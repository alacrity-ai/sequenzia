const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-DMyvYZnd.js","assets/index-ojxIWayS.js"])))=>i.map(i=>d[i]);
import{_ as te}from"./index-ojxIWayS.js";function ee(t=3){const i=["C","D","E","F","G","A","B"],a=["C#","D#","","F#","G#","A#",""],r=[t,t+1,t+2],l={};let c=0;for(const u of r)i.forEach(m=>{const h=`${m}${u}`;l[h]={note:h,x:c,width:60,height:200,isBlack:!1},c+=60});c=0;for(const u of r)a.forEach((m,h)=>{if(m===""){c+=60;return}const d=`${m}${u}`;l[d]={note:d,x:c+60-40/2,width:40,height:120,isBlack:!0},c+=60});return l}function mt(t,e,n=new Set,o=null){t.clearRect(0,0,t.canvas.width,t.canvas.height);const s={};if(o)for(const[i,a]of Object.entries(o))s[a]=i;for(const i of Object.values(e))i.isBlack||(Ut(t,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),t.fillStyle="#333",t.font="12px sans-serif",t.textAlign="center",s[i.note]&&(t.fillStyle="#7c3aed",t.fillText(s[i.note],i.x+i.width/2,i.height-24),t.fillStyle="#333"),t.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(e))i.isBlack&&(Ut(t,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),pe(t,i),s[i.note]&&(t.fillStyle="#c084fc",t.font="10px sans-serif",t.textAlign="center",t.fillText(s[i.note],i.x+i.width/2,i.height-28)))}function Ut(t,{x:e,width:n,height:o,fill:s,stroke:i,radius:a=8}){t.beginPath(),t.moveTo(e,0),t.lineTo(e,o-a),t.quadraticCurveTo(e,o,e+a,o),t.lineTo(e+n-a,o),t.quadraticCurveTo(e+n,o,e+n,o-a),t.lineTo(e+n,0),t.closePath(),t.fillStyle=s,t.fill(),t.strokeStyle=i,t.lineWidth=1,t.stroke()}function pe(t,e){const n=t.createLinearGradient(e.x,0,e.x,e.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),t.fillStyle=n,t.beginPath(),t.moveTo(e.x,0),t.lineTo(e.x+e.width,0),t.lineTo(e.x+e.width,e.height*.4),t.lineTo(e.x,e.height*.4),t.closePath(),t.fill()}const J=64,ge={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"};function _(t){var i;const e=(i=t==null?void 0:t.match)==null?void 0:i.call(t,/^([A-G]#?)(\d)$/);if(!e)return null;const[n,o]=e.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}function ye(t){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][t%12]+(Math.floor(t/12)-1)}function be(t){return t.replace(/\d+$/,"")}function Tt(t){return t.includes("#")}function ne(t,e){return t/e()}function Ee(t,e){let n=e.snapResolution||.25,o=e.isTripletMode?n*(2/3):n;return Math.round(t/o)*o}function we(t,e,n){const o=ne(t,n);return Ee(o,e)}function ve(t,e,n,o,s,i=4){t.beginPath(),t.moveTo(e+i,n),t.lineTo(e+o-i,n),t.quadraticCurveTo(e+o,n,e+o,n+i),t.lineTo(e+o,n+s-i),t.quadraticCurveTo(e+o,n+s,e+o-i,n+s),t.lineTo(e+i,n+s),t.quadraticCurveTo(e,n+s,e,n+s-i),t.lineTo(e,n+i),t.quadraticCurveTo(e,n,e+i,n),t.closePath()}function x(t){return t.totalMeasures*t.beatsPerMeasure}function At(t){const e=t.match(/^([A-G]#?)(\d)$/);if(!e)return null;const[n,o,s]=e;return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[o]+12*parseInt(s,10)}function Be(t){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][t%12]+(Math.floor(t/12)-1)}function Le(t,e,n,o,s,i,a,r){const{totalMeasures:l,beatsPerMeasure:c}=e,u=x(e)*i;for(let f=0;f<s;f++){const p=f*a,g=r(f);t.fillStyle=Tt(g)?"rgb(174,173,175)":"#fefefe",t.fillRect(0,p,u,a),t.fillStyle=Tt(g)?"#a088b0":"#dddddd",t.fillRect(-64,p,J,a)}t.font=`${Math.floor(a*.6)}px sans-serif`,t.textAlign="right",t.textBaseline="middle";for(let f=0;f<s;f++){const p=f*a,g=r(f);t.fillStyle=Tt(g)?"#800080":"#444",t.fillText(g,-8,p+a/2)}t.strokeStyle="#ddd",t.lineWidth=1;for(let f=0;f<s;f++){const p=f*a;t.beginPath(),t.moveTo(0,p),t.lineTo(u,p),t.stroke()}const m=s*a;t.beginPath(),t.moveTo(0,m),t.lineTo(u,m),t.stroke();const h=s*a,d=l*c;for(let f=0;f<=d;f++){const p=f*i,g=f%c===0;t.strokeStyle=g?"#bbb":"#eee",t.lineWidth=g?2:1,t.beginPath(),t.moveTo(p,0),t.lineTo(p,h),t.stroke()}const y=l*c*i;t.strokeStyle="#bbb",t.lineWidth=2,t.beginPath(),t.moveTo(y,0),t.lineTo(y,h),t.stroke()}function Me(t,e,{previewNote:n,hoveredNote:o,selectedNote:s,cellWidth:i,cellHeight:a,visibleStartBeat:r,visibleEndBeat:l,getPitchRow:c,getPitchClass:u,PITCH_COLOR_MAP:m,drawRoundedRect:h}){for(const d of e){if(d.start+d.duration<r||d.start>l)continue;const y=d.start*i,f=c(d.pitch)*a,p=d.duration*i,g=a-1,b=m[u(d.pitch)]||"#999";t.shadowColor="rgba(0,0,0,0.3)",t.shadowBlur=4,t.shadowOffsetX=1,t.shadowOffsetY=2,t.fillStyle=b,h(t,y,f,p,g),t.fill();const w=t.createLinearGradient(y,f,y,f+g);w.addColorStop(0,"rgba(255,255,255,0.4)"),w.addColorStop(.2,"rgba(255,255,255,0.15)"),w.addColorStop(.5,"rgba(255,255,255,0.05)"),w.addColorStop(1,"rgba(255,255,255,0)"),t.shadowColor="transparent",t.fillStyle=w,h(t,y,f,p,g),t.fill(),(d===o||d===s)&&(t.lineWidth=2,t.strokeStyle=d===s?"blue":"black",h(t,y,f,p,g),t.stroke())}if(n&&!o&&!s){const d=n.start*i,y=c(n.pitch)*a,f=n.duration*i,p=a-1,g=m[u(n.pitch)]||"#999";t.fillStyle=Se(g,.4),h(t,d,y,f,p),t.fill()}}function Se(t,e){const n=parseInt(t.slice(1),16);return`rgba(${n>>16&255}, ${n>>8&255}, ${n&255}, ${e})`}function ke(t,e,n,o,s,i){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.save(),t.translate(s-n,-o),t.strokeStyle="red",t.lineWidth=2,t.beginPath(),t.moveTo(e,0),t.lineTo(e,i),t.stroke(),t.restore()}function Ie(t,e,n,o=J){const s=t.getBoundingClientRect(),i=parseFloat(t.style.width||s.width),a=parseFloat(t.style.height||s.height),r=t.width/i,l=t.height/a,c=(e.clientX-s.left)*r+n.scrollLeft-o,u=(e.clientY-s.top)*l+n.scrollTop;return{x:c,y:u}}function Te(t,e,n,o,s,i){const a=Math.floor(e/s),r=t/i;return n.find(l=>r>=l.start&&r<l.start+l.duration&&o(l.pitch)===a)}function Ae(t,{sequencer:e,config:n,notes:o,getCellWidth:s,getCellHeight:i,getCanvasPos:a,findNoteAt:r,scheduleRedraw:l,getPitchFromRow:c,getSnappedBeatFromX:u,getRawBeatFromX:m,updatePreview:h,clearPreview:d,getSelectedNote:y,setSelectedNote:f,getHoveredNote:p,setHoveredNote:g,onNotesChanged:b}){let w=null,S=null;t.addEventListener("click",v=>{const{x:B,y:T}=a(v);if(B<0){const O=c(Math.floor(T/i()));e.playNote(O,.5);return}const I=r(B,T);if(I){f(I),l(),b&&b();return}const A=u(B,n),C=c(Math.floor(T/i())),F=x(n);if(A+n.currentDuration>F)return;e.playNote(C,.5),o.push({pitch:C,start:A,duration:n.currentDuration}),l(),b&&b()}),t.addEventListener("contextmenu",v=>{v.preventDefault();const{x:B,y:T}=a(v),I=r(B,T);if(I){const A=o.indexOf(I);A!==-1&&o.splice(A,1),l(),b&&b()}}),t.addEventListener("mousemove",v=>{const{x:B,y:T}=a(v);if(B<0){d();return}const I=r(B,T);g(I);const A=y();if(!w&&A&&A!==I&&f(null),!I&&!w){const C=u(B,n),F=c(Math.floor(T/i())),$=x(n);C+n.currentDuration<=$?h({pitch:F,start:C,duration:n.currentDuration}):d()}else d();if(w&&A){const C=B-w.startX,F=u(C,n)-u(0,n),$=Math.max(0,w.initialStart+F),O=x(n);$+A.duration<=O&&(A.start=$);const z=T-w.startY,H=Math.round(z/i()),Z=w.initialMidi-H,E=At(n.noteRange[0]),L=At(n.noteRange[1]),N=Math.max(E,Math.min(L,Z)),q=Be(N);q!==A.pitch&&(A.pitch=q,S!==q&&(S=q,e.playNote(q,.5))),l(),b&&b();return}l()}),t.addEventListener("mouseleave",()=>{d(),g(null),l()}),t.addEventListener("mousedown",v=>{const{x:B,y:T}=a(v),I=r(B,T);I&&(f(I),w={startX:B,startY:T,initialStart:I.start,initialMidi:At(I.pitch)})}),t.addEventListener("mouseup",()=>{w=null})}const Et=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function zt(t,e,n,o=0){const s=t.getContext("2d"),i=t.width,a=t.height;s.clearRect(0,0,i,a);const r=Et[o%Et.length];s.fillStyle=r;const l=x(n),c=_(n.noteRange[0]),m=_(n.noteRange[1])-c||1,h=Math.max(2,a/m);for(const d of e){const y=d.start/l*i,f=Math.max(1,d.duration/l*i),g=(_(d.pitch)-c)/m,b=a-g*a-h/2;s.fillRect(y,b,f,h)}}function it(t,e){const n=t.getContext("2d"),o=t.width,s=t.height;n.clearRect(0,0,o,s),e.forEach((i,a)=>{const r=i.notes,l=i.config;if(!(r!=null&&r.length))return;const c=x(l),u=Et[a%Et.length];n.fillStyle=u;const m=_(l.noteRange[0]),d=_(l.noteRange[1])-m||1,y=Math.max(2,s/d);for(const f of r){const p=f.start/c*o,g=Math.max(1,f.duration/c*o),w=(_(f.pitch)-m)/d,S=s-w*s-y/2;n.fillRect(p,S,g,y)}})}function Ce(t,e,n,o){const s=t.querySelector(".zoom-in-btn"),i=t.querySelector(".zoom-out-btn"),a=t.querySelector(".zoom-reset-btn");!s||!i||!a||(s.addEventListener("click",e),i.addEventListener("click",n),a.addEventListener("click",o))}function qe(t,e,n,o,s,i){let a=null,r=null,l=null,c=0,u=0;const m=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:50,cellHeight:25},{cellWidth:60,cellHeight:30}];let h=2;const d=t.getContext("2d"),y=e.getContext("2d");let f=m[h].cellWidth,p=m[h].cellHeight;const g=_(s.noteRange[1])-_(s.noteRange[0])+1,b=g*p,S=x(s)*f+J;t.width=S,t.height=b,t.style.width=`${S}px`,t.style.height=`${b}px`,e.width=S,e.height=b,e.style.width=`${S}px`,e.style.height=`${b}px`,n.addEventListener("scroll",()=>{c=n.scrollLeft,u=n.scrollTop,B()});let v=null;function B(){v!==null&&cancelAnimationFrame(v),v=requestAnimationFrame(T)}function T(){d.clearRect(0,0,t.width,t.height),d.save(),d.translate(-c+J,-u),Le(d,s,c,u,g,f,p,H),Me(d,o,{previewNote:a,hoveredNote:r,selectedNote:l,cellWidth:f,cellHeight:p,visibleStartBeat:c/f,visibleEndBeat:(c+t.width)/f,getPitchRow:z,getPitchClass:be,PITCH_COLOR_MAP:ge,drawRoundedRect:ve}),d.restore()}function I(){h<m.length-1&&(h++,F())}function A(){h>0&&(h--,F())}function C(){h=2,F()}function F(){const E=m[h];f=E.cellWidth,p=E.cellHeight,$()}function $(){const L=x(s)*f+J,q=(_(s.noteRange[1])-_(s.noteRange[0])+1)*p;t.width=L,t.height=q,t.style.width=`${L}px`,t.style.height=`${q}px`,e.width=L,e.height=q,e.style.width=`${L}px`,e.style.height=`${q}px`,B()}function O(E){ke(y,E,c,u,J,t.height)}Ce(i.container,I,A,C);function z(E){return _(s.noteRange[1])-_(E)}function H(E){const N=_(s.noteRange[1])-E,q=Math.max(_(s.noteRange[0]),Math.min(_(s.noteRange[1]),N));return ye(q)}function Z(){const E=document.getElementById("global-mini-contour");E&&it(E,k)}return Ae(t,{sequencer:i,config:s,notes:o,getCellWidth:()=>f,getCellHeight:()=>p,getCanvasPos:E=>Ie(t,E,n,J),findNoteAt:(E,L)=>Te(E,L,o,z,p,f),scheduleRedraw:B,getPitchFromRow:H,getSnappedBeatFromX:E=>we(E,s,()=>f),getRawBeatFromX:E=>ne(E,()=>f),updatePreview:E=>a=E,clearPreview:()=>a=null,getSelectedNote:()=>l,setSelectedNote:E=>l=E,getHoveredNote:()=>r,setHoveredNote:E=>r=E,onNotesChanged:Z}),{scheduleRedraw:B,drawPlayhead:O,getSelectedNote:()=>l,clearSelection:()=>{l=null,B()},getPreviewNote:()=>a,zoomIn:I,zoomOut:A,getXForBeat:E=>E*f}}let D=null,rt=500,yt=null,Ft=!1,_t=1/0,st=[],bt=null,oe=0;function Nt(t){return st.push(t),()=>{const e=st.indexOf(t);e!==-1&&st.splice(e,1)}}function Fe(){st=[]}function j(t){oe=t}function wt(){return oe}function _e(t){bt=t}function Ne(t,e={}){rt=60/t*1e3,Ft=e.loop??!1,_t=e.endBeat??1/0;const n=e.startBeat??0;yt=performance.now()-n*rt;const o=e.onLoop;function s(i){const r=(i-yt)/rt;if(j(r),st.forEach(l=>l(r)),r>=_t)if(Ft)yt=performance.now(),j(0),o&&o();else{vt();return}D=requestAnimationFrame(s)}D=requestAnimationFrame(s)}function vt(){D&&cancelAnimationFrame(D),D=null,Fe(),bt&&(bt(),bt=null)}function Re(){return D!==null}function se(){D&&cancelAnimationFrame(D),D=null}function ie(){if(D)return;const t=performance.now()-wt()*rt;function e(n){const s=(n-t)/rt;if(j(s),st.forEach(i=>i(s)),s>=_t)if(Ft)yt=performance.now(),j(0);else{vt();return}D=requestAnimationFrame(e)}D=requestAnimationFrame(e)}const xe={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function St(t){const e=t.match(/^([A-Ga-g][#b]?)(-?\d+)$/);if(!e)return null;const[,n,o]=e,s=n.toUpperCase(),i=xe[s];return i===void 0?null:12*(parseInt(o,10)+1)+i}class ae{constructor(e,n,o=K,s=W,i="fluidr3-gm/acoustic_grand_piano"){this.container=e,this.config={...n},this.context=o,this.destination=s,this.instrumentName=i,this.notes=[],this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.isMuted=!1,this.isSoloed=!1,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this._initCanvases())}async initInstrument(){try{await Bt(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(e){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,e)}}updateTrackLabel(){const e=this.container.querySelector(".track-name");e&&(e.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(e){this.instrumentName=e,this.updateTrackLabel(),this.initInstrument(),console.log(`[SEQ:${this.id}] Instrument set to:`,e)}playNote(e,n,o=100,s=!1){return fn(this.instrumentName,e,n,o,s)}_initCanvases(){const e=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),o=this.container.querySelector("#grid-scroll-container");this.grid=qe(e,n,o,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(e){this.config.totalMeasures=e;const n=x(this.config);this.clampNotesToGrid();const o=n*this.config.cellWidth+(this.config.labelWidth||64),s=this.container.querySelector("canvas.note-grid"),i=this.container.querySelector(".playhead-canvas");s&&(s.width=o,s.style.width=`${o}px`),i&&(i.width=o,i.style.width=`${o}px`),this.redraw()}clampNotesToGrid(){const e=x(this.config),n=this.notes.filter(o=>o.start<e);n.forEach(o=>{o.start+o.duration>e&&(o.duration=e-o.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear();const n=60/this.config.bpm;this._beatHandler=o=>{var s;if((s=this.grid)==null||s.drawPlayhead(this.grid.getXForBeat(o)),!!this.shouldPlay)for(const i of this.notes){const a=i.start,r=i.start+i.duration;if(!this._activeNotes.has(i)&&a<=o&&o<=r){const l=i.duration*n;this.playNote(i.pitch,l),this._activeNotes.add(i)}}},this._unsub=Nt(this._beatHandler),this._beatHandler(0)}stop(){var e,n,o;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const s of this._activeNotes){const i=this._noteHandlers.get(s);(e=i==null?void 0:i.forceStop)==null||e.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(o=this.grid)==null||o.drawPlayhead(null),this.redraw()}pause(){var e;for(const n of this._activeNotes){const o=this._noteHandlers.get(n);(e=o==null?void 0:o.stop)==null||e.call(o)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=Nt(this._beatHandler))}seekTo(e){this.stop(),this.play()}toggleMute(){this.isMuted=!this.isMuted,this.isMuted&&(this.isSoloed=!1),this.updateTrackStyle()}toggleSolo(){this.isSoloed=!this.isSoloed,this.isSoloed&&(this.isMuted=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const e=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");e.classList.toggle("bg-red-600",this.isMuted),e.classList.toggle("bg-gray-700",!this.isMuted),n.classList.toggle("bg-yellow-200",this.isSoloed),n.classList.toggle("bg-gray-700",!this.isSoloed),this.container.classList.toggle("opacity-40",this.isMuted&&!this.isSoloed),this.container.classList.toggle("opacity-100",!(this.isMuted&&!this.isSoloed))}updateNotesFromTrackMap(e){this.notes.splice(0,this.notes.length,...e.n.map(([n,o,s])=>({pitch:n,start:o,duration:s})))}redraw(){var e;(e=this.grid)==null||e.scheduleRedraw()}destroy(){var e;this.stop(),(e=this.container)==null||e.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:e,config:n,instrument:o}){this.notes.length=0,this.notes.push(...e),Object.assign(this.config,n),o&&(this.instrumentName=o),this.redraw()}async exportToOffline(){const e=60/this.config.bpm,n=await Bt(this.instrumentName,this.context,this.destination);for(const o of this.notes){const s=o.start*e,i=o.duration*e;n.start({note:St(o.pitch),duration:i,velocity:100,time:s,loop:!1})}}}async function $e(t){var i,a,r,l,c,u,m;const e=await t.text();let n;try{n=JSON.parse(e)}catch{throw new Error("Invalid JSON format.")}if(!n||!Array.isArray(n.notes))throw new Error("JSON file missing required `notes` array.");const o=n.notes.map(h=>({pitch:h.pitch,start:h.start,duration:h.duration})),s={bpm:((i=n.config)==null?void 0:i.bpm)??120,snapResolution:((a=n.config)==null?void 0:a.snapResolution)??.125,currentDuration:((r=n.config)==null?void 0:r.currentDuration)??.25,noteRange:((l=n.config)==null?void 0:l.noteRange)??["C3","B5"],totalBeats:((c=n.config)==null?void 0:c.totalBeats)??100,beatsPerMeasure:((u=n.config)==null?void 0:u.beatsPerMeasure)??4,totalMeasures:((m=n.config)==null?void 0:m.totalMeasures)??8};return[{notes:o,config:s}]}async function De(t){var r,l,c;const e=await t.text();let n;try{n=JSON.parse(e)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const o=((r=n.c)==null?void 0:r.b)??120,s=((l=n.c)==null?void 0:l.bpm)??4,i=((c=n.c)==null?void 0:c.tm)??8,a=Array.isArray(n.i)?n.i:[];return n.tr.map((u,m)=>{if(!Array.isArray(u.n))throw new Error("Track missing `n` (notes) array.");const h=u.n.map(([f,p,g])=>({pitch:f,start:p,duration:g})),d={bpm:o,beatsPerMeasure:s,totalMeasures:i},y=a[m]||"fluidr3-gm/acoustic_grand_piano";return{notes:h,config:d,instrument:y}})}const M={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,bpm:220,loopEnabled:!1,useEqualTemperament:!0,beatsPerMeasure:4,totalMeasures:8},k=[],Oe=document.getElementById("sequencers-container"),Pe=document.getElementById("sequencer-template"),le=document.getElementById("add-sequencer");function Pt(t,e){var n,o,s,i;(n=t.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!e),(o=t.querySelector(".zoom-out-btn"))==null||o.classList.toggle("hidden",!e),(s=t.querySelector(".zoom-reset-btn"))==null||s.classList.toggle("hidden",!e),(i=t.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!e)}function Wt(){return k}function We(t){const e=String(t);return Wt().find(n=>{var o;return String(n.id)===e||String((o=n.config)==null?void 0:o.id)===e})}function Ht(){const t=k.some(e=>e.solo);k.forEach(e=>{e.shouldPlay=t?e.solo:!e.mute})}function at(t,e){t.classList.toggle("opacity-100",e),t.classList.toggle("opacity-40",!e)}function Kt(t){const n=Pe.content.cloneNode(!0).querySelector(".sequencer");Oe.insertBefore(n,le);const o=k.length,s=t?{id:o,...M,...t.config}:{id:o,...M},i=(t==null?void 0:t.instrument)||"fluidr3-gm/acoustic_grand_piano",a=new ae(n,s,K,W,i);a.id=o,a.colorIndex=o,a.mute=!1,a.solo=!1,a.shouldPlay=!0;const r=n.querySelector("canvas.mini-contour");t&&a.setState(t),zt(r,a.notes,a.config,a.colorIndex),a.updateTrackLabel(),a.initInstrument();const l=n.querySelector(".collapse-btn"),c=l.querySelector("use"),u=n.querySelector(".sequencer-body");l.addEventListener("click",()=>{const f=u.classList.toggle("hidden");c.setAttribute("href",f?"#icon-caret-up":"#icon-caret-down"),r.classList.toggle("hidden",!f),Pt(n,!f),f&&zt(r,a.notes,a.config,a.colorIndex)});const m=n.querySelector(".delete-btn");m.innerHTML=`
    <svg class="w-6 h-6" aria-hidden="true">
      <use href="#icon-close-circle"></use>
    </svg>
  `,m.addEventListener("click",()=>{const f=document.getElementById("delete-confirm-modal"),p=document.getElementById("delete-confirm"),g=document.getElementById("delete-cancel");f.classList.remove("hidden");const b=()=>{a.destroy();const v=k.indexOf(a);v>=0&&k.splice(v,1),S()},w=()=>{S()},S=()=>{f.classList.add("hidden"),p.removeEventListener("click",b),g.removeEventListener("click",w)};p.addEventListener("click",b),g.addEventListener("click",w)});const h=n.querySelector(".mute-btn"),d=n.querySelector(".solo-btn"),y=n.querySelector(".instrument-select-btn");return h.addEventListener("click",()=>{a.mute=!a.mute,a.mute&&(a.solo=!1,d.classList.remove("bg-yellow-200"),d.classList.add("bg-gray-700"),d.classList.remove("hover:bg-yellow-400"),d.classList.add("hover:bg-purple-700"),at(d,!1)),at(h,a.mute),Ht();const f=wt();a.seekTo(f)}),d.addEventListener("click",()=>{a.solo=!a.solo,a.solo&&(a.mute=!1,at(h,!1)),d.classList.toggle("bg-yellow-200",a.solo),d.classList.toggle("bg-gray-700",!a.solo),d.classList.toggle("hover:bg-yellow-400",a.solo),d.classList.toggle("hover:bg-purple-700",!a.solo),Ht();const f=wt();a.seekTo(f)}),y.addEventListener("click",async()=>{const f=document.getElementById("instrument-select-modal"),p=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const g=a.instrumentName||"fluidr3-gm/acoustic_grand_piano",[b,w]=g.split("/");p.value=b,await p.dispatchEvent(new CustomEvent("change",{detail:{preselect:g}})),f.dataset.currentSequencer=a.id,f.classList.remove("hidden")}),at(h,!1),at(d,!1),d.classList.add("hover:bg-purple-700"),k.push(a),{seq:a,wrapper:n}}function Ke(){k.slice().forEach(t=>t.destroy()),k.length=0}function Ge(){const t=document.getElementById("global-mini-contour");le.addEventListener("click",()=>{Kt(),it(t,k)})}const V={openaiApiKey:"",openaiModel:"gpt-4o"};function Rt(){return V.openaiApiKey}function Xt(){return V.openaiModel}function je(t){V.openaiApiKey=t}function Ue(t){const e=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];if(!e.includes(t))throw new Error(`Invalid model: ${t}. Must be one of: ${e.join(", ")}`);V.openaiModel=t}function ze(){localStorage.setItem("userConfig",JSON.stringify(V))}function He(){const t=localStorage.getItem("userConfig");if(t){const e=JSON.parse(t);V.openaiApiKey=e.openaiApiKey||"",V.openaiModel=e.openaiModel||"gpt-4o"}}He();function Xe(){const t=document.getElementById("userconfig-modal"),e=document.getElementById("config-save"),n=document.getElementById("config-close"),o=document.getElementById("openai-key-input"),s=document.getElementById("openai-model-select");o.value=Rt(),s.value=Xt(),e.addEventListener("click",()=>{je(o.value),Ue(s.value),ze(),t.classList.add("hidden")}),n.addEventListener("click",()=>{o.value=Rt(),s.value=Xt(),t.classList.add("hidden")}),document.getElementById("key-not-set-ok").addEventListener("click",()=>{document.getElementById("openai-key-not-set-modal").classList.add("hidden")})}const Ye={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"};let Yt=!1,X=!1,Y=!1;function Je({getSequencers:t,onPlay:e,onStop:n,onPause:o,onResume:s,onDurationChange:i,onSnapChange:a,onToggleLoop:r,onTempoChange:l,onSave:c,onLoad:u,onMeasuresChange:m,onBeatsPerMeasureChange:h}){if(Yt)return;Yt=!0;const d=document.getElementById("play-button"),y=d.querySelector("use"),f=document.getElementById("stop-button"),p=document.getElementById("note-duration");p.value=String(M.currentDuration||1);const g=document.getElementById("snap-resolution");g.value=String(M.snapResolution||.25);const b=document.getElementById("loop-toggle"),w=document.getElementById("tempo-input"),S=document.getElementById("save-button"),v=document.getElementById("load-button"),B=document.getElementById("load-input"),T=document.getElementById("measures-input"),I=document.getElementById("beats-per-measure-input"),A=document.getElementById("config-button"),C=document.getElementById("export-modal"),F=document.getElementById("export-json"),$=document.getElementById("export-wav"),O=document.getElementById("export-midi"),z=document.getElementById("export-cancel");y.setAttribute("href","#icon-play"),d.addEventListener("click",()=>{!X&&!Y?(X=!0,Y=!1,e==null||e(),y.setAttribute("href","#icon-pause")):X?(X=!1,Y=!0,o==null||o(),y.setAttribute("href","#icon-play")):Y&&(X=!0,Y=!1,s==null||s(),y.setAttribute("href","#icon-pause"))}),f.addEventListener("click",()=>{n==null||n(),X=!1,Y=!1,y.setAttribute("href","#icon-play")});const H={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125};window.addEventListener("keydown",E=>{if(!document.querySelector(".ai-modal:not(.hidden)")){if(E.code==="Space"){E.preventDefault(),d.click();return}if(H.hasOwnProperty(E.code)){E.preventDefault();const N=H[E.code];p.value=N,p.dispatchEvent(new Event("change"))}}}),p.addEventListener("change",E=>{const L=parseFloat(E.target.value);Z(L),i==null||i(L),t==null||t().forEach(N=>{const q=N.grid;if(q!=null&&q.getPreviewNote){const It=q.getPreviewNote();It&&(It.duration=L,q.scheduleRedraw())}})});function Z(E){document.querySelectorAll(".note-duration-btn").forEach(N=>{const q=parseFloat(N.dataset.value);N.classList.remove("bg-purple-700"),N.classList.remove("bg-gray-800"),q===E?N.classList.add("bg-purple-700"):N.classList.add("bg-gray-800")})}g.addEventListener("change",E=>{const L=E.target.value;Ye.hasOwnProperty(L)&&(M.snapResolution=parseFloat(L),g.value=String(L),a==null||a(M.snapResolution))}),b.addEventListener("change",E=>{r==null||r(E.target.checked)}),w.addEventListener("change",E=>{const L=parseInt(E.target.value,10);isNaN(L)||l==null||l(L)}),S.addEventListener("click",()=>{C?C.classList.remove("hidden"):c==null||c("json")}),v.addEventListener("click",()=>{B.click()}),B.addEventListener("change",E=>{const L=E.target.files[0];L&&(u==null||u(L)),E.target.value=""}),F&&F.addEventListener("click",()=>{C.classList.add("hidden"),c==null||c("json")}),$&&$.addEventListener("click",()=>{C.classList.add("hidden"),c==null||c("wav")}),O&&O.addEventListener("click",()=>{C.classList.add("hidden"),c==null||c("midi")}),z&&z.addEventListener("click",()=>{C.classList.add("hidden")}),A.addEventListener("click",()=>{document.getElementById("userconfig-modal").classList.remove("hidden")}),Xe(),T.value=M.totalMeasures,I.value=M.beatsPerMeasure,T.addEventListener("change",E=>{const L=parseInt(E.target.value,10);!isNaN(L)&&L>0&&(m==null||m(L))}),I.addEventListener("change",E=>{const L=parseInt(E.target.value,10);!isNaN(L)&&L>0&&(h==null||h(L))}),Z(parseFloat(p.value))}function Ve(){X=!1,Y=!1;const e=document.getElementById("play-button").querySelector("use");e&&e.setAttribute("href","#icon-play")}function $n(t){const e=document.getElementById("measures-input");e&&(e.value=t)}function Ze(){var t;(t=document.getElementById("loading-modal"))==null||t.classList.remove("hidden")}function Qe(){var t;(t=document.getElementById("loading-modal"))==null||t.classList.add("hidden")}let R=null,ct=0;const Ct=new Map;async function U(){R||(R=await te(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function re(){return K}async function Bt(t,e=K,n=null){await U();const[o,s]=t.includes("/")?t.split("/"):["musyngkite",t],i=e instanceof OfflineAudioContext;Ct.has(e)||Ct.set(e,new Map);const a=Ct.get(e),r=`${o}/${s}`;if(a.has(r))return a.get(r);let l;if(o==="smolken")l=new R.Smolken(e,{instrument:s,destination:n||W,disableScheduler:i}),await Q(l.load);else if(o==="splendidgrandpiano")l=new R.SplendidGrandPiano(e,{destination:n||W,disableScheduler:i}),await Q(l.load);else if(o==="electricpiano")l=new R.ElectricPiano(e,{instrument:s,destination:n||W,disableScheduler:i}),await Q(l.load);else if(o==="mallets")l=new R.Mallet(e,{instrument:s,destination:n||W,disableScheduler:i}),await Q(l.load);else if(o==="drummachines"){l=new R.DrumMachine(e,{instrument:s,destination:n||W,disableScheduler:i}),await Q(l.load);const c=l.getSampleNames(),u=new Map;c.forEach((m,h)=>{const d=36+h;u.set(d,m)}),l.__midiMap=u}else{const u={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[o.toLowerCase()]||"MusyngKite",m=await ln();console.log(`[Soundfont] Available kits: ${m.join(", ")}`),console.log(`[Soundfont] Requested: kit=${u} instrument=${s}`);const d=`https://gleitz.github.io/midi-js-soundfonts/${u}/${s}-ogg.js`;l=new R.Soundfont(e,{instrument:s,instrumentUrl:d,kit:u,destination:n||W,disableScheduler:i}),await Q(l.load)}return a.set(r,l),l}async function tn(){return await U(),R.getMalletNames()}async function en(){return await U(),R.getElectricPianoNames()}async function nn(){return await U(),["splendidgrandpiano"]}async function on(){return await U(),R.getDrumMachineNames()}async function sn(){return await U(),R.getSmolkenNames()}async function an(t="MusyngKite"){await U();const e=await R.getSoundfontNames(t);return console.log(`[SF2] Instruments in kit "${t}":`,e),e}async function ln(){return await U(),R.getSoundfontKits()}function rn(){ct++,ct===1&&Ze()}function cn(){ct--,ct<=0&&(ct=0,Qe())}async function Q(t){rn();try{await t}finally{cn()}}let G=null,xt=null;async function Jt(t){if(xt===t)return;G=await Bt(t),xt=t,console.log(`[SF2] Global keyboard instrument set to: ${t}`)}function dn(){return xt}function ce(t,e=100,n=!1){var r;if(!G)return null;const s=re().currentTime,i=St(t),a=((r=G.__midiMap)==null?void 0:r.get(i))??i;return G.start({note:a,stopId:a,velocity:e,time:s,loop:n}),()=>{G.stop({stopId:a})}}function un(t){var o;if(!G)return;const e=St(t),n=((o=G.__midiMap)==null?void 0:o.get(e))??e;G.stop({stopId:n})}async function fn(t,e,n,o=100,s=!1,i=null,a=null,r=null){var h;const l=a||re(),c=await Bt(t,l,r),u=St(e),m=((h=c.__midiMap)==null?void 0:h.get(u))??u;return c.start({note:m,duration:n,velocity:o,loop:s,time:i??l.currentTime}),null}const K=new(window.AudioContext||window.webkitAudioContext),kt=K.createAnalyser();kt.fftSize=2048;const W=K.createGain();W.connect(kt);kt.connect(K.destination);function mn(t){K.resume();try{const e=ce(t,100,20);return e?{stop:e,forceStop:e}:null}catch(e){return console.error("[playNote] Failed to play note",t,e),null}}K.resume().catch(t=>{console.warn("Failed to resume AudioContext:",t)});let Vt=!1,ht=null;function hn(t,e){if(Vt)return;Vt=!0,ht=e;const n=t.getContext("2d"),o=new Map,s=new Set;function i(u,m){const h=ht();for(const d of Object.values(h))if(d.isBlack&&u>=d.x&&u<=d.x+d.width&&m>=0&&m<=d.height)return d.note;for(const d of Object.values(h))if(!d.isBlack&&u>=d.x&&u<=d.x+d.width&&m>=0&&m<=d.height)return d.note;return null}function a(u){if(!u||s.has(u))return;const m=mn(u);m&&(o.set(u,m),s.add(u),mt(n,ht(),s))}function r(u){if(!s.has(u))return;const m=o.get(u);m&&(m.stop(),o.delete(u)),s.delete(u),mt(n,ht(),s)}function l(){for(const u of s)r(u)}let c=!1;t.addEventListener("mousedown",u=>{c=!0;const m=t.getBoundingClientRect(),h=u.clientX-m.left,d=u.clientY-m.top,y=i(h,d);a(y)}),t.addEventListener("mousemove",u=>{if(!c)return;const m=t.getBoundingClientRect(),h=u.clientX-m.left,d=u.clientY-m.top,y=i(h,d);a(y)}),t.addEventListener("mouseup",()=>{c=!1,l()}),t.addEventListener("mouseleave",()=>{c=!1,l()})}const de=[..."qwertyuiop[zxcvbnm,./"],ue=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];let $t=!1,pt=null,dt=null,ut=null;function pn(t,e){if($t)return;$t=!0;const n=t.getContext("2d"),o=new Set,s=new Set,i=new Map,a=de,r=ue;pt=e;function l(){const m=pt(),h=Object.values(m).filter(f=>!f.isBlack).sort((f,p)=>f.x-p.x).map(f=>f.note),d=Object.values(m).filter(f=>f.isBlack).sort((f,p)=>f.x-p.x).map(f=>f.note),y={};return a.forEach((f,p)=>{h[p]&&(y[f]=h[p])}),r.forEach((f,p)=>{d[p]&&(y[f]=d[p])}),y}function c(m){const h=l(),d=h[m];if(!(!d||o.has(m))){if(o.add(m),!s.has(d)){const y=ce(d,100,bn());y&&(i.set(d,{stop:y}),s.add(d))}mt(n,pt(),s,h)}}function u(m){const h=l(),d=h[m];d&&(o.delete(m),s.has(d)&&(un(d),i.delete(d),s.delete(d)),mt(n,pt(),s,h))}dt=m=>{m.repeat||c(m.key)},ut=m=>{u(m.key)},window.addEventListener("keydown",dt),window.addEventListener("keyup",ut)}function gn(){dt&&(window.removeEventListener("keydown",dt),dt=null),ut&&(window.removeEventListener("keyup",ut),ut=null),$t=!1}let et=3,tt=ee(et),gt=!1;async function yn(t){const e=t.getContext("2d");await Jt("fluidr3-gm/acoustic_grand_piano");const n=de,o=ue;function s(){const p=Object.values(tt).filter(w=>!w.isBlack).sort((w,S)=>w.x-S.x).map(w=>w.note),g=Object.values(tt).filter(w=>w.isBlack).sort((w,S)=>w.x-S.x).map(w=>w.note),b={};return n.forEach((w,S)=>{p[S]&&(b[w]=p[S])}),o.forEach((w,S)=>{g[S]&&(b[w]=g[S])}),b}function i(){tt=ee(et);const p=gt?s():null;mt(e,tt,new Set,p)}hn(t,()=>tt),i(),document.getElementById("octave-up").addEventListener("click",()=>{et<7&&(et++,i())}),document.getElementById("octave-down").addEventListener("click",()=>{et>1&&(et--,i())});const a=document.getElementById("disable-keyboard-inputs");a.classList.remove("bg-purple-600"),a.classList.add("bg-gray-700"),a.addEventListener("click",()=>{gt=!gt,gt?(pn(t,()=>tt),a.classList.remove("bg-gray-700"),a.classList.add("bg-purple-600")):(gn(),a.classList.remove("bg-purple-600"),a.classList.add("bg-gray-700")),i()});const r=document.getElementById("instrument-select-btn"),l=document.getElementById("instrument-select-modal"),c=document.getElementById("instrument-select"),u=document.getElementById("instrument-select-confirm"),m=document.getElementById("instrument-cancel-btn"),h=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([p,g])=>{const b=document.createElement("option");b.value=p,b.textContent=p.replace(/_/g," ").replace(/\b\w/g,w=>w.toUpperCase()),h.appendChild(b)}),h.addEventListener("change",async p=>{var S;const g=h.value,b=document.getElementById("instrument-select"),w=((S=p.detail)==null?void 0:S.preselect)||null;try{let v;g==="mallets"?v=await tn():g==="electricpiano"?v=await en():g==="splendidgrandpiano"?v=await nn():g==="drummachines"?v=await on():g==="smolken"?v=await sn():["fluidr3-gm","musyngkite","fatboy"].includes(g)?v=await an({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[g]):v=await(await fetch(`/static/${g}.json`)).json(),b.innerHTML="",v.forEach(B=>{const T=document.createElement("option");T.value=`${g}/${B}`,T.textContent=B.split("_").map(I=>I.charAt(0).toUpperCase()+I.slice(1)).join(" "),b.appendChild(T)}),b.value=w||`${g}/${v[0]}`}catch(v){console.error(`Failed to load instruments for library: ${g}`,v)}}),h.dispatchEvent(new Event("change")),r.addEventListener("click",async()=>{const p=dn()||"fluidr3-gm/acoustic_grand_piano",[g,b]=p.split("/");h.value=g,await h.dispatchEvent(new CustomEvent("change",{detail:{preselect:p}})),l.classList.remove("hidden"),delete l.dataset.currentSequencer}),u.addEventListener("click",async()=>{const p=c.value;l.classList.add("hidden");const g=l.dataset.currentSequencer;if(g){console.log("[Modal] Looking up sequencer with id:",g);const b=We(g);console.log("[Modal] Lookup result:",b),b&&b.setInstrument(p),l.dataset.currentSequencer=""}else try{await Jt(p)}catch(b){console.error("Failed to load global instrument:",p,b)}});let y=!1;const f=document.getElementById("instrument-loop-toggle");f.addEventListener("change",()=>{y=f.checked,console.log("[UI] Loop mode:",y)}),m.addEventListener("click",()=>{l.classList.add("hidden")})}function bn(){var t;return((t=document.getElementById("instrument-loop-toggle"))==null?void 0:t.checked)||!1}function En(t,e){const n=e.getContext("2d"),o=e.width,s=e.height,i=new Uint8Array(t.fftSize),a=new Uint8Array(t.frequencyBinCount),r=document.createElement("canvas");r.width=o,r.height=s;const l=r.getContext("2d");let c="frequency";function u(){t.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,o,s),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const y=o/i.length;let f=0;for(let p=0;p<i.length;p++){const b=i[p]/128*s/2;p===0?n.moveTo(f,b):n.lineTo(f,b),f+=y}n.lineTo(o,s/2),n.stroke()}function m(){t.getByteFrequencyData(a),n.fillStyle="#000",n.fillRect(0,0,o,s),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,s),n.fillRect(o-1,0,1,s);const y=128,f=2,p=[];for(let g=0;g<y;g++)p.push(g*o/(y-1));p[p.length-1]=o-1;for(let g=0;g<y;g++){const b=p[g],w=g<y-1?p[g+1]:o,S=Math.max(1,w-b-f),v=20,B=2e4,T=g/(y-1),I=v*Math.pow(B/v,T),C=Math.min(a.length-1,Math.floor(I/22050*a.length)),F=a[C]/255,$=Math.max(1,F*s),O=240-T*240;n.fillStyle=`hsl(${O}, ${80+F*20}%, ${40+F*40}%)`,n.fillRect(b,s-$,S,$)}}function h(){t.getByteFrequencyData(a),r.initialized||(l.fillStyle="#000",l.fillRect(0,0,o,s),r.initialized=!0),l.drawImage(r,-1,0),l.fillStyle="#000",l.fillRect(o-1,0,1,s);const y=128,f=20,p=2e4;for(let g=0;g<y;g++){const b=g/(y-1),w=f*Math.pow(p/f,b),v=Math.min(a.length-1,Math.floor(w/22050*a.length)),B=a[v]/255,T=s-1-Math.floor(g*s/y);if(B<.05)continue;const I=Math.floor(B*255),A=Math.floor(B*(255-b*200)),C=Math.floor(B*(100+b*155));l.fillStyle=`rgb(${I}, ${A}, ${C})`,l.fillRect(o-1,T,1,1)}n.fillStyle="#000",n.fillRect(0,0,o,s),n.drawImage(r,0,0)}function d(){switch(requestAnimationFrame(d),c){case"frequency":m();break;case"spectrogram":h();break;case"waveform":default:u()}}return d(),{setMode(y){["waveform","frequency","spectrogram"].includes(y)&&(c=y,n.clearRect(0,0,o,s),c==="spectrogram"&&l.clearRect(0,0,o,s))}}}function wn(t,e){const n=En(kt,t),o=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let s=0;function i(){s=(s+1)%o.length;const{name:a,emoji:r}=o[s];n.setMode(a),e.textContent=r,e.title=`Mode: ${a}`}e.addEventListener("click",i),i()}function vn(t){if(!t.length)throw new Error("No tracks to export.");const e=t[0].config.bpm,n=t[0].config.beatsPerMeasure,o=t[0].config.totalMeasures,s={v:3,t:new Date().toISOString(),c:{b:e,bpm:n,tm:o},i:t.map(a=>a.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:t.map(({notes:a})=>({n:a.map(r=>[r.pitch,r.start,r.duration])}))},i=new Blob([JSON.stringify(s)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function Bn(t){if(!t.length)return;const n=60/t[0].config.bpm,o=Math.max(...t.flatMap(u=>u.notes.map(m=>(m.start+m.duration)*n+.2))),s=44100,i=new OfflineAudioContext(2,Math.ceil(s*o),s);for(const u of t){const m=u.instrument||"fluidr3-gm/acoustic_grand_piano",h=new ae(null,u.config,i,i.destination,m);h.setState(u),await h.exportToOffline()}const a=await i.startRendering(),r=Ln(a),l=URL.createObjectURL(r),c=document.createElement("a");c.href=l,c.download=`session-${Date.now()}.wav`,c.click(),URL.revokeObjectURL(l)}function Ln(t){const e=t.numberOfChannels,n=t.length*e*2,o=new DataView(new ArrayBuffer(44+n)),s=(a,r)=>{for(let l=0;l<r.length;l++)o.setUint8(a+l,r.charCodeAt(l))};s(0,"RIFF"),o.setUint32(4,36+n,!0),s(8,"WAVE"),s(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,e,!0),o.setUint32(24,t.sampleRate,!0),o.setUint32(28,t.sampleRate*e*2,!0),o.setUint16(32,e*2,!0),o.setUint16(34,16,!0),s(36,"data"),o.setUint32(40,n,!0);let i=44;for(let a=0;a<t.length;a++)for(let r=0;r<e;r++){const l=t.getChannelData(r)[a],c=Math.max(-1,Math.min(1,l));o.setInt16(i,c*32767,!0),i+=2}return new Blob([o.buffer],{type:"audio/wav"})}function Mn(){const t=document.querySelectorAll(".note-duration-btn"),e=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),o=document.getElementById("triplet-note-btn");let s=!1,i=!1;function a(l){l=parseFloat(l);let c=l;s?c=l*1.5:i&&(c=l*(2/3));let u=Array.from(e.options).find(m=>Math.abs(parseFloat(m.value)-c)<1e-4);u||(u=new Option(c.toString(),c.toString()),e.add(u)),e.value=u.value,e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}t.forEach(l=>{l.addEventListener("click",()=>{t.forEach(u=>u.classList.remove("bg-purple-600")),l.classList.add("bg-purple-600");const c=parseFloat(l.dataset.value);a(c)})}),n.addEventListener("click",()=>{i&&(i=!1,o.classList.remove("bg-purple-600")),s=!s,n.classList.toggle("bg-purple-600"),r()}),o.addEventListener("click",()=>{s&&(s=!1,n.classList.remove("bg-purple-600")),i=!i,o.classList.toggle("bg-purple-600"),M.isTripletMode=i,k.forEach(l=>{l.config.isTripletMode=i}),r()});function r(){const l=document.querySelector(".note-duration-btn.bg-purple-600");if(l){const c=parseFloat(l.dataset.value);a(c)}}a(M.currentDuration||1)}let P=null,Lt=null;function Sn(t){Lt=t,P=Lt.getContext("2d")}function nt(t){if(!P||!Lt)return;const{width:e,height:n}=Lt;P.clearRect(0,0,e,n);const o=Math.round(t)+.5;P.strokeStyle="#ff00ff",P.lineWidth=1,P.beginPath(),P.moveTo(o,0),P.lineTo(o,n),P.stroke()}let Mt=!1,ot=null,fe=null,Dt=!1;function kn(t,e){ot=t,fe=e,ot.addEventListener("mousedown",In),window.addEventListener("mousemove",Tn),window.addEventListener("mouseup",An)}function In(t){Re()&&(se(),k.forEach(e=>{var n;return(n=e.pause)==null?void 0:n.call(e)}),Dt=!0),Mt=!0,me(t)}function Tn(t){Mt&&me(t)}function An(){Mt&&(Mt=!1,Dt&&(ie(),k.forEach(t=>{var e;return(e=t.resume)==null?void 0:e.call(t)}),Dt=!1))}function me(t){const e=ot.getBoundingClientRect(),n=ot.width/e.width;let o=(t.clientX-e.left)*n;o=Math.max(0,Math.min(ot.width,o));const s=x(fe),i=o/ot.width*s;j(i),nt(o)}const Gt={maxBeatsContext:32,extendBeatsAmount:16};function Dn(){return Gt.maxBeatsContext}function On(){return Gt.extendBeatsAmount}function Ot(t,e,n,o){const s=x(M),i=o/s*e;t.clearRect(0,0,e,n);const a=Gt.maxBeatsContext,l=Math.max(0,o-a)/s*e,c=i-l;t.fillStyle="rgba(85, 187, 255, 0.55)",t.fillRect(l,0,c,n),t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.moveTo(i,0),t.lineTo(i,n),t.stroke()}let Zt=!1;function Qt(){if(!Zt){Zt=!0;const o=document.getElementById("extend-use-tags"),s=document.getElementById("extend-tags");if(o&&s){let c=function(){const u=o.checked;s.disabled=!u,s.classList.toggle("opacity-50",!u),s.classList.toggle("cursor-not-allowed",!u)};c(),o.addEventListener("change",c)}const i=document.getElementById("extend-start-help-btn"),a=document.getElementById("extend-start-help-popup"),r=document.getElementById("extend-start-help-close");i&&a&&r&&(i.addEventListener("click",()=>a.classList.remove("hidden")),r.addEventListener("click",()=>a.classList.add("hidden")),document.addEventListener("click",c=>{!a.contains(c.target)&&c.target!==i&&a.classList.add("hidden")}));const l=document.querySelector("#ai-extend-modal .generate-btn");l&&l.addEventListener("click",async()=>{const{extendTracksWithAI:c}=await te(async()=>{const{extendTracksWithAI:u}=await import("./extendTracks-DMyvYZnd.js");return{extendTracksWithAI:u}},__vite__mapDeps([0,1]));await c()})}const t=document.getElementById("extend-track-checkboxes"),e=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");t&&e&&n&&(t.innerHTML="",Wt().forEach((s,i)=>{const a=`extend-track-${i}`,r=document.createElement("div");r.className="flex items-center gap-2";const l=document.createElement("input");l.type="checkbox",l.id=a,l.dataset.index=i,l.checked=!0,l.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const c=document.createElement("label");c.htmlFor=a,c.className="text-sm text-gray-200",c.textContent=s.config.name||`Track ${i+1}`,l.addEventListener("change",()=>{lt()}),r.appendChild(l),r.appendChild(c),t.appendChild(r)}),e.addEventListener("click",()=>{t.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!0),lt()}),n.addEventListener("click",()=>{t.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!1),lt()}),lt())}let qt=!1,ft=0;function Pn(){return ft}function Cn(){const t=document.getElementById("extend-mini-contour"),e=document.getElementById("extend-mini-playhead");if(!t||!e)return;const n=e.getContext("2d"),o=t.clientWidth,s=t.clientHeight;t.width=o,t.height=s,e.width=o,e.height=s,lt(),Ot(n,o,s,ft),e.addEventListener("mousedown",a=>{qt=!0,i(a.offsetX)}),window.addEventListener("mouseup",()=>{qt=!1}),window.addEventListener("mousemove",a=>{if(!qt)return;const r=e.getBoundingClientRect();i(a.clientX-r.left)});function i(a){const r=x(M),l=Math.max(0,Math.min(a,o));ft=Math.round(l/o*r),Ot(n,o,s,ft)}}function lt(){const t=document.getElementById("extend-mini-contour"),e=document.getElementById("extend-mini-playhead"),n=e.getContext("2d"),o=e.width,s=e.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),a=Array.from(i).filter(l=>l.checked).map(l=>parseInt(l.dataset.index,10)),r=Wt().filter((l,c)=>a.includes(c));it(t,r),Ot(n,o,s,ft)}function qn(){const t=document.getElementById("note-mode-btn"),e=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),o=document.getElementById("ai-control-panel");function s(){document.querySelectorAll(".sequencer").forEach(h=>{const d=h.querySelector(".delete-btn"),y=h.querySelector(".collapse-btn"),f=y.querySelector("use");d.classList.add("button-locked"),y.classList.add("button-locked");const p=h.querySelector(".sequencer-body"),g=h.querySelector(".mini-contour");Pt(h,!1),p.classList.contains("hidden")||(p.classList.add("hidden"),g.classList.remove("hidden"),f.setAttribute("href","#icon-caret-up"))})}function i(){document.querySelectorAll(".sequencer").forEach(h=>{const d=h.querySelector(".delete-btn"),y=h.querySelector(".collapse-btn");d.classList.remove("button-locked"),y.classList.remove("button-locked")})}function a(){t.classList.replace("bg-gray-800","bg-blue-600"),e.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),o.classList.add("hidden"),i()}function r(){if(!Rt()){document.getElementById("openai-key-not-set-modal").classList.remove("hidden");return}e.classList.replace("bg-gray-800","bg-purple-600"),t.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),o.classList.remove("hidden"),s()}t.addEventListener("click",a),e.addEventListener("click",r);const l=document.getElementById("ai-inpaint-modal"),c=document.getElementById("ai-extend-modal"),u=document.getElementById("ai-generate-modal");function m(h){h.querySelector(".cancel-btn").addEventListener("click",()=>{h.classList.add("hidden")})}m(l),m(c),m(u),Qt(),document.getElementById("ai-inpaint-btn").addEventListener("click",()=>{l.classList.remove("hidden")}),document.getElementById("ai-extend-btn").addEventListener("click",()=>{c.classList.remove("hidden"),Cn(),Qt()}),document.getElementById("ai-generate-btn").addEventListener("click",()=>{u.classList.remove("hidden")})}function he(){it(Fn,k)}const Fn=document.getElementById("global-mini-contour"),jt=document.getElementById("global-mini-playhead");Sn(jt);kn(jt,M);nt(0);const _n=document.getElementById("piano");yn(_n);const Nn=document.getElementById("waveform");wn(Nn,document.getElementById("visualizer-mode"));const{wrapper:Rn}=Kt();Pt(Rn,!0);he();Ge();Mn();qn();Je({getSequencers:()=>k,onPlay:()=>{vt();const t=x(M),e=wt();Ne(M.bpm,{loop:M.loopEnabled,endBeat:t,startBeat:e,onLoop:()=>{k.forEach(n=>{var o;return(o=n.onTransportLoop)==null?void 0:o.call(n)})}}),Nt(n=>{const o=n/t*jt.width;nt(o)}),k.forEach(n=>n.play()),_e(()=>{Ve(),j(0),nt(0)})},onPause:()=>{se(),k.forEach(t=>t.pause())},onResume:()=>{ie(),k.forEach(t=>t.resume())},onStop:()=>{vt(),j(0),k.forEach(t=>t.stop()),nt(0)},onDurationChange:t=>{M.currentDuration=t,k.forEach(e=>e.config.currentDuration=t)},onSnapChange:t=>{M.snapResolution=t,k.forEach(e=>e.config.snapResolution=t)},onToggleLoop:t=>{M.loopEnabled=t,k.forEach(e=>e.config.loopEnabled=t)},onTempoChange:t=>{M.bpm=t,k.forEach(e=>e.config.bpm=t)},onSave:async t=>{const e=k.map(n=>n.getState());if(t==="json"){const{url:n,filename:o}=vn(e),s=document.createElement("a");s.href=n,s.download=o,s.click(),URL.revokeObjectURL(n)}else t==="wav"?await Bn(e):t==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async t=>{try{let e=[];try{e=await De(t)}catch{e=await $e(t)}if(e.length>0){const n=e[0].config;M.bpm=n.bpm??M.bpm;const o=document.getElementById("tempo-input");o&&(o.value=M.bpm),M.beatsPerMeasure=n.beatsPerMeasure??M.beatsPerMeasure,M.totalMeasures=n.totalMeasures??M.totalMeasures;const s=document.getElementById("measures-input");s&&(s.value=M.totalMeasures)}Ke(),e.forEach(n=>{const{seq:o,wrapper:s}=Kt(n),i=s.querySelector(".sequencer-body"),a=s.querySelector("canvas.mini-contour"),r=s.querySelector(".collapse-btn");i.classList.add("hidden"),a.classList.remove("hidden"),r.textContent="⯅"}),he(),j(0),nt(0)}catch(e){alert("Failed to load file: "+e.message)}},onMeasuresChange:t=>{M.totalMeasures=t,k.forEach(n=>{n.updateTotalMeasures(t)});const e=document.getElementById("global-mini-contour");e&&it(e,k)},onBeatsPerMeasureChange:t=>{M.beatsPerMeasure=t,k.forEach(n=>{n.config.beatsPerMeasure=t,n.updateTotalMeasures(M.totalMeasures)});const e=document.getElementById("global-mini-contour");e&&it(e,k)}});const Wn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{Xt as a,Wt as b,Pn as c,Dn as d,On as e,M as f,Rt as g,zt as h,it as i,Wn as m,$n as u};
