const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-DMl6BaqW.js","assets/index-BFH5I_Pd.js"])))=>i.map(i=>d[i]);
import{_ as Vn}from"./index-BFH5I_Pd.js";function Yn(e=3){const n=["C","D","E","F","G","A","B"],s=["C#","D#","","F#","G#","A#",""],l=[e,e+1,e+2],c={};let u=0;for(const a of l)n.forEach(d=>{const h=`${d}${a}`;c[h]={note:h,x:u,width:60,height:200,isBlack:!1},u+=60});u=0;for(const a of l)s.forEach((d,h)=>{if(d===""){u+=60;return}const f=`${d}${a}`;c[f]={note:f,x:u+60-40/2,width:40,height:120,isBlack:!0},u+=60});return c}function Ye(e,t,r=new Set,i=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const o={};if(i)for(const[n,s]of Object.entries(i))o[s]=n;for(const n of Object.values(t))n.isBlack||(dn(e,{...n,fill:r.has(n.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",o[n.note]&&(e.fillStyle="#7c3aed",e.fillText(o[n.note],n.x+n.width/2,n.height-24),e.fillStyle="#333"),e.fillText(n.note,n.x+n.width/2,n.height-8));for(const n of Object.values(t))n.isBlack&&(dn(e,{...n,fill:r.has(n.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),Gr(e,n),o[n.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(o[n.note],n.x+n.width/2,n.height-28)))}function dn(e,t){const{x:r,width:i,height:o,fill:n,stroke:s,radius:l=8}=t;e.beginPath(),e.moveTo(r,0),e.lineTo(r,o-l),e.quadraticCurveTo(r,o,r+l,o),e.lineTo(r+i-l,o),e.quadraticCurveTo(r+i,o,r+i,o-l),e.lineTo(r+i,0),e.closePath(),e.fillStyle=n,e.fill(),e.strokeStyle=s,e.lineWidth=1,e.stroke()}function Gr(e,t){const r=e.createLinearGradient(t.x,0,t.x,t.height);r.addColorStop(0,"rgba(255,255,255,0.2)"),r.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=r,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}const z={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0},Y=64,Xr={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"},Vr={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"},fn={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125},it=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:60,cellHeight:25},{cellWidth:80,cellHeight:30}],Jn={openaiApiKey:"",openaiModel:"gpt-4o",gridColorScheme:"Darkroom",noteColorScheme:"Track Color"};function qe(){return Jn}function Je(e){Object.assign(Jn,e)}function Yr(){const e=qe();localStorage.setItem("userConfig",JSON.stringify(e))}function Jr(){const e=localStorage.getItem("userConfig");if(e)try{const t=JSON.parse(e);Je(t)}catch(t){console.error("Failed to parse userConfig from localStorage:",t)}}Jr();const hn=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];function Mt(){return qe().openaiApiKey}function mn(){return qe().openaiModel}function Qr(e){Je({openaiApiKey:e})}function Zr(e){if(!hn.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${hn.join(", ")}`);Je({openaiModel:e})}function eo(){var o;const e=document.getElementById("openai-key-input"),t=document.getElementById("openai-model-select"),r=document.getElementById("config-save"),i=document.querySelectorAll("#config-close, #config-close-bottom");e.value=Mt(),t.value=mn(),r.addEventListener("click",()=>{var n;Qr(e.value),Zr(t.value),Yr(),(n=document.getElementById("userconfig-modal"))==null||n.classList.add("hidden")}),i.forEach(n=>{n.addEventListener("click",()=>{var s;e.value=Mt(),t.value=mn(),(s=document.getElementById("userconfig-modal"))==null||s.classList.add("hidden")})}),(o=document.getElementById("key-not-set-ok"))==null||o.addEventListener("click",()=>{var n;(n=document.getElementById("openai-key-not-set-modal"))==null||n.classList.add("hidden")})}function to(e,t){return e/t()}function Qn(e,t){const r=t.snapResolution||.25,i=t.isTripletMode?r*(2/3):r;return Math.round(e/i)*i}function no(e,t,r){const i=to(e,r);return Qn(i,t)}const ro={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function _(e){const t=e==null?void 0:e.match(/^([A-Ga-g])([#b]*)(-?\d+)$/);if(!t)return null;const[,r,i,o]=t,n=r.toUpperCase(),s=ro[n];if(s===void 0)return null;const l=[...i].reduce((u,a)=>a==="#"?u+1:a==="b"?u-1:u,0);return 12*(parseInt(o,10)+1)+(s+l)}const oo=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],io=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];function de(e,t=!1){const i=(t?io:oo)[e%12],o=Math.floor(e/12)-1;return`${i}${o}`}function so(e){return e.replace(/\d+$/,"")}function ao(e){return e.includes("#")}function Zn(e,t,r,i,o,n=4){e.beginPath(),e.moveTo(t+n,r),e.lineTo(t+i-n,r),e.quadraticCurveTo(t+i,r,t+i,r+n),e.lineTo(t+i,r+o-n),e.quadraticCurveTo(t+i,r+o,t+i-n,r+o),e.lineTo(t+n,r+o),e.quadraticCurveTo(t,r+o,t,r+o-n),e.lineTo(t,r+n),e.quadraticCurveTo(t,r,t+n,r),e.closePath()}function co(e,t){const r=structuredClone(e);return r.tempo=t.bpm,r}function er(e){return{type:"CHANGE_TEMPO",bpm:e}}function lo(e){return er(e)}function uo(e,t){const r=structuredClone(e);return r.timeSignature=[t.beats,4],r}function tr(e){return{type:"SET_TIME_SIGNATURE",beats:e}}function fo(e){return tr(e)}function ho(e,t){const r=structuredClone(e);return r.totalMeasures=t.measures,r}function nr(e){return{type:"SET_TOTAL_MEASURES",measures:e}}function mo(e){return nr(e)}function po(e,t){const r=structuredClone(e);if(r.sequencers.push({id:t.id,instrument:t.instrument,notes:t.notes??[]}),!B.find(o=>o.id===t.id)){const o={id:t.id,instrument:t.instrument,notes:t.notes??[]},{wrapper:n}=Sr(o);nt(n,!0)}return r}function rr(e,t){return{type:"CREATE_SEQUENCER",id:e,instrument:t}}function $t(e){return{type:"DELETE_SEQUENCER",id:e}}function go(e,t){const r=structuredClone(e);r.sequencers=r.sequencers.filter(o=>o.id!==t.id);const i=B.findIndex(o=>o.id===t.id);return i!==-1&&(B[i].destroy(),B.splice(i,1)),r}function yo(e,t,r=[]){return{type:"DELETE_SEQUENCER",id:e,instrument:t,notes:structuredClone(r)}}function bo(e,t,r=[]){return{type:"CREATE_SEQUENCER",id:e,instrument:t,notes:structuredClone(r)}}function vo(e,t){const r=structuredClone(e),i=r.sequencers.find(o=>o.id===t.sequencerId);return i&&t.instrument&&(i.instrument=t.instrument),r}function wo(e,t){return{type:"SET_INSTRUMENT",sequencerId:e,instrument:t}}function Eo(e,t){return{type:"SET_INSTRUMENT",sequencerId:e,instrument:t}}const Pe=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function pn(e){return e<0&&(console.error(`Invalid trackId: ${e}. Using default color.`),e=0),Pe[e%Pe.length]}function So(e){return e&&typeof e.colorIndex=="number"?pn(e.colorIndex):(console.error(`Invalid sequencer colorIndex: ${e==null?void 0:e.colorIndex}. Using default color.`),pn(0))}function Qe(e,t,r,i=0){const o=e.getContext("2d");if(!o)return;o.imageSmoothingEnabled=!1;const n=e.width,s=e.height;if(o.clearRect(0,0,n,s),!t.length)return;const l=Pe[i%Pe.length];o.fillStyle=l;const c=H(),u=t.map(g=>_(g.pitch)).filter(g=>g!==null);if(!u.length)return;let a=Math.min(...u),d=Math.max(...u),h=Math.max(1,d-a);for(;s%h!==0;)d++,h=d-a;const f=s/h;for(const g of t){const v=_(g.pitch);if(v==null)continue;const w=g.start/c*n,b=g.duration/c*n,S=(v-a)/h,E=s-S*s-f/2,T=Math.round(w),C=Math.max(1,Math.round(b)),N=Math.round(E);o.fillRect(T,N,C,f)}const m=et(),y=tt();o.save();let p=1;y>256?p=16:y>128?p=8:y>32&&(p=4);for(let g=0;g<=y;g++){if(g%p!==0)continue;const w=g*m/c*n,b=Math.round(w)+.5;o.beginPath(),o.moveTo(b,0),o.lineTo(b,s);const S=p===1||g%(p*2)===0;o.strokeStyle=S?"rgba(255, 255, 255, 0.12)":"rgba(255, 255, 255, 0.04)",o.lineWidth=.2,o.stroke()}o.restore()}function X(e,t){const r=e.getContext("2d");if(!r)return;const i=e.width,o=e.height;r.clearRect(0,0,i,o);const n=H();for(const s of t){const{notes:l,config:c}=s;if(!(l!=null&&l.length))continue;const u=Pe[t.indexOf(s)%Pe.length];r.fillStyle=u;const a=_(c.noteRange[0]),d=_(c.noteRange[1]);if(a==null||d==null)continue;const h=d-a||1,f=Math.max(2,o/h);for(const m of l){const y=_(m.pitch);if(y==null)continue;const p=m.start/n*i,g=Math.max(1,m.duration/n*i),v=(y-a)/h,w=o-v*o-f/2;r.fillRect(p,w,g,f)}}}function ko(e,t){X(e,t)}function Io(e,t){const r=structuredClone(e),i=r.sequencers.find(n=>n.id===t.sequencerId);if(!i)return e;i.notes.push(...t.notes);const o=document.getElementById("global-mini-contour");return o&&X(o,B),r}function Co(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function To(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function No(e,t){const r=structuredClone(e),i=r.sequencers.find(s=>s.id===t.sequencerId);if(!i)return e;const o=new Set(t.notes.map(s=>`${s.pitch}|${s.start}|${s.duration}`));i.notes=i.notes.filter(s=>{const l=`${s.pitch}|${s.start}|${s.duration}`;return!o.has(l)});const n=document.getElementById("global-mini-contour");return n&&X(n,B),r}function Wt(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function jt(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Bo(e,t){const r=structuredClone(e),i=r.sequencers.find(s=>s.id===t.sequencerId);if(!i)return e;const o=t.from,n=t.to;for(let s=0;s<o.length;s++){const l=o[s],c=n[s],u=i.notes.findIndex(a=>a.pitch===l.pitch&&a.start===l.start&&a.duration===l.duration);u!==-1&&(i.notes[u].pitch=c.pitch,i.notes[u].start=c.start)}return r}function zt(e,t,r){return{type:"MOVE_NOTES",sequencerId:e,from:structuredClone(t),to:structuredClone(r)}}function or(e,t,r){return zt(e,r,t)}function Mo(e,t){const r=structuredClone(e),i=r.sequencers.find(n=>n.id===t.sequencerId);if(!i)return e;const o=new Set(t.notes.map(n=>`${n.pitch}|${n.start}|${n.duration}`));return i.notes=i.notes.filter(n=>{const s=`${n.pitch}|${n.start}|${n.duration}`;return!o.has(s)}),r}function _o(e,t){return{type:"CUT_NOTES",sequencerId:e,notes:structuredClone(t)}}function Lo(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Po(e,t){const r=structuredClone(e),i=r.sequencers.find(o=>o.id===t.sequencerId);return i?(i.notes.push(...t.notes),r):e}function qo(e,t){return{type:"PASTE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Oo(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Ro(e,t){return structuredClone(e)}function Fo(e,t){const r=structuredClone(e),i=r.sequencers.find(s=>s.id===t.sequencerId);if(!i)return e;const o=t.resizes;for(const s of o){const l=i.notes.find(c=>c.pitch===s.pitch&&c.start===s.start);l&&(l.duration=s.newDuration)}const n=document.getElementById("global-mini-contour");return n&&X(n,B),r}function Uo(e,t){return{type:"RESIZE_NOTES",sequencerId:e,resizes:structuredClone(t)}}function Ao(e,t){const r=t.map(i=>({pitch:i.pitch,start:i.start,newDuration:i.oldDuration}));return{type:"RESIZE_NOTES",sequencerId:e,resizes:r}}function xo(e,t){return structuredClone(e)}function Kt(e=""){return{type:"CHECKPOINT",label:e}}function ir(e=""){return Kt(e)}const Do=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_TEMPO:co,CHECKPOINT:xo,CREATE_SEQUENCER:po,CUT_NOTES:Mo,DELETE_NOTES:No,DELETE_SEQUENCER:go,MOVE_NOTES:Bo,PASTE_NOTES:Po,PLACE_NOTES:Io,RESIZE_NOTES:Fo,SET_INSTRUMENT:vo,SET_TIME_SIGNATURE:uo,SET_TOTAL_MEASURES:ho,UPDATE_NOTE_VELOCITY:Ro},Symbol.toStringTag,{value:"Module"}));function Gt(e){const t=Do[e.type];if(!t)throw new Error(`Unknown diff type: ${e.type}`);const r=t(Oe(),e);sr(r)}const _t=new Set;function Ho(e){return _t.add(e),()=>_t.delete(e)}function Ze(e){for(const t of _t)t(e)}const ae=[];let ne=-1;const $o=100;function Wo({forwardDiff:e,reverseDiff:t}){ae.splice(ne+1),ae.push({forwardDiff:e,reverseDiff:t}),ne=ae.length-1,ae.length>$o&&(ae.shift(),ne--)}function jo(){var e;if(ne<0)return null;for(let t=ne;t>=0;t--){const r=ae[t];if(((e=r==null?void 0:r.forwardDiff)==null?void 0:e.type)==="CHECKPOINT")return null;if(r!=null&&r.reverseDiff)return ne=t-1,Gt(r.reverseDiff),Ze(Oe()),r.reverseDiff}return null}function zo(){if(ne>=ae.length-1)return null;ne++;const e=ae[ne];return!e||!e.forwardDiff?null:(Gt(e.forwardDiff),Ze(Oe()),e.forwardDiff)}function Ko(){ae.length=0,ne=-1}let dt={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[]};function Oe(){return dt}function sr(e){dt=structuredClone(e),Ze(dt)}function F(e,t){Gt(e),Wo({forwardDiff:e,reverseDiff:t}),Ze(dt)}let G=null,te=500,Ne=null,ft=!1,Lt=1/0,Be=[],ut=null,ar=0,cr=4,lr=8;function Pt(e){return Be.push(e),()=>{const t=Be.indexOf(e);t!==-1&&Be.splice(t,1)}}function Go(){Be=[]}function fe(e){ar=e}function ht(){return ar}function H(){return tt()*et()}function Xt(e,t=!0){if(t){const i=Ee();F(er(e),lo(i));return}if(ur()){const i=performance.now(),o=(i-(Ne??i))/te;te=60/e*1e3,Ne=i-o*te}else te=60/e*1e3;const r=document.getElementById("tempo-input");r&&r.value!==String(e)&&(r.value=String(e))}function Ee(){return 60/(te/1e3)}function Vt(e,t=!0){if(t){const i=et();F(tr(e),fo(i));return}cr=e;const r=document.getElementById("beats-per-measure-input");r&&r.value!==String(e)&&(r.value=String(e)),he().forEach(i=>{var o,n;(o=i.grid)!=null&&o.resizeAndRedraw?i.grid.resizeAndRedraw():(n=i.grid)==null||n.scheduleRedraw()})}function et(){return cr}function Yt(e,t=!0){if(t){const i=tt();F(nr(e),mo(i));return}lr=e;const r=document.getElementById("measures-input");r&&r.value!==String(e)&&(r.value=String(e)),he().forEach(i=>{var o;(o=i.grid)==null||o.scheduleRedraw()})}function tt(){return lr}function Xo(e){ft=e}function Vo(e){ut=e}function Yo(){return z.snapResolution}function Jo(e,t={}){te=60/e*1e3,ft=t.loop??!1,Lt=t.endBeat??1/0;const r=t.startBeat??0;Ne=performance.now()-r*te;const i=t.onLoop;function o(n){const l=(n-(Ne??n))/te;if(fe(l),Be.forEach(c=>c(l)),l>=Lt)if(ft)Ne=performance.now(),fe(0),i&&i();else{mt();return}G=requestAnimationFrame(o)}G=requestAnimationFrame(o)}function mt(){G!==null&&cancelAnimationFrame(G),G=null,Go(),ut&&(ut(),ut=null)}function ur(){return G!==null}function dr(){G!==null&&cancelAnimationFrame(G),G=null}function fr(){if(G!==null)return;const e=performance.now()-ht()*te;function t(r){const o=(r-e)/te;if(fe(o),Be.forEach(n=>n(o)),o>=Lt)if(ft)Ne=performance.now(),fe(0);else{mt();return}G=requestAnimationFrame(t)}G=requestAnimationFrame(t)}const gn={Midnight:{whiteKey:"#1e1e1e",blackKey:"#2a103b",labelWhite:"#2c2c2c",labelBlack:"#3a1d4d",textWhite:"#cfcfcf",textBlack:"#e6d9ff",gridLine:"#333",beatLine:"#4e3d63",measureLine:"#8561c2"},Seashell:{whiteKey:"#fefefe",blackKey:"#f1e7dc",labelWhite:"#dddddd",labelBlack:"#d4cfc9",textWhite:"#444",textBlack:"#663300",gridLine:"#ccc",beatLine:"#bbb",measureLine:"#999"},Cyberpunk:{whiteKey:"#1b1b2f",blackKey:"#162447",labelWhite:"#1f4068",labelBlack:"#1f4068",textWhite:"#e43f5a",textBlack:"#e43f5a",gridLine:"#1f4068",beatLine:"#e43f5a",measureLine:"#ffcc00"},"Classic Blue":{whiteKey:"#f5faff",blackKey:"#dceeff",labelWhite:"#aaccee",labelBlack:"#88bbdd",textWhite:"#002244",textBlack:"#001122",gridLine:"#99bbdd",beatLine:"#88aacc",measureLine:"#336699"},Darkroom:{whiteKey:"#2c2c2c",blackKey:"#1e1e1e",labelWhite:"#383838",labelBlack:"#2a2a2a",textWhite:"#a0a0a0",textBlack:"#e0e0e0",gridLine:"#404040",beatLine:"#606060",measureLine:"#808080"}};function Qo(e,t,r,i,o,n){const{gridColorScheme:s}=qe(),l=gn[s]||gn.Darkroom,c=et(),u=H(),a=u*i,d=r*o;e.font=`${Math.floor(o*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let h=0;h<r;h++){const f=h*o,m=n(h),y=ao(m);e.fillStyle=y?l.blackKey:l.whiteKey,e.fillRect(0,f,a,o),e.fillStyle=y?l.labelBlack:l.labelWhite,e.fillRect(-64,f,Y,o),e.fillStyle=y?l.textBlack:l.textWhite,e.fillText(m,-8,f+o/2)}e.strokeStyle=l.gridLine,e.lineWidth=1;for(let h=0;h<r;h++){const f=h*o;e.beginPath(),e.moveTo(0,f),e.lineTo(a,f),e.stroke()}for(let h=0;h<=u;h++){const f=h*i,m=h%c===0;e.strokeStyle=m?l.measureLine:l.beatLine,e.lineWidth=m?2:1,e.beginPath(),e.moveTo(f,0),e.lineTo(f,d),e.stroke()}}const Zo={Scriabin:(e,{getPitchClass:t}={})=>{const r=t?t(e.pitch):0;return Xr[r]||"#999"},"Track Color":(e,{getTrackColor:t}={})=>(t==null?void 0:t())||"#999","Octave Bands":e=>{const t=_(e.pitch);return t==null?"#999":`hsl(${t*3%360}, 100%, 60%)`},"Pitch Class Contrast":(e,{getPitchClass:t}={})=>{const r=_(e.pitch);if(r==null)return"#999";const i=r%12;return["#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f"][i]||"#999"}};function ei(e,t=1){if(e.startsWith("#")){const r=parseInt(e.slice(1),16),i=r>>16&255,o=r>>8&255,n=r&255;return`rgba(${i}, ${o}, ${n}, ${t})`}if(e.startsWith("hsl(")){const[r,i,o]=e.slice(4,-1).split(",").map(c=>parseFloat(c.trim())),[n,s,l]=ti(r,i/100,o/100);return`rgba(${n}, ${s}, ${l}, ${t})`}return e}function ti(e,t,r){const i=(1-Math.abs(2*r-1))*t,o=i*(1-Math.abs(e/60%2-1)),n=r-i/2;let s=0,l=0,c=0;return 0<=e&&e<60?[s,l,c]=[i,o,0]:60<=e&&e<120?[s,l,c]=[o,i,0]:120<=e&&e<180?[s,l,c]=[0,i,o]:180<=e&&e<240?[s,l,c]=[0,o,i]:240<=e&&e<300?[s,l,c]=[o,0,i]:300<=e&&e<360&&([s,l,c]=[i,0,o]),[Math.round((s+n)*255),Math.round((l+n)*255),Math.round((c+n)*255)]}function ni(e,t,{previewNotes:r=null,hoveredNote:i,selectedNote:o,selectedNotes:n=[],highlightedNotes:s=[],cellWidth:l,cellHeight:c,visibleStartBeat:u,visibleEndBeat:a,getPitchRow:d,getPitchClass:h,getTrackColor:f,drawRoundedRect:m}){const{noteColorScheme:p}=qe(),g=Zo[p]||(()=>"#999");for(const v of t){if(v.start+v.duration<u-2||v.start>a)continue;const w=v.start*l,b=d(v.pitch)*c,S=v.duration*l,E=c-1,T=g(v,{getPitchClass:h,getTrackColor:f});e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=s.includes(v)?"rgba(96, 165, 250, 0.6)":T,m(e,w,b,S,E),e.fill();const C=e.createLinearGradient(w,b,w,b+E);C.addColorStop(0,"rgba(255,255,255,0.4)"),C.addColorStop(.2,"rgba(255,255,255,0.15)"),C.addColorStop(.5,"rgba(255,255,255,0.05)"),C.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=C,m(e,w,b,S,E),e.fill();const N=n.includes(v),L=v===i,M=s.includes(v);(N||L||M)&&(e.lineWidth=N?3:2,e.strokeStyle=N?"rgba(0, 255, 255, 1.0)":L?"rgba(255, 255, 255, 0.9)":"rgba(255, 200, 50, 0.7)",m(e,w,b,S,E),e.stroke())}if(r)for(const v of r){const w=v.start*l,b=d(v.pitch)*c,S=v.duration*l,E=c-1,T=g(v,{getPitchClass:h,getTrackColor:f});e.fillStyle=ei(T,.4),m(e,w,b,S,E),e.fill()}}function ri(e,t,r,i){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+r,0),e.lineTo(t+r,i),e.stroke(),e.restore()}function oi(e,t,r,i=Y){const o=e.getBoundingClientRect(),n=parseFloat(e.style.width||`${o.width}`),s=parseFloat(e.style.height||`${o.height}`),l=e.width/n,c=e.height/s,u=(t.clientX-o.left)*l-i,a=(t.clientY-o.top)*c;return{x:u,y:a}}function ii(e,t,r,i,o,n){const s=Math.floor(t/o),l=e/n;return r.find(c=>l>=c.start&&l<c.start+c.duration&&i(c.pitch)===s)}function yn(e,t){const r=_(e),i=_(t);if(r===null||i===null)throw new Error(`Invalid pitches provided: ${e}, ${t}`);return r-i}function si(e,t,r,i){const o=e.querySelector(".zoom-in-btn"),n=e.querySelector(".zoom-out-btn"),s=e.querySelector(".zoom-reset-btn");!o||!n||!s||(o.addEventListener("click",t),n.addEventListener("click",r),s.addEventListener("click",i))}let vt=!1,pt=null,D=null;function ai(e){vt=!0,pt=e,D=null}function Jt(){var e;if(D){if(!D.gridContext.setPastePreviewNotes)return;D.gridContext.setPastePreviewNotes(null),D.scheduleRedraw(),(e=D.setCursor)==null||e.call(D,"default")}vt=!1,pt=null,D=null,document.body.style.cursor="default"}function Qt(){return vt}function ci(e,t){!vt||!pt||(pt(e,t),Jt())}function li(e){if(D&&D!==e){if(!D.gridContext.setPastePreviewNotes)return;D.gridContext.setPastePreviewNotes(null),D.scheduleRedraw()}D=e}const ce={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let hr=ce.NOTE_PLACEMENT;const qt=new Set;function mr(){return hr}function J(e){Jt(),hr=e;for(const t of qt)t(e)}function ui(e){return qt.add(e),()=>qt.delete(e)}let Zt=!1;function di(){Zt=!0,J(ce.SELECT)}function Me(){Zt=!1}function _e(){return Zt}let en=!1;function je(e=!0){en=e}function bn(){return en}function vn(){en=!1}let pr={notes:[],anchorBeat:0,anchorMidi:0};function gr(e){if(e.length===0)return;const t=e[0],r=t.start,i=_(t.pitch)??0;pr={notes:e.map(o=>({pitch:o.pitch,start:o.start,duration:o.duration})),anchorBeat:r,anchorMidi:i}}function Ot(){return pr}let tn=null,nn=null;function fi(e){tn=e}function Rt(){return tn}function wn(){tn=null}function En(e,t,r){nn={anchorNote:e,startX:t,startY:r,originalDuration:e.duration}}function Et(){return nn}function hi(){nn=null}function yr(e,t,r){if(!e.setPastePreviewNotes)return;if(!Qt()){e.setPastePreviewNotes(null);return}const{notes:i,anchorBeat:o,anchorMidi:n}=Ot(),s=e.getSnappedBeatFromX(t),l=e.getPitchFromRow(Math.floor(r/e.getCellHeight())),c=_(l);if(c===null)return;const u=s-o,a=c-n,d=i.map(h=>{const f=_(h.pitch);return f===null?{...h}:{pitch:de(f+a)??h.pitch,start:h.start+u,duration:h.duration}});e.setPastePreviewNotes(d),e.scheduleRedraw()}function br(e){e.setPastePreviewNotes&&Qt()&&e.setPastePreviewNotes(null)}function vr(e,t){return Qt()?(ci(e.grid,t),t.preventDefault(),t.stopPropagation(),!0):!1}let ze=null;const mi=8;function Sn(){ze=null}function pi(e,t){ze={x:e,y:t}}function gi(e,t){if(!ze)return!1;const r=e-ze.x,i=t-ze.y;return Math.sqrt(r*r+i*i)>=mi}let Te=null;function $e(e){Te&&Te!==e&&Te.clearSelection(),Te=e}function yi(){Te=null}function rn(){return Te}function bi(e,t,{getPitchRow:r,cellWidth:i,cellHeight:o,labelWidth:n}){const s=t.start*i+n,l=r(t.pitch)*o,c=t.duration*i,u=o-1,a=s+c/2,d=l+u/2,h=_(t.pitch);if(h===null)return;const f=h*5%360,m=e.animationCtx,y=performance.now(),p=500,g=3,v=60;function w(E,T,C){const N=Math.sin(E*Math.PI),L=1+T*N,M=(1-E)*C;m.globalAlpha=M,m.strokeStyle=`hsl(${f}, 100%, 65%)`,m.lineWidth=2;const U=c*L,A=u*L;m.beginPath(),m.roundRect(a-U/2,d-A/2,U,A,4),m.stroke()}function b(E){const T=Math.sin(E*Math.PI),N=`hsla(${f}, 100%, 80%, ${.4*T})`;m.globalAlpha=1,m.fillStyle=N,m.beginPath(),m.roundRect(s,l,c,u,3),m.fill()}function S(E){const T=E-y,C=T/p;if(C>1){m.clearRect(0,0,m.canvas.width,m.canvas.height);return}m.clearRect(0,0,m.canvas.width,m.canvas.height),m.save(),b(C);for(let N=0;N<g;N++){const L=N*v,M=Math.max(0,Math.min(1,(T-L)/(p-L)));w(M,.1+N*.1,.2)}m.restore(),requestAnimationFrame(S)}requestAnimationFrame(S)}function vi(e,t,{getPitchRow:r,cellWidth:i,cellHeight:o,labelWidth:n}){const s=t.start*i+n,l=r(t.pitch)*o,c=t.duration*i,u=o-1,a=s+c/2,d=l+u/2,h=_(t.pitch);if(h===null)return;const f=h*5%360,m=e.animationCtx,y=performance.now(),p=300;function g(v){const b=(v-y)/p;if(b>1){m.clearRect(0,0,m.canvas.width,m.canvas.height);return}m.clearRect(0,0,m.canvas.width,m.canvas.height),m.save();const S=1-.4*b,E=1-b,T=c*S,C=u*S;m.globalAlpha=E,m.fillStyle=`hsl(${f}, 100%, 70%)`,m.beginPath(),m.roundRect(a-T/2,d-C/2,T,C,3),m.fill(),m.restore(),requestAnimationFrame(g)}requestAnimationFrame(g)}function St(e,t,r,i){if(!e||typeof e.getCellWidth!="function"||typeof e.getCellHeight!="function"||typeof e.getPitchRow!="function")return console.error("Invalid ctx object passed to isOnResizeHandle"),!1;const o=e.getCellWidth(),n=e.getCellHeight(),s=e.getPitchRow,l=Math.min(10,n*.8),u=(t.start+t.duration)*o+6,a=s(t.pitch)*n+(n-l)/2,d=4,h=u-d,f=u+l+d,m=a-d,y=a+l+d;return r>=h&&r<=f&&i>=m&&i<=y?console.log("Hit resize handle!"):console.log("Missed resize handle."),r>=h&&r<=f&&i>=m&&i<=y}function kn(e){let t=null,r=null,i=!1;function o(a){var v;if(console.log("ClickHandler called"),$e(e.grid),bn()){vn(),e.scheduleRedraw();return}const{x:d,y:h}=e.getCanvasPos(a);if(d<0){const w=e.getPitchFromRow(Math.floor(h/e.getCellHeight()));e.sequencer.playNote(w,.5);return}const f=e.getSnappedBeatFromX(d),m=e.getPitchFromRow(Math.floor(h/e.getCellHeight())),y=H();if(f+e.config.currentDuration>y||e.notes.some(w=>w.pitch===m&&w.start===f))return;e.sequencer.playNote(m,.5);const g={pitch:m,start:f,duration:e.config.currentDuration};F(Co(e.sequencer.id,[g]),To(e.sequencer.id,[g])),e.setSelectedNote(null),bi(e,g,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:Y}),e.scheduleRedraw(),(v=e.onNotesChanged)==null||v.call(e)}function n(a){a.preventDefault();const{x:d,y:h}=e.getCanvasPos(a),f=e.findNoteAt(d,h);if(!f||e.notes.indexOf(f)===-1)return;vi(e,f,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:Y});const y=[f];F(Wt(e.sequencer.id,y),jt(e.sequencer.id,y)),vn(),e.setSelectedNote(null),e.scheduleRedraw()}function s(a){if(vr(e,a))return;const{x:d,y:h}=e.getCanvasPos(a),f=e.findNoteAt(d,h),m=Rt();if(m&&St(e,m,d,h)){En(m,d,h);return}if(f){if(St(e,f,d,h)){console.log("Resize mode started!"),En(f,d,h);return}$e(e.grid),e.setSelectedNote(f),$e(e.grid),e.setSelectedNote(f),t={startX:d,startY:h,anchorNote:f,initialNotes:[{note:f,start:f.start,midi:_(f.pitch)??0}],lastPreviewPitch:void 0};return}pi(d,h),i=!1}function l(a){var g,v,w;e.grid.setCursor("default");const{x:d,y:h}=e.getCanvasPos(a);if(d<0){e.clearPreview();return}const f=Et();if(f){e.grid.setCursor("ew-resize");const b=d-f.startX,S=e.getSnappedBeatFromX(b)-e.getSnappedBeatFromX(0),E=Math.max(Yo(),f.originalDuration+S);f.anchorNote.duration=E,e.scheduleRedraw(),(g=e.onNotesChanged)==null||g.call(e);return}yr(e,d,h),wn(),e.grid.setCursor("default");const m=((v=e.getSelectedNotes)==null?void 0:v.call(e))??[];for(const b of m)if(St(e,b,d,h)){fi(b),e.grid.setCursor("ew-resize");break}if(!f&&!i&&gi(d,h)){di(),e.selectionBox={active:!0,startX:d,startY:h,currentX:d,currentY:h},i=!0,$e(e.grid),Sn();return}const y=e.findNoteAt(d,h);e.setHoveredNote(y??null);const p=e.getSelectedNote();if(Et()||(t&&p?e.grid.setCursor("grabbing"):y&&e.grid.setCursor("grab")),!y&&!t&&!bn()&&!Rt()){const b=e.getSnappedBeatFromX(d),S=e.getPitchFromRow(Math.floor(h/e.getCellHeight())),E=H();b+e.config.currentDuration<=E?e.updatePreview({pitch:S,start:b,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&p){const b=d-t.startX,S=e.getSnappedBeatFromX(b)-e.getSnappedBeatFromX(0),E=h-t.startY,T=Math.round(E/e.getCellHeight()),C=Math.max(0,t.initialNotes[0].start+S),N=H();C+p.duration<=N&&(p.start=C);const L=t.initialNotes[0].midi-T,M=_(e.config.noteRange[0])??0,U=_(e.config.noteRange[1])??127,A=Math.max(M,Math.min(U,L)),x=de(A)??p.pitch;x!==p.pitch&&(p.pitch=x,r!==x&&(r=x,e.sequencer.playNote(x,.5))),e.scheduleRedraw(),(w=e.onNotesChanged)==null||w.call(e),je();return}e.scheduleRedraw()}function c(a){console.log("UpHandler called"),Sn(),i=!1;const d=Et();if(d){const{anchorNote:p,originalDuration:g}=d,v=p.duration;g!==v&&F(Uo(e.sequencer.id,[{pitch:p.pitch,start:p.start,newDuration:v}]),Ao(e.sequencer.id,[{pitch:p.pitch,start:p.start,oldDuration:g}])),hi(),je();return}if(!t||!e.getSelectedNote()){t=null;return}const{anchorNote:h}=t,f=t.initialNotes.find(p=>p.note===h);if(!f)return;const m={pitch:f.note.pitch,start:f.note.start,duration:f.note.duration};(f.start!==f.note.start||f.midi!==_(f.note.pitch))&&F(zt(e.sequencer.id,[{pitch:de(f.midi)??f.note.pitch,start:f.start,duration:f.note.duration}],[m]),or(e.sequencer.id,[{pitch:de(f.midi)??f.note.pitch,start:f.start,duration:f.note.duration}],[m])),je(),t=null}function u(){e.clearPreview(),e.setHoveredNote(null),wn(),br(e),e.scheduleRedraw()}return{attach(a){a.addEventListener("click",o),a.addEventListener("contextmenu",n),a.addEventListener("mousemove",l),a.addEventListener("mouseleave",u),a.addEventListener("mousedown",s),a.addEventListener("mouseup",c)},detach(a){a.removeEventListener("click",o),a.removeEventListener("contextmenu",n),a.removeEventListener("mousemove",l),a.removeEventListener("mouseleave",u),a.removeEventListener("mousedown",s),a.removeEventListener("mouseup",c)}}}function In(e,{startX:t,currentX:r,startY:i,currentY:o,getCellHeight:n,getSnappedBeatFromX:s,getPitchFromRow:l}){const c=Math.min(t,r),u=Math.min(i,o),a=Math.max(t,r),d=Math.max(i,o),h=Math.floor(u/n()),f=Math.floor(d/n()),m=s(c),y=s(a),p=_(l(h)),g=_(l(f));return e.filter(v=>{const w=_(v.pitch);if(w===null||p===null||g===null)return!1;const b=v.start,E=v.start+v.duration>m&&b<y,T=w>=g-1&&w<=p+1;return E&&T})}function Cn(e){let t=null;function r(l){l.preventDefault();const{x:c,y:u}=e.getCanvasPos(l),a=e.findNoteAt(c,u);if(!a)return;const d=e.getSelectedNotes(),h=d.includes(a)?d:[a];h.length&&(e.setSelectedNotes([]),F(Wt(e.sequencer.id,h),jt(e.sequencer.id,h)),_e()&&(Me(),J(ce.NOTE_PLACEMENT)))}function i(l){if(!e.grid||vr(e,l))return;const{x:c,y:u}=e.getCanvasPos(l);if(c<0)return;const a=e.findNoteAt(c,u);e.setHoveredNote(a??null),$e(e.grid);const d=e.getSelectedNotes();if(a&&d.includes(a)){t={startX:c,startY:u,anchorNote:a,initialNotes:d.map(h=>({note:h,start:h.start,midi:_(h.pitch)??0}))};return}e.selectionBox={active:!0,startX:c,startY:u,currentX:c,currentY:u},e.clearPreview(),e.setSelectedNote(null)}function o(l){var b,S;if(!e.grid)return;li(e.grid);const{x:c,y:u}=e.getCanvasPos(l),a=e.findNoteAt(c,u);if(e.setHoveredNote(a??null),yr(e,c,u),(b=e.selectionBox)!=null&&b.active){if(!e.setHighlightedNotes)return;e.selectionBox.currentX=c,e.selectionBox.currentY=u;const E=e.selectionBox,T=In(e.notes,{startX:E.startX,currentX:E.currentX,startY:E.startY,currentY:E.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes(T),e.scheduleRedraw();return}if(!t)return;const d=t,h=c-d.startX,f=e.getSnappedBeatFromX(h)-e.getSnappedBeatFromX(0),m=u-d.startY,y=Math.round(m/e.getCellHeight()),p=H(),g=_(e.config.noteRange[0])??0,v=_(e.config.noteRange[1])??127;for(const{note:E,start:T,midi:C}of d.initialNotes){const N=Math.max(0,T+f),L=Math.max(g,Math.min(v,C-y)),M=de(L)??E.pitch;N+E.duration<=p&&(E.start=N,E.pitch=M)}const w=d.initialNotes.find(E=>E.note===d.anchorNote);if(w){const E=w.note.pitch;d.lastPreviewPitch!==E&&(d.lastPreviewPitch=E,e.sequencer.playNote(E,.5))}e.scheduleRedraw(),(S=e.onNotesChanged)==null||S.call(e)}function n(l){var c,u;if((c=t==null?void 0:t.initialNotes)!=null&&c.length){const{initialNotes:a}=t,d=a.map(({start:m,midi:y,note:p})=>({pitch:de(y)??p.pitch,start:m,duration:p.duration})),h=a.map(({note:m})=>({pitch:m.pitch,start:m.start,duration:m.duration}));d.some((m,y)=>m.pitch!==h[y].pitch||m.start!==h[y].start)&&(F(zt(e.sequencer.id,d,h),or(e.sequencer.id,d,h)),_e()&&(Me(),J(ce.NOTE_PLACEMENT)))}if(t=null,(u=e.selectionBox)!=null&&u.active){if(!e.setHighlightedNotes)return;const{x:a,y:d}=e.getCanvasPos(l);e.selectionBox.currentX=a,e.selectionBox.currentY=d,e.selectionBox.active=!1;const h=In(e.notes,{startX:e.selectionBox.startX,currentX:e.selectionBox.currentX,startY:e.selectionBox.startY,currentY:e.selectionBox.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes([]),e.setSelectedNotes(h),e.scheduleRedraw(),_e()&&e.getSelectedNotes().length===0&&(l.stopPropagation(),Me(),J(ce.NOTE_PLACEMENT),je()),je()}}function s(){e.setHighlightedNotes&&(e.setHoveredNote(null),e.setHighlightedNotes([]),br(e),e.scheduleRedraw())}return{attach(l){l.addEventListener("mousedown",i),l.addEventListener("mousemove",o),l.addEventListener("mouseup",n),l.addEventListener("mouseleave",s),l.addEventListener("contextmenu",r)},detach(l){l.removeEventListener("mousedown",i),l.removeEventListener("mousemove",o),l.removeEventListener("mouseup",n),l.removeEventListener("mouseleave",s),l.removeEventListener("contextmenu",r)}}}function wi(e,t){const r=t.selectionBox;if(!r)return;const i=r.startX,o=r.startY,n=r.currentX,s=r.currentY,l=Math.min(i,n),c=Math.min(o,s),u=Math.abs(n-i),a=Math.abs(s-o);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),Zn(e,l,c,u,a,3),e.stroke(),e.restore()}function Ei(e,t,{cellWidth:r,cellHeight:i,getPitchRow:o,isHovered:n=!1}){const s=Math.min(10,i*.8),c=(t.start+t.duration)*r+6,u=o(t.pitch)*i+(i-s)/2;e.save(),e.shadowColor="rgba(0,0,0,0.4)",e.shadowBlur=3,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=n?"rgba(0, 255, 255, 0.95)":"rgba(255, 255, 255, 0.85)",e.beginPath(),e.moveTo(c,u),e.lineTo(c+s,u+s/2),e.lineTo(c,u+s),e.closePath(),e.fill();const a=e.createLinearGradient(c,u,c,u+s);a.addColorStop(0,"rgba(255,255,255,0.9)"),a.addColorStop(.5,"rgba(255,255,255,0.5)"),a.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=a,e.beginPath(),e.moveTo(c,u),e.lineTo(c+s,u+s/2),e.lineTo(c,u+s),e.closePath(),e.fill(),e.restore()}function Si(e,t,r,i,o,n,s){let l=null,c=null,u=null,a=null,d=[],h=2;const f=e.getContext("2d"),m=t.getContext("2d"),y=r.getContext("2d");if(!f||!m||!y)throw new Error("Failed to acquire required canvas contexts");const p=f,g=m,v=y;let w=it[h].cellWidth,b=it[h].cellHeight;const S=yn(n.noteRange[1],n.noteRange[0])+1,E=S*b,C=H()*w+Y;e.width=C,e.height=E,e.style.width=`${C}px`,e.style.height=`${E}px`,t.width=C,t.height=E,t.style.width=`${C}px`,t.style.height=`${E}px`,r.width=C,r.height=E,r.style.width=`${C}px`,r.style.height=`${E}px`;let N=null;function L(){N!==null&&cancelAnimationFrame(N),N=requestAnimationFrame(M)}function M(){var I,R;p.clearRect(0,0,e.width,e.height),p.save(),p.translate(Y,0),Qo(p,n,S,w,b,Re),ni(p,o,{previewNotes:c??(l?[l]:null),hoveredNote:u,selectedNote:a,selectedNotes:d,highlightedNotes:((I=k.getHighlightedNotes)==null?void 0:I.call(k))??[],cellWidth:w,cellHeight:b,visibleStartBeat:0,visibleEndBeat:e.width/w,getPitchRow:pe,getPitchClass:so,getTrackColor:()=>So(s),drawRoundedRect:Zn});for(const K of d)Ei(p,K,{cellWidth:w,cellHeight:b,getPitchRow:pe,isHovered:K===Rt()});(R=k.selectionBox)!=null&&R.active&&wi(p,k),p.restore()}function U(){h<it.length-1&&(h++,$())}function A(){h>0&&(h--,$())}function x(){h=2,$()}function $(){const I=it[h];w=I.cellWidth,b=I.cellHeight,O()}function O(){const R=H()*w+Y,V=(yn(n.noteRange[1],n.noteRange[0])+1)*b;e.width=R,e.height=V,e.style.width=`${R}px`,e.style.height=`${V}px`,t.width=R,t.height=V,t.style.width=`${R}px`,t.style.height=`${V}px`,r.width=R,r.height=V,r.style.width=`${R}px`,r.style.height=`${V}px`,v.clearRect(0,0,r.width,r.height),L()}function Se(I){ri(g,I,Y,e.height)}si(s.container,U,A,x);function pe(I){const R=_(n.noteRange[1]),K=_(I);return R===null||K===null?(console.warn(`Invalid pitch encountered: ${I}`),0):R-K}function Re(I){const R=_(n.noteRange[1]),K=_(n.noteRange[0]);if(R===null||K===null)return console.warn(`Invalid pitch range configured: ${n.noteRange}`),"C4";const V=R-I,Kr=Math.max(K,Math.min(R,V));return de(Kr)??"C4"}function Q(){const I=document.getElementById("global-mini-contour");I instanceof HTMLCanvasElement&&X(I,B)}let Z=null;const k={sequencer:s,grid:null,config:n,notes:o,canvas:e,animationCtx:v,getCellHeight:()=>b,getCellWidth:()=>w,getCanvasPos:I=>oi(e,I,i,Y),findNoteAt:(I,R)=>ii(I,R,o,pe,b,w),scheduleRedraw:L,getPitchFromRow:Re,getPitchRow:pe,getSnappedBeatFromX:I=>no(I,n,()=>w),updatePreview:I=>l=I,clearPreview:()=>l=null,getSelectedNote:()=>a,setSelectedNote:I=>{a=I,d=I?[I]:[]},getSelectedNotes:()=>d,setSelectedNotes:I=>{d=I,a=I.length===1?I[0]:null},setHoveredNote:I=>u=I,onNotesChanged:Q};function q(I){Z==null||Z.detach(e),Z=I,Z==null||Z.attach(e)}function P(){a=null,d=[],u=null,ot=[],L()}const j={"note-placement":()=>q(kn(k)),select:()=>q(Cn(k)),none:()=>q(null)};let re=ui(I=>{var R,K,V;l=null,c=null,ot=[],(R=k.clearPreview)==null||R.call(k),(K=k.setPastePreviewNotes)==null||K.call(k,null),k.selectionBox&&(k.selectionBox.active=!1,k.selectionBox=null),P(),(V=j[I])==null||V.call(j),L()});function rt(){return a}function Dr(){return l}function Hr(I){return I*w}function $r(I){e.style.cursor=I}function Wr(){return d}function jr(I){d=I,a=I.length===1?I[0]:null}function zr(){re(),yi()}const an={canvas:e,scheduleRedraw:L,drawPlayhead:Se,getSelectedNote:rt,clearSelection:P,getPreviewNote:Dr,zoomIn:U,zoomOut:A,getXForBeat:Hr,setMouseHandler:q,setCursor:$r,gridContext:k,getSelectedNotes:Wr,setSelectedNotes:jr,destroy:zr,resizeAndRedraw:O},cn=mr();let ln=null,un=null;cn==="note-placement"?(ln=kn(k),q(ln)):cn==="select"?(un=Cn(k),q(un)):q(null),k.setPastePreviewNotes=I=>{c=I};let ot=[];return k.getHighlightedNotes=()=>ot,k.setHighlightedNotes=I=>{ot=I},k.grid=an,an}function ki(e,t,{getPitchRow:r,cellWidth:i,cellHeight:o,labelWidth:n}){if(!(e!=null&&e.animationCtx)){console.warn("Missing animationCtx in animateNotePlay");return}const s=t.start*i+n,l=r(t.pitch)*o,c=t.duration*i,u=o-1,a=s+c/2,d=l+u/2,f=(_(t.pitch)||0)*5%360,m=e.animationCtx,y=document.createElement("canvas");y.width=m.canvas.width,y.height=m.canvas.height;let p=y.getContext("2d");if(!p){console.warn("Could not get animation context from offscreen canvas");return}const g=performance.now(),v=Ee();let w=t.duration*6e4/v;w=Math.max(100,Math.min(w,1600));const b=2,S=50;function E(N){const L=Math.sin(N*Math.PI),M=`hsla(${f}, 100%, 70%, ${.4*L})`;p&&(p.globalAlpha=1,p.fillStyle=M,p.beginPath(),p.roundRect(s,l,c,u,3),p.fill())}function T(N,L,M){const U=Math.sin(N*Math.PI),A=1+L*U,x=(1-N)*M;if(p){p.globalAlpha=x,p.strokeStyle=`hsl(${f}, 100%, 65%)`,p.lineWidth=1.5;const $=c*A,O=u*A;p.beginPath(),p.roundRect(a-$/2,d-O/2,$,O,4),p.stroke()}}function C(N){const L=N-g,M=L/w;if(M>1){p=null,y.width=0,y.height=0;return}if(p){p.clearRect(0,0,y.width,y.height),p.save(),E(M);for(let $=0;$<b;$++){const O=$*S,Se=Math.max(0,Math.min(1,(L-O)/(w-O)));T(Se,.1+$*.1,.3)}p.restore(),m.save();const U=1.5,A=c*U+8,x=u*U+8;m.clearRect(a-A/2,d-x/2,A,x),m.globalAlpha=1,m.drawImage(y,0,0),m.restore()}requestAnimationFrame(C)}requestAnimationFrame(C)}class wr{constructor(t,r,i=le,o=se,n="fluidr3-gm/acoustic_grand_piano"){this.notes=[],this.colorIndex=0,this.id=0,this.mute=!1,this.solo=!1,this.shouldPlay=!0,this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.container=t,this.config={...r},this.context=i,this.destination=o,this.instrumentName=n,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this.animationCanvas=this.container.querySelector(".note-animate-canvas"),this._initCanvases())}async initInstrument(){try{await gt(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){var r;const t=(r=this.container)==null?void 0:r.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument()}playNote(t,r,i=100,o=!1){return Xi(this.instrumentName,t,r,i,o)}_initCanvases(){if(!this.container)return;const t=this.container.querySelector("canvas.note-grid"),r=this.container.querySelector("canvas.playhead-canvas"),i=this.container.querySelector("#grid-scroll-container"),o=this.container.querySelector("canvas.note-animate-canvas");this.grid=Si(t,r,o,i,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(){var s,l,c;const t=H();this.clampNotesToGrid();const r=t*this.config.cellWidth+Y,i=(s=this.container)==null?void 0:s.querySelector("canvas.note-grid"),o=(l=this.container)==null?void 0:l.querySelector(".playhead-canvas"),n=(c=this.container)==null?void 0:c.querySelector(".mini-contour");i&&(i.width=r,i.style.width=`${r}px`),o&&(o.width=r,o.style.width=`${r}px`),n&&Qe(n,this.notes,this.config,this.colorIndex),this.redraw()}clampNotesToGrid(){const t=H(),r=this.notes.filter(i=>i.start<t);r.forEach(i=>{i.start+i.duration>t&&(i.duration=t-i.start)}),this.notes.splice(0,this.notes.length,...r)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear();const r=60/Ee();this._beatHandler=i=>{var o,n;if((o=this.grid)==null||o.drawPlayhead(this.grid.getXForBeat(i)),!!this.shouldPlay)for(const s of this.notes){const l=s.start,c=s.start+s.duration;if(!this._activeNotes.has(s)&&l<=i&&i<=c){const u=s.duration*r;if(this.playNote(s.pitch,u),(n=this.grid)!=null&&n.gridContext){const a=this.grid.gridContext;ki(a,s,{getPitchRow:a.getPitchRow,cellWidth:a.getCellWidth(),cellHeight:a.getCellHeight(),labelWidth:Y})}this._activeNotes.add(s)}}},this._unsub=Pt(this._beatHandler),this._beatHandler(0)}stop(){var t,r,i;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const o of this._activeNotes){const n=this._noteHandlers.get(o);(t=n==null?void 0:n.forceStop)==null||t.call(n),(r=n==null?void 0:n.stop)==null||r.call(n)}this._activeNotes.clear(),this._noteHandlers.clear(),(i=this.grid)==null||i.drawPlayhead(0),this.redraw()}pause(){var t;for(const r of this._activeNotes){const i=this._noteHandlers.get(r);(t=i==null?void 0:i.stop)==null||t.call(i)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=Pt(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.mute=!this.mute,this.mute&&(this.solo=!1),this.updateTrackStyle()}toggleSolo(){this.solo=!this.solo,this.solo&&(this.mute=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),r=this.container.querySelector(".solo-btn");t==null||t.classList.toggle("bg-red-600",this.mute),t==null||t.classList.toggle("bg-gray-700",!this.mute),r==null||r.classList.toggle("bg-yellow-200",this.solo),r==null||r.classList.toggle("bg-gray-700",!this.solo),this.container.classList.toggle("opacity-40",this.mute&&!this.solo),this.container.classList.toggle("opacity-100",!(this.mute&&!this.solo))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:r,instrument:i}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,r),i&&(this.instrumentName=i),this.redraw()}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([r,i,o])=>({pitch:r,start:i,duration:o})))}async exportToOffline(){const t=60/Ee(),r=await gt(this.instrumentName,this.context,this.destination);for(const i of this.notes){const o=i.start*t,n=i.duration*t,s=_(i.pitch);if(s!=null)if(this.instrumentName.startsWith("drummachines/")&&r.__midiMap){const l=r.__midiMap.get(s);l&&r.start({note:l,duration:n,velocity:100,time:o,loop:!1})}else r.start({note:s,duration:n,velocity:100,time:o,loop:!1})}}}const B=[],Ii=document.getElementById("sequencers-container"),Ci=document.getElementById("sequencer-template"),Er=document.getElementById("add-sequencer");function Sr(e){const r=Ci.content.cloneNode(!0).querySelector(".sequencer");Ii.insertBefore(r,Er);const i=B.length,o={id:i,...z},n=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",s=new wr(r,o,le,se,n);s.id=i,s.colorIndex=i,s.mute=!1,s.solo=!1,s.shouldPlay=!0;const l=r.querySelector("canvas.mini-contour");e&&s.setState({notes:e.notes,config:{},instrument:e.instrument}),Qe(l,s.notes,s.config,s.colorIndex),s.updateTrackLabel(),s.initInstrument();const c=r.querySelector(".collapse-btn"),u=c.querySelector("use"),a=r.querySelector(".sequencer-body");c.addEventListener("click",()=>{const y=a.classList.toggle("hidden");u.setAttribute("href",y?"#icon-caret-up":"#icon-caret-down"),l.classList.toggle("hidden",!y),nt(r,!y),y&&Qe(l,s.notes,s.config,s.colorIndex)}),r.querySelector(".delete-btn").addEventListener("click",()=>{const y=document.getElementById("delete-confirm-modal"),p=document.getElementById("delete-confirm"),g=document.getElementById("delete-cancel");y.classList.remove("hidden");const v=()=>{const S=yo(s.id,s.instrumentName,s.notes),E=bo(s.id,s.instrumentName,s.notes);F(S,E),b()},w=()=>{b()},b=()=>{y.classList.add("hidden"),p.removeEventListener("click",v),g.removeEventListener("click",w)};p.addEventListener("click",v),g.addEventListener("click",w)});const h=r.querySelector(".mute-btn"),f=r.querySelector(".solo-btn"),m=r.querySelector(".instrument-select-btn");return h.addEventListener("click",()=>{s.mute=!s.mute,s.mute&&(s.solo=!1,f.classList.remove("bg-yellow-200","hover:bg-yellow-400"),f.classList.add("bg-gray-700","hover:bg-purple-700"),Fe(f,!1)),Fe(h,s.mute),Tn(),s.seekTo(ht())}),f.addEventListener("click",()=>{s.solo=!s.solo,s.solo&&(s.mute=!1,Fe(h,!1)),f.classList.toggle("bg-yellow-200",s.solo),f.classList.toggle("bg-gray-700",!s.solo),f.classList.toggle("hover:bg-yellow-400",s.solo),f.classList.toggle("hover:bg-purple-700",!s.solo),Tn(),s.seekTo(ht())}),m.addEventListener("click",async()=>{const y=document.getElementById("instrument-select-modal"),p=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const g=s.instrumentName||"fluidr3-gm/acoustic_grand_piano",[v]=g.split("/");p.value=v,p.dispatchEvent(new CustomEvent("change",{detail:{preselect:g}})),y.dataset.currentSequencer=String(s.id),y.classList.remove("hidden")}),Ui(r),Fe(h,!1),Fe(f,!1),f.classList.add("hover:bg-purple-700"),B.push(s),{seq:s,wrapper:r}}function nt(e,t){var r,i,o,n,s;(r=e.querySelector(".zoom-in-btn"))==null||r.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-out-btn"))==null||i.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-reset-btn"))==null||o.classList.toggle("hidden",!t),(n=e.querySelector(".zoom-button-divider"))==null||n.classList.toggle("hidden",!t),(s=e.querySelector(".grip-handle"))==null||s.classList.toggle("hidden",!t)}function he(){return B}function Ti(e){const t=e;return B.find(r=>r.id===t)}function Tn(){const e=B.some(t=>t.solo);B.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function Fe(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function Ni(){B.slice().forEach(r=>r.destroy()),B.length=0;const e=Oe(),t=structuredClone(e);t.sequencers=[],Ko(),sr(t),Ze(t)}function Bi(){document.getElementById("global-mini-contour"),Er.addEventListener("click",()=>{const e=B.length;F(rr(e,"fluidr3-gm/acoustic_grand_piano"),$t(e))})}const Mi=["Darkroom","Seashell","Cyberpunk","Classic Blue","Midnight"],_i=["Track Color","Pitch Class Contrast","Scriabin","Octave Bands"];function Li(){const e=document.getElementById("grid-color-select"),t=document.getElementById("note-color-select");if(!e||!t)return;for(const i of Mi){const o=document.createElement("option");o.value=i,o.textContent=i,e.appendChild(o)}for(const i of _i){const o=document.createElement("option");o.value=i,o.textContent=i,t.appendChild(o)}const r=qe();e.value=r.gridColorScheme,t.value=r.noteColorScheme,e.addEventListener("change",i=>{const o=i.target;Je({gridColorScheme:o.value}),he().forEach(n=>{var s;return(s=n.grid)==null?void 0:s.scheduleRedraw()})}),t.addEventListener("change",i=>{const o=i.target;Je({noteColorScheme:o.value}),he().forEach(n=>{var s;return(s=n.grid)==null?void 0:s.scheduleRedraw()})})}function Pi(){const e=document.getElementById("userconfig-modal"),t=document.querySelectorAll(".settings-tab"),r=document.querySelectorAll(".settings-section");if(!e)return;function i(){t.forEach(o=>{const n=o.dataset.tab;if(!n)return;const s=document.getElementById(n),l=s!==null&&!s.classList.contains("hidden");o.classList.toggle("text-purple-500",l),o.classList.toggle("opacity-100",l),o.classList.toggle("text-gray-500",!l),o.classList.toggle("opacity-50",!l)})}t.forEach(o=>{o.addEventListener("click",()=>{const n=o.dataset.tab;if(!n)return;r.forEach(l=>l.classList.add("hidden"));const s=document.getElementById(n);s&&s.classList.remove("hidden"),i()})}),i(),eo(),Li()}let Nn=!1,ve=!1,we=!1;function qi({getSequencers:e,onPlay:t,onStop:r,onPause:i,onResume:o,onDurationChange:n,onSnapChange:s,onToggleLoop:l,onTempoChange:c,onSave:u,onLoad:a,onMeasuresChange:d,onBeatsPerMeasureChange:h}){if(Nn)return;Nn=!0;const f=document.getElementById("play-button"),m=f.querySelector("use"),y=document.getElementById("stop-button"),p=document.getElementById("note-duration"),g=document.getElementById("dotted-note-btn"),v=document.getElementById("triplet-note-btn"),w=document.getElementById("snap-resolution"),b=document.getElementById("loop-toggle"),S=document.getElementById("tempo-input"),E=document.getElementById("save-button"),T=document.getElementById("load-button"),C=document.getElementById("measures-input"),N=document.getElementById("beats-per-measure-input"),L=document.getElementById("config-button"),M=document.getElementById("export-modal"),U=document.getElementById("export-json"),A=document.getElementById("export-wav"),x=document.getElementById("export-midi"),$=document.getElementById("export-cancel");p.value=String(z.currentDuration||1),w.value=String(z.snapResolution||.25);const O=document.getElementById("import-modal"),Se=document.getElementById("import-json"),pe=document.getElementById("import-midi"),Re=document.getElementById("import-cancel"),Q=document.getElementById("load-input");T.addEventListener("click",()=>{O==null||O.classList.remove("hidden")}),Q&&Q.addEventListener("change",k=>{var j;const q=k.target,P=(j=q.files)==null?void 0:j[0];P&&a(P),q.value=""}),Se&&Se.addEventListener("click",()=>{O==null||O.classList.add("hidden"),Q&&(Q.setAttribute("accept",".json"),Q.click())}),pe&&pe.addEventListener("click",()=>{O==null||O.classList.add("hidden"),Q&&(Q.setAttribute("accept",".mid,.midi"),Q.click())}),Re&&Re.addEventListener("click",()=>{O==null||O.classList.add("hidden")}),m.setAttribute("href","#icon-play"),f.addEventListener("click",()=>{!ve&&!we?(ve=!0,we=!1,t(),m.setAttribute("href","#icon-pause")):ve?(ve=!1,we=!0,i(),m.setAttribute("href","#icon-play")):we&&(ve=!0,we=!1,o(),m.setAttribute("href","#icon-pause"))}),y.addEventListener("click",()=>{r(),ve=!1,we=!1,m.setAttribute("href","#icon-play")}),window.addEventListener("keydown",k=>{var j;if(document.querySelector(".ai-modal:not(.hidden)"))return;const P=(j=document.activeElement)==null?void 0:j.tagName;if(!(P==="INPUT"||P==="TEXTAREA")){if(k.code==="Space"){k.preventDefault(),f.click();return}if((k.metaKey||k.ctrlKey)&&(k.key==="z"&&jo(),k.key==="y"&&zo()),(k.metaKey||k.ctrlKey)&&k.key.toLowerCase()==="r"){k.preventDefault();return}if(mr()===ce.NOTE_PLACEMENT){if(Object.prototype.hasOwnProperty.call(fn,k.code)){k.preventDefault();const re=fn[k.code];p.value=String(re),p.dispatchEvent(new Event("change"))}if(k.key==="."){k.preventDefault(),g==null||g.click();return}if(k.key==="/"){k.preventDefault(),v==null||v.click();return}}}}),p.addEventListener("change",k=>{const q=k.target,P=parseFloat(q.value);Z(P),n(P),e().forEach(j=>{const re=j.grid;if(re!=null&&re.getPreviewNote){const rt=re.getPreviewNote();rt&&(rt.duration=P,re.scheduleRedraw())}})});function Z(k){document.querySelectorAll(".note-duration-btn").forEach(P=>{const j=parseFloat(P.dataset.value??"0");P.classList.remove("bg-purple-700","bg-gray-800"),j===k?P.classList.add("bg-purple-700"):P.classList.add("bg-gray-800")})}w.addEventListener("change",k=>{const P=k.target.value;Object.prototype.hasOwnProperty.call(Vr,P)&&(z.snapResolution=parseFloat(P),w.value=String(P),s(z.snapResolution))}),b.addEventListener("change",k=>{const q=k.target;l(q.checked)}),S.addEventListener("change",k=>{const q=k.target,P=parseInt(q.value,10);isNaN(P)||c(P)}),E.addEventListener("click",()=>{M?M.classList.remove("hidden"):u("json")}),U&&U.addEventListener("click",()=>{M==null||M.classList.add("hidden"),u==null||u("json")}),A&&A.addEventListener("click",()=>{M==null||M.classList.add("hidden"),u==null||u("wav")}),x&&x.addEventListener("click",()=>{M==null||M.classList.add("hidden"),u==null||u("midi")}),$&&$.addEventListener("click",()=>{M==null||M.classList.add("hidden")}),L==null||L.addEventListener("click",()=>{const k=document.getElementById("userconfig-modal");k==null||k.classList.remove("hidden")}),Pi(),C&&(C.value=String(tt())),N&&(N.value=String(et())),C==null||C.addEventListener("change",k=>{const q=k.target,P=parseInt(q.value,10);!isNaN(P)&&P>0&&(d==null||d(P))}),N==null||N.addEventListener("change",k=>{const q=k.target,P=parseInt(q.value,10);!isNaN(P)&&P>0&&(h==null||h(P))}),Z(parseFloat(p.value))}function Oi(){ve=!1,we=!1;const e=document.getElementById("play-button"),t=e==null?void 0:e.querySelector("use");t&&t.setAttribute("href","#icon-play")}function Ri(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function Fi(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}function Ui(e){const t=e.querySelector(".cursor-grab");if(!t)return;const r=e.querySelector(".sequencer-body");if(!r)return;let i=!1,o=0,n=0;const s=150,l=1e3;t.addEventListener("mousedown",c=>{i=!0,o=c.clientY,n=r.offsetHeight,t.classList.replace("cursor-grab","cursor-grabbing"),document.body.style.userSelect="none"}),window.addEventListener("mousemove",c=>{if(!i)return;const u=c.clientY-o;let a=n+u;a=Math.max(s,Math.min(l,a)),r.style.height=`${a}px`}),window.addEventListener("mouseup",()=>{i&&(i=!1,t.classList.replace("cursor-grabbing","cursor-grab"),document.body.style.userSelect="")})}let W=null,Ke=0;const kt=new Map;async function me(){W||(W=await Vn(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function kr(){return le}async function gt(e,t=le,r=null){var u;await me();const[i,o]=e.includes("/")?e.split("/"):["musyngkite",e],n=t instanceof OfflineAudioContext;kt.has(t)||kt.set(t,new Map);const s=kt.get(t),l=`${i}/${o}`;if(s.has(l))return s.get(l);let c;if(i==="smolken")c=new W.Smolken(t,{instrument:o,destination:r||se,disableScheduler:n}),await ke(c.load);else if(i==="splendidgrandpiano")c=new W.SplendidGrandPiano(t,{destination:r||se,disableScheduler:n}),await ke(c.load);else if(i==="electricpiano")c=new W.ElectricPiano(t,{instrument:o,destination:r||se,disableScheduler:n}),await ke(c.load);else if(i==="mallets")c=new W.Mallet(t,{instrument:o,destination:r||se,disableScheduler:n}),await ke(c.load);else if(i==="drummachines"){c=new W.DrumMachine(t,{instrument:o,destination:r||se,disableScheduler:n}),await ke(c.load);const a=((u=c.getSampleNames)==null?void 0:u.call(c))??[],d=new Map;a.forEach((h,f)=>{const m=36+f;d.set(m,h)}),c.__midiMap=d}else{const d={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[i.toLowerCase()]||"MusyngKite",h=await Wi();console.log(`[Soundfont] Available kits: ${h.join(", ")}`),console.log(`[Soundfont] Requested: kit=${d} instrument=${o}`);const m=`https://gleitz.github.io/midi-js-soundfonts/${d}/${o}-ogg.js`;c=new W.Soundfont(t,{instrument:o,instrumentUrl:m,kit:d,destination:r||se,disableScheduler:n}),await ke(c.load)}return s.set(l,c),c}async function Ai(){return await me(),W.getMalletNames()}async function xi(){return await me(),W.getElectricPianoNames()}async function Di(){return await me(),["splendidgrandpiano"]}async function Ir(){return await me(),W.getDrumMachineNames()}async function Hi(){return await me(),W.getSmolkenNames()}async function $i(e="MusyngKite"){await me();const t=await W.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function Wi(){return await me(),W.getSoundfontKits()}function ji(){Ke++,Ke===1&&Ri()}function zi(){Ke--,Ke<=0&&(Ke=0,Fi())}async function ke(e){ji();try{await e}finally{zi()}}let ee=null,Ft=null;async function Cr(e){if(Ft===e)return;ee=await gt(e),Ft=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function Ki(){return Ft}function Tr(e,t=100,r=!1){var l;if(!ee)return null;const o=kr().currentTime,n=_(e);if(n===null)return null;const s=((l=ee.__midiMap)==null?void 0:l.get(n))??n;return ee.start({note:s,stopId:s,velocity:t,time:o,loop:r}),()=>{ee==null||ee.stop({stopId:s})}}function Gi(e){var i;if(!ee)return;const t=_(e);if(t===null)return;const r=((i=ee.__midiMap)==null?void 0:i.get(t))??t;ee.stop({stopId:r})}async function Xi(e,t,r,i=100,o=!1,n=null,s=null,l=null){var h;const c=s||kr(),u=await gt(e,c,l),a=_(t);if(a===null)return null;const d=((h=u.__midiMap)==null?void 0:h.get(a))??a;return u.start({note:d,duration:r,velocity:i,loop:o,time:n??c.currentTime}),null}const le=new(window.AudioContext||window.webkitAudioContext),wt=le.createAnalyser();wt.fftSize=2048;const se=le.createGain();se.connect(wt);wt.connect(le.destination);function Vi(e){le.resume();try{const t=Tr(e,100,!1);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}le.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let Bn=!1,st=null;function Yi(e,t){if(Bn)return;Bn=!0,st=t;const r=e.getContext("2d");if(!r)return;const i=new Map,o=new Set;function n(a,d){const h=st();for(const f of Object.values(h))if(f.isBlack&&a>=f.x&&a<=f.x+f.width&&d>=0&&d<=f.height)return f.note;for(const f of Object.values(h))if(!f.isBlack&&a>=f.x&&a<=f.x+f.width&&d>=0&&d<=f.height)return f.note;return null}function s(a){if(!a||o.has(a))return;const d=Vi(a);d&&(i.set(a,d),o.add(a),r&&Ye(r,st(),o))}function l(a){if(!o.has(a))return;const d=i.get(a);d&&(d.stop(),i.delete(a)),o.delete(a),r&&Ye(r,st(),o)}function c(){for(const a of o)l(a)}let u=!1;e.addEventListener("mousedown",a=>{u=!0;const d=e.getBoundingClientRect(),h=a.clientX-d.left,f=a.clientY-d.top,m=n(h,f);s(m)}),e.addEventListener("mousemove",a=>{if(!u)return;const d=e.getBoundingClientRect(),h=a.clientX-d.left,f=a.clientY-d.top,m=n(h,f);s(m)}),e.addEventListener("mouseup",()=>{u=!1,c()}),e.addEventListener("mouseleave",()=>{u=!1,c()})}const Nr=[..."qwertyuiop[zxcvbnm,./"],Br=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];function Ji(){const e=document.getElementById("instrument-loop-toggle");return(e==null?void 0:e.checked)??!1}let Ut=!1,at=null,Ge=null,Xe=null;function Qi(e,t){if(Ut)return;Ut=!0;const r=e.getContext("2d");if(!r)throw new Error("Canvas 2D context not available.");const i=new Set,o=new Set,n=new Map,s=Nr,l=Br;at=t;function c(){const d=at(),h=Object.values(d).filter(y=>!y.isBlack).sort((y,p)=>y.x-p.x).map(y=>y.note),f=Object.values(d).filter(y=>y.isBlack).sort((y,p)=>y.x-p.x).map(y=>y.note),m={};return s.forEach((y,p)=>{h[p]&&(m[y]=h[p])}),l.forEach((y,p)=>{f[p]&&(m[y]=f[p])}),m}function u(d){const h=c(),f=h[d];if(!(!f||i.has(d))){if(i.add(d),!o.has(f)){const m=Tr(f,100,Ji());m&&(n.set(f,{stop:m}),o.add(f))}r&&Ye(r,at(),o,h)}}function a(d){const h=c(),f=h[d];f&&(i.delete(d),o.has(f)&&(Gi(f),n.delete(f),o.delete(f)),r&&Ye(r,at(),o,h))}Ge=d=>{d.repeat||u(d.key)},Xe=d=>{a(d.key)},window.addEventListener("keydown",Ge),window.addEventListener("keyup",Xe)}function Zi(){Ge&&(window.removeEventListener("keydown",Ge),Ge=null),Xe&&(window.removeEventListener("keyup",Xe),Xe=null),Ut=!1}let Ce=3,Ie=Yn(Ce),ct=!1;async function es(e){var n,s;const t=e.getContext("2d");if(!t)throw new Error("Failed to get 2D context for keyboard canvas");function r(){const l=Object.values(Ie).filter(a=>!a.isBlack).sort((a,d)=>a.x-d.x).map(a=>a.note),c=Object.values(Ie).filter(a=>a.isBlack).sort((a,d)=>a.x-d.x).map(a=>a.note),u={};return Nr.forEach((a,d)=>{l[d]&&(u[a]=l[d])}),Br.forEach((a,d)=>{c[d]&&(u[a]=c[d])}),u}function i(){if(!t)return;Ie=Yn(Ce);const l=ct?r():null;Ye(t,Ie,new Set,l)}Yi(e,()=>Ie),i(),(n=document.getElementById("octave-up"))==null||n.addEventListener("click",()=>{Ce<7&&(Ce++,i())}),(s=document.getElementById("octave-down"))==null||s.addEventListener("click",()=>{Ce>1&&(Ce--,i())});const o=document.getElementById("disable-keyboard-inputs");return o.classList.remove("bg-purple-600"),o.classList.add("bg-gray-700"),o.addEventListener("click",()=>{ct=!ct,ct?(Qi(e,()=>Ie),o.classList.remove("bg-gray-700"),o.classList.add("bg-purple-600")):(Zi(),o.classList.remove("bg-purple-600"),o.classList.add("bg-gray-700")),i()}),{refreshKeyboard:i}}async function ts(){const e=document.getElementById("instrument-select-btn"),t=document.getElementById("instrument-select-modal"),r=document.getElementById("instrument-select"),i=document.getElementById("instrument-select-confirm"),o=document.getElementById("instrument-cancel-btn"),n=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([l])=>{const c=document.createElement("option");c.value=l,c.textContent=l.replace(/_/g," ").replace(/\b\w/g,u=>u.toUpperCase()),n.appendChild(c)}),n.addEventListener("change",()=>{const l=new CustomEvent("instrument-library-change",{detail:{preselect:null}});n.dispatchEvent(l)}),n.addEventListener("instrument-library-change",async l=>{var d;const c=l,u=n.value,a=((d=c.detail)==null?void 0:d.preselect)??null;try{let h;u==="mallets"?h=await Ai():u==="electricpiano"?h=await xi():u==="splendidgrandpiano"?h=await Di():u==="drummachines"?h=await Ir():u==="smolken"?h=await Hi():["fluidr3-gm","musyngkite","fatboy"].includes(u)?h=await $i({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[u]):h=await(await fetch(`/static/${u}.json`)).json(),r.innerHTML="",h.forEach(f=>{const m=document.createElement("option");m.value=`${u}/${f}`,m.textContent=f.split("_").map(y=>y[0].toUpperCase()+y.slice(1)).join(" "),r.appendChild(m)}),a?r.value=a:h.length>0&&(r.value=`${u}/${h[0]}`)}catch(h){console.error(`Failed to load instruments for library: ${u}`,h)}}),e.addEventListener("click",async()=>{const l=Ki()||"fluidr3-gm/acoustic_grand_piano",[c]=l.split("/");n.value=c;const u=new CustomEvent("instrument-library-change",{detail:{preselect:l}});n.dispatchEvent(u),t.classList.remove("hidden"),delete t.dataset.currentSequencer}),i.addEventListener("click",async()=>{const l=r.value;t.classList.add("hidden");const c=t.dataset.currentSequencer,u=c!==void 0?parseInt(c,10):void 0;if(u!==void 0&&!isNaN(u)){const a=Ti(u);a&&(F(wo(a.id,l),Eo(a.id,a.instrumentName)),a.setInstrument(l)),t.dataset.currentSequencer=""}else try{await Cr(l)}catch(a){console.error("Failed to load global instrument:",l,a)}}),o.addEventListener("click",()=>{t.classList.add("hidden")})}async function ns(e){await Cr("fluidr3-gm/acoustic_grand_piano");const{refreshKeyboard:t}=await es(e);await ts()}function rs(e,t){const r=t.getContext("2d");if(!r)throw new Error("Canvas 2D context not available");const i=t.width,o=t.height,n=new Uint8Array(e.fftSize),s=new Uint8Array(e.frequencyBinCount),l=document.createElement("canvas");l.width=i,l.height=o;const c=l.getContext("2d");if(!c)throw new Error("Offscreen canvas 2D context not available");let u="frequency";function a(){if(!r)return;e.getByteTimeDomainData(n),r.fillStyle="#000",r.fillRect(0,0,i,o),r.lineWidth=2,r.strokeStyle="#00ffcc",r.beginPath();const m=i/n.length;let y=0;for(let p=0;p<n.length;p++){const v=n[p]/128*o/2;p===0?r.moveTo(y,v):r.lineTo(y,v),y+=m}r.lineTo(i,o/2),r.stroke()}function d(){if(e.getByteFrequencyData(s),!r)return;r.fillStyle="#000",r.fillRect(0,0,i,o),r.fillStyle="rgba(255,255,255,0.2)",r.fillRect(0,0,1,o),r.fillRect(i-1,0,1,o);const m=128,y=2,p=[];for(let g=0;g<m;g++)p.push(g*i/(m-1));p[p.length-1]=i-1;for(let g=0;g<m;g++){const v=p[g],w=g<m-1?p[g+1]:i,b=Math.max(1,w-v-y),S=20,E=2e4,T=g/(m-1),C=S*Math.pow(E/S,T),L=Math.min(s.length-1,Math.floor(C/22050*s.length)),M=s[L]/255,U=Math.max(1,M*o),A=240-T*240;r.fillStyle=`hsl(${A}, ${80+M*20}%, ${40+M*40}%)`,r.fillRect(v,o-U,b,U)}}function h(){if(e.getByteFrequencyData(s),!c)return;l.initialized||(c.fillStyle="#000",c.fillRect(0,0,i,o),l.initialized=!0),c.drawImage(l,-1,0),c.fillStyle="#000",c.fillRect(i-1,0,1,o);const m=128,y=20,p=2e4;for(let g=0;g<m;g++){const v=g/(m-1),w=y*Math.pow(p/y,v),S=Math.min(s.length-1,Math.floor(w/22050*s.length)),E=s[S]/255,T=o-1-Math.floor(g*o/m);if(E<.05)continue;const C=Math.floor(E*255),N=Math.floor(E*(255-v*200)),L=Math.floor(E*(100+v*155));c.fillStyle=`rgb(${C}, ${N}, ${L})`,c.fillRect(i-1,T,1,1)}r&&(r.fillStyle="#000",r.fillRect(0,0,i,o),r.drawImage(l,0,0))}function f(){switch(requestAnimationFrame(f),u){case"frequency":d();break;case"spectrogram":h();break;case"waveform":default:a()}}return f(),{setMode(m){["waveform","frequency","spectrogram"].includes(m)&&(u=m,r.clearRect(0,0,i,o),u==="spectrogram"&&c.clearRect(0,0,i,o))}}}function os(e,t){const r=rs(wt,e),i=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let o=0;function n(){o=(o+1)%i.length;const{name:s,emoji:l}=i[o];r.setMode(s),t.textContent=l,t.title=`Mode: ${s}`}t.addEventListener("click",n),n()}function is(){var d;const e=document.getElementById("global-mini-expand-btn"),t=document.getElementById("global-mini-contour"),r=document.getElementById("global-mini-playhead"),i=(d=t==null?void 0:t.parentElement)==null?void 0:d.parentElement,o=t==null?void 0:t.parentElement,n=e==null?void 0:e.querySelector("svg use"),s=document.querySelector(".footer-spacer"),l=40;let c=!1;function u(h,f){const m=h.offsetWidth;h.style.height=`${f}px`,h.height=f,h.width=m}if(!e||!t||!r||!i||!o||!n||!s){console.warn("FooterUI: One or more elements not found.");return}i.style.height=`${l}px`,o.style.height=`${l}px`,u(t,l),u(r,l),X(t,he());function a(){c=!c;const h=c?200:40;!i||!o||!t||!r||!n||!s||(i.style.height=`${h}px`,o.style.height=`${h}px`,u(t,h),u(r,h),n.setAttribute("href",c?"#icon-caret-down":"#icon-caret-up"),s.style.height=`${h-40+140}px`,X(t,he()))}e.addEventListener("click",a)}function ss(e){if(!e.sequencers.length)throw new Error("No tracks to export.");const t=e.tempo,r=e.timeSignature[0],i=e.totalMeasures,o={v:3,t:new Date().toISOString(),c:{b:t,bpm:r,tm:i},i:e.sequencers.map(s=>s.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.sequencers.map(s=>({n:s.notes.map(l=>[l.pitch,l.start,l.duration])}))},n=new Blob([JSON.stringify(o)],{type:"application/json"});return{url:URL.createObjectURL(n),filename:`session-${Date.now()}.json`}}async function as(e){if(!e.tracks||e.tracks.length===0)throw new Error("No tracks to export.");const r=60/Ee(),i=Math.max(...e.tracks.flatMap(a=>a.notes.map(d=>(d.start+d.duration)*r+.2))),o=44100,n=new OfflineAudioContext(2,Math.ceil(o*i),o);for(const a of e.tracks){const d=a.instrument||"fluidr3-gm/acoustic_grand_piano",h=new wr(null,a.config,n,n.destination,d);h.setState(a),await h.exportToOffline()}const s=await n.startRendering(),l=cs(s),c=URL.createObjectURL(l),u=document.createElement("a");u.href=c,u.download=`session-${Date.now()}.wav`,u.click(),URL.revokeObjectURL(c)}function cs(e){const t=e.numberOfChannels,r=e.length*t*2,i=new DataView(new ArrayBuffer(44+r)),o=(s,l)=>{for(let c=0;c<l.length;c++)i.setUint8(s+c,l.charCodeAt(c))};o(0,"RIFF"),i.setUint32(4,36+r,!0),o(8,"WAVE"),o(12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,t,!0),i.setUint32(24,e.sampleRate,!0),i.setUint32(28,e.sampleRate*t*2,!0),i.setUint16(32,t*2,!0),i.setUint16(34,16,!0),o(36,"data"),i.setUint32(40,r,!0);let n=44;for(let s=0;s<e.length;s++)for(let l=0;l<t;l++){const c=e.getChannelData(l)[s],u=Math.max(-1,Math.min(1,c));i.setInt16(n,u*32767,!0),n+=2}return new Blob([i.buffer],{type:"audio/wav"})}function ls(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if(typeof t=="function"){var r=function i(){return this instanceof i?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(i){var o=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(r,i,o.get?o:{enumerable:!0,get:function(){return e[i]}})}),r}var ge={},lt={},It,Mn;function us(){if(Mn)return It;Mn=1;function e(o){var n=new i(o),s=n.readChunk();if(s.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+s.id+"'";for(var l=t(s.data),c=[],u=0;!n.eof()&&u<l.numTracks;u++){var a=n.readChunk();if(a.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+a.id+"'";var d=r(a.data);c.push(d)}return{header:l,tracks:c}}function t(o){var n=new i(o),s=n.readUInt16(),l=n.readUInt16(),c={format:s,numTracks:l},u=n.readUInt16();return u&32768?(c.framesPerSecond=256-(u>>8),c.ticksPerFrame=u&255):c.ticksPerBeat=u,c}function r(o){for(var n=new i(o),s=[];!n.eof();){var l=u();s.push(l)}return s;var c;function u(){var a={};a.deltaTime=n.readVarInt();var d=n.readUInt8();if((d&240)===240)if(d===255){a.meta=!0;var h=n.readUInt8(),f=n.readVarInt();switch(h){case 0:if(a.type="sequenceNumber",f!==2)throw"Expected length for sequenceNumber event is 2, got "+f;return a.number=n.readUInt16(),a;case 1:return a.type="text",a.text=n.readString(f),a;case 2:return a.type="copyrightNotice",a.text=n.readString(f),a;case 3:return a.type="trackName",a.text=n.readString(f),a;case 4:return a.type="instrumentName",a.text=n.readString(f),a;case 5:return a.type="lyrics",a.text=n.readString(f),a;case 6:return a.type="marker",a.text=n.readString(f),a;case 7:return a.type="cuePoint",a.text=n.readString(f),a;case 32:if(a.type="channelPrefix",f!=1)throw"Expected length for channelPrefix event is 1, got "+f;return a.channel=n.readUInt8(),a;case 33:if(a.type="portPrefix",f!=1)throw"Expected length for portPrefix event is 1, got "+f;return a.port=n.readUInt8(),a;case 47:if(a.type="endOfTrack",f!=0)throw"Expected length for endOfTrack event is 0, got "+f;return a;case 81:if(a.type="setTempo",f!=3)throw"Expected length for setTempo event is 3, got "+f;return a.microsecondsPerBeat=n.readUInt24(),a;case 84:if(a.type="smpteOffset",f!=5)throw"Expected length for smpteOffset event is 5, got "+f;var m=n.readUInt8(),y={0:24,32:25,64:29,96:30};return a.frameRate=y[m&96],a.hour=m&31,a.min=n.readUInt8(),a.sec=n.readUInt8(),a.frame=n.readUInt8(),a.subFrame=n.readUInt8(),a;case 88:if(a.type="timeSignature",f!=2&&f!=4)throw"Expected length for timeSignature event is 4 or 2, got "+f;return a.numerator=n.readUInt8(),a.denominator=1<<n.readUInt8(),f===4?(a.metronome=n.readUInt8(),a.thirtyseconds=n.readUInt8()):(a.metronome=36,a.thirtyseconds=8),a;case 89:if(a.type="keySignature",f!=2)throw"Expected length for keySignature event is 2, got "+f;return a.key=n.readInt8(),a.scale=n.readUInt8(),a;case 127:return a.type="sequencerSpecific",a.data=n.readBytes(f),a;default:return a.type="unknownMeta",a.data=n.readBytes(f),a.metatypeByte=h,a}}else if(d==240){a.type="sysEx";var f=n.readVarInt();return a.data=n.readBytes(f),a}else if(d==247){a.type="endSysEx";var f=n.readVarInt();return a.data=n.readBytes(f),a}else throw"Unrecognised MIDI event type byte: "+d;else{var p;if((d&128)===0){if(c===null)throw"Running status byte encountered before status byte";p=d,d=c,a.running=!0}else p=n.readUInt8(),c=d;var g=d>>4;switch(a.channel=d&15,g){case 8:return a.type="noteOff",a.noteNumber=p,a.velocity=n.readUInt8(),a;case 9:var v=n.readUInt8();return a.type=v===0?"noteOff":"noteOn",a.noteNumber=p,a.velocity=v,v===0&&(a.byte9=!0),a;case 10:return a.type="noteAftertouch",a.noteNumber=p,a.amount=n.readUInt8(),a;case 11:return a.type="controller",a.controllerType=p,a.value=n.readUInt8(),a;case 12:return a.type="programChange",a.programNumber=p,a;case 13:return a.type="channelAftertouch",a.amount=p,a;case 14:return a.type="pitchBend",a.value=p+(n.readUInt8()<<7)-8192,a;default:throw"Unrecognised MIDI event type: "+g}}}}function i(o){this.buffer=o,this.bufferLen=this.buffer.length,this.pos=0}return i.prototype.eof=function(){return this.pos>=this.bufferLen},i.prototype.readUInt8=function(){var o=this.buffer[this.pos];return this.pos+=1,o},i.prototype.readInt8=function(){var o=this.readUInt8();return o&128?o-256:o},i.prototype.readUInt16=function(){var o=this.readUInt8(),n=this.readUInt8();return(o<<8)+n},i.prototype.readInt16=function(){var o=this.readUInt16();return o&32768?o-65536:o},i.prototype.readUInt24=function(){var o=this.readUInt8(),n=this.readUInt8(),s=this.readUInt8();return(o<<16)+(n<<8)+s},i.prototype.readInt24=function(){var o=this.readUInt24();return o&8388608?o-16777216:o},i.prototype.readUInt32=function(){var o=this.readUInt8(),n=this.readUInt8(),s=this.readUInt8(),l=this.readUInt8();return(o<<24)+(n<<16)+(s<<8)+l},i.prototype.readBytes=function(o){var n=this.buffer.slice(this.pos,this.pos+o);return this.pos+=o,n},i.prototype.readString=function(o){var n=this.readBytes(o);return String.fromCharCode.apply(null,n)},i.prototype.readVarInt=function(){for(var o=0;!this.eof();){var n=this.readUInt8();if(n&128)o+=n&127,o<<=7;else return o+n}return o},i.prototype.readChunk=function(){var o=this.readString(4),n=this.readUInt32(),s=this.readBytes(n);return{id:o,length:n,data:s}},It=e,It}var Ct,_n;function ds(){if(_n)return Ct;_n=1;function e(n,s){if(typeof n!="object")throw"Invalid MIDI data";s=s||{};var l=n.header||{},c=n.tracks||[],u,a=c.length,d=new o;for(t(d,l,a),u=0;u<a;u++)r(d,c[u],s);return d.buffer}function t(n,s,l){var c=s.format==null?1:s.format,u=128;s.timeDivision?u=s.timeDivision:s.ticksPerFrame&&s.framesPerSecond?u=-(s.framesPerSecond&255)<<8|s.ticksPerFrame&255:s.ticksPerBeat&&(u=s.ticksPerBeat&32767);var a=new o;a.writeUInt16(c),a.writeUInt16(l),a.writeUInt16(u),n.writeChunk("MThd",a.buffer)}function r(n,s,l){var c=new o,u,a=s.length,d=null;for(u=0;u<a;u++)(l.running===!1||!l.running&&!s[u].running)&&(d=null),d=i(c,s[u],d,l.useByte9ForNoteOff);n.writeChunk("MTrk",c.buffer)}function i(n,s,l,c){var u=s.type,a=s.deltaTime,d=s.text||"",h=s.data||[],f=null;switch(n.writeVarInt(a),u){case"sequenceNumber":n.writeUInt8(255),n.writeUInt8(0),n.writeVarInt(2),n.writeUInt16(s.number);break;case"text":n.writeUInt8(255),n.writeUInt8(1),n.writeVarInt(d.length),n.writeString(d);break;case"copyrightNotice":n.writeUInt8(255),n.writeUInt8(2),n.writeVarInt(d.length),n.writeString(d);break;case"trackName":n.writeUInt8(255),n.writeUInt8(3),n.writeVarInt(d.length),n.writeString(d);break;case"instrumentName":n.writeUInt8(255),n.writeUInt8(4),n.writeVarInt(d.length),n.writeString(d);break;case"lyrics":n.writeUInt8(255),n.writeUInt8(5),n.writeVarInt(d.length),n.writeString(d);break;case"marker":n.writeUInt8(255),n.writeUInt8(6),n.writeVarInt(d.length),n.writeString(d);break;case"cuePoint":n.writeUInt8(255),n.writeUInt8(7),n.writeVarInt(d.length),n.writeString(d);break;case"channelPrefix":n.writeUInt8(255),n.writeUInt8(32),n.writeVarInt(1),n.writeUInt8(s.channel);break;case"portPrefix":n.writeUInt8(255),n.writeUInt8(33),n.writeVarInt(1),n.writeUInt8(s.port);break;case"endOfTrack":n.writeUInt8(255),n.writeUInt8(47),n.writeVarInt(0);break;case"setTempo":n.writeUInt8(255),n.writeUInt8(81),n.writeVarInt(3),n.writeUInt24(s.microsecondsPerBeat);break;case"smpteOffset":n.writeUInt8(255),n.writeUInt8(84),n.writeVarInt(5);var m={24:0,25:32,29:64,30:96},y=s.hour&31|m[s.frameRate];n.writeUInt8(y),n.writeUInt8(s.min),n.writeUInt8(s.sec),n.writeUInt8(s.frame),n.writeUInt8(s.subFrame);break;case"timeSignature":n.writeUInt8(255),n.writeUInt8(88),n.writeVarInt(4),n.writeUInt8(s.numerator);var p=Math.floor(Math.log(s.denominator)/Math.LN2)&255;n.writeUInt8(p),n.writeUInt8(s.metronome),n.writeUInt8(s.thirtyseconds||8);break;case"keySignature":n.writeUInt8(255),n.writeUInt8(89),n.writeVarInt(2),n.writeInt8(s.key),n.writeUInt8(s.scale);break;case"sequencerSpecific":n.writeUInt8(255),n.writeUInt8(127),n.writeVarInt(h.length),n.writeBytes(h);break;case"unknownMeta":s.metatypeByte!=null&&(n.writeUInt8(255),n.writeUInt8(s.metatypeByte),n.writeVarInt(h.length),n.writeBytes(h));break;case"sysEx":n.writeUInt8(240),n.writeVarInt(h.length),n.writeBytes(h);break;case"endSysEx":n.writeUInt8(247),n.writeVarInt(h.length),n.writeBytes(h);break;case"noteOff":var g=c!==!1&&s.byte9||c&&s.velocity==0?144:128;f=g|s.channel,f!==l&&n.writeUInt8(f),n.writeUInt8(s.noteNumber),n.writeUInt8(s.velocity);break;case"noteOn":f=144|s.channel,f!==l&&n.writeUInt8(f),n.writeUInt8(s.noteNumber),n.writeUInt8(s.velocity);break;case"noteAftertouch":f=160|s.channel,f!==l&&n.writeUInt8(f),n.writeUInt8(s.noteNumber),n.writeUInt8(s.amount);break;case"controller":f=176|s.channel,f!==l&&n.writeUInt8(f),n.writeUInt8(s.controllerType),n.writeUInt8(s.value);break;case"programChange":f=192|s.channel,f!==l&&n.writeUInt8(f),n.writeUInt8(s.programNumber);break;case"channelAftertouch":f=208|s.channel,f!==l&&n.writeUInt8(f),n.writeUInt8(s.amount);break;case"pitchBend":f=224|s.channel,f!==l&&n.writeUInt8(f);var v=8192+s.value,w=v&127,b=v>>7&127;n.writeUInt8(w),n.writeUInt8(b);break;default:throw"Unrecognized event type: "+u}return f}function o(){this.buffer=[]}return o.prototype.writeUInt8=function(n){this.buffer.push(n&255)},o.prototype.writeInt8=o.prototype.writeUInt8,o.prototype.writeUInt16=function(n){var s=n>>8&255,l=n&255;this.writeUInt8(s),this.writeUInt8(l)},o.prototype.writeInt16=o.prototype.writeUInt16,o.prototype.writeUInt24=function(n){var s=n>>16&255,l=n>>8&255,c=n&255;this.writeUInt8(s),this.writeUInt8(l),this.writeUInt8(c)},o.prototype.writeInt24=o.prototype.writeUInt24,o.prototype.writeUInt32=function(n){var s=n>>24&255,l=n>>16&255,c=n>>8&255,u=n&255;this.writeUInt8(s),this.writeUInt8(l),this.writeUInt8(c),this.writeUInt8(u)},o.prototype.writeInt32=o.prototype.writeUInt32,o.prototype.writeBytes=function(n){this.buffer=this.buffer.concat(Array.prototype.slice.call(n,0))},o.prototype.writeString=function(n){var s,l=n.length,c=[];for(s=0;s<l;s++)c.push(n.codePointAt(s));this.writeBytes(c)},o.prototype.writeVarInt=function(n){if(n<0)throw"Cannot write negative variable-length integer";if(n<=127)this.writeUInt8(n);else{var s=n,l=[];for(l.push(s&127),s>>=7;s;){var c=s&127|128;l.push(c),s>>=7}this.writeBytes(l.reverse())}},o.prototype.writeChunk=function(n,s){this.writeString(n),this.writeUInt32(s.length),this.writeBytes(s)},Ct=e,Ct}var Ln;function Mr(){return Ln||(Ln=1,lt.parseMidi=us(),lt.writeMidi=ds()),lt}var Tt={},ye={},Pn;function _r(){if(Pn)return ye;Pn=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.insert=ye.search=void 0;function e(r,i,o){o===void 0&&(o="ticks");var n=0,s=r.length,l=s;if(s>0&&r[s-1][o]<=i)return s-1;for(;n<l;){var c=Math.floor(n+(l-n)/2),u=r[c],a=r[c+1];if(u[o]===i){for(var d=c;d<r.length;d++){var h=r[d];h[o]===i&&(c=d)}return c}else{if(u[o]<i&&a[o]>i)return c;u[o]>i?l=c:u[o]<i&&(n=c+1)}}return-1}ye.search=e;function t(r,i,o){if(o===void 0&&(o="ticks"),r.length){var n=e(r,i[o],o);r.splice(n+1,0,i)}else r.push(i)}return ye.insert=t,ye}var qn;function At(){return qn||(qn=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.Header=e.keySignatureKeys=void 0;var t=_r(),r=new WeakMap;e.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var i=function(){function o(n){var s=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",r.set(this,480),n){r.set(this,n.header.ticksPerBeat),n.tracks.forEach(function(c){c.forEach(function(u){u.meta&&(u.type==="timeSignature"?s.timeSignatures.push({ticks:u.absoluteTime,timeSignature:[u.numerator,u.denominator]}):u.type==="setTempo"?s.tempos.push({bpm:6e7/u.microsecondsPerBeat,ticks:u.absoluteTime}):u.type==="keySignature"&&s.keySignatures.push({key:e.keySignatureKeys[u.key+7],scale:u.scale===0?"major":"minor",ticks:u.absoluteTime}))})});var l=0;n.tracks[0].forEach(function(c){l+=c.deltaTime,c.meta&&(c.type==="trackName"?s.name=c.text:(c.type==="text"||c.type==="cuePoint"||c.type==="marker"||c.type==="lyrics")&&s.meta.push({text:c.text,ticks:l,type:c.type}))}),this.update()}}return o.prototype.update=function(){var n=this,s=0,l=0;this.tempos.sort(function(c,u){return c.ticks-u.ticks}),this.tempos.forEach(function(c,u){var a=u>0?n.tempos[u-1].bpm:n.tempos[0].bpm,d=c.ticks/n.ppq-l,h=60/a*d;c.time=h+s,s=c.time,l+=d}),this.timeSignatures.sort(function(c,u){return c.ticks-u.ticks}),this.timeSignatures.forEach(function(c,u){var a=u>0?n.timeSignatures[u-1]:n.timeSignatures[0],d=(c.ticks-a.ticks)/n.ppq,h=d/a.timeSignature[0]/(a.timeSignature[1]/4);a.measures=a.measures||0,c.measures=h+a.measures})},o.prototype.ticksToSeconds=function(n){var s=(0,t.search)(this.tempos,n);if(s!==-1){var l=this.tempos[s],c=l.time,u=(n-l.ticks)/this.ppq;return c+60/l.bpm*u}else{var a=n/this.ppq;return 60/120*a}},o.prototype.ticksToMeasures=function(n){var s=(0,t.search)(this.timeSignatures,n);if(s!==-1){var l=this.timeSignatures[s],c=(n-l.ticks)/this.ppq;return l.measures+c/(l.timeSignature[0]/l.timeSignature[1])/4}else return n/this.ppq/4},Object.defineProperty(o.prototype,"ppq",{get:function(){return r.get(this)},enumerable:!1,configurable:!0}),o.prototype.secondsToTicks=function(n){var s=(0,t.search)(this.tempos,n,"time");if(s!==-1){var l=this.tempos[s],c=l.time,u=n-c,a=u/(60/l.bpm);return Math.round(l.ticks+a*this.ppq)}else{var d=n/.5;return Math.round(d*this.ppq)}},o.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(n){return{bpm:n.bpm,ticks:n.ticks}}),timeSignatures:this.timeSignatures}},o.prototype.fromJSON=function(n){this.name=n.name,this.tempos=n.tempos.map(function(s){return Object.assign({},s)}),this.timeSignatures=n.timeSignatures.map(function(s){return Object.assign({},s)}),this.keySignatures=n.keySignatures.map(function(s){return Object.assign({},s)}),this.meta=n.meta.map(function(s){return Object.assign({},s)}),r.set(this,n.ppq),this.update()},o.prototype.setTempo=function(n){this.tempos=[{bpm:n,ticks:0}],this.update()},o}();e.Header=i}(Tt)),Tt}var Ue={},Nt={},On;function Lr(){return On||(On=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ControlChange=e.controlChangeIds=e.controlChangeNames=void 0,e.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},e.controlChangeIds=Object.keys(e.controlChangeNames).reduce(function(o,n){return o[e.controlChangeNames[n]]=n,o},{});var t=new WeakMap,r=new WeakMap,i=function(){function o(n,s){t.set(this,s),r.set(this,n.controllerType),this.ticks=n.absoluteTime,this.value=n.value}return Object.defineProperty(o.prototype,"number",{get:function(){return r.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"name",{get:function(){return e.controlChangeNames[this.number]?e.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"time",{get:function(){var n=t.get(this);return n.ticksToSeconds(this.ticks)},set:function(n){var s=t.get(this);this.ticks=s.secondsToTicks(n)},enumerable:!1,configurable:!0}),o.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},o}();e.ControlChange=i}(Nt)),Nt}var Ae={},Rn;function fs(){if(Rn)return Ae;Rn=1,Object.defineProperty(Ae,"__esModule",{value:!0}),Ae.createControlChanges=void 0;var e=Lr();function t(){return new Proxy({},{get:function(r,i){if(r[i])return r[i];if(e.controlChangeIds.hasOwnProperty(i))return r[e.controlChangeIds[i]]},set:function(r,i,o){return e.controlChangeIds.hasOwnProperty(i)?r[e.controlChangeIds[i]]=o:r[i]=o,!0}})}return Ae.createControlChanges=t,Ae}var xe={},Fn;function hs(){if(Fn)return xe;Fn=1,Object.defineProperty(xe,"__esModule",{value:!0}),xe.PitchBend=void 0;var e=new WeakMap,t=function(){function r(i,o){e.set(this,o),this.ticks=i.absoluteTime,this.value=i.value}return Object.defineProperty(r.prototype,"time",{get:function(){var i=e.get(this);return i.ticksToSeconds(this.ticks)},set:function(i){var o=e.get(this);this.ticks=o.secondsToTicks(i)},enumerable:!1,configurable:!0}),r.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},r}();return xe.PitchBend=t,xe}var De={},oe={},Un;function ms(){return Un||(Un=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.DrumKitByPatchID=oe.InstrumentFamilyByID=oe.instrumentByPatchID=void 0,oe.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],oe.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],oe.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),oe}var An;function ps(){if(An)return De;An=1,Object.defineProperty(De,"__esModule",{value:!0}),De.Instrument=void 0;var e=ms(),t=new WeakMap,r=function(){function i(o,n){if(this.number=0,t.set(this,n),this.number=0,o){var s=o.find(function(l){return l.type==="programChange"});s&&(this.number=s.programNumber)}}return Object.defineProperty(i.prototype,"name",{get:function(){return this.percussion?e.DrumKitByPatchID[this.number]:e.instrumentByPatchID[this.number]},set:function(o){var n=e.instrumentByPatchID.indexOf(o);n!==-1&&(this.number=n)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"family",{get:function(){return this.percussion?"drums":e.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"percussion",{get:function(){var o=t.get(this);return o.channel===9},enumerable:!1,configurable:!0}),i.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},i.prototype.fromJSON=function(o){this.number=o.number},i}();return De.Instrument=r,De}var He={},xn;function gs(){if(xn)return He;xn=1,Object.defineProperty(He,"__esModule",{value:!0}),He.Note=void 0;function e(s){var l=Math.floor(s/12)-1;return t(s)+l.toString()}function t(s){var l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],c=s%12;return l[c]}function r(s){var l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return l.indexOf(s)}var i=function(){var s=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,l={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(c){var u=s.exec(c),a=u[1],d=u[2],h=l[a.toLowerCase()];return h+(parseInt(d,10)+1)*12}}(),o=new WeakMap,n=function(){function s(l,c,u){o.set(this,u),this.midi=l.midi,this.velocity=l.velocity,this.noteOffVelocity=c.velocity,this.ticks=l.ticks,this.durationTicks=c.ticks-l.ticks}return Object.defineProperty(s.prototype,"name",{get:function(){return e(this.midi)},set:function(l){this.midi=i(l)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(l){var c=l-this.octave;this.midi+=c*12},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"pitch",{get:function(){return t(this.midi)},set:function(l){this.midi=12*(this.octave+1)+r(l)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"duration",{get:function(){var l=o.get(this);return l.ticksToSeconds(this.ticks+this.durationTicks)-l.ticksToSeconds(this.ticks)},set:function(l){var c=o.get(this),u=c.secondsToTicks(this.time+l);this.durationTicks=u-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"time",{get:function(){var l=o.get(this);return l.ticksToSeconds(this.ticks)},set:function(l){var c=o.get(this);this.ticks=c.secondsToTicks(l)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"bars",{get:function(){var l=o.get(this);return l.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),s.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},s}();return He.Note=n,He}var Dn;function Hn(){if(Dn)return Ue;Dn=1,Object.defineProperty(Ue,"__esModule",{value:!0}),Ue.Track=void 0;var e=_r(),t=Lr(),r=fs(),i=hs(),o=ps(),n=gs(),s=new WeakMap,l=function(){function c(u,a){var d=this;if(this.name="",this.notes=[],this.controlChanges=(0,r.createControlChanges)(),this.pitchBends=[],s.set(this,a),u){var h=u.find(function(b){return b.type==="trackName"});this.name=h?h.text:""}if(this.instrument=new o.Instrument(u,this),this.channel=0,u){for(var f=u.filter(function(b){return b.type==="noteOn"}),m=u.filter(function(b){return b.type==="noteOff"}),y=function(){var b=f.shift();p.channel=b.channel;var S=m.findIndex(function(T){return T.noteNumber===b.noteNumber&&T.absoluteTime>=b.absoluteTime});if(S!==-1){var E=m.splice(S,1)[0];p.addNote({durationTicks:E.absoluteTime-b.absoluteTime,midi:b.noteNumber,noteOffVelocity:E.velocity/127,ticks:b.absoluteTime,velocity:b.velocity/127})}},p=this;f.length;)y();var g=u.filter(function(b){return b.type==="controller"});g.forEach(function(b){d.addCC({number:b.controllerType,ticks:b.absoluteTime,value:b.value/127})});var v=u.filter(function(b){return b.type==="pitchBend"});v.forEach(function(b){d.addPitchBend({ticks:b.absoluteTime,value:b.value/Math.pow(2,13)})});var w=u.find(function(b){return b.type==="endOfTrack"});this.endOfTrackTicks=w!==void 0?w.absoluteTime:void 0}}return c.prototype.addNote=function(u){var a=s.get(this),d=new n.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},a);return Object.assign(d,u),(0,e.insert)(this.notes,d,"ticks"),this},c.prototype.addCC=function(u){var a=s.get(this),d=new t.ControlChange({controllerType:u.number},a);return delete u.number,Object.assign(d,u),Array.isArray(this.controlChanges[d.number])||(this.controlChanges[d.number]=[]),(0,e.insert)(this.controlChanges[d.number],d,"ticks"),this},c.prototype.addPitchBend=function(u){var a=s.get(this),d=new i.PitchBend({},a);return Object.assign(d,u),(0,e.insert)(this.pitchBends,d,"ticks"),this},Object.defineProperty(c.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var u=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,a=0;a<this.notes.length-1;a++){var d=this.notes[a].time+this.notes[a].duration;u<d&&(u=d)}return u},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var u=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,a=0;a<this.notes.length-1;a++){var d=this.notes[a].ticks+this.notes[a].durationTicks;u<d&&(u=d)}return u},enumerable:!1,configurable:!0}),c.prototype.fromJSON=function(u){var a=this;this.name=u.name,this.channel=u.channel,this.instrument=new o.Instrument(void 0,this),this.instrument.fromJSON(u.instrument),u.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=u.endOfTrackTicks);for(var d in u.controlChanges)u.controlChanges[d]&&u.controlChanges[d].forEach(function(h){a.addCC({number:h.number,ticks:h.ticks,value:h.value})});u.notes.forEach(function(h){a.addNote({durationTicks:h.durationTicks,midi:h.midi,ticks:h.ticks,velocity:h.velocity})})},c.prototype.toJSON=function(){for(var u={},a=0;a<127;a++)this.controlChanges.hasOwnProperty(a)&&(u[a]=this.controlChanges[a].map(function(h){return h.toJSON()}));var d={channel:this.channel,controlChanges:u,pitchBends:this.pitchBends.map(function(h){return h.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(h){return h.toJSON()})};return this.endOfTrackTicks!==void 0&&(d.endOfTrackTicks=this.endOfTrackTicks),d},c}();return Ue.Track=l,Ue}var be={};function ys(e){var t=[];return Pr(e,t),t}function Pr(e,t){for(var r=0;r<e.length;r++){var i=e[r];Array.isArray(i)?Pr(i,t):t.push(i)}}const bs=Object.freeze(Object.defineProperty({__proto__:null,flatten:ys},Symbol.toStringTag,{value:"Module"})),vs=ls(bs);var $n;function ws(){if($n)return be;$n=1;var e=be&&be.__spreadArray||function(g,v,w){if(w||arguments.length===2)for(var b=0,S=v.length,E;b<S;b++)(E||!(b in v))&&(E||(E=Array.prototype.slice.call(v,0,b)),E[b]=v[b]);return g.concat(E||Array.prototype.slice.call(v))};Object.defineProperty(be,"__esModule",{value:!0}),be.encode=void 0;var t=Mr(),r=At(),i=vs;function o(g,v){return[{absoluteTime:g.ticks,channel:v,deltaTime:0,noteNumber:g.midi,type:"noteOn",velocity:Math.floor(g.velocity*127)},{absoluteTime:g.ticks+g.durationTicks,channel:v,deltaTime:0,noteNumber:g.midi,type:"noteOff",velocity:Math.floor(g.noteOffVelocity*127)}]}function n(g){return(0,i.flatten)(g.notes.map(function(v){return o(v,g.channel)}))}function s(g,v){return{absoluteTime:g.ticks,channel:v,controllerType:g.number,deltaTime:0,type:"controller",value:Math.floor(g.value*127)}}function l(g){for(var v=[],w=0;w<127;w++)g.controlChanges.hasOwnProperty(w)&&g.controlChanges[w].forEach(function(b){v.push(s(b,g.channel))});return v}function c(g,v){return{absoluteTime:g.ticks,channel:v,deltaTime:0,type:"pitchBend",value:g.value}}function u(g){var v=[];return g.pitchBends.forEach(function(w){v.push(c(w,g.channel))}),v}function a(g){return{absoluteTime:0,channel:g.channel,deltaTime:0,programNumber:g.instrument.number,type:"programChange"}}function d(g){return{absoluteTime:0,deltaTime:0,meta:!0,text:g,type:"trackName"}}function h(g){return{absoluteTime:g.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/g.bpm),type:"setTempo"}}function f(g){return{absoluteTime:g.ticks,deltaTime:0,denominator:g.timeSignature[1],meta:!0,metronome:24,numerator:g.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function m(g){var v=r.keySignatureKeys.indexOf(g.key);return{absoluteTime:g.ticks,deltaTime:0,key:v+7,meta:!0,scale:g.scale==="major"?0:1,type:"keySignature"}}function y(g){return{absoluteTime:g.ticks,deltaTime:0,meta:!0,text:g.text,type:g.type}}function p(g){var v={header:{format:1,numTracks:g.tracks.length+1,ticksPerBeat:g.header.ppq},tracks:e([e(e(e(e([{absoluteTime:0,deltaTime:0,meta:!0,text:g.header.name,type:"trackName"}],g.header.keySignatures.map(function(w){return m(w)}),!0),g.header.meta.map(function(w){return y(w)}),!0),g.header.tempos.map(function(w){return h(w)}),!0),g.header.timeSignatures.map(function(w){return f(w)}),!0)],g.tracks.map(function(w){return e(e(e([d(w.name),a(w)],n(w),!0),l(w),!0),u(w),!0)}),!0)};return v.tracks=v.tracks.map(function(w){w=w.sort(function(S,E){return S.absoluteTime-E.absoluteTime});var b=0;return w.forEach(function(S){S.deltaTime=S.absoluteTime-b,b=S.absoluteTime,delete S.absoluteTime}),w.push({deltaTime:0,meta:!0,type:"endOfTrack"}),w}),new Uint8Array((0,t.writeMidi)(v))}return be.encode=p,be}var Wn;function Es(){return Wn||(Wn=1,function(e){var t=ge&&ge.__awaiter||function(d,h,f,m){function y(p){return p instanceof f?p:new f(function(g){g(p)})}return new(f||(f=Promise))(function(p,g){function v(S){try{b(m.next(S))}catch(E){g(E)}}function w(S){try{b(m.throw(S))}catch(E){g(E)}}function b(S){S.done?p(S.value):y(S.value).then(v,w)}b((m=m.apply(d,h||[])).next())})},r=ge&&ge.__generator||function(d,h){var f={label:0,sent:function(){if(p[0]&1)throw p[1];return p[1]},trys:[],ops:[]},m,y,p,g;return g={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(g[Symbol.iterator]=function(){return this}),g;function v(b){return function(S){return w([b,S])}}function w(b){if(m)throw new TypeError("Generator is already executing.");for(;f;)try{if(m=1,y&&(p=b[0]&2?y.return:b[0]?y.throw||((p=y.return)&&p.call(y),0):y.next)&&!(p=p.call(y,b[1])).done)return p;switch(y=0,p&&(b=[b[0]&2,p.value]),b[0]){case 0:case 1:p=b;break;case 4:return f.label++,{value:b[1],done:!1};case 5:f.label++,y=b[1],b=[0];continue;case 7:b=f.ops.pop(),f.trys.pop();continue;default:if(p=f.trys,!(p=p.length>0&&p[p.length-1])&&(b[0]===6||b[0]===2)){f=0;continue}if(b[0]===3&&(!p||b[1]>p[0]&&b[1]<p[3])){f.label=b[1];break}if(b[0]===6&&f.label<p[1]){f.label=p[1],p=b;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(b);break}p[2]&&f.ops.pop(),f.trys.pop();continue}b=h.call(d,f)}catch(S){b=[6,S],y=0}finally{m=p=0}if(b[0]&5)throw b[1];return{value:b[0]?b[1]:void 0,done:!0}}};Object.defineProperty(e,"__esModule",{value:!0}),e.Header=e.Track=e.Midi=void 0;var i=Mr(),o=At(),n=Hn(),s=ws(),l=function(){function d(h){var f=this,m=null;if(h){var y=h instanceof ArrayBuffer?new Uint8Array(h):h;m=(0,i.parseMidi)(y),m.tracks.forEach(function(p){var g=0;p.forEach(function(v){g+=v.deltaTime,v.absoluteTime=g})}),m.tracks=a(m.tracks)}this.header=new o.Header(m),this.tracks=[],h&&(this.tracks=m.tracks.map(function(p){return new n.Track(p,f.header)}),m.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return d.fromUrl=function(h){return t(this,void 0,void 0,function(){var f,m;return r(this,function(y){switch(y.label){case 0:return[4,fetch(h)];case 1:return f=y.sent(),f.ok?[4,f.arrayBuffer()]:[3,3];case 2:return m=y.sent(),[2,new d(m)];case 3:throw new Error("Could not load '".concat(h,"'"))}})})},Object.defineProperty(d.prototype,"name",{get:function(){return this.header.name},set:function(h){this.header.name=h},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"duration",{get:function(){var h=this.tracks.map(function(f){return f.duration});return Math.max.apply(Math,h)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"durationTicks",{get:function(){var h=this.tracks.map(function(f){return f.durationTicks});return Math.max.apply(Math,h)},enumerable:!1,configurable:!0}),d.prototype.addTrack=function(){var h=new n.Track(void 0,this.header);return this.tracks.push(h),h},d.prototype.toArray=function(){return(0,s.encode)(this)},d.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(h){return h.toJSON()})}},d.prototype.fromJSON=function(h){var f=this;this.header=new o.Header,this.header.fromJSON(h.header),this.tracks=h.tracks.map(function(m){var y=new n.Track(void 0,f.header);return y.fromJSON(m),y})},d.prototype.clone=function(){var h=new d;return h.fromJSON(this.toJSON()),h},d}();e.Midi=l;var c=Hn();Object.defineProperty(e,"Track",{enumerable:!0,get:function(){return c.Track}});var u=At();Object.defineProperty(e,"Header",{enumerable:!0,get:function(){return u.Header}});function a(d){for(var h=[],f=0;f<d.length;f++)for(var m=h.length,y=new Map,p=Array(16).fill(0),g=0,v=d[f];g<v.length;g++){var w=v[g],b=m,S=w.channel;if(S!==void 0){w.type==="programChange"&&(p[S]=w.programNumber);var E=p[S],T="".concat(E," ").concat(S);y.has(T)?b=y.get(T):(b=m+y.size,y.set(T,b))}h[b]||h.push([]),h[b].push(w)}return h}}(ge)),ge}var qr=Es();const Or=["acoustic_grand_piano","bright_acoustic_piano","electric_grand_piano","honkytonk_piano","electric_piano_1","electric_piano_2","harpsichord","clavinet","celesta","glockenspiel","music_box","vibraphone","marimba","xylophone","tubular_bells","dulcimer","drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","acoustic_guitar_nylon","acoustic_guitar_steel","electric_guitar_jazz","electric_guitar_clean","electric_guitar_muted","overdriven_guitar","distortion_guitar","guitar_harmonics","acoustic_bass","electric_bass_finger","electric_bass_pick","fretless_bass","slap_bass_1","slap_bass_2","synth_bass_1","synth_bass_2","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synth_strings_1","synth_strings_2","choir_aahs","voice_oohs","synth_choir","orchestra_hit","trumpet","trombone","tuba","muted_trumpet","french_horn","brass_section","synth_brass_1","synth_brass_2","soprano_sax","alto_sax","tenor_sax","baritone_sax","oboe","english_horn","bassoon","clarinet","piccolo","flute","recorder","pan_flute","blown_bottle","shakuhachi","whistle","ocarina","lead_1_square","lead_2_sawtooth","lead_3_calliope","lead_4_chiff","lead_5_charang","lead_6_voice","lead_7_fifths","lead_8_bass__lead","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep","fx_1_rain","fx_2_soundtrack","fx_3_crystal","fx_4_atmosphere","fx_5_brightness","fx_6_goblins","fx_7_echoes","fx_8_scifi","sitar","banjo","shamisen","koto","kalimba","bagpipe","fiddle","shanai","tinkle_bell","agogo","steel_drums","woodblock","taiko_drum","melodic_tom","synth_drum","reverse_cymbal","guitar_fret_noise","breath_noise","seashore","bird_tweet","telephone_ring","helicopter","applause","gunshot"];function Ss(e){const t=e.trim().toLowerCase().replace(/\s+/g,"_"),r=Or.findIndex(i=>i===t);return r!==-1?r:(t.includes("drum")||t.includes("drummachine"),0)}async function ks(e){if(!e.sequencers.length)throw new Error("No tracks to export.");const t=new qr.Midi;t.header.setTempo(e.tempo),t.header.timeSignatures.push({ticks:0,timeSignature:e.timeSignature});for(const[o,n]of e.sequencers.entries()){const s=t.addTrack(),l=n.instrument.toLowerCase().includes("drum");s.channel=l?9:o%16;const c=Ss(n.instrument);s.instrument.number=c;for(const u of n.notes){const a=_(u.pitch);if(a===null)continue;const d=jn(u.start,e.tempo),h=jn(u.duration,e.tempo);s.addNote({midi:a,time:d,duration:h,velocity:.8})}}const r=new Blob([t.toArray()],{type:"audio/midi"});return{url:URL.createObjectURL(r),filename:`session-${Date.now()}.mid`}}function jn(e,t){return 60/t*e}async function Is(e){var s,l,c;const t=await e.text();let r;try{r=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(r.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const i={bpm:((s=r.c)==null?void 0:s.b)??120,beatsPerMeasure:((l=r.c)==null?void 0:l.bpm)??4,totalMeasures:((c=r.c)==null?void 0:c.tm)??8},o=Array.isArray(r.i)?r.i:[],n=r.tr.map((u,a)=>{if(!Array.isArray(u.n))throw new Error(`Track ${a} missing \`n\` (notes) array.`);const d=u.n.map(([f,m,y])=>({pitch:f,start:m,duration:y})),h=o[a]||"fluidr3-gm/acoustic_grand_piano";return{notes:d,instrument:h,config:{}}});return{globalConfig:i,tracks:n}}async function Cs(e){var m;const t=await e.arrayBuffer(),r=new qr.Midi(t),i=r.header.tempos[0],o=r.header.timeSignatures[0],n=(i==null?void 0:i.bpm)??120,s=((m=o==null?void 0:o.timeSignature)==null?void 0:m[0])??4,c=Math.max(0,...r.tracks.flatMap(y=>y.notes.map(p=>p.time+p.duration)))*(n/60),u=Math.ceil(c/s)||8,a={bpm:n,beatsPerMeasure:s,totalMeasures:u},d=await Ir();console.log(`[MIDI] Available drum machines: ${d.join(", ")}`);const h=d.includes("LM-2")?"LM-2":d[0]??"TR-808",f=r.tracks.map(y=>{const p=y.notes.map(b=>({pitch:b.name,start:b.time*(n/60),duration:b.duration*(n/60)}));let g=y.instrument.number;(g===void 0||g===0)&&(y.channel===9?g=0:g=y.channel%128);const v=Or[g]||"acoustic_grand_piano",w=y.channel===9?`drummachines/${h}`:`fluidr3-gm/${v}`;return{notes:p,instrument:w,config:{}}});return{globalConfig:a,tracks:f}}function Ts(){for(const e of B){const t=e.container;if(!t)continue;const r=t.querySelector(".sequencer-body"),i=t.querySelector("canvas.mini-contour"),o=t.querySelector(".collapse-btn use");!r||!i||r.classList.contains("hidden")||(r.classList.add("hidden"),i.classList.remove("hidden"),o==null||o.setAttribute("href","#icon-caret-up"),nt(t,!1),Qe(i,e.notes,e.config,e.colorIndex))}}let ie=null,yt=null;function Ns(e){yt=e,ie=yt.getContext("2d")}function Le(e){if(!ie||!yt)return;const{width:t,height:r}=yt;ie.clearRect(0,0,t,r);const i=Math.round(e)+.5;ie.strokeStyle="#ff00ff",ie.lineWidth=1,ie.beginPath(),ie.moveTo(i,0),ie.lineTo(i,r),ie.stroke()}function zn(e,t){Xt(t.bpm),Vt(t.beatsPerMeasure),Yt(t.totalMeasures);const r=document.getElementById("tempo-input");r&&(r.value=String(Ee()));const i=document.getElementById("measures-input");i&&(i.value=String(tt())),Ni();for(const[n,s]of e.entries()){const l=n,c=s.instrument||"fluidr3-gm/acoustic_grand_piano",u=s.notes||[];F({type:"CREATE_SEQUENCER",id:l,instrument:c,notes:structuredClone(u),config:s.config||{}},$t(l))}F(Kt("Session Loaded"),ir("Session Loaded")),Ts();const o=document.getElementById("global-mini-contour");o&&ko(o,B),fe(0),Le(0)}function Bs(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),r=document.getElementById("dotted-note-btn"),i=document.getElementById("triplet-note-btn");let o=!1,n=!1;function s(c){let u=c;o?u=c*1.5:n&&(u=c*(2/3));let a=Array.from(t.options).find(d=>Math.abs(parseFloat(d.value)-u)<1e-4);a||(a=new Option(u.toString(),u.toString()),t.add(a)),t.value=a.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(c=>{c.addEventListener("click",()=>{e.forEach(a=>a.classList.remove("bg-purple-600")),c.classList.add("bg-purple-600");const u=parseFloat(c.dataset.value);s(u)})}),r.addEventListener("click",()=>{n&&(n=!1,i.classList.remove("bg-purple-600")),o=!o,r.classList.toggle("bg-purple-600"),l()}),i.addEventListener("click",()=>{o&&(o=!1,r.classList.remove("bg-purple-600")),n=!n,i.classList.toggle("bg-purple-600"),z.isTripletMode=n,B.forEach(c=>{c.config.isTripletMode=n}),l()});function l(){const c=document.querySelector(".note-duration-btn.bg-purple-600");if(c){const u=parseFloat(c.dataset.value);s(u)}}s(z.currentDuration||1)}let bt=!1,ue=null,xt=null,Dt=!1;function Ms(e,t){ue=e,xt=t,ue.addEventListener("mousedown",_s),window.addEventListener("mousemove",Ls),window.addEventListener("mouseup",Ps)}function _s(e){ur()&&(dr(),B.forEach(t=>{var r;return(r=t.pause)==null?void 0:r.call(t)}),Dt=!0),bt=!0,Rr(e)}function Ls(e){bt&&Rr(e)}function Ps(){bt&&(bt=!1,Dt&&(fr(),B.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),Dt=!1))}function Rr(e){if(!ue||!xt)return;const t=ue.getBoundingClientRect(),r=ue.width/t.width;let i=(e.clientX-t.left)*r;i=Math.max(0,Math.min(ue.width,i));const o=H(),n=i/ue.width*o,s=Qn(n,xt),l=s/o*ue.width;fe(s),Le(l)}const on={maxBeatsContext:32,extendBeatsAmount:16};function Ks(){return on.maxBeatsContext}function Gs(){return on.extendBeatsAmount}function Ht(e,t,r,i){const o=H(),n=i/o*t;e.clearRect(0,0,t,r);const s=on.maxBeatsContext,c=Math.max(0,i-s)/o*t,u=n-c;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(c,0,u,r),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(n,0),e.lineTo(n,r),e.stroke()}let Kn=!1,Bt=!1,Ve=0;function Xs(){return Ve}function Gn(){if(!Kn){Kn=!0;const i=document.getElementById("extend-use-tags"),o=document.getElementById("extend-tags");if(i&&o){let u=function(){const h=a.checked;d.disabled=!h,d.classList.toggle("opacity-50",!h),d.classList.toggle("cursor-not-allowed",!h)};const a=i,d=o;u(),a.addEventListener("change",u)}const n=document.getElementById("extend-start-help-btn"),s=document.getElementById("extend-start-help-popup"),l=document.getElementById("extend-start-help-close");n&&s&&l&&(n.addEventListener("click",()=>s.classList.remove("hidden")),l.addEventListener("click",()=>s.classList.add("hidden")),document.addEventListener("click",u=>{u.target instanceof Node&&!s.contains(u.target)&&u.target!==n&&s.classList.add("hidden")}));const c=document.querySelector("#ai-extend-modal .generate-btn");c&&c.addEventListener("click",async()=>{const{extendTracksWithAI:u}=await Vn(async()=>{const{extendTracksWithAI:a}=await import("./extendTracks-DMl6BaqW.js");return{extendTracksWithAI:a}},__vite__mapDeps([0,1]));await u()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),r=document.getElementById("extend-deselect-all");e&&t&&r&&(e.innerHTML="",he().forEach((o,n)=>{const s=`extend-track-${n}`,l=document.createElement("div");l.className="flex items-center gap-2";const c=document.createElement("input");c.type="checkbox",c.id=s,c.dataset.index=n.toString(),c.checked=!0,c.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const u=document.createElement("label");u.htmlFor=s,u.className="text-sm text-gray-200",u.textContent=o.config.name||`Track ${n+1}`,c.addEventListener("change",()=>{We()}),l.appendChild(c),l.appendChild(u),e.appendChild(l)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(o=>o.checked=!0),We()}),r.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(o=>o.checked=!1),We()}),We())}function qs(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const r=t.getContext("2d");if(!r)return;const i=e.clientWidth,o=e.clientHeight;e.width=i,e.height=o,t.width=i,t.height=o,We(),Ht(r,i,o,Ve),t.addEventListener("mousedown",s=>{Bt=!0,n(s.offsetX)}),window.addEventListener("mouseup",()=>{Bt=!1}),window.addEventListener("mousemove",s=>{if(!Bt)return;const l=t.getBoundingClientRect();n(s.clientX-l.left)});function n(s){if(!r)return;const l=H(),c=Math.max(0,Math.min(s,i));Ve=Math.round(c/i*l),Ht(r,i,o,Ve)}}function We(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const r=t.getContext("2d");if(!r)return;const i=t.width,o=t.height,n=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),s=Array.from(n).filter(c=>c.checked).map(c=>parseInt(c.dataset.index||"0",10)),l=he().filter((c,u)=>s.includes(u));X(e,l),Ht(r,i,o,Ve)}function Os(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),r=document.getElementById("velocity-mode-btn"),i=document.getElementById("note-duration-controls"),o=document.getElementById("select-mode-controls"),n=document.getElementById("velocity-mode-controls");if(!e||!t||!r||!i||!o||!n){console.error("Missing essential UI elements for edit mode switching.");return}function s(c){[e,t,r].forEach(u=>{u&&(u.classList.remove("bg-purple-600"),u.classList.add("bg-gray-800"))}),c.classList.remove("bg-gray-800"),c.classList.add("bg-purple-600")}function l(c){[i,o,n].forEach(u=>{u&&u.classList.add("hidden")}),c.classList.remove("hidden")}e.addEventListener("click",()=>{s(e),l(i),J("note-placement")}),t.addEventListener("click",()=>{s(t),l(o),J("select")}),r.addEventListener("click",()=>{s(r),l(n),J("none")}),window.addEventListener("keydown",c=>{var d;const u=(d=document.activeElement)==null?void 0:d.tagName;if(!(u==="INPUT"||u==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(c.key.toLowerCase()){case"q":e.click();break;case"w":t.click();break;case"e":r.click();break;default:return}}),s(e),l(i),J("note-placement")}function Rs(){var h,f,m;const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),r=document.getElementById("note-duration-panel"),i=document.getElementById("ai-control-panel");if(!e||!t||!r||!i){console.error("Missing essential elements for control mode switching.");return}function o(){document.querySelectorAll(".sequencer").forEach(y=>{const p=y.querySelector(".delete-btn"),g=y.querySelector(".collapse-btn"),v=g==null?void 0:g.querySelector("use"),w=y.querySelector(".sequencer-body"),b=y.querySelector(".mini-contour");!p||!g||!v||!w||!b||(p.classList.add("button-locked"),g.classList.add("button-locked"),nt(y,!1),w.classList.contains("hidden")||(w.classList.add("hidden"),b.classList.remove("hidden"),v.setAttribute("href","#icon-caret-up")))})}function n(){document.querySelectorAll(".sequencer").forEach(y=>{const p=y.querySelector(".delete-btn"),g=y.querySelector(".collapse-btn");p==null||p.classList.remove("button-locked"),g==null||g.classList.remove("button-locked")})}function s(){!e||!t||!r||!i||(e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),r.classList.remove("hidden"),i.classList.add("hidden"),n())}function l(){if(!Mt()){const y=document.getElementById("openai-key-not-set-modal");y==null||y.classList.remove("hidden");return}!e||!t||!r||!i||(t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),r.classList.add("hidden"),i.classList.remove("hidden"),o())}e.addEventListener("click",s),t.addEventListener("click",l);const c=document.getElementById("ai-inpaint-modal"),u=document.getElementById("ai-extend-modal"),a=document.getElementById("ai-generate-modal");function d(y){if(!y)return;const p=y.querySelector(".cancel-btn");p==null||p.addEventListener("click",()=>{y.classList.add("hidden")})}d(c),d(u),d(a),Gn(),(h=document.getElementById("ai-inpaint-btn"))==null||h.addEventListener("click",()=>{c==null||c.classList.remove("hidden")}),(f=document.getElementById("ai-extend-btn"))==null||f.addEventListener("click",()=>{u==null||u.classList.remove("hidden"),qs(),Gn()}),(m=document.getElementById("ai-generate-btn"))==null||m.addEventListener("click",()=>{a==null||a.classList.remove("hidden")}),Os()}function Fr(){const e=rn();if(!e)return;const t=e.gridContext,r=t.getSelectedNotes();r.length!==0&&(F(Wt(t.sequencer.id,r),jt(t.sequencer.id,r)),_e()&&(Me(),J(ce.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function Ur(){console.log("performCopy called");const e=rn();if(!e)return;const t=e.getSelectedNotes();t.length!==0&&gr(t)}function Ar(){const e=rn();if(!e)return;const t=e.gridContext,r=t.getSelectedNotes();r.length!==0&&(gr(r),F(_o(t.sequencer.id,r),Lo(t.sequencer.id,r)),_e()&&(Me(),J(ce.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function xr(){if(console.log("performPaste called"),!Ot().notes.length){console.log("No notes in clipboard");return}document.body.style.cursor="crosshair",ai((t,r)=>{const i=t.gridContext,{x:o,y:n}=i.getCanvasPos(r),s=i.getSnappedBeatFromX(o),l=i.getPitchFromRow(Math.floor(n/i.getCellHeight())),c=_(l);if(c===null)return;const{notes:u,anchorBeat:a,anchorMidi:d}=Ot(),h=s-a,f=c-d,m=u.map(y=>{const p=_(y.pitch);return p===null?{...y}:{pitch:de(p+f)??y.pitch,start:y.start+h,duration:y.duration}});F(qo(i.sequencer.id,m),Oo(i.sequencer.id,m)),_e()&&(Me(),J(ce.NOTE_PLACEMENT)),i.setSelectedNotes(m),document.body.style.cursor="default",Jt()})}function Fs(){document.addEventListener("keydown",e=>{const r=navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey,i=document.activeElement,o=i instanceof HTMLElement?i.tagName:null;if(!(o==="INPUT"||o==="TEXTAREA"))switch(!0){case(r&&e.key==="c"):e.preventDefault(),Ur();break;case(r&&e.key==="x"):e.preventDefault(),Ar();break;case(r&&e.key==="v"):e.preventDefault(),xr();break;case e.key==="Delete":e.preventDefault(),Fr();break}})}function Us(){const e=document.querySelector(".select-mode-copy");e&&(e.onclick=Ur);const t=document.querySelector(".select-mode-cut");t&&(t.onclick=Ar);const r=document.querySelector(".select-mode-paste");r&&(r.onclick=xr);const i=document.querySelector(".select-mode-delete");i&&(i.onclick=Fr),Fs()}function As(e,t){return e!==void 0&&t!==void 0&&e===t}function xs(e=Oe()){var r,i,o;Xt(e.tempo,!1),Vt(e.timeSignature[0],!1),Yt(e.totalMeasures,!1);for(const n of B)n.updateTotalMeasures();for(const n of e.sequencers){const s=B.find(l=>As(l.id,n.id));if(s){s.instrumentName=n.instrument;const l=(r=s.container)==null?void 0:r.querySelector("canvas.mini-contour");l&&Qe(l,s.notes,s.config,s.colorIndex);const c=(i=s.grid)==null?void 0:i.gridContext;if(c){const u=c.getSelectedNotes?c.getSelectedNotes():[],a=c.getSelectedNote?c.getSelectedNote():null,d=u.map(h=>({pitch:h.pitch,start:h.start,duration:h.duration}));if(c.notes.length=0,c.notes.push(...structuredClone(n.notes)),u.length>0){const h=d.map(f=>c.notes.find(m=>m.pitch===f.pitch&&m.start===f.start&&m.duration===f.duration)).filter(Boolean);h.length>0&&(c.setSelectedNotes(h),a&&h.length===1&&c.setSelectedNote(h[0]))}(o=s.grid)==null||o.scheduleRedraw()}}else{const l={id:n.id,instrument:n.instrument,notes:structuredClone(n.notes)},{wrapper:c}=Sr(l),u=c.querySelector(".sequencer");u&&nt(u,!0)}}const t=document.getElementById("global-mini-contour");t&&X(t,B)}Ho(xs);function Ds(){const e=document.getElementById("global-mini-contour");e&&X(e,B)}document.getElementById("global-mini-contour");const sn=document.getElementById("global-mini-playhead");Ns(sn);Ms(sn,z);Le(0);const Hs=document.getElementById("piano");ns(Hs);const $s=document.getElementById("waveform"),Ws=document.getElementById("visualizer-mode");os($s,Ws);const Xn=0,js="fluidr3-gm/acoustic_grand_piano";F(rr(Xn,js),$t(Xn));F(Kt("Initial App State"),ir("Initial App State"));Us();Ds();Bi();Bs();Rs();is();qi({getSequencers:()=>B,onPlay:()=>{mt();const e=H(),t=ht();Jo(Ee(),{loop:z.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{B.forEach(r=>{var i;return(i=r.onTransportLoop)==null?void 0:i.call(r)})}}),Pt(r=>{const i=r/e*sn.width;Le(i)}),B.forEach(r=>r.play()),Vo(()=>{Oi(),fe(0),Le(0)})},onPause:()=>{dr(),B.forEach(e=>e.pause())},onResume:()=>{fr(),B.forEach(e=>e.resume())},onStop:()=>{mt(),fe(0),B.forEach(e=>e.stop()),Le(0)},onDurationChange:e=>{z.currentDuration=e,B.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{z.snapResolution=e,B.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{z.loopEnabled=e,B.forEach(t=>t.config.loopEnabled=e),Xo(e)},onTempoChange:e=>{Xt(e)},onSave:async e=>{const t=Oe();if(e==="json"){const{url:r,filename:i}=ss(t),o=document.createElement("a");o.href=r,o.download=i,o.click(),URL.revokeObjectURL(r)}else if(e==="wav"){const r={globalConfig:{bpm:t.tempo,beatsPerMeasure:t.timeSignature[0],totalMeasures:t.totalMeasures},tracks:B.map(i=>({notes:i.notes,instrument:i.instrumentName,config:i.config}))};await as(r)}else if(e==="midi"){const{url:r,filename:i}=await ks(t),o=document.createElement("a");o.href=r,o.download=i,o.click(),URL.revokeObjectURL(r)}},onLoad:async e=>{var t;try{const r=(t=e.name.split(".").pop())==null?void 0:t.toLowerCase();if(r==="json"){const{tracks:i,globalConfig:o}=await Is(e);await zn(i,o)}else if(r==="mid"||r==="midi"){const{tracks:i,globalConfig:o}=await Cs(e);await zn(i,o)}else throw new Error("Unsupported file type.")}catch(r){r instanceof Error?alert("Failed to load file: "+r.message):alert("Failed to load file: Unknown error")}},onMeasuresChange:e=>{Yt(e);const t=document.getElementById("global-mini-contour");t&&X(t,B)},onBeatsPerMeasureChange:e=>{Vt(e);const t=document.getElementById("global-mini-contour");t&&X(t,B)}});const Vs=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{mn as a,he as b,Xs as c,Ks as d,Gs as e,et as f,Mt as g,Qe as h,X as i,Vs as m,Yt as u};
