const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-CRjY8Y_2.js","assets/index-qjYaReYC.js"])))=>i.map(i=>d[i]);
import{_ as zt}from"./index-qjYaReYC.js";function Yt(e=3){const i=["C","D","E","F","G","A","B"],r=["C#","D#","","F#","G#","A#",""],l=[e,e+1,e+2],a={};let d=0;for(const c of l)i.forEach(u=>{const f=`${u}${c}`;a[f]={note:f,x:d,width:60,height:200,isBlack:!1},d+=60});d=0;for(const c of l)r.forEach((u,f)=>{if(u===""){d+=60;return}const m=`${u}${c}`;a[m]={note:m,x:d+60-40/2,width:40,height:120,isBlack:!0},d+=60});return a}function qe(e,t,n=new Set,o=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const s={};if(o)for(const[i,r]of Object.entries(o))s[r]=i;for(const i of Object.values(t))i.isBlack||(Rt(e,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",s[i.note]&&(e.fillStyle="#7c3aed",e.fillText(s[i.note],i.x+i.width/2,i.height-24),e.fillStyle="#333"),e.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(t))i.isBlack&&(Rt(e,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),Tn(e,i),s[i.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(s[i.note],i.x+i.width/2,i.height-28)))}function Rt(e,{x:t,width:n,height:o,fill:s,stroke:i,radius:r=8}){e.beginPath(),e.moveTo(t,0),e.lineTo(t,o-r),e.quadraticCurveTo(t,o,t+r,o),e.lineTo(t+n-r,o),e.quadraticCurveTo(t+n,o,t+n,o-r),e.lineTo(t+n,0),e.closePath(),e.fillStyle=s,e.fill(),e.strokeStyle=i,e.lineWidth=1,e.stroke()}function Tn(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}function D(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}function An(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function Pn(e){return e.replace(/\d+$/,"")}function st(e){return e.includes("#")}function qn(e,t){return e/t()}function _n(e,t){let n=t.snapResolution||.25,o=t.isTripletMode?n*(2/3):n;return Math.round(e/o)*o}function Rn(e,t,n){const o=qn(e,n);return _n(o,t)}function Vt(e,t,n,o,s,i=4){e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+o-i,n),e.quadraticCurveTo(t+o,n,t+o,n+i),e.lineTo(t+o,n+s-i),e.quadraticCurveTo(t+o,n+s,t+o-i,n+s),e.lineTo(t+i,n+s),e.quadraticCurveTo(t,n+s,t,n+s-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}const le=64,Dn={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"},Ue=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:50,cellHeight:25},{cellWidth:60,cellHeight:30}];function Fn(e,t){const n=structuredClone(e);return n.tempo=t.bpm,n}function Qt(e){return{type:"CHANGE_TEMPO",bpm:e}}function On(e){return Qt(e)}function Hn(e,t){const n=structuredClone(e);return n.timeSignature=[t.beats,4],n}function Jt(e){return{type:"SET_TIME_SIGNATURE",beats:e}}function $n(e){return Jt(e)}function Un(e,t){const n=structuredClone(e);return n.totalMeasures=t.measures,n}function Zt(e){return{type:"SET_TOTAL_MEASURES",measures:e}}function Xn(e){return Zt(e)}function Gn(e,t){const n=structuredClone(e);return n.sequencers.push({id:t.id,instrument:t.instrument,notes:t.notes||[]}),M.find(s=>s.id===t.id)||vn({config:{id:t.id,...t.config},notes:t.notes||[],instrument:t.instrument}),n}function xt(e,t){return{type:"CREATE_SEQUENCER",id:e,instrument:t}}function wt(e){return{type:"DELETE_SEQUENCER",id:e}}function Kn(e,t){const n=structuredClone(e);n.sequencers=n.sequencers.filter(s=>s.id!==t.id);const o=M.findIndex(s=>s.id===t.id);return o!==-1&&(M[o].destroy(),M.splice(o,1)),n}function Wn(e,t,n=[]){return{type:"DELETE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function jn(e,t,n=[]){return{type:"CREATE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function zn(e,t){return structuredClone(e)}const je=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function _e(e,t,n,o=0){const s=e.getContext("2d"),i=e.width,r=e.height;s.clearRect(0,0,i,r);const l=je[o%je.length];s.fillStyle=l;const a=R(),d=D(n.noteRange[0]),u=D(n.noteRange[1])-d||1,f=Math.max(2,r/u);for(const m of t){const g=m.start/a*i,h=Math.max(1,m.duration/a*i),y=(D(m.pitch)-d)/u,E=r-y*r-f/2;s.fillRect(g,E,h,f)}}function ie(e,t){const n=e.getContext("2d"),o=e.width,s=e.height;n.clearRect(0,0,o,s),t.forEach((i,r)=>{const l=i.notes,a=i.config;if(!(l!=null&&l.length))return;const d=R(),c=je[r%je.length];n.fillStyle=c;const u=D(a.noteRange[0]),m=D(a.noteRange[1])-u||1,g=Math.max(2,s/m);for(const h of l){const p=h.start/d*o,y=Math.max(1,h.duration/d*o),v=(D(h.pitch)-u)/m,S=s-v*s-g/2;n.fillRect(p,S,y,g)}})}function Yn(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;o.notes.push(...t.notes);const s=document.getElementById("global-mini-contour");return s&&ie(s,M),n}function Vn(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Qn(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Jn(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));o.notes=o.notes.filter(r=>{const l=`${r.pitch}|${r.start}|${r.duration}`;return!s.has(l)});const i=document.getElementById("global-mini-contour");return i&&ie(i,M),n}function Bt(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Mt(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Zn(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const{from:s,to:i}=t;for(let r=0;r<s.length;r++){const l=s[r],a=i[r],d=o.notes.findIndex(c=>c.pitch===l.pitch&&c.start===l.start&&c.duration===l.duration);d!==-1&&(o.notes[d].pitch=a.pitch,o.notes[d].start=a.start)}return n}function Lt(e,t,n){return{type:"MOVE_NOTES",sequencerId:e,from:structuredClone(t),to:structuredClone(n)}}function en(e,t,n){return Lt(e,n,t)}function xn(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(i=>`${i.pitch}|${i.start}|${i.duration}`));return o.notes=o.notes.filter(i=>{const r=`${i.pitch}|${i.start}|${i.duration}`;return!s.has(r)}),n}function eo(e,t){return{type:"CUT_NOTES",sequencerId:e,notes:structuredClone(t)}}function to(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function no(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);return o?(o.notes.push(...t.notes),n):e}function oo(e,t){return{type:"PASTE_NOTES",sequencerId:e,notes:structuredClone(t)}}function so(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function io(e,t){return structuredClone(e)}function ro(e,t){return structuredClone(e)}function Ct(e=""){return{type:"CHECKPOINT",label:e}}function tn(e=""){return Ct(e)}const ao=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_INSTRUMENT:zn,CHANGE_TEMPO:Fn,CHECKPOINT:ro,CREATE_SEQUENCER:Gn,CUT_NOTES:xn,DELETE_NOTES:Jn,DELETE_SEQUENCER:Kn,MOVE_NOTES:Zn,PASTE_NOTES:no,PLACE_NOTES:Yn,SET_TIME_SIGNATURE:Hn,SET_TOTAL_MEASURES:Un,UPDATE_NOTE_VELOCITY:io},Symbol.toStringTag,{value:"Module"}));function Nt(e){const t=ao[e.type];if(!t)throw new Error(`Unknown diff type: ${e.type}`);const n=t(Fe(),e);nn(n)}let at=new Set;function co(e){return at.add(e),()=>at.delete(e)}function De(e){for(const t of at)t(e)}const de=[];let x=-1;function lo({forwardDiff:e,reverseDiff:t}){de.splice(x+1),de.push({forwardDiff:e,reverseDiff:t}),x=de.length-1}function uo(){var e;if(x<0)return null;for(let t=x;t>=0;t--){const n=de[t];if(((e=n==null?void 0:n.forwardDiff)==null?void 0:e.type)==="CHECKPOINT")return null;if(n!=null&&n.reverseDiff)return x=t-1,Nt(n.reverseDiff),De(Fe()),n.reverseDiff}return null}function fo(){if(x>=de.length-1)return null;x++;const e=de[x];return!e||!e.forwardDiff?null:(Nt(e.forwardDiff),De(Fe()),e.forwardDiff)}function mo(){de.length=0,x=-1}let ze={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[]};function Fe(){return ze}function nn(e){ze=structuredClone(e),De(ze)}function q(e,t){Nt(e),lo({forwardDiff:e,reverseDiff:t}),De(ze)}let X=null,V=500,Se=null,ct=!1,lt=1/0,we=[],We=null,on=0,sn=4,rn=8;function dt(e){return we.push(e),()=>{const t=we.indexOf(e);t!==-1&&we.splice(t,1)}}function go(){we=[]}function se(e){on=e}function R(){return He()*Oe()}function Ye(){return on}function ut(e,t=!0){if(t){const o=ue();q(Qt(e),On(o));return}if(an()){const o=performance.now(),s=(o-Se)/V;V=60/e*1e3,Se=o-s*V}else V=60/e*1e3;const n=document.getElementById("tempo-input");n&&n.value!==String(e)&&(n.value=e)}function ue(){return 60/(V/1e3)}function ft(e,t=!0){if(t){const o=Oe();q(Jt(e),$n(o));return}sn=e;const n=document.getElementById("beats-per-measure-input");n&&n.value!==String(e)&&(n.value=e),$e().forEach(o=>{var s,i;(s=o.grid)!=null&&s.resizeAndRedraw?o.grid.resizeAndRedraw():(i=o.grid)==null||i.scheduleRedraw()})}function Oe(){return sn}function mt(e,t=!0){if(t){const o=He();q(Zt(e),Xn(o));return}rn=e;const n=document.getElementById("measures-input");n&&n.value!==String(e)&&(n.value=e),$e().forEach(o=>{var s;(s=o.grid)==null||s.scheduleRedraw()})}function He(){return rn}function po(e){We=e}function ho(e,t={}){V=60/e*1e3,ct=t.loop??!1,lt=t.endBeat??1/0;const n=t.startBeat??0;Se=performance.now()-n*V;const o=t.onLoop;function s(i){const l=(i-Se)/V;if(se(l),we.forEach(a=>a(l)),l>=lt)if(ct)Se=performance.now(),se(0),o&&o();else{Ve();return}X=requestAnimationFrame(s)}X=requestAnimationFrame(s)}function Ve(){X&&cancelAnimationFrame(X),X=null,go(),We&&(We(),We=null)}function an(){return X!==null}function cn(){X&&cancelAnimationFrame(X),X=null}function ln(){if(X)return;const e=performance.now()-Ye()*V;function t(n){const s=(n-e)/V;if(se(s),we.forEach(i=>i(s)),s>=lt)if(ct)Se=performance.now(),se(0);else{Ve();return}X=requestAnimationFrame(t)}X=requestAnimationFrame(t)}function yo(e,t,n,o,s,i){const r=Oe(),l=R()*o;for(let c=0;c<n;c++){const u=c*s,f=i(c);e.fillStyle=st(f)?"rgb(174,173,175)":"#fefefe",e.fillRect(0,u,l,s),e.fillStyle=st(f)?"#a088b0":"#dddddd",e.fillRect(-64,u,le,s)}e.font=`${Math.floor(s*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let c=0;c<n;c++){const u=c*s,f=i(c);e.fillStyle=st(f)?"#800080":"#444",e.fillText(f,-8,u+s/2)}e.strokeStyle="#ddd",e.lineWidth=1;for(let c=0;c<n;c++){const u=c*s;e.beginPath(),e.moveTo(0,u),e.lineTo(l,u),e.stroke()}const a=R();console.log(`Got ${a} beats and beatsPerMeasure: ${r}`);const d=n*s;for(let c=0;c<=a;c++){const u=c*o,f=c%r===0;e.strokeStyle=f?"#bbb":"#eee",e.lineWidth=f?2:1,e.beginPath(),e.moveTo(u,0),e.lineTo(u,d),e.stroke()}}function Eo(e,t,{previewNotes:n=null,hoveredNote:o,selectedNote:s,selectedNotes:i=[],highlightedNotes:r=[],cellWidth:l,cellHeight:a,visibleStartBeat:d,visibleEndBeat:c,getPitchRow:u,getPitchClass:f,PITCH_COLOR_MAP:m,drawRoundedRect:g}){for(const p of t){if(p.start+p.duration<d-2||p.start>c)continue;const y=p.start*l,E=u(p.pitch)*a,v=p.duration*l,S=a-1,w=m[f(p.pitch)]||"#999";e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,r.includes(p)?e.fillStyle="rgba(96, 165, 250, 0.6)":e.fillStyle=w,g(e,y,E,v,S),e.fill();const L=e.createLinearGradient(y,E,y,E+S);L.addColorStop(0,"rgba(255,255,255,0.4)"),L.addColorStop(.2,"rgba(255,255,255,0.15)"),L.addColorStop(.5,"rgba(255,255,255,0.05)"),L.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=L,g(e,y,E,v,S),e.fill();const k=i.includes(p),C=p===o,I=r.includes(p);(k||C||I)&&(e.lineWidth=2,k?e.strokeStyle="rgba(59, 130, 246, 1.0)":C?e.strokeStyle="rgba(0, 0, 0, 0.8)":I&&(e.strokeStyle="rgba(96, 165, 250, 0.6)"),g(e,y,E,v,S),e.stroke())}if(n)for(const p of n){const y=p.start*l,E=u(p.pitch)*a,v=p.duration*l,S=a-1,w=m[f(p.pitch)]||"#999";e.fillStyle=vo(w,.4),g(e,y,E,v,S),e.fill()}}function vo(e,t){const n=parseInt(e.slice(1),16);return`rgba(${n>>16&255}, ${n>>8&255}, ${n&255}, ${t})`}function bo(e,t,n,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+n,0),e.lineTo(t+n,o),e.stroke(),e.restore()}function So(e,t,n,o=le){const s=e.getBoundingClientRect(),i=parseFloat(e.style.width||s.width),r=parseFloat(e.style.height||s.height),l=e.width/i,a=e.height/r,d=(t.clientX-s.left)*l-o,c=(t.clientY-s.top)*a;return{x:d,y:c}}function wo(e,t,n,o,s,i){const r=Math.floor(t/s),l=e/i;return n.find(a=>l>=a.start&&l<a.start+a.duration&&o(a.pitch)===r)}function Bo(e,t,n,o){const s=e.querySelector(".zoom-in-btn"),i=e.querySelector(".zoom-out-btn"),r=e.querySelector(".zoom-reset-btn");!s||!i||!r||(s.addEventListener("click",t),i.addEventListener("click",n),r.addEventListener("click",o))}function Mo(){for(const e of M){const t=e.container,n=t.querySelector(".sequencer-body"),o=t.querySelector("canvas.mini-contour"),s=t.querySelector(".collapse-btn use");n.classList.contains("hidden")||(n.classList.add("hidden"),o.classList.remove("hidden"),s==null||s.setAttribute("href","#icon-caret-up"),nt(t,!1),_e(o,e.notes,e.config,e.colorIndex))}}function P(e){const t=e.match(/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o,s]=t;return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[o]+12*parseInt(s,10)}function Re(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}let et=!1,Qe=null,H=null;function Lo(e){et=!0,Qe=e,H=null}function kt(){var e;H&&(H.gridContext.setPastePreviewNotes(null),H.scheduleRedraw(),(e=H.setCursor)==null||e.call(H,"default")),et=!1,Qe=null,H=null,document.body.style.cursor="default"}function It(){return et}function Co(e,t){!et||!Qe||(Qe(e,t),kt())}function No(e){H&&H!==e&&(H.gridContext.setPastePreviewNotes(null),H.scheduleRedraw()),H=e}const ee={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let dn=ee.NOTE_PLACEMENT;const gt=new Set;function un(){return dn}function W(e){kt(),dn=e;for(const t of gt)t(e)}function ko(e){return gt.add(e),()=>gt.delete(e)}let Tt=!1;function Io(){Tt=!0,W(ee.SELECT)}function Be(){Tt=!1}function Me(){return Tt}let At=!1;function To(e=!0){At=e}function Ao(){return At}function Po(){At=!1}let fn={notes:[],anchorBeat:0,anchorMidi:0};function mn(e){if(e.length===0)return;const t=e[0],n=t.start,o=P(t.pitch);fn={notes:e.map(s=>({pitch:s.pitch,start:s.start,duration:s.duration})),anchorBeat:n,anchorMidi:o}}function pt(){return fn}function gn(e,t,n){if(!It()){e.setPastePreviewNotes(null);return}const{notes:o,anchorBeat:s,anchorMidi:i}=pt(),r=e.getSnappedBeatFromX(t),l=e.getPitchFromRow(Math.floor(n/e.getCellHeight())),a=P(l),d=r-s,c=a-i,u=o.map(f=>({pitch:Re(P(f.pitch)+c),start:f.start+d,duration:f.duration}));e.setPastePreviewNotes(u),e.scheduleRedraw()}function pn(e){It()&&e.setPastePreviewNotes(null)}function hn(e,t){return It()?(Co(e.grid,t),t.preventDefault(),t.stopPropagation(),!0):!1}let ke=null;const qo=8;function Dt(){ke=null}function _o(e,t){ke={x:e,y:t}}function Ro(e,t){if(!ke)return!1;const n=e-ke.x,o=t-ke.y;return Math.sqrt(n*n+o*o)>=qo}let Ee=null;function ht(e){console.log(`registerSelectionStart called with grid: ${e}`),Ee&&Ee!==e&&Ee.clearSelection(),Ee=e}function Do(){Ee=null}function Pt(){return Ee}function Ft(e){let t=null,n=null,o=!1;function s(c){var v,S;if(ht(e.grid),Ao()){Po();return}const{x:u,y:f}=e.getCanvasPos(c);if(u<0){const w=e.getPitchFromRow(Math.floor(f/e.getCellHeight()));e.sequencer.playNote(w,.5);return}const m=e.findNoteAt(u,f);if(m){e.setSelectedNote(m),e.scheduleRedraw(),(v=e.onNotesChanged)==null||v.call(e);return}const g=e.getSnappedBeatFromX(u),h=e.getPitchFromRow(Math.floor(f/e.getCellHeight())),p=R();if(g+e.config.currentDuration>p||e.notes.some(w=>w.pitch===h&&w.start===g))return;e.sequencer.playNote(h,.5);const E={pitch:h,start:g,duration:e.config.currentDuration};q(Vn(e.sequencer.id,[E]),Qn(e.sequencer.id,[E])),e.scheduleRedraw(),(S=e.onNotesChanged)==null||S.call(e)}function i(c){c.preventDefault();const{x:u,y:f}=e.getCanvasPos(c),m=e.findNoteAt(u,f);if(!m||e.notes.indexOf(m)===-1)return;const h=[m];q(Bt(e.sequencer.id,h),Mt(e.sequencer.id,h))}function r(c){if(hn(e,c))return;const{x:u,y:f}=e.getCanvasPos(c),m=e.findNoteAt(u,f);if(m){ht(e.grid),e.setSelectedNote(m),t={startX:u,startY:f,anchorNote:m,initialStart:m.start,initialMidi:P(m.pitch),initialNote:{pitch:m.pitch,start:m.start,duration:m.duration}};return}_o(u,f),o=!1}function l(c){var h;const{x:u,y:f}=e.getCanvasPos(c);if(u<0){e.clearPreview();return}if(gn(e,u,f),!o&&Ro(u,f)){Io(),e.selectionBox={active:!0,startX:u,startY:f,currentX:u,currentY:f},o=!0,Dt();return}const m=e.findNoteAt(u,f);e.setHoveredNote(m);const g=e.getSelectedNote();if(!t&&g&&g!==m&&e.setSelectedNote(null),!m&&!t){const p=e.getSnappedBeatFromX(u),y=e.getPitchFromRow(Math.floor(f/e.getCellHeight())),E=R();p+e.config.currentDuration<=E?e.updatePreview({pitch:y,start:p,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&g){const p=u-t.startX,y=e.getSnappedBeatFromX(p)-e.getSnappedBeatFromX(0),E=Math.max(0,t.initialStart+y),v=R();E+g.duration<=v&&(g.start=E);const S=f-t.startY,w=Math.round(S/e.getCellHeight()),L=t.initialMidi-w,k=P(e.config.noteRange[0]),C=P(e.config.noteRange[1]),I=Math.max(k,Math.min(C,L)),A=Re(I);A!==g.pitch&&(g.pitch=A,n!==A&&(n=A,e.sequencer.playNote(A,.5))),e.scheduleRedraw(),(h=e.onNotesChanged)==null||h.call(e);return}e.scheduleRedraw()}function a(c){if(Dt(),o=!1,!t||!e.getSelectedNote()){t=null;return}const{anchorNote:u,initialNote:f}=t,m={pitch:u.pitch,start:u.start,duration:u.duration};(f.pitch!==m.pitch||f.start!==m.start)&&q(Lt(e.sequencer.id,[f],[m]),en(e.sequencer.id,[f],[m])),t=null}function d(){e.clearPreview(),e.setHoveredNote(null),pn(e),e.scheduleRedraw()}return{attach(c){c.addEventListener("click",s),c.addEventListener("contextmenu",i),c.addEventListener("mousemove",l),c.addEventListener("mouseleave",d),c.addEventListener("mousedown",r),c.addEventListener("mouseup",a)},detach(c){c.removeEventListener("click",s),c.removeEventListener("contextmenu",i),c.removeEventListener("mousemove",l),c.removeEventListener("mouseleave",d),c.removeEventListener("mousedown",r),c.removeEventListener("mouseup",a)}}}function Ot(e){let t=null;function n(l){l.preventDefault();const{x:a,y:d}=e.getCanvasPos(l),c=e.findNoteAt(a,d);if(!c)return;const u=e.getSelectedNotes(),f=u.includes(c)?u:[c];f.length&&(e.setSelectedNotes([]),q(Bt(e.sequencer.id,f),Mt(e.sequencer.id,f)),Me()&&(Be(),W(ee.NOTE_PLACEMENT)))}function o(l){if(hn(e,l))return;const{x:a,y:d}=e.getCanvasPos(l);if(a<0)return;const c=e.findNoteAt(a,d);e.setHoveredNote(c),ht(e.grid);const u=e.getSelectedNotes();if(c&&u.includes(c)){t={startX:a,startY:d,anchorNote:c,initialNotes:u.map(f=>({note:f,start:f.start,midi:P(f.pitch)}))};return}e.selectionBox={active:!0,startX:a,startY:d,currentX:a,currentY:d},e.clearPreview(),e.setSelectedNote(null)}function s(l){var u,f;No(e.grid);const{x:a,y:d}=e.getCanvasPos(l),c=e.findNoteAt(a,d);if(e.setHoveredNote(c),gn(e,a,d),(u=e.selectionBox)!=null&&u.active){e.selectionBox.currentX=a,e.selectionBox.currentY=d;const m=e.selectionBox,g=Math.min(m.startX,m.currentX),h=Math.min(m.startY,m.currentY),p=Math.max(m.startX,m.currentX),y=Math.max(m.startY,m.currentY),E=Math.floor(h/e.getCellHeight()),v=Math.floor(y/e.getCellHeight()),S=e.getSnappedBeatFromX(g),w=e.getSnappedBeatFromX(p),L=P(e.getPitchFromRow(E)),k=P(e.getPitchFromRow(v)),C=e.notes.filter(I=>{const A=P(I.pitch),G=I.start,_=I.start+I.duration,K=G>=S&&_<=w,me=A>=k&&A<=L;return K&&me});e.setHighlightedNotes(C),e.scheduleRedraw();return}if(t){const m=a-t.startX,g=e.getSnappedBeatFromX(m)-e.getSnappedBeatFromX(0),h=d-t.startY,p=Math.round(h/e.getCellHeight()),y=R(),E=P(e.config.noteRange[0]),v=P(e.config.noteRange[1]);for(const{note:w,start:L,midi:k}of t.initialNotes){const C=Math.max(0,L+g),I=Math.max(E,Math.min(v,k-p)),A=Re(I);C+w.duration<=y&&(w.start=C,w.pitch=A)}const S=t.initialNotes.find(w=>w.note===t.anchorNote);if(S){const w=S.note.pitch;t.lastPreviewPitch!==w&&(t.lastPreviewPitch=w,e.sequencer.playNote(w,.5))}e.scheduleRedraw(),(f=e.onNotesChanged)==null||f.call(e)}}function i(l){var a,d;if((a=t==null?void 0:t.initialNotes)!=null&&a.length){const{initialNotes:c}=t,u=c.map(({start:g,midi:h,note:p})=>({pitch:Re(h),start:g,duration:p.duration})),f=c.map(({note:g})=>({pitch:g.pitch,start:g.start,duration:g.duration}));u.some((g,h)=>g.pitch!==f[h].pitch||g.start!==f[h].start)&&(q(Lt(e.sequencer.id,u,f),en(e.sequencer.id,u,f)),Me()&&(Be(),W(ee.NOTE_PLACEMENT)))}if(t=null,(d=e.selectionBox)!=null&&d.active){const{x:c,y:u}=e.getCanvasPos(l);e.selectionBox.currentX=c,e.selectionBox.currentY=u,e.selectionBox.active=!1;const f=e.selectionBox,m=Math.min(f.startX,f.currentX),g=Math.min(f.startY,f.currentY),h=Math.max(f.startX,f.currentX),p=Math.max(f.startY,f.currentY),y=Math.floor(g/e.getCellHeight()),E=Math.floor(p/e.getCellHeight()),v=e.getSnappedBeatFromX(m),S=e.getSnappedBeatFromX(h),w=P(e.getPitchFromRow(y)),L=P(e.getPitchFromRow(E)),k=e.notes.filter(C=>{const I=P(C.pitch),A=C.start,G=C.start+C.duration,_=A>=v&&G<=S,K=I>=L&&I<=w;return _&&K});e.setHighlightedNotes([]),e.setSelectedNotes(k),e.scheduleRedraw(),Me()&&e.getSelectedNotes().length===0&&(l.stopPropagation(),Be(),W(ee.NOTE_PLACEMENT),To(!0))}}function r(){e.setHoveredNote(null),e.setHighlightedNotes([]),pn(e),e.scheduleRedraw()}return{attach(l){l.addEventListener("mousedown",o),l.addEventListener("mousemove",s),l.addEventListener("mouseup",i),l.addEventListener("mouseleave",r),l.addEventListener("contextmenu",n)},detach(l){l.removeEventListener("mousedown",o),l.removeEventListener("mousemove",s),l.removeEventListener("mouseup",i),l.removeEventListener("mouseleave",r),l.removeEventListener("contextmenu",n)}}}function Fo(e,t){const n=t.selectionBox;if(!n)return;const o=n.startX,s=n.startY,i=n.currentX,r=n.currentY,l=Math.min(o,i),a=Math.min(s,r),d=Math.abs(i-o),c=Math.abs(r-s);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),Vt(e,l,a,d,c,3),e.stroke(),e.restore()}function Oo(e,t,n,o,s,i){let r=null,l=null,a=null,d=null,c=2;const u=e.getContext("2d"),f=t.getContext("2d");let m=Ue[c].cellWidth,g=Ue[c].cellHeight;const h=D(s.noteRange[1])-D(s.noteRange[0])+1,p=h*g,E=R()*m+le;e.width=E,e.height=p,e.style.width=`${E}px`,e.style.height=`${p}px`,t.width=E,t.height=p,t.style.width=`${E}px`,t.style.height=`${p}px`;let v=null;function S(){v!==null&&cancelAnimationFrame(v),v=requestAnimationFrame(w)}function w(){var b;u.clearRect(0,0,e.width,e.height),u.save(),u.translate(le,0),yo(u,s,h,m,g,K),Eo(u,o,{previewNotes:l??(r?[r]:null),hoveredNote:a,selectedNote:d,selectedNotes:j,highlightedNotes:T.getHighlightedNotes(),cellWidth:m,cellHeight:g,visibleStartBeat:0,visibleEndBeat:e.width/m,getPitchRow:_,getPitchClass:Pn,PITCH_COLOR_MAP:Dn,drawRoundedRect:Vt}),(b=T.selectionBox)!=null&&b.active&&Fo(u,T),u.restore()}function L(){c<Ue.length-1&&(c++,I())}function k(){c>0&&(c--,I())}function C(){c=2,I()}function I(){const b=Ue[c];m=b.cellWidth,g=b.cellHeight,A()}function A(){const Y=R()*m+le,ge=(D(s.noteRange[1])-D(s.noteRange[0])+1)*g;e.width=Y,e.height=ge,e.style.width=`${Y}px`,e.style.height=`${ge}px`,t.width=Y,t.height=ge,t.style.width=`${Y}px`,t.style.height=`${ge}px`,S()}function G(b){bo(f,b,le,e.height)}Bo(i.container,L,k,C);function _(b){return D(s.noteRange[1])-D(b)}function K(b){const Le=D(s.noteRange[1])-b,ge=Math.max(D(s.noteRange[0]),Math.min(D(s.noteRange[1]),Le));return An(ge)}function me(){const b=document.getElementById("global-mini-contour");b&&ie(b,M)}let ne=null,j=[];const T={sequencer:i,grid:null,config:s,notes:o,getCellHeight:()=>g,getCanvasPos:b=>So(e,b,n,le),findNoteAt:(b,Y)=>wo(b,Y,o,_,g,m),scheduleRedraw:S,getPitchFromRow:K,getSnappedBeatFromX:b=>Rn(b,s,()=>m),updatePreview:b=>r=b,clearPreview:()=>r=null,getSelectedNote:()=>d,setSelectedNote:b=>{d=b,j=b?[b]:[]},getSelectedNotes:()=>j,setSelectedNotes:b=>{j=b,d=b.length===1?b[0]:null},setHoveredNote:b=>a=b,onNotesChanged:me};function z(b){ne&&ne.detach(e),ne=b,ne&&ne.attach(e)}function B(){d=null,j=[],a=null,Q=[],S()}const N=un();z(N==="note-placement"?Ft(T):N==="select"?Ot(T):null);let $=ko(b=>{var Y,Le;r=null,l=null,Q=[],(Y=T.clearPreview)==null||Y.call(T),(Le=T.setPastePreviewNotes)==null||Le.call(T,null),T.selectionBox&&(T.selectionBox.active=!1,T.selectionBox=null),B(),z(b==="note-placement"?Ft(T):b==="select"?Ot(T):null),S()});const O={canvas:e,scheduleRedraw:S,drawPlayhead:G,getSelectedNote:()=>d,clearSelection:B,getPreviewNote:()=>r,zoomIn:L,zoomOut:k,getXForBeat:b=>b*m,setMouseHandler:z,setCursor:b=>{e.style.cursor=b},gridContext:T,getSelectedNotes:()=>j,setSelectedNotes:b=>{j=b,d=b.length===1?b[0]:null},destroy(){$(),Do()}};T.setPastePreviewNotes=b=>{l=b};let Q=[];return T.getHighlightedNotes=()=>Q,T.setHighlightedNotes=b=>{Q=b},T.grid=O,O}const Ho={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function tt(e){const t=e.match(/^([A-Ga-g][#b]?)(-?\d+)$/);if(!t)return null;const[,n,o]=t,s=n.toUpperCase(),i=Ho[s];return i===void 0?null:12*(parseInt(o,10)+1)+i}class yn{constructor(t,n,o=te,s=Z,i="fluidr3-gm/acoustic_grand_piano"){this.container=t,this.config={...n},this.context=o,this.destination=s,this.instrumentName=i,this.notes=[],this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.isMuted=!1,this.isSoloed=!1,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this._initCanvases())}async initInstrument(){try{await Je(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){const t=this.container.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument(),console.log(`[SEQ:${this.id}] Instrument set to:`,t)}playNote(t,n,o=100,s=!1){return ms(this.instrumentName,t,n,o,s)}_initCanvases(){const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),o=this.container.querySelector("#grid-scroll-container");this.grid=Oo(t,n,o,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(t){const n=R();this.clampNotesToGrid();const o=n*this.config.cellWidth+(this.config.labelWidth||64),s=this.container.querySelector("canvas.note-grid"),i=this.container.querySelector(".playhead-canvas"),r=this.container.querySelector(".mini-contour");s&&(s.width=o,s.style.width=`${o}px`),i&&(i.width=o,i.style.width=`${o}px`),r&&_e(r,this.notes,this.config,this.colorIndex),this.redraw()}clampNotesToGrid(){const t=R(),n=this.notes.filter(o=>o.start<t);n.forEach(o=>{o.start+o.duration>t&&(o.duration=t-o.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear(),this._beatHandler=t=>{var o;if((o=this.grid)==null||o.drawPlayhead(this.grid.getXForBeat(t)),!this.shouldPlay)return;const n=60/ue();for(const s of this.notes){const i=s.start,r=s.start+s.duration;if(!this._activeNotes.has(s)&&i<=t&&t<=r){const l=s.duration*n;this.playNote(s.pitch,l),this._activeNotes.add(s)}}},this._unsub=dt(this._beatHandler),this._beatHandler(0)}stop(){var t,n,o;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const s of this._activeNotes){const i=this._noteHandlers.get(s);(t=i==null?void 0:i.forceStop)==null||t.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(o=this.grid)==null||o.drawPlayhead(null),this.redraw()}pause(){var t;for(const n of this._activeNotes){const o=this._noteHandlers.get(n);(t=o==null?void 0:o.stop)==null||t.call(o)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=dt(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.isMuted=!this.isMuted,this.isMuted&&(this.isSoloed=!1),this.updateTrackStyle()}toggleSolo(){this.isSoloed=!this.isSoloed,this.isSoloed&&(this.isMuted=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t.classList.toggle("bg-red-600",this.isMuted),t.classList.toggle("bg-gray-700",!this.isMuted),n.classList.toggle("bg-yellow-200",this.isSoloed),n.classList.toggle("bg-gray-700",!this.isSoloed),this.container.classList.toggle("opacity-40",this.isMuted&&!this.isSoloed),this.container.classList.toggle("opacity-100",!(this.isMuted&&!this.isSoloed))}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,o,s])=>({pitch:n,start:o,duration:s})))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:o}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),o&&(this.instrumentName=o),this.redraw()}async exportToOffline(){const t=60/ue(),n=await Je(this.instrumentName,this.context,this.destination);for(const o of this.notes){const s=o.start*t,i=o.duration*t;n.start({note:tt(o.pitch),duration:i,velocity:100,time:s,loop:!1})}}}async function $o(e){var r,l,a;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const o={bpm:((r=n.c)==null?void 0:r.b)??120,beatsPerMeasure:((l=n.c)==null?void 0:l.bpm)??4,totalMeasures:((a=n.c)==null?void 0:a.tm)??8},s=Array.isArray(n.i)?n.i:[];return{tracks:n.tr.map((d,c)=>{if(!Array.isArray(d.n))throw new Error(`Track ${c} missing \`n\` (notes) array.`);const u=d.n.map(([m,g,h])=>({pitch:m,start:g,duration:h})),f=s[c]||"fluidr3-gm/acoustic_grand_piano";return{notes:u,instrument:f}}),globalConfig:o}}const U={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0},M=[],Uo=document.getElementById("sequencers-container"),Xo=document.getElementById("sequencer-template"),En=document.getElementById("add-sequencer");function nt(e,t){var n,o,s,i;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-out-btn"))==null||o.classList.toggle("hidden",!t),(s=e.querySelector(".zoom-reset-btn"))==null||s.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!t)}function $e(){return M}function Go(e){const t=String(e);return $e().find(n=>{var o;return String(n.id)===t||String((o=n.config)==null?void 0:o.id)===t})}function Ht(){const e=M.some(t=>t.solo);M.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function Ce(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function vn(e){const n=Xo.content.cloneNode(!0).querySelector(".sequencer");Uo.insertBefore(n,En);const o=M.length,s=e?{id:o,...U,...e.config}:{id:o,...U},i=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",r=new yn(n,s,te,Z,i);r.id=o,r.colorIndex=o,r.mute=!1,r.solo=!1,r.shouldPlay=!0;const l=n.querySelector("canvas.mini-contour");e&&r.setState(e),_e(l,r.notes,r.config,r.colorIndex),r.updateTrackLabel(),r.initInstrument();const a=n.querySelector(".collapse-btn"),d=a.querySelector("use"),c=n.querySelector(".sequencer-body");a.addEventListener("click",()=>{const h=c.classList.toggle("hidden");d.setAttribute("href",h?"#icon-caret-up":"#icon-caret-down"),l.classList.toggle("hidden",!h),nt(n,!h),h&&_e(l,r.notes,r.config,r.colorIndex)}),n.querySelector(".delete-btn").addEventListener("click",()=>{const h=document.getElementById("delete-confirm-modal"),p=document.getElementById("delete-confirm"),y=document.getElementById("delete-cancel");h.classList.remove("hidden");const E=()=>{const w=Wn(r.id,r.instrumentName,r.notes),L=jn(r.id,r.instrumentName,r.notes);q(w,L),S()},v=()=>{S()},S=()=>{h.classList.add("hidden"),p.removeEventListener("click",E),y.removeEventListener("click",v)};p.addEventListener("click",E),y.addEventListener("click",v)});const f=n.querySelector(".mute-btn"),m=n.querySelector(".solo-btn"),g=n.querySelector(".instrument-select-btn");return f.addEventListener("click",()=>{r.mute=!r.mute,r.mute&&(r.solo=!1,m.classList.remove("bg-yellow-200"),m.classList.add("bg-gray-700"),m.classList.remove("hover:bg-yellow-400"),m.classList.add("hover:bg-purple-700"),Ce(m,!1)),Ce(f,r.mute),Ht();const h=Ye();r.seekTo(h)}),m.addEventListener("click",()=>{r.solo=!r.solo,r.solo&&(r.mute=!1,Ce(f,!1)),m.classList.toggle("bg-yellow-200",r.solo),m.classList.toggle("bg-gray-700",!r.solo),m.classList.toggle("hover:bg-yellow-400",r.solo),m.classList.toggle("hover:bg-purple-700",!r.solo),Ht();const h=Ye();r.seekTo(h)}),g.addEventListener("click",async()=>{const h=document.getElementById("instrument-select-modal"),p=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const y=r.instrumentName||"fluidr3-gm/acoustic_grand_piano",[E,v]=y.split("/");p.value=E,await p.dispatchEvent(new CustomEvent("change",{detail:{preselect:y}})),h.dataset.currentSequencer=r.id,h.classList.remove("hidden")}),Ce(f,!1),Ce(m,!1),m.classList.add("hover:bg-purple-700"),M.push(r),{seq:r,wrapper:n}}function Ko(){M.slice().forEach(n=>n.destroy()),M.length=0;const e=Fe(),t=structuredClone(e);t.sequencers=[],mo(),nn(t),De(t)}function Wo(){document.getElementById("global-mini-contour"),En.addEventListener("click",()=>{const e=M.length;q(xt(e,"fluidr3-gm/acoustic_grand_piano"),wt(e))})}const fe={openaiApiKey:"",openaiModel:"gpt-4o"};function yt(){return fe.openaiApiKey}function $t(){return fe.openaiModel}function jo(e){fe.openaiApiKey=e}function zo(e){const t=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];if(!t.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${t.join(", ")}`);fe.openaiModel=e}function Yo(){localStorage.setItem("userConfig",JSON.stringify(fe))}function Vo(){const e=localStorage.getItem("userConfig");if(e){const t=JSON.parse(e);fe.openaiApiKey=t.openaiApiKey||"",fe.openaiModel=t.openaiModel||"gpt-4o"}}Vo();function Qo(){const e=document.getElementById("userconfig-modal"),t=document.getElementById("config-save"),n=document.getElementById("config-close"),o=document.getElementById("openai-key-input"),s=document.getElementById("openai-model-select");o.value=yt(),s.value=$t(),t.addEventListener("click",()=>{jo(o.value),zo(s.value),Yo(),e.classList.add("hidden")}),n.addEventListener("click",()=>{o.value=yt(),s.value=$t(),e.classList.add("hidden")}),document.getElementById("key-not-set-ok").addEventListener("click",()=>{document.getElementById("openai-key-not-set-modal").classList.add("hidden")})}const Jo={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"};let Ut=!1,ae=!1,ce=!1;function Zo({getSequencers:e,onPlay:t,onStop:n,onPause:o,onResume:s,onDurationChange:i,onSnapChange:r,onToggleLoop:l,onTempoChange:a,onSave:d,onLoad:c,onMeasuresChange:u,onBeatsPerMeasureChange:f}){if(Ut)return;Ut=!0;const m=document.getElementById("play-button"),g=m.querySelector("use"),h=document.getElementById("stop-button"),p=document.getElementById("note-duration"),y=document.getElementById("dotted-note-btn"),E=document.getElementById("triplet-note-btn");p.value=String(U.currentDuration||1);const v=document.getElementById("snap-resolution");v.value=String(U.snapResolution||.25);const S=document.getElementById("loop-toggle"),w=document.getElementById("tempo-input"),L=document.getElementById("save-button"),k=document.getElementById("load-button"),C=document.getElementById("load-input"),I=document.getElementById("measures-input"),A=document.getElementById("beats-per-measure-input"),G=document.getElementById("config-button"),_=document.getElementById("export-modal"),K=document.getElementById("export-json"),me=document.getElementById("export-wav"),ne=document.getElementById("export-midi"),j=document.getElementById("export-cancel");g.setAttribute("href","#icon-play"),m.addEventListener("click",()=>{!ae&&!ce?(ae=!0,ce=!1,t==null||t(),g.setAttribute("href","#icon-pause")):ae?(ae=!1,ce=!0,o==null||o(),g.setAttribute("href","#icon-play")):ce&&(ae=!0,ce=!1,s==null||s(),g.setAttribute("href","#icon-pause"))}),h.addEventListener("click",()=>{n==null||n(),ae=!1,ce=!1,g.setAttribute("href","#icon-play")});const T={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125};window.addEventListener("keydown",B=>{var O;if(document.querySelector(".ai-modal:not(.hidden)"))return;const $=(O=document.activeElement)==null?void 0:O.tagName;if(!($==="INPUT"||$==="TEXTAREA")){if(B.code==="Space"){B.preventDefault(),m.click();return}if((B.metaKey||B.ctrlKey)&&(B.key==="z"&&uo(),B.key==="y"&&fo()),(B.metaKey||B.ctrlKey)&&B.key.toLowerCase()==="r"){B.preventDefault();return}if(un()===ee.NOTE_PLACEMENT){if(T.hasOwnProperty(B.code)){B.preventDefault();const Q=T[B.code];p.value=Q,p.dispatchEvent(new Event("change"))}if(B.key==="."){B.preventDefault(),y==null||y.click();return}if(B.key==="/"){B.preventDefault(),E==null||E.click();return}}}}),p.addEventListener("change",B=>{const N=parseFloat(B.target.value);z(N),i==null||i(N),e==null||e().forEach($=>{const O=$.grid;if(O!=null&&O.getPreviewNote){const Q=O.getPreviewNote();Q&&(Q.duration=N,O.scheduleRedraw())}})});function z(B){document.querySelectorAll(".note-duration-btn").forEach($=>{const O=parseFloat($.dataset.value);$.classList.remove("bg-purple-700"),$.classList.remove("bg-gray-800"),O===B?$.classList.add("bg-purple-700"):$.classList.add("bg-gray-800")})}v.addEventListener("change",B=>{const N=B.target.value;Jo.hasOwnProperty(N)&&(U.snapResolution=parseFloat(N),v.value=String(N),r==null||r(U.snapResolution))}),S.addEventListener("change",B=>{l==null||l(B.target.checked)}),w.addEventListener("change",B=>{const N=parseInt(B.target.value,10);isNaN(N)||a==null||a(N)}),L.addEventListener("click",()=>{_?_.classList.remove("hidden"):d==null||d("json")}),k.addEventListener("click",()=>{C.click()}),C.addEventListener("change",B=>{const N=B.target.files[0];N&&(c==null||c(N)),B.target.value=""}),K&&K.addEventListener("click",()=>{_.classList.add("hidden"),d==null||d("json")}),me&&me.addEventListener("click",()=>{_.classList.add("hidden"),d==null||d("wav")}),ne&&ne.addEventListener("click",()=>{_.classList.add("hidden"),d==null||d("midi")}),j&&j.addEventListener("click",()=>{_.classList.add("hidden")}),G.addEventListener("click",()=>{document.getElementById("userconfig-modal").classList.remove("hidden")}),Qo(),I.value=He(),A.value=Oe(),I.addEventListener("change",B=>{const N=parseInt(B.target.value,10);!isNaN(N)&&N>0&&(u==null||u(N))}),A.addEventListener("change",B=>{const N=parseInt(B.target.value,10);!isNaN(N)&&N>0&&(f==null||f(N))}),z(parseFloat(p.value))}function xo(){ae=!1,ce=!1;const t=document.getElementById("play-button").querySelector("use");t&&t.setAttribute("href","#icon-play")}function es(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function ts(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}let F=null,Ie=0;const it=new Map;async function re(){F||(F=await zt(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function bn(){return te}async function Je(e,t=te,n=null){await re();const[o,s]=e.includes("/")?e.split("/"):["musyngkite",e],i=t instanceof OfflineAudioContext;it.has(t)||it.set(t,new Map);const r=it.get(t),l=`${o}/${s}`;if(r.has(l))return r.get(l);let a;if(o==="smolken")a=new F.Smolken(t,{instrument:s,destination:n||Z,disableScheduler:i}),await pe(a.load);else if(o==="splendidgrandpiano")a=new F.SplendidGrandPiano(t,{destination:n||Z,disableScheduler:i}),await pe(a.load);else if(o==="electricpiano")a=new F.ElectricPiano(t,{instrument:s,destination:n||Z,disableScheduler:i}),await pe(a.load);else if(o==="mallets")a=new F.Mallet(t,{instrument:s,destination:n||Z,disableScheduler:i}),await pe(a.load);else if(o==="drummachines"){a=new F.DrumMachine(t,{instrument:s,destination:n||Z,disableScheduler:i}),await pe(a.load);const d=a.getSampleNames(),c=new Map;d.forEach((u,f)=>{const m=36+f;c.set(m,u)}),a.__midiMap=c}else{const c={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[o.toLowerCase()]||"MusyngKite",u=await cs();console.log(`[Soundfont] Available kits: ${u.join(", ")}`),console.log(`[Soundfont] Requested: kit=${c} instrument=${s}`);const m=`https://gleitz.github.io/midi-js-soundfonts/${c}/${s}-ogg.js`;a=new F.Soundfont(t,{instrument:s,instrumentUrl:m,kit:c,destination:n||Z,disableScheduler:i}),await pe(a.load)}return r.set(l,a),a}async function ns(){return await re(),F.getMalletNames()}async function os(){return await re(),F.getElectricPianoNames()}async function ss(){return await re(),["splendidgrandpiano"]}async function is(){return await re(),F.getDrumMachineNames()}async function rs(){return await re(),F.getSmolkenNames()}async function as(e="MusyngKite"){await re();const t=await F.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function cs(){return await re(),F.getSoundfontKits()}function ls(){Ie++,Ie===1&&es()}function ds(){Ie--,Ie<=0&&(Ie=0,ts())}async function pe(e){ls();try{await e}finally{ds()}}let oe=null,Et=null;async function Xt(e){if(Et===e)return;oe=await Je(e),Et=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function us(){return Et}function Sn(e,t=100,n=!1){var l;if(!oe)return null;const s=bn().currentTime,i=tt(e),r=((l=oe.__midiMap)==null?void 0:l.get(i))??i;return oe.start({note:r,stopId:r,velocity:t,time:s,loop:n}),()=>{oe.stop({stopId:r})}}function fs(e){var o;if(!oe)return;const t=tt(e),n=((o=oe.__midiMap)==null?void 0:o.get(t))??t;oe.stop({stopId:n})}async function ms(e,t,n,o=100,s=!1,i=null,r=null,l=null){var f;const a=r||bn(),d=await Je(e,a,l),c=tt(t),u=((f=d.__midiMap)==null?void 0:f.get(c))??c;return d.start({note:u,duration:n,velocity:o,loop:s,time:i??a.currentTime}),null}const te=new(window.AudioContext||window.webkitAudioContext),ot=te.createAnalyser();ot.fftSize=2048;const Z=te.createGain();Z.connect(ot);ot.connect(te.destination);function gs(e){te.resume();try{const t=Sn(e,100,20);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}te.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let Gt=!1,Xe=null;function ps(e,t){if(Gt)return;Gt=!0,Xe=t;const n=e.getContext("2d"),o=new Map,s=new Set;function i(c,u){const f=Xe();for(const m of Object.values(f))if(m.isBlack&&c>=m.x&&c<=m.x+m.width&&u>=0&&u<=m.height)return m.note;for(const m of Object.values(f))if(!m.isBlack&&c>=m.x&&c<=m.x+m.width&&u>=0&&u<=m.height)return m.note;return null}function r(c){if(!c||s.has(c))return;const u=gs(c);u&&(o.set(c,u),s.add(c),qe(n,Xe(),s))}function l(c){if(!s.has(c))return;const u=o.get(c);u&&(u.stop(),o.delete(c)),s.delete(c),qe(n,Xe(),s)}function a(){for(const c of s)l(c)}let d=!1;e.addEventListener("mousedown",c=>{d=!0;const u=e.getBoundingClientRect(),f=c.clientX-u.left,m=c.clientY-u.top,g=i(f,m);r(g)}),e.addEventListener("mousemove",c=>{if(!d)return;const u=e.getBoundingClientRect(),f=c.clientX-u.left,m=c.clientY-u.top,g=i(f,m);r(g)}),e.addEventListener("mouseup",()=>{d=!1,a()}),e.addEventListener("mouseleave",()=>{d=!1,a()})}const wn=[..."qwertyuiop[zxcvbnm,./"],Bn=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];let vt=!1,Ge=null,Te=null,Ae=null;function hs(e,t){if(vt)return;vt=!0;const n=e.getContext("2d"),o=new Set,s=new Set,i=new Map,r=wn,l=Bn;Ge=t;function a(){const u=Ge(),f=Object.values(u).filter(h=>!h.isBlack).sort((h,p)=>h.x-p.x).map(h=>h.note),m=Object.values(u).filter(h=>h.isBlack).sort((h,p)=>h.x-p.x).map(h=>h.note),g={};return r.forEach((h,p)=>{f[p]&&(g[h]=f[p])}),l.forEach((h,p)=>{m[p]&&(g[h]=m[p])}),g}function d(u){const f=a(),m=f[u];if(!(!m||o.has(u))){if(o.add(u),!s.has(m)){const g=Sn(m,100,vs());g&&(i.set(m,{stop:g}),s.add(m))}qe(n,Ge(),s,f)}}function c(u){const f=a(),m=f[u];m&&(o.delete(u),s.has(m)&&(fs(m),i.delete(m),s.delete(m)),qe(n,Ge(),s,f))}Te=u=>{u.repeat||d(u.key)},Ae=u=>{c(u.key)},window.addEventListener("keydown",Te),window.addEventListener("keyup",Ae)}function ys(){Te&&(window.removeEventListener("keydown",Te),Te=null),Ae&&(window.removeEventListener("keyup",Ae),Ae=null),vt=!1}let ye=3,he=Yt(ye),Ke=!1;async function Es(e){const t=e.getContext("2d");await Xt("fluidr3-gm/acoustic_grand_piano");const n=wn,o=Bn;function s(){const p=Object.values(he).filter(v=>!v.isBlack).sort((v,S)=>v.x-S.x).map(v=>v.note),y=Object.values(he).filter(v=>v.isBlack).sort((v,S)=>v.x-S.x).map(v=>v.note),E={};return n.forEach((v,S)=>{p[S]&&(E[v]=p[S])}),o.forEach((v,S)=>{y[S]&&(E[v]=y[S])}),E}function i(){he=Yt(ye);const p=Ke?s():null;qe(t,he,new Set,p)}ps(e,()=>he),i(),document.getElementById("octave-up").addEventListener("click",()=>{ye<7&&(ye++,i())}),document.getElementById("octave-down").addEventListener("click",()=>{ye>1&&(ye--,i())});const r=document.getElementById("disable-keyboard-inputs");r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700"),r.addEventListener("click",()=>{Ke=!Ke,Ke?(hs(e,()=>he),r.classList.remove("bg-gray-700"),r.classList.add("bg-purple-600")):(ys(),r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700")),i()});const l=document.getElementById("instrument-select-btn"),a=document.getElementById("instrument-select-modal"),d=document.getElementById("instrument-select"),c=document.getElementById("instrument-select-confirm"),u=document.getElementById("instrument-cancel-btn"),f=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([p,y])=>{const E=document.createElement("option");E.value=p,E.textContent=p.replace(/_/g," ").replace(/\b\w/g,v=>v.toUpperCase()),f.appendChild(E)}),f.addEventListener("change",async p=>{var S;const y=f.value,E=document.getElementById("instrument-select"),v=((S=p.detail)==null?void 0:S.preselect)||null;try{let w;y==="mallets"?w=await ns():y==="electricpiano"?w=await os():y==="splendidgrandpiano"?w=await ss():y==="drummachines"?w=await is():y==="smolken"?w=await rs():["fluidr3-gm","musyngkite","fatboy"].includes(y)?w=await as({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[y]):w=await(await fetch(`/static/${y}.json`)).json(),E.innerHTML="",w.forEach(L=>{const k=document.createElement("option");k.value=`${y}/${L}`,k.textContent=L.split("_").map(C=>C.charAt(0).toUpperCase()+C.slice(1)).join(" "),E.appendChild(k)}),E.value=v||`${y}/${w[0]}`}catch(w){console.error(`Failed to load instruments for library: ${y}`,w)}}),f.dispatchEvent(new Event("change")),l.addEventListener("click",async()=>{const p=us()||"fluidr3-gm/acoustic_grand_piano",[y,E]=p.split("/");f.value=y,await f.dispatchEvent(new CustomEvent("change",{detail:{preselect:p}})),a.classList.remove("hidden"),delete a.dataset.currentSequencer}),c.addEventListener("click",async()=>{const p=d.value;a.classList.add("hidden");const y=a.dataset.currentSequencer;if(y){console.log("[Modal] Looking up sequencer with id:",y);const E=Go(y);console.log("[Modal] Lookup result:",E),E&&E.setInstrument(p),a.dataset.currentSequencer=""}else try{await Xt(p)}catch(E){console.error("Failed to load global instrument:",p,E)}});let g=!1;const h=document.getElementById("instrument-loop-toggle");h.addEventListener("change",()=>{g=h.checked,console.log("[UI] Loop mode:",g)}),u.addEventListener("click",()=>{a.classList.add("hidden")})}function vs(){var e;return((e=document.getElementById("instrument-loop-toggle"))==null?void 0:e.checked)||!1}function bs(e,t){const n=t.getContext("2d"),o=t.width,s=t.height,i=new Uint8Array(e.fftSize),r=new Uint8Array(e.frequencyBinCount),l=document.createElement("canvas");l.width=o,l.height=s;const a=l.getContext("2d");let d="frequency";function c(){e.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,o,s),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const g=o/i.length;let h=0;for(let p=0;p<i.length;p++){const E=i[p]/128*s/2;p===0?n.moveTo(h,E):n.lineTo(h,E),h+=g}n.lineTo(o,s/2),n.stroke()}function u(){e.getByteFrequencyData(r),n.fillStyle="#000",n.fillRect(0,0,o,s),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,s),n.fillRect(o-1,0,1,s);const g=128,h=2,p=[];for(let y=0;y<g;y++)p.push(y*o/(g-1));p[p.length-1]=o-1;for(let y=0;y<g;y++){const E=p[y],v=y<g-1?p[y+1]:o,S=Math.max(1,v-E-h),w=20,L=2e4,k=y/(g-1),C=w*Math.pow(L/w,k),A=Math.min(r.length-1,Math.floor(C/22050*r.length)),G=r[A]/255,_=Math.max(1,G*s),K=240-k*240;n.fillStyle=`hsl(${K}, ${80+G*20}%, ${40+G*40}%)`,n.fillRect(E,s-_,S,_)}}function f(){e.getByteFrequencyData(r),l.initialized||(a.fillStyle="#000",a.fillRect(0,0,o,s),l.initialized=!0),a.drawImage(l,-1,0),a.fillStyle="#000",a.fillRect(o-1,0,1,s);const g=128,h=20,p=2e4;for(let y=0;y<g;y++){const E=y/(g-1),v=h*Math.pow(p/h,E),w=Math.min(r.length-1,Math.floor(v/22050*r.length)),L=r[w]/255,k=s-1-Math.floor(y*s/g);if(L<.05)continue;const C=Math.floor(L*255),I=Math.floor(L*(255-E*200)),A=Math.floor(L*(100+E*155));a.fillStyle=`rgb(${C}, ${I}, ${A})`,a.fillRect(o-1,k,1,1)}n.fillStyle="#000",n.fillRect(0,0,o,s),n.drawImage(l,0,0)}function m(){switch(requestAnimationFrame(m),d){case"frequency":u();break;case"spectrogram":f();break;case"waveform":default:c()}}return m(),{setMode(g){["waveform","frequency","spectrogram"].includes(g)&&(d=g,n.clearRect(0,0,o,s),d==="spectrogram"&&a.clearRect(0,0,o,s))}}}function Ss(e,t){const n=bs(ot,e),o=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let s=0;function i(){s=(s+1)%o.length;const{name:r,emoji:l}=o[s];n.setMode(r),t.textContent=l,t.title=`Mode: ${r}`}t.addEventListener("click",i),i()}function ws(e){if(!e.length)throw new Error("No tracks to export.");const t=ue(),n=Oe(),o=He(),s={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:o},i:e.map(r=>r.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.map(({notes:r})=>({n:r.map(l=>[l.pitch,l.start,l.duration])}))},i=new Blob([JSON.stringify(s)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function Bs(e){if(!e.length)return;const n=60/ue(),o=Math.max(...e.flatMap(c=>c.notes.map(u=>(u.start+u.duration)*n+.2))),s=44100,i=new OfflineAudioContext(2,Math.ceil(s*o),s);for(const c of e){const u=c.instrument||"fluidr3-gm/acoustic_grand_piano",f=new yn(null,c.config,i,i.destination,u);f.setState(c),await f.exportToOffline()}const r=await i.startRendering(),l=Ms(r),a=URL.createObjectURL(l),d=document.createElement("a");d.href=a,d.download=`session-${Date.now()}.wav`,d.click(),URL.revokeObjectURL(a)}function Ms(e){const t=e.numberOfChannels,n=e.length*t*2,o=new DataView(new ArrayBuffer(44+n)),s=(r,l)=>{for(let a=0;a<l.length;a++)o.setUint8(r+a,l.charCodeAt(a))};s(0,"RIFF"),o.setUint32(4,36+n,!0),s(8,"WAVE"),s(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,t,!0),o.setUint32(24,e.sampleRate,!0),o.setUint32(28,e.sampleRate*t*2,!0),o.setUint16(32,t*2,!0),o.setUint16(34,16,!0),s(36,"data"),o.setUint32(40,n,!0);let i=44;for(let r=0;r<e.length;r++)for(let l=0;l<t;l++){const a=e.getChannelData(l)[r],d=Math.max(-1,Math.min(1,a));o.setInt16(i,d*32767,!0),i+=2}return new Blob([o.buffer],{type:"audio/wav"})}function Ls(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),o=document.getElementById("triplet-note-btn");let s=!1,i=!1;function r(a){a=parseFloat(a);let d=a;s?d=a*1.5:i&&(d=a*(2/3));let c=Array.from(t.options).find(u=>Math.abs(parseFloat(u.value)-d)<1e-4);c||(c=new Option(d.toString(),d.toString()),t.add(c)),t.value=c.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(c=>c.classList.remove("bg-purple-600")),a.classList.add("bg-purple-600");const d=parseFloat(a.dataset.value);r(d)})}),n.addEventListener("click",()=>{i&&(i=!1,o.classList.remove("bg-purple-600")),s=!s,n.classList.toggle("bg-purple-600"),l()}),o.addEventListener("click",()=>{s&&(s=!1,n.classList.remove("bg-purple-600")),i=!i,o.classList.toggle("bg-purple-600"),U.isTripletMode=i,M.forEach(a=>{a.config.isTripletMode=i}),l()});function l(){const a=document.querySelector(".note-duration-btn.bg-purple-600");if(a){const d=parseFloat(a.dataset.value);r(d)}}r(U.currentDuration||1)}let J=null,Ze=null;function Cs(e){Ze=e,J=Ze.getContext("2d")}function ve(e){if(!J||!Ze)return;const{width:t,height:n}=Ze;J.clearRect(0,0,t,n);const o=Math.round(e)+.5;J.strokeStyle="#ff00ff",J.lineWidth=1,J.beginPath(),J.moveTo(o,0),J.lineTo(o,n),J.stroke()}let xe=!1,be=null,bt=!1;function Ns(e,t){be=e,be.addEventListener("mousedown",ks),window.addEventListener("mousemove",Is),window.addEventListener("mouseup",Ts)}function ks(e){an()&&(cn(),M.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),bt=!0),xe=!0,Mn(e)}function Is(e){xe&&Mn(e)}function Ts(){xe&&(xe=!1,bt&&(ln(),M.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),bt=!1))}function Mn(e){const t=be.getBoundingClientRect(),n=be.width/t.width;let o=(e.clientX-t.left)*n;o=Math.max(0,Math.min(be.width,o));const s=R(),i=o/be.width*s;se(i),ve(o)}const qt={maxBeatsContext:32,extendBeatsAmount:16};function Xs(){return qt.maxBeatsContext}function Gs(){return qt.extendBeatsAmount}function St(e,t,n,o){const s=R(),i=o/s*t;e.clearRect(0,0,t,n);const r=qt.maxBeatsContext,a=Math.max(0,o-r)/s*t,d=i-a;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(a,0,d,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke()}let Kt=!1;function Wt(){if(!Kt){Kt=!0;const o=document.getElementById("extend-use-tags"),s=document.getElementById("extend-tags");if(o&&s){let d=function(){const c=o.checked;s.disabled=!c,s.classList.toggle("opacity-50",!c),s.classList.toggle("cursor-not-allowed",!c)};d(),o.addEventListener("change",d)}const i=document.getElementById("extend-start-help-btn"),r=document.getElementById("extend-start-help-popup"),l=document.getElementById("extend-start-help-close");i&&r&&l&&(i.addEventListener("click",()=>r.classList.remove("hidden")),l.addEventListener("click",()=>r.classList.add("hidden")),document.addEventListener("click",d=>{!r.contains(d.target)&&d.target!==i&&r.classList.add("hidden")}));const a=document.querySelector("#ai-extend-modal .generate-btn");a&&a.addEventListener("click",async()=>{const{extendTracksWithAI:d}=await zt(async()=>{const{extendTracksWithAI:c}=await import("./extendTracks-CRjY8Y_2.js");return{extendTracksWithAI:c}},__vite__mapDeps([0,1]));await d()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",$e().forEach((s,i)=>{const r=`extend-track-${i}`,l=document.createElement("div");l.className="flex items-center gap-2";const a=document.createElement("input");a.type="checkbox",a.id=r,a.dataset.index=i,a.checked=!0,a.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const d=document.createElement("label");d.htmlFor=r,d.className="text-sm text-gray-200",d.textContent=s.config.name||`Track ${i+1}`,a.addEventListener("change",()=>{Ne()}),l.appendChild(a),l.appendChild(d),e.appendChild(l)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!0),Ne()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!1),Ne()}),Ne())}let rt=!1,Pe=0;function Ks(){return Pe}function As(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d"),o=e.clientWidth,s=e.clientHeight;e.width=o,e.height=s,t.width=o,t.height=s,Ne(),St(n,o,s,Pe),t.addEventListener("mousedown",r=>{rt=!0,i(r.offsetX)}),window.addEventListener("mouseup",()=>{rt=!1}),window.addEventListener("mousemove",r=>{if(!rt)return;const l=t.getBoundingClientRect();i(r.clientX-l.left)});function i(r){const l=R(),a=Math.max(0,Math.min(r,o));Pe=Math.round(a/o*l),St(n,o,s,Pe)}}function Ne(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead"),n=t.getContext("2d"),o=t.width,s=t.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),r=Array.from(i).filter(a=>a.checked).map(a=>parseInt(a.dataset.index,10)),l=$e().filter((a,d)=>r.includes(d));ie(e,l),St(n,o,s,Pe)}function Ps(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),o=document.getElementById("note-duration-controls"),s=document.getElementById("select-mode-controls"),i=document.getElementById("velocity-mode-controls");function r(a){[e,t,n].forEach(d=>{d.classList.remove("bg-purple-600"),d.classList.add("bg-gray-800")}),a.classList.remove("bg-gray-800"),a.classList.add("bg-purple-600")}function l(a){[o,s,i].forEach(d=>{d.classList.add("hidden")}),a.classList.remove("hidden")}e.addEventListener("click",()=>{r(e),l(o),W("note-placement")}),t.addEventListener("click",()=>{r(t),l(s),W("select")}),n.addEventListener("click",()=>{r(n),l(i),W("velocity")}),window.addEventListener("keydown",a=>{var u;const d=(u=document.activeElement)==null?void 0:u.tagName;if(!(d==="INPUT"||d==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(a.key){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),r(e),l(o),W("note-placement")}function qs(){const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),o=document.getElementById("ai-control-panel");function s(){document.querySelectorAll(".sequencer").forEach(f=>{const m=f.querySelector(".delete-btn"),g=f.querySelector(".collapse-btn"),h=g.querySelector("use");m.classList.add("button-locked"),g.classList.add("button-locked");const p=f.querySelector(".sequencer-body"),y=f.querySelector(".mini-contour");nt(f,!1),p.classList.contains("hidden")||(p.classList.add("hidden"),y.classList.remove("hidden"),h.setAttribute("href","#icon-caret-up"))})}function i(){document.querySelectorAll(".sequencer").forEach(f=>{const m=f.querySelector(".delete-btn"),g=f.querySelector(".collapse-btn");m.classList.remove("button-locked"),g.classList.remove("button-locked")})}function r(){e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),o.classList.add("hidden"),i()}function l(){if(!yt()){document.getElementById("openai-key-not-set-modal").classList.remove("hidden");return}t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),o.classList.remove("hidden"),s()}e.addEventListener("click",r),t.addEventListener("click",l);const a=document.getElementById("ai-inpaint-modal"),d=document.getElementById("ai-extend-modal"),c=document.getElementById("ai-generate-modal");function u(f){f.querySelector(".cancel-btn").addEventListener("click",()=>{f.classList.add("hidden")})}u(a),u(d),u(c),Wt(),document.getElementById("ai-inpaint-btn").addEventListener("click",()=>{a.classList.remove("hidden")}),document.getElementById("ai-extend-btn").addEventListener("click",()=>{d.classList.remove("hidden"),As(),Wt()}),document.getElementById("ai-generate-btn").addEventListener("click",()=>{c.classList.remove("hidden")}),Ps()}function Ln(){const e=Pt();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(q(Bt(t.sequencer.id,n),Mt(t.sequencer.id,n)),Me()&&(Be(),W(ee.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function Cn(){console.log("performCopy called");const e=Pt();if(!e)return;const t=e.getSelectedNotes();t.length!==0&&mn(t)}function Nn(){const e=Pt();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(mn(n),q(eo(t.sequencer.id,n),to(t.sequencer.id,n)),Me()&&(Be(),W(ee.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function kn(){if(console.log("performPaste called"),!pt().notes.length){console.log("No notes in clipboard");return}document.body.style.cursor="crosshair",Lo((t,n)=>{const o=t.gridContext,{x:s,y:i}=o.getCanvasPos(n),r=o.getSnappedBeatFromX(s),l=o.getPitchFromRow(Math.floor(i/o.getCellHeight())),a=P(l),{notes:d,anchorBeat:c,anchorMidi:u}=pt(),f=r-c,m=a-u,g=d.map(h=>({pitch:Re(P(h.pitch)+m),start:h.start+f,duration:h.duration}));q(oo(o.sequencer.id,g),so(o.sequencer.id,g)),Me()&&(Be(),W(ee.NOTE_PLACEMENT)),o.setSelectedNotes(g),document.body.style.cursor="default",kt()})}function _s(){document.addEventListener("keydown",e=>{var s;const n=navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey,o=(s=document.activeElement)==null?void 0:s.tagName;if(!(o==="INPUT"||o==="TEXTAREA"))switch(!0){case(n&&e.key==="c"):e.preventDefault(),Cn();break;case(n&&e.key==="x"):e.preventDefault(),Nn();break;case(n&&e.key==="v"):e.preventDefault(),kn();break;case e.key==="Delete":e.preventDefault(),Ln();break}})}function Rs(){const e=document.querySelector(".select-mode-copy");e&&(e.onclick=Cn);const t=document.querySelector(".select-mode-cut");t&&(t.onclick=Nn);const n=document.querySelector(".select-mode-paste");n&&(n.onclick=kn);const o=document.querySelector(".select-mode-delete");o&&(o.onclick=Ln),_s()}function Ds(e=Fe()){ut(e.tempo,!1),ft(e.timeSignature[0],!1),mt(e.totalMeasures,!1);for(const n of e.sequencers){let o=M.find(r=>r.id===n.id);if(!o){const{wrapper:r}=vn({id:n.id,instrument:n.instrument,config:{...n.config},notes:n.notes}),l=r.querySelector(".sequencer");l&&nt(l,!0)}o.config.instrument=n.instrument;const s=o.container.querySelector("canvas.mini-contour");s&&_e(s,o.notes,o.config,o.colorIndex);const i=o.grid.gridContext;i.setSelectedNotes([]),i.notes.length=0,i.notes.push(...structuredClone(n.notes)),o.grid.scheduleRedraw()}const t=document.getElementById("global-mini-contour");t&&ie(t,M)}co(Ds);function In(){ie(Fs,M)}const Fs=document.getElementById("global-mini-contour"),_t=document.getElementById("global-mini-playhead");Cs(_t);Ns(_t);ve(0);const Os=document.getElementById("piano");Es(Os);const Hs=document.getElementById("waveform");Ss(Hs,document.getElementById("visualizer-mode"));const jt=0,$s="fluidr3-gm/acoustic_grand_piano";q(xt(jt,$s),wt(jt));q(Ct("Initial App State"),tn("Initial App State"));Rs();In();Wo();Ls();qs();Zo({getSequencers:()=>M,onPlay:()=>{Ve();const e=R(),t=Ye();ho(ue(),{loop:U.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{M.forEach(n=>{var o;return(o=n.onTransportLoop)==null?void 0:o.call(n)})}}),dt(n=>{const o=n/e*_t.width;ve(o)}),M.forEach(n=>n.play()),po(()=>{xo(),se(0),ve(0)})},onPause:()=>{cn(),M.forEach(e=>e.pause())},onResume:()=>{ln(),M.forEach(e=>e.resume())},onStop:()=>{Ve(),se(0),M.forEach(e=>e.stop()),ve(0)},onDurationChange:e=>{U.currentDuration=e,M.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{U.snapResolution=e,M.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{U.loopEnabled=e,M.forEach(t=>t.config.loopEnabled=e)},onTempoChange:ut,onSave:async e=>{const t=M.map(n=>n.getState());if(e==="json"){const{url:n,filename:o}=ws(t),s=document.createElement("a");s.href=n,s.download=o,s.click(),URL.revokeObjectURL(n)}else e==="wav"?await Bs(t):e==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async e=>{try{const{tracks:t,globalConfig:n}=await $o(e);ut(n.bpm),ft(n.beatsPerMeasure),mt(n.totalMeasures);const o=document.getElementById("tempo-input");o&&(o.value=ue());const s=document.getElementById("measures-input");s&&(s.value=He()),Ko();for(const[i,r]of t.entries()){const l=i,a=r.instrument||"fluidr3-gm/acoustic_grand_piano",d=r.notes||[];q({type:"CREATE_SEQUENCER",id:l,instrument:a,notes:structuredClone(d),config:r.config||{}},wt(l))}q(Ct("Session Loaded"),tn("Session Loaded")),Mo(),In(),se(0),ve(0)}catch(t){alert("Failed to load file: "+t.message)}},onMeasuresChange:e=>{mt(e);const t=document.getElementById("global-mini-contour");t&&ie(t,M)},onBeatsPerMeasureChange:e=>{ft(e);const t=document.getElementById("global-mini-contour");t&&ie(t,M)}});const Ws=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{$t as a,$e as b,Ks as c,Xs as d,Gs as e,Oe as f,yt as g,_e as h,ie as i,Ws as m,mt as u};
