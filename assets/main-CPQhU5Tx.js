const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-BZL-TZTO.js","assets/index-B7lCMpVG.js"])))=>i.map(i=>d[i]);
import{_ as Bt}from"./index-B7lCMpVG.js";function Mt(e=3){const i=["C","D","E","F","G","A","B"],a=["C#","D#","","F#","G#","A#",""],l=[e,e+1,e+2],r={};let c=0;for(const f of l)i.forEach(u=>{const m=`${u}${f}`;r[m]={note:m,x:c,width:60,height:200,isBlack:!1},c+=60});c=0;for(const f of l)a.forEach((u,m)=>{if(u===""){c+=60;return}const d=`${u}${f}`;r[d]={note:d,x:c+60-40/2,width:40,height:120,isBlack:!0},c+=60});return r}function Be(e,t,n=new Set,s=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const o={};if(s)for(const[i,a]of Object.entries(s))o[a]=i;for(const i of Object.values(t))i.isBlack||(dt(e,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",o[i.note]&&(e.fillStyle="#7c3aed",e.fillText(o[i.note],i.x+i.width/2,i.height-24),e.fillStyle="#333"),e.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(t))i.isBlack&&(dt(e,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),$t(e,i),o[i.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(o[i.note],i.x+i.width/2,i.height-28)))}function dt(e,{x:t,width:n,height:s,fill:o,stroke:i,radius:a=8}){e.beginPath(),e.moveTo(t,0),e.lineTo(t,s-a),e.quadraticCurveTo(t,s,t+a,s),e.lineTo(t+n-a,s),e.quadraticCurveTo(t+n,s,t+n,s-a),e.lineTo(t+n,0),e.closePath(),e.fillStyle=o,e.fill(),e.strokeStyle=i,e.lineWidth=1,e.stroke()}function $t(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}const oe=64,Xt={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"};function F(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,s]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(s,10)}function Wt(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function Kt(e){return e.replace(/\d+$/,"")}function Ke(e){return e.includes("#")}function Gt(e,t){return e/t()}function Ut(e,t){let n=t.snapResolution||.25,s=t.isTripletMode?n*(2/3):n;return Math.round(e/s)*s}function jt(e,t,n){const s=Gt(e,n);return Ut(s,t)}function St(e,t,n,s,o,i=4){e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+s-i,n),e.quadraticCurveTo(t+s,n,t+s,n+i),e.lineTo(t+s,n+o-i),e.quadraticCurveTo(t+s,n+o,t+s-i,n+o),e.lineTo(t+i,n+o),e.quadraticCurveTo(t,n+o,t,n+o-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}function _(e){return e.totalMeasures*e.beatsPerMeasure}function R(e){const t=e.match(/^([A-G]#?)(\d)$/);if(!t)return null;const[n,s,o]=t;return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[s]+12*parseInt(o,10)}function Ae(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function Yt(e,t,n,s,o,i){const{totalMeasures:a,beatsPerMeasure:l}=t,r=_(t)*s;for(let d=0;d<n;d++){const h=d*o,p=i(d);e.fillStyle=Ke(p)?"rgb(174,173,175)":"#fefefe",e.fillRect(0,h,r,o),e.fillStyle=Ke(p)?"#a088b0":"#dddddd",e.fillRect(-64,h,oe,o)}e.font=`${Math.floor(o*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let d=0;d<n;d++){const h=d*o,p=i(d);e.fillStyle=Ke(p)?"#800080":"#444",e.fillText(p,-8,h+o/2)}e.strokeStyle="#ddd",e.lineWidth=1;for(let d=0;d<n;d++){const h=d*o;e.beginPath(),e.moveTo(0,h),e.lineTo(r,h),e.stroke()}const c=n*o;e.beginPath(),e.moveTo(0,c),e.lineTo(r,c),e.stroke();const f=n*o,u=a*l;for(let d=0;d<=u;d++){const h=d*s,p=d%l===0;e.strokeStyle=p?"#bbb":"#eee",e.lineWidth=p?2:1,e.beginPath(),e.moveTo(h,0),e.lineTo(h,f),e.stroke()}const m=a*l*s;e.strokeStyle="#bbb",e.lineWidth=2,e.beginPath(),e.moveTo(m,0),e.lineTo(m,f),e.stroke()}function zt(e,t,{previewNotes:n=null,hoveredNote:s,selectedNote:o,selectedNotes:i=[],highlightedNotes:a=[],cellWidth:l,cellHeight:r,visibleStartBeat:c,visibleEndBeat:f,getPitchRow:u,getPitchClass:m,PITCH_COLOR_MAP:d,drawRoundedRect:h}){for(const g of t){if(g.start+g.duration<c-2||g.start>f)continue;const y=g.start*l,b=u(g.pitch)*r,v=g.duration*l,B=r-1,w=d[m(g.pitch)]||"#999";e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,a.includes(g)?e.fillStyle="rgba(96, 165, 250, 0.6)":e.fillStyle=w,h(e,y,b,v,B),e.fill();const S=e.createLinearGradient(y,b,y,b+B);S.addColorStop(0,"rgba(255,255,255,0.4)"),S.addColorStop(.2,"rgba(255,255,255,0.15)"),S.addColorStop(.5,"rgba(255,255,255,0.05)"),S.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=S,h(e,y,b,v,B),e.fill();const I=i.includes(g),C=g===s,P=a.includes(g);(I||C||P)&&(e.lineWidth=2,I?e.strokeStyle="rgba(59, 130, 246, 1.0)":C?e.strokeStyle="rgba(0, 0, 0, 0.8)":P&&(e.strokeStyle="rgba(96, 165, 250, 0.6)"),h(e,y,b,v,B),e.stroke())}if(n)for(const g of n){const y=g.start*l,b=u(g.pitch)*r,v=g.duration*l,B=r-1,w=d[m(g.pitch)]||"#999";e.fillStyle=Jt(w,.4),h(e,y,b,v,B),e.fill()}}function Jt(e,t){const n=parseInt(e.slice(1),16);return`rgba(${n>>16&255}, ${n>>8&255}, ${n&255}, ${t})`}function Vt(e,t,n,s){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+n,0),e.lineTo(t+n,s),e.stroke(),e.restore()}function Zt(e,t,n,s=oe){const o=e.getBoundingClientRect(),i=parseFloat(e.style.width||o.width),a=parseFloat(e.style.height||o.height),l=e.width/i,r=e.height/a,c=(t.clientX-o.left)*l-s,f=(t.clientY-o.top)*r;return{x:c,y:f}}function Qt(e,t,n,s,o,i){const a=Math.floor(t/o),l=e/i;return n.find(r=>l>=r.start&&l<r.start+r.duration&&s(r.pitch)===a)}const Re=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function ut(e,t,n,s=0){const o=e.getContext("2d"),i=e.width,a=e.height;o.clearRect(0,0,i,a);const l=Re[s%Re.length];o.fillStyle=l;const r=_(n),c=F(n.noteRange[0]),u=F(n.noteRange[1])-c||1,m=Math.max(2,a/u);for(const d of t){const h=d.start/r*i,p=Math.max(1,d.duration/r*i),y=(F(d.pitch)-c)/u,b=a-y*a-m/2;o.fillRect(h,b,p,m)}}function me(e,t){const n=e.getContext("2d"),s=e.width,o=e.height;n.clearRect(0,0,s,o),t.forEach((i,a)=>{const l=i.notes,r=i.config;if(!(l!=null&&l.length))return;const c=_(r),f=Re[a%Re.length];n.fillStyle=f;const u=F(r.noteRange[0]),d=F(r.noteRange[1])-u||1,h=Math.max(2,o/d);for(const p of l){const g=p.start/c*s,y=Math.max(1,p.duration/c*s),v=(F(p.pitch)-u)/d,B=o-v*o-h/2;n.fillRect(g,B,y,h)}})}function xt(e,t,n,s){const o=e.querySelector(".zoom-in-btn"),i=e.querySelector(".zoom-out-btn"),a=e.querySelector(".zoom-reset-btn");!o||!i||!a||(o.addEventListener("click",t),i.addEventListener("click",n),a.addEventListener("click",s))}function ft(e){let t=null,n=null;function s(c){var g,y;const{x:f,y:u}=e.getCanvasPos(c);if(f<0){const b=e.getPitchFromRow(Math.floor(u/e.getCellHeight()));e.sequencer.playNote(b,.5);return}const m=e.findNoteAt(f,u);if(m){e.setSelectedNote(m),e.scheduleRedraw(),(g=e.onNotesChanged)==null||g.call(e);return}const d=e.getSnappedBeatFromX(f),h=e.getPitchFromRow(Math.floor(u/e.getCellHeight())),p=_(e.config);d+e.config.currentDuration>p||(e.sequencer.playNote(h,.5),e.notes.push({pitch:h,start:d,duration:e.config.currentDuration}),e.scheduleRedraw(),(y=e.onNotesChanged)==null||y.call(e))}function o(c){var d;c.preventDefault();const{x:f,y:u}=e.getCanvasPos(c),m=e.findNoteAt(f,u);if(m){const h=e.notes.indexOf(m);h!==-1&&e.notes.splice(h,1),e.scheduleRedraw(),(d=e.onNotesChanged)==null||d.call(e)}}function i(c){var h;const{x:f,y:u}=e.getCanvasPos(c);if(f<0){e.clearPreview();return}const m=e.findNoteAt(f,u);e.setHoveredNote(m);const d=e.getSelectedNote();if(!t&&d&&d!==m&&e.setSelectedNote(null),!m&&!t){const p=e.getSnappedBeatFromX(f),g=e.getPitchFromRow(Math.floor(u/e.getCellHeight())),y=_(e.config);p+e.config.currentDuration<=y?e.updatePreview({pitch:g,start:p,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&d){const p=f-t.startX,g=e.getSnappedBeatFromX(p)-e.getSnappedBeatFromX(0),y=Math.max(0,t.initialStart+g),b=_(e.config);y+d.duration<=b&&(d.start=y);const v=u-t.startY,B=Math.round(v/e.getCellHeight()),w=t.initialMidi-B,S=R(e.config.noteRange[0]),I=R(e.config.noteRange[1]),C=Math.max(S,Math.min(I,w)),P=Ae(C);P!==d.pitch&&(d.pitch=P,n!==P&&(n=P,e.sequencer.playNote(P,.5))),e.scheduleRedraw(),(h=e.onNotesChanged)==null||h.call(e);return}e.scheduleRedraw()}function a(){e.clearPreview(),e.setHoveredNote(null),e.scheduleRedraw()}function l(c){const{x:f,y:u}=e.getCanvasPos(c),m=e.findNoteAt(f,u);m&&(e.setSelectedNote(m),t={startX:f,startY:u,initialStart:m.start,initialMidi:R(m.pitch)})}function r(){t=null}return{attach(c){c.addEventListener("click",s),c.addEventListener("contextmenu",o),c.addEventListener("mousemove",i),c.addEventListener("mouseleave",a),c.addEventListener("mousedown",l),c.addEventListener("mouseup",r)},detach(c){c.removeEventListener("click",s),c.removeEventListener("contextmenu",o),c.removeEventListener("mousemove",i),c.removeEventListener("mouseleave",a),c.removeEventListener("mousedown",l),c.removeEventListener("mouseup",r)}}}let ce=null;function en(e){ce&&ce!==e&&ce.clearSelection(),ce=e}function tn(){ce=null}function Le(){return ce}let $e=!1,qe=null,H=null;function nn(e){$e=!0,qe=e,H=null}function nt(){var e;H&&(H.gridContext.setPastePreviewNotes(null),H.scheduleRedraw(),(e=H.setCursor)==null||e.call(H,"default")),$e=!1,qe=null,H=null,document.body.style.cursor="default"}function Ge(){return $e}function on(e,t){!$e||!qe||(qe(e,t),nt())}function sn(e){H&&H!==e&&(H.gridContext.setPastePreviewNotes(null),H.scheduleRedraw()),H=e}let Lt={notes:[],anchorBeat:0,anchorMidi:0};function mt(e){if(e.length===0)return;const t=e[0],n=t.start,s=R(t.pitch);Lt={notes:e.map(o=>({pitch:o.pitch,start:o.start,duration:o.duration})),anchorBeat:n,anchorMidi:s}}function kt(){return Lt}function ht(e){let t=null;function n(l){var m;l.preventDefault();const{x:r,y:c}=e.getCanvasPos(l),f=e.findNoteAt(r,c);if(!f)return;const u=e.getSelectedNotes();if(u.includes(f)){for(const d of u){const h=e.notes.indexOf(d);h!==-1&&e.notes.splice(h,1)}e.setSelectedNotes([])}else{const d=e.notes.indexOf(f);d!==-1&&e.notes.splice(d,1)}e.scheduleRedraw(),(m=e.onNotesChanged)==null||m.call(e)}function s(l){if(Ge()){on(e.grid,l),l.preventDefault(),l.stopPropagation();return}const{x:r,y:c}=e.getCanvasPos(l);if(r<0)return;const f=e.findNoteAt(r,c);e.setHoveredNote(f),en(e.grid);const u=e.getSelectedNotes();if(f&&u.includes(f)){t={startX:r,startY:c,anchorNote:f,initialNotes:u.map(m=>({note:m,start:m.start,midi:R(m.pitch)}))};return}e.selectionBox={active:!0,startX:r,startY:c,currentX:r,currentY:c},e.clearPreview(),e.setSelectedNote(null)}function o(l){var u,m;sn(e.grid);const{x:r,y:c}=e.getCanvasPos(l),f=e.findNoteAt(r,c);if(e.setHoveredNote(f),Ge()){const{notes:d,anchorBeat:h,anchorMidi:p}=kt(),g=e.getSnappedBeatFromX(r),y=e.getPitchFromRow(Math.floor(c/e.getCellHeight())),b=R(y),v=g-h,B=b-p,w=d.map(S=>({pitch:Ae(R(S.pitch)+B),start:S.start+v,duration:S.duration}));e.setPastePreviewNotes(w),e.scheduleRedraw();return}else e.setPastePreviewNotes(null);if((u=e.selectionBox)!=null&&u.active){e.selectionBox.currentX=r,e.selectionBox.currentY=c;const d=e.selectionBox,h=Math.min(d.startX,d.currentX),p=Math.min(d.startY,d.currentY),g=Math.max(d.startX,d.currentX),y=Math.max(d.startY,d.currentY),b=Math.floor(p/e.getCellHeight()),v=Math.floor(y/e.getCellHeight()),B=e.getSnappedBeatFromX(h),w=e.getSnappedBeatFromX(g),S=R(e.getPitchFromRow(b)),I=R(e.getPitchFromRow(v)),C=e.notes.filter(P=>{const A=R(P.pitch),W=P.start,q=P.start+P.duration,U=W>=B&&q<=w,x=A>=I&&A<=S;return U&&x});e.setHighlightedNotes(C),e.scheduleRedraw();return}if(t){const d=r-t.startX,h=e.getSnappedBeatFromX(d)-e.getSnappedBeatFromX(0),p=c-t.startY,g=Math.round(p/e.getCellHeight()),y=_(e.config),b=R(e.config.noteRange[0]),v=R(e.config.noteRange[1]);for(const{note:w,start:S,midi:I}of t.initialNotes){const C=Math.max(0,S+h),P=Math.max(b,Math.min(v,I-g)),A=Ae(P);C+w.duration<=y&&(w.start=C,w.pitch=A)}const B=t.initialNotes.find(w=>w.note===t.anchorNote);if(B){const w=B.note.pitch;t.lastPreviewPitch!==w&&(t.lastPreviewPitch=w,e.sequencer.playNote(w,.5))}e.scheduleRedraw(),(m=e.onNotesChanged)==null||m.call(e)}}function i(l){var r;if(t=null,(r=e.selectionBox)!=null&&r.active){const{x:c,y:f}=e.getCanvasPos(l);e.selectionBox.currentX=c,e.selectionBox.currentY=f,e.selectionBox.active=!1;const u=e.selectionBox,m=Math.min(u.startX,u.currentX),d=Math.min(u.startY,u.currentY),h=Math.max(u.startX,u.currentX),p=Math.max(u.startY,u.currentY),g=Math.floor(d/e.getCellHeight()),y=Math.floor(p/e.getCellHeight()),b=e.getSnappedBeatFromX(m),v=e.getSnappedBeatFromX(h),B=R(e.getPitchFromRow(g)),w=R(e.getPitchFromRow(y)),S=e.notes.filter(I=>{const C=R(I.pitch),P=I.start,A=I.start+I.duration,W=P>=b&&A<=v,q=C>=w&&C<=B;return W&&q});e.setHighlightedNotes([]),e.setSelectedNotes(S),e.scheduleRedraw()}}function a(){e.setHoveredNote(null),e.setHighlightedNotes([]),Ge()&&e.setPastePreviewNotes(null),e.scheduleRedraw()}return{attach(l){l.addEventListener("mousedown",s),l.addEventListener("mousemove",o),l.addEventListener("mouseup",i),l.addEventListener("mouseleave",a),l.addEventListener("contextmenu",n)},detach(l){l.removeEventListener("mousedown",s),l.removeEventListener("mousemove",o),l.removeEventListener("mouseup",i),l.removeEventListener("mouseleave",a),l.removeEventListener("contextmenu",n)}}}const ot={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let It=ot.NOTE_PLACEMENT;const Ye=new Set;function st(){return It}function ke(e){nt(),It=e;for(const t of Ye)t(e)}function an(e){return Ye.add(e),()=>Ye.delete(e)}function rn(e,t){const n=t.selectionBox;if(!n)return;const s=n.startX,o=n.startY,i=n.currentX,a=n.currentY,l=Math.min(s,i),r=Math.min(o,a),c=Math.abs(i-s),f=Math.abs(a-o);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),St(e,l,r,c,f,3),e.stroke(),e.restore()}function ln(e,t,n,s,o,i){let a=null,l=null,r=null,c=null;const f=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:50,cellHeight:25},{cellWidth:60,cellHeight:30}];let u=2;const m=e.getContext("2d"),d=t.getContext("2d");let h=f[u].cellWidth,p=f[u].cellHeight;const g=F(o.noteRange[1])-F(o.noteRange[0])+1,y=g*p,v=_(o)*h+oe;e.width=v,e.height=y,e.style.width=`${v}px`,e.style.height=`${y}px`,t.width=v,t.height=y,t.style.width=`${v}px`,t.style.height=`${y}px`;let B=null;function w(){B!==null&&cancelAnimationFrame(B),B=requestAnimationFrame(S)}function S(){var E;m.clearRect(0,0,e.width,e.height),m.save(),m.translate(oe,0),Yt(m,o,g,h,p,x),zt(m,s,{previewNotes:l??(a?[a]:null),hoveredNote:r,selectedNote:c,selectedNotes:K,highlightedNotes:T.getHighlightedNotes(),cellWidth:h,cellHeight:p,visibleStartBeat:0,visibleEndBeat:e.width/h,getPitchRow:U,getPitchClass:Kt,PITCH_COLOR_MAP:Xt,drawRoundedRect:St}),(E=T.selectionBox)!=null&&E.active&&rn(m,T),m.restore()}function I(){u<f.length-1&&(u++,A())}function C(){u>0&&(u--,A())}function P(){u=2,A()}function A(){const E=f[u];h=E.cellWidth,p=E.cellHeight,W()}function W(){const G=_(o)*h+oe,ie=(F(o.noteRange[1])-F(o.noteRange[0])+1)*p;e.width=G,e.height=ie,e.style.width=`${G}px`,e.style.height=`${ie}px`,t.width=G,t.height=ie,t.style.width=`${G}px`,t.style.height=`${ie}px`,w()}function q(E){Vt(d,E,oe,e.height)}xt(i.container,I,C,P);function U(E){return F(o.noteRange[1])-F(E)}function x(E){const he=F(o.noteRange[1])-E,ie=Math.max(F(o.noteRange[0]),Math.min(F(o.noteRange[1]),he));return Wt(ie)}function Me(){const E=document.getElementById("global-mini-contour");E&&me(E,k)}let J=null,K=[];const T={sequencer:i,grid:null,config:o,notes:s,getCellHeight:()=>p,getCanvasPos:E=>Zt(e,E,n,oe),findNoteAt:(E,G)=>Qt(E,G,s,U,p,h),scheduleRedraw:w,getPitchFromRow:x,getSnappedBeatFromX:E=>jt(E,o,()=>h),updatePreview:E=>a=E,clearPreview:()=>a=null,getSelectedNote:()=>c,setSelectedNote:E=>{c=E,K=E?[E]:[]},getSelectedNotes:()=>K,setSelectedNotes:E=>{K=E,c=E.length===1?E[0]:null},setHoveredNote:E=>r=E,onNotesChanged:Me};function M(E){J&&J.detach(e),J=E,J&&J.attach(e)}function N(){c=null,K=[],r=null,Se=[],w()}const O=st();M(O==="note-placement"?ft(T):O==="select"?ht(T):null);let $=an(E=>{var G,he;a=null,l=null,Se=[],(G=T.clearPreview)==null||G.call(T),(he=T.setPastePreviewNotes)==null||he.call(T,null),T.selectionBox&&(T.selectionBox.active=!1,T.selectionBox=null),N(),M(E==="note-placement"?ft(T):E==="select"?ht(T):null),w()});const ee={canvas:e,scheduleRedraw:w,drawPlayhead:q,getSelectedNote:()=>c,clearSelection:N,getPreviewNote:()=>a,zoomIn:I,zoomOut:C,getXForBeat:E=>E*h,setMouseHandler:M,setCursor:E=>{e.style.cursor=E},gridContext:T,getSelectedNotes:()=>K,setSelectedNotes:E=>{K=E,c=E.length===1?E[0]:null},destroy(){$(),tn()}};T.setPastePreviewNotes=E=>{l=E};let Se=[];return T.getHighlightedNotes=()=>Se,T.setHighlightedNotes=E=>{Se=E},T.grid=ee,ee}let X=null,ye=500,Pe=null,ze=!1,Je=1/0,fe=[],Te=null,Nt=0;function Ve(e){return fe.push(e),()=>{const t=fe.indexOf(e);t!==-1&&fe.splice(t,1)}}function cn(){fe=[]}function Z(e){Nt=e}function Fe(){return Nt}function dn(e){Te=e}function un(e,t={}){ye=60/e*1e3,ze=t.loop??!1,Je=t.endBeat??1/0;const n=t.startBeat??0;Pe=performance.now()-n*ye;const s=t.onLoop;function o(i){const l=(i-Pe)/ye;if(Z(l),fe.forEach(r=>r(l)),l>=Je)if(ze)Pe=performance.now(),Z(0),s&&s();else{_e();return}X=requestAnimationFrame(o)}X=requestAnimationFrame(o)}function _e(){X&&cancelAnimationFrame(X),X=null,cn(),Te&&(Te(),Te=null)}function fn(){return X!==null}function Ct(){X&&cancelAnimationFrame(X),X=null}function Pt(){if(X)return;const e=performance.now()-Fe()*ye;function t(n){const o=(n-e)/ye;if(Z(o),fe.forEach(i=>i(o)),o>=Je)if(ze)Pe=performance.now(),Z(0);else{_e();return}X=requestAnimationFrame(t)}X=requestAnimationFrame(t)}const mn={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function Xe(e){const t=e.match(/^([A-Ga-g][#b]?)(-?\d+)$/);if(!t)return null;const[,n,s]=t,o=n.toUpperCase(),i=mn[o];return i===void 0?null:12*(parseInt(s,10)+1)+i}class Tt{constructor(t,n,s=z,o=Y,i="fluidr3-gm/acoustic_grand_piano"){this.container=t,this.config={...n},this.context=s,this.destination=o,this.instrumentName=i,this.notes=[],this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.isMuted=!1,this.isSoloed=!1,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this._initCanvases())}async initInstrument(){try{await De(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){const t=this.container.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument(),console.log(`[SEQ:${this.id}] Instrument set to:`,t)}playNote(t,n,s=100,o=!1){return Wn(this.instrumentName,t,n,s,o)}_initCanvases(){const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),s=this.container.querySelector("#grid-scroll-container");this.grid=ln(t,n,s,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(t){this.config.totalMeasures=t;const n=_(this.config);this.clampNotesToGrid();const s=n*this.config.cellWidth+(this.config.labelWidth||64),o=this.container.querySelector("canvas.note-grid"),i=this.container.querySelector(".playhead-canvas");o&&(o.width=s,o.style.width=`${s}px`),i&&(i.width=s,i.style.width=`${s}px`),this.redraw()}clampNotesToGrid(){const t=_(this.config),n=this.notes.filter(s=>s.start<t);n.forEach(s=>{s.start+s.duration>t&&(s.duration=t-s.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear();const n=60/this.config.bpm;this._beatHandler=s=>{var o;if((o=this.grid)==null||o.drawPlayhead(this.grid.getXForBeat(s)),!!this.shouldPlay)for(const i of this.notes){const a=i.start,l=i.start+i.duration;if(!this._activeNotes.has(i)&&a<=s&&s<=l){const r=i.duration*n;this.playNote(i.pitch,r),this._activeNotes.add(i)}}},this._unsub=Ve(this._beatHandler),this._beatHandler(0)}stop(){var t,n,s;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const o of this._activeNotes){const i=this._noteHandlers.get(o);(t=i==null?void 0:i.forceStop)==null||t.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(s=this.grid)==null||s.drawPlayhead(null),this.redraw()}pause(){var t;for(const n of this._activeNotes){const s=this._noteHandlers.get(n);(t=s==null?void 0:s.stop)==null||t.call(s)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=Ve(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.isMuted=!this.isMuted,this.isMuted&&(this.isSoloed=!1),this.updateTrackStyle()}toggleSolo(){this.isSoloed=!this.isSoloed,this.isSoloed&&(this.isMuted=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t.classList.toggle("bg-red-600",this.isMuted),t.classList.toggle("bg-gray-700",!this.isMuted),n.classList.toggle("bg-yellow-200",this.isSoloed),n.classList.toggle("bg-gray-700",!this.isSoloed),this.container.classList.toggle("opacity-40",this.isMuted&&!this.isSoloed),this.container.classList.toggle("opacity-100",!(this.isMuted&&!this.isSoloed))}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,s,o])=>({pitch:n,start:s,duration:o})))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:s}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),s&&(this.instrumentName=s),this.redraw()}async exportToOffline(){const t=60/this.config.bpm,n=await De(this.instrumentName,this.context,this.destination);for(const s of this.notes){const o=s.start*t,i=s.duration*t;n.start({note:Xe(s.pitch),duration:i,velocity:100,time:o,loop:!1})}}}async function hn(e){var i,a,l,r,c,f,u;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!n||!Array.isArray(n.notes))throw new Error("JSON file missing required `notes` array.");const s=n.notes.map(m=>({pitch:m.pitch,start:m.start,duration:m.duration})),o={bpm:((i=n.config)==null?void 0:i.bpm)??120,snapResolution:((a=n.config)==null?void 0:a.snapResolution)??.125,currentDuration:((l=n.config)==null?void 0:l.currentDuration)??.25,noteRange:((r=n.config)==null?void 0:r.noteRange)??["C3","B5"],totalBeats:((c=n.config)==null?void 0:c.totalBeats)??100,beatsPerMeasure:((f=n.config)==null?void 0:f.beatsPerMeasure)??4,totalMeasures:((u=n.config)==null?void 0:u.totalMeasures)??8};return[{notes:s,config:o}]}async function gn(e){var l,r,c;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const s=((l=n.c)==null?void 0:l.b)??120,o=((r=n.c)==null?void 0:r.bpm)??4,i=((c=n.c)==null?void 0:c.tm)??8,a=Array.isArray(n.i)?n.i:[];return n.tr.map((f,u)=>{if(!Array.isArray(f.n))throw new Error("Track missing `n` (notes) array.");const m=f.n.map(([p,g,y])=>({pitch:p,start:g,duration:y})),d={bpm:s,beatsPerMeasure:o,totalMeasures:i},h=a[u]||"fluidr3-gm/acoustic_grand_piano";return{notes:m,config:d,instrument:h}})}const L={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,bpm:220,loopEnabled:!1,useEqualTemperament:!0,beatsPerMeasure:4,totalMeasures:8},k=[],pn=document.getElementById("sequencers-container"),yn=document.getElementById("sequencer-template"),At=document.getElementById("add-sequencer");function it(e,t){var n,s,o,i;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(s=e.querySelector(".zoom-out-btn"))==null||s.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-reset-btn"))==null||o.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!t)}function at(){return k}function bn(e){const t=String(e);return at().find(n=>{var s;return String(n.id)===t||String((s=n.config)==null?void 0:s.id)===t})}function gt(){const e=k.some(t=>t.solo);k.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function ge(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function rt(e){const n=yn.content.cloneNode(!0).querySelector(".sequencer");pn.insertBefore(n,At);const s=k.length,o=e?{id:s,...L,...e.config}:{id:s,...L},i=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",a=new Tt(n,o,z,Y,i);a.id=s,a.colorIndex=s,a.mute=!1,a.solo=!1,a.shouldPlay=!0;const l=n.querySelector("canvas.mini-contour");e&&a.setState(e),ut(l,a.notes,a.config,a.colorIndex),a.updateTrackLabel(),a.initInstrument();const r=n.querySelector(".collapse-btn"),c=r.querySelector("use"),f=n.querySelector(".sequencer-body");r.addEventListener("click",()=>{const p=f.classList.toggle("hidden");c.setAttribute("href",p?"#icon-caret-up":"#icon-caret-down"),l.classList.toggle("hidden",!p),it(n,!p),p&&ut(l,a.notes,a.config,a.colorIndex)});const u=n.querySelector(".delete-btn");u.innerHTML=`
    <svg class="w-6 h-6" aria-hidden="true">
      <use href="#icon-close-circle"></use>
    </svg>
  `,u.addEventListener("click",()=>{const p=document.getElementById("delete-confirm-modal"),g=document.getElementById("delete-confirm"),y=document.getElementById("delete-cancel");p.classList.remove("hidden");const b=()=>{a.destroy();const w=k.indexOf(a);w>=0&&k.splice(w,1),B()},v=()=>{B()},B=()=>{p.classList.add("hidden"),g.removeEventListener("click",b),y.removeEventListener("click",v)};g.addEventListener("click",b),y.addEventListener("click",v)});const m=n.querySelector(".mute-btn"),d=n.querySelector(".solo-btn"),h=n.querySelector(".instrument-select-btn");return m.addEventListener("click",()=>{a.mute=!a.mute,a.mute&&(a.solo=!1,d.classList.remove("bg-yellow-200"),d.classList.add("bg-gray-700"),d.classList.remove("hover:bg-yellow-400"),d.classList.add("hover:bg-purple-700"),ge(d,!1)),ge(m,a.mute),gt();const p=Fe();a.seekTo(p)}),d.addEventListener("click",()=>{a.solo=!a.solo,a.solo&&(a.mute=!1,ge(m,!1)),d.classList.toggle("bg-yellow-200",a.solo),d.classList.toggle("bg-gray-700",!a.solo),d.classList.toggle("hover:bg-yellow-400",a.solo),d.classList.toggle("hover:bg-purple-700",!a.solo),gt();const p=Fe();a.seekTo(p)}),h.addEventListener("click",async()=>{const p=document.getElementById("instrument-select-modal"),g=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const y=a.instrumentName||"fluidr3-gm/acoustic_grand_piano",[b,v]=y.split("/");g.value=b,await g.dispatchEvent(new CustomEvent("change",{detail:{preselect:y}})),p.dataset.currentSequencer=a.id,p.classList.remove("hidden")}),ge(m,!1),ge(d,!1),d.classList.add("hover:bg-purple-700"),k.push(a),{seq:a,wrapper:n}}function vn(){k.slice().forEach(e=>e.destroy()),k.length=0}function En(){const e=document.getElementById("global-mini-contour");At.addEventListener("click",()=>{rt(),me(e,k)})}const se={openaiApiKey:"",openaiModel:"gpt-4o"};function Ze(){return se.openaiApiKey}function pt(){return se.openaiModel}function wn(e){se.openaiApiKey=e}function Bn(e){const t=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];if(!t.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${t.join(", ")}`);se.openaiModel=e}function Mn(){localStorage.setItem("userConfig",JSON.stringify(se))}function Sn(){const e=localStorage.getItem("userConfig");if(e){const t=JSON.parse(e);se.openaiApiKey=t.openaiApiKey||"",se.openaiModel=t.openaiModel||"gpt-4o"}}Sn();function Ln(){const e=document.getElementById("userconfig-modal"),t=document.getElementById("config-save"),n=document.getElementById("config-close"),s=document.getElementById("openai-key-input"),o=document.getElementById("openai-model-select");s.value=Ze(),o.value=pt(),t.addEventListener("click",()=>{wn(s.value),Bn(o.value),Mn(),e.classList.add("hidden")}),n.addEventListener("click",()=>{s.value=Ze(),o.value=pt(),e.classList.add("hidden")}),document.getElementById("key-not-set-ok").addEventListener("click",()=>{document.getElementById("openai-key-not-set-modal").classList.add("hidden")})}const kn={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"};let yt=!1,te=!1,ne=!1;function In({getSequencers:e,onPlay:t,onStop:n,onPause:s,onResume:o,onDurationChange:i,onSnapChange:a,onToggleLoop:l,onTempoChange:r,onSave:c,onLoad:f,onMeasuresChange:u,onBeatsPerMeasureChange:m}){if(yt)return;yt=!0;const d=document.getElementById("play-button"),h=d.querySelector("use"),p=document.getElementById("stop-button"),g=document.getElementById("note-duration"),y=document.getElementById("dotted-note-btn"),b=document.getElementById("triplet-note-btn");g.value=String(L.currentDuration||1);const v=document.getElementById("snap-resolution");v.value=String(L.snapResolution||.25);const B=document.getElementById("loop-toggle"),w=document.getElementById("tempo-input"),S=document.getElementById("save-button"),I=document.getElementById("load-button"),C=document.getElementById("load-input"),P=document.getElementById("measures-input"),A=document.getElementById("beats-per-measure-input"),W=document.getElementById("config-button"),q=document.getElementById("export-modal"),U=document.getElementById("export-json"),x=document.getElementById("export-wav"),Me=document.getElementById("export-midi"),J=document.getElementById("export-cancel");h.setAttribute("href","#icon-play"),d.addEventListener("click",()=>{!te&&!ne?(te=!0,ne=!1,t==null||t(),h.setAttribute("href","#icon-pause")):te?(te=!1,ne=!0,s==null||s(),h.setAttribute("href","#icon-play")):ne&&(te=!0,ne=!1,o==null||o(),h.setAttribute("href","#icon-pause"))}),p.addEventListener("click",()=>{n==null||n(),te=!1,ne=!1,h.setAttribute("href","#icon-play")});const K={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125};window.addEventListener("keydown",M=>{var $;if(document.querySelector(".ai-modal:not(.hidden)"))return;const O=($=document.activeElement)==null?void 0:$.tagName;if(!(O==="INPUT"||O==="TEXTAREA")){if(M.code==="Space"){M.preventDefault(),d.click();return}if(st()===ot.NOTE_PLACEMENT){if(K.hasOwnProperty(M.code)){M.preventDefault();const ee=K[M.code];g.value=ee,g.dispatchEvent(new Event("change"))}if(M.key==="."){M.preventDefault(),y==null||y.click();return}if(M.key==="/"){M.preventDefault(),b==null||b.click();return}}}}),g.addEventListener("change",M=>{const N=parseFloat(M.target.value);T(N),i==null||i(N),e==null||e().forEach(O=>{const $=O.grid;if($!=null&&$.getPreviewNote){const ee=$.getPreviewNote();ee&&(ee.duration=N,$.scheduleRedraw())}})});function T(M){document.querySelectorAll(".note-duration-btn").forEach(O=>{const $=parseFloat(O.dataset.value);O.classList.remove("bg-purple-700"),O.classList.remove("bg-gray-800"),$===M?O.classList.add("bg-purple-700"):O.classList.add("bg-gray-800")})}v.addEventListener("change",M=>{const N=M.target.value;kn.hasOwnProperty(N)&&(L.snapResolution=parseFloat(N),v.value=String(N),a==null||a(L.snapResolution))}),B.addEventListener("change",M=>{l==null||l(M.target.checked)}),w.addEventListener("change",M=>{const N=parseInt(M.target.value,10);isNaN(N)||r==null||r(N)}),S.addEventListener("click",()=>{q?q.classList.remove("hidden"):c==null||c("json")}),I.addEventListener("click",()=>{C.click()}),C.addEventListener("change",M=>{const N=M.target.files[0];N&&(f==null||f(N)),M.target.value=""}),U&&U.addEventListener("click",()=>{q.classList.add("hidden"),c==null||c("json")}),x&&x.addEventListener("click",()=>{q.classList.add("hidden"),c==null||c("wav")}),Me&&Me.addEventListener("click",()=>{q.classList.add("hidden"),c==null||c("midi")}),J&&J.addEventListener("click",()=>{q.classList.add("hidden")}),W.addEventListener("click",()=>{document.getElementById("userconfig-modal").classList.remove("hidden")}),Ln(),P.value=L.totalMeasures,A.value=L.beatsPerMeasure,P.addEventListener("change",M=>{const N=parseInt(M.target.value,10);!isNaN(N)&&N>0&&(u==null||u(N))}),A.addEventListener("change",M=>{const N=parseInt(M.target.value,10);!isNaN(N)&&N>0&&(m==null||m(N))}),T(parseFloat(g.value))}function Nn(){te=!1,ne=!1;const t=document.getElementById("play-button").querySelector("use");t&&t.setAttribute("href","#icon-play")}function po(e){const t=document.getElementById("measures-input");t&&(t.value=e)}function Cn(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function Pn(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}let D=null,be=0;const Ue=new Map;async function Q(){D||(D=await Bt(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function Rt(){return z}async function De(e,t=z,n=null){await Q();const[s,o]=e.includes("/")?e.split("/"):["musyngkite",e],i=t instanceof OfflineAudioContext;Ue.has(t)||Ue.set(t,new Map);const a=Ue.get(t),l=`${s}/${o}`;if(a.has(l))return a.get(l);let r;if(s==="smolken")r=new D.Smolken(t,{instrument:o,destination:n||Y,disableScheduler:i}),await ae(r.load);else if(s==="splendidgrandpiano")r=new D.SplendidGrandPiano(t,{destination:n||Y,disableScheduler:i}),await ae(r.load);else if(s==="electricpiano")r=new D.ElectricPiano(t,{instrument:o,destination:n||Y,disableScheduler:i}),await ae(r.load);else if(s==="mallets")r=new D.Mallet(t,{instrument:o,destination:n||Y,disableScheduler:i}),await ae(r.load);else if(s==="drummachines"){r=new D.DrumMachine(t,{instrument:o,destination:n||Y,disableScheduler:i}),await ae(r.load);const c=r.getSampleNames(),f=new Map;c.forEach((u,m)=>{const d=36+m;f.set(d,u)}),r.__midiMap=f}else{const f={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[s.toLowerCase()]||"MusyngKite",u=await Dn();console.log(`[Soundfont] Available kits: ${u.join(", ")}`),console.log(`[Soundfont] Requested: kit=${f} instrument=${o}`);const d=`https://gleitz.github.io/midi-js-soundfonts/${f}/${o}-ogg.js`;r=new D.Soundfont(t,{instrument:o,instrumentUrl:d,kit:f,destination:n||Y,disableScheduler:i}),await ae(r.load)}return a.set(l,r),r}async function Tn(){return await Q(),D.getMalletNames()}async function An(){return await Q(),D.getElectricPianoNames()}async function Rn(){return await Q(),["splendidgrandpiano"]}async function qn(){return await Q(),D.getDrumMachineNames()}async function Fn(){return await Q(),D.getSmolkenNames()}async function _n(e="MusyngKite"){await Q();const t=await D.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function Dn(){return await Q(),D.getSoundfontKits()}function On(){be++,be===1&&Cn()}function Hn(){be--,be<=0&&(be=0,Pn())}async function ae(e){On();try{await e}finally{Hn()}}let V=null,Qe=null;async function bt(e){if(Qe===e)return;V=await De(e),Qe=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function $n(){return Qe}function qt(e,t=100,n=!1){var l;if(!V)return null;const o=Rt().currentTime,i=Xe(e),a=((l=V.__midiMap)==null?void 0:l.get(i))??i;return V.start({note:a,stopId:a,velocity:t,time:o,loop:n}),()=>{V.stop({stopId:a})}}function Xn(e){var s;if(!V)return;const t=Xe(e),n=((s=V.__midiMap)==null?void 0:s.get(t))??t;V.stop({stopId:n})}async function Wn(e,t,n,s=100,o=!1,i=null,a=null,l=null){var m;const r=a||Rt(),c=await De(e,r,l),f=Xe(t),u=((m=c.__midiMap)==null?void 0:m.get(f))??f;return c.start({note:u,duration:n,velocity:s,loop:o,time:i??r.currentTime}),null}const z=new(window.AudioContext||window.webkitAudioContext),We=z.createAnalyser();We.fftSize=2048;const Y=z.createGain();Y.connect(We);We.connect(z.destination);function Kn(e){z.resume();try{const t=qt(e,100,20);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}z.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let vt=!1,Ie=null;function Gn(e,t){if(vt)return;vt=!0,Ie=t;const n=e.getContext("2d"),s=new Map,o=new Set;function i(f,u){const m=Ie();for(const d of Object.values(m))if(d.isBlack&&f>=d.x&&f<=d.x+d.width&&u>=0&&u<=d.height)return d.note;for(const d of Object.values(m))if(!d.isBlack&&f>=d.x&&f<=d.x+d.width&&u>=0&&u<=d.height)return d.note;return null}function a(f){if(!f||o.has(f))return;const u=Kn(f);u&&(s.set(f,u),o.add(f),Be(n,Ie(),o))}function l(f){if(!o.has(f))return;const u=s.get(f);u&&(u.stop(),s.delete(f)),o.delete(f),Be(n,Ie(),o)}function r(){for(const f of o)l(f)}let c=!1;e.addEventListener("mousedown",f=>{c=!0;const u=e.getBoundingClientRect(),m=f.clientX-u.left,d=f.clientY-u.top,h=i(m,d);a(h)}),e.addEventListener("mousemove",f=>{if(!c)return;const u=e.getBoundingClientRect(),m=f.clientX-u.left,d=f.clientY-u.top,h=i(m,d);a(h)}),e.addEventListener("mouseup",()=>{c=!1,r()}),e.addEventListener("mouseleave",()=>{c=!1,r()})}const Ft=[..."qwertyuiop[zxcvbnm,./"],_t=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];let xe=!1,Ne=null,ve=null,Ee=null;function Un(e,t){if(xe)return;xe=!0;const n=e.getContext("2d"),s=new Set,o=new Set,i=new Map,a=Ft,l=_t;Ne=t;function r(){const u=Ne(),m=Object.values(u).filter(p=>!p.isBlack).sort((p,g)=>p.x-g.x).map(p=>p.note),d=Object.values(u).filter(p=>p.isBlack).sort((p,g)=>p.x-g.x).map(p=>p.note),h={};return a.forEach((p,g)=>{m[g]&&(h[p]=m[g])}),l.forEach((p,g)=>{d[g]&&(h[p]=d[g])}),h}function c(u){const m=r(),d=m[u];if(!(!d||s.has(u))){if(s.add(u),!o.has(d)){const h=qt(d,100,zn());h&&(i.set(d,{stop:h}),o.add(d))}Be(n,Ne(),o,m)}}function f(u){const m=r(),d=m[u];d&&(s.delete(u),o.has(d)&&(Xn(d),i.delete(d),o.delete(d)),Be(n,Ne(),o,m))}ve=u=>{u.repeat||c(u.key)},Ee=u=>{f(u.key)},window.addEventListener("keydown",ve),window.addEventListener("keyup",Ee)}function jn(){ve&&(window.removeEventListener("keydown",ve),ve=null),Ee&&(window.removeEventListener("keyup",Ee),Ee=null),xe=!1}let le=3,re=Mt(le),Ce=!1;async function Yn(e){const t=e.getContext("2d");await bt("fluidr3-gm/acoustic_grand_piano");const n=Ft,s=_t;function o(){const g=Object.values(re).filter(v=>!v.isBlack).sort((v,B)=>v.x-B.x).map(v=>v.note),y=Object.values(re).filter(v=>v.isBlack).sort((v,B)=>v.x-B.x).map(v=>v.note),b={};return n.forEach((v,B)=>{g[B]&&(b[v]=g[B])}),s.forEach((v,B)=>{y[B]&&(b[v]=y[B])}),b}function i(){re=Mt(le);const g=Ce?o():null;Be(t,re,new Set,g)}Gn(e,()=>re),i(),document.getElementById("octave-up").addEventListener("click",()=>{le<7&&(le++,i())}),document.getElementById("octave-down").addEventListener("click",()=>{le>1&&(le--,i())});const a=document.getElementById("disable-keyboard-inputs");a.classList.remove("bg-purple-600"),a.classList.add("bg-gray-700"),a.addEventListener("click",()=>{Ce=!Ce,Ce?(Un(e,()=>re),a.classList.remove("bg-gray-700"),a.classList.add("bg-purple-600")):(jn(),a.classList.remove("bg-purple-600"),a.classList.add("bg-gray-700")),i()});const l=document.getElementById("instrument-select-btn"),r=document.getElementById("instrument-select-modal"),c=document.getElementById("instrument-select"),f=document.getElementById("instrument-select-confirm"),u=document.getElementById("instrument-cancel-btn"),m=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([g,y])=>{const b=document.createElement("option");b.value=g,b.textContent=g.replace(/_/g," ").replace(/\b\w/g,v=>v.toUpperCase()),m.appendChild(b)}),m.addEventListener("change",async g=>{var B;const y=m.value,b=document.getElementById("instrument-select"),v=((B=g.detail)==null?void 0:B.preselect)||null;try{let w;y==="mallets"?w=await Tn():y==="electricpiano"?w=await An():y==="splendidgrandpiano"?w=await Rn():y==="drummachines"?w=await qn():y==="smolken"?w=await Fn():["fluidr3-gm","musyngkite","fatboy"].includes(y)?w=await _n({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[y]):w=await(await fetch(`/static/${y}.json`)).json(),b.innerHTML="",w.forEach(S=>{const I=document.createElement("option");I.value=`${y}/${S}`,I.textContent=S.split("_").map(C=>C.charAt(0).toUpperCase()+C.slice(1)).join(" "),b.appendChild(I)}),b.value=v||`${y}/${w[0]}`}catch(w){console.error(`Failed to load instruments for library: ${y}`,w)}}),m.dispatchEvent(new Event("change")),l.addEventListener("click",async()=>{const g=$n()||"fluidr3-gm/acoustic_grand_piano",[y,b]=g.split("/");m.value=y,await m.dispatchEvent(new CustomEvent("change",{detail:{preselect:g}})),r.classList.remove("hidden"),delete r.dataset.currentSequencer}),f.addEventListener("click",async()=>{const g=c.value;r.classList.add("hidden");const y=r.dataset.currentSequencer;if(y){console.log("[Modal] Looking up sequencer with id:",y);const b=bn(y);console.log("[Modal] Lookup result:",b),b&&b.setInstrument(g),r.dataset.currentSequencer=""}else try{await bt(g)}catch(b){console.error("Failed to load global instrument:",g,b)}});let h=!1;const p=document.getElementById("instrument-loop-toggle");p.addEventListener("change",()=>{h=p.checked,console.log("[UI] Loop mode:",h)}),u.addEventListener("click",()=>{r.classList.add("hidden")})}function zn(){var e;return((e=document.getElementById("instrument-loop-toggle"))==null?void 0:e.checked)||!1}function Jn(e,t){const n=t.getContext("2d"),s=t.width,o=t.height,i=new Uint8Array(e.fftSize),a=new Uint8Array(e.frequencyBinCount),l=document.createElement("canvas");l.width=s,l.height=o;const r=l.getContext("2d");let c="frequency";function f(){e.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,s,o),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const h=s/i.length;let p=0;for(let g=0;g<i.length;g++){const b=i[g]/128*o/2;g===0?n.moveTo(p,b):n.lineTo(p,b),p+=h}n.lineTo(s,o/2),n.stroke()}function u(){e.getByteFrequencyData(a),n.fillStyle="#000",n.fillRect(0,0,s,o),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,o),n.fillRect(s-1,0,1,o);const h=128,p=2,g=[];for(let y=0;y<h;y++)g.push(y*s/(h-1));g[g.length-1]=s-1;for(let y=0;y<h;y++){const b=g[y],v=y<h-1?g[y+1]:s,B=Math.max(1,v-b-p),w=20,S=2e4,I=y/(h-1),C=w*Math.pow(S/w,I),A=Math.min(a.length-1,Math.floor(C/22050*a.length)),W=a[A]/255,q=Math.max(1,W*o),U=240-I*240;n.fillStyle=`hsl(${U}, ${80+W*20}%, ${40+W*40}%)`,n.fillRect(b,o-q,B,q)}}function m(){e.getByteFrequencyData(a),l.initialized||(r.fillStyle="#000",r.fillRect(0,0,s,o),l.initialized=!0),r.drawImage(l,-1,0),r.fillStyle="#000",r.fillRect(s-1,0,1,o);const h=128,p=20,g=2e4;for(let y=0;y<h;y++){const b=y/(h-1),v=p*Math.pow(g/p,b),w=Math.min(a.length-1,Math.floor(v/22050*a.length)),S=a[w]/255,I=o-1-Math.floor(y*o/h);if(S<.05)continue;const C=Math.floor(S*255),P=Math.floor(S*(255-b*200)),A=Math.floor(S*(100+b*155));r.fillStyle=`rgb(${C}, ${P}, ${A})`,r.fillRect(s-1,I,1,1)}n.fillStyle="#000",n.fillRect(0,0,s,o),n.drawImage(l,0,0)}function d(){switch(requestAnimationFrame(d),c){case"frequency":u();break;case"spectrogram":m();break;case"waveform":default:f()}}return d(),{setMode(h){["waveform","frequency","spectrogram"].includes(h)&&(c=h,n.clearRect(0,0,s,o),c==="spectrogram"&&r.clearRect(0,0,s,o))}}}function Vn(e,t){const n=Jn(We,e),s=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let o=0;function i(){o=(o+1)%s.length;const{name:a,emoji:l}=s[o];n.setMode(a),t.textContent=l,t.title=`Mode: ${a}`}t.addEventListener("click",i),i()}function Zn(e){if(!e.length)throw new Error("No tracks to export.");const t=e[0].config.bpm,n=e[0].config.beatsPerMeasure,s=e[0].config.totalMeasures,o={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:s},i:e.map(a=>a.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.map(({notes:a})=>({n:a.map(l=>[l.pitch,l.start,l.duration])}))},i=new Blob([JSON.stringify(o)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function Qn(e){if(!e.length)return;const n=60/e[0].config.bpm,s=Math.max(...e.flatMap(f=>f.notes.map(u=>(u.start+u.duration)*n+.2))),o=44100,i=new OfflineAudioContext(2,Math.ceil(o*s),o);for(const f of e){const u=f.instrument||"fluidr3-gm/acoustic_grand_piano",m=new Tt(null,f.config,i,i.destination,u);m.setState(f),await m.exportToOffline()}const a=await i.startRendering(),l=xn(a),r=URL.createObjectURL(l),c=document.createElement("a");c.href=r,c.download=`session-${Date.now()}.wav`,c.click(),URL.revokeObjectURL(r)}function xn(e){const t=e.numberOfChannels,n=e.length*t*2,s=new DataView(new ArrayBuffer(44+n)),o=(a,l)=>{for(let r=0;r<l.length;r++)s.setUint8(a+r,l.charCodeAt(r))};o(0,"RIFF"),s.setUint32(4,36+n,!0),o(8,"WAVE"),o(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,t,!0),s.setUint32(24,e.sampleRate,!0),s.setUint32(28,e.sampleRate*t*2,!0),s.setUint16(32,t*2,!0),s.setUint16(34,16,!0),o(36,"data"),s.setUint32(40,n,!0);let i=44;for(let a=0;a<e.length;a++)for(let l=0;l<t;l++){const r=e.getChannelData(l)[a],c=Math.max(-1,Math.min(1,r));s.setInt16(i,c*32767,!0),i+=2}return new Blob([s.buffer],{type:"audio/wav"})}function eo(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),s=document.getElementById("triplet-note-btn");let o=!1,i=!1;function a(r){r=parseFloat(r);let c=r;o?c=r*1.5:i&&(c=r*(2/3));let f=Array.from(t.options).find(u=>Math.abs(parseFloat(u.value)-c)<1e-4);f||(f=new Option(c.toString(),c.toString()),t.add(f)),t.value=f.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(r=>{r.addEventListener("click",()=>{e.forEach(f=>f.classList.remove("bg-purple-600")),r.classList.add("bg-purple-600");const c=parseFloat(r.dataset.value);a(c)})}),n.addEventListener("click",()=>{i&&(i=!1,s.classList.remove("bg-purple-600")),o=!o,n.classList.toggle("bg-purple-600"),l()}),s.addEventListener("click",()=>{o&&(o=!1,n.classList.remove("bg-purple-600")),i=!i,s.classList.toggle("bg-purple-600"),L.isTripletMode=i,k.forEach(r=>{r.config.isTripletMode=i}),l()});function l(){const r=document.querySelector(".note-duration-btn.bg-purple-600");if(r){const c=parseFloat(r.dataset.value);a(c)}}a(L.currentDuration||1)}let j=null,Oe=null;function to(e){Oe=e,j=Oe.getContext("2d")}function de(e){if(!j||!Oe)return;const{width:t,height:n}=Oe;j.clearRect(0,0,t,n);const s=Math.round(e)+.5;j.strokeStyle="#ff00ff",j.lineWidth=1,j.beginPath(),j.moveTo(s,0),j.lineTo(s,n),j.stroke()}let He=!1,ue=null,Dt=null,et=!1;function no(e,t){ue=e,Dt=t,ue.addEventListener("mousedown",oo),window.addEventListener("mousemove",so),window.addEventListener("mouseup",io)}function oo(e){fn()&&(Ct(),k.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),et=!0),He=!0,Ot(e)}function so(e){He&&Ot(e)}function io(){He&&(He=!1,et&&(Pt(),k.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),et=!1))}function Ot(e){const t=ue.getBoundingClientRect(),n=ue.width/t.width;let s=(e.clientX-t.left)*n;s=Math.max(0,Math.min(ue.width,s));const o=_(Dt),i=s/ue.width*o;Z(i),de(s)}const lt={maxBeatsContext:32,extendBeatsAmount:16};function yo(){return lt.maxBeatsContext}function bo(){return lt.extendBeatsAmount}function tt(e,t,n,s){const o=_(L),i=s/o*t;e.clearRect(0,0,t,n);const a=lt.maxBeatsContext,r=Math.max(0,s-a)/o*t,c=i-r;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(r,0,c,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke()}let Et=!1;function wt(){if(!Et){Et=!0;const s=document.getElementById("extend-use-tags"),o=document.getElementById("extend-tags");if(s&&o){let c=function(){const f=s.checked;o.disabled=!f,o.classList.toggle("opacity-50",!f),o.classList.toggle("cursor-not-allowed",!f)};c(),s.addEventListener("change",c)}const i=document.getElementById("extend-start-help-btn"),a=document.getElementById("extend-start-help-popup"),l=document.getElementById("extend-start-help-close");i&&a&&l&&(i.addEventListener("click",()=>a.classList.remove("hidden")),l.addEventListener("click",()=>a.classList.add("hidden")),document.addEventListener("click",c=>{!a.contains(c.target)&&c.target!==i&&a.classList.add("hidden")}));const r=document.querySelector("#ai-extend-modal .generate-btn");r&&r.addEventListener("click",async()=>{const{extendTracksWithAI:c}=await Bt(async()=>{const{extendTracksWithAI:f}=await import("./extendTracks-BZL-TZTO.js");return{extendTracksWithAI:f}},__vite__mapDeps([0,1]));await c()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",at().forEach((o,i)=>{const a=`extend-track-${i}`,l=document.createElement("div");l.className="flex items-center gap-2";const r=document.createElement("input");r.type="checkbox",r.id=a,r.dataset.index=i,r.checked=!0,r.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const c=document.createElement("label");c.htmlFor=a,c.className="text-sm text-gray-200",c.textContent=o.config.name||`Track ${i+1}`,r.addEventListener("change",()=>{pe()}),l.appendChild(r),l.appendChild(c),e.appendChild(l)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(o=>o.checked=!0),pe()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(o=>o.checked=!1),pe()}),pe())}let je=!1,we=0;function vo(){return we}function ao(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d"),s=e.clientWidth,o=e.clientHeight;e.width=s,e.height=o,t.width=s,t.height=o,pe(),tt(n,s,o,we),t.addEventListener("mousedown",a=>{je=!0,i(a.offsetX)}),window.addEventListener("mouseup",()=>{je=!1}),window.addEventListener("mousemove",a=>{if(!je)return;const l=t.getBoundingClientRect();i(a.clientX-l.left)});function i(a){const l=_(L),r=Math.max(0,Math.min(a,s));we=Math.round(r/s*l),tt(n,s,o,we)}}function pe(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead"),n=t.getContext("2d"),s=t.width,o=t.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),a=Array.from(i).filter(r=>r.checked).map(r=>parseInt(r.dataset.index,10)),l=at().filter((r,c)=>a.includes(c));me(e,l),tt(n,s,o,we)}function ro(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),s=document.getElementById("note-duration-controls"),o=document.getElementById("select-mode-controls"),i=document.getElementById("velocity-mode-controls");function a(r){[e,t,n].forEach(c=>{c.classList.remove("bg-purple-600"),c.classList.add("bg-gray-800")}),r.classList.remove("bg-gray-800"),r.classList.add("bg-purple-600")}function l(r){[s,o,i].forEach(c=>{c.classList.add("hidden")}),r.classList.remove("hidden")}e.addEventListener("click",()=>{a(e),l(s),ke("note-placement")}),t.addEventListener("click",()=>{a(t),l(o),ke("select")}),n.addEventListener("click",()=>{a(n),l(i),ke("velocity")}),window.addEventListener("keydown",r=>{var u;const c=(u=document.activeElement)==null?void 0:u.tagName;if(!(c==="INPUT"||c==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(r.key){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),a(e),l(s),ke("note-placement")}function lo(){const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),s=document.getElementById("ai-control-panel");function o(){document.querySelectorAll(".sequencer").forEach(m=>{const d=m.querySelector(".delete-btn"),h=m.querySelector(".collapse-btn"),p=h.querySelector("use");d.classList.add("button-locked"),h.classList.add("button-locked");const g=m.querySelector(".sequencer-body"),y=m.querySelector(".mini-contour");it(m,!1),g.classList.contains("hidden")||(g.classList.add("hidden"),y.classList.remove("hidden"),p.setAttribute("href","#icon-caret-up"))})}function i(){document.querySelectorAll(".sequencer").forEach(m=>{const d=m.querySelector(".delete-btn"),h=m.querySelector(".collapse-btn");d.classList.remove("button-locked"),h.classList.remove("button-locked")})}function a(){e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),s.classList.add("hidden"),i()}function l(){if(!Ze()){document.getElementById("openai-key-not-set-modal").classList.remove("hidden");return}t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),s.classList.remove("hidden"),o()}e.addEventListener("click",a),t.addEventListener("click",l);const r=document.getElementById("ai-inpaint-modal"),c=document.getElementById("ai-extend-modal"),f=document.getElementById("ai-generate-modal");function u(m){m.querySelector(".cancel-btn").addEventListener("click",()=>{m.classList.add("hidden")})}u(r),u(c),u(f),wt(),document.getElementById("ai-inpaint-btn").addEventListener("click",()=>{r.classList.remove("hidden")}),document.getElementById("ai-extend-btn").addEventListener("click",()=>{c.classList.remove("hidden"),ao(),wt()}),document.getElementById("ai-generate-btn").addEventListener("click",()=>{f.classList.remove("hidden")}),ro()}function co(){document.addEventListener("keydown",o=>{var c;if(st()!==ot.SELECT)return;const a=navigator.platform.toUpperCase().includes("MAC")?o.metaKey:o.ctrlKey,l=(c=document.activeElement)==null?void 0:c.tagName;if(!(l==="INPUT"||l==="TEXTAREA"||!Le()))switch(!0){case(a&&o.key==="c"):o.preventDefault(),t==null||t.click();break;case(a&&o.key==="x"):o.preventDefault(),n==null||n.click();break;case(a&&o.key==="v"):o.preventDefault(),s==null||s.click();break;case o.key==="Delete":o.preventDefault(),e==null||e.click();break}});const e=document.querySelector(".select-mode-delete");e&&(e.onclick=()=>{var l;const o=Le();if(!o)return;const i=o.gridContext,a=o.getSelectedNotes();if(a.length!==0){for(const r of a){const c=i.notes.indexOf(r);c!==-1&&i.notes.splice(c,1)}i.setSelectedNotes([]),i.scheduleRedraw(),(l=i.onNotesChanged)==null||l.call(i)}});const t=document.querySelector(".select-mode-copy");t&&(t.onclick=()=>{const o=Le();if(!o)return;const i=o.getSelectedNotes();i.length!==0&&mt(i)});const n=document.querySelector(".select-mode-cut");n&&(n.onclick=()=>{var l;const o=Le();if(!o)return;const i=o.gridContext,a=o.getSelectedNotes();if(a.length!==0){mt(a);for(const r of a){const c=i.notes.indexOf(r);c!==-1&&i.notes.splice(c,1)}i.setSelectedNotes([]),i.scheduleRedraw(),(l=i.onNotesChanged)==null||l.call(i)}});const s=document.querySelector(".select-mode-paste");s&&(s.onclick=()=>{const o=kt();o.notes.length&&(document.body.style.cursor="crosshair",nn((i,a)=>{var v;const l=i.gridContext,{x:r,y:c}=l.getCanvasPos(a),f=l.getSnappedBeatFromX(r),u=l.getPitchFromRow(Math.floor(c/l.getCellHeight())),m=R(u),{notes:d,anchorBeat:h,anchorMidi:p}=o,g=f-h,y=m-p,b=d.map(B=>({pitch:Ae(R(B.pitch)+y),start:B.start+g,duration:B.duration}));l.notes.push(...b),l.setSelectedNotes(b),l.scheduleRedraw(),(v=l.onNotesChanged)==null||v.call(l),document.body.style.cursor="default",nt()}))})}function Ht(){me(uo,k)}const uo=document.getElementById("global-mini-contour"),ct=document.getElementById("global-mini-playhead");to(ct);no(ct,L);de(0);const fo=document.getElementById("piano");Yn(fo);const mo=document.getElementById("waveform");Vn(mo,document.getElementById("visualizer-mode"));const{wrapper:ho}=rt();it(ho,!0);co();Ht();En();eo();lo();In({getSequencers:()=>k,onPlay:()=>{_e();const e=_(L),t=Fe();un(L.bpm,{loop:L.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{k.forEach(n=>{var s;return(s=n.onTransportLoop)==null?void 0:s.call(n)})}}),Ve(n=>{const s=n/e*ct.width;de(s)}),k.forEach(n=>n.play()),dn(()=>{Nn(),Z(0),de(0)})},onPause:()=>{Ct(),k.forEach(e=>e.pause())},onResume:()=>{Pt(),k.forEach(e=>e.resume())},onStop:()=>{_e(),Z(0),k.forEach(e=>e.stop()),de(0)},onDurationChange:e=>{L.currentDuration=e,k.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{L.snapResolution=e,k.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{L.loopEnabled=e,k.forEach(t=>t.config.loopEnabled=e)},onTempoChange:e=>{L.bpm=e,k.forEach(t=>t.config.bpm=e)},onSave:async e=>{const t=k.map(n=>n.getState());if(e==="json"){const{url:n,filename:s}=Zn(t),o=document.createElement("a");o.href=n,o.download=s,o.click(),URL.revokeObjectURL(n)}else e==="wav"?await Qn(t):e==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async e=>{try{let t=[];try{t=await gn(e)}catch{t=await hn(e)}if(t.length>0){const n=t[0].config;L.bpm=n.bpm??L.bpm;const s=document.getElementById("tempo-input");s&&(s.value=L.bpm),L.beatsPerMeasure=n.beatsPerMeasure??L.beatsPerMeasure,L.totalMeasures=n.totalMeasures??L.totalMeasures;const o=document.getElementById("measures-input");o&&(o.value=L.totalMeasures)}vn(),t.forEach(n=>{const{seq:s,wrapper:o}=rt(n),i=o.querySelector(".sequencer-body"),a=o.querySelector("canvas.mini-contour"),l=o.querySelector(".collapse-btn");i.classList.add("hidden"),a.classList.remove("hidden"),l.textContent="⯅"}),Ht(),Z(0),de(0)}catch(t){alert("Failed to load file: "+t.message)}},onMeasuresChange:e=>{L.totalMeasures=e,k.forEach(n=>{n.updateTotalMeasures(e)});const t=document.getElementById("global-mini-contour");t&&me(t,k)},onBeatsPerMeasureChange:e=>{L.beatsPerMeasure=e,k.forEach(n=>{n.config.beatsPerMeasure=e,n.updateTotalMeasures(L.totalMeasures)});const t=document.getElementById("global-mini-contour");t&&me(t,k)}});const Eo=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{pt as a,at as b,vo as c,yo as d,bo as e,L as f,Ze as g,ut as h,me as i,Eo as m,po as u};
