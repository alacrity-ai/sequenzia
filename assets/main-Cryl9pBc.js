const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-bbx5Xkn4.js","assets/index-5oUMsW-B.js"])))=>i.map(i=>d[i]);
import{_ as un}from"./index-5oUMsW-B.js";function fn(e=3){const i=["C","D","E","F","G","A","B"],r=["C#","D#","","F#","G#","A#",""],c=[e,e+1,e+2],a={};let l=0;for(const d of c)i.forEach(f=>{const u=`${f}${d}`;a[u]={note:u,x:l,width:60,height:200,isBlack:!1},l+=60});l=0;for(const d of c)r.forEach((f,u)=>{if(f===""){l+=60;return}const m=`${f}${d}`;a[m]={note:m,x:l+60-40/2,width:40,height:120,isBlack:!0},l+=60});return a}function Fe(e,t,n=new Set,o=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const s={};if(o)for(const[i,r]of Object.entries(o))s[r]=i;for(const i of Object.values(t))i.isBlack||(Kt(e,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",s[i.note]&&(e.fillStyle="#7c3aed",e.fillText(s[i.note],i.x+i.width/2,i.height-24),e.fillStyle="#333"),e.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(t))i.isBlack&&(Kt(e,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),Vn(e,i),s[i.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(s[i.note],i.x+i.width/2,i.height-28)))}function Kt(e,{x:t,width:n,height:o,fill:s,stroke:i,radius:r=8}){e.beginPath(),e.moveTo(t,0),e.lineTo(t,o-r),e.quadraticCurveTo(t,o,t+r,o),e.lineTo(t+n-r,o),e.quadraticCurveTo(t+n,o,t+n,o-r),e.lineTo(t+n,0),e.closePath(),e.fillStyle=s,e.fill(),e.strokeStyle=i,e.lineWidth=1,e.stroke()}function Vn(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}function D(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}function Qn(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function Zn(e){return e.replace(/\d+$/,"")}function Jn(e){return e.includes("#")}function xn(e,t){return e/t()}function mn(e,t){let n=t.snapResolution||.25,o=t.isTripletMode?n*(2/3):n;return Math.round(e/o)*o}function eo(e,t,n){const o=xn(e,n);return mn(o,t)}function hn(e,t,n,o,s,i=4){e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+o-i,n),e.quadraticCurveTo(t+o,n,t+o,n+i),e.lineTo(t+o,n+s-i),e.quadraticCurveTo(t+o,n+s,t+o-i,n+s),e.lineTo(t+i,n+s),e.quadraticCurveTo(t,n+s,t,n+s-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}const J=64,to={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"},Xe=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:60,cellHeight:25},{cellWidth:80,cellHeight:30}];function no(e,t){const n=structuredClone(e);return n.tempo=t.bpm,n}function gn(e){return{type:"CHANGE_TEMPO",bpm:e}}function oo(e){return gn(e)}function so(e,t){const n=structuredClone(e);return n.timeSignature=[t.beats,4],n}function pn(e){return{type:"SET_TIME_SIGNATURE",beats:e}}function io(e){return pn(e)}function ro(e,t){const n=structuredClone(e);return n.totalMeasures=t.measures,n}function yn(e){return{type:"SET_TOTAL_MEASURES",measures:e}}function ao(e){return yn(e)}function co(e,t){const n=structuredClone(e);if(n.sequencers.push({id:t.id,instrument:t.instrument,notes:t.notes||[]}),!k.find(s=>s.id===t.id)){const{wrapper:s}=Fn({config:{id:t.id,...t.config},notes:t.notes||[],instrument:t.instrument});ze(s,!0)}return n}function En(e,t){return{type:"CREATE_SEQUENCER",id:e,instrument:t}}function Nt(e){return{type:"DELETE_SEQUENCER",id:e}}function lo(e,t){const n=structuredClone(e);n.sequencers=n.sequencers.filter(s=>s.id!==t.id);const o=k.findIndex(s=>s.id===t.id);return o!==-1&&(k[o].destroy(),k.splice(o,1)),n}function uo(e,t,n=[]){return{type:"DELETE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function fo(e,t,n=[]){return{type:"CREATE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function mo(e,t){return structuredClone(e)}const Me=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function ho(e){return Me[e%Me.length]}function go(e){return ho(e.colorIndex)}function He(e,t,n,o=0){const s=e.getContext("2d");s.imageSmoothingEnabled=!1;const i=e.width,r=e.height;if(s.clearRect(0,0,i,r),!t.length)return;const c=Me[o%Me.length];s.fillStyle=c;const a=F(),l=t.map(y=>D(y.pitch));let d=Math.min(...l),f=Math.max(...l),u=Math.max(1,f-d);for(;r%u!==0;)f++,u=f-d;const m=r/u;for(const y of t){const E=y.start/a*i,b=y.duration/a*i,w=(D(y.pitch)-d)/u,B=r-w*r-m/2,L=Math.round(E),M=Math.max(1,Math.round(b)),N=Math.round(B);s.fillRect(L,N,M,m)}const h=Le(),p=Ne();s.save();let g=1;p>256?g=16:p>128?g=8:p>32&&(g=4);for(let y=0;y<=p;y++){if(y%g!==0)continue;const b=y*h/a*i,S=Math.round(b)+.5;s.beginPath(),s.moveTo(S,0),s.lineTo(S,r);const w=g===1||y%(g*2)===0;s.strokeStyle=w?"rgba(255, 255, 255, 0.12)":"rgba(255, 255, 255, 0.04)",s.lineWidth=.2,s.stroke()}s.restore()}function V(e,t){const n=e.getContext("2d"),o=e.width,s=e.height;n.clearRect(0,0,o,s),t.forEach((i,r)=>{const c=i.notes,a=i.config;if(!(c!=null&&c.length))return;const l=F(),d=Me[r%Me.length];n.fillStyle=d;const f=D(a.noteRange[0]),m=D(a.noteRange[1])-f||1,h=Math.max(2,s/m);for(const p of c){const g=p.start/l*o,y=Math.max(1,p.duration/l*o),b=(D(p.pitch)-f)/m,S=s-b*s-h/2;n.fillRect(g,S,y,h)}})}function po(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;o.notes.push(...t.notes);const s=document.getElementById("global-mini-contour");return s&&V(s,k),n}function yo(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Eo(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function bo(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));o.notes=o.notes.filter(r=>{const c=`${r.pitch}|${r.start}|${r.duration}`;return!s.has(c)});const i=document.getElementById("global-mini-contour");return i&&V(i,k),n}function kt(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function It(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function So(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const{from:s,to:i}=t;for(let r=0;r<s.length;r++){const c=s[r],a=i[r],l=o.notes.findIndex(d=>d.pitch===c.pitch&&d.start===c.start&&d.duration===c.duration);l!==-1&&(o.notes[l].pitch=a.pitch,o.notes[l].start=a.start)}return n}function Tt(e,t,n){return{type:"MOVE_NOTES",sequencerId:e,from:structuredClone(t),to:structuredClone(n)}}function bn(e,t,n){return Tt(e,n,t)}function wo(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(i=>`${i.pitch}|${i.start}|${i.duration}`));return o.notes=o.notes.filter(i=>{const r=`${i.pitch}|${i.start}|${i.duration}`;return!s.has(r)}),n}function vo(e,t){return{type:"CUT_NOTES",sequencerId:e,notes:structuredClone(t)}}function Bo(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Co(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);return o?(o.notes.push(...t.notes),n):e}function Mo(e,t){return{type:"PASTE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Lo(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function No(e,t){return structuredClone(e)}function ko(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;for(const i of t.resizes){const r=o.notes.find(c=>c.pitch===i.pitch&&c.start===i.start);r&&(r.duration=i.newDuration)}const s=document.getElementById("global-mini-contour");return s&&V(s,k),n}function Io(e,t){return{type:"RESIZE_NOTES",sequencerId:e,resizes:structuredClone(t)}}function To(e,t){const n=t.map(o=>({pitch:o.pitch,start:o.start,newDuration:o.oldDuration}));return{type:"RESIZE_NOTES",sequencerId:e,resizes:n}}function Ao(e,t){return structuredClone(e)}function At(e=""){return{type:"CHECKPOINT",label:e}}function Sn(e=""){return At(e)}const Ro=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_INSTRUMENT:mo,CHANGE_TEMPO:no,CHECKPOINT:Ao,CREATE_SEQUENCER:co,CUT_NOTES:wo,DELETE_NOTES:bo,DELETE_SEQUENCER:lo,MOVE_NOTES:So,PASTE_NOTES:Co,PLACE_NOTES:po,RESIZE_NOTES:ko,SET_TIME_SIGNATURE:so,SET_TOTAL_MEASURES:ro,UPDATE_NOTE_VELOCITY:No},Symbol.toStringTag,{value:"Module"}));function Rt(e){const t=Ro[e.type];if(!t)throw new Error(`Unknown diff type: ${e.type}`);const n=t(Ge(),e);wn(n)}let ft=new Set;function Po(e){return ft.add(e),()=>ft.delete(e)}function Ue(e){for(const t of ft)t(e)}const oe=[];let ee=-1;const qo=100;function _o({forwardDiff:e,reverseDiff:t}){oe.splice(ee+1),oe.push({forwardDiff:e,reverseDiff:t}),ee=oe.length-1,oe.length>qo&&(oe.shift(),ee--)}function Do(){var e;if(ee<0)return null;for(let t=ee;t>=0;t--){const n=oe[t];if(((e=n==null?void 0:n.forwardDiff)==null?void 0:e.type)==="CHECKPOINT")return null;if(n!=null&&n.reverseDiff)return ee=t-1,Rt(n.reverseDiff),Ue(Ge()),n.reverseDiff}return null}function Oo(){if(ee>=oe.length-1)return null;ee++;const e=oe[ee];return!e||!e.forwardDiff?null:(Rt(e.forwardDiff),Ue(Ge()),e.forwardDiff)}function Fo(){oe.length=0,ee=-1}let Je={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[]};function Ge(){return Je}function wn(e){Je=structuredClone(e),Ue(Je)}function q(e,t){Rt(e),_o({forwardDiff:e,reverseDiff:t}),Ue(Je)}let X=null,x=500,we=null,mt=!1,ht=1/0,ve=[],Qe=null,vn=0,Bn=4,Cn=8;function gt(e){return ve.push(e),()=>{const t=ve.indexOf(e);t!==-1&&ve.splice(t,1)}}function Ho(){ve=[]}function le(e){vn=e}function F(){return Ne()*Le()}function xe(){return vn}function pt(e,t=!0){if(t){const o=de();q(gn(e),oo(o));return}if(Mn()){const o=performance.now(),s=(o-we)/x;x=60/e*1e3,we=o-s*x}else x=60/e*1e3;const n=document.getElementById("tempo-input");n&&n.value!==String(e)&&(n.value=e)}function de(){return 60/(x/1e3)}function yt(e,t=!0){if(t){const o=Le();q(pn(e),io(o));return}Bn=e;const n=document.getElementById("beats-per-measure-input");n&&n.value!==String(e)&&(n.value=e),ie().forEach(o=>{var s,i;(s=o.grid)!=null&&s.resizeAndRedraw?o.grid.resizeAndRedraw():(i=o.grid)==null||i.scheduleRedraw()})}function Le(){return Bn}function Et(e,t=!0){if(t){const o=Ne();q(yn(e),ao(o));return}Cn=e;const n=document.getElementById("measures-input");n&&n.value!==String(e)&&(n.value=e),ie().forEach(o=>{var s;(s=o.grid)==null||s.scheduleRedraw()})}function Ne(){return Cn}function $o(e){Qe=e}function Wo(){return $.snapResolution}function Uo(e,t={}){x=60/e*1e3,mt=t.loop??!1,ht=t.endBeat??1/0;const n=t.startBeat??0;we=performance.now()-n*x;const o=t.onLoop;function s(i){const c=(i-we)/x;if(le(c),ve.forEach(a=>a(c)),c>=ht)if(mt)we=performance.now(),le(0),o&&o();else{et();return}X=requestAnimationFrame(s)}X=requestAnimationFrame(s)}function et(){X&&cancelAnimationFrame(X),X=null,Ho(),Qe&&(Qe(),Qe=null)}function Mn(){return X!==null}function Ln(){X&&cancelAnimationFrame(X),X=null}function Nn(){if(X)return;const e=performance.now()-xe()*x;function t(n){const s=(n-e)/x;if(le(s),ve.forEach(i=>i(s)),s>=ht)if(mt)we=performance.now(),le(0);else{et();return}X=requestAnimationFrame(t)}X=requestAnimationFrame(t)}const kn={openaiApiKey:"",openaiModel:"gpt-4o",gridColorScheme:"Darkroom",noteColorScheme:"Track Color"};function ke(){return kn}function $e(e){Object.assign(kn,e)}const Xt={Midnight:{whiteKey:"#1e1e1e",blackKey:"#2a103b",labelWhite:"#2c2c2c",labelBlack:"#3a1d4d",textWhite:"#cfcfcf",textBlack:"#e6d9ff",gridLine:"#333",beatLine:"#4e3d63",measureLine:"#8561c2"},Seashell:{whiteKey:"#fefefe",blackKey:"#f1e7dc",labelWhite:"#dddddd",labelBlack:"#d4cfc9",textWhite:"#444",textBlack:"#663300",gridLine:"#ccc",beatLine:"#bbb",measureLine:"#999"},Cyberpunk:{whiteKey:"#1b1b2f",blackKey:"#162447",labelWhite:"#1f4068",labelBlack:"#1f4068",textWhite:"#e43f5a",textBlack:"#e43f5a",gridLine:"#1f4068",beatLine:"#e43f5a",measureLine:"#ffcc00"},"Classic Blue":{whiteKey:"#f5faff",blackKey:"#dceeff",labelWhite:"#aaccee",labelBlack:"#88bbdd",textWhite:"#002244",textBlack:"#001122",gridLine:"#99bbdd",beatLine:"#88aacc",measureLine:"#336699"},Darkroom:{whiteKey:"#2c2c2c",blackKey:"#1e1e1e",labelWhite:"#383838",labelBlack:"#2a2a2a",textWhite:"#a0a0a0",textBlack:"#e0e0e0",gridLine:"#404040",beatLine:"#606060",measureLine:"#808080"}};function Go(e,t,n,o,s,i){const{gridColorScheme:r}=ke(),c=Xt[r]||Xt.Darkroom,a=Le(),l=F(),d=l*o,f=n*s;e.font=`${Math.floor(s*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let u=0;u<n;u++){const m=u*s,h=i(u),p=Jn(h);e.fillStyle=p?c.blackKey:c.whiteKey,e.fillRect(0,m,d,s),e.fillStyle=p?c.labelBlack:c.labelWhite,e.fillRect(-64,m,J,s),e.fillStyle=p?c.textBlack:c.textWhite,e.fillText(h,-8,m+s/2)}e.strokeStyle=c.gridLine,e.lineWidth=1;for(let u=0;u<n;u++){const m=u*s;e.beginPath(),e.moveTo(0,m),e.lineTo(d,m),e.stroke()}for(let u=0;u<=l;u++){const m=u*o,h=u%a===0;e.strokeStyle=h?c.measureLine:c.beatLine,e.lineWidth=h?2:1,e.beginPath(),e.moveTo(m,0),e.lineTo(m,f),e.stroke()}}const zo={Scriabin:(e,{getPitchClass:t})=>{const n=t(e.pitch);return to[n]||"#999"},"Track Color":(e,{getTrackColor:t})=>(t==null?void 0:t(e.trackId))||"#999","Octave Bands":e=>{const t=D(e.pitch);return t==null?"#999":`hsl(${t*3%360}, 100%, 60%)`},"Pitch Class Contrast":(e,{getPitchClass:t})=>{const o=D(e.pitch)%12;return["#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f"][o]||"#999"}};function Ko(e,t,{previewNotes:n=null,hoveredNote:o,selectedNote:s,selectedNotes:i=[],highlightedNotes:r=[],cellWidth:c,cellHeight:a,visibleStartBeat:l,visibleEndBeat:d,getPitchRow:f,getPitchClass:u,getTrackColor:m,drawRoundedRect:h}){const{noteColorScheme:g}=ke(),y=zo[g]||(()=>"#999");for(const E of t){if(E.start+E.duration<l-2||E.start>d)continue;const b=E.start*c,S=f(E.pitch)*a,w=E.duration*c,B=a-1,L=y(E,{getPitchClass:u,getTrackColor:m});e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=r.includes(E)?"rgba(96, 165, 250, 0.6)":L,h(e,b,S,w,B),e.fill();const M=e.createLinearGradient(b,S,b,S+B);M.addColorStop(0,"rgba(255,255,255,0.4)"),M.addColorStop(.2,"rgba(255,255,255,0.15)"),M.addColorStop(.5,"rgba(255,255,255,0.05)"),M.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=M,h(e,b,S,w,B),e.fill();const N=i.includes(E),T=E===o,A=r.includes(E);(N||T||A)&&(e.lineWidth=N?3:2,e.strokeStyle=N?"rgba(0, 255, 255, 1.0)":T?"rgba(255, 255, 255, 0.9)":"rgba(255, 200, 50, 0.7)",h(e,b,S,w,B),e.stroke())}if(n)for(const E of n){const b=E.start*c,S=f(E.pitch)*a,w=E.duration*c,B=a-1,L=y(E,{getPitchClass:u,getTrackColor:m});e.fillStyle=Xo(L,.4),h(e,b,S,w,B),e.fill()}}function Xo(e,t=1){if(e.startsWith("#")){const n=parseInt(e.slice(1),16),o=n>>16&255,s=n>>8&255,i=n&255;return`rgba(${o}, ${s}, ${i}, ${t})`}if(e.startsWith("hsl(")){const[n,o,s]=e.slice(4,-1).split(",").map(a=>parseFloat(a)),[i,r,c]=jo(n,o/100,s/100);return`rgba(${i}, ${r}, ${c}, ${t})`}return e}function jo(e,t,n){const o=(1-Math.abs(2*n-1))*t,s=o*(1-Math.abs(e/60%2-1)),i=n-o/2;let[r,c,a]=[0,0,0];return 0<=e&&e<60?[r,c,a]=[o,s,0]:60<=e&&e<120?[r,c,a]=[s,o,0]:120<=e&&e<180?[r,c,a]=[0,o,s]:180<=e&&e<240?[r,c,a]=[0,s,o]:240<=e&&e<300?[r,c,a]=[s,0,o]:300<=e&&e<360&&([r,c,a]=[o,0,s]),[Math.round((r+i)*255),Math.round((c+i)*255),Math.round((a+i)*255)]}function Yo(e,t,n,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+n,0),e.lineTo(t+n,o),e.stroke(),e.restore()}function Vo(e,t,n,o=J){const s=e.getBoundingClientRect(),i=parseFloat(e.style.width||s.width),r=parseFloat(e.style.height||s.height),c=e.width/i,a=e.height/r,l=(t.clientX-s.left)*c-o,d=(t.clientY-s.top)*a;return{x:l,y:d}}function Qo(e,t,n,o,s,i){const r=Math.floor(t/s),c=e/i;return n.find(a=>c>=a.start&&c<a.start+a.duration&&o(a.pitch)===r)}function Zo(e,t,n,o){const s=e.querySelector(".zoom-in-btn"),i=e.querySelector(".zoom-out-btn"),r=e.querySelector(".zoom-reset-btn");!s||!i||!r||(s.addEventListener("click",t),i.addEventListener("click",n),r.addEventListener("click",o))}function Jo(){for(const e of k){const t=e.container,n=t.querySelector(".sequencer-body"),o=t.querySelector("canvas.mini-contour"),s=t.querySelector(".collapse-btn use");n.classList.contains("hidden")||(n.classList.add("hidden"),o.classList.remove("hidden"),s==null||s.setAttribute("href","#icon-caret-up"),ze(t,!1),He(o,e.notes,e.config,e.colorIndex))}}function W(e){const t=e.match(/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o,s]=t;return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[o]+12*parseInt(s,10)}function We(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}let it=!1,tt=null,z=null;function xo(e){it=!0,tt=e,z=null}function Pt(){var e;z&&(z.gridContext.setPastePreviewNotes(null),z.scheduleRedraw(),(e=z.setCursor)==null||e.call(z,"default")),it=!1,tt=null,z=null,document.body.style.cursor="default"}function qt(){return it}function es(e,t){!it||!tt||(tt(e,t),Pt())}function ts(e){z&&z!==e&&(z.gridContext.setPastePreviewNotes(null),z.scheduleRedraw()),z=e}const se={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let In=se.NOTE_PLACEMENT;const bt=new Set;function Tn(){return In}function Y(e){Pt(),In=e;for(const t of bt)t(e)}function ns(e){return bt.add(e),()=>bt.delete(e)}let _t=!1;function os(){_t=!0,Y(se.SELECT)}function Be(){_t=!1}function Ce(){return _t}let Dt=!1;function Re(e=!0){Dt=e}function jt(){return Dt}function Yt(){Dt=!1}let An={notes:[],anchorBeat:0,anchorMidi:0};function Rn(e){if(e.length===0)return;const t=e[0],n=t.start,o=W(t.pitch);An={notes:e.map(s=>({pitch:s.pitch,start:s.start,duration:s.duration})),anchorBeat:n,anchorMidi:o}}function St(){return An}let Ot=null,Ft=null;function ss(e){Ot=e}function wt(){return Ot}function Vt(){Ot=null}function Qt(e,t,n){Ft={anchorNote:e,startX:t,startY:n,originalDuration:e.duration}}function ct(){return Ft}function is(){Ft=null}function Pn(e,t,n){if(!qt()){e.setPastePreviewNotes(null);return}const{notes:o,anchorBeat:s,anchorMidi:i}=St(),r=e.getSnappedBeatFromX(t),c=e.getPitchFromRow(Math.floor(n/e.getCellHeight())),a=W(c),l=r-s,d=a-i,f=o.map(u=>({pitch:We(W(u.pitch)+d),start:u.start+l,duration:u.duration}));e.setPastePreviewNotes(f),e.scheduleRedraw()}function qn(e){qt()&&e.setPastePreviewNotes(null)}function _n(e,t){return qt()?(es(e.grid,t),t.preventDefault(),t.stopPropagation(),!0):!1}let Pe=null;const rs=8;function Zt(){Pe=null}function as(e,t){Pe={x:e,y:t}}function cs(e,t){if(!Pe)return!1;const n=e-Pe.x,o=t-Pe.y;return Math.sqrt(n*n+o*o)>=rs}let be=null;function Ze(e){be&&be!==e&&be.clearSelection(),be=e}function ls(){be=null}function Ht(){return be}function ds(e,t,{getPitchRow:n,cellWidth:o,cellHeight:s,labelWidth:i}){const r=t.start*o+i,c=n(t.pitch)*s,a=t.duration*o,l=s-1,d=r+a/2,f=c+l/2,m=us(t.pitch)*5%360,h=e.animationCtx,p=performance.now(),g=500,y=3,E=60;function b(B,L,M){const N=Math.sin(B*Math.PI),T=1+L*N,A=(1-B)*M;h.globalAlpha=A,h.strokeStyle=`hsl(${m}, 100%, 65%)`,h.lineWidth=2;const R=a*T,_=l*T;h.beginPath(),h.roundRect(d-R/2,f-_/2,R,_,4),h.stroke()}function S(B){const L=Math.sin(B*Math.PI),N=`hsla(${m}, 100%, 80%, ${.4*L})`;h.globalAlpha=1,h.fillStyle=N,h.beginPath(),h.roundRect(r,c,a,l,3),h.fill()}function w(B){const L=B-p,M=L/g;if(M>1){h.clearRect(0,0,h.canvas.width,h.canvas.height);return}h.clearRect(0,0,h.canvas.width,h.canvas.height),h.save(),S(M);for(let N=0;N<y;N++){const T=N*E,A=Math.max(0,Math.min(1,(L-T)/(g-T)));b(A,.1+N*.1,.2)}h.restore(),requestAnimationFrame(w)}requestAnimationFrame(w)}function us(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}function fs(e,t,{getPitchRow:n,cellWidth:o,cellHeight:s,labelWidth:i}){const r=t.start*o+i,c=n(t.pitch)*s,a=t.duration*o,l=s-1,d=r+a/2,f=c+l/2,m=ms(t.pitch)*5%360,h=e.animationCtx,p=performance.now(),g=300;function y(E){const S=(E-p)/g;if(S>1){h.clearRect(0,0,h.canvas.width,h.canvas.height);return}h.clearRect(0,0,h.canvas.width,h.canvas.height),h.save();const w=1-.4*S,B=1-S,L=a*w,M=l*w;h.globalAlpha=B,h.fillStyle=`hsl(${m}, 100%, 70%)`,h.beginPath(),h.roundRect(d-L/2,f-M/2,L,M,3),h.fill(),h.restore(),requestAnimationFrame(y)}requestAnimationFrame(y)}function ms(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}function lt(e,t,n,o){const s=e.getCellWidth(),i=e.getCellHeight(),r=e.getPitchRow,c=Math.min(10,i*.8),l=(t.start+t.duration)*s+6,d=r(t.pitch)*i+(i-c)/2,f=4,u=l-f,m=l+c+f,h=d-f,p=d+c+f;return n>=u&&n<=m&&o>=h&&o<=p?console.log("Hit resize handle!"):console.log("Missed resize handle."),n>=u&&n<=m&&o>=h&&o<=p}function Jt(e){let t=null,n=null,o=!1;function s(d){var E;if(console.log("ClickHandler called"),Ze(e.grid),jt()){Yt(),e.scheduleRedraw();return}const{x:f,y:u}=e.getCanvasPos(d);if(f<0){const b=e.getPitchFromRow(Math.floor(u/e.getCellHeight()));e.sequencer.playNote(b,.5);return}const m=e.getSnappedBeatFromX(f),h=e.getPitchFromRow(Math.floor(u/e.getCellHeight())),p=F();if(m+e.config.currentDuration>p||e.notes.some(b=>b.pitch===h&&b.start===m))return;e.sequencer.playNote(h,.5);const y={pitch:h,start:m,duration:e.config.currentDuration};q(yo(e.sequencer.id,[y]),Eo(e.sequencer.id,[y])),e.setSelectedNote(null),ds(e,y,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:J}),e.scheduleRedraw(),(E=e.onNotesChanged)==null||E.call(e)}function i(d){d.preventDefault();const{x:f,y:u}=e.getCanvasPos(d),m=e.findNoteAt(f,u);if(!m||e.notes.indexOf(m)===-1)return;fs(e,m,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:J});const p=[m];q(kt(e.sequencer.id,p),It(e.sequencer.id,p)),Yt(),e.setSelectedNote(null),e.scheduleRedraw()}function r(d){if(_n(e,d))return;const{x:f,y:u}=e.getCanvasPos(d),m=e.findNoteAt(f,u),h=wt();if(h&&lt(e,h,f,u)){Qt(h,f,u);return}if(m){if(lt(e,m,f,u)){console.log("Resize mode started!"),Qt(m,f,u);return}Ze(e.grid),e.setSelectedNote(m),t={startX:f,startY:u,anchorNote:m,initialStart:m.start,initialMidi:W(m.pitch),initialNote:{pitch:m.pitch,start:m.start,duration:m.duration}};return}as(f,u),o=!1}function c(d){var y,E,b;e.grid.setCursor("default");const{x:f,y:u}=e.getCanvasPos(d);if(f<0){e.clearPreview();return}const m=ct();if(m){e.grid.setCursor("ew-resize");const{anchorNote:S,startX:w}=m,{x:B}=e.getCanvasPos(d),L=B-w,M=e.getSnappedBeatFromX(L)-e.getSnappedBeatFromX(0),N=Math.max(Wo(),m.originalDuration+M);S.duration=N,e.scheduleRedraw(),(y=e.onNotesChanged)==null||y.call(e);return}Pn(e,f,u),Vt(),e.grid.setCursor("default");const h=((E=e.getSelectedNotes)==null?void 0:E.call(e))??[];for(const S of h)if(lt(e,S,f,u)){ss(S),e.grid.setCursor("ew-resize");break}if(!m&&!o&&cs(f,u)){os(),e.selectionBox={active:!0,startX:f,startY:u,currentX:f,currentY:u},o=!0,Ze(e.grid),Zt();return}const p=e.findNoteAt(f,u),g=e.getSelectedNote();if(e.setHoveredNote(p),ct()||(t&&g?e.grid.setCursor("grabbing"):p&&e.grid.setCursor("grab")),!p&&!t&&!jt()&&!wt()){const S=e.getSnappedBeatFromX(f),w=e.getPitchFromRow(Math.floor(u/e.getCellHeight())),B=F();S+e.config.currentDuration<=B?e.updatePreview({pitch:w,start:S,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&g){const S=f-t.startX,w=e.getSnappedBeatFromX(S)-e.getSnappedBeatFromX(0),B=Math.max(0,t.initialStart+w),L=F();B+g.duration<=L&&(g.start=B);const M=u-t.startY,N=Math.round(M/e.getCellHeight()),T=t.initialMidi-N,A=W(e.config.noteRange[0]),R=W(e.config.noteRange[1]),_=Math.max(A,Math.min(R,T)),P=We(_);P!==g.pitch&&(g.pitch=P,n!==P&&(n=P,e.sequencer.playNote(P,.5))),e.scheduleRedraw(),(b=e.onNotesChanged)==null||b.call(e),Re();return}e.scheduleRedraw()}function a(d){console.log("UpHandler called"),Zt(),o=!1;const f=ct();if(f){const{anchorNote:g,originalDuration:y}=f,E=g.duration;y!==E&&q(Io(e.sequencer.id,[{pitch:g.pitch,start:g.start,newDuration:E}]),To(e.sequencer.id,[{pitch:g.pitch,start:g.start,oldDuration:y}])),is(),Re();return}if(!t||!e.getSelectedNote()){t=null;return}const{anchorNote:u,initialNote:m}=t,h={pitch:u.pitch,start:u.start,duration:u.duration};(m.pitch!==h.pitch||m.start!==h.start)&&q(Tt(e.sequencer.id,[m],[h]),bn(e.sequencer.id,[m],[h])),Re(),t=null}function l(){e.clearPreview(),e.setHoveredNote(null),Vt(),qn(e),e.scheduleRedraw()}return{attach(d){d.addEventListener("click",s),d.addEventListener("contextmenu",i),d.addEventListener("mousemove",c),d.addEventListener("mouseleave",l),d.addEventListener("mousedown",r),d.addEventListener("mouseup",a)},detach(d){d.removeEventListener("click",s),d.removeEventListener("contextmenu",i),d.removeEventListener("mousemove",c),d.removeEventListener("mouseleave",l),d.removeEventListener("mousedown",r),d.removeEventListener("mouseup",a)}}}function xt(e,{startX:t,currentX:n,startY:o,currentY:s,getCellHeight:i,getSnappedBeatFromX:r,getPitchFromRow:c}){const a=Math.min(t,n),l=Math.min(o,s),d=Math.max(t,n),f=Math.max(o,s),u=Math.floor(l/i()),m=Math.floor(f/i()),h=r(a),p=r(d),g=W(c(u)),y=W(c(m));return e.filter(E=>{const b=W(E.pitch),S=E.start,B=E.start+E.duration>h&&S<p,L=b>=y-1&&b<=g+1;return B&&L})}function en(e){let t=null;function n(c){c.preventDefault();const{x:a,y:l}=e.getCanvasPos(c),d=e.findNoteAt(a,l);if(!d)return;const f=e.getSelectedNotes(),u=f.includes(d)?f:[d];u.length&&(e.setSelectedNotes([]),q(kt(e.sequencer.id,u),It(e.sequencer.id,u)),Ce()&&(Be(),Y(se.NOTE_PLACEMENT)))}function o(c){if(_n(e,c))return;const{x:a,y:l}=e.getCanvasPos(c);if(a<0)return;const d=e.findNoteAt(a,l);e.setHoveredNote(d),Ze(e.grid);const f=e.getSelectedNotes();if(d&&f.includes(d)){t={startX:a,startY:l,anchorNote:d,initialNotes:f.map(u=>({note:u,start:u.start,midi:W(u.pitch)}))};return}e.selectionBox={active:!0,startX:a,startY:l,currentX:a,currentY:l},e.clearPreview(),e.setSelectedNote(null)}function s(c){var f,u;ts(e.grid);const{x:a,y:l}=e.getCanvasPos(c),d=e.findNoteAt(a,l);if(e.setHoveredNote(d),Pn(e,a,l),(f=e.selectionBox)!=null&&f.active){e.selectionBox.currentX=a,e.selectionBox.currentY=l;const m=e.selectionBox,h=xt(e.notes,{startX:m.startX,currentX:m.currentX,startY:m.startY,currentY:m.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes(h),e.scheduleRedraw();return}if(t){const m=a-t.startX,h=e.getSnappedBeatFromX(m)-e.getSnappedBeatFromX(0),p=l-t.startY,g=Math.round(p/e.getCellHeight()),y=F(),E=W(e.config.noteRange[0]),b=W(e.config.noteRange[1]);for(const{note:w,start:B,midi:L}of t.initialNotes){const M=Math.max(0,B+h),N=Math.max(E,Math.min(b,L-g)),T=We(N);M+w.duration<=y&&(w.start=M,w.pitch=T)}const S=t.initialNotes.find(w=>w.note===t.anchorNote);if(S){const w=S.note.pitch;t.lastPreviewPitch!==w&&(t.lastPreviewPitch=w,e.sequencer.playNote(w,.5))}e.scheduleRedraw(),(u=e.onNotesChanged)==null||u.call(e)}}function i(c){var a,l;if((a=t==null?void 0:t.initialNotes)!=null&&a.length){const{initialNotes:d}=t,f=d.map(({start:h,midi:p,note:g})=>({pitch:We(p),start:h,duration:g.duration})),u=d.map(({note:h})=>({pitch:h.pitch,start:h.start,duration:h.duration}));f.some((h,p)=>h.pitch!==u[p].pitch||h.start!==u[p].start)&&(q(Tt(e.sequencer.id,f,u),bn(e.sequencer.id,f,u)),Ce()&&(Be(),Y(se.NOTE_PLACEMENT)))}if(t=null,(l=e.selectionBox)!=null&&l.active){const{x:d,y:f}=e.getCanvasPos(c);e.selectionBox.currentX=d,e.selectionBox.currentY=f,e.selectionBox.active=!1;const u=xt(e.notes,{startX:e.selectionBox.startX,currentX:e.selectionBox.currentX,startY:e.selectionBox.startY,currentY:e.selectionBox.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes([]),e.setSelectedNotes(u),e.scheduleRedraw(),Ce()&&(console.log("AUTO EXITED MODE"),e.getSelectedNotes().length===0&&(c.stopPropagation(),Be(),Y(se.NOTE_PLACEMENT),Re())),Re()}}function r(){e.setHoveredNote(null),e.setHighlightedNotes([]),qn(e),e.scheduleRedraw()}return{attach(c){c.addEventListener("mousedown",o),c.addEventListener("mousemove",s),c.addEventListener("mouseup",i),c.addEventListener("mouseleave",r),c.addEventListener("contextmenu",n)},detach(c){c.removeEventListener("mousedown",o),c.removeEventListener("mousemove",s),c.removeEventListener("mouseup",i),c.removeEventListener("mouseleave",r),c.removeEventListener("contextmenu",n)}}}function hs(e,t){const n=t.selectionBox;if(!n)return;const o=n.startX,s=n.startY,i=n.currentX,r=n.currentY,c=Math.min(o,i),a=Math.min(s,r),l=Math.abs(i-o),d=Math.abs(r-s);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),hn(e,c,a,l,d,3),e.stroke(),e.restore()}function gs(e,t,{cellWidth:n,cellHeight:o,getPitchRow:s,isHovered:i=!1}){const r=Math.min(10,o*.8),a=(t.start+t.duration)*n+6,l=s(t.pitch)*o+(o-r)/2;e.save(),e.shadowColor="rgba(0,0,0,0.4)",e.shadowBlur=3,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=i?"rgba(0, 255, 255, 0.95)":"rgba(255, 255, 255, 0.85)",e.beginPath(),e.moveTo(a,l),e.lineTo(a+r,l+r/2),e.lineTo(a,l+r),e.closePath(),e.fill();const d=e.createLinearGradient(a,l,a,l+r);d.addColorStop(0,"rgba(255,255,255,0.9)"),d.addColorStop(.5,"rgba(255,255,255,0.5)"),d.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=d,e.beginPath(),e.moveTo(a,l),e.lineTo(a+r,l+r/2),e.lineTo(a,l+r),e.closePath(),e.fill(),e.restore()}function ps(e,t,n,o,s,i,r){let c=null,a=null,l=null,d=null,f=2;const u=e.getContext("2d"),m=t.getContext("2d"),h=n.getContext("2d");let p=Xe[f].cellWidth,g=Xe[f].cellHeight;const y=D(i.noteRange[1])-D(i.noteRange[0])+1,E=y*g,S=F()*p+J;e.width=S,e.height=E,e.style.width=`${S}px`,e.style.height=`${E}px`,t.width=S,t.height=E,t.style.width=`${S}px`,t.style.height=`${E}px`,n.width=S,n.height=E,n.style.width=`${S}px`,n.style.height=`${E}px`;let w=null;function B(){w!==null&&cancelAnimationFrame(w),w=requestAnimationFrame(L)}function L(){var C;u.clearRect(0,0,e.width,e.height),u.save(),u.translate(J,0),Go(u,i,y,p,g,U),Ko(u,s,{previewNotes:a??(c?[c]:null),hoveredNote:l,selectedNote:d,selectedNotes:j,highlightedNotes:v.getHighlightedNotes(),cellWidth:p,cellHeight:g,visibleStartBeat:0,visibleEndBeat:e.width/p,getPitchRow:P,getPitchClass:Zn,getTrackColor:()=>go(r),drawRoundedRect:hn});for(const O of j)gs(u,O,{cellWidth:p,cellHeight:g,getPitchRow:P,isHovered:O===wt()});(C=v.selectionBox)!=null&&C.active&&hs(u,v),u.restore()}function M(){f<Xe.length-1&&(f++,A())}function N(){f>0&&(f--,A())}function T(){f=2,A()}function A(){const C=Xe[f];p=C.cellWidth,g=C.cellHeight,R()}function R(){const O=F()*p+J,ae=(D(i.noteRange[1])-D(i.noteRange[0])+1)*g;e.width=O,e.height=ae,e.style.width=`${O}px`,e.style.height=`${ae}px`,t.width=O,t.height=ae,t.style.width=`${O}px`,t.style.height=`${ae}px`,n.width=O,n.height=ae,n.style.width=`${O}px`,n.style.height=`${ae}px`,h.clearRect(0,0,n.width,n.height),B()}function _(C){Yo(m,C,J,e.height)}Zo(r.container,M,N,T);function P(C){return D(i.noteRange[1])-D(C)}function U(C){const Ie=D(i.noteRange[1])-C,ae=Math.max(D(i.noteRange[0]),Math.min(D(i.noteRange[1]),Ie));return Qn(ae)}function Q(){const C=document.getElementById("global-mini-contour");C&&V(C,k)}let Z=null,j=[];const v={sequencer:r,grid:null,config:i,notes:s,canvas:e,animationCtx:h,getCellHeight:()=>g,getCellWidth:()=>p,getCanvasPos:C=>Vo(e,C,o,J),findNoteAt:(C,O)=>Qo(C,O,s,P,g,p),scheduleRedraw:B,getPitchFromRow:U,getPitchRow:P,getSnappedBeatFromX:C=>eo(C,i,()=>p),updatePreview:C=>c=C,clearPreview:()=>c=null,getSelectedNote:()=>d,setSelectedNote:C=>{d=C,j=C?[C]:[]},getSelectedNotes:()=>j,setSelectedNotes:C=>{j=C,d=C.length===1?C[0]:null},setHoveredNote:C=>l=C,onNotesChanged:Q};function I(C){Z&&Z.detach(e),Z=C,Z&&Z.attach(e)}function G(){d=null,j=[],l=null,Ke=[],B()}let K=ns(C=>{var O,Ie;c=null,a=null,Ke=[],(O=v.clearPreview)==null||O.call(v),(Ie=v.setPastePreviewNotes)==null||Ie.call(v,null),v.selectionBox&&(v.selectionBox.active=!1,v.selectionBox=null),G(),I(C==="note-placement"?Jt(v):C==="select"?en(v):null),B()});const fe={canvas:e,scheduleRedraw:B,drawPlayhead:_,getSelectedNote:()=>d,clearSelection:G,getPreviewNote:()=>c,zoomIn:M,zoomOut:N,getXForBeat:C=>C*p,setMouseHandler:I,setCursor:C=>{e.style.cursor=C},gridContext:v,getSelectedNotes:()=>j,setSelectedNotes:C=>{j=C,d=C.length===1?C[0]:null},destroy(){K(),ls()}},Ut=Tn();let Gt=null,zt=null;Ut==="note-placement"?(Gt=Jt(v),I(Gt)):Ut==="select"?(zt=en(v),I(zt)):I(null),v.setPastePreviewNotes=C=>{a=C};let Ke=[];return v.getHighlightedNotes=()=>Ke,v.setHighlightedNotes=C=>{Ke=C},v.grid=fe,fe}const ys={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function rt(e){const t=e.match(/^([A-Ga-g][#b]?)(-?\d+)$/);if(!t)return null;const[,n,o]=t,s=n.toUpperCase(),i=ys[s];return i===void 0?null:12*(parseInt(o,10)+1)+i}function Es(e,t,{getPitchRow:n,cellWidth:o,cellHeight:s,labelWidth:i}){if(!(e!=null&&e.animationCtx)){console.warn("Missing animationCtx in animateNotePlay");return}const r=t.start*o+i,c=n(t.pitch)*s,a=t.duration*o,l=s-1,d=r+a/2,f=c+l/2,m=bs(t.pitch)*5%360,h=e.animationCtx,p=document.createElement("canvas");p.width=h.canvas.width,p.height=h.canvas.height;let g=p.getContext("2d");const y=performance.now(),E=de();let b=t.duration*6e4/E;b=Math.max(100,Math.min(b,1600));const S=2,w=50;function B(N){const T=Math.sin(N*Math.PI),A=`hsla(${m}, 100%, 70%, ${.4*T})`;g.globalAlpha=1,g.fillStyle=A,g.beginPath(),g.roundRect(r,c,a,l,3),g.fill()}function L(N,T,A){const R=Math.sin(N*Math.PI),_=1+T*R,P=(1-N)*A;g.globalAlpha=P,g.strokeStyle=`hsl(${m}, 100%, 65%)`,g.lineWidth=1.5;const U=a*_,Q=l*_;g.beginPath(),g.roundRect(d-U/2,f-Q/2,U,Q,4),g.stroke()}function M(N){const T=N-y,A=T/b;if(A>1){g=null,p.width=0,p.height=0;return}g.clearRect(0,0,p.width,p.height),g.save(),B(A);for(let U=0;U<S;U++){const Q=U*w,Z=Math.max(0,Math.min(1,(T-Q)/(b-Q)));L(Z,.1+U*.1,.3)}g.restore(),h.save();const R=1.5,_=a*R+8,P=l*R+8;h.clearRect(d-_/2,f-P/2,_,P),h.globalAlpha=1,h.drawImage(p,0,0),h.restore(),requestAnimationFrame(M)}requestAnimationFrame(M)}function bs(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}class Dn{constructor(t,n,o=re,s=ne,i="fluidr3-gm/acoustic_grand_piano"){this.container=t,this.config={...n},this.context=o,this.destination=s,this.instrumentName=i,this.notes=[],this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.isMuted=!1,this.isSoloed=!1,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this._initCanvases())}async initInstrument(){try{await nt(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){const t=this.container.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument(),console.log(`[SEQ:${this.id}] Instrument set to:`,t)}playNote(t,n,o=100,s=!1){return Zs(this.instrumentName,t,n,o,s)}_initCanvases(){const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),o=this.container.querySelector("#grid-scroll-container"),s=this.container.querySelector("canvas.note-animate-canvas");this.grid=ps(t,n,s,o,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(t){const n=F();this.clampNotesToGrid();const o=n*this.config.cellWidth+(this.config.labelWidth||64),s=this.container.querySelector("canvas.note-grid"),i=this.container.querySelector(".playhead-canvas"),r=this.container.querySelector(".mini-contour");s&&(s.width=o,s.style.width=`${o}px`),i&&(i.width=o,i.style.width=`${o}px`),r&&He(r,this.notes,this.config,this.colorIndex),this.redraw()}clampNotesToGrid(){const t=F(),n=this.notes.filter(o=>o.start<t);n.forEach(o=>{o.start+o.duration>t&&(o.duration=t-o.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear(),this._beatHandler=t=>{var o,s;if((o=this.grid)==null||o.drawPlayhead(this.grid.getXForBeat(t)),!this.shouldPlay)return;const n=60/de();for(const i of this.notes){const r=i.start,c=i.start+i.duration;if(!this._activeNotes.has(i)&&r<=t&&t<=c){const a=i.duration*n;if(this.playNote(i.pitch,a),(s=this.grid)!=null&&s.gridContext){const l=this.grid.gridContext;Es(l,i,{getPitchRow:l.getPitchRow,cellWidth:l.getCellWidth(),cellHeight:l.getCellHeight(),labelWidth:J})}this._activeNotes.add(i)}}},this._unsub=gt(this._beatHandler),this._beatHandler(0)}stop(){var t,n,o;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const s of this._activeNotes){const i=this._noteHandlers.get(s);(t=i==null?void 0:i.forceStop)==null||t.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(o=this.grid)==null||o.drawPlayhead(null),this.redraw()}pause(){var t;for(const n of this._activeNotes){const o=this._noteHandlers.get(n);(t=o==null?void 0:o.stop)==null||t.call(o)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=gt(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.isMuted=!this.isMuted,this.isMuted&&(this.isSoloed=!1),this.updateTrackStyle()}toggleSolo(){this.isSoloed=!this.isSoloed,this.isSoloed&&(this.isMuted=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t.classList.toggle("bg-red-600",this.isMuted),t.classList.toggle("bg-gray-700",!this.isMuted),n.classList.toggle("bg-yellow-200",this.isSoloed),n.classList.toggle("bg-gray-700",!this.isSoloed),this.container.classList.toggle("opacity-40",this.isMuted&&!this.isSoloed),this.container.classList.toggle("opacity-100",!(this.isMuted&&!this.isSoloed))}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,o,s])=>({pitch:n,start:o,duration:s})))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:o}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),o&&(this.instrumentName=o),this.redraw()}async exportToOffline(){const t=60/de(),n=await nt(this.instrumentName,this.context,this.destination);for(const o of this.notes){const s=o.start*t,i=o.duration*t;n.start({note:rt(o.pitch),duration:i,velocity:100,time:s,loop:!1})}}}const $={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0},k=[],Ss=document.getElementById("sequencers-container"),ws=document.getElementById("sequencer-template"),On=document.getElementById("add-sequencer");function ze(e,t){var n,o,s,i,r;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-out-btn"))==null||o.classList.toggle("hidden",!t),(s=e.querySelector(".zoom-reset-btn"))==null||s.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!t),(r=e.querySelector(".grip-handle"))==null||r.classList.toggle("hidden",!t)}function ie(){return k}function vs(e){const t=String(e);return ie().find(n=>{var o;return String(n.id)===t||String((o=n.config)==null?void 0:o.id)===t})}function tn(){const e=k.some(t=>t.solo);k.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function Te(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function Fn(e){const n=ws.content.cloneNode(!0).querySelector(".sequencer");Ss.insertBefore(n,On);const o=k.length,s=e?{id:o,...$,...e.config}:{id:o,...$},i=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",r=new Dn(n,s,re,ne,i);r.id=o,r.colorIndex=o,r.mute=!1,r.solo=!1,r.shouldPlay=!0;const c=n.querySelector("canvas.mini-contour");e&&r.setState(e),He(c,r.notes,r.config,r.colorIndex),r.updateTrackLabel(),r.initInstrument();const a=n.querySelector(".collapse-btn"),l=a.querySelector("use"),d=n.querySelector(".sequencer-body");a.addEventListener("click",()=>{const p=d.classList.toggle("hidden");l.setAttribute("href",p?"#icon-caret-up":"#icon-caret-down"),c.classList.toggle("hidden",!p),ze(n,!p),p&&He(c,r.notes,r.config,r.colorIndex)}),n.querySelector(".delete-btn").addEventListener("click",()=>{const p=document.getElementById("delete-confirm-modal"),g=document.getElementById("delete-confirm"),y=document.getElementById("delete-cancel");p.classList.remove("hidden");const E=()=>{const w=uo(r.id,r.instrumentName,r.notes),B=fo(r.id,r.instrumentName,r.notes);q(w,B),S()},b=()=>{S()},S=()=>{p.classList.add("hidden"),g.removeEventListener("click",E),y.removeEventListener("click",b)};g.addEventListener("click",E),y.addEventListener("click",b)});const u=n.querySelector(".mute-btn"),m=n.querySelector(".solo-btn"),h=n.querySelector(".instrument-select-btn");return u.addEventListener("click",()=>{r.mute=!r.mute,r.mute&&(r.solo=!1,m.classList.remove("bg-yellow-200"),m.classList.add("bg-gray-700"),m.classList.remove("hover:bg-yellow-400"),m.classList.add("hover:bg-purple-700"),Te(m,!1)),Te(u,r.mute),tn();const p=xe();r.seekTo(p)}),m.addEventListener("click",()=>{r.solo=!r.solo,r.solo&&(r.mute=!1,Te(u,!1)),m.classList.toggle("bg-yellow-200",r.solo),m.classList.toggle("bg-gray-700",!r.solo),m.classList.toggle("hover:bg-yellow-400",r.solo),m.classList.toggle("hover:bg-purple-700",!r.solo),tn();const p=xe();r.seekTo(p)}),h.addEventListener("click",async()=>{const p=document.getElementById("instrument-select-modal"),g=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const y=r.instrumentName||"fluidr3-gm/acoustic_grand_piano",[E,b]=y.split("/");g.value=E,g.dispatchEvent(new CustomEvent("change",{detail:{preselect:y}})),p.dataset.currentSequencer=r.id,p.classList.remove("hidden")}),Hs(n),Te(u,!1),Te(m,!1),m.classList.add("hover:bg-purple-700"),k.push(r),{seq:r,wrapper:n}}function Bs(){k.slice().forEach(n=>n.destroy()),k.length=0;const e=Ge(),t=structuredClone(e);t.sequencers=[],Fo(),wn(t),Ue(t)}function Cs(){document.getElementById("global-mini-contour"),On.addEventListener("click",()=>{const e=k.length;q(En(e,"fluidr3-gm/acoustic_grand_piano"),Nt(e))})}function Ms(){localStorage.setItem("userConfig",JSON.stringify(ke()))}function Ls(){const e=localStorage.getItem("userConfig");if(e){const t=JSON.parse(e);$e(t)}}Ls();const nn=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];function vt(){return ke().openaiApiKey}function on(){return ke().openaiModel}function Ns(e){$e({openaiApiKey:e})}function ks(e){if(!nn.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${nn.join(", ")}`);$e({openaiModel:e})}function Is(){var s;const e=document.getElementById("openai-key-input"),t=document.getElementById("openai-model-select"),n=document.getElementById("config-save"),o=document.querySelectorAll("#config-close, #config-close-bottom");e.value=vt(),t.value=on(),n.addEventListener("click",()=>{Ns(e.value),ks(t.value),Ms(),document.getElementById("userconfig-modal").classList.add("hidden")}),o.forEach(i=>{i.addEventListener("click",()=>{e.value=vt(),t.value=on(),document.getElementById("userconfig-modal").classList.add("hidden")})}),(s=document.getElementById("key-not-set-ok"))==null||s.addEventListener("click",()=>{var i;(i=document.getElementById("openai-key-not-set-modal"))==null||i.classList.add("hidden")})}const Ts=["Darkroom","Seashell","Cyberpunk","Classic Blue","Midnight"],As=["Track Color","Pitch Class Contrast","Scriabin","Octave Bands"];function Rs(){const e=document.getElementById("grid-color-select"),t=document.getElementById("note-color-select");for(const o of Ts){const s=document.createElement("option");s.value=o,s.textContent=o,e.appendChild(s)}for(const o of As){const s=document.createElement("option");s.value=o,s.textContent=o,t.appendChild(s)}const n=ke();e.value=n.gridColorScheme,t.value=n.noteColorScheme,e.addEventListener("change",o=>{$e({gridColorScheme:o.target.value}),ie().forEach(s=>{var i;return(i=s.grid)==null?void 0:i.scheduleRedraw()})}),t.addEventListener("change",o=>{$e({noteColorScheme:o.target.value}),ie().forEach(s=>{var i;return(i=s.grid)==null?void 0:i.scheduleRedraw()})})}function Ps(){document.getElementById("userconfig-modal");const e=document.querySelectorAll(".settings-tab"),t=document.querySelectorAll(".settings-section");function n(){e.forEach(o=>{const s=o.dataset.tab,i=document.getElementById(s),r=i&&!i.classList.contains("hidden");o.classList.toggle("text-purple-500",r),o.classList.toggle("opacity-100",r),o.classList.toggle("text-gray-500",!r),o.classList.toggle("opacity-50",!r)})}e.forEach(o=>{o.addEventListener("click",()=>{const s=o.dataset.tab;t.forEach(r=>r.classList.add("hidden"));const i=document.getElementById(s);i&&i.classList.remove("hidden"),n()})}),n(),Is(),Rs()}const qs={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"};let sn=!1,me=!1,he=!1;function _s({getSequencers:e,onPlay:t,onStop:n,onPause:o,onResume:s,onDurationChange:i,onSnapChange:r,onToggleLoop:c,onTempoChange:a,onSave:l,onLoad:d,onMeasuresChange:f,onBeatsPerMeasureChange:u}){if(sn)return;sn=!0;const m=document.getElementById("play-button"),h=m.querySelector("use"),p=document.getElementById("stop-button"),g=document.getElementById("note-duration"),y=document.getElementById("dotted-note-btn"),E=document.getElementById("triplet-note-btn");g.value=String($.currentDuration||1);const b=document.getElementById("snap-resolution");b.value=String($.snapResolution||.25);const S=document.getElementById("loop-toggle"),w=document.getElementById("tempo-input"),B=document.getElementById("save-button"),L=document.getElementById("load-button"),M=document.getElementById("load-input"),N=document.getElementById("measures-input"),T=document.getElementById("beats-per-measure-input"),A=document.getElementById("config-button"),R=document.getElementById("export-modal"),_=document.getElementById("export-json"),P=document.getElementById("export-wav"),U=document.getElementById("export-midi"),Q=document.getElementById("export-cancel");h.setAttribute("href","#icon-play"),m.addEventListener("click",()=>{!me&&!he?(me=!0,he=!1,t==null||t(),h.setAttribute("href","#icon-pause")):me?(me=!1,he=!0,o==null||o(),h.setAttribute("href","#icon-play")):he&&(me=!0,he=!1,s==null||s(),h.setAttribute("href","#icon-pause"))}),p.addEventListener("click",()=>{n==null||n(),me=!1,he=!1,h.setAttribute("href","#icon-play")});const Z={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125};window.addEventListener("keydown",v=>{var K;if(document.querySelector(".ai-modal:not(.hidden)"))return;const G=(K=document.activeElement)==null?void 0:K.tagName;if(!(G==="INPUT"||G==="TEXTAREA")){if(v.code==="Space"){v.preventDefault(),m.click();return}if((v.metaKey||v.ctrlKey)&&(v.key==="z"&&Do(),v.key==="y"&&Oo()),(v.metaKey||v.ctrlKey)&&v.key.toLowerCase()==="r"){v.preventDefault();return}if(Tn()===se.NOTE_PLACEMENT){if(Z.hasOwnProperty(v.code)){v.preventDefault();const fe=Z[v.code];g.value=fe,g.dispatchEvent(new Event("change"))}if(v.key==="."){v.preventDefault(),y==null||y.click();return}if(v.key==="/"){v.preventDefault(),E==null||E.click();return}}}}),g.addEventListener("change",v=>{const I=parseFloat(v.target.value);j(I),i==null||i(I),e==null||e().forEach(G=>{const K=G.grid;if(K!=null&&K.getPreviewNote){const fe=K.getPreviewNote();fe&&(fe.duration=I,K.scheduleRedraw())}})});function j(v){document.querySelectorAll(".note-duration-btn").forEach(G=>{const K=parseFloat(G.dataset.value);G.classList.remove("bg-purple-700"),G.classList.remove("bg-gray-800"),K===v?G.classList.add("bg-purple-700"):G.classList.add("bg-gray-800")})}b.addEventListener("change",v=>{const I=v.target.value;qs.hasOwnProperty(I)&&($.snapResolution=parseFloat(I),b.value=String(I),r==null||r($.snapResolution))}),S.addEventListener("change",v=>{c==null||c(v.target.checked)}),w.addEventListener("change",v=>{const I=parseInt(v.target.value,10);isNaN(I)||a==null||a(I)}),B.addEventListener("click",()=>{R?R.classList.remove("hidden"):l==null||l("json")}),L.addEventListener("click",()=>{M.click()}),M.addEventListener("change",v=>{const I=v.target.files[0];I&&(d==null||d(I)),v.target.value=""}),_&&_.addEventListener("click",()=>{R.classList.add("hidden"),l==null||l("json")}),P&&P.addEventListener("click",()=>{R.classList.add("hidden"),l==null||l("wav")}),U&&U.addEventListener("click",()=>{R.classList.add("hidden"),l==null||l("midi")}),Q&&Q.addEventListener("click",()=>{R.classList.add("hidden")}),A.addEventListener("click",()=>{document.getElementById("userconfig-modal").classList.remove("hidden")}),Ps(),N.value=Ne(),T.value=Le(),N.addEventListener("change",v=>{const I=parseInt(v.target.value,10);!isNaN(I)&&I>0&&(f==null||f(I))}),T.addEventListener("change",v=>{const I=parseInt(v.target.value,10);!isNaN(I)&&I>0&&(u==null||u(I))}),j(parseFloat(g.value))}function Ds(){me=!1,he=!1;const t=document.getElementById("play-button").querySelector("use");t&&t.setAttribute("href","#icon-play")}function Os(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function Fs(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}function Hs(e){const t=e.querySelector(".cursor-grab");if(!t)return;const n=e.querySelector(".sequencer-body");if(!n)return;let o=!1,s=0,i=0;const r=150,c=1e3;t.addEventListener("mousedown",a=>{o=!0,s=a.clientY,i=n.offsetHeight,t.classList.replace("cursor-grab","cursor-grabbing"),document.body.style.userSelect="none"}),window.addEventListener("mousemove",a=>{if(!o)return;const l=a.clientY-s;let d=i+l;d=Math.max(r,Math.min(c,d)),n.style.height=`${d}px`}),window.addEventListener("mouseup",()=>{o&&(o=!1,t.classList.replace("cursor-grabbing","cursor-grab"),document.body.style.userSelect="")})}let H=null,qe=0;const dt=new Map;async function ue(){H||(H=await un(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function Hn(){return re}async function nt(e,t=re,n=null){await ue();const[o,s]=e.includes("/")?e.split("/"):["musyngkite",e],i=t instanceof OfflineAudioContext;dt.has(t)||dt.set(t,new Map);const r=dt.get(t),c=`${o}/${s}`;if(r.has(c))return r.get(c);let a;if(o==="smolken")a=new H.Smolken(t,{instrument:s,destination:n||ne,disableScheduler:i}),await pe(a.load);else if(o==="splendidgrandpiano")a=new H.SplendidGrandPiano(t,{destination:n||ne,disableScheduler:i}),await pe(a.load);else if(o==="electricpiano")a=new H.ElectricPiano(t,{instrument:s,destination:n||ne,disableScheduler:i}),await pe(a.load);else if(o==="mallets")a=new H.Mallet(t,{instrument:s,destination:n||ne,disableScheduler:i}),await pe(a.load);else if(o==="drummachines"){a=new H.DrumMachine(t,{instrument:s,destination:n||ne,disableScheduler:i}),await pe(a.load);const l=a.getSampleNames(),d=new Map;l.forEach((f,u)=>{const m=36+u;d.set(m,f)}),a.__midiMap=d}else{const d={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[o.toLowerCase()]||"MusyngKite",f=await Xs();console.log(`[Soundfont] Available kits: ${f.join(", ")}`),console.log(`[Soundfont] Requested: kit=${d} instrument=${s}`);const m=`https://gleitz.github.io/midi-js-soundfonts/${d}/${s}-ogg.js`;a=new H.Soundfont(t,{instrument:s,instrumentUrl:m,kit:d,destination:n||ne,disableScheduler:i}),await pe(a.load)}return r.set(c,a),a}async function $s(){return await ue(),H.getMalletNames()}async function Ws(){return await ue(),H.getElectricPianoNames()}async function Us(){return await ue(),["splendidgrandpiano"]}async function Gs(){return await ue(),H.getDrumMachineNames()}async function zs(){return await ue(),H.getSmolkenNames()}async function Ks(e="MusyngKite"){await ue();const t=await H.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function Xs(){return await ue(),H.getSoundfontKits()}function js(){qe++,qe===1&&Os()}function Ys(){qe--,qe<=0&&(qe=0,Fs())}async function pe(e){js();try{await e}finally{Ys()}}let ce=null,Bt=null;async function rn(e){if(Bt===e)return;ce=await nt(e),Bt=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function Vs(){return Bt}function $n(e,t=100,n=!1){var c;if(!ce)return null;const s=Hn().currentTime,i=rt(e),r=((c=ce.__midiMap)==null?void 0:c.get(i))??i;return ce.start({note:r,stopId:r,velocity:t,time:s,loop:n}),()=>{ce.stop({stopId:r})}}function Qs(e){var o;if(!ce)return;const t=rt(e),n=((o=ce.__midiMap)==null?void 0:o.get(t))??t;ce.stop({stopId:n})}async function Zs(e,t,n,o=100,s=!1,i=null,r=null,c=null){var u;const a=r||Hn(),l=await nt(e,a,c),d=rt(t),f=((u=l.__midiMap)==null?void 0:u.get(d))??d;return l.start({note:f,duration:n,velocity:o,loop:s,time:i??a.currentTime}),null}const re=new(window.AudioContext||window.webkitAudioContext),at=re.createAnalyser();at.fftSize=2048;const ne=re.createGain();ne.connect(at);at.connect(re.destination);function Js(e){re.resume();try{const t=$n(e,100,20);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}re.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let an=!1,je=null;function xs(e,t){if(an)return;an=!0,je=t;const n=e.getContext("2d"),o=new Map,s=new Set;function i(d,f){const u=je();for(const m of Object.values(u))if(m.isBlack&&d>=m.x&&d<=m.x+m.width&&f>=0&&f<=m.height)return m.note;for(const m of Object.values(u))if(!m.isBlack&&d>=m.x&&d<=m.x+m.width&&f>=0&&f<=m.height)return m.note;return null}function r(d){if(!d||s.has(d))return;const f=Js(d);f&&(o.set(d,f),s.add(d),Fe(n,je(),s))}function c(d){if(!s.has(d))return;const f=o.get(d);f&&(f.stop(),o.delete(d)),s.delete(d),Fe(n,je(),s)}function a(){for(const d of s)c(d)}let l=!1;e.addEventListener("mousedown",d=>{l=!0;const f=e.getBoundingClientRect(),u=d.clientX-f.left,m=d.clientY-f.top,h=i(u,m);r(h)}),e.addEventListener("mousemove",d=>{if(!l)return;const f=e.getBoundingClientRect(),u=d.clientX-f.left,m=d.clientY-f.top,h=i(u,m);r(h)}),e.addEventListener("mouseup",()=>{l=!1,a()}),e.addEventListener("mouseleave",()=>{l=!1,a()})}const Wn=[..."qwertyuiop[zxcvbnm,./"],Un=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];let Ct=!1,Ye=null,_e=null,De=null;function ei(e,t){if(Ct)return;Ct=!0;const n=e.getContext("2d"),o=new Set,s=new Set,i=new Map,r=Wn,c=Un;Ye=t;function a(){const f=Ye(),u=Object.values(f).filter(p=>!p.isBlack).sort((p,g)=>p.x-g.x).map(p=>p.note),m=Object.values(f).filter(p=>p.isBlack).sort((p,g)=>p.x-g.x).map(p=>p.note),h={};return r.forEach((p,g)=>{u[g]&&(h[p]=u[g])}),c.forEach((p,g)=>{m[g]&&(h[p]=m[g])}),h}function l(f){const u=a(),m=u[f];if(!(!m||o.has(f))){if(o.add(f),!s.has(m)){const h=$n(m,100,oi());h&&(i.set(m,{stop:h}),s.add(m))}Fe(n,Ye(),s,u)}}function d(f){const u=a(),m=u[f];m&&(o.delete(f),s.has(m)&&(Qs(m),i.delete(m),s.delete(m)),Fe(n,Ye(),s,u))}_e=f=>{f.repeat||l(f.key)},De=f=>{d(f.key)},window.addEventListener("keydown",_e),window.addEventListener("keyup",De)}function ti(){_e&&(window.removeEventListener("keydown",_e),_e=null),De&&(window.removeEventListener("keyup",De),De=null),Ct=!1}let Ee=3,ye=fn(Ee),Ve=!1;async function ni(e){const t=e.getContext("2d");await rn("fluidr3-gm/acoustic_grand_piano");const n=Wn,o=Un;function s(){const g=Object.values(ye).filter(b=>!b.isBlack).sort((b,S)=>b.x-S.x).map(b=>b.note),y=Object.values(ye).filter(b=>b.isBlack).sort((b,S)=>b.x-S.x).map(b=>b.note),E={};return n.forEach((b,S)=>{g[S]&&(E[b]=g[S])}),o.forEach((b,S)=>{y[S]&&(E[b]=y[S])}),E}function i(){ye=fn(Ee);const g=Ve?s():null;Fe(t,ye,new Set,g)}xs(e,()=>ye),i(),document.getElementById("octave-up").addEventListener("click",()=>{Ee<7&&(Ee++,i())}),document.getElementById("octave-down").addEventListener("click",()=>{Ee>1&&(Ee--,i())});const r=document.getElementById("disable-keyboard-inputs");r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700"),r.addEventListener("click",()=>{Ve=!Ve,Ve?(ei(e,()=>ye),r.classList.remove("bg-gray-700"),r.classList.add("bg-purple-600")):(ti(),r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700")),i()});const c=document.getElementById("instrument-select-btn"),a=document.getElementById("instrument-select-modal"),l=document.getElementById("instrument-select"),d=document.getElementById("instrument-select-confirm"),f=document.getElementById("instrument-cancel-btn"),u=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([g,y])=>{const E=document.createElement("option");E.value=g,E.textContent=g.replace(/_/g," ").replace(/\b\w/g,b=>b.toUpperCase()),u.appendChild(E)}),u.addEventListener("change",async g=>{var S;const y=u.value,E=document.getElementById("instrument-select"),b=((S=g.detail)==null?void 0:S.preselect)||null;try{let w;y==="mallets"?w=await $s():y==="electricpiano"?w=await Ws():y==="splendidgrandpiano"?w=await Us():y==="drummachines"?w=await Gs():y==="smolken"?w=await zs():["fluidr3-gm","musyngkite","fatboy"].includes(y)?w=await Ks({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[y]):w=await(await fetch(`/static/${y}.json`)).json(),E.innerHTML="",w.forEach(B=>{const L=document.createElement("option");L.value=`${y}/${B}`,L.textContent=B.split("_").map(M=>M.charAt(0).toUpperCase()+M.slice(1)).join(" "),E.appendChild(L)}),E.value=b||`${y}/${w[0]}`}catch(w){console.error(`Failed to load instruments for library: ${y}`,w)}}),u.dispatchEvent(new Event("change")),c.addEventListener("click",async()=>{const g=Vs()||"fluidr3-gm/acoustic_grand_piano",[y,E]=g.split("/");u.value=y,await u.dispatchEvent(new CustomEvent("change",{detail:{preselect:g}})),a.classList.remove("hidden"),delete a.dataset.currentSequencer}),d.addEventListener("click",async()=>{const g=l.value;a.classList.add("hidden");const y=a.dataset.currentSequencer;if(y){console.log("[Modal] Looking up sequencer with id:",y);const E=vs(y);console.log("[Modal] Lookup result:",E),E&&E.setInstrument(g),a.dataset.currentSequencer=""}else try{await rn(g)}catch(E){console.error("Failed to load global instrument:",g,E)}});let h=!1;const p=document.getElementById("instrument-loop-toggle");p.addEventListener("change",()=>{h=p.checked,console.log("[UI] Loop mode:",h)}),f.addEventListener("click",()=>{a.classList.add("hidden")})}function oi(){var e;return((e=document.getElementById("instrument-loop-toggle"))==null?void 0:e.checked)||!1}function si(e,t){const n=t.getContext("2d"),o=t.width,s=t.height,i=new Uint8Array(e.fftSize),r=new Uint8Array(e.frequencyBinCount),c=document.createElement("canvas");c.width=o,c.height=s;const a=c.getContext("2d");let l="frequency";function d(){e.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,o,s),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const h=o/i.length;let p=0;for(let g=0;g<i.length;g++){const E=i[g]/128*s/2;g===0?n.moveTo(p,E):n.lineTo(p,E),p+=h}n.lineTo(o,s/2),n.stroke()}function f(){e.getByteFrequencyData(r),n.fillStyle="#000",n.fillRect(0,0,o,s),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,s),n.fillRect(o-1,0,1,s);const h=128,p=2,g=[];for(let y=0;y<h;y++)g.push(y*o/(h-1));g[g.length-1]=o-1;for(let y=0;y<h;y++){const E=g[y],b=y<h-1?g[y+1]:o,S=Math.max(1,b-E-p),w=20,B=2e4,L=y/(h-1),M=w*Math.pow(B/w,L),T=Math.min(r.length-1,Math.floor(M/22050*r.length)),A=r[T]/255,R=Math.max(1,A*s),_=240-L*240;n.fillStyle=`hsl(${_}, ${80+A*20}%, ${40+A*40}%)`,n.fillRect(E,s-R,S,R)}}function u(){e.getByteFrequencyData(r),c.initialized||(a.fillStyle="#000",a.fillRect(0,0,o,s),c.initialized=!0),a.drawImage(c,-1,0),a.fillStyle="#000",a.fillRect(o-1,0,1,s);const h=128,p=20,g=2e4;for(let y=0;y<h;y++){const E=y/(h-1),b=p*Math.pow(g/p,E),w=Math.min(r.length-1,Math.floor(b/22050*r.length)),B=r[w]/255,L=s-1-Math.floor(y*s/h);if(B<.05)continue;const M=Math.floor(B*255),N=Math.floor(B*(255-E*200)),T=Math.floor(B*(100+E*155));a.fillStyle=`rgb(${M}, ${N}, ${T})`,a.fillRect(o-1,L,1,1)}n.fillStyle="#000",n.fillRect(0,0,o,s),n.drawImage(c,0,0)}function m(){switch(requestAnimationFrame(m),l){case"frequency":f();break;case"spectrogram":u();break;case"waveform":default:d()}}return m(),{setMode(h){["waveform","frequency","spectrogram"].includes(h)&&(l=h,n.clearRect(0,0,o,s),l==="spectrogram"&&a.clearRect(0,0,o,s))}}}function ii(e,t){const n=si(at,e),o=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let s=0;function i(){s=(s+1)%o.length;const{name:r,emoji:c}=o[s];n.setMode(r),t.textContent=c,t.title=`Mode: ${r}`}t.addEventListener("click",i),i()}function ri(){var f;const e=document.getElementById("global-mini-expand-btn"),t=document.getElementById("global-mini-contour"),n=document.getElementById("global-mini-playhead"),o=(f=t==null?void 0:t.parentElement)==null?void 0:f.parentElement,s=t==null?void 0:t.parentElement,i=e.querySelector("svg use"),r=document.querySelector(".footer-spacer"),c=40;let a=!1;function l(u,m){const h=u.offsetWidth;u.style.height=m+"px",u.height=m,u.width=h}o.style.height=c+"px",s.style.height=c+"px",l(t,c),l(n,c),V(t,ie());function d(){a=!a;const u=a?200:40;o.style.height=u+"px",s.style.height=u+"px",l(t,u),l(n,u),i.setAttribute("href",a?"#icon-caret-down":"#icon-caret-up"),r.style.height=u-40+140+"px",V(t,ie())}e==null||e.addEventListener("click",d)}function ai(e){if(!e.length)throw new Error("No tracks to export.");const t=de(),n=Le(),o=Ne(),s={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:o},i:e.map(r=>r.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.map(({notes:r})=>({n:r.map(c=>[c.pitch,c.start,c.duration])}))},i=new Blob([JSON.stringify(s)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function ci(e){if(!e.length)return;const n=60/de(),o=Math.max(...e.flatMap(d=>d.notes.map(f=>(f.start+f.duration)*n+.2))),s=44100,i=new OfflineAudioContext(2,Math.ceil(s*o),s);for(const d of e){const f=d.instrument||"fluidr3-gm/acoustic_grand_piano",u=new Dn(null,d.config,i,i.destination,f);u.setState(d),await u.exportToOffline()}const r=await i.startRendering(),c=li(r),a=URL.createObjectURL(c),l=document.createElement("a");l.href=a,l.download=`session-${Date.now()}.wav`,l.click(),URL.revokeObjectURL(a)}function li(e){const t=e.numberOfChannels,n=e.length*t*2,o=new DataView(new ArrayBuffer(44+n)),s=(r,c)=>{for(let a=0;a<c.length;a++)o.setUint8(r+a,c.charCodeAt(a))};s(0,"RIFF"),o.setUint32(4,36+n,!0),s(8,"WAVE"),s(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,t,!0),o.setUint32(24,e.sampleRate,!0),o.setUint32(28,e.sampleRate*t*2,!0),o.setUint16(32,t*2,!0),o.setUint16(34,16,!0),s(36,"data"),o.setUint32(40,n,!0);let i=44;for(let r=0;r<e.length;r++)for(let c=0;c<t;c++){const a=e.getChannelData(c)[r],l=Math.max(-1,Math.min(1,a));o.setInt16(i,l*32767,!0),i+=2}return new Blob([o.buffer],{type:"audio/wav"})}async function di(e){var r,c,a;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const o={bpm:((r=n.c)==null?void 0:r.b)??120,beatsPerMeasure:((c=n.c)==null?void 0:c.bpm)??4,totalMeasures:((a=n.c)==null?void 0:a.tm)??8},s=Array.isArray(n.i)?n.i:[];return{tracks:n.tr.map((l,d)=>{if(!Array.isArray(l.n))throw new Error(`Track ${d} missing \`n\` (notes) array.`);const f=l.n.map(([m,h,p])=>({pitch:m,start:h,duration:p})),u=s[d]||"fluidr3-gm/acoustic_grand_piano";return{notes:f,instrument:u}}),globalConfig:o}}function ui(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),o=document.getElementById("triplet-note-btn");let s=!1,i=!1;function r(a){a=parseFloat(a);let l=a;s?l=a*1.5:i&&(l=a*(2/3));let d=Array.from(t.options).find(f=>Math.abs(parseFloat(f.value)-l)<1e-4);d||(d=new Option(l.toString(),l.toString()),t.add(d)),t.value=d.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(d=>d.classList.remove("bg-purple-600")),a.classList.add("bg-purple-600");const l=parseFloat(a.dataset.value);r(l)})}),n.addEventListener("click",()=>{i&&(i=!1,o.classList.remove("bg-purple-600")),s=!s,n.classList.toggle("bg-purple-600"),c()}),o.addEventListener("click",()=>{s&&(s=!1,n.classList.remove("bg-purple-600")),i=!i,o.classList.toggle("bg-purple-600"),$.isTripletMode=i,k.forEach(a=>{a.config.isTripletMode=i}),c()});function c(){const a=document.querySelector(".note-duration-btn.bg-purple-600");if(a){const l=parseFloat(a.dataset.value);r(l)}}r($.currentDuration||1)}let te=null,ot=null;function fi(e){ot=e,te=ot.getContext("2d")}function Se(e){if(!te||!ot)return;const{width:t,height:n}=ot;te.clearRect(0,0,t,n);const o=Math.round(e)+.5;te.strokeStyle="#ff00ff",te.lineWidth=1,te.beginPath(),te.moveTo(o,0),te.lineTo(o,n),te.stroke()}let st=!1,ge=null,Mt=!1;function mi(e,t){ge=e,ge.addEventListener("mousedown",hi),window.addEventListener("mousemove",gi),window.addEventListener("mouseup",pi)}function hi(e){Mn()&&(Ln(),k.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),Mt=!0),st=!0,Gn(e)}function gi(e){st&&Gn(e)}function pi(){st&&(st=!1,Mt&&(Nn(),k.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),Mt=!1))}function Gn(e){const t=ge.getBoundingClientRect(),n=ge.width/t.width;let o=(e.clientX-t.left)*n;o=Math.max(0,Math.min(ge.width,o));const s=F(),i=o/ge.width*s,r=mn(i,$),c=r/s*ge.width;le(r),Se(c)}const $t={maxBeatsContext:32,extendBeatsAmount:16};function ki(){return $t.maxBeatsContext}function Ii(){return $t.extendBeatsAmount}function Lt(e,t,n,o){const s=F(),i=o/s*t;e.clearRect(0,0,t,n);const r=$t.maxBeatsContext,a=Math.max(0,o-r)/s*t,l=i-a;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(a,0,l,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke()}let cn=!1;function ln(){if(!cn){cn=!0;const o=document.getElementById("extend-use-tags"),s=document.getElementById("extend-tags");if(o&&s){let l=function(){const d=o.checked;s.disabled=!d,s.classList.toggle("opacity-50",!d),s.classList.toggle("cursor-not-allowed",!d)};l(),o.addEventListener("change",l)}const i=document.getElementById("extend-start-help-btn"),r=document.getElementById("extend-start-help-popup"),c=document.getElementById("extend-start-help-close");i&&r&&c&&(i.addEventListener("click",()=>r.classList.remove("hidden")),c.addEventListener("click",()=>r.classList.add("hidden")),document.addEventListener("click",l=>{!r.contains(l.target)&&l.target!==i&&r.classList.add("hidden")}));const a=document.querySelector("#ai-extend-modal .generate-btn");a&&a.addEventListener("click",async()=>{const{extendTracksWithAI:l}=await un(async()=>{const{extendTracksWithAI:d}=await import("./extendTracks-bbx5Xkn4.js");return{extendTracksWithAI:d}},__vite__mapDeps([0,1]));await l()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",ie().forEach((s,i)=>{const r=`extend-track-${i}`,c=document.createElement("div");c.className="flex items-center gap-2";const a=document.createElement("input");a.type="checkbox",a.id=r,a.dataset.index=i,a.checked=!0,a.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const l=document.createElement("label");l.htmlFor=r,l.className="text-sm text-gray-200",l.textContent=s.config.name||`Track ${i+1}`,a.addEventListener("change",()=>{Ae()}),c.appendChild(a),c.appendChild(l),e.appendChild(c)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!0),Ae()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!1),Ae()}),Ae())}let ut=!1,Oe=0;function Ti(){return Oe}function yi(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d"),o=e.clientWidth,s=e.clientHeight;e.width=o,e.height=s,t.width=o,t.height=s,Ae(),Lt(n,o,s,Oe),t.addEventListener("mousedown",r=>{ut=!0,i(r.offsetX)}),window.addEventListener("mouseup",()=>{ut=!1}),window.addEventListener("mousemove",r=>{if(!ut)return;const c=t.getBoundingClientRect();i(r.clientX-c.left)});function i(r){const c=F(),a=Math.max(0,Math.min(r,o));Oe=Math.round(a/o*c),Lt(n,o,s,Oe)}}function Ae(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead"),n=t.getContext("2d"),o=t.width,s=t.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),r=Array.from(i).filter(a=>a.checked).map(a=>parseInt(a.dataset.index,10)),c=ie().filter((a,l)=>r.includes(l));V(e,c),Lt(n,o,s,Oe)}function Ei(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),o=document.getElementById("note-duration-controls"),s=document.getElementById("select-mode-controls"),i=document.getElementById("velocity-mode-controls");function r(a){[e,t,n].forEach(l=>{l.classList.remove("bg-purple-600"),l.classList.add("bg-gray-800")}),a.classList.remove("bg-gray-800"),a.classList.add("bg-purple-600")}function c(a){[o,s,i].forEach(l=>{l.classList.add("hidden")}),a.classList.remove("hidden")}e.addEventListener("click",()=>{r(e),c(o),Y("note-placement")}),t.addEventListener("click",()=>{r(t),c(s),Y("select")}),n.addEventListener("click",()=>{r(n),c(i),Y("velocity")}),window.addEventListener("keydown",a=>{var f;const l=(f=document.activeElement)==null?void 0:f.tagName;if(!(l==="INPUT"||l==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(a.key){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),r(e),c(o),Y("note-placement")}function bi(){const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),o=document.getElementById("ai-control-panel");function s(){document.querySelectorAll(".sequencer").forEach(u=>{const m=u.querySelector(".delete-btn"),h=u.querySelector(".collapse-btn"),p=h.querySelector("use");m.classList.add("button-locked"),h.classList.add("button-locked");const g=u.querySelector(".sequencer-body"),y=u.querySelector(".mini-contour");ze(u,!1),g.classList.contains("hidden")||(g.classList.add("hidden"),y.classList.remove("hidden"),p.setAttribute("href","#icon-caret-up"))})}function i(){document.querySelectorAll(".sequencer").forEach(u=>{const m=u.querySelector(".delete-btn"),h=u.querySelector(".collapse-btn");m.classList.remove("button-locked"),h.classList.remove("button-locked")})}function r(){e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),o.classList.add("hidden"),i()}function c(){if(!vt()){document.getElementById("openai-key-not-set-modal").classList.remove("hidden");return}t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),o.classList.remove("hidden"),s()}e.addEventListener("click",r),t.addEventListener("click",c);const a=document.getElementById("ai-inpaint-modal"),l=document.getElementById("ai-extend-modal"),d=document.getElementById("ai-generate-modal");function f(u){u.querySelector(".cancel-btn").addEventListener("click",()=>{u.classList.add("hidden")})}f(a),f(l),f(d),ln(),document.getElementById("ai-inpaint-btn").addEventListener("click",()=>{a.classList.remove("hidden")}),document.getElementById("ai-extend-btn").addEventListener("click",()=>{l.classList.remove("hidden"),yi(),ln()}),document.getElementById("ai-generate-btn").addEventListener("click",()=>{d.classList.remove("hidden")}),Ei()}function zn(){const e=Ht();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(q(kt(t.sequencer.id,n),It(t.sequencer.id,n)),Ce()&&(Be(),Y(se.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function Kn(){console.log("performCopy called");const e=Ht();if(!e)return;const t=e.getSelectedNotes();t.length!==0&&Rn(t)}function Xn(){const e=Ht();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(Rn(n),q(vo(t.sequencer.id,n),Bo(t.sequencer.id,n)),Ce()&&(Be(),Y(se.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function jn(){if(console.log("performPaste called"),!St().notes.length){console.log("No notes in clipboard");return}document.body.style.cursor="crosshair",xo((t,n)=>{const o=t.gridContext,{x:s,y:i}=o.getCanvasPos(n),r=o.getSnappedBeatFromX(s),c=o.getPitchFromRow(Math.floor(i/o.getCellHeight())),a=W(c),{notes:l,anchorBeat:d,anchorMidi:f}=St(),u=r-d,m=a-f,h=l.map(p=>({pitch:We(W(p.pitch)+m),start:p.start+u,duration:p.duration}));q(Mo(o.sequencer.id,h),Lo(o.sequencer.id,h)),Ce()&&(Be(),Y(se.NOTE_PLACEMENT)),o.setSelectedNotes(h),document.body.style.cursor="default",Pt()})}function Si(){document.addEventListener("keydown",e=>{var s;const n=navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey,o=(s=document.activeElement)==null?void 0:s.tagName;if(!(o==="INPUT"||o==="TEXTAREA"))switch(!0){case(n&&e.key==="c"):e.preventDefault(),Kn();break;case(n&&e.key==="x"):e.preventDefault(),Xn();break;case(n&&e.key==="v"):e.preventDefault(),jn();break;case e.key==="Delete":e.preventDefault(),zn();break}})}function wi(){const e=document.querySelector(".select-mode-copy");e&&(e.onclick=Kn);const t=document.querySelector(".select-mode-cut");t&&(t.onclick=Xn);const n=document.querySelector(".select-mode-paste");n&&(n.onclick=jn);const o=document.querySelector(".select-mode-delete");o&&(o.onclick=zn),Si()}function vi(e=Ge()){pt(e.tempo,!1),yt(e.timeSignature[0],!1),Et(e.totalMeasures,!1);for(const n of k)n.updateTotalMeasures(e.totalMeasures);for(const n of e.sequencers){let o=k.find(s=>s.id===n.id);if(o){o.config.instrument=n.instrument;const s=o.container.querySelector("canvas.mini-contour");s&&He(s,o.notes,o.config,o.colorIndex);const i=o.grid.gridContext,r=i.getSelectedNotes?i.getSelectedNotes():[],c=i.getSelectedNote?i.getSelectedNote():null,a=r.map(l=>({pitch:l.pitch,start:l.start,duration:l.duration}));if(i.notes.length=0,i.notes.push(...structuredClone(n.notes)),r.length>0){const l=a.map(d=>i.notes.find(f=>f.pitch===d.pitch&&f.start===d.start&&f.duration===d.duration)).filter(Boolean);l.length>0&&(i.setSelectedNotes(l),c&&l.length===1&&i.setSelectedNote(l[0]))}o.grid.scheduleRedraw()}else{const{wrapper:s}=Fn({id:n.id,instrument:n.instrument,config:{...n.config},notes:n.notes}),i=s.querySelector(".sequencer");i&&ze(i,!0)}}const t=document.getElementById("global-mini-contour");t&&V(t,k)}Po(vi);function Yn(){V(Bi,k)}const Bi=document.getElementById("global-mini-contour"),Wt=document.getElementById("global-mini-playhead");fi(Wt);mi(Wt);Se(0);const Ci=document.getElementById("piano");ni(Ci);const Mi=document.getElementById("waveform");ii(Mi,document.getElementById("visualizer-mode"));const dn=0,Li="fluidr3-gm/acoustic_grand_piano";q(En(dn,Li),Nt(dn));q(At("Initial App State"),Sn("Initial App State"));wi();Yn();Cs();ui();bi();ri();_s({getSequencers:()=>k,onPlay:()=>{et();const e=F(),t=xe();Uo(de(),{loop:$.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{k.forEach(n=>{var o;return(o=n.onTransportLoop)==null?void 0:o.call(n)})}}),gt(n=>{const o=n/e*Wt.width;Se(o)}),k.forEach(n=>n.play()),$o(()=>{Ds(),le(0),Se(0)})},onPause:()=>{Ln(),k.forEach(e=>e.pause())},onResume:()=>{Nn(),k.forEach(e=>e.resume())},onStop:()=>{et(),le(0),k.forEach(e=>e.stop()),Se(0)},onDurationChange:e=>{$.currentDuration=e,k.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{$.snapResolution=e,k.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{$.loopEnabled=e,k.forEach(t=>t.config.loopEnabled=e)},onTempoChange:pt,onSave:async e=>{const t=k.map(n=>n.getState());if(e==="json"){const{url:n,filename:o}=ai(t),s=document.createElement("a");s.href=n,s.download=o,s.click(),URL.revokeObjectURL(n)}else e==="wav"?await ci(t):e==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async e=>{try{const{tracks:t,globalConfig:n}=await di(e);pt(n.bpm),yt(n.beatsPerMeasure),Et(n.totalMeasures);const o=document.getElementById("tempo-input");o&&(o.value=de());const s=document.getElementById("measures-input");s&&(s.value=Ne()),Bs();for(const[i,r]of t.entries()){const c=i,a=r.instrument||"fluidr3-gm/acoustic_grand_piano",l=r.notes||[];q({type:"CREATE_SEQUENCER",id:c,instrument:a,notes:structuredClone(l),config:r.config||{}},Nt(c))}q(At("Session Loaded"),Sn("Session Loaded")),Jo(),Yn(),le(0),Se(0)}catch(t){alert("Failed to load file: "+t.message)}},onMeasuresChange:e=>{Et(e);const t=document.getElementById("global-mini-contour");t&&V(t,k)},onBeatsPerMeasureChange:e=>{yt(e);const t=document.getElementById("global-mini-contour");t&&V(t,k)}});const Ai=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{on as a,ie as b,Ti as c,ki as d,Ii as e,Le as f,vt as g,He as h,V as i,Ai as m,Et as u};
