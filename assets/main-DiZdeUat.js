const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-DCCpU_04.js","assets/index-WUAvkpjQ.js"])))=>i.map(i=>d[i]);
import{_ as xt}from"./index-WUAvkpjQ.js";function Vt(e=3){const i=["C","D","E","F","G","A","B"],r=["C#","D#","","F#","G#","A#",""],c=[e,e+1,e+2],a={};let u=0;for(const d of c)i.forEach(m=>{const l=`${m}${d}`;a[l]={note:l,x:u,width:60,height:200,isBlack:!1},u+=60});u=0;for(const d of c)r.forEach((m,l)=>{if(m===""){u+=60;return}const f=`${m}${d}`;a[f]={note:f,x:u+60-40/2,width:40,height:120,isBlack:!0},u+=60});return a}function Re(e,t,n=new Set,o=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const s={};if(o)for(const[i,r]of Object.entries(o))s[r]=i;for(const i of Object.values(t))i.isBlack||(Rt(e,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",s[i.note]&&(e.fillStyle="#7c3aed",e.fillText(s[i.note],i.x+i.width/2,i.height-24),e.fillStyle="#333"),e.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(t))i.isBlack&&(Rt(e,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),_n(e,i),s[i.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(s[i.note],i.x+i.width/2,i.height-28)))}function Rt(e,{x:t,width:n,height:o,fill:s,stroke:i,radius:r=8}){e.beginPath(),e.moveTo(t,0),e.lineTo(t,o-r),e.quadraticCurveTo(t,o,t+r,o),e.lineTo(t+n-r,o),e.quadraticCurveTo(t+n,o,t+n,o-r),e.lineTo(t+n,0),e.closePath(),e.fillStyle=s,e.fill(),e.strokeStyle=i,e.lineWidth=1,e.stroke()}function _n(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}function P(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}function qn(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function Rn(e){return e.replace(/\d+$/,"")}function Dn(e){return e.includes("#")}function On(e,t){return e/t()}function Fn(e,t){let n=t.snapResolution||.25,o=t.isTripletMode?n*(2/3):n;return Math.round(e/o)*o}function Hn(e,t,n){const o=On(e,n);return Fn(o,t)}function Qt(e,t,n,o,s,i=4){e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+o-i,n),e.quadraticCurveTo(t+o,n,t+o,n+i),e.lineTo(t+o,n+s-i),e.quadraticCurveTo(t+o,n+s,t+o-i,n+s),e.lineTo(t+i,n+s),e.quadraticCurveTo(t,n+s,t,n+s-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}const ue=64,$n={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"},Xe=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:50,cellHeight:25},{cellWidth:60,cellHeight:30}];function Un(e,t){const n=structuredClone(e);return n.tempo=t.bpm,n}function Jt(e){return{type:"CHANGE_TEMPO",bpm:e}}function Wn(e){return Jt(e)}function Kn(e,t){const n=structuredClone(e);return n.timeSignature=[t.beats,4],n}function Zt(e){return{type:"SET_TIME_SIGNATURE",beats:e}}function Xn(e){return Zt(e)}function Gn(e,t){const n=structuredClone(e);return n.totalMeasures=t.measures,n}function en(e){return{type:"SET_TOTAL_MEASURES",measures:e}}function jn(e){return en(e)}function zn(e,t){const n=structuredClone(e);if(n.sequencers.push({id:t.id,instrument:t.instrument,notes:t.notes||[]}),!L.find(s=>s.id===t.id)){const{wrapper:s}=wn({config:{id:t.id,...t.config},notes:t.notes||[],instrument:t.instrument});Ke(s,!0)}return n}function tn(e,t){return{type:"CREATE_SEQUENCER",id:e,instrument:t}}function wt(e){return{type:"DELETE_SEQUENCER",id:e}}function Yn(e,t){const n=structuredClone(e);n.sequencers=n.sequencers.filter(s=>s.id!==t.id);const o=L.findIndex(s=>s.id===t.id);return o!==-1&&(L[o].destroy(),L.splice(o,1)),n}function xn(e,t,n=[]){return{type:"DELETE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function Vn(e,t,n=[]){return{type:"CREATE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function Qn(e,t){return structuredClone(e)}const Ce=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function Jn(e){return Ce[e%Ce.length]}function Zn(e){return Jn(e.colorIndex)}function De(e,t,n,o=0){const s=e.getContext("2d"),i=e.width,r=e.height;s.clearRect(0,0,i,r);const c=Ce[o%Ce.length];s.fillStyle=c;const a=D(),u=P(n.noteRange[0]),m=P(n.noteRange[1])-u||1,l=Math.max(2,r/m);for(const f of t){const g=f.start/a*i,h=Math.max(1,f.duration/a*i),E=(P(f.pitch)-u)/m,y=r-E*r-l/2;s.fillRect(g,y,h,l)}}function Q(e,t){const n=e.getContext("2d"),o=e.width,s=e.height;n.clearRect(0,0,o,s),t.forEach((i,r)=>{const c=i.notes,a=i.config;if(!(c!=null&&c.length))return;const u=D(),d=Ce[r%Ce.length];n.fillStyle=d;const m=P(a.noteRange[0]),f=P(a.noteRange[1])-m||1,g=Math.max(2,s/f);for(const h of c){const p=h.start/u*o,E=Math.max(1,h.duration/u*o),b=(P(h.pitch)-m)/f,w=s-b*s-g/2;n.fillRect(p,w,E,g)}})}function eo(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;o.notes.push(...t.notes);const s=document.getElementById("global-mini-contour");return s&&Q(s,L),n}function to(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function no(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function oo(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));o.notes=o.notes.filter(r=>{const c=`${r.pitch}|${r.start}|${r.duration}`;return!s.has(c)});const i=document.getElementById("global-mini-contour");return i&&Q(i,L),n}function Bt(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Lt(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function so(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const{from:s,to:i}=t;for(let r=0;r<s.length;r++){const c=s[r],a=i[r],u=o.notes.findIndex(d=>d.pitch===c.pitch&&d.start===c.start&&d.duration===c.duration);u!==-1&&(o.notes[u].pitch=a.pitch,o.notes[u].start=a.start)}return n}function Ct(e,t,n){return{type:"MOVE_NOTES",sequencerId:e,from:structuredClone(t),to:structuredClone(n)}}function nn(e,t,n){return Ct(e,n,t)}function io(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(i=>`${i.pitch}|${i.start}|${i.duration}`));return o.notes=o.notes.filter(i=>{const r=`${i.pitch}|${i.start}|${i.duration}`;return!s.has(r)}),n}function ro(e,t){return{type:"CUT_NOTES",sequencerId:e,notes:structuredClone(t)}}function ao(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function co(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);return o?(o.notes.push(...t.notes),n):e}function lo(e,t){return{type:"PASTE_NOTES",sequencerId:e,notes:structuredClone(t)}}function uo(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function fo(e,t){return structuredClone(e)}function mo(e,t){return structuredClone(e)}function Mt(e=""){return{type:"CHECKPOINT",label:e}}function on(e=""){return Mt(e)}const go=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_INSTRUMENT:Qn,CHANGE_TEMPO:Un,CHECKPOINT:mo,CREATE_SEQUENCER:zn,CUT_NOTES:io,DELETE_NOTES:oo,DELETE_SEQUENCER:Yn,MOVE_NOTES:so,PASTE_NOTES:co,PLACE_NOTES:eo,SET_TIME_SIGNATURE:Kn,SET_TOTAL_MEASURES:Gn,UPDATE_NOTE_VELOCITY:fo},Symbol.toStringTag,{value:"Module"}));function kt(e){const t=go[e.type];if(!t)throw new Error(`Unknown diff type: ${e.type}`);const n=t($e(),e);sn(n)}let at=new Set;function ho(e){return at.add(e),()=>at.delete(e)}function He(e){for(const t of at)t(e)}const te=[];let V=-1;const po=100;function yo({forwardDiff:e,reverseDiff:t}){te.splice(V+1),te.push({forwardDiff:e,reverseDiff:t}),V=te.length-1,te.length>po&&(te.shift(),V--)}function Eo(){var e;if(V<0)return null;for(let t=V;t>=0;t--){const n=te[t];if(((e=n==null?void 0:n.forwardDiff)==null?void 0:e.type)==="CHECKPOINT")return null;if(n!=null&&n.reverseDiff)return V=t-1,kt(n.reverseDiff),He($e()),n.reverseDiff}return null}function bo(){if(V>=te.length-1)return null;V++;const e=te[V];return!e||!e.forwardDiff?null:(kt(e.forwardDiff),He($e()),e.forwardDiff)}function vo(){te.length=0,V=-1}let xe={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[]};function $e(){return xe}function sn(e){xe=structuredClone(e),He(xe)}function q(e,t){kt(e),yo({forwardDiff:e,reverseDiff:t}),He(xe)}let K=null,x=500,Se=null,ct=!1,lt=1/0,we=[],Ye=null,rn=0,an=4,cn=8;function dt(e){return we.push(e),()=>{const t=we.indexOf(e);t!==-1&&we.splice(t,1)}}function So(){we=[]}function ae(e){rn=e}function D(){return We()*Ue()}function Ve(){return rn}function ut(e,t=!0){if(t){const o=fe();q(Jt(e),Wn(o));return}if(ln()){const o=performance.now(),s=(o-Se)/x;x=60/e*1e3,Se=o-s*x}else x=60/e*1e3;const n=document.getElementById("tempo-input");n&&n.value!==String(e)&&(n.value=e)}function fe(){return 60/(x/1e3)}function ft(e,t=!0){if(t){const o=Ue();q(Zt(e),Xn(o));return}an=e;const n=document.getElementById("beats-per-measure-input");n&&n.value!==String(e)&&(n.value=e),oe().forEach(o=>{var s,i;(s=o.grid)!=null&&s.resizeAndRedraw?o.grid.resizeAndRedraw():(i=o.grid)==null||i.scheduleRedraw()})}function Ue(){return an}function mt(e,t=!0){if(t){const o=We();q(en(e),jn(o));return}cn=e;const n=document.getElementById("measures-input");n&&n.value!==String(e)&&(n.value=e),oe().forEach(o=>{var s;(s=o.grid)==null||s.scheduleRedraw()})}function We(){return cn}function wo(e){Ye=e}function Bo(e,t={}){x=60/e*1e3,ct=t.loop??!1,lt=t.endBeat??1/0;const n=t.startBeat??0;Se=performance.now()-n*x;const o=t.onLoop;function s(i){const c=(i-Se)/x;if(ae(c),we.forEach(a=>a(c)),c>=lt)if(ct)Se=performance.now(),ae(0),o&&o();else{Qe();return}K=requestAnimationFrame(s)}K=requestAnimationFrame(s)}function Qe(){K&&cancelAnimationFrame(K),K=null,So(),Ye&&(Ye(),Ye=null)}function ln(){return K!==null}function dn(){K&&cancelAnimationFrame(K),K=null}function un(){if(K)return;const e=performance.now()-Ve()*x;function t(n){const s=(n-e)/x;if(ae(s),we.forEach(i=>i(s)),s>=lt)if(ct)Se=performance.now(),ae(0);else{Qe();return}K=requestAnimationFrame(t)}K=requestAnimationFrame(t)}const fn={openaiApiKey:"",openaiModel:"gpt-4o",gridColorScheme:"Darkroom",noteColorScheme:"Track Color"};function Me(){return fn}function Oe(e){Object.assign(fn,e)}const Dt={Midnight:{whiteKey:"#1e1e1e",blackKey:"#2a103b",labelWhite:"#2c2c2c",labelBlack:"#3a1d4d",textWhite:"#cfcfcf",textBlack:"#e6d9ff",gridLine:"#333",beatLine:"#4e3d63",measureLine:"#8561c2"},Seashell:{whiteKey:"#fefefe",blackKey:"#f1e7dc",labelWhite:"#dddddd",labelBlack:"#d4cfc9",textWhite:"#444",textBlack:"#663300",gridLine:"#ccc",beatLine:"#bbb",measureLine:"#999"},Cyberpunk:{whiteKey:"#1b1b2f",blackKey:"#162447",labelWhite:"#1f4068",labelBlack:"#1f4068",textWhite:"#e43f5a",textBlack:"#e43f5a",gridLine:"#1f4068",beatLine:"#e43f5a",measureLine:"#ffcc00"},"Classic Blue":{whiteKey:"#f5faff",blackKey:"#dceeff",labelWhite:"#aaccee",labelBlack:"#88bbdd",textWhite:"#002244",textBlack:"#001122",gridLine:"#99bbdd",beatLine:"#88aacc",measureLine:"#336699"},Darkroom:{whiteKey:"#2c2c2c",blackKey:"#1e1e1e",labelWhite:"#383838",labelBlack:"#2a2a2a",textWhite:"#a0a0a0",textBlack:"#e0e0e0",gridLine:"#404040",beatLine:"#606060",measureLine:"#808080"}};function Lo(e,t,n,o,s,i){const{gridColorScheme:r}=Me(),c=Dt[r]||Dt.Darkroom,a=Ue(),u=D(),d=u*o,m=n*s;e.font=`${Math.floor(s*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let l=0;l<n;l++){const f=l*s,g=i(l),h=Dn(g);e.fillStyle=h?c.blackKey:c.whiteKey,e.fillRect(0,f,d,s),e.fillStyle=h?c.labelBlack:c.labelWhite,e.fillRect(-64,f,ue,s),e.fillStyle=h?c.textBlack:c.textWhite,e.fillText(g,-8,f+s/2)}e.strokeStyle=c.gridLine,e.lineWidth=1;for(let l=0;l<n;l++){const f=l*s;e.beginPath(),e.moveTo(0,f),e.lineTo(d,f),e.stroke()}for(let l=0;l<=u;l++){const f=l*o,g=l%a===0;e.strokeStyle=g?c.measureLine:c.beatLine,e.lineWidth=g?2:1,e.beginPath(),e.moveTo(f,0),e.lineTo(f,m),e.stroke()}}const Co={Scriabin:(e,{getPitchClass:t})=>{const n=t(e.pitch);return $n[n]||"#999"},"Track Color":(e,{getTrackColor:t})=>(t==null?void 0:t(e.trackId))||"#999","Octave Bands":e=>{const t=P(e.pitch);return t==null?"#999":`hsl(${t*3%360}, 100%, 60%)`},"Pitch Class Contrast":(e,{getPitchClass:t})=>{const o=P(e.pitch)%12;return["#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f"][o]||"#999"}};function Mo(e,t,{previewNotes:n=null,hoveredNote:o,selectedNote:s,selectedNotes:i=[],highlightedNotes:r=[],cellWidth:c,cellHeight:a,visibleStartBeat:u,visibleEndBeat:d,getPitchRow:m,getPitchClass:l,getTrackColor:f,drawRoundedRect:g}){const{noteColorScheme:p}=Me(),E=Co[p]||(()=>"#999");for(const y of t){if(y.start+y.duration<u-2||y.start>d)continue;const b=y.start*c,w=m(y.pitch)*a,S=y.duration*c,C=a-1,N=E(y,{getPitchClass:l,getTrackColor:f});e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=r.includes(y)?"rgba(96, 165, 250, 0.6)":N,g(e,b,w,S,C),e.fill();const M=e.createLinearGradient(b,w,b,w+C);M.addColorStop(0,"rgba(255,255,255,0.4)"),M.addColorStop(.2,"rgba(255,255,255,0.15)"),M.addColorStop(.5,"rgba(255,255,255,0.05)"),M.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=M,g(e,b,w,S,C),e.fill();const I=i.includes(y),T=y===o,F=r.includes(y);(I||T||F)&&(e.lineWidth=I?3:2,e.strokeStyle=I?"rgba(0, 255, 255, 1.0)":T?"rgba(255, 255, 255, 0.9)":"rgba(255, 200, 50, 0.7)",g(e,b,w,S,C),e.stroke())}if(n)for(const y of n){const b=y.start*c,w=m(y.pitch)*a,S=y.duration*c,C=a-1,N=E(y,{getPitchClass:l,getTrackColor:f});e.fillStyle=ko(N,.4),g(e,b,w,S,C),e.fill()}}function ko(e,t=1){if(e.startsWith("#")){const n=parseInt(e.slice(1),16),o=n>>16&255,s=n>>8&255,i=n&255;return`rgba(${o}, ${s}, ${i}, ${t})`}if(e.startsWith("hsl(")){const[n,o,s]=e.slice(4,-1).split(",").map(a=>parseFloat(a)),[i,r,c]=No(n,o/100,s/100);return`rgba(${i}, ${r}, ${c}, ${t})`}return e}function No(e,t,n){const o=(1-Math.abs(2*n-1))*t,s=o*(1-Math.abs(e/60%2-1)),i=n-o/2;let[r,c,a]=[0,0,0];return 0<=e&&e<60?[r,c,a]=[o,s,0]:60<=e&&e<120?[r,c,a]=[s,o,0]:120<=e&&e<180?[r,c,a]=[0,o,s]:180<=e&&e<240?[r,c,a]=[0,s,o]:240<=e&&e<300?[r,c,a]=[s,0,o]:300<=e&&e<360&&([r,c,a]=[o,0,s]),[Math.round((r+i)*255),Math.round((c+i)*255),Math.round((a+i)*255)]}function Io(e,t,n,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+n,0),e.lineTo(t+n,o),e.stroke(),e.restore()}function To(e,t,n,o=ue){const s=e.getBoundingClientRect(),i=parseFloat(e.style.width||s.width),r=parseFloat(e.style.height||s.height),c=e.width/i,a=e.height/r,u=(t.clientX-s.left)*c-o,d=(t.clientY-s.top)*a;return{x:u,y:d}}function Ao(e,t,n,o,s,i){const r=Math.floor(t/s),c=e/i;return n.find(a=>c>=a.start&&c<a.start+a.duration&&o(a.pitch)===r)}function Po(e,t,n,o){const s=e.querySelector(".zoom-in-btn"),i=e.querySelector(".zoom-out-btn"),r=e.querySelector(".zoom-reset-btn");!s||!i||!r||(s.addEventListener("click",t),i.addEventListener("click",n),r.addEventListener("click",o))}function _o(){for(const e of L){const t=e.container,n=t.querySelector(".sequencer-body"),o=t.querySelector("canvas.mini-contour"),s=t.querySelector(".collapse-btn use");n.classList.contains("hidden")||(n.classList.add("hidden"),o.classList.remove("hidden"),s==null||s.setAttribute("href","#icon-caret-up"),Ke(t,!1),De(o,e.notes,e.config,e.colorIndex))}}function _(e){const t=e.match(/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o,s]=t;return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[o]+12*parseInt(s,10)}function Fe(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}let nt=!1,Je=null,$=null;function qo(e){nt=!0,Je=e,$=null}function Nt(){var e;$&&($.gridContext.setPastePreviewNotes(null),$.scheduleRedraw(),(e=$.setCursor)==null||e.call($,"default")),nt=!1,Je=null,$=null,document.body.style.cursor="default"}function It(){return nt}function Ro(e,t){!nt||!Je||(Je(e,t),Nt())}function Do(e){$&&$!==e&&($.gridContext.setPastePreviewNotes(null),$.scheduleRedraw()),$=e}const ne={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let mn=ne.NOTE_PLACEMENT;const gt=new Set;function gn(){return mn}function G(e){Nt(),mn=e;for(const t of gt)t(e)}function Oo(e){return gt.add(e),()=>gt.delete(e)}let Tt=!1;function Fo(){Tt=!0,G(ne.SELECT)}function Be(){Tt=!1}function Le(){return Tt}let At=!1;function Ho(e=!0){At=e}function $o(){return At}function Uo(){At=!1}let hn={notes:[],anchorBeat:0,anchorMidi:0};function pn(e){if(e.length===0)return;const t=e[0],n=t.start,o=_(t.pitch);hn={notes:e.map(s=>({pitch:s.pitch,start:s.start,duration:s.duration})),anchorBeat:n,anchorMidi:o}}function ht(){return hn}function yn(e,t,n){if(!It()){e.setPastePreviewNotes(null);return}const{notes:o,anchorBeat:s,anchorMidi:i}=ht(),r=e.getSnappedBeatFromX(t),c=e.getPitchFromRow(Math.floor(n/e.getCellHeight())),a=_(c),u=r-s,d=a-i,m=o.map(l=>({pitch:Fe(_(l.pitch)+d),start:l.start+u,duration:l.duration}));e.setPastePreviewNotes(m),e.scheduleRedraw()}function En(e){It()&&e.setPastePreviewNotes(null)}function bn(e,t){return It()?(Ro(e.grid,t),t.preventDefault(),t.stopPropagation(),!0):!1}let Te=null;const Wo=8;function Ot(){Te=null}function Ko(e,t){Te={x:e,y:t}}function Xo(e,t){if(!Te)return!1;const n=e-Te.x,o=t-Te.y;return Math.sqrt(n*n+o*o)>=Wo}let Ee=null;function pt(e){console.log(`registerSelectionStart called with grid: ${e}`),Ee&&Ee!==e&&Ee.clearSelection(),Ee=e}function Go(){Ee=null}function Pt(){return Ee}function Ft(e){let t=null,n=null,o=!1;function s(d){var b,w;if(pt(e.grid),$o()){Uo();return}const{x:m,y:l}=e.getCanvasPos(d);if(m<0){const S=e.getPitchFromRow(Math.floor(l/e.getCellHeight()));e.sequencer.playNote(S,.5);return}const f=e.findNoteAt(m,l);if(f){e.setSelectedNote(f),e.scheduleRedraw(),(b=e.onNotesChanged)==null||b.call(e);return}const g=e.getSnappedBeatFromX(m),h=e.getPitchFromRow(Math.floor(l/e.getCellHeight())),p=D();if(g+e.config.currentDuration>p||e.notes.some(S=>S.pitch===h&&S.start===g))return;e.sequencer.playNote(h,.5);const y={pitch:h,start:g,duration:e.config.currentDuration};q(to(e.sequencer.id,[y]),no(e.sequencer.id,[y])),e.scheduleRedraw(),(w=e.onNotesChanged)==null||w.call(e)}function i(d){d.preventDefault();const{x:m,y:l}=e.getCanvasPos(d),f=e.findNoteAt(m,l);if(!f||e.notes.indexOf(f)===-1)return;const h=[f];q(Bt(e.sequencer.id,h),Lt(e.sequencer.id,h))}function r(d){if(bn(e,d))return;const{x:m,y:l}=e.getCanvasPos(d),f=e.findNoteAt(m,l);if(f){pt(e.grid),e.setSelectedNote(f),t={startX:m,startY:l,anchorNote:f,initialStart:f.start,initialMidi:_(f.pitch),initialNote:{pitch:f.pitch,start:f.start,duration:f.duration}};return}Ko(m,l),o=!1}function c(d){var h;const{x:m,y:l}=e.getCanvasPos(d);if(m<0){e.clearPreview();return}if(yn(e,m,l),!o&&Xo(m,l)){Fo(),e.selectionBox={active:!0,startX:m,startY:l,currentX:m,currentY:l},o=!0,Ot();return}const f=e.findNoteAt(m,l);e.setHoveredNote(f);const g=e.getSelectedNote();if(!t&&g&&g!==f&&e.setSelectedNote(null),!f&&!t){const p=e.getSnappedBeatFromX(m),E=e.getPitchFromRow(Math.floor(l/e.getCellHeight())),y=D();p+e.config.currentDuration<=y?e.updatePreview({pitch:E,start:p,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&g){const p=m-t.startX,E=e.getSnappedBeatFromX(p)-e.getSnappedBeatFromX(0),y=Math.max(0,t.initialStart+E),b=D();y+g.duration<=b&&(g.start=y);const w=l-t.startY,S=Math.round(w/e.getCellHeight()),C=t.initialMidi-S,N=_(e.config.noteRange[0]),M=_(e.config.noteRange[1]),I=Math.max(N,Math.min(M,C)),T=Fe(I);T!==g.pitch&&(g.pitch=T,n!==T&&(n=T,e.sequencer.playNote(T,.5))),e.scheduleRedraw(),(h=e.onNotesChanged)==null||h.call(e);return}e.scheduleRedraw()}function a(d){if(Ot(),o=!1,!t||!e.getSelectedNote()){t=null;return}const{anchorNote:m,initialNote:l}=t,f={pitch:m.pitch,start:m.start,duration:m.duration};(l.pitch!==f.pitch||l.start!==f.start)&&q(Ct(e.sequencer.id,[l],[f]),nn(e.sequencer.id,[l],[f])),t=null}function u(){e.clearPreview(),e.setHoveredNote(null),En(e),e.scheduleRedraw()}return{attach(d){d.addEventListener("click",s),d.addEventListener("contextmenu",i),d.addEventListener("mousemove",c),d.addEventListener("mouseleave",u),d.addEventListener("mousedown",r),d.addEventListener("mouseup",a)},detach(d){d.removeEventListener("click",s),d.removeEventListener("contextmenu",i),d.removeEventListener("mousemove",c),d.removeEventListener("mouseleave",u),d.removeEventListener("mousedown",r),d.removeEventListener("mouseup",a)}}}function Ht(e){let t=null;function n(c){c.preventDefault();const{x:a,y:u}=e.getCanvasPos(c),d=e.findNoteAt(a,u);if(!d)return;const m=e.getSelectedNotes(),l=m.includes(d)?m:[d];l.length&&(e.setSelectedNotes([]),q(Bt(e.sequencer.id,l),Lt(e.sequencer.id,l)),Le()&&(Be(),G(ne.NOTE_PLACEMENT)))}function o(c){if(bn(e,c))return;const{x:a,y:u}=e.getCanvasPos(c);if(a<0)return;const d=e.findNoteAt(a,u);e.setHoveredNote(d),pt(e.grid);const m=e.getSelectedNotes();if(d&&m.includes(d)){t={startX:a,startY:u,anchorNote:d,initialNotes:m.map(l=>({note:l,start:l.start,midi:_(l.pitch)}))};return}e.selectionBox={active:!0,startX:a,startY:u,currentX:a,currentY:u},e.clearPreview(),e.setSelectedNote(null)}function s(c){var m,l;Do(e.grid);const{x:a,y:u}=e.getCanvasPos(c),d=e.findNoteAt(a,u);if(e.setHoveredNote(d),yn(e,a,u),(m=e.selectionBox)!=null&&m.active){e.selectionBox.currentX=a,e.selectionBox.currentY=u;const f=e.selectionBox,g=Math.min(f.startX,f.currentX),h=Math.min(f.startY,f.currentY),p=Math.max(f.startX,f.currentX),E=Math.max(f.startY,f.currentY),y=Math.floor(h/e.getCellHeight()),b=Math.floor(E/e.getCellHeight()),w=e.getSnappedBeatFromX(g),S=e.getSnappedBeatFromX(p),C=_(e.getPitchFromRow(y)),N=_(e.getPitchFromRow(b)),M=e.notes.filter(I=>{const T=_(I.pitch),F=I.start,R=I.start+I.duration,X=F>=w&&R<=S,me=T>=N&&T<=C;return X&&me});e.setHighlightedNotes(M),e.scheduleRedraw();return}if(t){const f=a-t.startX,g=e.getSnappedBeatFromX(f)-e.getSnappedBeatFromX(0),h=u-t.startY,p=Math.round(h/e.getCellHeight()),E=D(),y=_(e.config.noteRange[0]),b=_(e.config.noteRange[1]);for(const{note:S,start:C,midi:N}of t.initialNotes){const M=Math.max(0,C+g),I=Math.max(y,Math.min(b,N-p)),T=Fe(I);M+S.duration<=E&&(S.start=M,S.pitch=T)}const w=t.initialNotes.find(S=>S.note===t.anchorNote);if(w){const S=w.note.pitch;t.lastPreviewPitch!==S&&(t.lastPreviewPitch=S,e.sequencer.playNote(S,.5))}e.scheduleRedraw(),(l=e.onNotesChanged)==null||l.call(e)}}function i(c){var a,u;if((a=t==null?void 0:t.initialNotes)!=null&&a.length){const{initialNotes:d}=t,m=d.map(({start:g,midi:h,note:p})=>({pitch:Fe(h),start:g,duration:p.duration})),l=d.map(({note:g})=>({pitch:g.pitch,start:g.start,duration:g.duration}));m.some((g,h)=>g.pitch!==l[h].pitch||g.start!==l[h].start)&&(q(Ct(e.sequencer.id,m,l),nn(e.sequencer.id,m,l)),Le()&&(Be(),G(ne.NOTE_PLACEMENT)))}if(t=null,(u=e.selectionBox)!=null&&u.active){const{x:d,y:m}=e.getCanvasPos(c);e.selectionBox.currentX=d,e.selectionBox.currentY=m,e.selectionBox.active=!1;const l=e.selectionBox,f=Math.min(l.startX,l.currentX),g=Math.min(l.startY,l.currentY),h=Math.max(l.startX,l.currentX),p=Math.max(l.startY,l.currentY),E=Math.floor(g/e.getCellHeight()),y=Math.floor(p/e.getCellHeight()),b=e.getSnappedBeatFromX(f),w=e.getSnappedBeatFromX(h),S=_(e.getPitchFromRow(E)),C=_(e.getPitchFromRow(y)),N=e.notes.filter(M=>{const I=_(M.pitch),T=M.start,F=M.start+M.duration,R=T>=b&&F<=w,X=I>=C&&I<=S;return R&&X});e.setHighlightedNotes([]),e.setSelectedNotes(N),e.scheduleRedraw(),Le()&&e.getSelectedNotes().length===0&&(c.stopPropagation(),Be(),G(ne.NOTE_PLACEMENT),Ho(!0))}}function r(){e.setHoveredNote(null),e.setHighlightedNotes([]),En(e),e.scheduleRedraw()}return{attach(c){c.addEventListener("mousedown",o),c.addEventListener("mousemove",s),c.addEventListener("mouseup",i),c.addEventListener("mouseleave",r),c.addEventListener("contextmenu",n)},detach(c){c.removeEventListener("mousedown",o),c.removeEventListener("mousemove",s),c.removeEventListener("mouseup",i),c.removeEventListener("mouseleave",r),c.removeEventListener("contextmenu",n)}}}function jo(e,t){const n=t.selectionBox;if(!n)return;const o=n.startX,s=n.startY,i=n.currentX,r=n.currentY,c=Math.min(o,i),a=Math.min(s,r),u=Math.abs(i-o),d=Math.abs(r-s);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),Qt(e,c,a,u,d,3),e.stroke(),e.restore()}function zo(e,t,n,o,s,i){let r=null,c=null,a=null,u=null,d=2;const m=e.getContext("2d"),l=t.getContext("2d");let f=Xe[d].cellWidth,g=Xe[d].cellHeight;const h=P(s.noteRange[1])-P(s.noteRange[0])+1,p=h*g,y=D()*f+ue;e.width=y,e.height=p,e.style.width=`${y}px`,e.style.height=`${p}px`,t.width=y,t.height=p,t.style.width=`${y}px`,t.style.height=`${p}px`;let b=null;function w(){b!==null&&cancelAnimationFrame(b),b=requestAnimationFrame(S)}function S(){var v;m.clearRect(0,0,e.width,e.height),m.save(),m.translate(ue,0),Lo(m,s,h,f,g,X),Mo(m,o,{previewNotes:c??(r?[r]:null),hoveredNote:a,selectedNote:u,selectedNotes:j,highlightedNotes:A.getHighlightedNotes(),cellWidth:f,cellHeight:g,visibleStartBeat:0,visibleEndBeat:e.width/f,getPitchRow:R,getPitchClass:Rn,getTrackColor:()=>Zn(i),drawRoundedRect:Qt}),(v=A.selectionBox)!=null&&v.active&&jo(m,A),m.restore()}function C(){d<Xe.length-1&&(d++,I())}function N(){d>0&&(d--,I())}function M(){d=2,I()}function I(){const v=Xe[d];f=v.cellWidth,g=v.cellHeight,T()}function T(){const Y=D()*f+ue,ge=(P(s.noteRange[1])-P(s.noteRange[0])+1)*g;e.width=Y,e.height=ge,e.style.width=`${Y}px`,e.style.height=`${ge}px`,t.width=Y,t.height=ge,t.style.width=`${Y}px`,t.style.height=`${ge}px`,w()}function F(v){Io(l,v,ue,e.height)}Po(i.container,C,N,M);function R(v){return P(s.noteRange[1])-P(v)}function X(v){const ke=P(s.noteRange[1])-v,ge=Math.max(P(s.noteRange[0]),Math.min(P(s.noteRange[1]),ke));return qn(ge)}function me(){const v=document.getElementById("global-mini-contour");v&&Q(v,L)}let ie=null,j=[];const A={sequencer:i,grid:null,config:s,notes:o,getCellHeight:()=>g,getCanvasPos:v=>To(e,v,n,ue),findNoteAt:(v,Y)=>Ao(v,Y,o,R,g,f),scheduleRedraw:w,getPitchFromRow:X,getSnappedBeatFromX:v=>Hn(v,s,()=>f),updatePreview:v=>r=v,clearPreview:()=>r=null,getSelectedNote:()=>u,setSelectedNote:v=>{u=v,j=v?[v]:[]},getSelectedNotes:()=>j,setSelectedNotes:v=>{j=v,u=v.length===1?v[0]:null},setHoveredNote:v=>a=v,onNotesChanged:me};function z(v){ie&&ie.detach(e),ie=v,ie&&ie.attach(e)}function B(){u=null,j=[],a=null,J=[],w()}const k=gn();z(k==="note-placement"?Ft(A):k==="select"?Ht(A):null);let U=Oo(v=>{var Y,ke;r=null,c=null,J=[],(Y=A.clearPreview)==null||Y.call(A),(ke=A.setPastePreviewNotes)==null||ke.call(A,null),A.selectionBox&&(A.selectionBox.active=!1,A.selectionBox=null),B(),z(v==="note-placement"?Ft(A):v==="select"?Ht(A):null),w()});const H={canvas:e,scheduleRedraw:w,drawPlayhead:F,getSelectedNote:()=>u,clearSelection:B,getPreviewNote:()=>r,zoomIn:C,zoomOut:N,getXForBeat:v=>v*f,setMouseHandler:z,setCursor:v=>{e.style.cursor=v},gridContext:A,getSelectedNotes:()=>j,setSelectedNotes:v=>{j=v,u=v.length===1?v[0]:null},destroy(){U(),Go()}};A.setPastePreviewNotes=v=>{c=v};let J=[];return A.getHighlightedNotes=()=>J,A.setHighlightedNotes=v=>{J=v},A.grid=H,H}const Yo={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function ot(e){const t=e.match(/^([A-Ga-g][#b]?)(-?\d+)$/);if(!t)return null;const[,n,o]=t,s=n.toUpperCase(),i=Yo[s];return i===void 0?null:12*(parseInt(o,10)+1)+i}class vn{constructor(t,n,o=se,s=ee,i="fluidr3-gm/acoustic_grand_piano"){this.container=t,this.config={...n},this.context=o,this.destination=s,this.instrumentName=i,this.notes=[],this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.isMuted=!1,this.isSoloed=!1,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this._initCanvases())}async initInstrument(){try{await Ze(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){const t=this.container.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument(),console.log(`[SEQ:${this.id}] Instrument set to:`,t)}playNote(t,n,o=100,s=!1){return Cs(this.instrumentName,t,n,o,s)}_initCanvases(){const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),o=this.container.querySelector("#grid-scroll-container");this.grid=zo(t,n,o,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(t){const n=D();this.clampNotesToGrid();const o=n*this.config.cellWidth+(this.config.labelWidth||64),s=this.container.querySelector("canvas.note-grid"),i=this.container.querySelector(".playhead-canvas"),r=this.container.querySelector(".mini-contour");s&&(s.width=o,s.style.width=`${o}px`),i&&(i.width=o,i.style.width=`${o}px`),r&&De(r,this.notes,this.config,this.colorIndex),this.redraw()}clampNotesToGrid(){const t=D(),n=this.notes.filter(o=>o.start<t);n.forEach(o=>{o.start+o.duration>t&&(o.duration=t-o.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear(),this._beatHandler=t=>{var o;if((o=this.grid)==null||o.drawPlayhead(this.grid.getXForBeat(t)),!this.shouldPlay)return;const n=60/fe();for(const s of this.notes){const i=s.start,r=s.start+s.duration;if(!this._activeNotes.has(s)&&i<=t&&t<=r){const c=s.duration*n;this.playNote(s.pitch,c),this._activeNotes.add(s)}}},this._unsub=dt(this._beatHandler),this._beatHandler(0)}stop(){var t,n,o;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const s of this._activeNotes){const i=this._noteHandlers.get(s);(t=i==null?void 0:i.forceStop)==null||t.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(o=this.grid)==null||o.drawPlayhead(null),this.redraw()}pause(){var t;for(const n of this._activeNotes){const o=this._noteHandlers.get(n);(t=o==null?void 0:o.stop)==null||t.call(o)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=dt(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.isMuted=!this.isMuted,this.isMuted&&(this.isSoloed=!1),this.updateTrackStyle()}toggleSolo(){this.isSoloed=!this.isSoloed,this.isSoloed&&(this.isMuted=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t.classList.toggle("bg-red-600",this.isMuted),t.classList.toggle("bg-gray-700",!this.isMuted),n.classList.toggle("bg-yellow-200",this.isSoloed),n.classList.toggle("bg-gray-700",!this.isSoloed),this.container.classList.toggle("opacity-40",this.isMuted&&!this.isSoloed),this.container.classList.toggle("opacity-100",!(this.isMuted&&!this.isSoloed))}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,o,s])=>({pitch:n,start:o,duration:s})))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:o}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),o&&(this.instrumentName=o),this.redraw()}async exportToOffline(){const t=60/fe(),n=await Ze(this.instrumentName,this.context,this.destination);for(const o of this.notes){const s=o.start*t,i=o.duration*t;n.start({note:ot(o.pitch),duration:i,velocity:100,time:s,loop:!1})}}}const W={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0},L=[],xo=document.getElementById("sequencers-container"),Vo=document.getElementById("sequencer-template"),Sn=document.getElementById("add-sequencer");function Ke(e,t){var n,o,s,i;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-out-btn"))==null||o.classList.toggle("hidden",!t),(s=e.querySelector(".zoom-reset-btn"))==null||s.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!t)}function oe(){return L}function Qo(e){const t=String(e);return oe().find(n=>{var o;return String(n.id)===t||String((o=n.config)==null?void 0:o.id)===t})}function $t(){const e=L.some(t=>t.solo);L.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function Ne(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function wn(e){const n=Vo.content.cloneNode(!0).querySelector(".sequencer");xo.insertBefore(n,Sn);const o=L.length,s=e?{id:o,...W,...e.config}:{id:o,...W},i=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",r=new vn(n,s,se,ee,i);r.id=o,r.colorIndex=o,r.mute=!1,r.solo=!1,r.shouldPlay=!0;const c=n.querySelector("canvas.mini-contour");e&&r.setState(e),De(c,r.notes,r.config,r.colorIndex),r.updateTrackLabel(),r.initInstrument();const a=n.querySelector(".collapse-btn"),u=a.querySelector("use"),d=n.querySelector(".sequencer-body");a.addEventListener("click",()=>{const h=d.classList.toggle("hidden");u.setAttribute("href",h?"#icon-caret-up":"#icon-caret-down"),c.classList.toggle("hidden",!h),Ke(n,!h),h&&De(c,r.notes,r.config,r.colorIndex)}),n.querySelector(".delete-btn").addEventListener("click",()=>{const h=document.getElementById("delete-confirm-modal"),p=document.getElementById("delete-confirm"),E=document.getElementById("delete-cancel");h.classList.remove("hidden");const y=()=>{const S=xn(r.id,r.instrumentName,r.notes),C=Vn(r.id,r.instrumentName,r.notes);q(S,C),w()},b=()=>{w()},w=()=>{h.classList.add("hidden"),p.removeEventListener("click",y),E.removeEventListener("click",b)};p.addEventListener("click",y),E.addEventListener("click",b)});const l=n.querySelector(".mute-btn"),f=n.querySelector(".solo-btn"),g=n.querySelector(".instrument-select-btn");return l.addEventListener("click",()=>{r.mute=!r.mute,r.mute&&(r.solo=!1,f.classList.remove("bg-yellow-200"),f.classList.add("bg-gray-700"),f.classList.remove("hover:bg-yellow-400"),f.classList.add("hover:bg-purple-700"),Ne(f,!1)),Ne(l,r.mute),$t();const h=Ve();r.seekTo(h)}),f.addEventListener("click",()=>{r.solo=!r.solo,r.solo&&(r.mute=!1,Ne(l,!1)),f.classList.toggle("bg-yellow-200",r.solo),f.classList.toggle("bg-gray-700",!r.solo),f.classList.toggle("hover:bg-yellow-400",r.solo),f.classList.toggle("hover:bg-purple-700",!r.solo),$t();const h=Ve();r.seekTo(h)}),g.addEventListener("click",async()=>{const h=document.getElementById("instrument-select-modal"),p=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const E=r.instrumentName||"fluidr3-gm/acoustic_grand_piano",[y,b]=E.split("/");p.value=y,p.dispatchEvent(new CustomEvent("change",{detail:{preselect:E}})),h.dataset.currentSequencer=r.id,h.classList.remove("hidden")}),Ne(l,!1),Ne(f,!1),f.classList.add("hover:bg-purple-700"),L.push(r),{seq:r,wrapper:n}}function Jo(){L.slice().forEach(n=>n.destroy()),L.length=0;const e=$e(),t=structuredClone(e);t.sequencers=[],vo(),sn(t),He(t)}function Zo(){document.getElementById("global-mini-contour"),Sn.addEventListener("click",()=>{const e=L.length;q(tn(e,"fluidr3-gm/acoustic_grand_piano"),wt(e))})}function es(){localStorage.setItem("userConfig",JSON.stringify(Me()))}function ts(){const e=localStorage.getItem("userConfig");if(e){const t=JSON.parse(e);Oe(t)}}ts();const Ut=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];function yt(){return Me().openaiApiKey}function Wt(){return Me().openaiModel}function ns(e){Oe({openaiApiKey:e})}function os(e){if(!Ut.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${Ut.join(", ")}`);Oe({openaiModel:e})}function ss(){var s;const e=document.getElementById("openai-key-input"),t=document.getElementById("openai-model-select"),n=document.getElementById("config-save"),o=document.querySelectorAll("#config-close, #config-close-bottom");e.value=yt(),t.value=Wt(),n.addEventListener("click",()=>{ns(e.value),os(t.value),es(),document.getElementById("userconfig-modal").classList.add("hidden")}),o.forEach(i=>{i.addEventListener("click",()=>{e.value=yt(),t.value=Wt(),document.getElementById("userconfig-modal").classList.add("hidden")})}),(s=document.getElementById("key-not-set-ok"))==null||s.addEventListener("click",()=>{var i;(i=document.getElementById("openai-key-not-set-modal"))==null||i.classList.add("hidden")})}const is=["Darkroom","Seashell","Cyberpunk","Classic Blue","Midnight"],rs=["Track Color","Pitch Class Contrast","Scriabin","Octave Bands"];function as(){const e=document.getElementById("grid-color-select"),t=document.getElementById("note-color-select");for(const o of is){const s=document.createElement("option");s.value=o,s.textContent=o,e.appendChild(s)}for(const o of rs){const s=document.createElement("option");s.value=o,s.textContent=o,t.appendChild(s)}const n=Me();e.value=n.gridColorScheme,t.value=n.noteColorScheme,e.addEventListener("change",o=>{Oe({gridColorScheme:o.target.value}),oe().forEach(s=>{var i;return(i=s.grid)==null?void 0:i.scheduleRedraw()})}),t.addEventListener("change",o=>{Oe({noteColorScheme:o.target.value}),oe().forEach(s=>{var i;return(i=s.grid)==null?void 0:i.scheduleRedraw()})})}function cs(){document.getElementById("userconfig-modal");const e=document.querySelectorAll(".settings-tab"),t=document.querySelectorAll(".settings-section");function n(){e.forEach(o=>{const s=o.dataset.tab,i=document.getElementById(s),r=i&&!i.classList.contains("hidden");o.classList.toggle("text-purple-500",r),o.classList.toggle("opacity-100",r),o.classList.toggle("text-gray-500",!r),o.classList.toggle("opacity-50",!r)})}e.forEach(o=>{o.addEventListener("click",()=>{const s=o.dataset.tab;t.forEach(r=>r.classList.add("hidden"));const i=document.getElementById(s);i&&i.classList.remove("hidden"),n()})}),n(),ss(),as()}const ls={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"};let Kt=!1,le=!1,de=!1;function ds({getSequencers:e,onPlay:t,onStop:n,onPause:o,onResume:s,onDurationChange:i,onSnapChange:r,onToggleLoop:c,onTempoChange:a,onSave:u,onLoad:d,onMeasuresChange:m,onBeatsPerMeasureChange:l}){if(Kt)return;Kt=!0;const f=document.getElementById("play-button"),g=f.querySelector("use"),h=document.getElementById("stop-button"),p=document.getElementById("note-duration"),E=document.getElementById("dotted-note-btn"),y=document.getElementById("triplet-note-btn");p.value=String(W.currentDuration||1);const b=document.getElementById("snap-resolution");b.value=String(W.snapResolution||.25);const w=document.getElementById("loop-toggle"),S=document.getElementById("tempo-input"),C=document.getElementById("save-button"),N=document.getElementById("load-button"),M=document.getElementById("load-input"),I=document.getElementById("measures-input"),T=document.getElementById("beats-per-measure-input"),F=document.getElementById("config-button"),R=document.getElementById("export-modal"),X=document.getElementById("export-json"),me=document.getElementById("export-wav"),ie=document.getElementById("export-midi"),j=document.getElementById("export-cancel");g.setAttribute("href","#icon-play"),f.addEventListener("click",()=>{!le&&!de?(le=!0,de=!1,t==null||t(),g.setAttribute("href","#icon-pause")):le?(le=!1,de=!0,o==null||o(),g.setAttribute("href","#icon-play")):de&&(le=!0,de=!1,s==null||s(),g.setAttribute("href","#icon-pause"))}),h.addEventListener("click",()=>{n==null||n(),le=!1,de=!1,g.setAttribute("href","#icon-play")});const A={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125};window.addEventListener("keydown",B=>{var H;if(document.querySelector(".ai-modal:not(.hidden)"))return;const U=(H=document.activeElement)==null?void 0:H.tagName;if(!(U==="INPUT"||U==="TEXTAREA")){if(B.code==="Space"){B.preventDefault(),f.click();return}if((B.metaKey||B.ctrlKey)&&(B.key==="z"&&Eo(),B.key==="y"&&bo()),(B.metaKey||B.ctrlKey)&&B.key.toLowerCase()==="r"){B.preventDefault();return}if(gn()===ne.NOTE_PLACEMENT){if(A.hasOwnProperty(B.code)){B.preventDefault();const J=A[B.code];p.value=J,p.dispatchEvent(new Event("change"))}if(B.key==="."){B.preventDefault(),E==null||E.click();return}if(B.key==="/"){B.preventDefault(),y==null||y.click();return}}}}),p.addEventListener("change",B=>{const k=parseFloat(B.target.value);z(k),i==null||i(k),e==null||e().forEach(U=>{const H=U.grid;if(H!=null&&H.getPreviewNote){const J=H.getPreviewNote();J&&(J.duration=k,H.scheduleRedraw())}})});function z(B){document.querySelectorAll(".note-duration-btn").forEach(U=>{const H=parseFloat(U.dataset.value);U.classList.remove("bg-purple-700"),U.classList.remove("bg-gray-800"),H===B?U.classList.add("bg-purple-700"):U.classList.add("bg-gray-800")})}b.addEventListener("change",B=>{const k=B.target.value;ls.hasOwnProperty(k)&&(W.snapResolution=parseFloat(k),b.value=String(k),r==null||r(W.snapResolution))}),w.addEventListener("change",B=>{c==null||c(B.target.checked)}),S.addEventListener("change",B=>{const k=parseInt(B.target.value,10);isNaN(k)||a==null||a(k)}),C.addEventListener("click",()=>{R?R.classList.remove("hidden"):u==null||u("json")}),N.addEventListener("click",()=>{M.click()}),M.addEventListener("change",B=>{const k=B.target.files[0];k&&(d==null||d(k)),B.target.value=""}),X&&X.addEventListener("click",()=>{R.classList.add("hidden"),u==null||u("json")}),me&&me.addEventListener("click",()=>{R.classList.add("hidden"),u==null||u("wav")}),ie&&ie.addEventListener("click",()=>{R.classList.add("hidden"),u==null||u("midi")}),j&&j.addEventListener("click",()=>{R.classList.add("hidden")}),F.addEventListener("click",()=>{document.getElementById("userconfig-modal").classList.remove("hidden")}),cs(),I.value=We(),T.value=Ue(),I.addEventListener("change",B=>{const k=parseInt(B.target.value,10);!isNaN(k)&&k>0&&(m==null||m(k))}),T.addEventListener("change",B=>{const k=parseInt(B.target.value,10);!isNaN(k)&&k>0&&(l==null||l(k))}),z(parseFloat(p.value))}function us(){le=!1,de=!1;const t=document.getElementById("play-button").querySelector("use");t&&t.setAttribute("href","#icon-play")}function fs(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function ms(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}let O=null,Ae=0;const it=new Map;async function ce(){O||(O=await xt(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function Bn(){return se}async function Ze(e,t=se,n=null){await ce();const[o,s]=e.includes("/")?e.split("/"):["musyngkite",e],i=t instanceof OfflineAudioContext;it.has(t)||it.set(t,new Map);const r=it.get(t),c=`${o}/${s}`;if(r.has(c))return r.get(c);let a;if(o==="smolken")a=new O.Smolken(t,{instrument:s,destination:n||ee,disableScheduler:i}),await he(a.load);else if(o==="splendidgrandpiano")a=new O.SplendidGrandPiano(t,{destination:n||ee,disableScheduler:i}),await he(a.load);else if(o==="electricpiano")a=new O.ElectricPiano(t,{instrument:s,destination:n||ee,disableScheduler:i}),await he(a.load);else if(o==="mallets")a=new O.Mallet(t,{instrument:s,destination:n||ee,disableScheduler:i}),await he(a.load);else if(o==="drummachines"){a=new O.DrumMachine(t,{instrument:s,destination:n||ee,disableScheduler:i}),await he(a.load);const u=a.getSampleNames(),d=new Map;u.forEach((m,l)=>{const f=36+l;d.set(f,m)}),a.__midiMap=d}else{const d={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[o.toLowerCase()]||"MusyngKite",m=await vs();console.log(`[Soundfont] Available kits: ${m.join(", ")}`),console.log(`[Soundfont] Requested: kit=${d} instrument=${s}`);const f=`https://gleitz.github.io/midi-js-soundfonts/${d}/${s}-ogg.js`;a=new O.Soundfont(t,{instrument:s,instrumentUrl:f,kit:d,destination:n||ee,disableScheduler:i}),await he(a.load)}return r.set(c,a),a}async function gs(){return await ce(),O.getMalletNames()}async function hs(){return await ce(),O.getElectricPianoNames()}async function ps(){return await ce(),["splendidgrandpiano"]}async function ys(){return await ce(),O.getDrumMachineNames()}async function Es(){return await ce(),O.getSmolkenNames()}async function bs(e="MusyngKite"){await ce();const t=await O.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function vs(){return await ce(),O.getSoundfontKits()}function Ss(){Ae++,Ae===1&&fs()}function ws(){Ae--,Ae<=0&&(Ae=0,ms())}async function he(e){Ss();try{await e}finally{ws()}}let re=null,Et=null;async function Xt(e){if(Et===e)return;re=await Ze(e),Et=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function Bs(){return Et}function Ln(e,t=100,n=!1){var c;if(!re)return null;const s=Bn().currentTime,i=ot(e),r=((c=re.__midiMap)==null?void 0:c.get(i))??i;return re.start({note:r,stopId:r,velocity:t,time:s,loop:n}),()=>{re.stop({stopId:r})}}function Ls(e){var o;if(!re)return;const t=ot(e),n=((o=re.__midiMap)==null?void 0:o.get(t))??t;re.stop({stopId:n})}async function Cs(e,t,n,o=100,s=!1,i=null,r=null,c=null){var l;const a=r||Bn(),u=await Ze(e,a,c),d=ot(t),m=((l=u.__midiMap)==null?void 0:l.get(d))??d;return u.start({note:m,duration:n,velocity:o,loop:s,time:i??a.currentTime}),null}const se=new(window.AudioContext||window.webkitAudioContext),st=se.createAnalyser();st.fftSize=2048;const ee=se.createGain();ee.connect(st);st.connect(se.destination);function Ms(e){se.resume();try{const t=Ln(e,100,20);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}se.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let Gt=!1,Ge=null;function ks(e,t){if(Gt)return;Gt=!0,Ge=t;const n=e.getContext("2d"),o=new Map,s=new Set;function i(d,m){const l=Ge();for(const f of Object.values(l))if(f.isBlack&&d>=f.x&&d<=f.x+f.width&&m>=0&&m<=f.height)return f.note;for(const f of Object.values(l))if(!f.isBlack&&d>=f.x&&d<=f.x+f.width&&m>=0&&m<=f.height)return f.note;return null}function r(d){if(!d||s.has(d))return;const m=Ms(d);m&&(o.set(d,m),s.add(d),Re(n,Ge(),s))}function c(d){if(!s.has(d))return;const m=o.get(d);m&&(m.stop(),o.delete(d)),s.delete(d),Re(n,Ge(),s)}function a(){for(const d of s)c(d)}let u=!1;e.addEventListener("mousedown",d=>{u=!0;const m=e.getBoundingClientRect(),l=d.clientX-m.left,f=d.clientY-m.top,g=i(l,f);r(g)}),e.addEventListener("mousemove",d=>{if(!u)return;const m=e.getBoundingClientRect(),l=d.clientX-m.left,f=d.clientY-m.top,g=i(l,f);r(g)}),e.addEventListener("mouseup",()=>{u=!1,a()}),e.addEventListener("mouseleave",()=>{u=!1,a()})}const Cn=[..."qwertyuiop[zxcvbnm,./"],Mn=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];let bt=!1,je=null,Pe=null,_e=null;function Ns(e,t){if(bt)return;bt=!0;const n=e.getContext("2d"),o=new Set,s=new Set,i=new Map,r=Cn,c=Mn;je=t;function a(){const m=je(),l=Object.values(m).filter(h=>!h.isBlack).sort((h,p)=>h.x-p.x).map(h=>h.note),f=Object.values(m).filter(h=>h.isBlack).sort((h,p)=>h.x-p.x).map(h=>h.note),g={};return r.forEach((h,p)=>{l[p]&&(g[h]=l[p])}),c.forEach((h,p)=>{f[p]&&(g[h]=f[p])}),g}function u(m){const l=a(),f=l[m];if(!(!f||o.has(m))){if(o.add(m),!s.has(f)){const g=Ln(f,100,As());g&&(i.set(f,{stop:g}),s.add(f))}Re(n,je(),s,l)}}function d(m){const l=a(),f=l[m];f&&(o.delete(m),s.has(f)&&(Ls(f),i.delete(f),s.delete(f)),Re(n,je(),s,l))}Pe=m=>{m.repeat||u(m.key)},_e=m=>{d(m.key)},window.addEventListener("keydown",Pe),window.addEventListener("keyup",_e)}function Is(){Pe&&(window.removeEventListener("keydown",Pe),Pe=null),_e&&(window.removeEventListener("keyup",_e),_e=null),bt=!1}let ye=3,pe=Vt(ye),ze=!1;async function Ts(e){const t=e.getContext("2d");await Xt("fluidr3-gm/acoustic_grand_piano");const n=Cn,o=Mn;function s(){const p=Object.values(pe).filter(b=>!b.isBlack).sort((b,w)=>b.x-w.x).map(b=>b.note),E=Object.values(pe).filter(b=>b.isBlack).sort((b,w)=>b.x-w.x).map(b=>b.note),y={};return n.forEach((b,w)=>{p[w]&&(y[b]=p[w])}),o.forEach((b,w)=>{E[w]&&(y[b]=E[w])}),y}function i(){pe=Vt(ye);const p=ze?s():null;Re(t,pe,new Set,p)}ks(e,()=>pe),i(),document.getElementById("octave-up").addEventListener("click",()=>{ye<7&&(ye++,i())}),document.getElementById("octave-down").addEventListener("click",()=>{ye>1&&(ye--,i())});const r=document.getElementById("disable-keyboard-inputs");r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700"),r.addEventListener("click",()=>{ze=!ze,ze?(Ns(e,()=>pe),r.classList.remove("bg-gray-700"),r.classList.add("bg-purple-600")):(Is(),r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700")),i()});const c=document.getElementById("instrument-select-btn"),a=document.getElementById("instrument-select-modal"),u=document.getElementById("instrument-select"),d=document.getElementById("instrument-select-confirm"),m=document.getElementById("instrument-cancel-btn"),l=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([p,E])=>{const y=document.createElement("option");y.value=p,y.textContent=p.replace(/_/g," ").replace(/\b\w/g,b=>b.toUpperCase()),l.appendChild(y)}),l.addEventListener("change",async p=>{var w;const E=l.value,y=document.getElementById("instrument-select"),b=((w=p.detail)==null?void 0:w.preselect)||null;try{let S;E==="mallets"?S=await gs():E==="electricpiano"?S=await hs():E==="splendidgrandpiano"?S=await ps():E==="drummachines"?S=await ys():E==="smolken"?S=await Es():["fluidr3-gm","musyngkite","fatboy"].includes(E)?S=await bs({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[E]):S=await(await fetch(`/static/${E}.json`)).json(),y.innerHTML="",S.forEach(C=>{const N=document.createElement("option");N.value=`${E}/${C}`,N.textContent=C.split("_").map(M=>M.charAt(0).toUpperCase()+M.slice(1)).join(" "),y.appendChild(N)}),y.value=b||`${E}/${S[0]}`}catch(S){console.error(`Failed to load instruments for library: ${E}`,S)}}),l.dispatchEvent(new Event("change")),c.addEventListener("click",async()=>{const p=Bs()||"fluidr3-gm/acoustic_grand_piano",[E,y]=p.split("/");l.value=E,await l.dispatchEvent(new CustomEvent("change",{detail:{preselect:p}})),a.classList.remove("hidden"),delete a.dataset.currentSequencer}),d.addEventListener("click",async()=>{const p=u.value;a.classList.add("hidden");const E=a.dataset.currentSequencer;if(E){console.log("[Modal] Looking up sequencer with id:",E);const y=Qo(E);console.log("[Modal] Lookup result:",y),y&&y.setInstrument(p),a.dataset.currentSequencer=""}else try{await Xt(p)}catch(y){console.error("Failed to load global instrument:",p,y)}});let g=!1;const h=document.getElementById("instrument-loop-toggle");h.addEventListener("change",()=>{g=h.checked,console.log("[UI] Loop mode:",g)}),m.addEventListener("click",()=>{a.classList.add("hidden")})}function As(){var e;return((e=document.getElementById("instrument-loop-toggle"))==null?void 0:e.checked)||!1}function Ps(e,t){const n=t.getContext("2d"),o=t.width,s=t.height,i=new Uint8Array(e.fftSize),r=new Uint8Array(e.frequencyBinCount),c=document.createElement("canvas");c.width=o,c.height=s;const a=c.getContext("2d");let u="frequency";function d(){e.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,o,s),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const g=o/i.length;let h=0;for(let p=0;p<i.length;p++){const y=i[p]/128*s/2;p===0?n.moveTo(h,y):n.lineTo(h,y),h+=g}n.lineTo(o,s/2),n.stroke()}function m(){e.getByteFrequencyData(r),n.fillStyle="#000",n.fillRect(0,0,o,s),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,s),n.fillRect(o-1,0,1,s);const g=128,h=2,p=[];for(let E=0;E<g;E++)p.push(E*o/(g-1));p[p.length-1]=o-1;for(let E=0;E<g;E++){const y=p[E],b=E<g-1?p[E+1]:o,w=Math.max(1,b-y-h),S=20,C=2e4,N=E/(g-1),M=S*Math.pow(C/S,N),T=Math.min(r.length-1,Math.floor(M/22050*r.length)),F=r[T]/255,R=Math.max(1,F*s),X=240-N*240;n.fillStyle=`hsl(${X}, ${80+F*20}%, ${40+F*40}%)`,n.fillRect(y,s-R,w,R)}}function l(){e.getByteFrequencyData(r),c.initialized||(a.fillStyle="#000",a.fillRect(0,0,o,s),c.initialized=!0),a.drawImage(c,-1,0),a.fillStyle="#000",a.fillRect(o-1,0,1,s);const g=128,h=20,p=2e4;for(let E=0;E<g;E++){const y=E/(g-1),b=h*Math.pow(p/h,y),S=Math.min(r.length-1,Math.floor(b/22050*r.length)),C=r[S]/255,N=s-1-Math.floor(E*s/g);if(C<.05)continue;const M=Math.floor(C*255),I=Math.floor(C*(255-y*200)),T=Math.floor(C*(100+y*155));a.fillStyle=`rgb(${M}, ${I}, ${T})`,a.fillRect(o-1,N,1,1)}n.fillStyle="#000",n.fillRect(0,0,o,s),n.drawImage(c,0,0)}function f(){switch(requestAnimationFrame(f),u){case"frequency":m();break;case"spectrogram":l();break;case"waveform":default:d()}}return f(),{setMode(g){["waveform","frequency","spectrogram"].includes(g)&&(u=g,n.clearRect(0,0,o,s),u==="spectrogram"&&a.clearRect(0,0,o,s))}}}function _s(e,t){const n=Ps(st,e),o=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let s=0;function i(){s=(s+1)%o.length;const{name:r,emoji:c}=o[s];n.setMode(r),t.textContent=c,t.title=`Mode: ${r}`}t.addEventListener("click",i),i()}function qs(){var m;const e=document.getElementById("global-mini-expand-btn"),t=document.getElementById("global-mini-contour"),n=document.getElementById("global-mini-playhead"),o=(m=t==null?void 0:t.parentElement)==null?void 0:m.parentElement,s=t==null?void 0:t.parentElement,i=e.querySelector("svg use"),r=document.querySelector(".footer-spacer"),c=40;let a=!1;function u(l,f){const g=l.offsetWidth;l.style.height=f+"px",l.height=f,l.width=g}o.style.height=c+"px",s.style.height=c+"px",u(t,c),u(n,c),Q(t,oe());function d(){a=!a;const l=a?200:40;o.style.height=l+"px",s.style.height=l+"px",u(t,l),u(n,l),i.setAttribute("href",a?"#icon-caret-down":"#icon-caret-up"),r.style.height=l-40+140+"px",Q(t,oe())}e==null||e.addEventListener("click",d)}function Rs(e){if(!e.length)throw new Error("No tracks to export.");const t=fe(),n=Ue(),o=We(),s={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:o},i:e.map(r=>r.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.map(({notes:r})=>({n:r.map(c=>[c.pitch,c.start,c.duration])}))},i=new Blob([JSON.stringify(s)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function Ds(e){if(!e.length)return;const n=60/fe(),o=Math.max(...e.flatMap(d=>d.notes.map(m=>(m.start+m.duration)*n+.2))),s=44100,i=new OfflineAudioContext(2,Math.ceil(s*o),s);for(const d of e){const m=d.instrument||"fluidr3-gm/acoustic_grand_piano",l=new vn(null,d.config,i,i.destination,m);l.setState(d),await l.exportToOffline()}const r=await i.startRendering(),c=Os(r),a=URL.createObjectURL(c),u=document.createElement("a");u.href=a,u.download=`session-${Date.now()}.wav`,u.click(),URL.revokeObjectURL(a)}function Os(e){const t=e.numberOfChannels,n=e.length*t*2,o=new DataView(new ArrayBuffer(44+n)),s=(r,c)=>{for(let a=0;a<c.length;a++)o.setUint8(r+a,c.charCodeAt(a))};s(0,"RIFF"),o.setUint32(4,36+n,!0),s(8,"WAVE"),s(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,t,!0),o.setUint32(24,e.sampleRate,!0),o.setUint32(28,e.sampleRate*t*2,!0),o.setUint16(32,t*2,!0),o.setUint16(34,16,!0),s(36,"data"),o.setUint32(40,n,!0);let i=44;for(let r=0;r<e.length;r++)for(let c=0;c<t;c++){const a=e.getChannelData(c)[r],u=Math.max(-1,Math.min(1,a));o.setInt16(i,u*32767,!0),i+=2}return new Blob([o.buffer],{type:"audio/wav"})}async function Fs(e){var r,c,a;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const o={bpm:((r=n.c)==null?void 0:r.b)??120,beatsPerMeasure:((c=n.c)==null?void 0:c.bpm)??4,totalMeasures:((a=n.c)==null?void 0:a.tm)??8},s=Array.isArray(n.i)?n.i:[];return{tracks:n.tr.map((u,d)=>{if(!Array.isArray(u.n))throw new Error(`Track ${d} missing \`n\` (notes) array.`);const m=u.n.map(([f,g,h])=>({pitch:f,start:g,duration:h})),l=s[d]||"fluidr3-gm/acoustic_grand_piano";return{notes:m,instrument:l}}),globalConfig:o}}function Hs(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),o=document.getElementById("triplet-note-btn");let s=!1,i=!1;function r(a){a=parseFloat(a);let u=a;s?u=a*1.5:i&&(u=a*(2/3));let d=Array.from(t.options).find(m=>Math.abs(parseFloat(m.value)-u)<1e-4);d||(d=new Option(u.toString(),u.toString()),t.add(d)),t.value=d.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(d=>d.classList.remove("bg-purple-600")),a.classList.add("bg-purple-600");const u=parseFloat(a.dataset.value);r(u)})}),n.addEventListener("click",()=>{i&&(i=!1,o.classList.remove("bg-purple-600")),s=!s,n.classList.toggle("bg-purple-600"),c()}),o.addEventListener("click",()=>{s&&(s=!1,n.classList.remove("bg-purple-600")),i=!i,o.classList.toggle("bg-purple-600"),W.isTripletMode=i,L.forEach(a=>{a.config.isTripletMode=i}),c()});function c(){const a=document.querySelector(".note-duration-btn.bg-purple-600");if(a){const u=parseFloat(a.dataset.value);r(u)}}r(W.currentDuration||1)}let Z=null,et=null;function $s(e){et=e,Z=et.getContext("2d")}function be(e){if(!Z||!et)return;const{width:t,height:n}=et;Z.clearRect(0,0,t,n);const o=Math.round(e)+.5;Z.strokeStyle="#ff00ff",Z.lineWidth=1,Z.beginPath(),Z.moveTo(o,0),Z.lineTo(o,n),Z.stroke()}let tt=!1,ve=null,vt=!1;function Us(e,t){ve=e,ve.addEventListener("mousedown",Ws),window.addEventListener("mousemove",Ks),window.addEventListener("mouseup",Xs)}function Ws(e){ln()&&(dn(),L.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),vt=!0),tt=!0,kn(e)}function Ks(e){tt&&kn(e)}function Xs(){tt&&(tt=!1,vt&&(un(),L.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),vt=!1))}function kn(e){const t=ve.getBoundingClientRect(),n=ve.width/t.width;let o=(e.clientX-t.left)*n;o=Math.max(0,Math.min(ve.width,o));const s=D(),i=o/ve.width*s;ae(i),be(o)}const _t={maxBeatsContext:32,extendBeatsAmount:16};function ni(){return _t.maxBeatsContext}function oi(){return _t.extendBeatsAmount}function St(e,t,n,o){const s=D(),i=o/s*t;e.clearRect(0,0,t,n);const r=_t.maxBeatsContext,a=Math.max(0,o-r)/s*t,u=i-a;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(a,0,u,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke()}let jt=!1;function zt(){if(!jt){jt=!0;const o=document.getElementById("extend-use-tags"),s=document.getElementById("extend-tags");if(o&&s){let u=function(){const d=o.checked;s.disabled=!d,s.classList.toggle("opacity-50",!d),s.classList.toggle("cursor-not-allowed",!d)};u(),o.addEventListener("change",u)}const i=document.getElementById("extend-start-help-btn"),r=document.getElementById("extend-start-help-popup"),c=document.getElementById("extend-start-help-close");i&&r&&c&&(i.addEventListener("click",()=>r.classList.remove("hidden")),c.addEventListener("click",()=>r.classList.add("hidden")),document.addEventListener("click",u=>{!r.contains(u.target)&&u.target!==i&&r.classList.add("hidden")}));const a=document.querySelector("#ai-extend-modal .generate-btn");a&&a.addEventListener("click",async()=>{const{extendTracksWithAI:u}=await xt(async()=>{const{extendTracksWithAI:d}=await import("./extendTracks-DCCpU_04.js");return{extendTracksWithAI:d}},__vite__mapDeps([0,1]));await u()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",oe().forEach((s,i)=>{const r=`extend-track-${i}`,c=document.createElement("div");c.className="flex items-center gap-2";const a=document.createElement("input");a.type="checkbox",a.id=r,a.dataset.index=i,a.checked=!0,a.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const u=document.createElement("label");u.htmlFor=r,u.className="text-sm text-gray-200",u.textContent=s.config.name||`Track ${i+1}`,a.addEventListener("change",()=>{Ie()}),c.appendChild(a),c.appendChild(u),e.appendChild(c)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!0),Ie()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!1),Ie()}),Ie())}let rt=!1,qe=0;function si(){return qe}function Gs(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d"),o=e.clientWidth,s=e.clientHeight;e.width=o,e.height=s,t.width=o,t.height=s,Ie(),St(n,o,s,qe),t.addEventListener("mousedown",r=>{rt=!0,i(r.offsetX)}),window.addEventListener("mouseup",()=>{rt=!1}),window.addEventListener("mousemove",r=>{if(!rt)return;const c=t.getBoundingClientRect();i(r.clientX-c.left)});function i(r){const c=D(),a=Math.max(0,Math.min(r,o));qe=Math.round(a/o*c),St(n,o,s,qe)}}function Ie(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead"),n=t.getContext("2d"),o=t.width,s=t.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),r=Array.from(i).filter(a=>a.checked).map(a=>parseInt(a.dataset.index,10)),c=oe().filter((a,u)=>r.includes(u));Q(e,c),St(n,o,s,qe)}function js(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),o=document.getElementById("note-duration-controls"),s=document.getElementById("select-mode-controls"),i=document.getElementById("velocity-mode-controls");function r(a){[e,t,n].forEach(u=>{u.classList.remove("bg-purple-600"),u.classList.add("bg-gray-800")}),a.classList.remove("bg-gray-800"),a.classList.add("bg-purple-600")}function c(a){[o,s,i].forEach(u=>{u.classList.add("hidden")}),a.classList.remove("hidden")}e.addEventListener("click",()=>{r(e),c(o),G("note-placement")}),t.addEventListener("click",()=>{r(t),c(s),G("select")}),n.addEventListener("click",()=>{r(n),c(i),G("velocity")}),window.addEventListener("keydown",a=>{var m;const u=(m=document.activeElement)==null?void 0:m.tagName;if(!(u==="INPUT"||u==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(a.key){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),r(e),c(o),G("note-placement")}function zs(){const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),o=document.getElementById("ai-control-panel");function s(){document.querySelectorAll(".sequencer").forEach(l=>{const f=l.querySelector(".delete-btn"),g=l.querySelector(".collapse-btn"),h=g.querySelector("use");f.classList.add("button-locked"),g.classList.add("button-locked");const p=l.querySelector(".sequencer-body"),E=l.querySelector(".mini-contour");Ke(l,!1),p.classList.contains("hidden")||(p.classList.add("hidden"),E.classList.remove("hidden"),h.setAttribute("href","#icon-caret-up"))})}function i(){document.querySelectorAll(".sequencer").forEach(l=>{const f=l.querySelector(".delete-btn"),g=l.querySelector(".collapse-btn");f.classList.remove("button-locked"),g.classList.remove("button-locked")})}function r(){e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),o.classList.add("hidden"),i()}function c(){if(!yt()){document.getElementById("openai-key-not-set-modal").classList.remove("hidden");return}t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),o.classList.remove("hidden"),s()}e.addEventListener("click",r),t.addEventListener("click",c);const a=document.getElementById("ai-inpaint-modal"),u=document.getElementById("ai-extend-modal"),d=document.getElementById("ai-generate-modal");function m(l){l.querySelector(".cancel-btn").addEventListener("click",()=>{l.classList.add("hidden")})}m(a),m(u),m(d),zt(),document.getElementById("ai-inpaint-btn").addEventListener("click",()=>{a.classList.remove("hidden")}),document.getElementById("ai-extend-btn").addEventListener("click",()=>{u.classList.remove("hidden"),Gs(),zt()}),document.getElementById("ai-generate-btn").addEventListener("click",()=>{d.classList.remove("hidden")}),js()}function Nn(){const e=Pt();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(q(Bt(t.sequencer.id,n),Lt(t.sequencer.id,n)),Le()&&(Be(),G(ne.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function In(){console.log("performCopy called");const e=Pt();if(!e)return;const t=e.getSelectedNotes();t.length!==0&&pn(t)}function Tn(){const e=Pt();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(pn(n),q(ro(t.sequencer.id,n),ao(t.sequencer.id,n)),Le()&&(Be(),G(ne.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function An(){if(console.log("performPaste called"),!ht().notes.length){console.log("No notes in clipboard");return}document.body.style.cursor="crosshair",qo((t,n)=>{const o=t.gridContext,{x:s,y:i}=o.getCanvasPos(n),r=o.getSnappedBeatFromX(s),c=o.getPitchFromRow(Math.floor(i/o.getCellHeight())),a=_(c),{notes:u,anchorBeat:d,anchorMidi:m}=ht(),l=r-d,f=a-m,g=u.map(h=>({pitch:Fe(_(h.pitch)+f),start:h.start+l,duration:h.duration}));q(lo(o.sequencer.id,g),uo(o.sequencer.id,g)),Le()&&(Be(),G(ne.NOTE_PLACEMENT)),o.setSelectedNotes(g),document.body.style.cursor="default",Nt()})}function Ys(){document.addEventListener("keydown",e=>{var s;const n=navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey,o=(s=document.activeElement)==null?void 0:s.tagName;if(!(o==="INPUT"||o==="TEXTAREA"))switch(!0){case(n&&e.key==="c"):e.preventDefault(),In();break;case(n&&e.key==="x"):e.preventDefault(),Tn();break;case(n&&e.key==="v"):e.preventDefault(),An();break;case e.key==="Delete":e.preventDefault(),Nn();break}})}function xs(){const e=document.querySelector(".select-mode-copy");e&&(e.onclick=In);const t=document.querySelector(".select-mode-cut");t&&(t.onclick=Tn);const n=document.querySelector(".select-mode-paste");n&&(n.onclick=An);const o=document.querySelector(".select-mode-delete");o&&(o.onclick=Nn),Ys()}function Vs(e=$e()){ut(e.tempo,!1),ft(e.timeSignature[0],!1),mt(e.totalMeasures,!1);for(const n of e.sequencers){let o=L.find(r=>r.id===n.id);if(!o){const{wrapper:r}=wn({id:n.id,instrument:n.instrument,config:{...n.config},notes:n.notes}),c=r.querySelector(".sequencer");c&&Ke(c,!0)}o.config.instrument=n.instrument;const s=o.container.querySelector("canvas.mini-contour");s&&De(s,o.notes,o.config,o.colorIndex);const i=o.grid.gridContext;i.setSelectedNotes([]),i.notes.length=0,i.notes.push(...structuredClone(n.notes)),o.grid.scheduleRedraw()}const t=document.getElementById("global-mini-contour");t&&Q(t,L)}ho(Vs);function Pn(){Q(Qs,L)}const Qs=document.getElementById("global-mini-contour"),qt=document.getElementById("global-mini-playhead");$s(qt);Us(qt);be(0);const Js=document.getElementById("piano");Ts(Js);const Zs=document.getElementById("waveform");_s(Zs,document.getElementById("visualizer-mode"));const Yt=0,ei="fluidr3-gm/acoustic_grand_piano";q(tn(Yt,ei),wt(Yt));q(Mt("Initial App State"),on("Initial App State"));xs();Pn();Zo();Hs();zs();qs();ds({getSequencers:()=>L,onPlay:()=>{Qe();const e=D(),t=Ve();Bo(fe(),{loop:W.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{L.forEach(n=>{var o;return(o=n.onTransportLoop)==null?void 0:o.call(n)})}}),dt(n=>{const o=n/e*qt.width;be(o)}),L.forEach(n=>n.play()),wo(()=>{us(),ae(0),be(0)})},onPause:()=>{dn(),L.forEach(e=>e.pause())},onResume:()=>{un(),L.forEach(e=>e.resume())},onStop:()=>{Qe(),ae(0),L.forEach(e=>e.stop()),be(0)},onDurationChange:e=>{W.currentDuration=e,L.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{W.snapResolution=e,L.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{W.loopEnabled=e,L.forEach(t=>t.config.loopEnabled=e)},onTempoChange:ut,onSave:async e=>{const t=L.map(n=>n.getState());if(e==="json"){const{url:n,filename:o}=Rs(t),s=document.createElement("a");s.href=n,s.download=o,s.click(),URL.revokeObjectURL(n)}else e==="wav"?await Ds(t):e==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async e=>{try{const{tracks:t,globalConfig:n}=await Fs(e);ut(n.bpm),ft(n.beatsPerMeasure),mt(n.totalMeasures);const o=document.getElementById("tempo-input");o&&(o.value=fe());const s=document.getElementById("measures-input");s&&(s.value=We()),Jo();for(const[i,r]of t.entries()){const c=i,a=r.instrument||"fluidr3-gm/acoustic_grand_piano",u=r.notes||[];q({type:"CREATE_SEQUENCER",id:c,instrument:a,notes:structuredClone(u),config:r.config||{}},wt(c))}q(Mt("Session Loaded"),on("Session Loaded")),_o(),Pn(),ae(0),be(0)}catch(t){alert("Failed to load file: "+t.message)}},onMeasuresChange:e=>{mt(e);const t=document.getElementById("global-mini-contour");t&&Q(t,L)},onBeatsPerMeasureChange:e=>{ft(e);const t=document.getElementById("global-mini-contour");t&&Q(t,L)}});const ii=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{Wt as a,oe as b,si as c,ni as d,oi as e,Ue as f,yt as g,De as h,Q as i,ii as m,mt as u};
