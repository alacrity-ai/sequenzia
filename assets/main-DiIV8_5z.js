const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-V5P0Y9xU.js","assets/index-CEAX8RQB.js"])))=>i.map(i=>d[i]);
import{_ as Xt}from"./index-CEAX8RQB.js";function Kt(e=3){const i=["C","D","E","F","G","A","B"],r=["C#","D#","","F#","G#","A#",""],l=[e,e+1,e+2],a={};let c=0;for(const d of l)i.forEach(u=>{const f=`${u}${d}`;a[f]={note:f,x:c,width:60,height:200,isBlack:!1},c+=60});c=0;for(const d of l)r.forEach((u,f)=>{if(u===""){c+=60;return}const m=`${u}${d}`;a[m]={note:m,x:c+60-40/2,width:40,height:120,isBlack:!0},c+=60});return a}function Ie(e,t,n=new Set,o=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const s={};if(o)for(const[i,r]of Object.entries(o))s[r]=i;for(const i of Object.values(t))i.isBlack||(Tt(e,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",s[i.note]&&(e.fillStyle="#7c3aed",e.fillText(s[i.note],i.x+i.width/2,i.height-24),e.fillStyle="#333"),e.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(t))i.isBlack&&(Tt(e,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),pn(e,i),s[i.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(s[i.note],i.x+i.width/2,i.height-28)))}function Tt(e,{x:t,width:n,height:o,fill:s,stroke:i,radius:r=8}){e.beginPath(),e.moveTo(t,0),e.lineTo(t,o-r),e.quadraticCurveTo(t,o,t+r,o),e.lineTo(t+n-r,o),e.quadraticCurveTo(t+n,o,t+n,o-r),e.lineTo(t+n,0),e.closePath(),e.fillStyle=s,e.fill(),e.strokeStyle=i,e.lineWidth=1,e.stroke()}function pn(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}const ae=64,yn={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"},De=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:50,cellHeight:25},{cellWidth:60,cellHeight:30}];function D(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(o,10)}function En(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function vn(e){return e.replace(/\d+$/,"")}function tt(e){return e.includes("#")}function bn(e,t){return e/t()}function wn(e,t){let n=t.snapResolution||.25,o=t.isTripletMode?n*(2/3):n;return Math.round(e/o)*o}function Sn(e,t,n){const o=bn(e,n);return wn(o,t)}function Gt(e,t,n,o,s,i=4){e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+o-i,n),e.quadraticCurveTo(t+o,n,t+o,n+i),e.lineTo(t+o,n+s-i),e.quadraticCurveTo(t+o,n+s,t+o-i,n+s),e.lineTo(t+i,n+s),e.quadraticCurveTo(t,n+s,t,n+s-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}function Bn(e,t){const n=structuredClone(e);return n.tempo=t.bpm,n}function Wt(e){return{type:"CHANGE_TEMPO",bpm:e}}function Mn(e){return Wt(e)}function Ln(e,t){const n=structuredClone(e);return n.timeSignature=[t.beats,4],n}function jt(e){return{type:"SET_TIME_SIGNATURE",beats:e}}function Cn(e){return jt(e)}function kn(e,t){const n=structuredClone(e);return n.totalMeasures=t.measures,n}function zt(e){return{type:"SET_TOTAL_MEASURES",measures:e}}function Nn(e){return zt(e)}function In(e,t){const n=structuredClone(e);return n.sequencers.push({id:t.id,instrument:t.instrument,notes:t.notes||[]}),L.find(s=>s.id===t.id)||ln({config:{id:t.id,...t.config},notes:t.notes||[],instrument:t.instrument}),n}function Yt(e,t){return{type:"CREATE_SEQUENCER",id:e,instrument:t}}function vt(e){return{type:"DELETE_SEQUENCER",id:e}}function Tn(e,t){const n=structuredClone(e);n.sequencers=n.sequencers.filter(s=>s.id!==t.id);const o=L.findIndex(s=>s.id===t.id);return o!==-1&&(L[o].destroy(),L.splice(o,1)),n}function An(e,t,n=[]){return{type:"DELETE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function qn(e,t,n=[]){return{type:"CREATE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function _n(e,t){return structuredClone(e)}const Ke=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function Te(e,t,n,o=0){const s=e.getContext("2d"),i=e.width,r=e.height;s.clearRect(0,0,i,r);const l=Ke[o%Ke.length];s.fillStyle=l;const a=P(),c=D(n.noteRange[0]),u=D(n.noteRange[1])-c||1,f=Math.max(2,r/u);for(const m of t){const h=m.start/a*i,y=Math.max(1,m.duration/a*i),p=(D(m.pitch)-c)/u,E=r-p*r-f/2;s.fillRect(h,E,y,f)}}function oe(e,t){const n=e.getContext("2d"),o=e.width,s=e.height;n.clearRect(0,0,o,s),t.forEach((i,r)=>{const l=i.notes,a=i.config;if(!(l!=null&&l.length))return;const c=P(),d=Ke[r%Ke.length];n.fillStyle=d;const u=D(a.noteRange[0]),m=D(a.noteRange[1])-u||1,h=Math.max(2,s/m);for(const y of l){const g=y.start/c*o,p=Math.max(1,y.duration/c*o),v=(D(y.pitch)-u)/m,w=s-v*s-h/2;n.fillRect(g,w,p,h)}})}function Pn(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;o.notes.push(...t.notes);const s=document.getElementById("global-mini-contour");return s&&oe(s,L),n}function Rn(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Dn(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Fn(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));o.notes=o.notes.filter(r=>{const l=`${r.pitch}|${r.start}|${r.duration}`;return!s.has(l)});const i=document.getElementById("global-mini-contour");return i&&oe(i,L),n}function bt(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function wt(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function On(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const{from:s,to:i}=t;for(let r=0;r<s.length;r++){const l=s[r],a=i[r],c=o.notes.findIndex(d=>d.pitch===l.pitch&&d.start===l.start&&d.duration===l.duration);c!==-1&&(o.notes[c].pitch=a.pitch,o.notes[c].start=a.start)}return n}function St(e,t,n){return{type:"MOVE_NOTES",sequencerId:e,from:structuredClone(t),to:structuredClone(n)}}function Vt(e,t,n){return St(e,n,t)}function $n(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(i=>`${i.pitch}|${i.start}|${i.duration}`));return o.notes=o.notes.filter(i=>{const r=`${i.pitch}|${i.start}|${i.duration}`;return!s.has(r)}),n}function Hn(e,t){return{type:"CUT_NOTES",sequencerId:e,notes:structuredClone(t)}}function Un(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Xn(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);return o?(o.notes.push(...t.notes),n):e}function Kn(e,t){return{type:"PASTE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Gn(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Wn(e,t){return structuredClone(e)}function jn(e,t){return structuredClone(e)}function Bt(e=""){return{type:"CHECKPOINT",label:e}}function Qt(e=""){return Bt(e)}const zn=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_INSTRUMENT:_n,CHANGE_TEMPO:Bn,CHECKPOINT:jn,CREATE_SEQUENCER:In,CUT_NOTES:$n,DELETE_NOTES:Fn,DELETE_SEQUENCER:Tn,MOVE_NOTES:On,PASTE_NOTES:Xn,PLACE_NOTES:Pn,SET_TIME_SIGNATURE:Ln,SET_TOTAL_MEASURES:kn,UPDATE_NOTE_VELOCITY:Wn},Symbol.toStringTag,{value:"Module"}));function Mt(e){const t=zn[e.type];if(!t)throw new Error(`Unknown diff type: ${e.type}`);const n=t(qe(),e);Jt(n)}let it=new Set;function Yn(e){return it.add(e),()=>it.delete(e)}function Ae(e){for(const t of it)t(e)}const ce=[];let Z=-1;function Vn({forwardDiff:e,reverseDiff:t}){ce.splice(Z+1),ce.push({forwardDiff:e,reverseDiff:t}),Z=ce.length-1}function Qn(){var e;if(Z<0)return null;for(let t=Z;t>=0;t--){const n=ce[t];if(((e=n==null?void 0:n.forwardDiff)==null?void 0:e.type)==="CHECKPOINT")return null;if(n!=null&&n.reverseDiff)return Z=t-1,Mt(n.reverseDiff),Ae(qe()),n.reverseDiff}return null}function Jn(){if(Z>=ce.length-1)return null;Z++;const e=ce[Z];return!e||!e.forwardDiff?null:(Mt(e.forwardDiff),Ae(qe()),e.forwardDiff)}function Zn(){ce.length=0,Z=-1}let Ge={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[]};function qe(){return Ge}function Jt(e){Ge=structuredClone(e),Ae(Ge)}function q(e,t){Mt(e),Vn({forwardDiff:e,reverseDiff:t}),Ae(Ge)}let X=null,Y=500,ve=null,rt=!1,at=1/0,be=[],Xe=null,Zt=0,xt=4,en=8;function ct(e){return be.push(e),()=>{const t=be.indexOf(e);t!==-1&&be.splice(t,1)}}function xn(){be=[]}function ne(e){Zt=e}function P(){return Pe()*_e()}function We(){return Zt}function lt(e,t=!0){if(t){const o=le();q(Wt(e),Mn(o));return}if(tn()){const o=performance.now(),s=(o-ve)/Y;Y=60/e*1e3,ve=o-s*Y}else Y=60/e*1e3;const n=document.getElementById("tempo-input");n&&n.value!==String(e)&&(n.value=e)}function le(){return 60/(Y/1e3)}function dt(e,t=!0){if(t){const o=_e();q(jt(e),Cn(o));return}xt=e;const n=document.getElementById("beats-per-measure-input");n&&n.value!==String(e)&&(n.value=e),Re().forEach(o=>{var s,i;(s=o.grid)!=null&&s.resizeAndRedraw?o.grid.resizeAndRedraw():(i=o.grid)==null||i.scheduleRedraw()})}function _e(){return xt}function ut(e,t=!0){if(t){const o=Pe();q(zt(e),Nn(o));return}en=e;const n=document.getElementById("measures-input");n&&n.value!==String(e)&&(n.value=e),Re().forEach(o=>{var s;(s=o.grid)==null||s.scheduleRedraw()})}function Pe(){return en}function eo(e){Xe=e}function to(e,t={}){Y=60/e*1e3,rt=t.loop??!1,at=t.endBeat??1/0;const n=t.startBeat??0;ve=performance.now()-n*Y;const o=t.onLoop;function s(i){const l=(i-ve)/Y;if(ne(l),be.forEach(a=>a(l)),l>=at)if(rt)ve=performance.now(),ne(0),o&&o();else{je();return}X=requestAnimationFrame(s)}X=requestAnimationFrame(s)}function je(){X&&cancelAnimationFrame(X),X=null,xn(),Xe&&(Xe(),Xe=null)}function tn(){return X!==null}function nn(){X&&cancelAnimationFrame(X),X=null}function on(){if(X)return;const e=performance.now()-We()*Y;function t(n){const s=(n-e)/Y;if(ne(s),be.forEach(i=>i(s)),s>=at)if(rt)ve=performance.now(),ne(0);else{je();return}X=requestAnimationFrame(t)}X=requestAnimationFrame(t)}function no(e,t,n,o,s,i){const r=_e(),l=P()*o;for(let d=0;d<n;d++){const u=d*s,f=i(d);e.fillStyle=tt(f)?"rgb(174,173,175)":"#fefefe",e.fillRect(0,u,l,s),e.fillStyle=tt(f)?"#a088b0":"#dddddd",e.fillRect(-64,u,ae,s)}e.font=`${Math.floor(s*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let d=0;d<n;d++){const u=d*s,f=i(d);e.fillStyle=tt(f)?"#800080":"#444",e.fillText(f,-8,u+s/2)}e.strokeStyle="#ddd",e.lineWidth=1;for(let d=0;d<n;d++){const u=d*s;e.beginPath(),e.moveTo(0,u),e.lineTo(l,u),e.stroke()}const a=P();console.log(`Got ${a} beats and beatsPerMeasure: ${r}`);const c=n*s;for(let d=0;d<=a;d++){const u=d*o,f=d%r===0;e.strokeStyle=f?"#bbb":"#eee",e.lineWidth=f?2:1,e.beginPath(),e.moveTo(u,0),e.lineTo(u,c),e.stroke()}}function oo(e,t,{previewNotes:n=null,hoveredNote:o,selectedNote:s,selectedNotes:i=[],highlightedNotes:r=[],cellWidth:l,cellHeight:a,visibleStartBeat:c,visibleEndBeat:d,getPitchRow:u,getPitchClass:f,PITCH_COLOR_MAP:m,drawRoundedRect:h}){for(const g of t){if(g.start+g.duration<c-2||g.start>d)continue;const p=g.start*l,E=u(g.pitch)*a,v=g.duration*l,w=a-1,S=m[f(g.pitch)]||"#999";e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,r.includes(g)?e.fillStyle="rgba(96, 165, 250, 0.6)":e.fillStyle=S,h(e,p,E,v,w),e.fill();const M=e.createLinearGradient(p,E,p,E+w);M.addColorStop(0,"rgba(255,255,255,0.4)"),M.addColorStop(.2,"rgba(255,255,255,0.15)"),M.addColorStop(.5,"rgba(255,255,255,0.05)"),M.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=M,h(e,p,E,v,w),e.fill();const I=i.includes(g),k=g===o,C=r.includes(g);(I||k||C)&&(e.lineWidth=2,I?e.strokeStyle="rgba(59, 130, 246, 1.0)":k?e.strokeStyle="rgba(0, 0, 0, 0.8)":C&&(e.strokeStyle="rgba(96, 165, 250, 0.6)"),h(e,p,E,v,w),e.stroke())}if(n)for(const g of n){const p=g.start*l,E=u(g.pitch)*a,v=g.duration*l,w=a-1,S=m[f(g.pitch)]||"#999";e.fillStyle=so(S,.4),h(e,p,E,v,w),e.fill()}}function so(e,t){const n=parseInt(e.slice(1),16);return`rgba(${n>>16&255}, ${n>>8&255}, ${n&255}, ${t})`}function io(e,t,n,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+n,0),e.lineTo(t+n,o),e.stroke(),e.restore()}function ro(e,t,n,o=ae){const s=e.getBoundingClientRect(),i=parseFloat(e.style.width||s.width),r=parseFloat(e.style.height||s.height),l=e.width/i,a=e.height/r,c=(t.clientX-s.left)*l-o,d=(t.clientY-s.top)*a;return{x:c,y:d}}function ao(e,t,n,o,s,i){const r=Math.floor(t/s),l=e/i;return n.find(a=>l>=a.start&&l<a.start+a.duration&&o(a.pitch)===r)}function co(e,t,n,o){const s=e.querySelector(".zoom-in-btn"),i=e.querySelector(".zoom-out-btn"),r=e.querySelector(".zoom-reset-btn");!s||!i||!r||(s.addEventListener("click",t),i.addEventListener("click",n),r.addEventListener("click",o))}function lo(){for(const e of L){const t=e.container,n=t.querySelector(".sequencer-body"),o=t.querySelector("canvas.mini-contour"),s=t.querySelector(".collapse-btn use");n.classList.contains("hidden")||(n.classList.add("hidden"),o.classList.remove("hidden"),s==null||s.setAttribute("href","#icon-caret-up"),xe(t,!1),Te(o,e.notes,e.config,e.colorIndex))}}function A(e){const t=e.match(/^([A-G]#?)(\d)$/);if(!t)return null;const[n,o,s]=t;return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[o]+12*parseInt(s,10)}function Me(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function At(e){let t=null,n=null;function o(c){var p,E;const{x:d,y:u}=e.getCanvasPos(c);if(d<0){const v=e.getPitchFromRow(Math.floor(u/e.getCellHeight()));e.sequencer.playNote(v,.5);return}const f=e.findNoteAt(d,u);if(f){e.setSelectedNote(f),e.scheduleRedraw(),(p=e.onNotesChanged)==null||p.call(e);return}const m=e.getSnappedBeatFromX(d),h=e.getPitchFromRow(Math.floor(u/e.getCellHeight())),y=P();if(m+e.config.currentDuration>y)return;e.sequencer.playNote(h,.5);const g={pitch:h,start:m,duration:e.config.currentDuration};q(Rn(e.sequencer.id,[g]),Dn(e.sequencer.id,[g])),e.scheduleRedraw(),(E=e.onNotesChanged)==null||E.call(e)}function s(c){c.preventDefault();const{x:d,y:u}=e.getCanvasPos(c),f=e.findNoteAt(d,u);if(!f||e.notes.indexOf(f)===-1)return;const h=[f];q(bt(e.sequencer.id,h),wt(e.sequencer.id,h))}function i(c){const{x:d,y:u}=e.getCanvasPos(c),f=e.findNoteAt(d,u);f&&(e.setSelectedNote(f),t={startX:d,startY:u,anchorNote:f,initialStart:f.start,initialMidi:A(f.pitch),initialNote:{pitch:f.pitch,start:f.start,duration:f.duration}})}function r(c){var h;const{x:d,y:u}=e.getCanvasPos(c);if(d<0){e.clearPreview();return}const f=e.findNoteAt(d,u);e.setHoveredNote(f);const m=e.getSelectedNote();if(!t&&m&&m!==f&&e.setSelectedNote(null),!f&&!t){const y=e.getSnappedBeatFromX(d),g=e.getPitchFromRow(Math.floor(u/e.getCellHeight())),p=P();y+e.config.currentDuration<=p?e.updatePreview({pitch:g,start:y,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&m){const y=d-t.startX,g=e.getSnappedBeatFromX(y)-e.getSnappedBeatFromX(0),p=Math.max(0,t.initialStart+g),E=P();p+m.duration<=E&&(m.start=p);const v=u-t.startY,w=Math.round(v/e.getCellHeight()),S=t.initialMidi-w,M=A(e.config.noteRange[0]),I=A(e.config.noteRange[1]),k=Math.max(M,Math.min(I,S)),C=Me(k);C!==m.pitch&&(m.pitch=C,n!==C&&(n=C,e.sequencer.playNote(C,.5))),e.scheduleRedraw(),(h=e.onNotesChanged)==null||h.call(e);return}e.scheduleRedraw()}function l(){if(!t||!e.getSelectedNote()){t=null;return}const{anchorNote:c,initialNote:d}=t,u={pitch:c.pitch,start:c.start,duration:c.duration};(d.pitch!==u.pitch||d.start!==u.start)&&q(St(e.sequencer.id,[d],[u]),Vt(e.sequencer.id,[d],[u])),t=null}function a(){e.clearPreview(),e.setHoveredNote(null),e.scheduleRedraw()}return{attach(c){c.addEventListener("click",o),c.addEventListener("contextmenu",s),c.addEventListener("mousemove",r),c.addEventListener("mouseleave",a),c.addEventListener("mousedown",i),c.addEventListener("mouseup",l)},detach(c){c.removeEventListener("click",o),c.removeEventListener("contextmenu",s),c.removeEventListener("mousemove",r),c.removeEventListener("mouseleave",a),c.removeEventListener("mousedown",i),c.removeEventListener("mouseup",l)}}}let pe=null;function uo(e){pe&&pe!==e&&pe.clearSelection(),pe=e}function fo(){pe=null}function Fe(){return pe}let Je=!1,ze=null,$=null;function mo(e){Je=!0,ze=e,$=null}function Lt(){var e;$&&($.gridContext.setPastePreviewNotes(null),$.scheduleRedraw(),(e=$.setCursor)==null||e.call($,"default")),Je=!1,ze=null,$=null,document.body.style.cursor="default"}function nt(){return Je}function go(e,t){!Je||!ze||(ze(e,t),Lt())}function ho(e){$&&$!==e&&($.gridContext.setPastePreviewNotes(null),$.scheduleRedraw()),$=e}let sn={notes:[],anchorBeat:0,anchorMidi:0};function qt(e){if(e.length===0)return;const t=e[0],n=t.start,o=A(t.pitch);sn={notes:e.map(s=>({pitch:s.pitch,start:s.start,duration:s.duration})),anchorBeat:n,anchorMidi:o}}function ft(){return sn}function _t(e){let t=null;function n(l){l.preventDefault();const{x:a,y:c}=e.getCanvasPos(l),d=e.findNoteAt(a,c);if(!d)return;const u=e.getSelectedNotes(),f=u.includes(d)?u:[d];f.length&&(e.setSelectedNotes([]),q(bt(e.sequencer.id,f),wt(e.sequencer.id,f)))}function o(l){if(nt()){go(e.grid,l),l.preventDefault(),l.stopPropagation();return}const{x:a,y:c}=e.getCanvasPos(l);if(a<0)return;const d=e.findNoteAt(a,c);e.setHoveredNote(d),uo(e.grid);const u=e.getSelectedNotes();if(d&&u.includes(d)){t={startX:a,startY:c,anchorNote:d,initialNotes:u.map(f=>({note:f,start:f.start,midi:A(f.pitch)}))};return}e.selectionBox={active:!0,startX:a,startY:c,currentX:a,currentY:c},e.clearPreview(),e.setSelectedNote(null)}function s(l){var u,f;ho(e.grid);const{x:a,y:c}=e.getCanvasPos(l),d=e.findNoteAt(a,c);if(e.setHoveredNote(d),nt()){const{notes:m,anchorBeat:h,anchorMidi:y}=ft(),g=e.getSnappedBeatFromX(a),p=e.getPitchFromRow(Math.floor(c/e.getCellHeight())),E=A(p),v=g-h,w=E-y,S=m.map(M=>({pitch:Me(A(M.pitch)+w),start:M.start+v,duration:M.duration}));e.setPastePreviewNotes(S),e.scheduleRedraw();return}else e.setPastePreviewNotes(null);if((u=e.selectionBox)!=null&&u.active){e.selectionBox.currentX=a,e.selectionBox.currentY=c;const m=e.selectionBox,h=Math.min(m.startX,m.currentX),y=Math.min(m.startY,m.currentY),g=Math.max(m.startX,m.currentX),p=Math.max(m.startY,m.currentY),E=Math.floor(y/e.getCellHeight()),v=Math.floor(p/e.getCellHeight()),w=e.getSnappedBeatFromX(h),S=e.getSnappedBeatFromX(g),M=A(e.getPitchFromRow(E)),I=A(e.getPitchFromRow(v)),k=e.notes.filter(C=>{const R=A(C.pitch),K=C.start,_=C.start+C.duration,G=K>=w&&_<=S,ue=R>=I&&R<=M;return G&&ue});e.setHighlightedNotes(k),e.scheduleRedraw();return}if(t){const m=a-t.startX,h=e.getSnappedBeatFromX(m)-e.getSnappedBeatFromX(0),y=c-t.startY,g=Math.round(y/e.getCellHeight()),p=P(),E=A(e.config.noteRange[0]),v=A(e.config.noteRange[1]);for(const{note:S,start:M,midi:I}of t.initialNotes){const k=Math.max(0,M+h),C=Math.max(E,Math.min(v,I-g)),R=Me(C);k+S.duration<=p&&(S.start=k,S.pitch=R)}const w=t.initialNotes.find(S=>S.note===t.anchorNote);if(w){const S=w.note.pitch;t.lastPreviewPitch!==S&&(t.lastPreviewPitch=S,e.sequencer.playNote(S,.5))}e.scheduleRedraw(),(f=e.onNotesChanged)==null||f.call(e)}}function i(l){var a,c;if((a=t==null?void 0:t.initialNotes)!=null&&a.length){const{initialNotes:d}=t,u=d.map(({start:h,midi:y,note:g})=>({pitch:Me(y),start:h,duration:g.duration})),f=d.map(({note:h})=>({pitch:h.pitch,start:h.start,duration:h.duration}));u.some((h,y)=>h.pitch!==f[y].pitch||h.start!==f[y].start)&&q(St(e.sequencer.id,u,f),Vt(e.sequencer.id,u,f))}if(t=null,(c=e.selectionBox)!=null&&c.active){const{x:d,y:u}=e.getCanvasPos(l);e.selectionBox.currentX=d,e.selectionBox.currentY=u,e.selectionBox.active=!1;const f=e.selectionBox,m=Math.min(f.startX,f.currentX),h=Math.min(f.startY,f.currentY),y=Math.max(f.startX,f.currentX),g=Math.max(f.startY,f.currentY),p=Math.floor(h/e.getCellHeight()),E=Math.floor(g/e.getCellHeight()),v=e.getSnappedBeatFromX(m),w=e.getSnappedBeatFromX(y),S=A(e.getPitchFromRow(p)),M=A(e.getPitchFromRow(E)),I=e.notes.filter(k=>{const C=A(k.pitch),R=k.start,K=k.start+k.duration,_=R>=v&&K<=w,G=C>=M&&C<=S;return _&&G});e.setHighlightedNotes([]),e.setSelectedNotes(I),e.scheduleRedraw()}}function r(){e.setHoveredNote(null),e.setHighlightedNotes([]),nt()&&e.setPastePreviewNotes(null),e.scheduleRedraw()}return{attach(l){l.addEventListener("mousedown",o),l.addEventListener("mousemove",s),l.addEventListener("mouseup",i),l.addEventListener("mouseleave",r),l.addEventListener("contextmenu",n)},detach(l){l.removeEventListener("mousedown",o),l.removeEventListener("mousemove",s),l.removeEventListener("mouseup",i),l.removeEventListener("mouseleave",r),l.removeEventListener("contextmenu",n)}}}const Ct={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let rn=Ct.NOTE_PLACEMENT;const mt=new Set;function kt(){return rn}function Oe(e){Lt(),rn=e;for(const t of mt)t(e)}function po(e){return mt.add(e),()=>mt.delete(e)}function yo(e,t){const n=t.selectionBox;if(!n)return;const o=n.startX,s=n.startY,i=n.currentX,r=n.currentY,l=Math.min(o,i),a=Math.min(s,r),c=Math.abs(i-o),d=Math.abs(r-s);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),Gt(e,l,a,c,d,3),e.stroke(),e.restore()}function Eo(e,t,n,o,s,i){let r=null,l=null,a=null,c=null,d=2;const u=e.getContext("2d"),f=t.getContext("2d");let m=De[d].cellWidth,h=De[d].cellHeight;const y=D(s.noteRange[1])-D(s.noteRange[0])+1,g=y*h,E=P()*m+ae;e.width=E,e.height=g,e.style.width=`${E}px`,e.style.height=`${g}px`,t.width=E,t.height=g,t.style.width=`${E}px`,t.style.height=`${g}px`;let v=null;function w(){v!==null&&cancelAnimationFrame(v),v=requestAnimationFrame(S)}function S(){var b;u.clearRect(0,0,e.width,e.height),u.save(),u.translate(ae,0),no(u,s,y,m,h,G),oo(u,o,{previewNotes:l??(r?[r]:null),hoveredNote:a,selectedNote:c,selectedNotes:W,highlightedNotes:T.getHighlightedNotes(),cellWidth:m,cellHeight:h,visibleStartBeat:0,visibleEndBeat:e.width/m,getPitchRow:_,getPitchClass:vn,PITCH_COLOR_MAP:yn,drawRoundedRect:Gt}),(b=T.selectionBox)!=null&&b.active&&yo(u,T),u.restore()}function M(){d<De.length-1&&(d++,C())}function I(){d>0&&(d--,C())}function k(){d=2,C()}function C(){const b=De[d];m=b.cellWidth,h=b.cellHeight,R()}function R(){const z=P()*m+ae,fe=(D(s.noteRange[1])-D(s.noteRange[0])+1)*h;e.width=z,e.height=fe,e.style.width=`${z}px`,e.style.height=`${fe}px`,t.width=z,t.height=fe,t.style.width=`${z}px`,t.style.height=`${fe}px`,w()}function K(b){io(f,b,ae,e.height)}co(i.container,M,I,k);function _(b){return D(s.noteRange[1])-D(b)}function G(b){const we=D(s.noteRange[1])-b,fe=Math.max(D(s.noteRange[0]),Math.min(D(s.noteRange[1]),we));return En(fe)}function ue(){const b=document.getElementById("global-mini-contour");b&&oe(b,L)}let ee=null,W=[];const T={sequencer:i,grid:null,config:s,notes:o,getCellHeight:()=>h,getCanvasPos:b=>ro(e,b,n,ae),findNoteAt:(b,z)=>ao(b,z,o,_,h,m),scheduleRedraw:w,getPitchFromRow:G,getSnappedBeatFromX:b=>Sn(b,s,()=>m),updatePreview:b=>r=b,clearPreview:()=>r=null,getSelectedNote:()=>c,setSelectedNote:b=>{c=b,W=b?[b]:[]},getSelectedNotes:()=>W,setSelectedNotes:b=>{W=b,c=b.length===1?b[0]:null},setHoveredNote:b=>a=b,onNotesChanged:ue};function j(b){ee&&ee.detach(e),ee=b,ee&&ee.attach(e)}function B(){c=null,W=[],a=null,V=[],w()}const N=kt();j(N==="note-placement"?At(T):N==="select"?_t(T):null);let H=po(b=>{var z,we;r=null,l=null,V=[],(z=T.clearPreview)==null||z.call(T),(we=T.setPastePreviewNotes)==null||we.call(T,null),T.selectionBox&&(T.selectionBox.active=!1,T.selectionBox=null),B(),j(b==="note-placement"?At(T):b==="select"?_t(T):null),w()});const O={canvas:e,scheduleRedraw:w,drawPlayhead:K,getSelectedNote:()=>c,clearSelection:B,getPreviewNote:()=>r,zoomIn:M,zoomOut:I,getXForBeat:b=>b*m,setMouseHandler:j,setCursor:b=>{e.style.cursor=b},gridContext:T,getSelectedNotes:()=>W,setSelectedNotes:b=>{W=b,c=b.length===1?b[0]:null},destroy(){H(),fo()}};T.setPastePreviewNotes=b=>{l=b};let V=[];return T.getHighlightedNotes=()=>V,T.setHighlightedNotes=b=>{V=b},T.grid=O,O}const vo={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function Ze(e){const t=e.match(/^([A-Ga-g][#b]?)(-?\d+)$/);if(!t)return null;const[,n,o]=t,s=n.toUpperCase(),i=vo[s];return i===void 0?null:12*(parseInt(o,10)+1)+i}class an{constructor(t,n,o=x,s=J,i="fluidr3-gm/acoustic_grand_piano"){this.container=t,this.config={...n},this.context=o,this.destination=s,this.instrumentName=i,this.notes=[],this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.isMuted=!1,this.isSoloed=!1,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this._initCanvases())}async initInstrument(){try{await Ye(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){const t=this.container.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument(),console.log(`[SEQ:${this.id}] Instrument set to:`,t)}playNote(t,n,o=100,s=!1){return zo(this.instrumentName,t,n,o,s)}_initCanvases(){const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),o=this.container.querySelector("#grid-scroll-container");this.grid=Eo(t,n,o,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(t){const n=P();this.clampNotesToGrid();const o=n*this.config.cellWidth+(this.config.labelWidth||64),s=this.container.querySelector("canvas.note-grid"),i=this.container.querySelector(".playhead-canvas"),r=this.container.querySelector(".mini-contour");s&&(s.width=o,s.style.width=`${o}px`),i&&(i.width=o,i.style.width=`${o}px`),r&&Te(r,this.notes,this.config,this.colorIndex),this.redraw()}clampNotesToGrid(){const t=P(),n=this.notes.filter(o=>o.start<t);n.forEach(o=>{o.start+o.duration>t&&(o.duration=t-o.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear(),this._beatHandler=t=>{var o;if((o=this.grid)==null||o.drawPlayhead(this.grid.getXForBeat(t)),!this.shouldPlay)return;const n=60/le();for(const s of this.notes){const i=s.start,r=s.start+s.duration;if(!this._activeNotes.has(s)&&i<=t&&t<=r){const l=s.duration*n;this.playNote(s.pitch,l),this._activeNotes.add(s)}}},this._unsub=ct(this._beatHandler),this._beatHandler(0)}stop(){var t,n,o;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const s of this._activeNotes){const i=this._noteHandlers.get(s);(t=i==null?void 0:i.forceStop)==null||t.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(o=this.grid)==null||o.drawPlayhead(null),this.redraw()}pause(){var t;for(const n of this._activeNotes){const o=this._noteHandlers.get(n);(t=o==null?void 0:o.stop)==null||t.call(o)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=ct(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.isMuted=!this.isMuted,this.isMuted&&(this.isSoloed=!1),this.updateTrackStyle()}toggleSolo(){this.isSoloed=!this.isSoloed,this.isSoloed&&(this.isMuted=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t.classList.toggle("bg-red-600",this.isMuted),t.classList.toggle("bg-gray-700",!this.isMuted),n.classList.toggle("bg-yellow-200",this.isSoloed),n.classList.toggle("bg-gray-700",!this.isSoloed),this.container.classList.toggle("opacity-40",this.isMuted&&!this.isSoloed),this.container.classList.toggle("opacity-100",!(this.isMuted&&!this.isSoloed))}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,o,s])=>({pitch:n,start:o,duration:s})))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:o}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),o&&(this.instrumentName=o),this.redraw()}async exportToOffline(){const t=60/le(),n=await Ye(this.instrumentName,this.context,this.destination);for(const o of this.notes){const s=o.start*t,i=o.duration*t;n.start({note:Ze(o.pitch),duration:i,velocity:100,time:s,loop:!1})}}}async function bo(e){var r,l,a;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const o={bpm:((r=n.c)==null?void 0:r.b)??120,beatsPerMeasure:((l=n.c)==null?void 0:l.bpm)??4,totalMeasures:((a=n.c)==null?void 0:a.tm)??8},s=Array.isArray(n.i)?n.i:[];return{tracks:n.tr.map((c,d)=>{if(!Array.isArray(c.n))throw new Error(`Track ${d} missing \`n\` (notes) array.`);const u=c.n.map(([m,h,y])=>({pitch:m,start:h,duration:y})),f=s[d]||"fluidr3-gm/acoustic_grand_piano";return{notes:u,instrument:f}}),globalConfig:o}}const U={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0},L=[],wo=document.getElementById("sequencers-container"),So=document.getElementById("sequencer-template"),cn=document.getElementById("add-sequencer");function xe(e,t){var n,o,s,i;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-out-btn"))==null||o.classList.toggle("hidden",!t),(s=e.querySelector(".zoom-reset-btn"))==null||s.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!t)}function Re(){return L}function Bo(e){const t=String(e);return Re().find(n=>{var o;return String(n.id)===t||String((o=n.config)==null?void 0:o.id)===t})}function Pt(){const e=L.some(t=>t.solo);L.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function Se(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function ln(e){const n=So.content.cloneNode(!0).querySelector(".sequencer");wo.insertBefore(n,cn);const o=L.length,s=e?{id:o,...U,...e.config}:{id:o,...U},i=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",r=new an(n,s,x,J,i);r.id=o,r.colorIndex=o,r.mute=!1,r.solo=!1,r.shouldPlay=!0;const l=n.querySelector("canvas.mini-contour");e&&r.setState(e),Te(l,r.notes,r.config,r.colorIndex),r.updateTrackLabel(),r.initInstrument();const a=n.querySelector(".collapse-btn"),c=a.querySelector("use"),d=n.querySelector(".sequencer-body");a.addEventListener("click",()=>{const y=d.classList.toggle("hidden");c.setAttribute("href",y?"#icon-caret-up":"#icon-caret-down"),l.classList.toggle("hidden",!y),xe(n,!y),y&&Te(l,r.notes,r.config,r.colorIndex)}),n.querySelector(".delete-btn").addEventListener("click",()=>{const y=document.getElementById("delete-confirm-modal"),g=document.getElementById("delete-confirm"),p=document.getElementById("delete-cancel");y.classList.remove("hidden");const E=()=>{const S=An(r.id,r.instrumentName,r.notes),M=qn(r.id,r.instrumentName,r.notes);q(S,M),w()},v=()=>{w()},w=()=>{y.classList.add("hidden"),g.removeEventListener("click",E),p.removeEventListener("click",v)};g.addEventListener("click",E),p.addEventListener("click",v)});const f=n.querySelector(".mute-btn"),m=n.querySelector(".solo-btn"),h=n.querySelector(".instrument-select-btn");return f.addEventListener("click",()=>{r.mute=!r.mute,r.mute&&(r.solo=!1,m.classList.remove("bg-yellow-200"),m.classList.add("bg-gray-700"),m.classList.remove("hover:bg-yellow-400"),m.classList.add("hover:bg-purple-700"),Se(m,!1)),Se(f,r.mute),Pt();const y=We();r.seekTo(y)}),m.addEventListener("click",()=>{r.solo=!r.solo,r.solo&&(r.mute=!1,Se(f,!1)),m.classList.toggle("bg-yellow-200",r.solo),m.classList.toggle("bg-gray-700",!r.solo),m.classList.toggle("hover:bg-yellow-400",r.solo),m.classList.toggle("hover:bg-purple-700",!r.solo),Pt();const y=We();r.seekTo(y)}),h.addEventListener("click",async()=>{const y=document.getElementById("instrument-select-modal"),g=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const p=r.instrumentName||"fluidr3-gm/acoustic_grand_piano",[E,v]=p.split("/");g.value=E,await g.dispatchEvent(new CustomEvent("change",{detail:{preselect:p}})),y.dataset.currentSequencer=r.id,y.classList.remove("hidden")}),Se(f,!1),Se(m,!1),m.classList.add("hover:bg-purple-700"),L.push(r),{seq:r,wrapper:n}}function Mo(){L.slice().forEach(n=>n.destroy()),L.length=0;const e=qe(),t=structuredClone(e);t.sequencers=[],Zn(),Jt(t),Ae(t)}function Lo(){document.getElementById("global-mini-contour"),cn.addEventListener("click",()=>{const e=L.length;q(Yt(e,"fluidr3-gm/acoustic_grand_piano"),vt(e))})}const de={openaiApiKey:"",openaiModel:"gpt-4o"};function gt(){return de.openaiApiKey}function Rt(){return de.openaiModel}function Co(e){de.openaiApiKey=e}function ko(e){const t=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];if(!t.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${t.join(", ")}`);de.openaiModel=e}function No(){localStorage.setItem("userConfig",JSON.stringify(de))}function Io(){const e=localStorage.getItem("userConfig");if(e){const t=JSON.parse(e);de.openaiApiKey=t.openaiApiKey||"",de.openaiModel=t.openaiModel||"gpt-4o"}}Io();function To(){const e=document.getElementById("userconfig-modal"),t=document.getElementById("config-save"),n=document.getElementById("config-close"),o=document.getElementById("openai-key-input"),s=document.getElementById("openai-model-select");o.value=gt(),s.value=Rt(),t.addEventListener("click",()=>{Co(o.value),ko(s.value),No(),e.classList.add("hidden")}),n.addEventListener("click",()=>{o.value=gt(),s.value=Rt(),e.classList.add("hidden")}),document.getElementById("key-not-set-ok").addEventListener("click",()=>{document.getElementById("openai-key-not-set-modal").classList.add("hidden")})}const Ao={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"};let Dt=!1,ie=!1,re=!1;function qo({getSequencers:e,onPlay:t,onStop:n,onPause:o,onResume:s,onDurationChange:i,onSnapChange:r,onToggleLoop:l,onTempoChange:a,onSave:c,onLoad:d,onMeasuresChange:u,onBeatsPerMeasureChange:f}){if(Dt)return;Dt=!0;const m=document.getElementById("play-button"),h=m.querySelector("use"),y=document.getElementById("stop-button"),g=document.getElementById("note-duration"),p=document.getElementById("dotted-note-btn"),E=document.getElementById("triplet-note-btn");g.value=String(U.currentDuration||1);const v=document.getElementById("snap-resolution");v.value=String(U.snapResolution||.25);const w=document.getElementById("loop-toggle"),S=document.getElementById("tempo-input"),M=document.getElementById("save-button"),I=document.getElementById("load-button"),k=document.getElementById("load-input"),C=document.getElementById("measures-input"),R=document.getElementById("beats-per-measure-input"),K=document.getElementById("config-button"),_=document.getElementById("export-modal"),G=document.getElementById("export-json"),ue=document.getElementById("export-wav"),ee=document.getElementById("export-midi"),W=document.getElementById("export-cancel");h.setAttribute("href","#icon-play"),m.addEventListener("click",()=>{!ie&&!re?(ie=!0,re=!1,t==null||t(),h.setAttribute("href","#icon-pause")):ie?(ie=!1,re=!0,o==null||o(),h.setAttribute("href","#icon-play")):re&&(ie=!0,re=!1,s==null||s(),h.setAttribute("href","#icon-pause"))}),y.addEventListener("click",()=>{n==null||n(),ie=!1,re=!1,h.setAttribute("href","#icon-play")});const T={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125};window.addEventListener("keydown",B=>{var O;if(document.querySelector(".ai-modal:not(.hidden)"))return;const H=(O=document.activeElement)==null?void 0:O.tagName;if(!(H==="INPUT"||H==="TEXTAREA")){if(B.code==="Space"){B.preventDefault(),m.click();return}if((B.metaKey||B.ctrlKey)&&(B.key==="z"&&Qn(),B.key==="y"&&Jn()),(B.metaKey||B.ctrlKey)&&B.key.toLowerCase()==="r"){B.preventDefault();return}if(kt()===Ct.NOTE_PLACEMENT){if(T.hasOwnProperty(B.code)){B.preventDefault();const V=T[B.code];g.value=V,g.dispatchEvent(new Event("change"))}if(B.key==="."){B.preventDefault(),p==null||p.click();return}if(B.key==="/"){B.preventDefault(),E==null||E.click();return}}}}),g.addEventListener("change",B=>{const N=parseFloat(B.target.value);j(N),i==null||i(N),e==null||e().forEach(H=>{const O=H.grid;if(O!=null&&O.getPreviewNote){const V=O.getPreviewNote();V&&(V.duration=N,O.scheduleRedraw())}})});function j(B){document.querySelectorAll(".note-duration-btn").forEach(H=>{const O=parseFloat(H.dataset.value);H.classList.remove("bg-purple-700"),H.classList.remove("bg-gray-800"),O===B?H.classList.add("bg-purple-700"):H.classList.add("bg-gray-800")})}v.addEventListener("change",B=>{const N=B.target.value;Ao.hasOwnProperty(N)&&(U.snapResolution=parseFloat(N),v.value=String(N),r==null||r(U.snapResolution))}),w.addEventListener("change",B=>{l==null||l(B.target.checked)}),S.addEventListener("change",B=>{const N=parseInt(B.target.value,10);isNaN(N)||a==null||a(N)}),M.addEventListener("click",()=>{_?_.classList.remove("hidden"):c==null||c("json")}),I.addEventListener("click",()=>{k.click()}),k.addEventListener("change",B=>{const N=B.target.files[0];N&&(d==null||d(N)),B.target.value=""}),G&&G.addEventListener("click",()=>{_.classList.add("hidden"),c==null||c("json")}),ue&&ue.addEventListener("click",()=>{_.classList.add("hidden"),c==null||c("wav")}),ee&&ee.addEventListener("click",()=>{_.classList.add("hidden"),c==null||c("midi")}),W&&W.addEventListener("click",()=>{_.classList.add("hidden")}),K.addEventListener("click",()=>{document.getElementById("userconfig-modal").classList.remove("hidden")}),To(),C.value=Pe(),R.value=_e(),C.addEventListener("change",B=>{const N=parseInt(B.target.value,10);!isNaN(N)&&N>0&&(u==null||u(N))}),R.addEventListener("change",B=>{const N=parseInt(B.target.value,10);!isNaN(N)&&N>0&&(f==null||f(N))}),j(parseFloat(g.value))}function _o(){ie=!1,re=!1;const t=document.getElementById("play-button").querySelector("use");t&&t.setAttribute("href","#icon-play")}function Po(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function Ro(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}let F=null,Le=0;const ot=new Map;async function se(){F||(F=await Xt(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function dn(){return x}async function Ye(e,t=x,n=null){await se();const[o,s]=e.includes("/")?e.split("/"):["musyngkite",e],i=t instanceof OfflineAudioContext;ot.has(t)||ot.set(t,new Map);const r=ot.get(t),l=`${o}/${s}`;if(r.has(l))return r.get(l);let a;if(o==="smolken")a=new F.Smolken(t,{instrument:s,destination:n||J,disableScheduler:i}),await me(a.load);else if(o==="splendidgrandpiano")a=new F.SplendidGrandPiano(t,{destination:n||J,disableScheduler:i}),await me(a.load);else if(o==="electricpiano")a=new F.ElectricPiano(t,{instrument:s,destination:n||J,disableScheduler:i}),await me(a.load);else if(o==="mallets")a=new F.Mallet(t,{instrument:s,destination:n||J,disableScheduler:i}),await me(a.load);else if(o==="drummachines"){a=new F.DrumMachine(t,{instrument:s,destination:n||J,disableScheduler:i}),await me(a.load);const c=a.getSampleNames(),d=new Map;c.forEach((u,f)=>{const m=36+f;d.set(m,u)}),a.__midiMap=d}else{const d={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[o.toLowerCase()]||"MusyngKite",u=await Xo();console.log(`[Soundfont] Available kits: ${u.join(", ")}`),console.log(`[Soundfont] Requested: kit=${d} instrument=${s}`);const m=`https://gleitz.github.io/midi-js-soundfonts/${d}/${s}-ogg.js`;a=new F.Soundfont(t,{instrument:s,instrumentUrl:m,kit:d,destination:n||J,disableScheduler:i}),await me(a.load)}return r.set(l,a),a}async function Do(){return await se(),F.getMalletNames()}async function Fo(){return await se(),F.getElectricPianoNames()}async function Oo(){return await se(),["splendidgrandpiano"]}async function $o(){return await se(),F.getDrumMachineNames()}async function Ho(){return await se(),F.getSmolkenNames()}async function Uo(e="MusyngKite"){await se();const t=await F.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function Xo(){return await se(),F.getSoundfontKits()}function Ko(){Le++,Le===1&&Po()}function Go(){Le--,Le<=0&&(Le=0,Ro())}async function me(e){Ko();try{await e}finally{Go()}}let te=null,ht=null;async function Ft(e){if(ht===e)return;te=await Ye(e),ht=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function Wo(){return ht}function un(e,t=100,n=!1){var l;if(!te)return null;const s=dn().currentTime,i=Ze(e),r=((l=te.__midiMap)==null?void 0:l.get(i))??i;return te.start({note:r,stopId:r,velocity:t,time:s,loop:n}),()=>{te.stop({stopId:r})}}function jo(e){var o;if(!te)return;const t=Ze(e),n=((o=te.__midiMap)==null?void 0:o.get(t))??t;te.stop({stopId:n})}async function zo(e,t,n,o=100,s=!1,i=null,r=null,l=null){var f;const a=r||dn(),c=await Ye(e,a,l),d=Ze(t),u=((f=c.__midiMap)==null?void 0:f.get(d))??d;return c.start({note:u,duration:n,velocity:o,loop:s,time:i??a.currentTime}),null}const x=new(window.AudioContext||window.webkitAudioContext),et=x.createAnalyser();et.fftSize=2048;const J=x.createGain();J.connect(et);et.connect(x.destination);function Yo(e){x.resume();try{const t=un(e,100,20);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}x.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let Ot=!1,$e=null;function Vo(e,t){if(Ot)return;Ot=!0,$e=t;const n=e.getContext("2d"),o=new Map,s=new Set;function i(d,u){const f=$e();for(const m of Object.values(f))if(m.isBlack&&d>=m.x&&d<=m.x+m.width&&u>=0&&u<=m.height)return m.note;for(const m of Object.values(f))if(!m.isBlack&&d>=m.x&&d<=m.x+m.width&&u>=0&&u<=m.height)return m.note;return null}function r(d){if(!d||s.has(d))return;const u=Yo(d);u&&(o.set(d,u),s.add(d),Ie(n,$e(),s))}function l(d){if(!s.has(d))return;const u=o.get(d);u&&(u.stop(),o.delete(d)),s.delete(d),Ie(n,$e(),s)}function a(){for(const d of s)l(d)}let c=!1;e.addEventListener("mousedown",d=>{c=!0;const u=e.getBoundingClientRect(),f=d.clientX-u.left,m=d.clientY-u.top,h=i(f,m);r(h)}),e.addEventListener("mousemove",d=>{if(!c)return;const u=e.getBoundingClientRect(),f=d.clientX-u.left,m=d.clientY-u.top,h=i(f,m);r(h)}),e.addEventListener("mouseup",()=>{c=!1,a()}),e.addEventListener("mouseleave",()=>{c=!1,a()})}const fn=[..."qwertyuiop[zxcvbnm,./"],mn=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];let pt=!1,He=null,Ce=null,ke=null;function Qo(e,t){if(pt)return;pt=!0;const n=e.getContext("2d"),o=new Set,s=new Set,i=new Map,r=fn,l=mn;He=t;function a(){const u=He(),f=Object.values(u).filter(y=>!y.isBlack).sort((y,g)=>y.x-g.x).map(y=>y.note),m=Object.values(u).filter(y=>y.isBlack).sort((y,g)=>y.x-g.x).map(y=>y.note),h={};return r.forEach((y,g)=>{f[g]&&(h[y]=f[g])}),l.forEach((y,g)=>{m[g]&&(h[y]=m[g])}),h}function c(u){const f=a(),m=f[u];if(!(!m||o.has(u))){if(o.add(u),!s.has(m)){const h=un(m,100,xo());h&&(i.set(m,{stop:h}),s.add(m))}Ie(n,He(),s,f)}}function d(u){const f=a(),m=f[u];m&&(o.delete(u),s.has(m)&&(jo(m),i.delete(m),s.delete(m)),Ie(n,He(),s,f))}Ce=u=>{u.repeat||c(u.key)},ke=u=>{d(u.key)},window.addEventListener("keydown",Ce),window.addEventListener("keyup",ke)}function Jo(){Ce&&(window.removeEventListener("keydown",Ce),Ce=null),ke&&(window.removeEventListener("keyup",ke),ke=null),pt=!1}let he=3,ge=Kt(he),Ue=!1;async function Zo(e){const t=e.getContext("2d");await Ft("fluidr3-gm/acoustic_grand_piano");const n=fn,o=mn;function s(){const g=Object.values(ge).filter(v=>!v.isBlack).sort((v,w)=>v.x-w.x).map(v=>v.note),p=Object.values(ge).filter(v=>v.isBlack).sort((v,w)=>v.x-w.x).map(v=>v.note),E={};return n.forEach((v,w)=>{g[w]&&(E[v]=g[w])}),o.forEach((v,w)=>{p[w]&&(E[v]=p[w])}),E}function i(){ge=Kt(he);const g=Ue?s():null;Ie(t,ge,new Set,g)}Vo(e,()=>ge),i(),document.getElementById("octave-up").addEventListener("click",()=>{he<7&&(he++,i())}),document.getElementById("octave-down").addEventListener("click",()=>{he>1&&(he--,i())});const r=document.getElementById("disable-keyboard-inputs");r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700"),r.addEventListener("click",()=>{Ue=!Ue,Ue?(Qo(e,()=>ge),r.classList.remove("bg-gray-700"),r.classList.add("bg-purple-600")):(Jo(),r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-700")),i()});const l=document.getElementById("instrument-select-btn"),a=document.getElementById("instrument-select-modal"),c=document.getElementById("instrument-select"),d=document.getElementById("instrument-select-confirm"),u=document.getElementById("instrument-cancel-btn"),f=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([g,p])=>{const E=document.createElement("option");E.value=g,E.textContent=g.replace(/_/g," ").replace(/\b\w/g,v=>v.toUpperCase()),f.appendChild(E)}),f.addEventListener("change",async g=>{var w;const p=f.value,E=document.getElementById("instrument-select"),v=((w=g.detail)==null?void 0:w.preselect)||null;try{let S;p==="mallets"?S=await Do():p==="electricpiano"?S=await Fo():p==="splendidgrandpiano"?S=await Oo():p==="drummachines"?S=await $o():p==="smolken"?S=await Ho():["fluidr3-gm","musyngkite","fatboy"].includes(p)?S=await Uo({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[p]):S=await(await fetch(`/static/${p}.json`)).json(),E.innerHTML="",S.forEach(M=>{const I=document.createElement("option");I.value=`${p}/${M}`,I.textContent=M.split("_").map(k=>k.charAt(0).toUpperCase()+k.slice(1)).join(" "),E.appendChild(I)}),E.value=v||`${p}/${S[0]}`}catch(S){console.error(`Failed to load instruments for library: ${p}`,S)}}),f.dispatchEvent(new Event("change")),l.addEventListener("click",async()=>{const g=Wo()||"fluidr3-gm/acoustic_grand_piano",[p,E]=g.split("/");f.value=p,await f.dispatchEvent(new CustomEvent("change",{detail:{preselect:g}})),a.classList.remove("hidden"),delete a.dataset.currentSequencer}),d.addEventListener("click",async()=>{const g=c.value;a.classList.add("hidden");const p=a.dataset.currentSequencer;if(p){console.log("[Modal] Looking up sequencer with id:",p);const E=Bo(p);console.log("[Modal] Lookup result:",E),E&&E.setInstrument(g),a.dataset.currentSequencer=""}else try{await Ft(g)}catch(E){console.error("Failed to load global instrument:",g,E)}});let h=!1;const y=document.getElementById("instrument-loop-toggle");y.addEventListener("change",()=>{h=y.checked,console.log("[UI] Loop mode:",h)}),u.addEventListener("click",()=>{a.classList.add("hidden")})}function xo(){var e;return((e=document.getElementById("instrument-loop-toggle"))==null?void 0:e.checked)||!1}function es(e,t){const n=t.getContext("2d"),o=t.width,s=t.height,i=new Uint8Array(e.fftSize),r=new Uint8Array(e.frequencyBinCount),l=document.createElement("canvas");l.width=o,l.height=s;const a=l.getContext("2d");let c="frequency";function d(){e.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,o,s),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const h=o/i.length;let y=0;for(let g=0;g<i.length;g++){const E=i[g]/128*s/2;g===0?n.moveTo(y,E):n.lineTo(y,E),y+=h}n.lineTo(o,s/2),n.stroke()}function u(){e.getByteFrequencyData(r),n.fillStyle="#000",n.fillRect(0,0,o,s),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,s),n.fillRect(o-1,0,1,s);const h=128,y=2,g=[];for(let p=0;p<h;p++)g.push(p*o/(h-1));g[g.length-1]=o-1;for(let p=0;p<h;p++){const E=g[p],v=p<h-1?g[p+1]:o,w=Math.max(1,v-E-y),S=20,M=2e4,I=p/(h-1),k=S*Math.pow(M/S,I),R=Math.min(r.length-1,Math.floor(k/22050*r.length)),K=r[R]/255,_=Math.max(1,K*s),G=240-I*240;n.fillStyle=`hsl(${G}, ${80+K*20}%, ${40+K*40}%)`,n.fillRect(E,s-_,w,_)}}function f(){e.getByteFrequencyData(r),l.initialized||(a.fillStyle="#000",a.fillRect(0,0,o,s),l.initialized=!0),a.drawImage(l,-1,0),a.fillStyle="#000",a.fillRect(o-1,0,1,s);const h=128,y=20,g=2e4;for(let p=0;p<h;p++){const E=p/(h-1),v=y*Math.pow(g/y,E),S=Math.min(r.length-1,Math.floor(v/22050*r.length)),M=r[S]/255,I=s-1-Math.floor(p*s/h);if(M<.05)continue;const k=Math.floor(M*255),C=Math.floor(M*(255-E*200)),R=Math.floor(M*(100+E*155));a.fillStyle=`rgb(${k}, ${C}, ${R})`,a.fillRect(o-1,I,1,1)}n.fillStyle="#000",n.fillRect(0,0,o,s),n.drawImage(l,0,0)}function m(){switch(requestAnimationFrame(m),c){case"frequency":u();break;case"spectrogram":f();break;case"waveform":default:d()}}return m(),{setMode(h){["waveform","frequency","spectrogram"].includes(h)&&(c=h,n.clearRect(0,0,o,s),c==="spectrogram"&&a.clearRect(0,0,o,s))}}}function ts(e,t){const n=es(et,e),o=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let s=0;function i(){s=(s+1)%o.length;const{name:r,emoji:l}=o[s];n.setMode(r),t.textContent=l,t.title=`Mode: ${r}`}t.addEventListener("click",i),i()}function ns(e){if(!e.length)throw new Error("No tracks to export.");const t=le(),n=_e(),o=Pe(),s={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:o},i:e.map(r=>r.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.map(({notes:r})=>({n:r.map(l=>[l.pitch,l.start,l.duration])}))},i=new Blob([JSON.stringify(s)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function os(e){if(!e.length)return;const n=60/le(),o=Math.max(...e.flatMap(d=>d.notes.map(u=>(u.start+u.duration)*n+.2))),s=44100,i=new OfflineAudioContext(2,Math.ceil(s*o),s);for(const d of e){const u=d.instrument||"fluidr3-gm/acoustic_grand_piano",f=new an(null,d.config,i,i.destination,u);f.setState(d),await f.exportToOffline()}const r=await i.startRendering(),l=ss(r),a=URL.createObjectURL(l),c=document.createElement("a");c.href=a,c.download=`session-${Date.now()}.wav`,c.click(),URL.revokeObjectURL(a)}function ss(e){const t=e.numberOfChannels,n=e.length*t*2,o=new DataView(new ArrayBuffer(44+n)),s=(r,l)=>{for(let a=0;a<l.length;a++)o.setUint8(r+a,l.charCodeAt(a))};s(0,"RIFF"),o.setUint32(4,36+n,!0),s(8,"WAVE"),s(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,t,!0),o.setUint32(24,e.sampleRate,!0),o.setUint32(28,e.sampleRate*t*2,!0),o.setUint16(32,t*2,!0),o.setUint16(34,16,!0),s(36,"data"),o.setUint32(40,n,!0);let i=44;for(let r=0;r<e.length;r++)for(let l=0;l<t;l++){const a=e.getChannelData(l)[r],c=Math.max(-1,Math.min(1,a));o.setInt16(i,c*32767,!0),i+=2}return new Blob([o.buffer],{type:"audio/wav"})}function is(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),o=document.getElementById("triplet-note-btn");let s=!1,i=!1;function r(a){a=parseFloat(a);let c=a;s?c=a*1.5:i&&(c=a*(2/3));let d=Array.from(t.options).find(u=>Math.abs(parseFloat(u.value)-c)<1e-4);d||(d=new Option(c.toString(),c.toString()),t.add(d)),t.value=d.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(d=>d.classList.remove("bg-purple-600")),a.classList.add("bg-purple-600");const c=parseFloat(a.dataset.value);r(c)})}),n.addEventListener("click",()=>{i&&(i=!1,o.classList.remove("bg-purple-600")),s=!s,n.classList.toggle("bg-purple-600"),l()}),o.addEventListener("click",()=>{s&&(s=!1,n.classList.remove("bg-purple-600")),i=!i,o.classList.toggle("bg-purple-600"),U.isTripletMode=i,L.forEach(a=>{a.config.isTripletMode=i}),l()});function l(){const a=document.querySelector(".note-duration-btn.bg-purple-600");if(a){const c=parseFloat(a.dataset.value);r(c)}}r(U.currentDuration||1)}let Q=null,Ve=null;function rs(e){Ve=e,Q=Ve.getContext("2d")}function ye(e){if(!Q||!Ve)return;const{width:t,height:n}=Ve;Q.clearRect(0,0,t,n);const o=Math.round(e)+.5;Q.strokeStyle="#ff00ff",Q.lineWidth=1,Q.beginPath(),Q.moveTo(o,0),Q.lineTo(o,n),Q.stroke()}let Qe=!1,Ee=null,yt=!1;function as(e,t){Ee=e,Ee.addEventListener("mousedown",cs),window.addEventListener("mousemove",ls),window.addEventListener("mouseup",ds)}function cs(e){tn()&&(nn(),L.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),yt=!0),Qe=!0,gn(e)}function ls(e){Qe&&gn(e)}function ds(){Qe&&(Qe=!1,yt&&(on(),L.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),yt=!1))}function gn(e){const t=Ee.getBoundingClientRect(),n=Ee.width/t.width;let o=(e.clientX-t.left)*n;o=Math.max(0,Math.min(Ee.width,o));const s=P(),i=o/Ee.width*s;ne(i),ye(o)}const Nt={maxBeatsContext:32,extendBeatsAmount:16};function ws(){return Nt.maxBeatsContext}function Ss(){return Nt.extendBeatsAmount}function Et(e,t,n,o){const s=P(),i=o/s*t;e.clearRect(0,0,t,n);const r=Nt.maxBeatsContext,a=Math.max(0,o-r)/s*t,c=i-a;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(a,0,c,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke()}let $t=!1;function Ht(){if(!$t){$t=!0;const o=document.getElementById("extend-use-tags"),s=document.getElementById("extend-tags");if(o&&s){let c=function(){const d=o.checked;s.disabled=!d,s.classList.toggle("opacity-50",!d),s.classList.toggle("cursor-not-allowed",!d)};c(),o.addEventListener("change",c)}const i=document.getElementById("extend-start-help-btn"),r=document.getElementById("extend-start-help-popup"),l=document.getElementById("extend-start-help-close");i&&r&&l&&(i.addEventListener("click",()=>r.classList.remove("hidden")),l.addEventListener("click",()=>r.classList.add("hidden")),document.addEventListener("click",c=>{!r.contains(c.target)&&c.target!==i&&r.classList.add("hidden")}));const a=document.querySelector("#ai-extend-modal .generate-btn");a&&a.addEventListener("click",async()=>{const{extendTracksWithAI:c}=await Xt(async()=>{const{extendTracksWithAI:d}=await import("./extendTracks-V5P0Y9xU.js");return{extendTracksWithAI:d}},__vite__mapDeps([0,1]));await c()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",Re().forEach((s,i)=>{const r=`extend-track-${i}`,l=document.createElement("div");l.className="flex items-center gap-2";const a=document.createElement("input");a.type="checkbox",a.id=r,a.dataset.index=i,a.checked=!0,a.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const c=document.createElement("label");c.htmlFor=r,c.className="text-sm text-gray-200",c.textContent=s.config.name||`Track ${i+1}`,a.addEventListener("change",()=>{Be()}),l.appendChild(a),l.appendChild(c),e.appendChild(l)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!0),Be()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!1),Be()}),Be())}let st=!1,Ne=0;function Bs(){return Ne}function us(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d"),o=e.clientWidth,s=e.clientHeight;e.width=o,e.height=s,t.width=o,t.height=s,Be(),Et(n,o,s,Ne),t.addEventListener("mousedown",r=>{st=!0,i(r.offsetX)}),window.addEventListener("mouseup",()=>{st=!1}),window.addEventListener("mousemove",r=>{if(!st)return;const l=t.getBoundingClientRect();i(r.clientX-l.left)});function i(r){const l=P(),a=Math.max(0,Math.min(r,o));Ne=Math.round(a/o*l),Et(n,o,s,Ne)}}function Be(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead"),n=t.getContext("2d"),o=t.width,s=t.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),r=Array.from(i).filter(a=>a.checked).map(a=>parseInt(a.dataset.index,10)),l=Re().filter((a,c)=>r.includes(c));oe(e,l),Et(n,o,s,Ne)}function fs(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),o=document.getElementById("note-duration-controls"),s=document.getElementById("select-mode-controls"),i=document.getElementById("velocity-mode-controls");function r(a){[e,t,n].forEach(c=>{c.classList.remove("bg-purple-600"),c.classList.add("bg-gray-800")}),a.classList.remove("bg-gray-800"),a.classList.add("bg-purple-600")}function l(a){[o,s,i].forEach(c=>{c.classList.add("hidden")}),a.classList.remove("hidden")}e.addEventListener("click",()=>{r(e),l(o),Oe("note-placement")}),t.addEventListener("click",()=>{r(t),l(s),Oe("select")}),n.addEventListener("click",()=>{r(n),l(i),Oe("velocity")}),window.addEventListener("keydown",a=>{var u;const c=(u=document.activeElement)==null?void 0:u.tagName;if(!(c==="INPUT"||c==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(a.key){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),r(e),l(o),Oe("note-placement")}function ms(){const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),o=document.getElementById("ai-control-panel");function s(){document.querySelectorAll(".sequencer").forEach(f=>{const m=f.querySelector(".delete-btn"),h=f.querySelector(".collapse-btn"),y=h.querySelector("use");m.classList.add("button-locked"),h.classList.add("button-locked");const g=f.querySelector(".sequencer-body"),p=f.querySelector(".mini-contour");xe(f,!1),g.classList.contains("hidden")||(g.classList.add("hidden"),p.classList.remove("hidden"),y.setAttribute("href","#icon-caret-up"))})}function i(){document.querySelectorAll(".sequencer").forEach(f=>{const m=f.querySelector(".delete-btn"),h=f.querySelector(".collapse-btn");m.classList.remove("button-locked"),h.classList.remove("button-locked")})}function r(){e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),o.classList.add("hidden"),i()}function l(){if(!gt()){document.getElementById("openai-key-not-set-modal").classList.remove("hidden");return}t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),o.classList.remove("hidden"),s()}e.addEventListener("click",r),t.addEventListener("click",l);const a=document.getElementById("ai-inpaint-modal"),c=document.getElementById("ai-extend-modal"),d=document.getElementById("ai-generate-modal");function u(f){f.querySelector(".cancel-btn").addEventListener("click",()=>{f.classList.add("hidden")})}u(a),u(c),u(d),Ht(),document.getElementById("ai-inpaint-btn").addEventListener("click",()=>{a.classList.remove("hidden")}),document.getElementById("ai-extend-btn").addEventListener("click",()=>{c.classList.remove("hidden"),us(),Ht()}),document.getElementById("ai-generate-btn").addEventListener("click",()=>{d.classList.remove("hidden")}),fs()}function gs(){document.addEventListener("keydown",s=>{var c;if(kt()!==Ct.SELECT)return;const r=navigator.platform.toUpperCase().includes("MAC")?s.metaKey:s.ctrlKey,l=(c=document.activeElement)==null?void 0:c.tagName;if(!(l==="INPUT"||l==="TEXTAREA"||!Fe()))switch(!0){case(r&&s.key==="c"):s.preventDefault(),t==null||t.click();break;case(r&&s.key==="x"):s.preventDefault(),n==null||n.click();break;case(r&&s.key==="v"):s.preventDefault(),o==null||o.click();break;case s.key==="Delete":s.preventDefault(),e==null||e.click();break}});const e=document.querySelector(".select-mode-delete");e&&(e.onclick=()=>{const s=Fe();if(!s)return;const i=s.gridContext,r=i.getSelectedNotes();r.length!==0&&(q(bt(i.sequencer.id,r),wt(i.sequencer.id,r)),i.setSelectedNotes([]))});const t=document.querySelector(".select-mode-copy");t&&(t.onclick=()=>{const s=Fe();if(!s)return;const i=s.getSelectedNotes();i.length!==0&&qt(i)});const n=document.querySelector(".select-mode-cut");n&&(n.onclick=()=>{const s=Fe();if(!s)return;const i=s.gridContext,r=i.getSelectedNotes();r.length!==0&&(qt(r),q(Hn(i.sequencer.id,r),Un(i.sequencer.id,r)),i.setSelectedNotes([]))});const o=document.querySelector(".select-mode-paste");o&&(o.onclick=()=>{ft().notes.length&&(document.body.style.cursor="crosshair",mo((i,r)=>{const l=i.gridContext,{x:a,y:c}=l.getCanvasPos(r),d=l.getSnappedBeatFromX(a),u=l.getPitchFromRow(Math.floor(c/l.getCellHeight())),f=A(u),{notes:m,anchorBeat:h,anchorMidi:y}=ft(),g=d-h,p=f-y,E=m.map(v=>({pitch:Me(A(v.pitch)+p),start:v.start+g,duration:v.duration}));q(Kn(l.sequencer.id,E),Gn(l.sequencer.id,E)),l.setSelectedNotes(E),document.body.style.cursor="default",Lt()}))})}function hs(e=qe()){lt(e.tempo,!1),dt(e.timeSignature[0],!1),ut(e.totalMeasures,!1);for(const n of e.sequencers){let o=L.find(r=>r.id===n.id);if(!o){const{wrapper:r}=ln({id:n.id,instrument:n.instrument,config:{...n.config},notes:n.notes}),l=r.querySelector(".sequencer");l&&xe(l,!0)}o.config.instrument=n.instrument;const s=o.container.querySelector("canvas.mini-contour");s&&Te(s,o.notes,o.config,o.colorIndex);const i=o.grid.gridContext;i.setSelectedNotes([]),i.notes.length=0,i.notes.push(...structuredClone(n.notes)),o.grid.scheduleRedraw()}const t=document.getElementById("global-mini-contour");t&&oe(t,L)}Yn(hs);function hn(){oe(ps,L)}const ps=document.getElementById("global-mini-contour"),It=document.getElementById("global-mini-playhead");rs(It);as(It);ye(0);const ys=document.getElementById("piano");Zo(ys);const Es=document.getElementById("waveform");ts(Es,document.getElementById("visualizer-mode"));const Ut=0,vs="fluidr3-gm/acoustic_grand_piano";q(Yt(Ut,vs),vt(Ut));q(Bt("Initial App State"),Qt("Initial App State"));gs();hn();Lo();is();ms();qo({getSequencers:()=>L,onPlay:()=>{je();const e=P(),t=We();to(le(),{loop:U.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{L.forEach(n=>{var o;return(o=n.onTransportLoop)==null?void 0:o.call(n)})}}),ct(n=>{const o=n/e*It.width;ye(o)}),L.forEach(n=>n.play()),eo(()=>{_o(),ne(0),ye(0)})},onPause:()=>{nn(),L.forEach(e=>e.pause())},onResume:()=>{on(),L.forEach(e=>e.resume())},onStop:()=>{je(),ne(0),L.forEach(e=>e.stop()),ye(0)},onDurationChange:e=>{U.currentDuration=e,L.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{U.snapResolution=e,L.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{U.loopEnabled=e,L.forEach(t=>t.config.loopEnabled=e)},onTempoChange:lt,onSave:async e=>{const t=L.map(n=>n.getState());if(e==="json"){const{url:n,filename:o}=ns(t),s=document.createElement("a");s.href=n,s.download=o,s.click(),URL.revokeObjectURL(n)}else e==="wav"?await os(t):e==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async e=>{try{const{tracks:t,globalConfig:n}=await bo(e);lt(n.bpm),dt(n.beatsPerMeasure),ut(n.totalMeasures);const o=document.getElementById("tempo-input");o&&(o.value=le());const s=document.getElementById("measures-input");s&&(s.value=Pe()),Mo();for(const[i,r]of t.entries()){const l=i,a=r.instrument||"fluidr3-gm/acoustic_grand_piano",c=r.notes||[];q({type:"CREATE_SEQUENCER",id:l,instrument:a,notes:structuredClone(c),config:r.config||{}},vt(l))}q(Bt("Session Loaded"),Qt("Session Loaded")),lo(),hn(),ne(0),ye(0)}catch(t){alert("Failed to load file: "+t.message)}},onMeasuresChange:e=>{ut(e);const t=document.getElementById("global-mini-contour");t&&oe(t,L)},onBeatsPerMeasureChange:e=>{dt(e);const t=document.getElementById("global-mini-contour");t&&oe(t,L)}});const Ms=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{Rt as a,Re as b,Bs as c,ws as d,Ss as e,_e as f,gt as g,Te as h,oe as i,Ms as m,ut as u};
