const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-DV34HA7T.js","assets/index-o0AAgJur.js"])))=>i.map(i=>d[i]);
import{_ as hi}from"./index-o0AAgJur.js";function nn(e=3){const r=["C","D","E","F","G","A","B"],s=["C#","D#","","F#","G#","A#",""],c=[e,e+1,e+2],l={};let u=0;for(const a of c)r.forEach(d=>{const h=`${d}${a}`;l[h]={note:h,x:u,width:60,height:200,isBlack:!1},u+=60});u=0;for(const a of c)s.forEach((d,h)=>{if(d===""){u+=60;return}const f=`${d}${a}`;l[f]={note:f,x:u+60-40/2,width:40,height:120,isBlack:!0},u+=60});return l}function nt(e,t,n=new Set,o=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const i={};if(o)for(const[r,s]of Object.entries(o))i[s]=r;for(const r of Object.values(t))r.isBlack||(ar(e,{...r,fill:n.has(r.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",i[r.note]&&(e.fillStyle="#7c3aed",e.fillText(i[r.note],r.x+r.width/2,r.height-24),e.fillStyle="#333"),e.fillText(r.note,r.x+r.width/2,r.height-8));for(const r of Object.values(t))r.isBlack&&(ar(e,{...r,fill:n.has(r.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),pi(e,r),i[r.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(i[r.note],r.x+r.width/2,r.height-28)))}function ar(e,t){const{x:n,width:o,height:i,fill:r,stroke:s,radius:c=8}=t;e.beginPath(),e.moveTo(n,0),e.lineTo(n,i-c),e.quadraticCurveTo(n,i,n+c,i),e.lineTo(n+o-c,i),e.quadraticCurveTo(n+o,i,n+o,i-c),e.lineTo(n+o,0),e.closePath(),e.fillStyle=r,e.fill(),e.strokeStyle=s,e.lineWidth=1,e.stroke()}function pi(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}const J={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0},oe=64,mi={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"},gi={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"},cr={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125},At=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:60,cellHeight:25},{cellWidth:80,cellHeight:30}],Yr={openaiApiKey:"",openaiModel:"gpt-4o",gridColorScheme:"Darkroom",noteColorScheme:"Track Color"};function ot(){return Yr}function It(e){Object.assign(Yr,e)}function yi(){const e=ot();localStorage.setItem("userConfig",JSON.stringify(e))}function bi(){const e=localStorage.getItem("userConfig");if(e)try{const t=JSON.parse(e);It(t)}catch(t){console.error("Failed to parse userConfig from localStorage:",t)}}bi();const lr=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];function wn(){return ot().openaiApiKey}function ur(){return ot().openaiModel}function vi(e){It({openaiApiKey:e})}function wi(e){if(!lr.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${lr.join(", ")}`);It({openaiModel:e})}function Ei(){var i;const e=document.getElementById("openai-key-input"),t=document.getElementById("openai-model-select"),n=document.getElementById("config-save"),o=document.querySelectorAll("#config-close, #config-close-bottom");e.value=wn(),t.value=ur(),n.addEventListener("click",()=>{var r;vi(e.value),wi(t.value),yi(),(r=document.getElementById("userconfig-modal"))==null||r.classList.add("hidden")}),o.forEach(r=>{r.addEventListener("click",()=>{var s;e.value=wn(),t.value=ur(),(s=document.getElementById("userconfig-modal"))==null||s.classList.add("hidden")})}),(i=document.getElementById("key-not-set-ok"))==null||i.addEventListener("click",()=>{var r;(r=document.getElementById("openai-key-not-set-modal"))==null||r.classList.add("hidden")})}function _i(e,t){return e/t()}function Jr(e,t){const n=t.snapResolution||.25,o=t.isTripletMode?n*(2/3):n;return Math.round(e/o)*o}function Si(e,t,n){const o=_i(e,n);return Jr(o,t)}const ki={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function L(e){const t=e==null?void 0:e.match(/^([A-Ga-g])([#b]*)(-?\d+)$/);if(!t)return null;const[,n,o,i]=t,r=n.toUpperCase(),s=ki[r];if(s===void 0)return null;const c=[...o].reduce((u,a)=>a==="#"?u+1:a==="b"?u-1:u,0);return 12*(parseInt(i,10)+1)+(s+c)}const Ii=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],Pi=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];function Me(e,t=!1){const o=(t?Pi:Ii)[e%12],i=Math.floor(e/12)-1;return`${o}${i}`}function Mi(e){return e.replace(/\d+$/,"")}function Ci(e){return e.includes("#")}function Qr(e,t,n,o,i,r=4){e.beginPath(),e.moveTo(t+r,n),e.lineTo(t+o-r,n),e.quadraticCurveTo(t+o,n,t+o,n+r),e.lineTo(t+o,n+i-r),e.quadraticCurveTo(t+o,n+i,t+o-r,n+i),e.lineTo(t+r,n+i),e.quadraticCurveTo(t,n+i,t,n+i-r),e.lineTo(t,n+r),e.quadraticCurveTo(t,n,t+r,n),e.closePath()}function Ti(e,t){const n=structuredClone(e);return n.tempo=t.bpm,n}function Zr(e){return{type:"CHANGE_TEMPO",bpm:e}}function Ni(e){return Zr(e)}function Bi(e,t){const n=structuredClone(e);return n.timeSignature=[t.beats,4],n}function eo(e){return{type:"SET_TIME_SIGNATURE",beats:e}}function Li(e){return eo(e)}function Fi(e,t){const n=structuredClone(e);return n.totalMeasures=t.measures,n}function to(e){return{type:"SET_TOTAL_MEASURES",measures:e}}function Ai(e){return to(e)}function Oi(e,t){const n=structuredClone(e);if(n.sequencers.push({id:t.id,instrument:t.instrument,notes:t.notes??[]}),!B.find(i=>i.id===t.id)){const i={id:t.id,instrument:t.instrument,notes:t.notes??[]},{wrapper:r}=Co(i);Nt(r,!0)}return n}function no(e,t){return{type:"CREATE_SEQUENCER",id:e,instrument:t}}function An(e){return{type:"DELETE_SEQUENCER",id:e}}function Ri(e,t){const n=structuredClone(e);n.sequencers=n.sequencers.filter(i=>i.id!==t.id);const o=B.findIndex(i=>i.id===t.id);return o!==-1&&(B[o].destroy(),B.splice(o,1)),n}function Di(e,t,n=[]){return{type:"DELETE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function qi(e,t,n=[]){return{type:"CREATE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function Ui(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);return o&&t.instrument&&(o.instrument=t.instrument),n}function xi(e,t){return{type:"SET_INSTRUMENT",sequencerId:e,instrument:t}}function $i(e,t){return{type:"SET_INSTRUMENT",sequencerId:e,instrument:t}}const rt=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function dr(e){return e<0&&(console.error(`Invalid trackId: ${e}. Using default color.`),e=0),rt[e%rt.length]}function Hi(e){return e&&typeof e.colorIndex=="number"?dr(e.colorIndex):(console.error(`Invalid sequencer colorIndex: ${e==null?void 0:e.colorIndex}. Using default color.`),dr(0))}function Pt(e,t,n,o=0){const i=e.getContext("2d");if(!i)return;i.imageSmoothingEnabled=!1;const r=e.width,s=e.height;if(i.clearRect(0,0,r,s),!t.length)return;const c=rt[o%rt.length];i.fillStyle=c;const l=z(),u=t.map(g=>L(g.pitch)).filter(g=>g!==null);if(!u.length)return;let a=Math.min(...u),d=Math.max(...u),h=Math.max(1,d-a);for(;s%h!==0;)d++,h=d-a;const f=s/h;for(const g of t){const v=L(g.pitch);if(v==null)continue;const w=g.start/l*r,b=g.duration/l*r,_=(v-a)/h,E=s-_*s-f/2,C=Math.round(w),P=Math.max(1,Math.round(b)),T=Math.round(E);i.fillRect(C,T,P,f)}const m=Ct(),y=Tt();i.save();let p=1;y>256?p=16:y>128?p=8:y>32&&(p=4);for(let g=0;g<=y;g++){if(g%p!==0)continue;const w=g*m/l*r,b=Math.round(w)+.5;i.beginPath(),i.moveTo(b,0),i.lineTo(b,s);const _=p===1||g%(p*2)===0;i.strokeStyle=_?"rgba(255, 255, 255, 0.12)":"rgba(255, 255, 255, 0.04)",i.lineWidth=.2,i.stroke()}i.restore()}function ne(e,t){const n=e.getContext("2d");if(!n)return;const o=e.width,i=e.height;n.clearRect(0,0,o,i);const r=z();for(const s of t){const{notes:c,config:l}=s;if(!(c!=null&&c.length))continue;const u=rt[t.indexOf(s)%rt.length];n.fillStyle=u;const a=L(l.noteRange[0]),d=L(l.noteRange[1]);if(a==null||d==null)continue;const h=d-a||1,f=Math.max(2,i/h);for(const m of c){const y=L(m.pitch);if(y==null)continue;const p=m.start/r*o,g=Math.max(1,m.duration/r*o),v=(y-a)/h,w=i-v*i-f/2;n.fillRect(p,w,g,f)}}}function Gi(e,t){ne(e,t)}function ji(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;o.notes.push(...t.notes);const i=document.getElementById("global-mini-contour");return i&&ne(i,B),n}function zi(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Wi(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Ki(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);if(!o)return e;const i=new Set(t.notes.map(s=>`${s.pitch}|${s.start}|${s.duration}`));o.notes=o.notes.filter(s=>{const c=`${s.pitch}|${s.start}|${s.duration}`;return!i.has(c)});const r=document.getElementById("global-mini-contour");return r&&ne(r,B),n}function On(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Rn(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Xi(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);if(!o)return e;const i=t.from,r=t.to;for(let s=0;s<i.length;s++){const c=i[s],l=r[s],u=o.notes.findIndex(a=>a.pitch===c.pitch&&a.start===c.start&&a.duration===c.duration);u!==-1&&(o.notes[u].pitch=l.pitch,o.notes[u].start=l.start)}return n}function Dn(e,t,n){return{type:"MOVE_NOTES",sequencerId:e,from:structuredClone(t),to:structuredClone(n)}}function ro(e,t,n){return Dn(e,n,t)}function Vi(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const i=new Set(t.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));return o.notes=o.notes.filter(r=>{const s=`${r.pitch}|${r.start}|${r.duration}`;return!i.has(s)}),n}function Yi(e,t){return{type:"CUT_NOTES",sequencerId:e,notes:structuredClone(t)}}function Ji(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Qi(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);return o?(o.notes.push(...t.notes),n):e}function Zi(e,t){return{type:"PASTE_NOTES",sequencerId:e,notes:structuredClone(t)}}function es(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function ts(e,t){return structuredClone(e)}function ns(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);if(!o)return e;const i=t.resizes;for(const s of i){const c=o.notes.find(l=>l.pitch===s.pitch&&l.start===s.start);c&&(c.duration=s.newDuration)}const r=document.getElementById("global-mini-contour");return r&&ne(r,B),n}function rs(e,t){return{type:"RESIZE_NOTES",sequencerId:e,resizes:structuredClone(t)}}function os(e,t){const n=t.map(o=>({pitch:o.pitch,start:o.start,newDuration:o.oldDuration}));return{type:"RESIZE_NOTES",sequencerId:e,resizes:n}}function is(e,t){return structuredClone(e)}function qn(e=""){return{type:"CHECKPOINT",label:e}}function oo(e=""){return qn(e)}const ss=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_TEMPO:Ti,CHECKPOINT:is,CREATE_SEQUENCER:Oi,CUT_NOTES:Vi,DELETE_NOTES:Ki,DELETE_SEQUENCER:Ri,MOVE_NOTES:Xi,PASTE_NOTES:Qi,PLACE_NOTES:ji,RESIZE_NOTES:ns,SET_INSTRUMENT:Ui,SET_TIME_SIGNATURE:Bi,SET_TOTAL_MEASURES:Fi,UPDATE_NOTE_VELOCITY:ts},Symbol.toStringTag,{value:"Module"}));function Un(e){const t=ss[e.type];if(!t)throw new Error(`Unknown diff type: ${e.type}`);const n=t(it(),e);io(n)}const En=new Set;function as(e){return En.add(e),()=>En.delete(e)}function Mt(e){for(const t of En)t(e)}const ge=[];let ue=-1;const cs=100;function ls({forwardDiff:e,reverseDiff:t}){ge.splice(ue+1),ge.push({forwardDiff:e,reverseDiff:t}),ue=ge.length-1,ge.length>cs&&(ge.shift(),ue--)}function us(){var e;if(ue<0)return null;for(let t=ue;t>=0;t--){const n=ge[t];if(((e=n==null?void 0:n.forwardDiff)==null?void 0:e.type)==="CHECKPOINT")return null;if(n!=null&&n.reverseDiff)return ue=t-1,Un(n.reverseDiff),Mt(it()),n.reverseDiff}return null}function ds(){if(ue>=ge.length-1)return null;ue++;const e=ge[ue];return!e||!e.forwardDiff?null:(Un(e.forwardDiff),Mt(it()),e.forwardDiff)}function fs(){ge.length=0,ue=-1}let Xt={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[]};function it(){return Xt}function io(e){Xt=structuredClone(e),Mt(Xt)}function G(e,t){Un(e),ls({forwardDiff:e,reverseDiff:t}),Mt(Xt)}let te=null,be=500,ve=null,Vt=!1,fr=1/0,Qe=[],Gt=null,so=0,ao=4,co=8;function _n(e){return Qe.push(e),()=>{const t=Qe.indexOf(e);t!==-1&&Qe.splice(t,1)}}function hs(){Qe=[]}function we(e){so=e}function Yt(){return so}function z(){return Tt()*Ct()}function xn(e,t=!0){if(t){const r=He();G(Zr(e),Ni(r));return}const n=performance.now(),o=(n-(ve??n))/be;be=60/e*1e3,ve!==null&&(ve=n-o*be);const i=document.getElementById("tempo-input");i&&i.value!==String(e)&&(i.value=String(e))}function He(){return 60/(be/1e3)}function $n(e,t=!0){if(t){const o=Ct();G(eo(e),Li(o));return}ao=e;const n=document.getElementById("beats-per-measure-input");n&&n.value!==String(e)&&(n.value=String(e)),Te().forEach(o=>{var i,r;(i=o.grid)!=null&&i.resizeAndRedraw?o.grid.resizeAndRedraw():(r=o.grid)==null||r.scheduleRedraw()})}function Ct(){return ao}function Hn(e,t=!0){if(t){const o=Tt();G(to(e),Ai(o));return}co=e;const n=document.getElementById("measures-input");n&&n.value!==String(e)&&(n.value=String(e)),Te().forEach(o=>{var i;(i=o.grid)==null||i.scheduleRedraw()})}function Tt(){return co}function ps(e){Vt=e}function ms(e){Gt=e}function gs(){return J.snapResolution}function ys(e,t={}){be=60/e*1e3,Vt=t.loop??!1,fr=t.endBeat??z();const n=t.startBeat??0;ve=performance.now()-n*be,we(n);const o=t.onLoop;function i(r){const c=(r-(ve??r))/be;if(we(c),Qe.forEach(l=>l(c)),c>=fr)if(Vt)ve=performance.now(),we(0),o&&o();else{Jt();return}te=requestAnimationFrame(i)}te=requestAnimationFrame(i)}function Jt(){te!==null&&cancelAnimationFrame(te),te=null,hs(),Gt&&(Gt(),Gt=null)}function bs(){return te!==null}function lo(){te!==null&&cancelAnimationFrame(te),te=null}function uo(){if(te!==null)return;ve=performance.now()-Yt()*be;function t(n){const i=(n-(ve??n))/be;if(we(i),Qe.forEach(r=>r(i)),i>=z())if(Vt)ve=performance.now(),we(0);else{Jt();return}te=requestAnimationFrame(t)}te=requestAnimationFrame(t)}const hr={Midnight:{whiteKey:"#1e1e1e",blackKey:"#2a103b",labelWhite:"#2c2c2c",labelBlack:"#3a1d4d",textWhite:"#cfcfcf",textBlack:"#e6d9ff",gridLine:"#333",beatLine:"#4e3d63",measureLine:"#8561c2"},Seashell:{whiteKey:"#fefefe",blackKey:"#f1e7dc",labelWhite:"#dddddd",labelBlack:"#d4cfc9",textWhite:"#444",textBlack:"#663300",gridLine:"#ccc",beatLine:"#bbb",measureLine:"#999"},Cyberpunk:{whiteKey:"#1b1b2f",blackKey:"#162447",labelWhite:"#1f4068",labelBlack:"#1f4068",textWhite:"#e43f5a",textBlack:"#e43f5a",gridLine:"#1f4068",beatLine:"#e43f5a",measureLine:"#ffcc00"},"Classic Blue":{whiteKey:"#f5faff",blackKey:"#dceeff",labelWhite:"#aaccee",labelBlack:"#88bbdd",textWhite:"#002244",textBlack:"#001122",gridLine:"#99bbdd",beatLine:"#88aacc",measureLine:"#336699"},Darkroom:{whiteKey:"#2c2c2c",blackKey:"#1e1e1e",labelWhite:"#383838",labelBlack:"#2a2a2a",textWhite:"#a0a0a0",textBlack:"#e0e0e0",gridLine:"#404040",beatLine:"#606060",measureLine:"#808080"}};function vs(e,t,n,o,i,r){const{gridColorScheme:s}=ot(),c=hr[s]||hr.Darkroom,l=Ct(),u=z(),a=u*o,d=n*i;e.font=`${Math.floor(i*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let h=0;h<n;h++){const f=h*i,m=r(h),y=Ci(m);e.fillStyle=y?c.blackKey:c.whiteKey,e.fillRect(0,f,a,i),e.fillStyle=y?c.labelBlack:c.labelWhite,e.fillRect(-64,f,oe,i),e.fillStyle=y?c.textBlack:c.textWhite,e.fillText(m,-8,f+i/2)}e.strokeStyle=c.gridLine,e.lineWidth=1;for(let h=0;h<n;h++){const f=h*i;e.beginPath(),e.moveTo(0,f),e.lineTo(a,f),e.stroke()}for(let h=0;h<=u;h++){const f=h*o,m=h%l===0;e.strokeStyle=m?c.measureLine:c.beatLine,e.lineWidth=m?2:1,e.beginPath(),e.moveTo(f,0),e.lineTo(f,d),e.stroke()}}const ws={Scriabin:(e,{getPitchClass:t}={})=>{const n=t?t(e.pitch):0;return mi[n]||"#999"},"Track Color":(e,{getTrackColor:t}={})=>(t==null?void 0:t())||"#999","Octave Bands":e=>{const t=L(e.pitch);return t==null?"#999":`hsl(${t*3%360}, 100%, 60%)`},"Pitch Class Contrast":(e,{getPitchClass:t}={})=>{const n=L(e.pitch);if(n==null)return"#999";const o=n%12;return["#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f"][o]||"#999"}};function Es(e,t=1){if(e.startsWith("#")){const n=parseInt(e.slice(1),16),o=n>>16&255,i=n>>8&255,r=n&255;return`rgba(${o}, ${i}, ${r}, ${t})`}if(e.startsWith("hsl(")){const[n,o,i]=e.slice(4,-1).split(",").map(l=>parseFloat(l.trim())),[r,s,c]=_s(n,o/100,i/100);return`rgba(${r}, ${s}, ${c}, ${t})`}return e}function _s(e,t,n){const o=(1-Math.abs(2*n-1))*t,i=o*(1-Math.abs(e/60%2-1)),r=n-o/2;let s=0,c=0,l=0;return 0<=e&&e<60?[s,c,l]=[o,i,0]:60<=e&&e<120?[s,c,l]=[i,o,0]:120<=e&&e<180?[s,c,l]=[0,o,i]:180<=e&&e<240?[s,c,l]=[0,i,o]:240<=e&&e<300?[s,c,l]=[i,0,o]:300<=e&&e<360&&([s,c,l]=[o,0,i]),[Math.round((s+r)*255),Math.round((c+r)*255),Math.round((l+r)*255)]}function Ss(e,t,{previewNotes:n=null,hoveredNote:o,selectedNote:i,selectedNotes:r=[],highlightedNotes:s=[],cellWidth:c,cellHeight:l,visibleStartBeat:u,visibleEndBeat:a,getPitchRow:d,getPitchClass:h,getTrackColor:f,drawRoundedRect:m}){const{noteColorScheme:p}=ot(),g=ws[p]||(()=>"#999");for(const v of t){if(v.start+v.duration<u-2||v.start>a)continue;const w=v.start*c,b=d(v.pitch)*l,_=v.duration*c,E=l-1,C=g(v,{getPitchClass:h,getTrackColor:f});e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=s.includes(v)?"rgba(96, 165, 250, 0.6)":C,m(e,w,b,_,E),e.fill();const P=e.createLinearGradient(w,b,w,b+E);P.addColorStop(0,"rgba(255,255,255,0.4)"),P.addColorStop(.2,"rgba(255,255,255,0.15)"),P.addColorStop(.5,"rgba(255,255,255,0.05)"),P.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=P,m(e,w,b,_,E),e.fill();const T=r.includes(v),N=v===o,M=s.includes(v);(T||N||M)&&(e.lineWidth=T?3:2,e.strokeStyle=T?"rgba(0, 255, 255, 1.0)":N?"rgba(255, 255, 255, 0.9)":"rgba(255, 200, 50, 0.7)",m(e,w,b,_,E),e.stroke())}if(n)for(const v of n){const w=v.start*c,b=d(v.pitch)*l,_=v.duration*c,E=l-1,C=g(v,{getPitchClass:h,getTrackColor:f});e.fillStyle=Es(C,.4),m(e,w,b,_,E),e.fill()}}function ks(e,t,n,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+n,0),e.lineTo(t+n,o),e.stroke(),e.restore()}function Is(e,t,n,o=oe){const i=e.getBoundingClientRect(),r=parseFloat(e.style.width||`${i.width}`),s=parseFloat(e.style.height||`${i.height}`),c=e.width/r,l=e.height/s,u=(t.clientX-i.left)*c-o,a=(t.clientY-i.top)*l;return{x:u,y:a}}function Ps(e,t,n,o,i,r){const s=Math.floor(t/i),c=e/r;return n.find(l=>c>=l.start&&c<l.start+l.duration&&o(l.pitch)===s)}function pr(e,t){const n=L(e),o=L(t);if(n===null||o===null)throw new Error(`Invalid pitches provided: ${e}, ${t}`);return n-o}function Ms(e,t,n,o){const i=e.querySelector(".zoom-in-btn"),r=e.querySelector(".zoom-out-btn"),s=e.querySelector(".zoom-reset-btn");!i||!r||!s||(i.addEventListener("click",t),r.addEventListener("click",n),s.addEventListener("click",o))}let rn=!1,Qt=null,K=null;function Cs(e){rn=!0,Qt=e,K=null}function Gn(){var e;if(K){if(!K.gridContext.setPastePreviewNotes)return;K.gridContext.setPastePreviewNotes(null),K.scheduleRedraw(),(e=K.setCursor)==null||e.call(K,"default")}rn=!1,Qt=null,K=null,document.body.style.cursor="default"}function jn(){return rn}function Ts(e,t){!rn||!Qt||(Qt(e,t),Gn())}function Ns(e){if(K&&K!==e){if(!K.gridContext.setPastePreviewNotes)return;K.gridContext.setPastePreviewNotes(null),K.scheduleRedraw()}K=e}const Ee={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let fo=Ee.NOTE_PLACEMENT;const Sn=new Set;function ho(){return fo}function ie(e){Gn(),fo=e;for(const t of Sn)t(e)}function Bs(e){return Sn.add(e),()=>Sn.delete(e)}let zn=!1;function Ls(){zn=!0,ie(Ee.SELECT)}function Ze(){zn=!1}function et(){return zn}let Wn=!1;function vt(e=!0){Wn=e}function mr(){return Wn}function gr(){Wn=!1}let po={notes:[],anchorBeat:0,anchorMidi:0};function mo(e){if(e.length===0)return;const t=e[0],n=t.start,o=L(t.pitch)??0;po={notes:e.map(i=>({pitch:i.pitch,start:i.start,duration:i.duration})),anchorBeat:n,anchorMidi:o}}function kn(){return po}let Kn=null,Xn=null;function Fs(e){Kn=e}function In(){return Kn}function yr(){Kn=null}function br(e,t,n){Xn={anchorNote:e,startX:t,startY:n,originalDuration:e.duration}}function dn(){return Xn}function As(){Xn=null}function go(e,t,n){if(!e.setPastePreviewNotes)return;if(!jn()){e.setPastePreviewNotes(null);return}const{notes:o,anchorBeat:i,anchorMidi:r}=kn(),s=e.getSnappedBeatFromX(t),c=e.getPitchFromRow(Math.floor(n/e.getCellHeight())),l=L(c);if(l===null)return;const u=s-i,a=l-r,d=o.map(h=>{const f=L(h.pitch);return f===null?{...h}:{pitch:Me(f+a)??h.pitch,start:h.start+u,duration:h.duration}});e.setPastePreviewNotes(d),e.scheduleRedraw()}function yo(e){e.setPastePreviewNotes&&jn()&&e.setPastePreviewNotes(null)}function bo(e,t){return jn()?(Ts(e.grid,t),t.preventDefault(),t.stopPropagation(),!0):!1}let wt=null;const Os=8;function vr(){wt=null}function Rs(e,t){wt={x:e,y:t}}function Ds(e,t){if(!wt)return!1;const n=e-wt.x,o=t-wt.y;return Math.sqrt(n*n+o*o)>=Os}let Ye=null;function ht(e){Ye&&Ye!==e&&Ye.clearSelection(),Ye=e}function qs(){Ye=null}function Vn(){return Ye}function Us(e,t,{getPitchRow:n,cellWidth:o,cellHeight:i,labelWidth:r}){const s=t.start*o+r,c=n(t.pitch)*i,l=t.duration*o,u=i-1,a=s+l/2,d=c+u/2,h=L(t.pitch);if(h===null)return;const f=h*5%360,m=e.animationCtx,y=performance.now(),p=500,g=3,v=60;function w(E,C,P){const T=Math.sin(E*Math.PI),N=1+C*T,M=(1-E)*P;m.globalAlpha=M,m.strokeStyle=`hsl(${f}, 100%, 65%)`,m.lineWidth=2;const O=l*N,D=u*N;m.beginPath(),m.roundRect(a-O/2,d-D/2,O,D,4),m.stroke()}function b(E){const C=Math.sin(E*Math.PI),T=`hsla(${f}, 100%, 80%, ${.4*C})`;m.globalAlpha=1,m.fillStyle=T,m.beginPath(),m.roundRect(s,c,l,u,3),m.fill()}function _(E){const C=E-y,P=C/p;if(P>1){m.clearRect(0,0,m.canvas.width,m.canvas.height);return}m.clearRect(0,0,m.canvas.width,m.canvas.height),m.save(),b(P);for(let T=0;T<g;T++){const N=T*v,M=Math.max(0,Math.min(1,(C-N)/(p-N)));w(M,.1+T*.1,.2)}m.restore(),requestAnimationFrame(_)}requestAnimationFrame(_)}function xs(e,t,{getPitchRow:n,cellWidth:o,cellHeight:i,labelWidth:r}){const s=t.start*o+r,c=n(t.pitch)*i,l=t.duration*o,u=i-1,a=s+l/2,d=c+u/2,h=L(t.pitch);if(h===null)return;const f=h*5%360,m=e.animationCtx,y=performance.now(),p=300;function g(v){const b=(v-y)/p;if(b>1){m.clearRect(0,0,m.canvas.width,m.canvas.height);return}m.clearRect(0,0,m.canvas.width,m.canvas.height),m.save();const _=1-.4*b,E=1-b,C=l*_,P=u*_;m.globalAlpha=E,m.fillStyle=`hsl(${f}, 100%, 70%)`,m.beginPath(),m.roundRect(a-C/2,d-P/2,C,P,3),m.fill(),m.restore(),requestAnimationFrame(g)}requestAnimationFrame(g)}function fn(e,t,n,o){if(!e||typeof e.getCellWidth!="function"||typeof e.getCellHeight!="function"||typeof e.getPitchRow!="function")return console.error("Invalid ctx object passed to isOnResizeHandle"),!1;const i=e.getCellWidth(),r=e.getCellHeight(),s=e.getPitchRow,c=Math.min(10,r*.8),u=(t.start+t.duration)*i+6,a=s(t.pitch)*r+(r-c)/2,d=4,h=u-d,f=u+c+d,m=a-d,y=a+c+d;return n>=h&&n<=f&&o>=m&&o<=y?console.log("Hit resize handle!"):console.log("Missed resize handle."),n>=h&&n<=f&&o>=m&&o<=y}function wr(e){let t=null,n=null,o=!1;function i(a){var v;if(console.log("ClickHandler called"),ht(e.grid),mr()){gr(),e.scheduleRedraw();return}const{x:d,y:h}=e.getCanvasPos(a);if(d<0){const w=e.getPitchFromRow(Math.floor(h/e.getCellHeight()));e.sequencer.playNote(w,.5);return}const f=e.getSnappedBeatFromX(d),m=e.getPitchFromRow(Math.floor(h/e.getCellHeight())),y=z();if(f+e.config.currentDuration>y||e.notes.some(w=>w.pitch===m&&w.start===f))return;e.sequencer.playNote(m,.5);const g={pitch:m,start:f,duration:e.config.currentDuration};G(zi(e.sequencer.id,[g]),Wi(e.sequencer.id,[g])),e.setSelectedNote(null),Us(e,g,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:oe}),e.scheduleRedraw(),(v=e.onNotesChanged)==null||v.call(e)}function r(a){a.preventDefault();const{x:d,y:h}=e.getCanvasPos(a),f=e.findNoteAt(d,h);if(!f||e.notes.indexOf(f)===-1)return;xs(e,f,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:oe});const y=[f];G(On(e.sequencer.id,y),Rn(e.sequencer.id,y)),gr(),e.setSelectedNote(null),e.scheduleRedraw()}function s(a){if(bo(e,a))return;const{x:d,y:h}=e.getCanvasPos(a),f=e.findNoteAt(d,h),m=In();if(m&&fn(e,m,d,h)){br(m,d,h);return}if(f){if(fn(e,f,d,h)){console.log("Resize mode started!"),br(f,d,h);return}ht(e.grid),e.setSelectedNote(f),ht(e.grid),e.setSelectedNote(f),t={startX:d,startY:h,anchorNote:f,initialNotes:[{note:f,start:f.start,midi:L(f.pitch)??0}],lastPreviewPitch:void 0};return}Rs(d,h),o=!1}function c(a){var g,v,w;e.grid.setCursor("default");const{x:d,y:h}=e.getCanvasPos(a);if(d<0){e.clearPreview();return}const f=dn();if(f){e.grid.setCursor("ew-resize");const b=d-f.startX,_=e.getSnappedBeatFromX(b)-e.getSnappedBeatFromX(0),E=Math.max(gs(),f.originalDuration+_);f.anchorNote.duration=E,e.scheduleRedraw(),(g=e.onNotesChanged)==null||g.call(e);return}go(e,d,h),yr(),e.grid.setCursor("default");const m=((v=e.getSelectedNotes)==null?void 0:v.call(e))??[];for(const b of m)if(fn(e,b,d,h)){Fs(b),e.grid.setCursor("ew-resize");break}if(!f&&!o&&Ds(d,h)){Ls(),e.selectionBox={active:!0,startX:d,startY:h,currentX:d,currentY:h},o=!0,ht(e.grid),vr();return}const y=e.findNoteAt(d,h);e.setHoveredNote(y??null);const p=e.getSelectedNote();if(dn()||(t&&p?e.grid.setCursor("grabbing"):y&&e.grid.setCursor("grab")),!y&&!t&&!mr()&&!In()){const b=e.getSnappedBeatFromX(d),_=e.getPitchFromRow(Math.floor(h/e.getCellHeight())),E=z();b+e.config.currentDuration<=E?e.updatePreview({pitch:_,start:b,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&p){const b=d-t.startX,_=e.getSnappedBeatFromX(b)-e.getSnappedBeatFromX(0),E=h-t.startY,C=Math.round(E/e.getCellHeight()),P=Math.max(0,t.initialNotes[0].start+_),T=z();P+p.duration<=T&&(p.start=P);const N=t.initialNotes[0].midi-C,M=L(e.config.noteRange[0])??0,O=L(e.config.noteRange[1])??127,D=Math.max(M,Math.min(O,N)),$=Me(D)??p.pitch;$!==p.pitch&&(p.pitch=$,n!==$&&(n=$,e.sequencer.playNote($,.5))),e.scheduleRedraw(),(w=e.onNotesChanged)==null||w.call(e),vt();return}e.scheduleRedraw()}function l(a){console.log("UpHandler called"),vr(),o=!1;const d=dn();if(d){const{anchorNote:p,originalDuration:g}=d,v=p.duration;g!==v&&G(rs(e.sequencer.id,[{pitch:p.pitch,start:p.start,newDuration:v}]),os(e.sequencer.id,[{pitch:p.pitch,start:p.start,oldDuration:g}])),As(),vt();return}if(!t||!e.getSelectedNote()){t=null;return}const{anchorNote:h}=t,f=t.initialNotes.find(p=>p.note===h);if(!f)return;const m={pitch:f.note.pitch,start:f.note.start,duration:f.note.duration};(f.start!==f.note.start||f.midi!==L(f.note.pitch))&&G(Dn(e.sequencer.id,[{pitch:Me(f.midi)??f.note.pitch,start:f.start,duration:f.note.duration}],[m]),ro(e.sequencer.id,[{pitch:Me(f.midi)??f.note.pitch,start:f.start,duration:f.note.duration}],[m])),vt(),t=null}function u(){e.clearPreview(),e.setHoveredNote(null),yr(),yo(e),e.scheduleRedraw()}return{attach(a){a.addEventListener("click",i),a.addEventListener("contextmenu",r),a.addEventListener("mousemove",c),a.addEventListener("mouseleave",u),a.addEventListener("mousedown",s),a.addEventListener("mouseup",l)},detach(a){a.removeEventListener("click",i),a.removeEventListener("contextmenu",r),a.removeEventListener("mousemove",c),a.removeEventListener("mouseleave",u),a.removeEventListener("mousedown",s),a.removeEventListener("mouseup",l)}}}function Er(e,{startX:t,currentX:n,startY:o,currentY:i,getCellHeight:r,getSnappedBeatFromX:s,getPitchFromRow:c}){const l=Math.min(t,n),u=Math.min(o,i),a=Math.max(t,n),d=Math.max(o,i),h=Math.floor(u/r()),f=Math.floor(d/r()),m=s(l),y=s(a),p=L(c(h)),g=L(c(f));return e.filter(v=>{const w=L(v.pitch);if(w===null||p===null||g===null)return!1;const b=v.start,E=v.start+v.duration>m&&b<y,C=w>=g-1&&w<=p+1;return E&&C})}function _r(e){let t=null;function n(c){c.preventDefault();const{x:l,y:u}=e.getCanvasPos(c),a=e.findNoteAt(l,u);if(!a)return;const d=e.getSelectedNotes(),h=d.includes(a)?d:[a];h.length&&(e.setSelectedNotes([]),G(On(e.sequencer.id,h),Rn(e.sequencer.id,h)),et()&&(Ze(),ie(Ee.NOTE_PLACEMENT)))}function o(c){if(!e.grid||bo(e,c))return;const{x:l,y:u}=e.getCanvasPos(c);if(l<0)return;const a=e.findNoteAt(l,u);e.setHoveredNote(a??null),ht(e.grid);const d=e.getSelectedNotes();if(a&&d.includes(a)){t={startX:l,startY:u,anchorNote:a,initialNotes:d.map(h=>({note:h,start:h.start,midi:L(h.pitch)??0}))};return}e.selectionBox={active:!0,startX:l,startY:u,currentX:l,currentY:u},e.clearPreview(),e.setSelectedNote(null)}function i(c){var b,_;if(!e.grid)return;Ns(e.grid);const{x:l,y:u}=e.getCanvasPos(c),a=e.findNoteAt(l,u);if(e.setHoveredNote(a??null),go(e,l,u),(b=e.selectionBox)!=null&&b.active){if(!e.setHighlightedNotes)return;e.selectionBox.currentX=l,e.selectionBox.currentY=u;const E=e.selectionBox,C=Er(e.notes,{startX:E.startX,currentX:E.currentX,startY:E.startY,currentY:E.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes(C),e.scheduleRedraw();return}if(!t)return;const d=t,h=l-d.startX,f=e.getSnappedBeatFromX(h)-e.getSnappedBeatFromX(0),m=u-d.startY,y=Math.round(m/e.getCellHeight()),p=z(),g=L(e.config.noteRange[0])??0,v=L(e.config.noteRange[1])??127;for(const{note:E,start:C,midi:P}of d.initialNotes){const T=Math.max(0,C+f),N=Math.max(g,Math.min(v,P-y)),M=Me(N)??E.pitch;T+E.duration<=p&&(E.start=T,E.pitch=M)}const w=d.initialNotes.find(E=>E.note===d.anchorNote);if(w){const E=w.note.pitch;d.lastPreviewPitch!==E&&(d.lastPreviewPitch=E,e.sequencer.playNote(E,.5))}e.scheduleRedraw(),(_=e.onNotesChanged)==null||_.call(e)}function r(c){var l,u;if((l=t==null?void 0:t.initialNotes)!=null&&l.length){const{initialNotes:a}=t,d=a.map(({start:m,midi:y,note:p})=>({pitch:Me(y)??p.pitch,start:m,duration:p.duration})),h=a.map(({note:m})=>({pitch:m.pitch,start:m.start,duration:m.duration}));d.some((m,y)=>m.pitch!==h[y].pitch||m.start!==h[y].start)&&(G(Dn(e.sequencer.id,d,h),ro(e.sequencer.id,d,h)),et()&&(Ze(),ie(Ee.NOTE_PLACEMENT)))}if(t=null,(u=e.selectionBox)!=null&&u.active){if(!e.setHighlightedNotes)return;const{x:a,y:d}=e.getCanvasPos(c);e.selectionBox.currentX=a,e.selectionBox.currentY=d,e.selectionBox.active=!1;const h=Er(e.notes,{startX:e.selectionBox.startX,currentX:e.selectionBox.currentX,startY:e.selectionBox.startY,currentY:e.selectionBox.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes([]),e.setSelectedNotes(h),e.scheduleRedraw(),et()&&e.getSelectedNotes().length===0&&(c.stopPropagation(),Ze(),ie(Ee.NOTE_PLACEMENT),vt()),vt()}}function s(){e.setHighlightedNotes&&(e.setHoveredNote(null),e.setHighlightedNotes([]),yo(e),e.scheduleRedraw())}return{attach(c){c.addEventListener("mousedown",o),c.addEventListener("mousemove",i),c.addEventListener("mouseup",r),c.addEventListener("mouseleave",s),c.addEventListener("contextmenu",n)},detach(c){c.removeEventListener("mousedown",o),c.removeEventListener("mousemove",i),c.removeEventListener("mouseup",r),c.removeEventListener("mouseleave",s),c.removeEventListener("contextmenu",n)}}}function $s(e,t){const n=t.selectionBox;if(!n)return;const o=n.startX,i=n.startY,r=n.currentX,s=n.currentY,c=Math.min(o,r),l=Math.min(i,s),u=Math.abs(r-o),a=Math.abs(s-i);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),Qr(e,c,l,u,a,3),e.stroke(),e.restore()}function Hs(e,t,{cellWidth:n,cellHeight:o,getPitchRow:i,isHovered:r=!1}){const s=Math.min(10,o*.8),l=(t.start+t.duration)*n+6,u=i(t.pitch)*o+(o-s)/2;e.save(),e.shadowColor="rgba(0,0,0,0.4)",e.shadowBlur=3,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=r?"rgba(0, 255, 255, 0.95)":"rgba(255, 255, 255, 0.85)",e.beginPath(),e.moveTo(l,u),e.lineTo(l+s,u+s/2),e.lineTo(l,u+s),e.closePath(),e.fill();const a=e.createLinearGradient(l,u,l,u+s);a.addColorStop(0,"rgba(255,255,255,0.9)"),a.addColorStop(.5,"rgba(255,255,255,0.5)"),a.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=a,e.beginPath(),e.moveTo(l,u),e.lineTo(l+s,u+s/2),e.lineTo(l,u+s),e.closePath(),e.fill(),e.restore()}function Gs(e,t,n,o,i,r,s){let c=null,l=null,u=null,a=null,d=[],h=2;const f=e.getContext("2d"),m=t.getContext("2d"),y=n.getContext("2d");if(!f||!m||!y)throw new Error("Failed to acquire required canvas contexts");const p=f,g=m,v=y;let w=At[h].cellWidth,b=At[h].cellHeight;const _=pr(r.noteRange[1],r.noteRange[0])+1,E=_*b,P=z()*w+oe;e.width=P,e.height=E,e.style.width=`${P}px`,e.style.height=`${E}px`,t.width=P,t.height=E,t.style.width=`${P}px`,t.style.height=`${E}px`,n.width=P,n.height=E,n.style.width=`${P}px`,n.style.height=`${E}px`;let T=null;function N(){T!==null&&cancelAnimationFrame(T),T=requestAnimationFrame(M)}function M(){var I,U;p.clearRect(0,0,e.width,e.height),p.save(),p.translate(oe,0),vs(p,r,_,w,b,Ne),Ss(p,i,{previewNotes:l??(c?[c]:null),hoveredNote:u,selectedNote:a,selectedNotes:d,highlightedNotes:((I=S.getHighlightedNotes)==null?void 0:I.call(S))??[],cellWidth:w,cellHeight:b,visibleStartBeat:0,visibleEndBeat:e.width/w,getPitchRow:ae,getPitchClass:Mi,getTrackColor:()=>Hi(s),drawRoundedRect:Qr});for(const Z of d)Hs(p,Z,{cellWidth:w,cellHeight:b,getPitchRow:ae,isHovered:Z===In()});(U=S.selectionBox)!=null&&U.active&&$s(p,S),p.restore()}function O(){h<At.length-1&&(h++,H())}function D(){h>0&&(h--,H())}function $(){h=2,H()}function H(){const I=At[h];w=I.cellWidth,b=I.cellHeight,A()}function A(){const U=z()*w+oe,re=(pr(r.noteRange[1],r.noteRange[0])+1)*b;e.width=U,e.height=re,e.style.width=`${U}px`,e.style.height=`${re}px`,t.width=U,t.height=re,t.style.width=`${U}px`,t.style.height=`${re}px`,n.width=U,n.height=re,n.style.width=`${U}px`,n.style.height=`${re}px`,v.clearRect(0,0,n.width,n.height),N()}function q(I){ks(g,I,oe,e.height)}Ms(s.container,O,D,$);function ae(I){const U=L(r.noteRange[1]),Z=L(I);return U===null||Z===null?(console.warn(`Invalid pitch encountered: ${I}`),0):U-Z}function Ne(I){const U=L(r.noteRange[1]),Z=L(r.noteRange[0]);if(U===null||Z===null)return console.warn(`Invalid pitch range configured: ${r.noteRange}`),"C4";const re=U-I,fi=Math.max(Z,Math.min(U,re));return Me(fi)??"C4"}function V(){const I=document.getElementById("global-mini-contour");I instanceof HTMLCanvasElement&&ne(I,B)}let Q=null;const S={sequencer:s,grid:null,config:r,notes:i,canvas:e,animationCtx:v,getCellHeight:()=>b,getCellWidth:()=>w,getCanvasPos:I=>Is(e,I,o,oe),findNoteAt:(I,U)=>Ps(I,U,i,ae,b,w),scheduleRedraw:N,getPitchFromRow:Ne,getPitchRow:ae,getSnappedBeatFromX:I=>Si(I,r,()=>w),updatePreview:I=>c=I,clearPreview:()=>c=null,getSelectedNote:()=>a,setSelectedNote:I=>{a=I,d=I?[I]:[]},getSelectedNotes:()=>d,setSelectedNotes:I=>{d=I,a=I.length===1?I[0]:null},setHoveredNote:I=>u=I,onNotesChanged:V};function R(I){Q==null||Q.detach(e),Q=I,Q==null||Q.attach(e)}function F(){a=null,d=[],u=null,Ft=[],N()}const W={"note-placement":()=>R(wr(S)),select:()=>R(_r(S)),none:()=>R(null)};let de=Bs(I=>{var U,Z,re;c=null,l=null,Ft=[],(U=S.clearPreview)==null||U.call(S),(Z=S.setPastePreviewNotes)==null||Z.call(S,null),S.selectionBox&&(S.selectionBox.active=!1,S.selectionBox=null),F(),(re=W[I])==null||re.call(W),N()});function Lt(){return a}function si(){return c}function ai(I){return I*w}function ci(I){e.style.cursor=I}function li(){return d}function ui(I){d=I,a=I.length===1?I[0]:null}function di(){de(),qs()}const rr={canvas:e,scheduleRedraw:N,drawPlayhead:q,getSelectedNote:Lt,clearSelection:F,getPreviewNote:si,zoomIn:O,zoomOut:D,getXForBeat:ai,setMouseHandler:R,setCursor:ci,gridContext:S,getSelectedNotes:li,setSelectedNotes:ui,destroy:di,resizeAndRedraw:A},or=ho();let ir=null,sr=null;or==="note-placement"?(ir=wr(S),R(ir)):or==="select"?(sr=_r(S),R(sr)):R(null),S.setPastePreviewNotes=I=>{l=I};let Ft=[];return S.getHighlightedNotes=()=>Ft,S.setHighlightedNotes=I=>{Ft=I},S.grid=rr,rr}const on={sf2:vc()},vo="sf2";async function Sr(e,t,n){const o=e.split("/");if(o.length!==3)throw new Error(`Invalid instrument fullName format: "${e}". Expected format "engine/library/instrument"`);const[i,r,s]=o,c=on[i];if(!c)throw new Error(`Engine "${i}" not available`);return console.log("Calling instrument-loader.ts LoadInstrument with:",e,i,t,n),await c.loadInstrument(`${r}/${s}`,t,n)}async function js(e=vo){const t=on[e];if(!t)throw new Error(`Engine "${e}" not available`);const n=await t.getAvailableLibraries();return console.log("getAvailableLibraries was called!: ",n),n}async function zs(e,t=vo){const n=on[t];if(!n)throw new Error(`Engine "${t}" not available`);return await n.getAvailableInstruments(e)}function Ws(){return Object.keys(on)}function Ks(e,t,{getPitchRow:n,cellWidth:o,cellHeight:i,labelWidth:r}){if(!(e!=null&&e.animationCtx)){console.warn("Missing animationCtx in animateNotePlay");return}const s=t.start*o+r,c=n(t.pitch)*i,l=t.duration*o,u=i-1,a=s+l/2,d=c+u/2,f=(L(t.pitch)||0)*5%360,m=e.animationCtx,y=document.createElement("canvas");y.width=m.canvas.width,y.height=m.canvas.height;let p=y.getContext("2d");if(!p){console.warn("Could not get animation context from offscreen canvas");return}const g=performance.now(),v=He();let w=t.duration*6e4/v;w=Math.max(100,Math.min(w,1600));const b=2,_=50;function E(T){const N=Math.sin(T*Math.PI),M=`hsla(${f}, 100%, 70%, ${.4*N})`;p&&(p.globalAlpha=1,p.fillStyle=M,p.beginPath(),p.roundRect(s,c,l,u,3),p.fill())}function C(T,N,M){const O=Math.sin(T*Math.PI),D=1+N*O,$=(1-T)*M;if(p){p.globalAlpha=$,p.strokeStyle=`hsl(${f}, 100%, 65%)`,p.lineWidth=1.5;const H=l*D,A=u*D;p.beginPath(),p.roundRect(a-H/2,d-A/2,H,A,4),p.stroke()}}function P(T){const N=T-g,M=N/w;if(M>1){p=null,y.width=0,y.height=0;return}if(p){p.clearRect(0,0,y.width,y.height),p.save(),E(M);for(let H=0;H<b;H++){const A=H*_,q=Math.max(0,Math.min(1,(N-A)/(w-A)));C(q,.1+H*.1,.3)}p.restore(),m.save();const O=1.5,D=l*O+8,$=u*O+8;m.clearRect(a-D/2,d-$/2,D,$),m.globalAlpha=1,m.drawImage(y,0,0),m.restore()}requestAnimationFrame(P)}requestAnimationFrame(P)}class wo{constructor(t,n,o=Se(),i=xe(),r="sf2/fluidr3-gm/acoustic_grand_piano"){this.notes=[],this.colorIndex=0,this.id=0,this.mute=!1,this.solo=!1,this.shouldPlay=!0,this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.container=t,this.config={...n},this.context=o,this.destination=i,this.instrumentName=r,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this.animationCanvas=this.container.querySelector(".note-animate-canvas"),this._initCanvases())}async initInstrument(){try{await Sr(this.instrumentName,this.context,this.destination),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){var n;const t=(n=this.container)==null?void 0:n.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument()}playNote(t,n,o=100,i=!1){return Cc(this.instrumentName,t,n,o,i)}_initCanvases(){if(!this.container)return;const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),o=this.container.querySelector("#grid-scroll-container"),i=this.container.querySelector("canvas.note-animate-canvas");this.grid=Gs(t,n,i,o,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(){var s,c,l;const t=z();this.clampNotesToGrid();const n=t*this.config.cellWidth+oe,o=(s=this.container)==null?void 0:s.querySelector("canvas.note-grid"),i=(c=this.container)==null?void 0:c.querySelector(".playhead-canvas"),r=(l=this.container)==null?void 0:l.querySelector(".mini-contour");o&&(o.width=n,o.style.width=`${n}px`),i&&(i.width=n,i.style.width=`${n}px`),r&&Pt(r,this.notes,this.config,this.colorIndex),this.redraw()}clampNotesToGrid(){const t=z(),n=this.notes.filter(o=>o.start<t);n.forEach(o=>{o.start+o.duration>t&&(o.duration=t-o.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear();const n=60/He();this._beatHandler=o=>{var i,r;if((i=this.grid)==null||i.drawPlayhead(this.grid.getXForBeat(o)),!!this.shouldPlay)for(const s of this.notes){const c=s.start,l=s.start+s.duration;if(!this._activeNotes.has(s)&&c<=o&&o<=l){const u=s.duration*n;if(this.playNote(s.pitch,u),(r=this.grid)!=null&&r.gridContext){const a=this.grid.gridContext;Ks(a,s,{getPitchRow:a.getPitchRow,cellWidth:a.getCellWidth(),cellHeight:a.getCellHeight(),labelWidth:oe})}this._activeNotes.add(s)}}},this._unsub=_n(this._beatHandler),this._beatHandler(0)}stop(){var t,n,o;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const i of this._activeNotes){const r=this._noteHandlers.get(i);(t=r==null?void 0:r.forceStop)==null||t.call(r),(n=r==null?void 0:r.stop)==null||n.call(r)}this._activeNotes.clear(),this._noteHandlers.clear(),(o=this.grid)==null||o.drawPlayhead(0),this.redraw()}pause(){var t;for(const n of this._activeNotes){const o=this._noteHandlers.get(n);(t=o==null?void 0:o.stop)==null||t.call(o)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=_n(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.mute=!this.mute,this.mute&&(this.solo=!1),this.updateTrackStyle()}toggleSolo(){this.solo=!this.solo,this.solo&&(this.mute=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t==null||t.classList.toggle("bg-red-600",this.mute),t==null||t.classList.toggle("bg-gray-700",!this.mute),n==null||n.classList.toggle("bg-yellow-200",this.solo),n==null||n.classList.toggle("bg-gray-700",!this.solo),this.container.classList.toggle("opacity-40",this.mute&&!this.solo),this.container.classList.toggle("opacity-100",!(this.mute&&!this.solo))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:o}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),o&&(this.instrumentName=o),this.redraw()}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,o,i])=>({pitch:n,start:o,duration:i})))}async exportToOffline(){const t=60/He(),n=await Sr(this.instrumentName,this.context,this.destination);for(const o of this.notes){const i=o.start*t,r=o.duration*t,s=L(o.pitch);if(s==null)continue;const c=this.instrumentName.split("/");if((c.length>=3?c[1]:c[0])==="drummachines"&&n.__midiMap){const u=n.__midiMap.get(s);u&&n.start({note:u,duration:r,velocity:100,time:i,loop:!1})}else n.start({note:s,duration:r,velocity:100,time:i,loop:!1})}}}let Pe,Je,Eo,_o,$e,le,ye="sf2";function Xs(){Pe=document.getElementById("instrument-select-modal"),Je=document.getElementById("instrument-select"),Eo=document.getElementById("instrument-select-confirm"),_o=document.getElementById("instrument-cancel-btn"),$e=document.getElementById("instrument-engine-select"),le=document.getElementById("instrument-library-select"),Vs(),Ys()}function Vs(){const e=Ws();$e.innerHTML="",e.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t.toUpperCase(),$e.appendChild(n)}),$e.value=ye}function Ys(){$e.addEventListener("change",async()=>{ye=$e.value,await So()}),le.addEventListener("change",()=>{const e=new CustomEvent("instrument-library-change",{detail:{preselect:null}});le.dispatchEvent(e)}),le.addEventListener("instrument-library-change",async e=>{var i;const t=e,n=le.value,o=((i=t.detail)==null?void 0:i.preselect)??null;try{const r=await zs(n,ye);Je.innerHTML="",r.forEach(s=>{const c=document.createElement("option");c.value=`${ye}/${n}/${s}`,c.textContent=s.split("_").map(l=>l?l[0].toUpperCase()+l.slice(1):"").join(" "),Je.appendChild(c)}),o?Je.value=o:r.length>0&&(Je.value=`${ye}/${n}/${r[0]}`)}catch(r){console.error(`Failed to load instruments for library: ${n}`,r)}}),Eo.addEventListener("click",Io),_o.addEventListener("click",Po)}async function So(e=null,t=null){try{const n=await js(ye);le.innerHTML="",n.forEach(i=>{const r=document.createElement("option");r.value=i,r.textContent=i.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase()),le.appendChild(r)}),e&&n.includes(e)?le.value=e:n.length>0&&(le.value=n[0]);const o=new CustomEvent("instrument-library-change",{detail:{preselect:t}});le.dispatchEvent(o)}catch(n){console.error("Failed to refresh libraries for engine:",ye,n)}}async function ko(e,t){const[n,o,i]=e.split("/");ye=n||"sf2",$e.value=ye,t!==void 0?Pe.dataset.currentSequencer=String(t):delete Pe.dataset.currentSequencer,await So(o,e)}async function Io(){const e=Je.value;Pe.classList.add("hidden");const t=Number(Pe.dataset.currentSequencer);if(Pe.dataset.currentSequencer!==void 0&&!isNaN(t)){const n=Zs(t);if(n){G(xi(n.id,e),$i(n.id,n.instrumentName)),n.setInstrument(e);return}console.warn(`Failed to find sequencer with ID ${t}`);return}if(Pe.dataset.currentSequencer===void 0)try{await jo(e)}catch(n){console.error("Failed to load global instrument:",e,n)}}function Po(){Pe.classList.add("hidden")}const B=[],Js=document.getElementById("sequencers-container"),Qs=document.getElementById("sequencer-template"),Mo=document.getElementById("add-sequencer");function Co(e){const n=Qs.content.cloneNode(!0).querySelector(".sequencer");Js.insertBefore(n,Mo);const o=B.length,i={id:o,...J},r=(e==null?void 0:e.instrument)||"sf2/fluidr3-gm/acoustic_grand_piano",s=new wo(n,i,Se(),xe(),r);s.id=o,s.colorIndex=o,s.mute=!1,s.solo=!1,s.shouldPlay=!0;const c=n.querySelector("canvas.mini-contour");e&&s.setState({notes:e.notes,config:{},instrument:e.instrument}),Pt(c,s.notes,s.config,s.colorIndex),s.updateTrackLabel(),s.initInstrument();const l=n.querySelector(".collapse-btn"),u=l.querySelector("use"),a=n.querySelector(".sequencer-body");l.addEventListener("click",()=>{const y=a.classList.toggle("hidden");u.setAttribute("href",y?"#icon-caret-up":"#icon-caret-down"),c.classList.toggle("hidden",!y),Nt(n,!y),y&&Pt(c,s.notes,s.config,s.colorIndex)}),n.querySelector(".delete-btn").addEventListener("click",()=>{const y=document.getElementById("delete-confirm-modal"),p=document.getElementById("delete-confirm"),g=document.getElementById("delete-cancel");y.classList.remove("hidden");const v=()=>{const _=Di(s.id,s.instrumentName,s.notes),E=qi(s.id,s.instrumentName,s.notes);G(_,E),b()},w=()=>{b()},b=()=>{y.classList.add("hidden"),p.removeEventListener("click",v),g.removeEventListener("click",w)};p.addEventListener("click",v),g.addEventListener("click",w)});const h=n.querySelector(".mute-btn"),f=n.querySelector(".solo-btn"),m=n.querySelector(".instrument-select-btn");return h.addEventListener("click",()=>{s.mute=!s.mute,s.mute&&(s.solo=!1,f.classList.remove("bg-yellow-200","hover:bg-yellow-400"),f.classList.add("bg-gray-700","hover:bg-purple-700"),st(f,!1)),st(h,s.mute),kr(),s.seekTo(Yt())}),f.addEventListener("click",()=>{s.solo=!s.solo,s.solo&&(s.mute=!1,st(h,!1)),f.classList.toggle("bg-yellow-200",s.solo),f.classList.toggle("bg-gray-700",!s.solo),f.classList.toggle("hover:bg-yellow-400",s.solo),f.classList.toggle("hover:bg-purple-700",!s.solo),kr(),s.seekTo(Yt())}),m.addEventListener("click",async()=>{const y=s.instrumentName||"sf2/fluidr3-gm/acoustic_grand_piano";await ko(y,s.id),document.getElementById("instrument-select-modal").classList.remove("hidden")}),ua(n),st(h,!1),st(f,!1),f.classList.add("hover:bg-purple-700"),B.push(s),{seq:s,wrapper:n}}function Nt(e,t){var n,o,i,r,s;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-out-btn"))==null||o.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-reset-btn"))==null||i.classList.toggle("hidden",!t),(r=e.querySelector(".zoom-button-divider"))==null||r.classList.toggle("hidden",!t),(s=e.querySelector(".grip-handle"))==null||s.classList.toggle("hidden",!t)}function Te(){return B}function Zs(e){const t=e;return B.find(n=>n.id===t)}function kr(){const e=B.some(t=>t.solo);B.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function st(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function ea(){B.slice().forEach(n=>n.destroy()),B.length=0;const e=it(),t=structuredClone(e);t.sequencers=[],fs(),io(t),Mt(t)}function ta(){document.getElementById("global-mini-contour"),Mo.addEventListener("click",()=>{const e=B.length;G(no(e,"sf2/fluidr3-gm/acoustic_grand_piano"),An(e))})}const na=["Darkroom","Seashell","Cyberpunk","Classic Blue","Midnight"],ra=["Track Color","Pitch Class Contrast","Scriabin","Octave Bands"];function oa(){const e=document.getElementById("grid-color-select"),t=document.getElementById("note-color-select");if(!e||!t)return;for(const o of na){const i=document.createElement("option");i.value=o,i.textContent=o,e.appendChild(i)}for(const o of ra){const i=document.createElement("option");i.value=o,i.textContent=o,t.appendChild(i)}const n=ot();e.value=n.gridColorScheme,t.value=n.noteColorScheme,e.addEventListener("change",o=>{const i=o.target;It({gridColorScheme:i.value}),Te().forEach(r=>{var s;return(s=r.grid)==null?void 0:s.scheduleRedraw()})}),t.addEventListener("change",o=>{const i=o.target;It({noteColorScheme:i.value}),Te().forEach(r=>{var s;return(s=r.grid)==null?void 0:s.scheduleRedraw()})})}function ia(){const e=document.getElementById("userconfig-modal"),t=document.querySelectorAll(".settings-tab"),n=document.querySelectorAll(".settings-section");if(!e)return;function o(){t.forEach(i=>{const r=i.dataset.tab;if(!r)return;const s=document.getElementById(r),c=s!==null&&!s.classList.contains("hidden");i.classList.toggle("text-purple-500",c),i.classList.toggle("opacity-100",c),i.classList.toggle("text-gray-500",!c),i.classList.toggle("opacity-50",!c)})}t.forEach(i=>{i.addEventListener("click",()=>{const r=i.dataset.tab;if(!r)return;n.forEach(c=>c.classList.add("hidden"));const s=document.getElementById(r);s&&s.classList.remove("hidden"),o()})}),o(),Ei(),oa()}let Ir=!1,Ae=!1,Oe=!1;function sa({getSequencers:e,onPlay:t,onStop:n,onPause:o,onResume:i,onDurationChange:r,onSnapChange:s,onToggleLoop:c,onTempoChange:l,onSave:u,onLoad:a,onMeasuresChange:d,onBeatsPerMeasureChange:h}){if(Ir)return;Ir=!0;const f=document.getElementById("play-button"),m=f.querySelector("use"),y=document.getElementById("stop-button"),p=document.getElementById("note-duration"),g=document.getElementById("dotted-note-btn"),v=document.getElementById("triplet-note-btn"),w=document.getElementById("snap-resolution"),b=document.getElementById("loop-toggle"),_=document.getElementById("tempo-input"),E=document.getElementById("save-button"),C=document.getElementById("load-button"),P=document.getElementById("measures-input"),T=document.getElementById("beats-per-measure-input"),N=document.getElementById("config-button"),M=document.getElementById("export-modal"),O=document.getElementById("export-json"),D=document.getElementById("export-wav"),$=document.getElementById("export-midi"),H=document.getElementById("export-cancel");p.value=String(J.currentDuration||1),w.value=String(J.snapResolution||.25);const A=document.getElementById("import-modal"),q=document.getElementById("import-json"),ae=document.getElementById("import-midi"),Ne=document.getElementById("import-cancel"),V=document.getElementById("load-input");C.addEventListener("click",()=>{A==null||A.classList.remove("hidden")}),V&&V.addEventListener("change",S=>{var W;const R=S.target,F=(W=R.files)==null?void 0:W[0];F&&a(F),R.value=""}),q&&q.addEventListener("click",()=>{A==null||A.classList.add("hidden"),V&&(V.setAttribute("accept",".json"),V.click())}),ae&&ae.addEventListener("click",()=>{A==null||A.classList.add("hidden"),V&&(V.setAttribute("accept",".mid,.midi"),V.click())}),Ne&&Ne.addEventListener("click",()=>{A==null||A.classList.add("hidden")}),m.setAttribute("href","#icon-play"),f.addEventListener("click",()=>{!Ae&&!Oe?(Ae=!0,Oe=!1,t(),m.setAttribute("href","#icon-pause")):Ae?(Ae=!1,Oe=!0,o(),m.setAttribute("href","#icon-play")):Oe&&(Ae=!0,Oe=!1,i(),m.setAttribute("href","#icon-pause"))}),y.addEventListener("click",()=>{n(),Ae=!1,Oe=!1,m.setAttribute("href","#icon-play")}),window.addEventListener("keydown",S=>{var W;if(document.querySelector(".ai-modal:not(.hidden)"))return;const F=(W=document.activeElement)==null?void 0:W.tagName;if(!(F==="INPUT"||F==="TEXTAREA")){if(S.code==="Space"){S.preventDefault(),f.click();return}if((S.metaKey||S.ctrlKey)&&(S.key==="z"&&us(),S.key==="y"&&ds()),(S.metaKey||S.ctrlKey)&&S.key.toLowerCase()==="r"){S.preventDefault();return}if(ho()===Ee.NOTE_PLACEMENT){if(Object.prototype.hasOwnProperty.call(cr,S.code)){S.preventDefault();const de=cr[S.code];p.value=String(de),p.dispatchEvent(new Event("change"))}if(S.key==="."){S.preventDefault(),g==null||g.click();return}if(S.key==="/"){S.preventDefault(),v==null||v.click();return}}}}),p.addEventListener("change",S=>{const R=S.target,F=parseFloat(R.value);Q(F),r(F),e().forEach(W=>{const de=W.grid;if(de!=null&&de.getPreviewNote){const Lt=de.getPreviewNote();Lt&&(Lt.duration=F,de.scheduleRedraw())}})});function Q(S){document.querySelectorAll(".note-duration-btn").forEach(F=>{const W=parseFloat(F.dataset.value??"0");F.classList.remove("bg-purple-700","bg-gray-800"),W===S?F.classList.add("bg-purple-700"):F.classList.add("bg-gray-800")})}w.addEventListener("change",S=>{const F=S.target.value;Object.prototype.hasOwnProperty.call(gi,F)&&(J.snapResolution=parseFloat(F),w.value=String(F),s(J.snapResolution))}),b.addEventListener("change",S=>{const R=S.target;c(R.checked)}),_.addEventListener("change",S=>{const R=S.target,F=parseInt(R.value,10);isNaN(F)||l(F)}),E.addEventListener("click",()=>{M?M.classList.remove("hidden"):u("json")}),O&&O.addEventListener("click",()=>{M==null||M.classList.add("hidden"),u==null||u("json")}),D&&D.addEventListener("click",()=>{M==null||M.classList.add("hidden"),u==null||u("wav")}),$&&$.addEventListener("click",()=>{M==null||M.classList.add("hidden"),u==null||u("midi")}),H&&H.addEventListener("click",()=>{M==null||M.classList.add("hidden")}),N==null||N.addEventListener("click",()=>{const S=document.getElementById("userconfig-modal");S==null||S.classList.remove("hidden")}),ia(),P&&(P.value=String(Tt())),T&&(T.value=String(Ct())),P==null||P.addEventListener("change",S=>{const R=S.target,F=parseInt(R.value,10);!isNaN(F)&&F>0&&(d==null||d(F))}),T==null||T.addEventListener("change",S=>{const R=S.target,F=parseInt(R.value,10);!isNaN(F)&&F>0&&(h==null||h(F))}),Q(parseFloat(p.value))}function aa(){Ae=!1,Oe=!1;const e=document.getElementById("play-button"),t=e==null?void 0:e.querySelector("use");t&&t.setAttribute("href","#icon-play")}function ca(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function la(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}function ua(e){const t=e.querySelector(".cursor-grab");if(!t)return;const n=e.querySelector(".sequencer-body");if(!n)return;let o=!1,i=0,r=0;const s=150,c=1e3;t.addEventListener("mousedown",l=>{o=!0,i=l.clientY,r=n.offsetHeight,t.classList.replace("cursor-grab","cursor-grabbing"),document.body.style.userSelect="none"}),window.addEventListener("mousemove",l=>{if(!o)return;const u=l.clientY-i;let a=r+u;a=Math.max(s,Math.min(c,a)),n.style.height=`${a}px`}),window.addEventListener("mouseup",()=>{o&&(o=!1,t.classList.replace("cursor-grabbing","cursor-grab"),document.body.style.userSelect="")})}var da=Object.defineProperty,fa=Object.defineProperties,ha=Object.getOwnPropertyDescriptors,Pr=Object.getOwnPropertySymbols,pa=Object.prototype.hasOwnProperty,ma=Object.prototype.propertyIsEnumerable,To=e=>{throw TypeError(e)},Mr=(e,t,n)=>t in e?da(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,se=(e,t)=>{for(var n in t||(t={}))pa.call(t,n)&&Mr(e,n,t[n]);if(Pr)for(var n of Pr(t))ma.call(t,n)&&Mr(e,n,t[n]);return e},Ce=(e,t)=>fa(e,ha(t)),Yn=(e,t,n)=>t.has(e)||To("Cannot "+n),k=(e,t,n)=>(Yn(e,t,"read from private field"),n?n.call(e):t.get(e)),j=(e,t,n)=>t.has(e)?To("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),x=(e,t,n,o)=>(Yn(e,t,"write to private field"),t.set(e,n),n),jt=(e,t,n)=>(Yn(e,t,"access private method"),n),X=(e,t,n)=>new Promise((o,i)=>{var r=l=>{try{c(n.next(l))}catch(u){i(u)}},s=l=>{try{c(n.throw(l))}catch(u){i(u)}},c=l=>l.done?o(l.value):Promise.resolve(l.value).then(r,s);c((n=n.apply(e,t)).next())});function zt(e){const t=e.filter(n=>!!n);return t.reduce((n,o)=>{const i="output"in n?n.output:n,r="input"in o?o.input:o;return i.connect(r),o}),()=>{t.reduce((n,o)=>{const i="output"in n?n.output:n,r="input"in o?o.input:o;return i.disconnect(r),o})}}function ga(e){let t=e;const n=new Set;function o(s){return n.add(s),s(t),()=>{n.delete(s)}}function i(s){t=s,n.forEach(c=>c(t))}function r(){return t}return{subscribe:o,set:i,get:r}}function ya(){const e=new Set;function t(o){return e.add(o),()=>{e.delete(o)}}function n(o){e.forEach(i=>i(o))}return{subscribe:t,trigger:n}}function ba(e){let t=!1;return()=>{t||(t=!0,e.forEach(n=>n==null?void 0:n()))}}function No(e){return e*e/16129}function va(e){return Math.pow(10,e/20)}var Re,ke,ze,We,Wt,De,qe,Bo=class{constructor(e,t){this.context=e,j(this,Re),j(this,ke),j(this,ze),j(this,We),j(this,Wt),j(this,De),j(this,qe,!1);var n,o,i;x(this,De,{destination:(n=t==null?void 0:t.destination)!=null?n:e.destination,volume:(o=t==null?void 0:t.volume)!=null?o:100,volumeToGain:(i=t==null?void 0:t.volumeToGain)!=null?i:No}),this.input=e.createGain(),x(this,Re,e.createGain()),x(this,We,zt([this.input,k(this,Re),k(this,De).destination]));const r=ga(k(this,De).volume);this.setVolume=r.set,x(this,Wt,r.subscribe(s=>{k(this,Re).gain.value=k(this,De).volumeToGain(s)}))}addInsert(e){var t;if(k(this,qe))throw Error("Can't add insert to disconnected channel");(t=k(this,ze))!=null||x(this,ze,[]),k(this,ze).push(e),k(this,We).call(this),x(this,We,zt([this.input,...k(this,ze),k(this,Re),k(this,De).destination]))}addEffect(e,t,n){var o;if(k(this,qe))throw Error("Can't add effect to disconnected channel");const i=this.context.createGain();i.gain.value=n;const r="input"in t?t.input:t,s=zt([k(this,Re),i,r]);(o=k(this,ke))!=null||x(this,ke,[]),k(this,ke).push({name:e,mix:i,disconnect:s})}sendEffect(e,t){var n;if(k(this,qe))throw Error("Can't send effect to disconnected channel");const o=(n=k(this,ke))==null?void 0:n.find(i=>i.name===e);o?o.mix.gain.value=t:console.warn("Send bus not found: "+e)}disconnect(){var e;k(this,qe)||(x(this,qe,!0),k(this,We).call(this),k(this,Wt).call(this),(e=k(this,ke))==null||e.forEach(t=>t.disconnect()),x(this,ke,void 0))}};Re=new WeakMap;ke=new WeakMap;ze=new WeakMap;We=new WeakMap;Wt=new WeakMap;De=new WeakMap;qe=new WeakMap;var Y,wa=class{constructor(e){this.compare=e,j(this,Y,[])}push(e){const t=k(this,Y).length;let n=0,o=t-1,i=t;for(;n<=o;){const r=Math.floor((n+o)/2);this.compare(e,k(this,Y)[r])<0?(i=r,o=r-1):n=r+1}k(this,Y).splice(i,0,e)}pop(){return k(this,Y).shift()}peek(){return k(this,Y)[0]}removeAll(e){const t=k(this,Y).length;return x(this,Y,k(this,Y).filter(n=>!e(n))),k(this,Y).length!==t}clear(){x(this,Y,[])}size(){return k(this,Y).length}};Y=new WeakMap;function Cr(e,t){return e&&t?n=>{e(n),t(n)}:e??t}function Ea(e){var t,n,o;const i={disableScheduler:(t=e.disableScheduler)!=null?t:!1,scheduleLookaheadMs:(n=e.scheduleLookaheadMs)!=null?n:200,scheduleIntervalMs:(o=e.scheduleIntervalMs)!=null?o:50,onStart:e.onStart,onEnded:e.onEnded};if(i.scheduleLookaheadMs<1)throw Error("scheduleLookaheadMs must be greater than 0");if(i.scheduleIntervalMs<1)throw Error("scheduleIntervalMs must be greater than 0");if(i.scheduleLookaheadMs<i.scheduleIntervalMs)throw Error("scheduleLookaheadMs must be greater than scheduleIntervalMs");return i}var he,ee,Ue,Lo=class{constructor(e,t={}){j(this,he),j(this,ee),j(this,Ue),x(this,he,Ea(t)),x(this,ee,new wa((n,o)=>n.time-o.time)),this.player=e}get context(){return this.player.context}get buffers(){return this.player.buffers}get isRunning(){return k(this,Ue)!==void 0}start(e){var t;if(k(this,he).disableScheduler)return this.player.start(e);const n=this.player.context,o=n.currentTime,i=(t=e.time)!=null?t:o,r=k(this,he).scheduleLookaheadMs/1e3;return e.onStart=Cr(e.onStart,k(this,he).onStart),e.onEnded=Cr(e.onEnded,k(this,he).onEnded),i<o+r?this.player.start(e):(k(this,ee).push(Ce(se({},e),{time:i})),k(this,Ue)||x(this,Ue,setInterval(()=>{const s=n.currentTime+r;for(;k(this,ee).size()&&k(this,ee).peek().time<=s;){const c=k(this,ee).pop();c&&this.player.start(c)}k(this,ee).size()||(clearInterval(k(this,Ue)),x(this,Ue,void 0))},k(this,he).scheduleIntervalMs)),s=>{!s||s<i?k(this,ee).removeAll(c=>c===e)||this.player.stop(Ce(se({},e),{time:s})):this.player.stop(Ce(se({},e),{time:s}))})}stop(e){var t;if(k(this,he).disableScheduler)return this.player.stop(e);if(this.player.stop(e),!e){k(this,ee).clear();return}const n=(t=e==null?void 0:e.time)!=null?t:0,o=e==null?void 0:e.stopId;o?k(this,ee).removeAll(i=>i.time>=n&&i.stopId?i.stopId===o:i.note===o):k(this,ee).removeAll(i=>i.time>=n)}disconnect(){this.player.disconnect()}};he=new WeakMap;ee=new WeakMap;Ue=new WeakMap;var pt,Ke,mt,Fo=class{constructor(e,t){this.context=e,this.options=t,j(this,pt),j(this,Ke,!1),j(this,mt);var n,o;x(this,pt,{velocityToGain:(n=t.velocityToGain)!=null?n:No,destination:(o=t.destination)!=null?o:e.destination}),this.buffers={},x(this,mt,ya())}start(e){var t,n,o,i,r,s,c,l,u,a,d,h,f,m;if(k(this,Ke))throw new Error("Can't start a sample on disconnected player");const y=this.context,p=e.name&&this.buffers[e.name]||this.buffers[e.note];if(!p)return console.warn(`Sample not found: '${e.note}'`),()=>{};const g=y.createBufferSource();g.buffer=p;const v=(n=(t=e.detune)!=null?t:this.options.detune)!=null?n:0;g.detune?g.detune.value=v:g.playbackRate&&(g.playbackRate.value=Math.pow(2,v/1200));const w=(o=e.lpfCutoffHz)!=null?o:this.options.lpfCutoffHz,b=w?y.createBiquadFilter():void 0;w&&b&&(b.type="lowpass",b.frequency.value=w);const _=y.createGain(),E=(r=(i=e.velocity)!=null?i:this.options.velocity)!=null?r:100;_.gain.value=k(this,pt).velocityToGain(E),((s=e.loop)!=null?s:this.options.loop)&&(g.loop=!0,g.loopStart=(c=e.loopStart)!=null?c:0,g.loopEnd=(l=e.loopEnd)!=null?l:p.duration);const P=(u=e.decayTime)!=null?u:this.options.decayTime,[T,N]=_a(y,P);function M(q){if(q??(q=y.currentTime),q<=H)g.stop(q);else{const ae=N(q);g.stop(ae)}}const O=e.gainOffset?y.createGain():void 0;O&&e.gainOffset&&(O.gain.value=e.gainOffset);const D=(a=e.stopId)!=null?a:e.note,$=ba([zt([g,b,_,T,O,k(this,pt).destination]),(d=e.stop)==null?void 0:d.call(e,M),k(this,mt).subscribe(q=>{(!q||q.stopId===void 0||q.stopId===D)&&M(q==null?void 0:q.time)})]);g.onended=()=>{var q;$(),(q=e.onEnded)==null||q.call(e,e)},(h=e.onStart)==null||h.call(e,e);const H=Math.max((f=e.time)!=null?f:0,y.currentTime);g.start(e.time);let A=(m=e.duration)!=null?m:p.duration;return typeof e.duration=="number"&&M(H+A),M}stop(e){k(this,mt).trigger(e)}disconnect(){k(this,Ke)||(x(this,Ke,!0),this.stop(),Object.keys(this.buffers).forEach(e=>{delete this.buffers[e]}))}get connected(){return!k(this,Ke)}};pt=new WeakMap;Ke=new WeakMap;mt=new WeakMap;function _a(e,t=.2){let n=0;const o=e.createGain();o.gain.value=1;function i(r){if(n)return n;o.gain.cancelScheduledValues(r);const s=r||e.currentTime;return n=s+t,o.gain.setValueAtTime(1,s),o.gain.linearRampToValueAtTime(0,n),n}return[o,i]}var sn=class{constructor(e,t){this.context=e;const n=new Bo(e,t);this.player=new Lo(new Fo(e,Ce(se({},t),{destination:n.input})),t),this.output=n}get buffers(){return this.player.buffers}start(e){return this.player.start(e)}stop(e){this.player.stop(typeof e=="object"?e:e!==void 0?{stopId:e}:void 0)}disconnect(){this.output.disconnect(),this.player.disconnect()}};function Jn(e,t,n){return X(this,null,function*(){t=t.replace(/#/g,"%23").replace(/([^:]\/)\/+/g,"$1");const o=yield n.fetch(t);if(o.status!==200){console.warn("Error loading buffer. Invalid status: ",o.status,t);return}try{const i=yield o.arrayBuffer();return yield e.decodeAudioData(i)}catch(i){console.warn("Error loading buffer",i,t)}})}function an(e){if(typeof document>"u")return null;const t=document.createElement("audio");for(let n=0;n<e.length;n++){const o=e[n],i=t.canPlayType(`audio/${o}`);if(i==="probably"||i==="maybe")return o;if(o==="m4a"){const r=t.canPlayType("audio/aac");if(r==="probably"||r==="maybe")return o}}return null}function Sa(){var e;return"."+((e=an(["ogg","m4a"]))!=null?e:"ogg")}var Bt={fetch(e){return fetch(e)}};function Ao(e){return typeof e=="object"&&typeof e.baseUrl=="string"&&typeof e.name=="string"&&Array.isArray(e.samples)&&Array.isArray(e.groupNames)&&typeof e.nameToSampleName=="object"&&typeof e.sampleGroupVariations=="object"}var ka={baseUrl:"",name:"",samples:[],groupNames:[],nameToSampleName:{},sampleGroupVariations:{}};function Ia(e,t){return X(this,null,function*(){var n,o,i,r;const c=yield(yield t.fetch(e)).json();c.baseUrl=e.replace("/dm.json",""),c.groupNames=[],c.nameToSampleName={},c.sampleGroupVariations={};for(const l of c.samples){c.nameToSampleName[l]=l;const u=l.indexOf("/")!==-1?"/":"-",[a,d]=l.split(u);c.groupNames.includes(a)||c.groupNames.push(a),(o=(n=c.nameToSampleName)[a])!=null||(n[a]=l),(r=(i=c.sampleGroupVariations)[a])!=null||(i[a]=[]),d&&c.sampleGroupVariations[a].push(`${a}${u}${d}`)}return c})}function Oo(){return Object.keys(Ro)}var Ro={"TR-808":"https://smpldsnds.github.io/drum-machines/TR-808/dm.json","Casio-RZ1":"https://smpldsnds.github.io/drum-machines/Casio-RZ1/dm.json","LM-2":"https://smpldsnds.github.io/drum-machines/LM-2/dm.json","MFB-512":"https://smpldsnds.github.io/drum-machines/MFB-512/dm.json","Roland CR-8000":"https://smpldsnds.github.io/drum-machines/Roland-CR-8000/dm.json"};function Pa(e){var t,n,o;const i={instrument:(t=e==null?void 0:e.instrument)!=null?t:"TR-808",storage:(n=e==null?void 0:e.storage)!=null?n:Bt,url:(o=e==null?void 0:e.url)!=null?o:""};if(typeof i.instrument=="string"){if(i.url||(i.url=Ro[i.instrument]),!i.url)throw new Error("Invalid instrument: "+i.instrument)}else if(!Ao(i.instrument))throw new Error("Invalid instrument: "+i.instrument);return i}var pe,Ma=class{constructor(e,t){j(this,pe,ka);const n=Pa(t),o=Ao(n.instrument)?Promise.resolve(n.instrument):Ia(n.url,n.storage);this.player=new sn(e,t),this.output=this.player.output,this.load=Ca(e,this.player.buffers,o,n.storage).then(()=>this),o.then(i=>{x(this,pe,i)})}getSampleNames(){return k(this,pe).samples.slice()}getGroupNames(){return k(this,pe).groupNames.slice()}getSampleNamesForGroup(e){var t;return(t=k(this,pe).sampleGroupVariations[e])!=null?t:[]}start(e){var t;const n=k(this,pe).nameToSampleName[e.note];return this.player.start(Ce(se({},e),{note:n||e.note,stopId:(t=e.stopId)!=null?t:e.note}))}stop(e){return this.player.stop(e)}loaded(){return X(this,null,function*(){return console.warn("deprecated: use load instead"),this.load})}get sampleNames(){return console.log("deprecated: Use getGroupNames instead"),k(this,pe).groupNames.slice()}getVariations(e){var t;return console.warn("deprecated: use getSampleNamesForGroup"),(t=k(this,pe).sampleGroupVariations[e])!=null?t:[]}};pe=new WeakMap;function Ca(e,t,n,o){var i;const r=(i=an(["ogg","m4a"]))!=null?i:"ogg";return n.then(s=>Promise.all(s.samples.map(c=>X(this,null,function*(){const l=`${s.baseUrl}/${c}.${r}`,u=yield Jn(e,l,o);u&&(t[c]=u)}))))}function Ta(e){const n=/^([a-gA-G]?)(#{1,}|b{1,}|)(-?\d+)$/.exec(e);if(!n)return;const o=n[1].toUpperCase();if(!o)return;const i=n[2],r=i[0]==="b"?-i.length:i.length,s=n[3]?+n[3]:4,c=(o.charCodeAt(0)+3)%7;return[0,2,4,5,7,9,11][c]+r+12*(s+1)}function _e(e){return e===void 0?void 0:typeof e=="number"?e:Ta(e)}function Na(e={}){return{groups:[],options:e}}function Qn(){return{regions:[]}}function Do(e,t,n,o){const i=[],r=_e(t.note);if(r===void 0)return i;for(const s of e.regions){const c=qo(r,n??0,t,s,o);c&&i.push(c)}return i}function Ba(e,t,n,o){const i=_e(t.note);if(i!==void 0)for(const r of e.regions){const s=qo(i,0,t,r,o);if(s)return s}}function qo(e,t,n,o,i){var r,s,c,l,u,a,d,h,f,m,y,p,g,v,w,b,_,E,C,P,T,N,M,O,D,$,H,A;if(!(e>=((r=o.midiLow)!=null?r:0)&&e<((s=o.midiHigh)!=null?s:127)+1)||!(n.velocity===void 0||n.velocity>=((c=o.velLow)!=null?c:0)&&n.velocity<=((l=o.velHigh)!=null?l:127)))return;if(o.seqLength){const F=t%o.seqLength,W=((u=o.seqPosition)!=null?u:1)-1;if(F!==W)return}const Ne=e-o.midiPitch,V=(a=n.velocity)!=null?a:i==null?void 0:i.velocity,Q=o.volume?va(o.volume):0,S=(h=(d=n.gainOffset)!=null?d:void 0)!=null?h:0,R=(f=n.detune)!=null?f:0;return{decayTime:(p=(y=n==null?void 0:n.decayTime)!=null?y:(m=o.sample)==null?void 0:m.decayTime)!=null?p:i==null?void 0:i.decayTime,detune:100*(Ne+((g=o.tune)!=null?g:0))+R,duration:(b=(w=n==null?void 0:n.duration)!=null?w:(v=o.sample)==null?void 0:v.duration)!=null?b:i==null?void 0:i.duration,gainOffset:S+Q||void 0,loop:(C=(E=n==null?void 0:n.loop)!=null?E:(_=o.sample)==null?void 0:_.loop)!=null?C:i==null?void 0:i.loop,loopEnd:(N=(T=n==null?void 0:n.loopEnd)!=null?T:(P=o.sample)==null?void 0:P.loopEnd)!=null?N:i==null?void 0:i.loopEnd,loopStart:(D=(O=n==null?void 0:n.loopStart)!=null?O:(M=o.sample)==null?void 0:M.loopStart)!=null?D:i==null?void 0:i.loopStart,lpfCutoffHz:(A=(H=n==null?void 0:n.lpfCutoffHz)!=null?H:($=o.sample)==null?void 0:$.lpfCutoffHz)!=null?A:i==null?void 0:i.lpfCutoffHz,name:o.sampleName,note:e,onEnded:n.onEnded,onStart:n.onStart,stopId:n.name,time:n.time,velocity:V??void 0}}function La(e){if(e.length===0)return[];if(e.sort((t,n)=>t.midiPitch-n.midiPitch),e[0].midiLow=0,e[0].midiHigh=127,e.length===1)return e;for(let t=1;t<e.length;t++){const n=e[t-1],o=e[t],i=Math.floor((n.midiPitch+o.midiPitch)/2);n.midiHigh=i,o.midiLow=i+1}return e[e.length-1].midiHigh=127,e}var Fa=class{constructor(e,t){this.context=e,this.seqNum=0;const n=new Bo(e,t);this.instrument=Na(t),this.player=new Lo(new Fo(e,Ce(se({},t),{destination:n.input})),t),this.output=n}get buffers(){return this.player.buffers}start(e){const t=[],n=typeof e=="object"?e:{note:e};for(const o of this.instrument.groups){const i=Do(o,n,this.seqNum);this.seqNum++;for(const r of i){let s=this.player.start(r);t.push(s)}}return o=>t.forEach(i=>i(o))}stop(e){if(e==null){this.player.stop();return}const t=typeof e=="object"?e:{stopId:e},n=_e(t.stopId);n&&(t.stopId=n,this.player.stop(t))}disconnect(){this.output.disconnect(),this.player.disconnect()}};function Uo(e,t){const n=Sa();return(o,i)=>X(this,null,function*(){const r=yield fetch(e).then(l=>l.text()),s=Aa(r,t.group);s.length&&console.warn("Problems converting sfz",s);const c=new Set;return t.group.regions.forEach(l=>c.add(l.sampleName)),Promise.all(Array.from(c).map(l=>X(this,null,function*(){const u=t.urlFromSampleName(l,n),a=yield Jn(o,u,i);t.buffers[l]=a}))).then(()=>t.group)})}function Aa(e,t){let n="global";const o=e.split(`
`).map(Ua).filter(s=>!!s),i=new xa;let r=[];for(const s of o)switch(s.type){case"mode":r.push(i.closeScope(n,t)),n=s.value;break;case"prop:num":case"prop:str":case"prop:num_arr":i.push(s.key,s.value);break;case"unknown":console.warn("Unknown SFZ token",s.value);break}return r.filter(s=>!!s)}var Oa=/^<([^>]+)>$/,Ra=/^([^=]+)=([-\.\d]+)$/,Da=/^([^=]+)=(.+)$/,qa=/^([^=]+)_(\d+)=(\d+)$/;function Ua(e){if(e=e.trim(),e===""||e.startsWith("//"))return;const t=e.match(Oa);if(t)return{type:"mode",value:t[1]};const n=e.match(qa);if(n)return{type:"prop:num_arr",key:n[1],value:[Number(n[2]),Number(n[3])]};const o=e.match(Ra);if(o)return{type:"prop:num",key:o[1],value:Number(o[2])};const i=e.match(Da);return i?{type:"prop:str",key:i[1],value:i[2]}:{type:"unknown",value:e}}var gt,Kt,xa=class{constructor(){j(this,gt),this.values={},this.global={},this.group={}}closeScope(e,t){if(e==="global")jt(this,gt,Kt).call(this,this.global);else if(e==="group")this.group=jt(this,gt,Kt).call(this,{});else if(e==="region"){const n=jt(this,gt,Kt).call(this,se(se({sampleName:"",midiPitch:-1},this.global),this.group));if(n.sampleName==="")return"Missing sample name";if(n.midiPitch===-1)if(n.midiLow!==void 0)n.midiPitch=n.midiLow;else return"Missing pitch_keycenter";n.seqLength&&n.seqPosition===void 0&&(n.seqPosition=1),n.ampRelease&&(n.sample={decayTime:n.ampRelease},delete n.ampRelease),t.regions.push(n)}}get empty(){return Object.keys(this.values).length===0}get keys(){return Object.keys(this.values)}push(e,t){this.values[e]=t}popNum(e,t,n){return typeof this.values[e]!="number"?!1:(t[n]=this.values[e],delete this.values[e],!0)}popStr(e,t,n){return typeof this.values[e]!="string"?!1:(t[n]=this.values[e],delete this.values[e],!0)}popNumArr(e,t,n){return Array.isArray(this.values[e])?(t[n]=this.values[e],delete this.values[e],!0):!1}};gt=new WeakSet;Kt=function(e){return this.popStr("sample",e,"sampleName"),this.popNum("pitch_keycenter",e,"midiPitch"),this.popNum("ampeg_attack",e,"ampAttack"),this.popNum("ampeg_release",e,"ampRelease"),this.popNum("bend_down",e,"bendDown"),this.popNum("bend_up",e,"bendUp"),this.popNum("group",e,"group"),this.popNum("hikey",e,"midiHigh"),this.popNum("hivel",e,"velHigh"),this.popNum("lokey",e,"midiLow"),this.popNum("offset",e,"offset"),this.popNum("lovel",e,"velLow"),this.popNum("off_by",e,"groupOffBy"),this.popNum("pitch_keytrack",e,"ignore"),this.popNum("seq_length",e,"seqLength"),this.popNum("seq_position",e,"seqPosition"),this.popNum("tune",e,"tune"),this.popNum("volume",e,"volume"),this.popNumArr("amp_velcurve",e,"ampVelCurve"),this.values={},e};var $a="https://smpldsnds.github.io/sgossner-vcsl/";function Ha(e){return $a+e+".sfz"}function Ga(e,t){const n=Ha(e),i=`https://smpldsnds.github.io/sgossner-vcsl/${e.slice(0,e.lastIndexOf("/")+1)}`,r=Qn();return Uo(n,{buffers:t,group:r,urlFromSampleName:(s,c)=>i+"/"+s.replace(".wav",c)})}var ja=class{constructor(e,t={}){var n,o;this.config={instrument:(n=t.instrument)!=null?n:"Arco",storage:(o=t.storage)!=null?o:Bt},this.player=new Fa(e,t);const i=Ga(this.config.instrument,this.player.buffers);this.load=i(e,this.config.storage).then(r=>(this.player.instrument.groups.push(r),this))}get output(){return this.player.output}get buffers(){return this.player.buffers}get context(){return this.player.context}start(e){return this.player.start(e)}stop(e){return this.player.stop(e)}disconnect(){this.player.disconnect()}};function za(){return Object.keys(xo)}var Wa=class extends ja{constructor(e,t){var n;super(e,Ce(se({},t),{instrument:xo[(n=t.instrument)!=null?n:""]}))}},xo={"Balafon - Hard Mallet":"Idiophones/Struck Idiophones/Balafon - Hard Mallet","Balafon - Keyswitch":"Idiophones/Struck Idiophones/Balafon - Keyswitch","Balafon - Soft Mallet":"Idiophones/Struck Idiophones/Balafon - Soft Mallet","Balafon - Traditional Mallet":"Idiophones/Struck Idiophones/Balafon - Traditional Mallet","Tubular Bells 1":"Idiophones/Struck Idiophones/Tubular Bells 1","Tubular Bells 2":"Idiophones/Struck Idiophones/Tubular Bells 2","Vibraphone - Bowed":"Idiophones/Struck Idiophones/Vibraphone - Bowed","Vibraphone - Hard Mallets":"Idiophones/Struck Idiophones/Vibraphone - Hard Mallets","Vibraphone - Keyswitch":"Idiophones/Struck Idiophones/Vibraphone - Keyswitch","Vibraphone - Soft Mallets":"Idiophones/Struck Idiophones/Vibraphone - Soft Mallets","Xylophone - Hard Mallets":"Idiophones/Struck Idiophones/Xylophone - Hard Mallets","Xylophone - Keyswitch":"Idiophones/Struck Idiophones/Xylophone - Keyswitch","Xylophone - Medium Mallets":"Idiophones/Struck Idiophones/Xylophone - Medium Mallets","Xylophone - Soft Mallets":"Idiophones/Struck Idiophones/Xylophone - Soft Mallets"};function Ka(){return["Pizzicato","Arco","Switched"]}function Xa(e){return`https://smpldsnds.github.io/sfzinstruments-dsmolken-double-bass/d_smolken_rubner_bass_${{Arco:"arco",Pizzicato:"pizz",Switched:"switched"}[e]}.sfz`}var Va=class{constructor(e,t={}){this.seqNum=0;var n,o;this.config={instrument:(n=t.instrument)!=null?n:"Arco",storage:(o=t.storage)!=null?o:Bt},this.player=new sn(e,t),this.group=Qn();const i=Xa(this.config.instrument),r=Uo(i,{buffers:this.player.buffers,group:this.group,urlFromSampleName:(s,c)=>`https://smpldsnds.github.io/sfzinstruments-dsmolken-double-bass/${s.replace("\\","/").replace(".wav",c)}`});this.load=r(e,this.config.storage).then(()=>this)}get output(){return this.player.output}get buffers(){return this.player.buffers}get context(){return this.player.context}start(e){const t=Do(this.group,typeof e=="object"?e:{note:e},this.seqNum);this.seqNum++;const n=t.map(o=>this.player.start(o));return o=>n.forEach(i=>i(o))}stop(e){if(e==null){this.player.stop();return}const t=typeof e=="object"?e:{stopId:e},n=_e(t.stopId);n&&(t.stopId=n,this.player.stop(t))}disconnect(){this.player.disconnect()}};function Ya(e,t){var n;const o=(n=an(["ogg","mp3"]))!=null?n:"mp3";return`https://gleitz.github.io/midi-js-soundfonts/${t}/${e}-${o}.js`}function Ja(e,t,n){return(o,i)=>X(this,null,function*(){const r=yield(yield i.fetch(e)).text(),s=Qa(r),c=Object.keys(s);yield Promise.all(c.map(l=>X(this,null,function*(){const u=_e(l);if(!u)return;const a=ec(Za(s[l])),d=yield o.decodeAudioData(a);t[l]=d,n.regions.push({sampleName:l,midiPitch:u})}))),La(n.regions)})}function Qa(e){const t=e.indexOf("MIDI.Soundfont.");if(t<0)throw Error("Invalid MIDI.js Soundfont format");const n=e.indexOf("=",t)+2,o=e.lastIndexOf(",");return JSON.parse(e.slice(n,o)+"}")}function Za(e){return e.slice(e.indexOf(",")+1)}function ec(e){const t=window.atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o.buffer}var tc=["MusyngKite","FluidR3_GM"],nc=["accordion","acoustic_bass","acoustic_grand_piano","acoustic_guitar_nylon","acoustic_guitar_steel","agogo","alto_sax","applause","bagpipe","banjo","baritone_sax","bassoon","bird_tweet","blown_bottle","brass_section","breath_noise","bright_acoustic_piano","celesta","cello","choir_aahs","church_organ","clarinet","clavinet","contrabass","distortion_guitar","drawbar_organ","dulcimer","electric_bass_finger","electric_bass_pick","electric_grand_piano","electric_guitar_clean","electric_guitar_jazz","electric_guitar_muted","electric_piano_1","electric_piano_2","english_horn","fiddle","flute","french_horn","fretless_bass","fx_1_rain","fx_2_soundtrack","fx_3_crystal","fx_4_atmosphere","fx_5_brightness","fx_6_goblins","fx_7_echoes","fx_8_scifi","glockenspiel","guitar_fret_noise","guitar_harmonics","gunshot","harmonica","harpsichord","helicopter","honkytonk_piano","kalimba","koto","lead_1_square","lead_2_sawtooth","lead_3_calliope","lead_4_chiff","lead_5_charang","lead_6_voice","lead_7_fifths","lead_8_bass__lead","marimba","melodic_tom","music_box","muted_trumpet","oboe","ocarina","orchestra_hit","orchestral_harp","overdriven_guitar","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep","pan_flute","percussive_organ","piccolo","pizzicato_strings","recorder","reed_organ","reverse_cymbal","rock_organ","seashore","shakuhachi","shamisen","shanai","sitar","slap_bass_1","slap_bass_2","soprano_sax","steel_drums","string_ensemble_1","string_ensemble_2","synth_bass_1","synth_bass_2","synth_brass_1","synth_brass_2","synth_choir","synth_drum","synth_strings_1","synth_strings_2","taiko_drum","tango_accordion","telephone_ring","tenor_sax","timpani","tinkle_bell","tremolo_strings","trombone","trumpet","tuba","tubular_bells","vibraphone","viola","violin","voice_oohs","whistle","woodblock","xylophone"];function rc(e,t){if(!e.startsWith("http"))return`https://goldst.dev/midi-js-soundfonts/${t}/${e}-loop.json`}function oc(e,t=44100){return X(this,null,function*(){if(e)try{const n=yield fetch(e);if(n.status!==200)return;const o=yield n.json(),i={};return Object.keys(o).forEach(r=>{const s=_e(r);if(s){const c=o[r];i[s]=[c[0]/t,c[1]/t]}}),i}catch{return}})}function ic(){return tc}function sc(){return nc}var yt,ac=class{constructor(e,t){this.context=e,j(this,yt),this.config=lc(t),this.player=new sn(e,t),this.group=Qn(),x(this,yt,!1);const n=cc(this.config.instrumentUrl,this.config.loopDataUrl,this.player.buffers,this.group);this.load=n(e,this.config.storage).then(i=>(x(this,yt,i),this));const o=e.createGain();o.gain.value=this.config.extraGain,this.player.output.addInsert(o)}get output(){return this.player.output}get hasLoops(){return k(this,yt)}loaded(){return X(this,null,function*(){return console.warn("deprecated: use load instead"),this.load})}disconnect(){this.player.disconnect()}start(e){const t=Ba(this.group,typeof e=="object"?e:{note:e});return t?this.player.start(t):()=>{}}stop(e){return this.player.stop(e)}};yt=new WeakMap;function cc(e,t,n,o){const i=Ja(e,n,o);return(r,s)=>X(this,null,function*(){const[c,l]=yield Promise.all([i(r,s),oc(t)]);return l&&o.regions.forEach(u=>{var a;const d=l[u.midiPitch];d&&((a=u.sample)!=null||(u.sample={}),u.sample.loop=!0,u.sample.loopStart=d[0],u.sample.loopEnd=d[1])}),!!l})}function lc(e){var t,n,o,i;if(!e.instrument&&!e.instrumentUrl)throw Error("Soundfont: instrument or instrumentUrl is required");const r={kit:"MusyngKite",instrument:e.instrument,storage:(t=e.storage)!=null?t:Bt,extraGain:(n=e.extraGain)!=null?n:5,loadLoopData:(o=e.loadLoopData)!=null?o:!1,loopDataUrl:e.loopDataUrl,instrumentUrl:(i=e.instrumentUrl)!=null?i:""};if(r.instrument&&r.instrument.startsWith("http")&&(console.warn("Use 'instrumentUrl' instead of 'instrument' to load from a URL"),r.instrumentUrl=r.instrument,r.instrument=void 0),r.instrumentUrl)(r.kit||r.instrument)&&console.warn("Soundfont: 'kit' and 'instrument' config parameters are ignored because 'instrumentUrl' is explicitly set.");else if(r.instrument)r.instrumentUrl=Ya(r.instrument,r.kit);else throw Error("Soundfont: 'instrument' or 'instrumentUrl' configuration parameter is required");return r.loadLoopData&&r.instrument&&!r.loopDataUrl&&(r.loopDataUrl=rc(r.instrument,r.kit)),r}var uc="https://danigb.github.io/samples/splendid-grand-piano",Pn,$o,dc=class{constructor(e,t){this.context=e,j(this,Pn),this.options=Object.assign({baseUrl:uc,storage:Bt,detune:0,volume:100,velocity:100,decayTime:.5},t),this.player=new sn(e,this.options);const n=hc(this.options.baseUrl,this.options.storage,this.options.notesToLoad);this.load=n(e,this.player.buffers).then(()=>this)}get output(){return this.player.output}get buffers(){return this.player.buffers}loaded(){return X(this,null,function*(){return console.warn("deprecated: use load instead"),this.load})}start(e){var t,n;const o=typeof e=="object"?se({},e):{note:e},i=jt(this,Pn,$o).call(this,o);return i?(o.note=i[0],o.stopId=(t=o.stopId)!=null?t:i[1],o.detune=i[2]+((n=o.detune)!=null?n:this.options.detune),this.player.start(o)):()=>{}}stop(e){var t;if(typeof e=="string")return this.player.stop((t=_e(e))!=null?t:e);if(typeof e=="object"){const n=_e(e.stopId);return this.player.stop(n!==void 0?Ce(se({},e),{stopId:n}):e)}else return this.player.stop(e)}};Pn=new WeakSet;$o=function(e){var t;const n=_e(e.note);if(!n)return;const o=(t=e.velocity)!=null?t:this.options.velocity,i=Zt.findIndex(s=>o>=s.vel_range[0]&&o<=s.vel_range[1]),r=Zt[i];if(r)return fc(r.name,n,this.player.buffers)};function fc(e,t,n){let o=0;for(;n[e+(t+o)]===void 0&&o<128;)o>0?o=-o:o=-o+1;return o===127?[e+t,t,0]:[e+(t+o),t,-o*100]}function hc(e,t,n){var o;const i=(o=an(["ogg","m4a"]))!=null?o:"ogg";let r=n?Zt.filter(s=>s.vel_range[0]<=n.velocityRange[1]&&s.vel_range[1]>=n.velocityRange[0]):Zt;return(s,c)=>X(this,null,function*(){for(const l of r){const u=n?l.samples.filter(a=>n.notes.includes(a[0])):l.samples;yield Promise.all(u.map(a=>X(this,[a],function*([d,h]){const f=`${e}/${h}.${i}`,m=yield Jn(s,f,t);m&&(c[l.name+d]=m)})))}})}var Zt=[{name:"PPP",vel_range:[1,40],cutoff:1e3,samples:[[23,"PP-B-1"],[27,"PP-D#0"],[29,"PP-F0"],[31,"PP-G0"],[33,"PP-A0"],[35,"PP-B0"],[37,"PP-C#1"],[38,"PP-D1"],[40,"PP-E1"],[41,"PP-F1"],[43,"PP-G1"],[45,"PP-A1"],[47,"PP-B1"],[48,"PP-C2"],[50,"PP-D2"],[52,"PP-E2"],[53,"PP-F2"],[55,"PP-G2"],[56,"PP-G#2"],[57,"PP-A2"],[58,"PP-A#2"],[59,"PP-B2"],[60,"PP-C3"],[62,"PP-D3"],[64,"PP-E3"],[65,"PP-F3"],[67,"PP-G3"],[69,"PP-A3"],[71,"PP-B3"],[72,"PP-C4"],[74,"PP-D4"],[76,"PP-E4"],[77,"PP-F4"],[79,"PP-G4"],[80,"PP-G#4"],[81,"PP-A4"],[82,"PP-A#4"],[83,"PP-B4"],[85,"PP-C#5"],[86,"PP-D5"],[87,"PP-D#5"],[89,"PP-F5"],[90,"PP-F#5"],[91,"PP-G5"],[92,"PP-G#5"],[93,"PP-A5"],[94,"PP-A#5"],[95,"PP-B5"],[96,"PP-C6"],[97,"PP-C#6"],[98,"PP-D6"],[99,"PP-D#6"],[100,"PP-E6"],[101,"PP-F6"],[102,"PP-F#6"],[103,"PP-G6"],[104,"PP-G#6"],[105,"PP-A6"],[106,"PP-A#6"],[107,"PP-B6"],[108,"PP-C7"]]},{name:"PP",vel_range:[41,67],samples:[[23,"PP-B-1"],[27,"PP-D#0"],[29,"PP-F0"],[31,"PP-G0"],[33,"PP-A0"],[35,"PP-B0"],[37,"PP-C#1"],[38,"PP-D1"],[40,"PP-E1"],[41,"PP-F1"],[43,"PP-G1"],[45,"PP-A1"],[47,"PP-B1"],[48,"PP-C2"],[50,"PP-D2"],[52,"PP-E2"],[53,"PP-F2"],[55,"PP-G2"],[56,"PP-G#2"],[57,"PP-A2"],[58,"PP-A#2"],[59,"PP-B2"],[60,"PP-C3"],[62,"PP-D3"],[64,"PP-E3"],[65,"PP-F3"],[67,"PP-G3"],[69,"PP-A3"],[71,"PP-B3"],[72,"PP-C4"],[74,"PP-D4"],[76,"PP-E4"],[77,"PP-F4"],[79,"PP-G4"],[80,"PP-G#4"],[81,"PP-A4"],[82,"PP-A#4"],[83,"PP-B4"],[85,"PP-C#5"],[86,"PP-D5"],[87,"PP-D#5"],[89,"PP-F5"],[90,"PP-F#5"],[91,"PP-G5"],[92,"PP-G#5"],[93,"PP-A5"],[94,"PP-A#5"],[95,"PP-B5"],[96,"PP-C6"],[97,"PP-C#6"],[98,"PP-D6"],[99,"PP-D#6"],[100,"PP-E6"],[101,"PP-F6"],[102,"PP-F#6"],[103,"PP-G6"],[104,"PP-G#6"],[105,"PP-A6"],[106,"PP-A#6"],[107,"PP-B6"],[108,"PP-C7"]]},{name:"MP",vel_range:[68,84],samples:[[23,"Mp-B-1"],[27,"Mp-D#0"],[29,"Mp-F0"],[31,"Mp-G0"],[33,"Mp-A0"],[35,"Mp-B0"],[37,"Mp-C#1"],[38,"Mp-D1"],[40,"Mp-E1"],[41,"Mp-F1"],[43,"Mp-G1"],[45,"Mp-A1"],[47,"Mp-B1"],[48,"Mp-C2"],[50,"Mp-D2"],[52,"Mp-E2"],[53,"Mp-F2"],[55,"Mp-G2"],[56,"Mp-G#2"],[57,"Mp-A2"],[58,"Mp-A#2"],[59,"Mp-B2"],[60,"Mp-C3"],[62,"Mp-D3"],[64,"Mp-E3"],[65,"Mp-F3"],[67,"Mp-G3"],[69,"Mp-A3"],[71,"Mp-B3"],[72,"Mp-C4"],[74,"Mp-D4"],[76,"Mp-E4"],[77,"Mp-F4"],[79,"Mp-G4"],[80,"Mp-G#4"],[81,"Mp-A4"],[82,"Mp-A#4"],[83,"Mp-B4"],[85,"Mp-C#5"],[86,"Mp-D5"],[87,"Mp-D#5"],[88,"Mp-E5"],[89,"Mp-F5"],[90,"Mp-F#5"],[91,"Mp-G5"],[92,"Mp-G#5"],[93,"Mp-A5"],[94,"Mp-A#5"],[95,"Mp-B5"],[96,"Mp-C6"],[97,"Mp-C#6"],[98,"Mp-D6"],[99,"Mp-D#6"],[100,"PP-E6"],[101,"Mp-F6"],[102,"Mp-F#6"],[103,"Mp-G6"],[104,"Mp-G#6"],[105,"Mp-A6"],[106,"Mp-A#6"],[107,"PP-B6"],[108,"PP-C7"]]},{name:"MF",vel_range:[85,100],samples:[[23,"Mf-B-1"],[27,"Mf-D#0"],[29,"Mf-F0"],[31,"Mf-G0"],[33,"Mf-A0"],[35,"Mf-B0"],[37,"Mf-C#1"],[38,"Mf-D1"],[40,"Mf-E1"],[41,"Mf-F1"],[43,"Mf-G1"],[45,"Mf-A1"],[47,"Mf-B1"],[48,"Mf-C2"],[50,"Mf-D2"],[52,"Mf-E2"],[53,"Mf-F2"],[55,"Mf-G2"],[56,"Mf-G#2"],[57,"Mf-A2"],[58,"Mf-A#2"],[59,"Mf-B2"],[60,"Mf-C3"],[62,"Mf-D3"],[64,"Mf-E3"],[65,"Mf-F3"],[67,"Mf-G3"],[69,"Mf-A3"],[71,"Mf-B3"],[72,"Mf-C4"],[74,"Mf-D4"],[76,"Mf-E4"],[77,"Mf-F4"],[79,"Mf-G4"],[80,"Mf-G#4"],[81,"Mf-A4"],[82,"Mf-A#4"],[83,"Mf-B4"],[85,"Mf-C#5"],[86,"Mf-D5"],[87,"Mf-D#5"],[88,"Mf-E5"],[89,"Mf-F5"],[90,"Mf-F#5"],[91,"Mf-G5"],[92,"Mf-G#5"],[93,"Mf-A5"],[94,"Mf-A#5"],[95,"Mf-B5"],[96,"Mf-C6"],[97,"Mf-C#6"],[98,"Mf-D6"],[99,"Mf-D#6"],[100,"Mf-E6"],[101,"Mf-F6"],[102,"Mf-F#6"],[103,"Mf-G6"],[104,"Mf-G#6"],[105,"Mf-A6"],[106,"Mf-A#6"],[107,"Mf-B6"],[108,"PP-C7"]]},{name:"FF",vel_range:[101,127],samples:[[23,"FF-B-1"],[27,"FF-D#0"],[29,"FF-F0"],[31,"FF-G0"],[33,"FF-A0"],[35,"FF-B0"],[37,"FF-C#1"],[38,"FF-D1"],[40,"FF-E1"],[41,"FF-F1"],[43,"FF-G1"],[45,"FF-A1"],[47,"FF-B1"],[48,"FF-C2"],[50,"FF-D2"],[52,"FF-E2"],[53,"FF-F2"],[55,"FF-G2"],[56,"FF-G#2"],[57,"FF-A2"],[58,"FF-A#2"],[59,"FF-B2"],[60,"FF-C3"],[62,"FF-D3"],[64,"FF-E3"],[65,"FF-F3"],[67,"FF-G3"],[69,"FF-A3"],[71,"FF-B3"],[72,"FF-C4"],[74,"FF-D4"],[76,"FF-E4"],[77,"FF-F4"],[79,"FF-G4"],[80,"FF-G#4"],[81,"FF-A4"],[82,"FF-A#4"],[83,"FF-B4"],[85,"FF-C#5"],[86,"FF-D5"],[88,"FF-E5"],[89,"FF-F5"],[91,"FF-G5"],[93,"FF-A5"],[95,"Mf-B5"],[96,"Mf-C6"],[97,"Mf-C#6"],[98,"Mf-D6"],[99,"Mf-D#6"],[100,"Mf-E6"],[102,"Mf-F#6"],[103,"Mf-G6"],[104,"Mf-G#6"],[105,"Mf-A6"],[106,"Mf-A#6"],[107,"Mf-B6"],[108,"Mf-C7"]]}];let Et=0;const hn=new Map;async function cn(e,t=Se(),n=null){var d;const o=e.split("/");let i="sf2",r="musyngkite",s="acoustic_grand_piano";o.length===3?[i,r,s]=o:o.length===2?[r,s]=o:o.length===1&&(s=o[0]);const c=t instanceof OfflineAudioContext;hn.has(t)||hn.set(t,new Map);const l=hn.get(t),u=`${r}/${s}`;if(l.has(u))return l.get(u);let a;if(r==="smolken")a=new Va(t,{instrument:s,destination:n||xe(),disableScheduler:c}),await at(a.load);else if(r==="splendidgrandpiano")a=new dc(t,{destination:n||xe(),disableScheduler:c}),await at(a.load);else if(r==="mallets")a=new Wa(t,{instrument:s,destination:n||xe(),disableScheduler:c}),await at(a.load);else if(r==="drummachines"){a=new Ma(t,{instrument:s,destination:n||xe(),disableScheduler:c}),await at(a.load);const h=((d=a.getSampleNames)==null?void 0:d.call(a))??[],f=new Map;h.forEach((m,y)=>{const p=36+y;f.set(p,m)}),a.__midiMap=f}else{const f={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[r.toLowerCase()]||"MusyngKite",m=await Ho();console.log(`[SF2] Available kits: ${m.join(", ")}`),console.log(`[SF2] Loading from kit=${f}, instrument=${s}`);const p=`https://gleitz.github.io/midi-js-soundfonts/${f}/${s}-ogg.js`;a=new ac(t,{instrument:s,instrumentUrl:p,kit:f,destination:n||xe(),disableScheduler:c}),await at(a.load)}return l.set(u,a),a}async function pc(){console.log("[SF2] Getting available libraries");const e=Ho();console.log("[SF2] Available kits:",e);const t=e.map(o=>{switch(o){case"FluidR3_GM":return"fluidr3-gm";case"FatBoy":return"fatboy";case"MusyngKite":return"musyngkite";default:return o.toLowerCase()}}),n=["splendidgrandpiano","mallets","drummachines","smolken"];return[...new Set([...t,...n])]}function Ho(){const t=[...ic()];return t.includes("FatBoy")||t.push("FatBoy"),t}async function mc(e){console.log(`[SF2] Getting available instruments for library: ${e}`);const t=e.toLowerCase();if(t==="splendidgrandpiano")return["splendidgrandpiano"];if(t==="mallets")return za();if(t==="drummachines")return Oo();if(t==="smolken")return Ka();await cn(`${e}/acoustic_grand_piano`);const o=sc();return console.log(`[SF2] Instruments in library "${e}":`,o),o??[]}function gc(){return Oo()}function yc(){Et++,Et===1&&ca()}function bc(){Et--,Et<=0&&(Et=0,la())}async function at(e){yc();try{await e}finally{bc()}}function vc(){return{name:"sf2",loadInstrument:cn,getAvailableLibraries:pc,getAvailableInstruments:mc}}let ce=null,Mn=null;async function wc(e){if(Mn===e)return;ce=await cn(e),Mn=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function Ec(){return Mn}function _c(e,t=100,n=!1){var c;if(!ce)return null;const i=Se().currentTime,r=L(e);if(r===null)return null;const s=((c=ce.__midiMap)==null?void 0:c.get(r))??r;return ce.start({note:s,stopId:s,velocity:t,time:i,loop:n}),()=>{ce==null||ce.stop({stopId:s})}}function Sc(e){var o;if(!ce)return;const t=L(e);if(t===null)return;const n=((o=ce.__midiMap)==null?void 0:o.get(t))??t;ce.stop({stopId:n})}async function kc(e,t,n,o=100,i=!1,r=null,s=null,c=null){var h;const l=s||Se(),u=await cn(e,l,c),a=L(t);if(a===null)return null;const d=((h=u.__midiMap)==null?void 0:h.get(a))??a;return u.start({note:d,duration:n,velocity:o,loop:i,time:r??l.currentTime}),null}function Ic(){return{name:"sf2",setActiveInstrument:wc,getActiveInstrumentName:Ec,playNote:_c,stopNoteByPitch:Sc,loadAndPlayNote:kc}}const ln={sf2:Ic()},un="sf2";let Go=null;async function jo(e,t=un){const n=ln[t];if(!n)throw new Error(`Engine "${t}" not available`);await n.setActiveInstrument(e),Go=e}function Pc(){return Go}function zo(e,t=100,n=!1,o=un){const i=ln[o];if(!i)throw new Error(`Engine "${o}" not available`);return i.playNote(e,t,n)}function Mc(e,t=un){const n=ln[t];if(!n)throw new Error(`Engine "${t}" not available`);return n.stopNoteByPitch(e)}async function Cc(e,t,n,o=100,i=!1,r=null,s=null,c=null,l=un){const u=ln[l];if(!u)throw new Error(`Engine "${l}" not available`);return await u.loadAndPlayNote(e,t,n,o,i,r,s,c)}let pn=null;function Se(){return pn||(pn=new(window.AudioContext||window.webkitAudioContext)),pn}let Ot=null,Rt=null;function Cn(){return Ot||(Ot=Se().createAnalyser(),Ot.fftSize=2048),Ot}function xe(){return Rt||(Rt=Se().createGain(),Cn().connect(Se().destination),Rt.connect(Cn())),Rt}function Tc(e){Se().resume();try{const t=zo(e,100,!1);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}let Tr=!1,Dt=null;function Wo(e,t){if(Tr)return;Tr=!0,Dt=t;const n=e.getContext("2d");if(!n)return;const o=new Map,i=new Set;function r(a,d){const h=Dt();for(const f of Object.values(h))if(f.isBlack&&a>=f.x&&a<=f.x+f.width&&d>=0&&d<=f.height)return f.note;for(const f of Object.values(h))if(!f.isBlack&&a>=f.x&&a<=f.x+f.width&&d>=0&&d<=f.height)return f.note;return null}function s(a){if(!a||i.has(a))return;const d=Tc(a);d&&(o.set(a,d),i.add(a),n&&nt(n,Dt(),i))}function c(a){if(!i.has(a))return;const d=o.get(a);d&&(d.stop(),o.delete(a)),i.delete(a),n&&nt(n,Dt(),i)}function l(){for(const a of i)c(a)}let u=!1;e.addEventListener("mousedown",a=>{u=!0;const d=e.getBoundingClientRect(),h=a.clientX-d.left,f=a.clientY-d.top,m=r(h,f);s(m)}),e.addEventListener("mousemove",a=>{if(!u)return;const d=e.getBoundingClientRect(),h=a.clientX-d.left,f=a.clientY-d.top,m=r(h,f);s(m)}),e.addEventListener("mouseup",()=>{u=!1,l()}),e.addEventListener("mouseleave",()=>{u=!1,l()})}const Zn=[..."qwertyuiop[zxcvbnm,./"],er=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];function Nc(){const e=document.getElementById("instrument-loop-toggle");return(e==null?void 0:e.checked)??!1}let Tn=!1,qt=null,_t=null,St=null;function Ko(e,t){if(Tn)return;Tn=!0;const n=e.getContext("2d");if(!n)throw new Error("Canvas 2D context not available.");const o=new Set,i=new Set,r=new Map,s=Zn,c=er;qt=t;function l(){const d=qt(),h=Object.values(d).filter(y=>!y.isBlack).sort((y,p)=>y.x-p.x).map(y=>y.note),f=Object.values(d).filter(y=>y.isBlack).sort((y,p)=>y.x-p.x).map(y=>y.note),m={};return s.forEach((y,p)=>{h[p]&&(m[y]=h[p])}),c.forEach((y,p)=>{f[p]&&(m[y]=f[p])}),m}function u(d){const h=l(),f=h[d];if(!(!f||o.has(d))){if(o.add(d),!i.has(f)){const m=zo(f,100,Nc());m&&(r.set(f,{stop:m}),i.add(f))}n&&nt(n,qt(),i,h)}}function a(d){const h=l(),f=h[d];f&&(o.delete(d),i.has(f)&&(Mc(f),r.delete(f),i.delete(f)),n&&nt(n,qt(),i,h))}_t=d=>{d.repeat||u(d.key)},St=d=>{a(d.key)},window.addEventListener("keydown",_t),window.addEventListener("keyup",St)}function Xo(){_t&&(window.removeEventListener("keydown",_t),_t=null),St&&(window.removeEventListener("keyup",St),St=null),Tn=!1}let Xe=3,Ge=nn(Xe),Ut=!1;async function Bc(e){var r,s;const t=e.getContext("2d");if(!t)throw new Error("Failed to get 2D context for keyboard canvas");function n(){const c=Object.values(Ge).filter(a=>!a.isBlack).sort((a,d)=>a.x-d.x).map(a=>a.note),l=Object.values(Ge).filter(a=>a.isBlack).sort((a,d)=>a.x-d.x).map(a=>a.note),u={};return Zn.forEach((a,d)=>{c[d]&&(u[a]=c[d])}),er.forEach((a,d)=>{l[d]&&(u[a]=l[d])}),u}function o(){if(!t)return;Ge=nn(Xe);const c=Ut?n():null;nt(t,Ge,new Set,c)}Wo(e,()=>Ge),o(),(r=document.getElementById("octave-up"))==null||r.addEventListener("click",()=>{Xe<7&&(Xe++,o())}),(s=document.getElementById("octave-down"))==null||s.addEventListener("click",()=>{Xe>1&&(Xe--,o())});const i=document.getElementById("disable-keyboard-inputs");return i.classList.remove("bg-purple-600"),i.classList.add("bg-gray-700"),i.addEventListener("click",()=>{Ut=!Ut,Ut?(Ko(e,()=>Ge),i.classList.remove("bg-gray-700"),i.classList.add("bg-purple-600")):(Xo(),i.classList.remove("bg-purple-600"),i.classList.add("bg-gray-700")),o()}),{refreshKeyboard:o}}let Ve=3,je=nn(Ve),xt=!1,$t=null;async function Lc(e){var c,l;if($t=e.getContext("2d"),!$t)throw new Error("Failed to get 2D context for keyboard canvas.");await jo("sf2/fluidr3-gm/acoustic_grand_piano");function t(){const u=Object.values(je).filter(h=>!h.isBlack).sort((h,f)=>h.x-f.x).map(h=>h.note),a=Object.values(je).filter(h=>h.isBlack).sort((h,f)=>h.x-f.x).map(h=>h.note),d={};return Zn.forEach((h,f)=>{u[f]&&(d[h]=u[f])}),er.forEach((h,f)=>{a[f]&&(d[h]=a[f])}),d}function n(){je=nn(Ve);const u=xt?t():null;$t&&nt($t,je,new Set,u)}Wo(e,()=>je),n(),(c=document.getElementById("octave-up"))==null||c.addEventListener("click",()=>{Ve<7&&(Ve++,n())}),(l=document.getElementById("octave-down"))==null||l.addEventListener("click",()=>{Ve>1&&(Ve--,n())});const o=document.getElementById("disable-keyboard-inputs");o.classList.remove("bg-purple-600"),o.classList.add("bg-gray-700"),o.addEventListener("click",()=>{xt=!xt,xt?(Ko(e,()=>je),o.classList.remove("bg-gray-700"),o.classList.add("bg-purple-600")):(Xo(),o.classList.remove("bg-purple-600"),o.classList.add("bg-gray-700")),n()}),document.getElementById("global-instrument-select-btn").addEventListener("click",async()=>{console.log("GLOBAL KEYBOARD BUTTON CLICKED");const u=Pc()||"sf2/fluidr3-gm/acoustic_grand_piano",a=document.getElementById("instrument-select-modal");delete a.dataset.currentSequencer,await ko(u),a.classList.remove("hidden")}),document.getElementById("instrument-select-confirm").addEventListener("click",async()=>{await Io(),n()}),document.getElementById("instrument-cancel-btn").addEventListener("click",()=>{Po()})}async function Fc(e){await Lc(e);const{refreshKeyboard:t}=await Bc(e)}function Ac(e,t){const n=t.getContext("2d");if(!n)throw new Error("Canvas 2D context not available");const o=t.width,i=t.height,r=new Uint8Array(e.fftSize),s=new Uint8Array(e.frequencyBinCount),c=document.createElement("canvas");c.width=o,c.height=i;const l=c.getContext("2d");if(!l)throw new Error("Offscreen canvas 2D context not available");let u="frequency";function a(){if(!n)return;e.getByteTimeDomainData(r),n.fillStyle="#000",n.fillRect(0,0,o,i),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const m=o/r.length;let y=0;for(let p=0;p<r.length;p++){const v=r[p]/128*i/2;p===0?n.moveTo(y,v):n.lineTo(y,v),y+=m}n.lineTo(o,i/2),n.stroke()}function d(){if(e.getByteFrequencyData(s),!n)return;n.fillStyle="#000",n.fillRect(0,0,o,i),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,i),n.fillRect(o-1,0,1,i);const m=128,y=2,p=[];for(let g=0;g<m;g++)p.push(g*o/(m-1));p[p.length-1]=o-1;for(let g=0;g<m;g++){const v=p[g],w=g<m-1?p[g+1]:o,b=Math.max(1,w-v-y),_=20,E=2e4,C=g/(m-1),P=_*Math.pow(E/_,C),N=Math.min(s.length-1,Math.floor(P/22050*s.length)),M=s[N]/255,O=Math.max(1,M*i),D=240-C*240;n.fillStyle=`hsl(${D}, ${80+M*20}%, ${40+M*40}%)`,n.fillRect(v,i-O,b,O)}}function h(){if(e.getByteFrequencyData(s),!l)return;c.initialized||(l.fillStyle="#000",l.fillRect(0,0,o,i),c.initialized=!0),l.drawImage(c,-1,0),l.fillStyle="#000",l.fillRect(o-1,0,1,i);const m=128,y=20,p=2e4;for(let g=0;g<m;g++){const v=g/(m-1),w=y*Math.pow(p/y,v),_=Math.min(s.length-1,Math.floor(w/22050*s.length)),E=s[_]/255,C=i-1-Math.floor(g*i/m);if(E<.05)continue;const P=Math.floor(E*255),T=Math.floor(E*(255-v*200)),N=Math.floor(E*(100+v*155));l.fillStyle=`rgb(${P}, ${T}, ${N})`,l.fillRect(o-1,C,1,1)}n&&(n.fillStyle="#000",n.fillRect(0,0,o,i),n.drawImage(c,0,0))}function f(){switch(requestAnimationFrame(f),u){case"frequency":d();break;case"spectrogram":h();break;case"waveform":default:a()}}return f(),{setMode(m){["waveform","frequency","spectrogram"].includes(m)&&(u=m,n.clearRect(0,0,o,i),u==="spectrogram"&&l.clearRect(0,0,o,i))}}}function Oc(e,t){const n=Ac(Cn(),e),o=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let i=0;function r(){i=(i+1)%o.length;const{name:s,emoji:c}=o[i];n.setMode(s),t.textContent=c,t.title=`Mode: ${s}`}t.addEventListener("click",r),r()}function Rc(){var d;const e=document.getElementById("global-mini-expand-btn"),t=document.getElementById("global-mini-contour"),n=document.getElementById("global-mini-playhead"),o=(d=t==null?void 0:t.parentElement)==null?void 0:d.parentElement,i=t==null?void 0:t.parentElement,r=e==null?void 0:e.querySelector("svg use"),s=document.querySelector(".footer-spacer"),c=40;let l=!1;function u(h,f){const m=h.offsetWidth;h.style.height=`${f}px`,h.height=f,h.width=m}if(!e||!t||!n||!o||!i||!r||!s){console.warn("FooterUI: One or more elements not found.");return}o.style.height=`${c}px`,i.style.height=`${c}px`,u(t,c),u(n,c),ne(t,Te());function a(){l=!l;const h=l?200:40;!o||!i||!t||!n||!r||!s||(o.style.height=`${h}px`,i.style.height=`${h}px`,u(t,h),u(n,h),r.setAttribute("href",l?"#icon-caret-down":"#icon-caret-up"),s.style.height=`${h-40+140}px`,ne(t,Te()))}e.addEventListener("click",a)}function Dc(e){if(!e.sequencers.length)throw new Error("No tracks to export.");const t=e.tempo,n=e.timeSignature[0],o=e.totalMeasures,i={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:o},i:e.sequencers.map(s=>s.instrument||"sf2/fluidr3-gm/acoustic_grand_piano"),tr:e.sequencers.map(s=>({n:s.notes.map(c=>[c.pitch,c.start,c.duration])}))},r=new Blob([JSON.stringify(i)],{type:"application/json"});return{url:URL.createObjectURL(r),filename:`session-${Date.now()}.json`}}async function qc(e){if(!e.tracks||e.tracks.length===0)throw new Error("No tracks to export.");const n=60/He(),o=Math.max(...e.tracks.flatMap(a=>a.notes.map(d=>(d.start+d.duration)*n+.2))),i=44100,r=new OfflineAudioContext(2,Math.ceil(i*o),i);for(const a of e.tracks){const d=a.instrument||"sf2/fluidr3-gm/acoustic_grand_piano",h=new wo(null,a.config,r,r.destination,d);h.setState(a),await h.exportToOffline()}const s=await r.startRendering(),c=Uc(s),l=URL.createObjectURL(c),u=document.createElement("a");u.href=l,u.download=`session-${Date.now()}.wav`,u.click(),URL.revokeObjectURL(l)}function Uc(e){const t=e.numberOfChannels,n=e.length*t*2,o=new DataView(new ArrayBuffer(44+n)),i=(s,c)=>{for(let l=0;l<c.length;l++)o.setUint8(s+l,c.charCodeAt(l))};i(0,"RIFF"),o.setUint32(4,36+n,!0),i(8,"WAVE"),i(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,t,!0),o.setUint32(24,e.sampleRate,!0),o.setUint32(28,e.sampleRate*t*2,!0),o.setUint16(32,t*2,!0),o.setUint16(34,16,!0),i(36,"data"),o.setUint32(40,n,!0);let r=44;for(let s=0;s<e.length;s++)for(let c=0;c<t;c++){const l=e.getChannelData(c)[s],u=Math.max(-1,Math.min(1,l));o.setInt16(r,u*32767,!0),r+=2}return new Blob([o.buffer],{type:"audio/wav"})}function xc(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if(typeof t=="function"){var n=function o(){return this instanceof o?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach(function(o){var i=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(n,o,i.get?i:{enumerable:!0,get:function(){return e[o]}})}),n}var Be={},Ht={},mn,Nr;function $c(){if(Nr)return mn;Nr=1;function e(i){var r=new o(i),s=r.readChunk();if(s.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+s.id+"'";for(var c=t(s.data),l=[],u=0;!r.eof()&&u<c.numTracks;u++){var a=r.readChunk();if(a.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+a.id+"'";var d=n(a.data);l.push(d)}return{header:c,tracks:l}}function t(i){var r=new o(i),s=r.readUInt16(),c=r.readUInt16(),l={format:s,numTracks:c},u=r.readUInt16();return u&32768?(l.framesPerSecond=256-(u>>8),l.ticksPerFrame=u&255):l.ticksPerBeat=u,l}function n(i){for(var r=new o(i),s=[];!r.eof();){var c=u();s.push(c)}return s;var l;function u(){var a={};a.deltaTime=r.readVarInt();var d=r.readUInt8();if((d&240)===240)if(d===255){a.meta=!0;var h=r.readUInt8(),f=r.readVarInt();switch(h){case 0:if(a.type="sequenceNumber",f!==2)throw"Expected length for sequenceNumber event is 2, got "+f;return a.number=r.readUInt16(),a;case 1:return a.type="text",a.text=r.readString(f),a;case 2:return a.type="copyrightNotice",a.text=r.readString(f),a;case 3:return a.type="trackName",a.text=r.readString(f),a;case 4:return a.type="instrumentName",a.text=r.readString(f),a;case 5:return a.type="lyrics",a.text=r.readString(f),a;case 6:return a.type="marker",a.text=r.readString(f),a;case 7:return a.type="cuePoint",a.text=r.readString(f),a;case 32:if(a.type="channelPrefix",f!=1)throw"Expected length for channelPrefix event is 1, got "+f;return a.channel=r.readUInt8(),a;case 33:if(a.type="portPrefix",f!=1)throw"Expected length for portPrefix event is 1, got "+f;return a.port=r.readUInt8(),a;case 47:if(a.type="endOfTrack",f!=0)throw"Expected length for endOfTrack event is 0, got "+f;return a;case 81:if(a.type="setTempo",f!=3)throw"Expected length for setTempo event is 3, got "+f;return a.microsecondsPerBeat=r.readUInt24(),a;case 84:if(a.type="smpteOffset",f!=5)throw"Expected length for smpteOffset event is 5, got "+f;var m=r.readUInt8(),y={0:24,32:25,64:29,96:30};return a.frameRate=y[m&96],a.hour=m&31,a.min=r.readUInt8(),a.sec=r.readUInt8(),a.frame=r.readUInt8(),a.subFrame=r.readUInt8(),a;case 88:if(a.type="timeSignature",f!=2&&f!=4)throw"Expected length for timeSignature event is 4 or 2, got "+f;return a.numerator=r.readUInt8(),a.denominator=1<<r.readUInt8(),f===4?(a.metronome=r.readUInt8(),a.thirtyseconds=r.readUInt8()):(a.metronome=36,a.thirtyseconds=8),a;case 89:if(a.type="keySignature",f!=2)throw"Expected length for keySignature event is 2, got "+f;return a.key=r.readInt8(),a.scale=r.readUInt8(),a;case 127:return a.type="sequencerSpecific",a.data=r.readBytes(f),a;default:return a.type="unknownMeta",a.data=r.readBytes(f),a.metatypeByte=h,a}}else if(d==240){a.type="sysEx";var f=r.readVarInt();return a.data=r.readBytes(f),a}else if(d==247){a.type="endSysEx";var f=r.readVarInt();return a.data=r.readBytes(f),a}else throw"Unrecognised MIDI event type byte: "+d;else{var p;if((d&128)===0){if(l===null)throw"Running status byte encountered before status byte";p=d,d=l,a.running=!0}else p=r.readUInt8(),l=d;var g=d>>4;switch(a.channel=d&15,g){case 8:return a.type="noteOff",a.noteNumber=p,a.velocity=r.readUInt8(),a;case 9:var v=r.readUInt8();return a.type=v===0?"noteOff":"noteOn",a.noteNumber=p,a.velocity=v,v===0&&(a.byte9=!0),a;case 10:return a.type="noteAftertouch",a.noteNumber=p,a.amount=r.readUInt8(),a;case 11:return a.type="controller",a.controllerType=p,a.value=r.readUInt8(),a;case 12:return a.type="programChange",a.programNumber=p,a;case 13:return a.type="channelAftertouch",a.amount=p,a;case 14:return a.type="pitchBend",a.value=p+(r.readUInt8()<<7)-8192,a;default:throw"Unrecognised MIDI event type: "+g}}}}function o(i){this.buffer=i,this.bufferLen=this.buffer.length,this.pos=0}return o.prototype.eof=function(){return this.pos>=this.bufferLen},o.prototype.readUInt8=function(){var i=this.buffer[this.pos];return this.pos+=1,i},o.prototype.readInt8=function(){var i=this.readUInt8();return i&128?i-256:i},o.prototype.readUInt16=function(){var i=this.readUInt8(),r=this.readUInt8();return(i<<8)+r},o.prototype.readInt16=function(){var i=this.readUInt16();return i&32768?i-65536:i},o.prototype.readUInt24=function(){var i=this.readUInt8(),r=this.readUInt8(),s=this.readUInt8();return(i<<16)+(r<<8)+s},o.prototype.readInt24=function(){var i=this.readUInt24();return i&8388608?i-16777216:i},o.prototype.readUInt32=function(){var i=this.readUInt8(),r=this.readUInt8(),s=this.readUInt8(),c=this.readUInt8();return(i<<24)+(r<<16)+(s<<8)+c},o.prototype.readBytes=function(i){var r=this.buffer.slice(this.pos,this.pos+i);return this.pos+=i,r},o.prototype.readString=function(i){var r=this.readBytes(i);return String.fromCharCode.apply(null,r)},o.prototype.readVarInt=function(){for(var i=0;!this.eof();){var r=this.readUInt8();if(r&128)i+=r&127,i<<=7;else return i+r}return i},o.prototype.readChunk=function(){var i=this.readString(4),r=this.readUInt32(),s=this.readBytes(r);return{id:i,length:r,data:s}},mn=e,mn}var gn,Br;function Hc(){if(Br)return gn;Br=1;function e(r,s){if(typeof r!="object")throw"Invalid MIDI data";s=s||{};var c=r.header||{},l=r.tracks||[],u,a=l.length,d=new i;for(t(d,c,a),u=0;u<a;u++)n(d,l[u],s);return d.buffer}function t(r,s,c){var l=s.format==null?1:s.format,u=128;s.timeDivision?u=s.timeDivision:s.ticksPerFrame&&s.framesPerSecond?u=-(s.framesPerSecond&255)<<8|s.ticksPerFrame&255:s.ticksPerBeat&&(u=s.ticksPerBeat&32767);var a=new i;a.writeUInt16(l),a.writeUInt16(c),a.writeUInt16(u),r.writeChunk("MThd",a.buffer)}function n(r,s,c){var l=new i,u,a=s.length,d=null;for(u=0;u<a;u++)(c.running===!1||!c.running&&!s[u].running)&&(d=null),d=o(l,s[u],d,c.useByte9ForNoteOff);r.writeChunk("MTrk",l.buffer)}function o(r,s,c,l){var u=s.type,a=s.deltaTime,d=s.text||"",h=s.data||[],f=null;switch(r.writeVarInt(a),u){case"sequenceNumber":r.writeUInt8(255),r.writeUInt8(0),r.writeVarInt(2),r.writeUInt16(s.number);break;case"text":r.writeUInt8(255),r.writeUInt8(1),r.writeVarInt(d.length),r.writeString(d);break;case"copyrightNotice":r.writeUInt8(255),r.writeUInt8(2),r.writeVarInt(d.length),r.writeString(d);break;case"trackName":r.writeUInt8(255),r.writeUInt8(3),r.writeVarInt(d.length),r.writeString(d);break;case"instrumentName":r.writeUInt8(255),r.writeUInt8(4),r.writeVarInt(d.length),r.writeString(d);break;case"lyrics":r.writeUInt8(255),r.writeUInt8(5),r.writeVarInt(d.length),r.writeString(d);break;case"marker":r.writeUInt8(255),r.writeUInt8(6),r.writeVarInt(d.length),r.writeString(d);break;case"cuePoint":r.writeUInt8(255),r.writeUInt8(7),r.writeVarInt(d.length),r.writeString(d);break;case"channelPrefix":r.writeUInt8(255),r.writeUInt8(32),r.writeVarInt(1),r.writeUInt8(s.channel);break;case"portPrefix":r.writeUInt8(255),r.writeUInt8(33),r.writeVarInt(1),r.writeUInt8(s.port);break;case"endOfTrack":r.writeUInt8(255),r.writeUInt8(47),r.writeVarInt(0);break;case"setTempo":r.writeUInt8(255),r.writeUInt8(81),r.writeVarInt(3),r.writeUInt24(s.microsecondsPerBeat);break;case"smpteOffset":r.writeUInt8(255),r.writeUInt8(84),r.writeVarInt(5);var m={24:0,25:32,29:64,30:96},y=s.hour&31|m[s.frameRate];r.writeUInt8(y),r.writeUInt8(s.min),r.writeUInt8(s.sec),r.writeUInt8(s.frame),r.writeUInt8(s.subFrame);break;case"timeSignature":r.writeUInt8(255),r.writeUInt8(88),r.writeVarInt(4),r.writeUInt8(s.numerator);var p=Math.floor(Math.log(s.denominator)/Math.LN2)&255;r.writeUInt8(p),r.writeUInt8(s.metronome),r.writeUInt8(s.thirtyseconds||8);break;case"keySignature":r.writeUInt8(255),r.writeUInt8(89),r.writeVarInt(2),r.writeInt8(s.key),r.writeUInt8(s.scale);break;case"sequencerSpecific":r.writeUInt8(255),r.writeUInt8(127),r.writeVarInt(h.length),r.writeBytes(h);break;case"unknownMeta":s.metatypeByte!=null&&(r.writeUInt8(255),r.writeUInt8(s.metatypeByte),r.writeVarInt(h.length),r.writeBytes(h));break;case"sysEx":r.writeUInt8(240),r.writeVarInt(h.length),r.writeBytes(h);break;case"endSysEx":r.writeUInt8(247),r.writeVarInt(h.length),r.writeBytes(h);break;case"noteOff":var g=l!==!1&&s.byte9||l&&s.velocity==0?144:128;f=g|s.channel,f!==c&&r.writeUInt8(f),r.writeUInt8(s.noteNumber),r.writeUInt8(s.velocity);break;case"noteOn":f=144|s.channel,f!==c&&r.writeUInt8(f),r.writeUInt8(s.noteNumber),r.writeUInt8(s.velocity);break;case"noteAftertouch":f=160|s.channel,f!==c&&r.writeUInt8(f),r.writeUInt8(s.noteNumber),r.writeUInt8(s.amount);break;case"controller":f=176|s.channel,f!==c&&r.writeUInt8(f),r.writeUInt8(s.controllerType),r.writeUInt8(s.value);break;case"programChange":f=192|s.channel,f!==c&&r.writeUInt8(f),r.writeUInt8(s.programNumber);break;case"channelAftertouch":f=208|s.channel,f!==c&&r.writeUInt8(f),r.writeUInt8(s.amount);break;case"pitchBend":f=224|s.channel,f!==c&&r.writeUInt8(f);var v=8192+s.value,w=v&127,b=v>>7&127;r.writeUInt8(w),r.writeUInt8(b);break;default:throw"Unrecognized event type: "+u}return f}function i(){this.buffer=[]}return i.prototype.writeUInt8=function(r){this.buffer.push(r&255)},i.prototype.writeInt8=i.prototype.writeUInt8,i.prototype.writeUInt16=function(r){var s=r>>8&255,c=r&255;this.writeUInt8(s),this.writeUInt8(c)},i.prototype.writeInt16=i.prototype.writeUInt16,i.prototype.writeUInt24=function(r){var s=r>>16&255,c=r>>8&255,l=r&255;this.writeUInt8(s),this.writeUInt8(c),this.writeUInt8(l)},i.prototype.writeInt24=i.prototype.writeUInt24,i.prototype.writeUInt32=function(r){var s=r>>24&255,c=r>>16&255,l=r>>8&255,u=r&255;this.writeUInt8(s),this.writeUInt8(c),this.writeUInt8(l),this.writeUInt8(u)},i.prototype.writeInt32=i.prototype.writeUInt32,i.prototype.writeBytes=function(r){this.buffer=this.buffer.concat(Array.prototype.slice.call(r,0))},i.prototype.writeString=function(r){var s,c=r.length,l=[];for(s=0;s<c;s++)l.push(r.codePointAt(s));this.writeBytes(l)},i.prototype.writeVarInt=function(r){if(r<0)throw"Cannot write negative variable-length integer";if(r<=127)this.writeUInt8(r);else{var s=r,c=[];for(c.push(s&127),s>>=7;s;){var l=s&127|128;c.push(l),s>>=7}this.writeBytes(c.reverse())}},i.prototype.writeChunk=function(r,s){this.writeString(r),this.writeUInt32(s.length),this.writeBytes(s)},gn=e,gn}var Lr;function Vo(){return Lr||(Lr=1,Ht.parseMidi=$c(),Ht.writeMidi=Hc()),Ht}var yn={},Le={},Fr;function Yo(){if(Fr)return Le;Fr=1,Object.defineProperty(Le,"__esModule",{value:!0}),Le.insert=Le.search=void 0;function e(n,o,i){i===void 0&&(i="ticks");var r=0,s=n.length,c=s;if(s>0&&n[s-1][i]<=o)return s-1;for(;r<c;){var l=Math.floor(r+(c-r)/2),u=n[l],a=n[l+1];if(u[i]===o){for(var d=l;d<n.length;d++){var h=n[d];h[i]===o&&(l=d)}return l}else{if(u[i]<o&&a[i]>o)return l;u[i]>o?c=l:u[i]<o&&(r=l+1)}}return-1}Le.search=e;function t(n,o,i){if(i===void 0&&(i="ticks"),n.length){var r=e(n,o[i],i);n.splice(r+1,0,o)}else n.push(o)}return Le.insert=t,Le}var Ar;function Nn(){return Ar||(Ar=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.Header=e.keySignatureKeys=void 0;var t=Yo(),n=new WeakMap;e.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var o=function(){function i(r){var s=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",n.set(this,480),r){n.set(this,r.header.ticksPerBeat),r.tracks.forEach(function(l){l.forEach(function(u){u.meta&&(u.type==="timeSignature"?s.timeSignatures.push({ticks:u.absoluteTime,timeSignature:[u.numerator,u.denominator]}):u.type==="setTempo"?s.tempos.push({bpm:6e7/u.microsecondsPerBeat,ticks:u.absoluteTime}):u.type==="keySignature"&&s.keySignatures.push({key:e.keySignatureKeys[u.key+7],scale:u.scale===0?"major":"minor",ticks:u.absoluteTime}))})});var c=0;r.tracks[0].forEach(function(l){c+=l.deltaTime,l.meta&&(l.type==="trackName"?s.name=l.text:(l.type==="text"||l.type==="cuePoint"||l.type==="marker"||l.type==="lyrics")&&s.meta.push({text:l.text,ticks:c,type:l.type}))}),this.update()}}return i.prototype.update=function(){var r=this,s=0,c=0;this.tempos.sort(function(l,u){return l.ticks-u.ticks}),this.tempos.forEach(function(l,u){var a=u>0?r.tempos[u-1].bpm:r.tempos[0].bpm,d=l.ticks/r.ppq-c,h=60/a*d;l.time=h+s,s=l.time,c+=d}),this.timeSignatures.sort(function(l,u){return l.ticks-u.ticks}),this.timeSignatures.forEach(function(l,u){var a=u>0?r.timeSignatures[u-1]:r.timeSignatures[0],d=(l.ticks-a.ticks)/r.ppq,h=d/a.timeSignature[0]/(a.timeSignature[1]/4);a.measures=a.measures||0,l.measures=h+a.measures})},i.prototype.ticksToSeconds=function(r){var s=(0,t.search)(this.tempos,r);if(s!==-1){var c=this.tempos[s],l=c.time,u=(r-c.ticks)/this.ppq;return l+60/c.bpm*u}else{var a=r/this.ppq;return 60/120*a}},i.prototype.ticksToMeasures=function(r){var s=(0,t.search)(this.timeSignatures,r);if(s!==-1){var c=this.timeSignatures[s],l=(r-c.ticks)/this.ppq;return c.measures+l/(c.timeSignature[0]/c.timeSignature[1])/4}else return r/this.ppq/4},Object.defineProperty(i.prototype,"ppq",{get:function(){return n.get(this)},enumerable:!1,configurable:!0}),i.prototype.secondsToTicks=function(r){var s=(0,t.search)(this.tempos,r,"time");if(s!==-1){var c=this.tempos[s],l=c.time,u=r-l,a=u/(60/c.bpm);return Math.round(c.ticks+a*this.ppq)}else{var d=r/.5;return Math.round(d*this.ppq)}},i.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(r){return{bpm:r.bpm,ticks:r.ticks}}),timeSignatures:this.timeSignatures}},i.prototype.fromJSON=function(r){this.name=r.name,this.tempos=r.tempos.map(function(s){return Object.assign({},s)}),this.timeSignatures=r.timeSignatures.map(function(s){return Object.assign({},s)}),this.keySignatures=r.keySignatures.map(function(s){return Object.assign({},s)}),this.meta=r.meta.map(function(s){return Object.assign({},s)}),n.set(this,r.ppq),this.update()},i.prototype.setTempo=function(r){this.tempos=[{bpm:r,ticks:0}],this.update()},i}();e.Header=o}(yn)),yn}var ct={},bn={},Or;function Jo(){return Or||(Or=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ControlChange=e.controlChangeIds=e.controlChangeNames=void 0,e.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},e.controlChangeIds=Object.keys(e.controlChangeNames).reduce(function(i,r){return i[e.controlChangeNames[r]]=r,i},{});var t=new WeakMap,n=new WeakMap,o=function(){function i(r,s){t.set(this,s),n.set(this,r.controllerType),this.ticks=r.absoluteTime,this.value=r.value}return Object.defineProperty(i.prototype,"number",{get:function(){return n.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return e.controlChangeNames[this.number]?e.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"time",{get:function(){var r=t.get(this);return r.ticksToSeconds(this.ticks)},set:function(r){var s=t.get(this);this.ticks=s.secondsToTicks(r)},enumerable:!1,configurable:!0}),i.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},i}();e.ControlChange=o}(bn)),bn}var lt={},Rr;function Gc(){if(Rr)return lt;Rr=1,Object.defineProperty(lt,"__esModule",{value:!0}),lt.createControlChanges=void 0;var e=Jo();function t(){return new Proxy({},{get:function(n,o){if(n[o])return n[o];if(e.controlChangeIds.hasOwnProperty(o))return n[e.controlChangeIds[o]]},set:function(n,o,i){return e.controlChangeIds.hasOwnProperty(o)?n[e.controlChangeIds[o]]=i:n[o]=i,!0}})}return lt.createControlChanges=t,lt}var ut={},Dr;function jc(){if(Dr)return ut;Dr=1,Object.defineProperty(ut,"__esModule",{value:!0}),ut.PitchBend=void 0;var e=new WeakMap,t=function(){function n(o,i){e.set(this,i),this.ticks=o.absoluteTime,this.value=o.value}return Object.defineProperty(n.prototype,"time",{get:function(){var o=e.get(this);return o.ticksToSeconds(this.ticks)},set:function(o){var i=e.get(this);this.ticks=i.secondsToTicks(o)},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},n}();return ut.PitchBend=t,ut}var dt={},fe={},qr;function zc(){return qr||(qr=1,Object.defineProperty(fe,"__esModule",{value:!0}),fe.DrumKitByPatchID=fe.InstrumentFamilyByID=fe.instrumentByPatchID=void 0,fe.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],fe.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],fe.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),fe}var Ur;function Wc(){if(Ur)return dt;Ur=1,Object.defineProperty(dt,"__esModule",{value:!0}),dt.Instrument=void 0;var e=zc(),t=new WeakMap,n=function(){function o(i,r){if(this.number=0,t.set(this,r),this.number=0,i){var s=i.find(function(c){return c.type==="programChange"});s&&(this.number=s.programNumber)}}return Object.defineProperty(o.prototype,"name",{get:function(){return this.percussion?e.DrumKitByPatchID[this.number]:e.instrumentByPatchID[this.number]},set:function(i){var r=e.instrumentByPatchID.indexOf(i);r!==-1&&(this.number=r)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"family",{get:function(){return this.percussion?"drums":e.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"percussion",{get:function(){var i=t.get(this);return i.channel===9},enumerable:!1,configurable:!0}),o.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},o.prototype.fromJSON=function(i){this.number=i.number},o}();return dt.Instrument=n,dt}var ft={},xr;function Kc(){if(xr)return ft;xr=1,Object.defineProperty(ft,"__esModule",{value:!0}),ft.Note=void 0;function e(s){var c=Math.floor(s/12)-1;return t(s)+c.toString()}function t(s){var c=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],l=s%12;return c[l]}function n(s){var c=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return c.indexOf(s)}var o=function(){var s=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,c={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(l){var u=s.exec(l),a=u[1],d=u[2],h=c[a.toLowerCase()];return h+(parseInt(d,10)+1)*12}}(),i=new WeakMap,r=function(){function s(c,l,u){i.set(this,u),this.midi=c.midi,this.velocity=c.velocity,this.noteOffVelocity=l.velocity,this.ticks=c.ticks,this.durationTicks=l.ticks-c.ticks}return Object.defineProperty(s.prototype,"name",{get:function(){return e(this.midi)},set:function(c){this.midi=o(c)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(c){var l=c-this.octave;this.midi+=l*12},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"pitch",{get:function(){return t(this.midi)},set:function(c){this.midi=12*(this.octave+1)+n(c)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"duration",{get:function(){var c=i.get(this);return c.ticksToSeconds(this.ticks+this.durationTicks)-c.ticksToSeconds(this.ticks)},set:function(c){var l=i.get(this),u=l.secondsToTicks(this.time+c);this.durationTicks=u-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"time",{get:function(){var c=i.get(this);return c.ticksToSeconds(this.ticks)},set:function(c){var l=i.get(this);this.ticks=l.secondsToTicks(c)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"bars",{get:function(){var c=i.get(this);return c.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),s.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},s}();return ft.Note=r,ft}var $r;function Hr(){if($r)return ct;$r=1,Object.defineProperty(ct,"__esModule",{value:!0}),ct.Track=void 0;var e=Yo(),t=Jo(),n=Gc(),o=jc(),i=Wc(),r=Kc(),s=new WeakMap,c=function(){function l(u,a){var d=this;if(this.name="",this.notes=[],this.controlChanges=(0,n.createControlChanges)(),this.pitchBends=[],s.set(this,a),u){var h=u.find(function(b){return b.type==="trackName"});this.name=h?h.text:""}if(this.instrument=new i.Instrument(u,this),this.channel=0,u){for(var f=u.filter(function(b){return b.type==="noteOn"}),m=u.filter(function(b){return b.type==="noteOff"}),y=function(){var b=f.shift();p.channel=b.channel;var _=m.findIndex(function(C){return C.noteNumber===b.noteNumber&&C.absoluteTime>=b.absoluteTime});if(_!==-1){var E=m.splice(_,1)[0];p.addNote({durationTicks:E.absoluteTime-b.absoluteTime,midi:b.noteNumber,noteOffVelocity:E.velocity/127,ticks:b.absoluteTime,velocity:b.velocity/127})}},p=this;f.length;)y();var g=u.filter(function(b){return b.type==="controller"});g.forEach(function(b){d.addCC({number:b.controllerType,ticks:b.absoluteTime,value:b.value/127})});var v=u.filter(function(b){return b.type==="pitchBend"});v.forEach(function(b){d.addPitchBend({ticks:b.absoluteTime,value:b.value/Math.pow(2,13)})});var w=u.find(function(b){return b.type==="endOfTrack"});this.endOfTrackTicks=w!==void 0?w.absoluteTime:void 0}}return l.prototype.addNote=function(u){var a=s.get(this),d=new r.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},a);return Object.assign(d,u),(0,e.insert)(this.notes,d,"ticks"),this},l.prototype.addCC=function(u){var a=s.get(this),d=new t.ControlChange({controllerType:u.number},a);return delete u.number,Object.assign(d,u),Array.isArray(this.controlChanges[d.number])||(this.controlChanges[d.number]=[]),(0,e.insert)(this.controlChanges[d.number],d,"ticks"),this},l.prototype.addPitchBend=function(u){var a=s.get(this),d=new o.PitchBend({},a);return Object.assign(d,u),(0,e.insert)(this.pitchBends,d,"ticks"),this},Object.defineProperty(l.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var u=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,a=0;a<this.notes.length-1;a++){var d=this.notes[a].time+this.notes[a].duration;u<d&&(u=d)}return u},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var u=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,a=0;a<this.notes.length-1;a++){var d=this.notes[a].ticks+this.notes[a].durationTicks;u<d&&(u=d)}return u},enumerable:!1,configurable:!0}),l.prototype.fromJSON=function(u){var a=this;this.name=u.name,this.channel=u.channel,this.instrument=new i.Instrument(void 0,this),this.instrument.fromJSON(u.instrument),u.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=u.endOfTrackTicks);for(var d in u.controlChanges)u.controlChanges[d]&&u.controlChanges[d].forEach(function(h){a.addCC({number:h.number,ticks:h.ticks,value:h.value})});u.notes.forEach(function(h){a.addNote({durationTicks:h.durationTicks,midi:h.midi,ticks:h.ticks,velocity:h.velocity})})},l.prototype.toJSON=function(){for(var u={},a=0;a<127;a++)this.controlChanges.hasOwnProperty(a)&&(u[a]=this.controlChanges[a].map(function(h){return h.toJSON()}));var d={channel:this.channel,controlChanges:u,pitchBends:this.pitchBends.map(function(h){return h.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(h){return h.toJSON()})};return this.endOfTrackTicks!==void 0&&(d.endOfTrackTicks=this.endOfTrackTicks),d},l}();return ct.Track=c,ct}var Fe={};function Xc(e){var t=[];return Qo(e,t),t}function Qo(e,t){for(var n=0;n<e.length;n++){var o=e[n];Array.isArray(o)?Qo(o,t):t.push(o)}}const Vc=Object.freeze(Object.defineProperty({__proto__:null,flatten:Xc},Symbol.toStringTag,{value:"Module"})),Yc=xc(Vc);var Gr;function Jc(){if(Gr)return Fe;Gr=1;var e=Fe&&Fe.__spreadArray||function(g,v,w){if(w||arguments.length===2)for(var b=0,_=v.length,E;b<_;b++)(E||!(b in v))&&(E||(E=Array.prototype.slice.call(v,0,b)),E[b]=v[b]);return g.concat(E||Array.prototype.slice.call(v))};Object.defineProperty(Fe,"__esModule",{value:!0}),Fe.encode=void 0;var t=Vo(),n=Nn(),o=Yc;function i(g,v){return[{absoluteTime:g.ticks,channel:v,deltaTime:0,noteNumber:g.midi,type:"noteOn",velocity:Math.floor(g.velocity*127)},{absoluteTime:g.ticks+g.durationTicks,channel:v,deltaTime:0,noteNumber:g.midi,type:"noteOff",velocity:Math.floor(g.noteOffVelocity*127)}]}function r(g){return(0,o.flatten)(g.notes.map(function(v){return i(v,g.channel)}))}function s(g,v){return{absoluteTime:g.ticks,channel:v,controllerType:g.number,deltaTime:0,type:"controller",value:Math.floor(g.value*127)}}function c(g){for(var v=[],w=0;w<127;w++)g.controlChanges.hasOwnProperty(w)&&g.controlChanges[w].forEach(function(b){v.push(s(b,g.channel))});return v}function l(g,v){return{absoluteTime:g.ticks,channel:v,deltaTime:0,type:"pitchBend",value:g.value}}function u(g){var v=[];return g.pitchBends.forEach(function(w){v.push(l(w,g.channel))}),v}function a(g){return{absoluteTime:0,channel:g.channel,deltaTime:0,programNumber:g.instrument.number,type:"programChange"}}function d(g){return{absoluteTime:0,deltaTime:0,meta:!0,text:g,type:"trackName"}}function h(g){return{absoluteTime:g.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/g.bpm),type:"setTempo"}}function f(g){return{absoluteTime:g.ticks,deltaTime:0,denominator:g.timeSignature[1],meta:!0,metronome:24,numerator:g.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function m(g){var v=n.keySignatureKeys.indexOf(g.key);return{absoluteTime:g.ticks,deltaTime:0,key:v+7,meta:!0,scale:g.scale==="major"?0:1,type:"keySignature"}}function y(g){return{absoluteTime:g.ticks,deltaTime:0,meta:!0,text:g.text,type:g.type}}function p(g){var v={header:{format:1,numTracks:g.tracks.length+1,ticksPerBeat:g.header.ppq},tracks:e([e(e(e(e([{absoluteTime:0,deltaTime:0,meta:!0,text:g.header.name,type:"trackName"}],g.header.keySignatures.map(function(w){return m(w)}),!0),g.header.meta.map(function(w){return y(w)}),!0),g.header.tempos.map(function(w){return h(w)}),!0),g.header.timeSignatures.map(function(w){return f(w)}),!0)],g.tracks.map(function(w){return e(e(e([d(w.name),a(w)],r(w),!0),c(w),!0),u(w),!0)}),!0)};return v.tracks=v.tracks.map(function(w){w=w.sort(function(_,E){return _.absoluteTime-E.absoluteTime});var b=0;return w.forEach(function(_){_.deltaTime=_.absoluteTime-b,b=_.absoluteTime,delete _.absoluteTime}),w.push({deltaTime:0,meta:!0,type:"endOfTrack"}),w}),new Uint8Array((0,t.writeMidi)(v))}return Fe.encode=p,Fe}var jr;function Qc(){return jr||(jr=1,function(e){var t=Be&&Be.__awaiter||function(d,h,f,m){function y(p){return p instanceof f?p:new f(function(g){g(p)})}return new(f||(f=Promise))(function(p,g){function v(_){try{b(m.next(_))}catch(E){g(E)}}function w(_){try{b(m.throw(_))}catch(E){g(E)}}function b(_){_.done?p(_.value):y(_.value).then(v,w)}b((m=m.apply(d,h||[])).next())})},n=Be&&Be.__generator||function(d,h){var f={label:0,sent:function(){if(p[0]&1)throw p[1];return p[1]},trys:[],ops:[]},m,y,p,g;return g={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(g[Symbol.iterator]=function(){return this}),g;function v(b){return function(_){return w([b,_])}}function w(b){if(m)throw new TypeError("Generator is already executing.");for(;f;)try{if(m=1,y&&(p=b[0]&2?y.return:b[0]?y.throw||((p=y.return)&&p.call(y),0):y.next)&&!(p=p.call(y,b[1])).done)return p;switch(y=0,p&&(b=[b[0]&2,p.value]),b[0]){case 0:case 1:p=b;break;case 4:return f.label++,{value:b[1],done:!1};case 5:f.label++,y=b[1],b=[0];continue;case 7:b=f.ops.pop(),f.trys.pop();continue;default:if(p=f.trys,!(p=p.length>0&&p[p.length-1])&&(b[0]===6||b[0]===2)){f=0;continue}if(b[0]===3&&(!p||b[1]>p[0]&&b[1]<p[3])){f.label=b[1];break}if(b[0]===6&&f.label<p[1]){f.label=p[1],p=b;break}if(p&&f.label<p[2]){f.label=p[2],f.ops.push(b);break}p[2]&&f.ops.pop(),f.trys.pop();continue}b=h.call(d,f)}catch(_){b=[6,_],y=0}finally{m=p=0}if(b[0]&5)throw b[1];return{value:b[0]?b[1]:void 0,done:!0}}};Object.defineProperty(e,"__esModule",{value:!0}),e.Header=e.Track=e.Midi=void 0;var o=Vo(),i=Nn(),r=Hr(),s=Jc(),c=function(){function d(h){var f=this,m=null;if(h){var y=h instanceof ArrayBuffer?new Uint8Array(h):h;m=(0,o.parseMidi)(y),m.tracks.forEach(function(p){var g=0;p.forEach(function(v){g+=v.deltaTime,v.absoluteTime=g})}),m.tracks=a(m.tracks)}this.header=new i.Header(m),this.tracks=[],h&&(this.tracks=m.tracks.map(function(p){return new r.Track(p,f.header)}),m.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return d.fromUrl=function(h){return t(this,void 0,void 0,function(){var f,m;return n(this,function(y){switch(y.label){case 0:return[4,fetch(h)];case 1:return f=y.sent(),f.ok?[4,f.arrayBuffer()]:[3,3];case 2:return m=y.sent(),[2,new d(m)];case 3:throw new Error("Could not load '".concat(h,"'"))}})})},Object.defineProperty(d.prototype,"name",{get:function(){return this.header.name},set:function(h){this.header.name=h},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"duration",{get:function(){var h=this.tracks.map(function(f){return f.duration});return Math.max.apply(Math,h)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"durationTicks",{get:function(){var h=this.tracks.map(function(f){return f.durationTicks});return Math.max.apply(Math,h)},enumerable:!1,configurable:!0}),d.prototype.addTrack=function(){var h=new r.Track(void 0,this.header);return this.tracks.push(h),h},d.prototype.toArray=function(){return(0,s.encode)(this)},d.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(h){return h.toJSON()})}},d.prototype.fromJSON=function(h){var f=this;this.header=new i.Header,this.header.fromJSON(h.header),this.tracks=h.tracks.map(function(m){var y=new r.Track(void 0,f.header);return y.fromJSON(m),y})},d.prototype.clone=function(){var h=new d;return h.fromJSON(this.toJSON()),h},d}();e.Midi=c;var l=Hr();Object.defineProperty(e,"Track",{enumerable:!0,get:function(){return l.Track}});var u=Nn();Object.defineProperty(e,"Header",{enumerable:!0,get:function(){return u.Header}});function a(d){for(var h=[],f=0;f<d.length;f++)for(var m=h.length,y=new Map,p=Array(16).fill(0),g=0,v=d[f];g<v.length;g++){var w=v[g],b=m,_=w.channel;if(_!==void 0){w.type==="programChange"&&(p[_]=w.programNumber);var E=p[_],C="".concat(E," ").concat(_);y.has(C)?b=y.get(C):(b=m+y.size,y.set(C,b))}h[b]||h.push([]),h[b].push(w)}return h}}(Be)),Be}var Zo=Qc();const ei=["acoustic_grand_piano","bright_acoustic_piano","electric_grand_piano","honkytonk_piano","electric_piano_1","electric_piano_2","harpsichord","clavinet","celesta","glockenspiel","music_box","vibraphone","marimba","xylophone","tubular_bells","dulcimer","drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","acoustic_guitar_nylon","acoustic_guitar_steel","electric_guitar_jazz","electric_guitar_clean","electric_guitar_muted","overdriven_guitar","distortion_guitar","guitar_harmonics","acoustic_bass","electric_bass_finger","electric_bass_pick","fretless_bass","slap_bass_1","slap_bass_2","synth_bass_1","synth_bass_2","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synth_strings_1","synth_strings_2","choir_aahs","voice_oohs","synth_choir","orchestra_hit","trumpet","trombone","tuba","muted_trumpet","french_horn","brass_section","synth_brass_1","synth_brass_2","soprano_sax","alto_sax","tenor_sax","baritone_sax","oboe","english_horn","bassoon","clarinet","piccolo","flute","recorder","pan_flute","blown_bottle","shakuhachi","whistle","ocarina","lead_1_square","lead_2_sawtooth","lead_3_calliope","lead_4_chiff","lead_5_charang","lead_6_voice","lead_7_fifths","lead_8_bass__lead","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep","fx_1_rain","fx_2_soundtrack","fx_3_crystal","fx_4_atmosphere","fx_5_brightness","fx_6_goblins","fx_7_echoes","fx_8_scifi","sitar","banjo","shamisen","koto","kalimba","bagpipe","fiddle","shanai","tinkle_bell","agogo","steel_drums","woodblock","taiko_drum","melodic_tom","synth_drum","reverse_cymbal","guitar_fret_noise","breath_noise","seashore","bird_tweet","telephone_ring","helicopter","applause","gunshot"];function Zc(e){const t=e.trim().toLowerCase().replace(/\s+/g,"_"),n=ei.findIndex(o=>o===t);return n!==-1?n:(t.includes("drum")||t.includes("drummachine"),0)}async function el(e){if(!e.sequencers.length)throw new Error("No tracks to export.");const t=new Zo.Midi;t.header.setTempo(e.tempo),t.header.timeSignatures.push({ticks:0,timeSignature:e.timeSignature});for(const[i,r]of e.sequencers.entries()){const s=t.addTrack(),c=r.instrument.toLowerCase().includes("drum");s.channel=c?9:i%16;const l=Zc(r.instrument);s.instrument.number=l;for(const u of r.notes){const a=L(u.pitch);if(a===null)continue;const d=zr(u.start,e.tempo),h=zr(u.duration,e.tempo);s.addNote({midi:a,time:d,duration:h,velocity:.8})}}const n=new Blob([t.toArray()],{type:"audio/midi"});return{url:URL.createObjectURL(n),filename:`session-${Date.now()}.mid`}}function zr(e,t){return 60/t*e}async function tl(e){var s,c,l;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const o={bpm:((s=n.c)==null?void 0:s.b)??120,beatsPerMeasure:((c=n.c)==null?void 0:c.bpm)??4,totalMeasures:((l=n.c)==null?void 0:l.tm)??8},i=Array.isArray(n.i)?n.i:[],r=n.tr.map((u,a)=>{if(!Array.isArray(u.n))throw new Error(`Track ${a} missing \`n\` (notes) array.`);const d=u.n.map(([f,m,y])=>({pitch:f,start:m,duration:y})),h=i[a]||"sf2/fluidr3-gm/acoustic_grand_piano";return{notes:d,instrument:h,config:{}}});return{globalConfig:o,tracks:r}}async function nl(e){var m;const t=await e.arrayBuffer(),n=new Zo.Midi(t),o=n.header.tempos[0],i=n.header.timeSignatures[0],r=(o==null?void 0:o.bpm)??120,s=((m=i==null?void 0:i.timeSignature)==null?void 0:m[0])??4,l=Math.max(0,...n.tracks.flatMap(y=>y.notes.map(p=>p.time+p.duration)))*(r/60),u=Math.ceil(l/s)||8,a={bpm:r,beatsPerMeasure:s,totalMeasures:u},d=await gc();console.log(`[MIDI] Available drum machines: ${d.join(", ")}`);const h=d.includes("LM-2")?"LM-2":d[0]??"TR-808",f=n.tracks.map(y=>{const p=y.notes.map(b=>({pitch:b.name,start:b.time*(r/60),duration:b.duration*(r/60)}));let g=y.instrument.number;(g===void 0||g===0)&&(y.channel===9?g=0:g=y.channel%128);const v=ei[g]||"acoustic_grand_piano",w=y.channel===9?`sf2/drummachines/${h}`:`sf2/fluidr3-gm/${v}`;return{notes:p,instrument:w,config:{}}});return{globalConfig:a,tracks:f}}function rl(){for(const e of B){const t=e.container;if(!t)continue;const n=t.querySelector(".sequencer-body"),o=t.querySelector("canvas.mini-contour"),i=t.querySelector(".collapse-btn use");!n||!o||n.classList.contains("hidden")||(n.classList.add("hidden"),o.classList.remove("hidden"),i==null||i.setAttribute("href","#icon-caret-up"),Nt(t,!1),Pt(o,e.notes,e.config,e.colorIndex))}}let me=null,en=null;function ol(e){en=e,me=en.getContext("2d")}function tt(e){if(!me||!en)return;const{width:t,height:n}=en;me.clearRect(0,0,t,n);const o=Math.round(e)+.5;me.strokeStyle="#ff00ff",me.lineWidth=1,me.beginPath(),me.moveTo(o,0),me.lineTo(o,n),me.stroke()}function Wr(e,t){xn(t.bpm),$n(t.beatsPerMeasure),Hn(t.totalMeasures);const n=document.getElementById("tempo-input");n&&(n.value=String(He()));const o=document.getElementById("measures-input");o&&(o.value=String(Tt())),ea();for(const[r,s]of e.entries()){const c=r,l=s.instrument||"sf2/fluidr3-gm/acoustic_grand_piano",u=s.notes||[];G({type:"CREATE_SEQUENCER",id:c,instrument:l,notes:structuredClone(u),config:s.config||{}},An(c))}G(qn("Session Loaded"),oo("Session Loaded")),rl();const i=document.getElementById("global-mini-contour");i&&Gi(i,B),we(0),tt(0)}function il(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),o=document.getElementById("triplet-note-btn");let i=!1,r=!1;function s(l){let u=l;i?u=l*1.5:r&&(u=l*(2/3));let a=Array.from(t.options).find(d=>Math.abs(parseFloat(d.value)-u)<1e-4);a||(a=new Option(u.toString(),u.toString()),t.add(a)),t.value=a.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(l=>{l.addEventListener("click",()=>{e.forEach(a=>a.classList.remove("bg-purple-600")),l.classList.add("bg-purple-600");const u=parseFloat(l.dataset.value);s(u)})}),n.addEventListener("click",()=>{r&&(r=!1,o.classList.remove("bg-purple-600")),i=!i,n.classList.toggle("bg-purple-600"),c()}),o.addEventListener("click",()=>{i&&(i=!1,n.classList.remove("bg-purple-600")),r=!r,o.classList.toggle("bg-purple-600"),J.isTripletMode=r,B.forEach(l=>{l.config.isTripletMode=r}),c()});function c(){const l=document.querySelector(".note-duration-btn.bg-purple-600");if(l){const u=parseFloat(l.dataset.value);s(u)}}s(J.currentDuration||1)}let tn=!1,Ie=null,Bn=null,Ln=!1;function sl(e,t){Ie=e,Bn=t,Ie.addEventListener("mousedown",al),window.addEventListener("mousemove",cl),window.addEventListener("mouseup",ll)}function al(e){bs()&&(lo(),B.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),Ln=!0),tn=!0,ti(e)}function cl(e){tn&&ti(e)}function ll(){tn&&(tn=!1,Ln&&(uo(),B.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),Ln=!1))}function ti(e){if(!Ie||!Bn)return;const t=Ie.getBoundingClientRect(),n=Ie.width/t.width;let o=(e.clientX-t.left)*n;o=Math.max(0,Math.min(Ie.width,o));const i=z(),r=o/Ie.width*i,s=Jr(r,Bn),c=s/i*Ie.width;we(s),tt(c)}const tr={maxBeatsContext:32,extendBeatsAmount:16};function Sl(){return tr.maxBeatsContext}function kl(){return tr.extendBeatsAmount}function Fn(e,t,n,o){const i=z(),r=o/i*t;e.clearRect(0,0,t,n);const s=tr.maxBeatsContext,l=Math.max(0,o-s)/i*t,u=r-l;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(l,0,u,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(r,0),e.lineTo(r,n),e.stroke()}let Kr=!1,vn=!1,kt=0;function Il(){return kt}function Xr(){if(!Kr){Kr=!0;const o=document.getElementById("extend-use-tags"),i=document.getElementById("extend-tags");if(o&&i){let u=function(){const h=a.checked;d.disabled=!h,d.classList.toggle("opacity-50",!h),d.classList.toggle("cursor-not-allowed",!h)};const a=o,d=i;u(),a.addEventListener("change",u)}const r=document.getElementById("extend-start-help-btn"),s=document.getElementById("extend-start-help-popup"),c=document.getElementById("extend-start-help-close");r&&s&&c&&(r.addEventListener("click",()=>s.classList.remove("hidden")),c.addEventListener("click",()=>s.classList.add("hidden")),document.addEventListener("click",u=>{u.target instanceof Node&&!s.contains(u.target)&&u.target!==r&&s.classList.add("hidden")}));const l=document.querySelector("#ai-extend-modal .generate-btn");l&&l.addEventListener("click",async()=>{const{extendTracksWithAI:u}=await hi(async()=>{const{extendTracksWithAI:a}=await import("./extendTracks-DV34HA7T.js");return{extendTracksWithAI:a}},__vite__mapDeps([0,1]));await u()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",Te().forEach((i,r)=>{const s=`extend-track-${r}`,c=document.createElement("div");c.className="flex items-center gap-2";const l=document.createElement("input");l.type="checkbox",l.id=s,l.dataset.index=r.toString(),l.checked=!0,l.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const u=document.createElement("label");u.htmlFor=s,u.className="text-sm text-gray-200",u.textContent=i.config.name||`Track ${r+1}`,l.addEventListener("change",()=>{bt()}),c.appendChild(l),c.appendChild(u),e.appendChild(c)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(i=>i.checked=!0),bt()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(i=>i.checked=!1),bt()}),bt())}function ul(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d");if(!n)return;const o=e.clientWidth,i=e.clientHeight;e.width=o,e.height=i,t.width=o,t.height=i,bt(),Fn(n,o,i,kt),t.addEventListener("mousedown",s=>{vn=!0,r(s.offsetX)}),window.addEventListener("mouseup",()=>{vn=!1}),window.addEventListener("mousemove",s=>{if(!vn)return;const c=t.getBoundingClientRect();r(s.clientX-c.left)});function r(s){if(!n)return;const c=z(),l=Math.max(0,Math.min(s,o));kt=Math.round(l/o*c),Fn(n,o,i,kt)}}function bt(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d");if(!n)return;const o=t.width,i=t.height,r=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),s=Array.from(r).filter(l=>l.checked).map(l=>parseInt(l.dataset.index||"0",10)),c=Te().filter((l,u)=>s.includes(u));ne(e,c),Fn(n,o,i,kt)}function dl(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),o=document.getElementById("note-duration-controls"),i=document.getElementById("select-mode-controls"),r=document.getElementById("velocity-mode-controls");if(!e||!t||!n||!o||!i||!r){console.error("Missing essential UI elements for edit mode switching.");return}function s(l){[e,t,n].forEach(u=>{u&&(u.classList.remove("bg-purple-600"),u.classList.add("bg-gray-800"))}),l.classList.remove("bg-gray-800"),l.classList.add("bg-purple-600")}function c(l){[o,i,r].forEach(u=>{u&&u.classList.add("hidden")}),l.classList.remove("hidden")}e.addEventListener("click",()=>{s(e),c(o),ie("note-placement")}),t.addEventListener("click",()=>{s(t),c(i),ie("select")}),n.addEventListener("click",()=>{s(n),c(r),ie("none")}),window.addEventListener("keydown",l=>{var d;const u=(d=document.activeElement)==null?void 0:d.tagName;if(!(u==="INPUT"||u==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(l.key.toLowerCase()){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),s(e),c(o),ie("note-placement")}function fl(){var h,f,m;const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),o=document.getElementById("ai-control-panel");if(!e||!t||!n||!o){console.error("Missing essential elements for control mode switching.");return}function i(){document.querySelectorAll(".sequencer").forEach(y=>{const p=y.querySelector(".delete-btn"),g=y.querySelector(".collapse-btn"),v=g==null?void 0:g.querySelector("use"),w=y.querySelector(".sequencer-body"),b=y.querySelector(".mini-contour");!p||!g||!v||!w||!b||(p.classList.add("button-locked"),g.classList.add("button-locked"),Nt(y,!1),w.classList.contains("hidden")||(w.classList.add("hidden"),b.classList.remove("hidden"),v.setAttribute("href","#icon-caret-up")))})}function r(){document.querySelectorAll(".sequencer").forEach(y=>{const p=y.querySelector(".delete-btn"),g=y.querySelector(".collapse-btn");p==null||p.classList.remove("button-locked"),g==null||g.classList.remove("button-locked")})}function s(){!e||!t||!n||!o||(e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),o.classList.add("hidden"),r())}function c(){if(!wn()){const y=document.getElementById("openai-key-not-set-modal");y==null||y.classList.remove("hidden");return}!e||!t||!n||!o||(t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),o.classList.remove("hidden"),i())}e.addEventListener("click",s),t.addEventListener("click",c);const l=document.getElementById("ai-inpaint-modal"),u=document.getElementById("ai-extend-modal"),a=document.getElementById("ai-generate-modal");function d(y){if(!y)return;const p=y.querySelector(".cancel-btn");p==null||p.addEventListener("click",()=>{y.classList.add("hidden")})}d(l),d(u),d(a),Xr(),(h=document.getElementById("ai-inpaint-btn"))==null||h.addEventListener("click",()=>{l==null||l.classList.remove("hidden")}),(f=document.getElementById("ai-extend-btn"))==null||f.addEventListener("click",()=>{u==null||u.classList.remove("hidden"),ul(),Xr()}),(m=document.getElementById("ai-generate-btn"))==null||m.addEventListener("click",()=>{a==null||a.classList.remove("hidden")}),dl()}function ni(){const e=Vn();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(G(On(t.sequencer.id,n),Rn(t.sequencer.id,n)),et()&&(Ze(),ie(Ee.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function ri(){console.log("performCopy called");const e=Vn();if(!e)return;const t=e.getSelectedNotes();t.length!==0&&mo(t)}function oi(){const e=Vn();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(mo(n),G(Yi(t.sequencer.id,n),Ji(t.sequencer.id,n)),et()&&(Ze(),ie(Ee.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function ii(){if(console.log("performPaste called"),!kn().notes.length){console.log("No notes in clipboard");return}document.body.style.cursor="crosshair",Cs((t,n)=>{const o=t.gridContext,{x:i,y:r}=o.getCanvasPos(n),s=o.getSnappedBeatFromX(i),c=o.getPitchFromRow(Math.floor(r/o.getCellHeight())),l=L(c);if(l===null)return;const{notes:u,anchorBeat:a,anchorMidi:d}=kn(),h=s-a,f=l-d,m=u.map(y=>{const p=L(y.pitch);return p===null?{...y}:{pitch:Me(p+f)??y.pitch,start:y.start+h,duration:y.duration}});G(Zi(o.sequencer.id,m),es(o.sequencer.id,m)),et()&&(Ze(),ie(Ee.NOTE_PLACEMENT)),o.setSelectedNotes(m),document.body.style.cursor="default",Gn()})}function hl(){document.addEventListener("keydown",e=>{const n=navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey,o=document.activeElement,i=o instanceof HTMLElement?o.tagName:null;if(!(i==="INPUT"||i==="TEXTAREA"))switch(!0){case(n&&e.key==="c"):e.preventDefault(),ri();break;case(n&&e.key==="x"):e.preventDefault(),oi();break;case(n&&e.key==="v"):e.preventDefault(),ii();break;case e.key==="Delete":e.preventDefault(),ni();break}})}function pl(){const e=document.querySelector(".select-mode-copy");e&&(e.onclick=ri);const t=document.querySelector(".select-mode-cut");t&&(t.onclick=oi);const n=document.querySelector(".select-mode-paste");n&&(n.onclick=ii);const o=document.querySelector(".select-mode-delete");o&&(o.onclick=ni),hl()}function ml(e,t){return e!==void 0&&t!==void 0&&e===t}function gl(e=it()){var n,o,i;xn(e.tempo,!1),$n(e.timeSignature[0],!1),Hn(e.totalMeasures,!1);for(const r of B)r.updateTotalMeasures();for(const r of e.sequencers){const s=B.find(c=>ml(c.id,r.id));if(s){s.instrumentName=r.instrument;const c=(n=s.container)==null?void 0:n.querySelector("canvas.mini-contour");c&&Pt(c,s.notes,s.config,s.colorIndex);const l=(o=s.grid)==null?void 0:o.gridContext;if(l){const u=l.getSelectedNotes?l.getSelectedNotes():[],a=l.getSelectedNote?l.getSelectedNote():null,d=u.map(h=>({pitch:h.pitch,start:h.start,duration:h.duration}));if(l.notes.length=0,l.notes.push(...structuredClone(r.notes)),u.length>0){const h=d.map(f=>l.notes.find(m=>m.pitch===f.pitch&&m.start===f.start&&m.duration===f.duration)).filter(Boolean);h.length>0&&(l.setSelectedNotes(h),a&&h.length===1&&l.setSelectedNote(h[0]))}(i=s.grid)==null||i.scheduleRedraw()}}else{const c={id:r.id,instrument:r.instrument,notes:structuredClone(r.notes)},{wrapper:l}=Co(c),u=l.querySelector(".sequencer");u&&Nt(u,!0)}}const t=document.getElementById("global-mini-contour");t&&ne(t,B)}as(gl);Xs();function yl(){const e=document.getElementById("global-mini-contour");e&&ne(e,B)}document.getElementById("global-mini-contour");const nr=document.getElementById("global-mini-playhead");ol(nr);sl(nr,J);tt(0);const Vr=0,bl="sf2/fluidr3-gm/acoustic_grand_piano";G(no(Vr,bl),An(Vr));const vl=document.getElementById("piano");Fc(vl);const wl=document.getElementById("waveform"),El=document.getElementById("visualizer-mode");Oc(wl,El);G(qn("Initial App State"),oo("Initial App State"));pl();yl();ta();il();fl();Rc();sa({getSequencers:()=>B,onPlay:()=>{Jt();const e=z(),t=Yt();ys(He(),{loop:J.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{B.forEach(n=>{var o;return(o=n.onTransportLoop)==null?void 0:o.call(n)})}}),_n(n=>{const o=n/e*nr.width;tt(o)}),B.forEach(n=>n.play()),ms(()=>{aa(),we(0),tt(0)})},onPause:()=>{lo(),B.forEach(e=>e.pause())},onResume:()=>{uo(),B.forEach(e=>e.resume())},onStop:()=>{Jt(),we(0),B.forEach(e=>e.stop()),tt(0)},onDurationChange:e=>{J.currentDuration=e,B.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{J.snapResolution=e,B.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{J.loopEnabled=e,B.forEach(t=>t.config.loopEnabled=e),ps(e)},onTempoChange:e=>{xn(e)},onSave:async e=>{const t=it();if(e==="json"){const{url:n,filename:o}=Dc(t),i=document.createElement("a");i.href=n,i.download=o,i.click(),URL.revokeObjectURL(n)}else if(e==="wav"){const n={globalConfig:{bpm:t.tempo,beatsPerMeasure:t.timeSignature[0],totalMeasures:t.totalMeasures},tracks:B.map(o=>({notes:o.notes,instrument:o.instrumentName,config:o.config}))};await qc(n)}else if(e==="midi"){const{url:n,filename:o}=await el(t),i=document.createElement("a");i.href=n,i.download=o,i.click(),URL.revokeObjectURL(n)}},onLoad:async e=>{var t;try{const n=(t=e.name.split(".").pop())==null?void 0:t.toLowerCase();if(n==="json"){const{tracks:o,globalConfig:i}=await tl(e);await Wr(o,i)}else if(n==="mid"||n==="midi"){const{tracks:o,globalConfig:i}=await nl(e);await Wr(o,i)}else throw new Error("Unsupported file type.")}catch(n){n instanceof Error?alert("Failed to load file: "+n.message):alert("Failed to load file: Unknown error")}},onMeasuresChange:e=>{Hn(e);const t=document.getElementById("global-mini-contour");t&&ne(t,B)},onBeatsPerMeasureChange:e=>{$n(e);const t=document.getElementById("global-mini-contour");t&&ne(t,B)}});const Pl=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{ur as a,Te as b,Il as c,Sl as d,kl as e,Ct as f,wn as g,Pt as h,ne as i,Pl as m,Hn as u};
