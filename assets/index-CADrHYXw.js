import{g as tr,S as In,a as Rn,M as Pn,D as On,b as Fn,c as Dn,d as Un,e as qn,f as Kn,i as $n,h as zn,P as ir,z as Ie,Z as T,m as Hn,O as Jn,j as sr}from"./vendor-CYgQJ7h-.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function Wn(){return new Date().toISOString()}function Rt(i,e=3){var s,n;if(i===null||typeof i!="object")return i;if(e<=0){const r=((s=i.constructor)==null?void 0:s.name)||"Object",a=Object.keys(i).length;return`[${r} object, ${a} keys]`}if(Array.isArray(i))return i.length>10?[...i.slice(0,10).map(r=>Rt(r,e-1)),`...(${i.length} total)`]:i.map(r=>Rt(r,e-1));const t={_type:((n=i.constructor)==null?void 0:n.name)||"Object"};for(const r in i){if(!Object.prototype.hasOwnProperty.call(i,r))continue;const a=i[r];if(a instanceof HTMLElement)t[r]=`[HTMLElement: ${a.tagName}]`;else if(a instanceof AudioContext||a instanceof AudioNode)t[r]="[AudioNode]";else if(typeof a=="function")t[r]="[Function]";else if(typeof a=="object"){const l=Object.keys(a).length>3?e-1:e;t[r]=Rt(a,l)}else t[r]=a}return t}function jn(i){try{const e=Rt(i,3);return JSON.stringify(e,null,2)}catch(e){return JSON.stringify({error:"Could not serialize log payload",reason:e.message,type:typeof i},null,2)}}function rr(i,e,t="log"){const n={timestamp:Wn(),level:t,message:i};e!==void 0&&(n.data=e);const r=jn(n);switch(t){case"warn":console.warn(r);break;case"error":console.error(r);break;case"info":console.info(r);break;case"debug":console.debug(r);break;case"log":default:console.log(r);break}}const Ii="SEQUENZIA_DEV";let gt=!1;typeof window<"u"&&(gt=localStorage.getItem(Ii)==="true");function us(){gt=!0,typeof window<"u"&&localStorage.setItem(Ii,"true")}function Xn(){gt=!1,typeof window<"u"&&localStorage.removeItem(Ii)}function ii(){return gt}function E(i,e,t="log"){gt&&rr(i,e,t)}const Ni={ShowHotkeys:{code:"Backquote"},Undo:[{code:"KeyZ",ctrl:!0},{code:"KeyZ",meta:!0}],Redo:[{code:"KeyY",ctrl:!0},{code:"KeyY",meta:!0}],PasteNotes:[{code:"KeyV",ctrl:!0},{code:"KeyV",meta:!0}],CopyNotes:[{code:"KeyC",ctrl:!0},{code:"KeyC",meta:!0}],CutNotes:[{code:"KeyX",ctrl:!0},{code:"KeyX",meta:!0}],DeleteNotes:{code:"Delete"},ToggleVelocityTool:{code:"KeyV",shift:!0},ToggleQuantizeTool:{code:"KeyQ",shift:!0},ToggleTransposeTool:{code:"KeyT",shift:!0},ToggleChordifyTool:{code:"KeyC",shift:!0},ToggleHumanizeTool:{code:"KeyH",shift:!0},TransportPlay:{code:"Space"},TransportStop:{code:"Space",shift:!0},SeekBackward:{code:"KeyA",shift:!0},SeekForward:{code:"KeyD",shift:!0},SeekMeasureBack:{code:"KeyS",shift:!0},SeekMeasureForward:{code:"KeyW",shift:!0},ApplyDuration1:{code:"Digit1"},ApplyDuration2:{code:"Digit2"},ApplyDuration3:{code:"Digit3"},ApplyDuration4:{code:"Digit4"},ApplyDuration5:{code:"Digit5"},ApplyDuration6:{code:"Digit6"},ApplySnap1:{code:"Digit1",shift:!0},ApplySnap2:{code:"Digit2",shift:!0},ApplySnap3:{code:"Digit3",shift:!0},ApplySnap4:{code:"Digit4",shift:!0},ApplySnap5:{code:"Digit5",shift:!0},ApplySnap6:{code:"Digit6",shift:!0},ToggleDottedNotes:{code:"Period"},ToggleTripletNotes:{code:"Slash"},AIStartAutocomplete:{code:"KeyG"},ToggleAIMode:{code:"KeyG",shift:!0},ApproveAutocomplete:{code:"Tab"},RejectAutocomplete:{code:"Tab",shift:!0},AIToolsMenu:{code:"KeyT"},AIExtendBefore:{code:"KeyY"},AIPaint:{code:"KeyU"},AIExtendAfter:{code:"KeyI"},AIAdjustPrompt:{code:"KeyO"},AIDebugger:{code:"KeyP"},SwitchToNoteMode:{code:"KeyQ"},SwitchToAIMode:{code:"KeyW"}};function Ri(){return typeof window<"u"&&typeof localStorage<"u"}function bt(i,e){Ri()&&localStorage.setItem(i,JSON.stringify(e))}function Qe(i){if(!Ri())return null;const e=localStorage.getItem(i);if(!e)return null;try{return JSON.parse(e)}catch(t){return console.error(`Error parsing localStorage key "${i}":`,t),null}}function Vn(i){Ri()&&localStorage.removeItem(i)}const Pi="userKeyMacroBindings",et=structuredClone(Ni);function Oi(i){return et[i]}function Yn(i,e){console.debug("[KeyMacroStore] Updated macro:",i,"→",e),et[i]=e,Qn()}function Zn(){console.debug("[KeyMacroStore] Resetting all macros to defaults."),Object.keys(Ni).forEach(i=>{et[i]=structuredClone(Ni[i])}),Vn(Pi)}function hs(){return et}function Qn(){bt(Pi,et)}function ea(){const i=Qe(Pi);i&&(console.debug("[KeyMacroStore] Loaded user bindings from localStorage."),Object.keys(i).forEach(e=>{et[e]=i[e]}))}function ta(i,e){return i.code===e.code&&!!i.ctrlKey==!!e.ctrl&&!!i.shiftKey==!!e.shift&&!!i.altKey==!!e.alt&&!!i.metaKey==!!e.meta}function q(i,e){const t=Oi(e),s=Array.isArray(t)?t:[t];for(const n of s)if(ta(i,n))return console.debug("[matchesMacro] Matched macro:",e,"with event:",i,"→ binding:",n),!0;return!1}const Z=class Z{static subscribe(e,t){this.subscribers.add({instance:e,contentEl:t}),this.initGlobalListeners()}static unsubscribe(e){this.subscribers.forEach(t=>{t.instance===e&&this.subscribers.delete(t)})}static getSubscribers(){return this.subscribers}static showAll(){this.subscribers.forEach(e=>e.instance.show())}static hideAll(){this.subscribers.forEach(e=>e.instance.hide())}static toggleAll(){this.subscribers.forEach(e=>e.instance.toggle())}static clear(){this.subscribers.clear()}static destroyAll(){this.subscribers.forEach(e=>{e.instance.hide(),e.contentEl.parentNode&&e.contentEl.parentNode.removeChild(e.contentEl)}),this.clear()}static initGlobalListeners(){this.listenersInitialized||(console.log("Global listeners initialized"),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp),this.listenersInitialized=!0)}static detachGlobalListeners(){this.listenersInitialized&&(document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.listenersInitialized=!1)}};Z.subscribers=new Set,Z.altKeyDown=!1,Z.listenersInitialized=!1,Z.handleKeyDown=e=>{Z.altKeyDown||q(e,"ShowHotkeys")&&!Z.altKeyDown&&(Z.altKeyDown=!0,Z.showAll())},Z.handleKeyUp=e=>{Z.altKeyDown&&q(e,"ShowHotkeys")&&(Z.altKeyDown=!1,Z.hideAll())};let ue=Z;class Ne{constructor(){this.reloadCallbacks=[]}static getInstance(){return Ne.instance||(Ne.instance=new Ne),Ne.instance}registerReloadable(e){this.reloadCallbacks.push(e)}unregisterReloadable(e){this.reloadCallbacks=this.reloadCallbacks.filter(t=>t!==e)}reloadAll(){ue.destroyAll(),this.reloadCallbacks.forEach(e=>e())}}function ia(){const i=document.getElementById("splash-modal");return i?!i.classList.contains("hidden"):!1}function nr(i){const e=[];for(const t of i)Array.isArray(t)?e.push(...nr(t)):t!=null&&t!==!1&&e.push(t);return e}function y(i,e={},...t){const s=document.createElement(i);for(const[r,a]of Object.entries(e))if(!(a==null||a===!1))if(r==="class"||r==="className")s.className=a;else if(r==="style"&&typeof a=="object")for(const[o,l]of Object.entries(a))l!=null&&(s.style[o]=l);else if(r==="dataset"&&typeof a=="object")for(const[o,l]of Object.entries(a))s.dataset[o]=String(l);else r.startsWith("data-")?s.setAttribute(r,String(a)):r.startsWith("on")&&typeof a=="function"?s.addEventListener(r.slice(2).toLowerCase(),a):r in s?s[r]=a:s.setAttribute(r,String(a));const n=nr(t);for(const r of n)s.appendChild(typeof r=="string"?document.createTextNode(r):r);return s}const sa={global:{noteToolMode:"express"},theme:{gridColorScheme:"Darkroom",noteColorScheme:"Track Color",skin:"Default"},ai:{openaiApiKey:"",openaiModel:"gpt-4o",indicatorEnabled:!1}},ar={name:"Default",appBackground:"bg-black",menuBackground:"bg-gradient-to-br from-gray-800 to-gray-900",surfaceBackground:"bg-gray-900",accentColor:"bg-purple-700",textColor:"text-white",borderColor:"border-purple-950",buttonPrimaryColor:"bg-purple-700",buttonPrimaryColorHover:"hover:bg-purple-600",buttonSecondaryColor:"bg-gray-800",buttonSecondaryColorHover:"hover:bg-gray-700",buttonTertiaryColor:"bg-blue-700",buttonTertiaryColorHover:"hover:bg-blue-600",toggleTrackBase:"bg-gray-700",toggleTrackChecked:"peer-checked:bg-purple-600",toggleKnobBase:"after:border-gray-300",toggleKnobChecked:"peer-checked:after:border-white",blackKeyColor:"#a6a09b",whiteKeyColor:"#292524",volumeGradientFrom:"from-purple-600",volumeGradientTo:"to-purple-400",volumeThumbColor:"bg-purple-500",panGradientFrom:"from-indigo-600",panGradientTo:"to-indigo-400",panThumbColor:"bg-indigo-500",snapMarkerColor:"bg-purple-300/50"},ra={name:"Blue Dream",appBackground:"bg-gradient-to-b from-blue-900 to-gray-900",menuBackground:"bg-gradient-to-br from-blue-800 to-blue-900",surfaceBackground:"bg-blue-950/80",accentColor:"bg-cyan-400",textColor:"text-white",borderColor:"border-cyan-400",buttonPrimaryColor:"bg-cyan-600",buttonPrimaryColorHover:"hover:bg-cyan-500",buttonSecondaryColor:"bg-blue-800",buttonSecondaryColorHover:"hover:bg-blue-700",buttonTertiaryColor:"bg-indigo-600",buttonTertiaryColorHover:"hover:bg-indigo-500",toggleTrackBase:"bg-blue-700",toggleTrackChecked:"peer-checked:bg-cyan-400",toggleKnobBase:"after:border-blue-300",toggleKnobChecked:"peer-checked:after:border-white",blackKeyColor:"#1b1f5f",whiteKeyColor:"#c0e7ff",volumeGradientFrom:"from-cyan-500",volumeGradientTo:"to-cyan-300",volumeThumbColor:"bg-cyan-400",panGradientFrom:"from-indigo-500",panGradientTo:"to-indigo-300",panThumbColor:"bg-indigo-400",snapMarkerColor:"bg-cyan-400/50"},na={name:"Modern Light",appBackground:"bg-white",menuBackground:"bg-gray-100",surfaceBackground:"bg-gray-200",accentColor:"bg-blue-600",textColor:"text-gray-900",borderColor:"border-blue-600",buttonPrimaryColor:"bg-blue-600",buttonPrimaryColorHover:"hover:bg-blue-500",buttonSecondaryColor:"bg-gray-200",buttonSecondaryColorHover:"hover:bg-gray-300",buttonTertiaryColor:"bg-gray-300",buttonTertiaryColorHover:"hover:bg-gray-400",toggleTrackBase:"bg-gray-300",toggleTrackChecked:"peer-checked:bg-blue-600",toggleKnobBase:"after:border-gray-400",toggleKnobChecked:"peer-checked:after:border-white",blackKeyColor:"#111111",whiteKeyColor:"#ffffff",volumeGradientFrom:"from-blue-500",volumeGradientTo:"to-blue-300",volumeThumbColor:"bg-blue-400",panGradientFrom:"from-sky-500",panGradientTo:"to-sky-300",panThumbColor:"bg-sky-400",snapMarkerColor:"bg-blue-400/50"},aa={name:"Synthwave",appBackground:"bg-gradient-to-br from-black via-gray-900 to-purple-950",menuBackground:"bg-gradient-to-br from-purple-800 to-pink-900",surfaceBackground:"bg-gray-900/80",accentColor:"bg-fuchsia-500",textColor:"text-neon-green",borderColor:"border-fuchsia-500",buttonPrimaryColor:"bg-pink-700",buttonPrimaryColorHover:"hover:bg-pink-600",buttonSecondaryColor:"bg-purple-800",buttonSecondaryColorHover:"hover:bg-purple-700",buttonTertiaryColor:"bg-gray-800",buttonTertiaryColorHover:"hover:bg-gray-700",toggleTrackBase:"bg-pink-800",toggleTrackChecked:"peer-checked:bg-fuchsia-500",toggleKnobBase:"after:border-pink-400",toggleKnobChecked:"peer-checked:after:border-white",blackKeyColor:"#d946ef",whiteKeyColor:"#f5d0fe",volumeGradientFrom:"from-fuchsia-500",volumeGradientTo:"to-pink-400",volumeThumbColor:"bg-fuchsia-400",panGradientFrom:"from-purple-600",panGradientTo:"to-purple-400",panThumbColor:"bg-purple-500",snapMarkerColor:"bg-fuchsia-300/50"},oa={name:"Verdant Alloy",appBackground:"bg-gradient-to-b from-gray-900 to-green-950",menuBackground:"bg-gradient-to-tr from-emerald-800 to-lime-700",surfaceBackground:"bg-emerald-950/70",accentColor:"bg-lime-400",textColor:"text-lime-100",borderColor:"border-lime-400",buttonPrimaryColor:"bg-emerald-600",buttonPrimaryColorHover:"hover:bg-emerald-500",buttonSecondaryColor:"bg-lime-700",buttonSecondaryColorHover:"hover:bg-lime-600",buttonTertiaryColor:"bg-gray-700",buttonTertiaryColorHover:"hover:bg-gray-600",toggleTrackBase:"bg-emerald-700",toggleTrackChecked:"peer-checked:bg-lime-400",toggleKnobBase:"after:border-lime-300",toggleKnobChecked:"peer-checked:after:border-white",blackKeyColor:"#143016",whiteKeyColor:"#dbf4dc",volumeGradientFrom:"from-emerald-500",volumeGradientTo:"to-emerald-300",volumeThumbColor:"bg-emerald-400",panGradientFrom:"from-lime-500",panGradientTo:"to-lime-300",panThumbColor:"bg-lime-400",snapMarkerColor:"bg-lime-300/50"},la={name:"Sunset",appBackground:"bg-gradient-to-br from-orange-900 via-red-800 to-purple-900",menuBackground:"bg-gradient-to-bl from-rose-800 to-orange-700",surfaceBackground:"bg-orange-950/70",accentColor:"bg-yellow-400",textColor:"text-yellow-100",borderColor:"border-yellow-400",buttonPrimaryColor:"bg-amber-600",buttonPrimaryColorHover:"hover:bg-amber-500",buttonSecondaryColor:"bg-red-700",buttonSecondaryColorHover:"hover:bg-red-600",buttonTertiaryColor:"bg-purple-700",buttonTertiaryColorHover:"hover:bg-purple-600",toggleTrackBase:"bg-red-700",toggleTrackChecked:"peer-checked:bg-yellow-400",toggleKnobBase:"after:border-orange-300",toggleKnobChecked:"peer-checked:after:border-white",blackKeyColor:"#45122c",whiteKeyColor:"#fff3e0",volumeGradientFrom:"from-amber-500",volumeGradientTo:"to-amber-300",volumeThumbColor:"bg-amber-400",panGradientFrom:"from-rose-500",panGradientTo:"to-rose-300",panThumbColor:"bg-rose-400",snapMarkerColor:"bg-amber-300/50"},ca={Default:ar,"Blue Dream":ra,"Modern Light":na,Synthwave:aa,"Verdant Alloy":oa,Sunset:la};function da(i){return ca[i]||ar}const tt=structuredClone(sa);tt.theme.skin;function V(){return tt}function or(){return tt.ai.openaiApiKey}function _t(){return tt.ai.indicatorEnabled}function U(){return da(tt.theme.skin)}function re(i){lr(tt,i);try{const e=J();if(e.length>0)for(const t of e)t.redraw()}catch(e){console.warn("[updateUserConfig] Skipped sequencer UI refresh (store not ready yet).",e)}}function lr(i,e){for(const t in e)e[t]&&typeof e[t]=="object"&&!Array.isArray(e[t])?(i[t]||(i[t]={}),lr(i[t],e[t])):i[t]=e[t]}const ua={sm:{widthClass:"w-[300px]",maxWidthClass:"max-w-sm"},md:{widthClass:"w-[500px]",maxWidthClass:"max-w-md"},lg:{widthClass:"w-[700px]",maxWidthClass:"max-w-lg"},xl:{widthClass:"w-[900px]",maxWidthClass:"max-w-xl"},full:{widthClass:"w-full",maxWidthClass:"max-w-full"}};function he(i,e,t={}){const s=U(),n=t.sizePreset?ua[t.sizePreset]:void 0,r=t.widthClass||(n==null?void 0:n.widthClass)||"w-[500px]",a=t.maxWidthClass||(n==null?void 0:n.maxWidthClass)||"max-w-full",o=y("div",{class:"absolute inset-0 rounded-2xl border-2 border-purple-500 opacity-30 blur-xl animate-pulse pointer-events-none"}),l=t.scrollableContent?y("div",{class:"overflow-y-auto overflow-x-hidden max-h-[75vh] w-full flex flex-col gap-6 pr-2"},...Array.isArray(e)?e:[e]):Array.isArray(e)?e:[e],d=y("div",{class:["relative flex flex-col",s.menuBackground,"border border-purple-700 shadow-2xl rounded-2xl","px-10 py-8 animate-fade-in text-white",r,a].join(" ")},o,l);return y("div",{id:i,class:"fixed inset-0 bg-black/70 flex items-center justify-center z-[9999] hidden"},d)}function z({id:i,text:e,kind:t="primary",onClick:s,additionalClasses:n=""}){const r=U(),a={primary:r.buttonPrimaryColor,secondary:r.buttonSecondaryColor,tertiary:r.buttonTertiaryColor}[t],o={primary:r.buttonPrimaryColorHover,secondary:r.buttonSecondaryColorHover,tertiary:r.buttonTertiaryColorHover}[t];return y("button",{id:i,class:["cursor-pointer flex-1 py-2 rounded-lg transition-all text-sm",a,o,r.textColor,n].join(" "),textContent:e,onclick:s})}function ha(){const i=y("div",{class:"absolute inset-0 rounded-2xl border-2 border-purple-500 opacity-30 blur-xl animate-pulse pointer-events-none"}),e=y("h2",{class:"text-xl font-semibold mb-4 text-center tracking-wide z-10",textContent:"Oops!"}),t=y("div",{id:"error-message-content",class:["bg-gray-700 text-gray-100 rounded-xl px-4 py-3 text-sm whitespace-pre-wrap","z-10 max-h-[240px] overflow-y-auto text-center"].join(" ")}),s=z({id:"error-close-btn",text:"Close",kind:"primary",additionalClasses:"mt-8 self-center text-base px-6 py-2 font-medium"});return he("error-modal",[i,e,t,s],{widthClass:"w-[420px]",maxWidthClass:"max-w-full"})}function fa(i){const e=i.querySelector("#error-close-btn"),t=i.querySelector("div.relative"),s=()=>{i.style.opacity="0",i.style.transition="opacity 0.3s ease-out",setTimeout(()=>{i.classList.add("hidden"),i.style.opacity="1"},300)},n=r=>{t&&(t.contains(r.target)||s())};return e==null||e.addEventListener("click",s),i.addEventListener("mousedown",n),{detach:()=>{e==null||e.removeEventListener("click",s),i.removeEventListener("mousedown",n)},refreshUI:()=>{}}}class pa{constructor(){this.detachFn=null,this.modal=ha(),this.messageBox=this.modal.querySelector("#error-message-content"),document.body.appendChild(this.modal);const e=fa(this.modal);this.detachFn=e.detach}show(e){this.messageBox.textContent=e,this.modal.classList.remove("hidden"),this.modal.style.opacity="1"}hide(){this.modal.classList.add("hidden"),this.modal.style.opacity="1"}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function ma(){const i=y("div",{class:"absolute inset-0 rounded-2xl border-2 border-purple-500 opacity-30 blur-xl animate-pulse pointer-events-none"}),e=y("div",{class:"text-[100px] mb-4 z-10 animate-bounce text-center",textContent:"🛠️"}),t=y("div",{class:"text-xl font-semibold text-white z-10 tracking-wide text-center",textContent:"Feature Not Implemented"}),s=y("div",{class:"text-sm text-gray-400 mt-2 z-10 text-center",innerHTML:"This part of Sequenzia is still under construction.<br />Check back soon!"}),n=z({id:"feature-modal-close-btn",text:"Got it",kind:"primary",additionalClasses:"mt-6 self-center z-10 px-6 py-2 text-base"});return he("feature-not-implemented-modal",[i,e,t,s,n],{widthClass:"w-[400px]",maxWidthClass:"max-w-full"})}function ya(i){const e=i.querySelector("#feature-modal-close-btn"),t=i.querySelector("div.relative"),s=()=>{i.style.opacity="0",i.style.transition="opacity 0.3s ease-out",setTimeout(()=>{i.classList.add("hidden"),i.style.opacity="1"},300)},n=r=>{t&&(t.contains(r.target)||s())};return e==null||e.addEventListener("click",s),i.addEventListener("mousedown",n),{detach:()=>{e==null||e.removeEventListener("click",s),i.removeEventListener("mousedown",n)},refreshUI:()=>{}}}class ga{constructor(){this.detachFn=null,this.modal=ma(),document.body.appendChild(this.modal);const e=ya(this.modal);this.detachFn=e.detach}show(){this.modal.classList.remove("hidden"),this.modal.style.opacity="1"}hide(){this.modal.classList.add("hidden"),this.modal.style.opacity="1"}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function ba(){const i=y("div",{class:"absolute inset-0 rounded-2xl border-2 border-purple-500 opacity-30 blur-xl animate-pulse pointer-events-none"}),e=y("div",{class:"flex justify-center items-center space-x-3 mb-6 z-10"},y("div",{class:"w-4 h-4 bg-purple-400 rounded-full animate-bounce",style:"animation-delay: 0s"}),y("div",{class:"w-4 h-4 bg-purple-400 rounded-full animate-bounce",style:"animation-delay: 0.1s"}),y("div",{class:"w-4 h-4 bg-purple-400 rounded-full animate-bounce",style:"animation-delay: 0.2s"})),t=y("div",{id:"loading-modal-title",class:"text-xl font-semibold text-white z-10 tracking-wide text-center",textContent:"Loading Sounds..."}),s=y("div",{id:"loading-modal-subtext",class:"text-sm text-gray-400 mt-2 z-10 text-center",textContent:"Please wait while we dial it in."}),n=y("button",{id:"loading-modal-cancel",class:"cursor-pointer mt-6 z-10 text-sm text-purple-400 hover:text-purple-300 underline hidden",textContent:"Cancel"});return he("loading-modal",[i,e,t,s,n],{widthClass:"w-[360px]",maxWidthClass:"max-w-full"})}function _a(i,e){const t=i.querySelector("#loading-modal-cancel"),s=()=>{e()};return t==null||t.addEventListener("click",s),{detach:()=>{t==null||t.removeEventListener("click",s)},refreshUI:()=>{}}}class va{constructor(e){this.detachFn=null,this.modal=ba(),this.titleEl=this.modal.querySelector("#loading-modal-title"),this.subtextEl=this.modal.querySelector("#loading-modal-subtext"),this.cancelBtn=this.modal.querySelector("#loading-modal-cancel"),document.body.appendChild(this.modal);const t=_a(this.modal,e);this.detachFn=t.detach}show(e){e!=null&&e.title&&(this.titleEl.textContent=e.title),e!=null&&e.subtext&&(this.subtextEl.textContent=e.subtext),this.cancelBtn.classList.toggle("hidden",!(e!=null&&e.cancelable)),this.modal.classList.remove("hidden"),this.modal.style.opacity="1"}hide(){this.modal.classList.add("hidden"),this.modal.style.opacity="1"}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function fe(i){const e=i.startsWith("/")?i.substring(1):i;return(window.location.pathname.startsWith("/sequenzia")?"/sequenzia/":"./")+e}function Sa(){const i=y("div",{class:"mb-8"},y("img",{id:"splash-logo",src:fe("static/svg/sequenzia-logo.svg"),alt:"Sequenzia",class:"w-[300px] h-auto animate-fade-in rounded-xl"})),e=y("div",{class:"flex items-center space-x-2 mb-4"},y("div",{class:"w-3 h-3 bg-blue-500 rounded-full animate-bounce",style:"animation-delay: 0s"}),y("div",{class:"w-3 h-3 bg-blue-500 rounded-full animate-bounce",style:"animation-delay: 0.1s"}),y("div",{class:"w-3 h-3 bg-blue-500 rounded-full animate-bounce",style:"animation-delay: 0.2s"})),t=y("div",{class:"text-white text-xl font-medium"},"Loading Sequenzia ",y("span",{class:"animate-pulse"},"...")),s=y("div",{class:"relative flex flex-col items-center"},i,e,t);return y("div",{id:"splash-modal",class:"fixed inset-0 bg-black/90 flex items-center justify-center z-[9999] hidden"},s)}function Ca(i){return{detach:()=>{},refreshUI:()=>{}}}class Na{constructor(){this.detachFn=null,this.modal=Sa(),document.body.appendChild(this.modal);const e=Ca(this.modal);this.detachFn=e.detach,this.footerMain=document.getElementById("footer-main"),this.contentMain=document.getElementById("content-main"),this.splashLogo=this.modal.querySelector("#splash-logo")}show(){var e,t,s,n;this.splashLogo&&(this.splashLogo.src=fe("static/logo.png")),this.modal.classList.remove("hidden"),this.modal.style.opacity="1",(e=this.footerMain)==null||e.classList.remove("content-visible"),(t=this.footerMain)==null||t.classList.add("content-hidden"),(s=this.contentMain)==null||s.classList.remove("content-visible"),(n=this.contentMain)==null||n.classList.add("content-hidden")}hide(e=1e3){setTimeout(()=>{this.modal.style.opacity="0",this.modal.style.transition="opacity 0.5s ease-out",setTimeout(()=>{var t,s,n,r;this.modal.classList.add("hidden"),this.modal.style.opacity="1",(t=this.footerMain)==null||t.classList.remove("content-hidden"),(s=this.footerMain)==null||s.classList.add("content-visible"),(n=this.contentMain)==null||n.classList.remove("content-hidden"),(r=this.contentMain)==null||r.classList.add("content-visible")},500)},e)}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function wa(){const i=y("h2",{class:"text-lg font-semibold mb-4 text-center",textContent:"API Key Required"}),e=y("p",{class:"mb-6 text-center text-sm",textContent:"In order to use AI Features, you must add an OpenAI API Key in the config."}),t=z({id:"key-not-set-ok",text:"OK",kind:"secondary",additionalClasses:"w-full py-2"}),s=y("div",{class:"bg-gray-800 text-white rounded-lg shadow-xl p-6 w-96 flex flex-col items-center"},i,e,t);return y("div",{id:"openai-key-not-set-modal",class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden"},s)}function Ma(i){const e=i.querySelector("#key-not-set-ok"),t=()=>{i.classList.add("hidden")};return e==null||e.addEventListener("click",t),{detach:()=>{e==null||e.removeEventListener("click",t)},refreshUI:()=>{}}}class xa{constructor(){this.detachFn=null,this.modal=wa(),document.body.appendChild(this.modal);const e=Ma(this.modal);this.detachFn=e.detach}show(){this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function La(){const i=y("div",{class:"absolute inset-0 rounded-2xl border-2 border-purple-500 opacity-30 blur-xl animate-pulse pointer-events-none"}),e=y("div",{class:"text-[100px] mb-6 animate-bounce z-10",textContent:"🤖"}),t=y("div",{class:"flex items-center space-x-3 mb-6 z-10"},y("div",{class:"w-4 h-4 bg-purple-400 rounded-full animate-bounce",style:"animation-delay: 0s"}),y("div",{class:"w-4 h-4 bg-purple-400 rounded-full animate-bounce",style:"animation-delay: 0.1s"}),y("div",{class:"w-4 h-4 bg-purple-400 rounded-full animate-bounce",style:"animation-delay: 0.2s"})),s=y("div",{class:"text-sm text-gray-400 mt-4 z-10 text-center",textContent:"AI is Generating..."}),n=y("div",{class:"relative flex flex-col items-center bg-gradient-to-br from-gray-800 to-gray-900 border border-purple-700 shadow-2xl rounded-2xl px-10 py-8 animate-fade-in w-[360px] max-w-full"},i,e,t,s);return y("div",{id:"ai-working-modal",class:"fixed inset-0 bg-black/70 flex items-center justify-center z-[9999] hidden"},n)}function ka(i){return{detach:()=>{},refreshUI:()=>{}}}class Aa{constructor(){this.detachFn=null,this.modal=La(),document.body.appendChild(this.modal);const e=ka(this.modal);this.detachFn=e.detach}show(){this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function Ba(){const i=y("h2",{class:"text-lg font-semibold mb-4 text-center",textContent:"AI Generation Failed"}),e=y("p",{class:"mb-6 text-center text-sm",textContent:"Unable to generate AI content. Please try again."}),t=z({id:"generation-failed-ok",text:"OK",kind:"secondary",additionalClasses:"w-full py-2"}),s=y("div",{class:"bg-gray-800 text-white rounded-lg shadow-xl p-6 w-96 flex flex-col items-center"},i,e,t);return y("div",{id:"ai-generation-failed-modal",class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"},s)}function Ga(i){const e=i.querySelector("#generation-failed-ok"),t=()=>{i.classList.add("hidden")};return e==null||e.addEventListener("click",t),{detach:()=>{e==null||e.removeEventListener("click",t)},refreshUI:()=>{}}}class Ea{constructor(){this.detachFn=null,this.modal=Ba(),document.body.appendChild(this.modal);const e=Ga(this.modal);this.detachFn=e.detach}show(){this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}class Ta{constructor(e){this.onCancelLoading=e,this.initialize()}initialize(){this.errorModal=new pa,this.featureModal=new ga,this.loadingModal=new va(this.onCancelLoading),this.splashModal=new Na,this.openAIKeyNotSetModal=new xa,this.aiWorkingModal=new Aa,this.aiGenerationFailedModal=new Ea}showError(e){this.errorModal.show(e)}showFeatureBlocked(){this.featureModal.show()}showOpenAIKeyNotSet(){this.openAIKeyNotSetModal.show()}showAIWorking(){this.aiWorkingModal.show()}hideAIWorking(){this.aiWorkingModal.hide()}showAIGenerationFailed(){this.aiGenerationFailedModal.show()}showLoading(e){this.loadingModal.show(e)}hideLoading(){this.loadingModal.hide()}showSplashScreen(){this.splashModal.show()}hideSplashScreen(){this.splashModal.hide()}destroy(){var e,t,s,n,r,a,o;(e=this.errorModal)==null||e.destroy(),(t=this.featureModal)==null||t.destroy(),(s=this.loadingModal)==null||s.destroy(),(n=this.splashModal)==null||n.destroy(),(r=this.openAIKeyNotSetModal)==null||r.destroy(),(a=this.aiWorkingModal)==null||a.destroy(),(o=this.aiGenerationFailedModal)==null||o.destroy()}reload(){this.destroy(),this.initialize()}}let si=null;function Q(){return si||(si=new Ta(()=>{console.warn("User cancelled loading.")})),si}let cr=!1;function ct(i="Loading Sounds...",e="Please wait while we dial it in.",t,s){if(ia()||ur()&&!s)return;s&&(Fi(),dr(!0));const n=Q();n.showLoading({title:i,subtext:e,cancelable:!!t}),t&&(n.destroy(),n.reload())}function Fi(i){i&&dr(!1),ur()||Q().hideLoading()}function dr(i){cr=i}function ur(){return cr}let ut=0;function hr(){ut++,ut===1&&ct()}function fr(){ut--,ut<=0&&(ut=0,Fi())}async function Ia(i){hr();try{return await i}finally{fr()}}const ri=new Map;async function Ra(i,e){e?await i.load:await Ua(i.load)}async function $t(i,e=te(),t=null,s,n,r,a=!0){var C;const o=i.split("/");let l="sf2",d="musyngkite",c="acoustic_grand_piano";o.length===3?[l,d,c]=o:o.length===2?[d,c]=o:o.length===1&&(c=o[0]);const u=e instanceof OfflineAudioContext;ri.has(e)||ri.set(e,new Map);const f=ri.get(e),h=String(e??te()),m=`${d}/${c}@${h}`;if(a&&f.has(m))return f.get(m);const b=Math.max(0,Math.min(127,Math.round((s??1)*127))),g=e.createStereoPanner();n!==void 0&&(g.pan.value=n);const p=e.createGain();p.connect(g),t&&t.context!==e&&(console.warn("[loadInstrument] Ignoring mismatched destination from different context"),t=null),g.connect(t||ze(e));const _={instrument:c,volume:b,destination:p,disableScheduler:u};let S;if(d==="smolken")S=new In(e,_);else if(d==="splendidgrandpiano")S=new Rn(e,_);else if(d==="mallets")S=new Pn(e,_);else if(d==="drummachines")S=new On(e,_);else{const w={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[d.toLowerCase()]||"MusyngKite",k=`https://gleitz.github.io/midi-js-soundfonts/${w}/${c}-ogg.js`;S=new Fn(e,{..._,instrumentUrl:k,kit:w})}if(await Ra(S,r??!1),d==="drummachines"){const N=((C=S.getSampleNames)==null?void 0:C.call(S))??[],w=new Map;N.forEach((L,k)=>{const B=36+k;w.set(B,L)}),S.__midiMap=w}const v=S;return v.setVolume=N=>{var L;const w=Math.max(0,Math.min(127,Math.round(N*127)));"output"in v&&typeof((L=v.output)==null?void 0:L.setVolume)=="function"&&v.output.setVolume(w)},v.setPan=N=>{g.pan.value=Math.max(-1,Math.min(1,N))},a&&f.set(m,v),v}async function Pa(){const e=Oa().map(s=>{switch(s){case"FluidR3_GM":return"fluidr3-gm";case"FatBoy":return"fatboy";case"MusyngKite":return"musyngkite";default:return s.toLowerCase()}}),t=["splendidgrandpiano","mallets","drummachines","smolken"];return[...new Set([...e,...t])]}function Oa(){const e=[...Kn()];return e.includes("FatBoy")||e.push("FatBoy"),e}async function Fa(i){const e=i.toLowerCase();return e==="splendidgrandpiano"?["splendidgrandpiano"]:e==="mallets"?Dn():e==="drummachines"?tr():e==="smolken"?Un():(await $t(`${i}/acoustic_grand_piano`,te(),null,0,0,!0),qn()??[])}function Da(){return tr()}async function Ua(i){hr();try{await i}finally{fr()}}function qa(){return{name:"sf2",loadInstrument:$t,getAvailableLibraries:Pa,getAvailableInstruments:Fa}}let ni=null,Lt=null;function Fe(){return ni||(ni=new AudioContext),ni}function Ka(){if(!Lt){const i=Fe();Lt=i.createGain(),Lt.connect(i.destination)}return Lt}const $a={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function j(i){const e=i==null?void 0:i.match(/^([A-Ga-g])([#b]*)(-?\d+)$/);if(!e)return null;const[,t,s,n]=e,r=t.toUpperCase(),a=$a[r];if(a===void 0)return null;const o=[...s].reduce((d,c)=>c==="#"?d+1:c==="b"?d-1:d,0);return 12*(parseInt(n,10)+1)+(a+o)}let me=null,wi=null;async function za(i){if(wi===i)return;me=await $t(i,Fe()),wi=i}function Ha(){return wi}function Ja(i,e=100,t=!1){var o;if(!me)return null;const n=Fe().currentTime,r=j(i);if(r===null)return null;const a=((o=me.__midiMap)==null?void 0:o.get(r))??r;return me.start({note:a,stopId:a,velocity:e,time:n,loop:t}),()=>{me==null||me.stop({stopId:a})}}function Wa(i){var s;if(!me)return;const e=j(i);if(e===null)return;const t=((s=me.__midiMap)==null?void 0:s.get(e))??e;me.stop({stopId:t})}async function ja(i,e,t,s=100,n=!1,r=null,a=null,o=null,l,d){var m;const c=a||te(),u=await $t(i,c,o,l,d);l!==void 0&&u.setVolume&&u.setVolume(l),d!==void 0&&u.setPan&&u.setPan(d);const f=j(e);if(f===null)return null;const h=((m=u.__midiMap)==null?void 0:m.get(f))??f;return u.start({note:h,duration:t,velocity:s,loop:n,time:r??c.currentTime}),null}function Xa(){return{name:"sf2",setActiveInstrument:za,getActiveInstrumentName:Ha,playNote:Ja,stopNoteByPitch:Wa,loadAndPlayNote:ja}}const pt=[{id:"0000_Aspirin_sf2_file",library:"Aspirin",displayName:"Acoustic Grand Piano"},{id:"0000_Chaos_sf2_file",library:"Chaos",displayName:"Acoustic Grand Piano"},{id:"0000_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Acoustic Grand Piano"},{id:"0000_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Acoustic Grand Piano"},{id:"0000_JCLive_sf2_file",library:"JCLive",displayName:"Acoustic Grand Piano"},{id:"0000_SBLive_sf2",library:"SBLive",displayName:"Acoustic Grand Piano"},{id:"0000_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Acoustic Grand Piano"},{id:"0010_Aspirin_sf2_file",library:"Aspirin",displayName:"Bright Acoustic Piano"},{id:"0010_Chaos_sf2_file",library:"Chaos",displayName:"Bright Acoustic Piano"},{id:"0010_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Bright Acoustic Piano"},{id:"0010_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Bright Acoustic Piano"},{id:"0010_JCLive_sf2_file",library:"JCLive",displayName:"Bright Acoustic Piano"},{id:"0010_SBLive_sf2",library:"SBLive",displayName:"Bright Acoustic Piano"},{id:"0010_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Bright Acoustic Piano"},{id:"0020_Aspirin_sf2_file",library:"Aspirin",displayName:"Electric Grand Piano"},{id:"0020_Chaos_sf2_file",library:"Chaos",displayName:"Electric Grand Piano"},{id:"0020_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Electric Grand Piano"},{id:"0020_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Electric Grand Piano"},{id:"0020_JCLive_sf2_file",library:"JCLive",displayName:"Electric Grand Piano"},{id:"0020_SBLive_sf2",library:"SBLive",displayName:"Electric Grand Piano"},{id:"0020_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Electric Grand Piano"},{id:"0050_Aspirin_sf2_file",library:"Aspirin",displayName:"Electric Piano 2"},{id:"0050_Chaos_sf2_file",library:"Chaos",displayName:"Electric Piano 2"},{id:"0050_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Electric Piano 2"},{id:"0050_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Electric Piano 2"},{id:"0050_JCLive_sf2_file",library:"JCLive",displayName:"Electric Piano 2"},{id:"0050_SBLive_sf2",library:"SBLive",displayName:"Electric Piano 2"},{id:"0050_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Electric Piano 2"},{id:"0060_Aspirin_sf2_file",library:"Aspirin",displayName:"Harpsichord"},{id:"0060_Chaos_sf2_file",library:"Chaos",displayName:"Harpsichord"},{id:"0060_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Harpsichord"},{id:"0060_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Harpsichord"},{id:"0060_JCLive_sf2_file",library:"JCLive",displayName:"Harpsichord"},{id:"0060_SBLive_sf2",library:"SBLive",displayName:"Harpsichord"},{id:"0060_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Harpsichord"},{id:"0070_Aspirin_sf2_file",library:"Aspirin",displayName:"Clavinet"},{id:"0070_Chaos_sf2_file",library:"Chaos",displayName:"Clavinet"},{id:"0070_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Clavinet"},{id:"0070_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Clavinet"},{id:"0070_JCLive_sf2_file",library:"JCLive",displayName:"Clavinet"},{id:"0070_SBLive_sf2",library:"SBLive",displayName:"Clavinet"},{id:"0070_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Clavinet"},{id:"0080_Aspirin_sf2_file",library:"Aspirin",displayName:"Celesta"},{id:"0080_Chaos_sf2_file",library:"Chaos",displayName:"Celesta"},{id:"0080_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Celesta"},{id:"0080_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Celesta"},{id:"0080_JCLive_sf2_file",library:"JCLive",displayName:"Celesta"},{id:"0080_SBLive_sf2",library:"SBLive",displayName:"Celesta"},{id:"0080_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Celesta"},{id:"0090_Aspirin_sf2_file",library:"Aspirin",displayName:"Glockenspiel"},{id:"0090_Chaos_sf2_file",library:"Chaos",displayName:"Glockenspiel"},{id:"0090_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Glockenspiel"},{id:"0090_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Glockenspiel"},{id:"0090_JCLive_sf2_file",library:"JCLive",displayName:"Glockenspiel"},{id:"0090_SBLive_sf2",library:"SBLive",displayName:"Glockenspiel"},{id:"0090_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Glockenspiel"},{id:"0100_Aspirin_sf2_file",library:"Aspirin",displayName:"Music Box"},{id:"0100_Chaos_sf2_file",library:"Chaos",displayName:"Music Box"},{id:"0100_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Music Box"},{id:"0100_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Music Box"},{id:"0100_JCLive_sf2_file",library:"JCLive",displayName:"Music Box"},{id:"0100_SBLive_sf2",library:"SBLive",displayName:"Music Box"},{id:"0100_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Music Box"},{id:"0110_Aspirin_sf2_file",library:"Aspirin",displayName:"Vibraphone"},{id:"0110_Chaos_sf2_file",library:"Chaos",displayName:"Vibraphone"},{id:"0110_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Vibraphone"},{id:"0110_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Vibraphone"},{id:"0110_JCLive_sf2_file",library:"JCLive",displayName:"Vibraphone"},{id:"0110_SBLive_sf2",library:"SBLive",displayName:"Vibraphone"},{id:"0110_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Vibraphone"},{id:"0120_Aspirin_sf2_file",library:"Aspirin",displayName:"Marimba"},{id:"0120_Chaos_sf2_file",library:"Chaos",displayName:"Marimba"},{id:"0120_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Marimba"},{id:"0120_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Marimba"},{id:"0120_JCLive_sf2_file",library:"JCLive",displayName:"Marimba"},{id:"0120_SBLive_sf2",library:"SBLive",displayName:"Marimba"},{id:"0120_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Marimba"},{id:"0130_Aspirin_sf2_file",library:"Aspirin",displayName:"Xylophone"},{id:"0130_Chaos_sf2_file",library:"Chaos",displayName:"Xylophone"},{id:"0130_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Xylophone"},{id:"0130_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Xylophone"},{id:"0130_JCLive_sf2_file",library:"JCLive",displayName:"Xylophone"},{id:"0130_SBLive_sf2",library:"SBLive",displayName:"Xylophone"},{id:"0130_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Xylophone"},{id:"0140_Aspirin_sf2_file",library:"Aspirin",displayName:"Tubular Bells"},{id:"0140_Chaos_sf2_file",library:"Chaos",displayName:"Tubular Bells"},{id:"0140_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Tubular Bells"},{id:"0140_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Tubular Bells"},{id:"0140_JCLive_sf2_file",library:"JCLive",displayName:"Tubular Bells"},{id:"0140_SBLive_sf2",library:"SBLive",displayName:"Tubular Bells"},{id:"0140_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Tubular Bells"},{id:"0150_Aspirin_sf2_file",library:"Aspirin",displayName:"Dulcimer"},{id:"0150_Chaos_sf2_file",library:"Chaos",displayName:"Dulcimer"},{id:"0150_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Dulcimer"},{id:"0150_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Dulcimer"},{id:"0150_JCLive_sf2_file",library:"JCLive",displayName:"Dulcimer"},{id:"0150_SBLive_sf2",library:"SBLive",displayName:"Dulcimer"},{id:"0150_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Dulcimer"},{id:"0160_Aspirin_sf2_file",library:"Aspirin",displayName:"Drawbar Organ"},{id:"0160_Chaos_sf2_file",library:"Chaos",displayName:"Drawbar Organ"},{id:"0160_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drawbar Organ"},{id:"0160_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Drawbar Organ"},{id:"0160_JCLive_sf2_file",library:"JCLive",displayName:"Drawbar Organ"},{id:"0160_SBLive_sf2",library:"SBLive",displayName:"Drawbar Organ"},{id:"0160_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Drawbar Organ"},{id:"0170_Aspirin_sf2_file",library:"Aspirin",displayName:"Percussive Organ"},{id:"0170_Chaos_sf2_file",library:"Chaos",displayName:"Percussive Organ"},{id:"0170_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Percussive Organ"},{id:"0170_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Percussive Organ"},{id:"0170_JCLive_sf2_file",library:"JCLive",displayName:"Percussive Organ"},{id:"0170_SBLive_sf2",library:"SBLive",displayName:"Percussive Organ"},{id:"0170_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Percussive Organ"},{id:"0180_Aspirin_sf2_file",library:"Aspirin",displayName:"Rock Organ"},{id:"0180_Chaos_sf2_file",library:"Chaos",displayName:"Rock Organ"},{id:"0180_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Rock Organ"},{id:"0180_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Rock Organ"},{id:"0180_JCLive_sf2_file",library:"JCLive",displayName:"Rock Organ"},{id:"0180_SBLive_sf2",library:"SBLive",displayName:"Rock Organ"},{id:"0180_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Rock Organ"},{id:"0190_Aspirin_sf2_file",library:"Aspirin",displayName:"Church Organ"},{id:"0190_Chaos_sf2_file",library:"Chaos",displayName:"Church Organ"},{id:"0190_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Church Organ"},{id:"0190_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Church Organ"},{id:"0190_JCLive_sf2_file",library:"JCLive",displayName:"Church Organ"},{id:"0190_SBLive_sf2",library:"SBLive",displayName:"Church Organ"},{id:"0190_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Church Organ"},{id:"0200_Aspirin_sf2_file",library:"Aspirin",displayName:"Reed Organ"},{id:"0200_Chaos_sf2_file",library:"Chaos",displayName:"Reed Organ"},{id:"0200_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Reed Organ"},{id:"0200_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Reed Organ"},{id:"0200_JCLive_sf2_file",library:"JCLive",displayName:"Reed Organ"},{id:"0200_SBLive_sf2",library:"SBLive",displayName:"Reed Organ"},{id:"0200_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Reed Organ"},{id:"0210_Aspirin_sf2_file",library:"Aspirin",displayName:"Accordion"},{id:"0210_Chaos_sf2_file",library:"Chaos",displayName:"Accordion"},{id:"0210_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Accordion"},{id:"0210_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Accordion"},{id:"0210_JCLive_sf2_file",library:"JCLive",displayName:"Accordion"},{id:"0210_SBLive_sf2",library:"SBLive",displayName:"Accordion"},{id:"0210_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Accordion"},{id:"0220_Aspirin_sf2_file",library:"Aspirin",displayName:"Harmonica"},{id:"0220_Chaos_sf2_file",library:"Chaos",displayName:"Harmonica"},{id:"0220_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Harmonica"},{id:"0220_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Harmonica"},{id:"0220_JCLive_sf2_file",library:"JCLive",displayName:"Harmonica"},{id:"0220_SBLive_sf2",library:"SBLive",displayName:"Harmonica"},{id:"0220_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Harmonica"},{id:"0230_Aspirin_sf2_file",library:"Aspirin",displayName:"Tango Accordion"},{id:"0230_Chaos_sf2_file",library:"Chaos",displayName:"Tango Accordion"},{id:"0230_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Tango Accordion"},{id:"0230_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Tango Accordion"},{id:"0230_JCLive_sf2_file",library:"JCLive",displayName:"Tango Accordion"},{id:"0230_SBLive_sf2",library:"SBLive",displayName:"Tango Accordion"},{id:"0230_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Tango Accordion"},{id:"0240_Aspirin_sf2_file",library:"Aspirin",displayName:"Acoustic Guitar (nylon)"},{id:"0240_Chaos_sf2_file",library:"Chaos",displayName:"Acoustic Guitar (nylon)"},{id:"0240_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Acoustic Guitar (nylon)"},{id:"0240_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Acoustic Guitar (nylon)"},{id:"0240_JCLive_sf2_file",library:"JCLive",displayName:"Acoustic Guitar (nylon)"},{id:"0240_SBLive_sf2",library:"SBLive",displayName:"Acoustic Guitar (nylon)"},{id:"0240_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Acoustic Guitar (nylon)"},{id:"0250_Aspirin_sf2_file",library:"Aspirin",displayName:"Acoustic Guitar (steel)"},{id:"0250_Chaos_sf2_file",library:"Chaos",displayName:"Acoustic Guitar (steel)"},{id:"0250_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Acoustic Guitar (steel)"},{id:"0250_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Acoustic Guitar (steel)"},{id:"0250_JCLive_sf2_file",library:"JCLive",displayName:"Acoustic Guitar (steel)"},{id:"0250_SBLive_sf2",library:"SBLive",displayName:"Acoustic Guitar (steel)"},{id:"0250_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Acoustic Guitar (steel)"},{id:"0260_Aspirin_sf2_file",library:"Aspirin",displayName:"Electric Guitar (jazz)"},{id:"0260_Chaos_sf2_file",library:"Chaos",displayName:"Electric Guitar (jazz)"},{id:"0260_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Electric Guitar (jazz)"},{id:"0260_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Electric Guitar (jazz)"},{id:"0260_JCLive_sf2_file",library:"JCLive",displayName:"Electric Guitar (jazz)"},{id:"0260_SBLive_sf2",library:"SBLive",displayName:"Electric Guitar (jazz)"},{id:"0260_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Electric Guitar (jazz)"},{id:"0270_Aspirin_sf2_file",library:"Aspirin",displayName:"Electric Guitar (clean)"},{id:"0270_Chaos_sf2_file",library:"Chaos",displayName:"Electric Guitar (clean)"},{id:"0270_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Electric Guitar (clean)"},{id:"0270_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Electric Guitar (clean)"},{id:"0270_JCLive_sf2_file",library:"JCLive",displayName:"Electric Guitar (clean)"},{id:"0270_SBLive_sf2",library:"SBLive",displayName:"Electric Guitar (clean)"},{id:"0270_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Electric Guitar (clean)"},{id:"0280_Aspirin_sf2_file",library:"Aspirin",displayName:"Electric Guitar (muted)"},{id:"0280_Chaos_sf2_file",library:"Chaos",displayName:"Electric Guitar (muted)"},{id:"0280_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Electric Guitar (muted)"},{id:"0280_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Electric Guitar (muted)"},{id:"0280_JCLive_sf2_file",library:"JCLive",displayName:"Electric Guitar (muted)"},{id:"0280_SBLive_sf2",library:"SBLive",displayName:"Electric Guitar (muted)"},{id:"0280_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Electric Guitar (muted)"},{id:"0290_Aspirin_sf2_file",library:"Aspirin",displayName:"Overdriven Guitar"},{id:"0290_Chaos_sf2_file",library:"Chaos",displayName:"Overdriven Guitar"},{id:"0290_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Overdriven Guitar"},{id:"0290_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Overdriven Guitar"},{id:"0290_JCLive_sf2_file",library:"JCLive",displayName:"Overdriven Guitar"},{id:"0290_SBLive_sf2",library:"SBLive",displayName:"Overdriven Guitar"},{id:"0290_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Overdriven Guitar"},{id:"0300_Aspirin_sf2_file",library:"Aspirin",displayName:"Distortion Guitar"},{id:"0300_Chaos_sf2_file",library:"Chaos",displayName:"Distortion Guitar"},{id:"0300_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Distortion Guitar"},{id:"0300_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Distortion Guitar"},{id:"0300_JCLive_sf2_file",library:"JCLive",displayName:"Distortion Guitar"},{id:"0300_SBLive_sf2",library:"SBLive",displayName:"Distortion Guitar"},{id:"0300_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Distortion Guitar"},{id:"0310_Aspirin_sf2_file",library:"Aspirin",displayName:"Guitar Harmonics"},{id:"0310_Chaos_sf2_file",library:"Chaos",displayName:"Guitar Harmonics"},{id:"0310_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Guitar Harmonics"},{id:"0310_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Guitar Harmonics"},{id:"0310_JCLive_sf2_file",library:"JCLive",displayName:"Guitar Harmonics"},{id:"0310_SBLive_sf2",library:"SBLive",displayName:"Guitar Harmonics"},{id:"0310_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Guitar Harmonics"},{id:"0320_Aspirin_sf2_file",library:"Aspirin",displayName:"Acoustic Bass"},{id:"0320_Chaos_sf2_file",library:"Chaos",displayName:"Acoustic Bass"},{id:"0320_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Acoustic Bass"},{id:"0320_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Acoustic Bass"},{id:"0320_JCLive_sf2_file",library:"JCLive",displayName:"Acoustic Bass"},{id:"0320_SBLive_sf2",library:"SBLive",displayName:"Acoustic Bass"},{id:"0320_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Acoustic Bass"},{id:"0330_Aspirin_sf2_file",library:"Aspirin",displayName:"Electric Bass (finger)"},{id:"0330_Chaos_sf2_file",library:"Chaos",displayName:"Electric Bass (finger)"},{id:"0330_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Electric Bass (finger)"},{id:"0330_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Electric Bass (finger)"},{id:"0330_JCLive_sf2_file",library:"JCLive",displayName:"Electric Bass (finger)"},{id:"0330_SBLive_sf2",library:"SBLive",displayName:"Electric Bass (finger)"},{id:"0330_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Electric Bass (finger)"},{id:"0340_Aspirin_sf2_file",library:"Aspirin",displayName:"Electric Bass (pick)"},{id:"0340_Chaos_sf2_file",library:"Chaos",displayName:"Electric Bass (pick)"},{id:"0340_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Electric Bass (pick)"},{id:"0340_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Electric Bass (pick)"},{id:"0340_JCLive_sf2_file",library:"JCLive",displayName:"Electric Bass (pick)"},{id:"0340_SBLive_sf2",library:"SBLive",displayName:"Electric Bass (pick)"},{id:"0340_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Electric Bass (pick)"},{id:"0350_Aspirin_sf2_file",library:"Aspirin",displayName:"Fretless Bass"},{id:"0350_Chaos_sf2_file",library:"Chaos",displayName:"Fretless Bass"},{id:"0350_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Fretless Bass"},{id:"0350_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Fretless Bass"},{id:"0350_JCLive_sf2_file",library:"JCLive",displayName:"Fretless Bass"},{id:"0350_SBLive_sf2",library:"SBLive",displayName:"Fretless Bass"},{id:"0350_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Fretless Bass"},{id:"0360_Aspirin_sf2_file",library:"Aspirin",displayName:"Slap Bass 1"},{id:"0360_Chaos_sf2_file",library:"Chaos",displayName:"Slap Bass 1"},{id:"0360_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Slap Bass 1"},{id:"0360_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Slap Bass 1"},{id:"0360_JCLive_sf2_file",library:"JCLive",displayName:"Slap Bass 1"},{id:"0360_SBLive_sf2",library:"SBLive",displayName:"Slap Bass 1"},{id:"0360_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Slap Bass 1"},{id:"0370_Aspirin_sf2_file",library:"Aspirin",displayName:"Slap Bass 2"},{id:"0370_Chaos_sf2_file",library:"Chaos",displayName:"Slap Bass 2"},{id:"0370_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Slap Bass 2"},{id:"0370_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Slap Bass 2"},{id:"0370_JCLive_sf2_file",library:"JCLive",displayName:"Slap Bass 2"},{id:"0370_SBLive_sf2",library:"SBLive",displayName:"Slap Bass 2"},{id:"0370_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Slap Bass 2"},{id:"0380_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Bass 1"},{id:"0380_Chaos_sf2_file",library:"Chaos",displayName:"Synth Bass 1"},{id:"0380_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Bass 1"},{id:"0380_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Bass 1"},{id:"0380_JCLive_sf2_file",library:"JCLive",displayName:"Synth Bass 1"},{id:"0380_SBLive_sf2",library:"SBLive",displayName:"Synth Bass 1"},{id:"0380_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Bass 1"},{id:"0390_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Bass 2"},{id:"0390_Chaos_sf2_file",library:"Chaos",displayName:"Synth Bass 2"},{id:"0390_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Bass 2"},{id:"0390_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Bass 2"},{id:"0390_JCLive_sf2_file",library:"JCLive",displayName:"Synth Bass 2"},{id:"0390_SBLive_sf2",library:"SBLive",displayName:"Synth Bass 2"},{id:"0390_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Bass 2"},{id:"0400_Aspirin_sf2_file",library:"Aspirin",displayName:"Violin"},{id:"0400_Chaos_sf2_file",library:"Chaos",displayName:"Violin"},{id:"0400_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Violin"},{id:"0400_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Violin"},{id:"0400_JCLive_sf2_file",library:"JCLive",displayName:"Violin"},{id:"0400_SBLive_sf2",library:"SBLive",displayName:"Violin"},{id:"0400_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Violin"},{id:"0410_Aspirin_sf2_file",library:"Aspirin",displayName:"Viola"},{id:"0410_Chaos_sf2_file",library:"Chaos",displayName:"Viola"},{id:"0410_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Viola"},{id:"0410_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Viola"},{id:"0410_JCLive_sf2_file",library:"JCLive",displayName:"Viola"},{id:"0410_SBLive_sf2",library:"SBLive",displayName:"Viola"},{id:"0410_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Viola"},{id:"0420_Aspirin_sf2_file",library:"Aspirin",displayName:"Cello"},{id:"0420_Chaos_sf2_file",library:"Chaos",displayName:"Cello"},{id:"0420_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Cello"},{id:"0420_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Cello"},{id:"0420_JCLive_sf2_file",library:"JCLive",displayName:"Cello"},{id:"0420_SBLive_sf2",library:"SBLive",displayName:"Cello"},{id:"0420_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Cello"},{id:"0430_Aspirin_sf2_file",library:"Aspirin",displayName:"Contrabass"},{id:"0430_Chaos_sf2_file",library:"Chaos",displayName:"Contrabass"},{id:"0430_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Contrabass"},{id:"0430_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Contrabass"},{id:"0430_JCLive_sf2_file",library:"JCLive",displayName:"Contrabass"},{id:"0430_SBLive_sf2",library:"SBLive",displayName:"Contrabass"},{id:"0430_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Contrabass"},{id:"0440_Aspirin_sf2_file",library:"Aspirin",displayName:"Tremolo Strings"},{id:"0440_Chaos_sf2_file",library:"Chaos",displayName:"Tremolo Strings"},{id:"0440_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Tremolo Strings"},{id:"0440_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Tremolo Strings"},{id:"0440_JCLive_sf2_file",library:"JCLive",displayName:"Tremolo Strings"},{id:"0440_SBLive_sf2",library:"SBLive",displayName:"Tremolo Strings"},{id:"0440_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Tremolo Strings"},{id:"0450_Aspirin_sf2_file",library:"Aspirin",displayName:"Pizzicato Strings"},{id:"0450_Chaos_sf2_file",library:"Chaos",displayName:"Pizzicato Strings"},{id:"0450_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pizzicato Strings"},{id:"0450_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pizzicato Strings"},{id:"0450_JCLive_sf2_file",library:"JCLive",displayName:"Pizzicato Strings"},{id:"0450_SBLive_sf2",library:"SBLive",displayName:"Pizzicato Strings"},{id:"0450_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pizzicato Strings"},{id:"0460_Aspirin_sf2_file",library:"Aspirin",displayName:"Orchestral Harp"},{id:"0460_Chaos_sf2_file",library:"Chaos",displayName:"Orchestral Harp"},{id:"0460_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Orchestral Harp"},{id:"0460_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Orchestral Harp"},{id:"0460_JCLive_sf2_file",library:"JCLive",displayName:"Orchestral Harp"},{id:"0460_SBLive_sf2",library:"SBLive",displayName:"Orchestral Harp"},{id:"0460_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Orchestral Harp"},{id:"0470_Aspirin_sf2_file",library:"Aspirin",displayName:"Timpani"},{id:"0470_Chaos_sf2_file",library:"Chaos",displayName:"Timpani"},{id:"0470_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Timpani"},{id:"0470_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Timpani"},{id:"0470_JCLive_sf2_file",library:"JCLive",displayName:"Timpani"},{id:"0470_SBLive_sf2",library:"SBLive",displayName:"Timpani"},{id:"0470_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Timpani"},{id:"0480_Aspirin_sf2_file",library:"Aspirin",displayName:"String Ensemble 1"},{id:"0480_Chaos_sf2_file",library:"Chaos",displayName:"String Ensemble 1"},{id:"0480_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"String Ensemble 1"},{id:"0480_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"String Ensemble 1"},{id:"0480_JCLive_sf2_file",library:"JCLive",displayName:"String Ensemble 1"},{id:"0480_SBLive_sf2",library:"SBLive",displayName:"String Ensemble 1"},{id:"0480_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"String Ensemble 1"},{id:"0490_Aspirin_sf2_file",library:"Aspirin",displayName:"String Ensemble 2"},{id:"0490_Chaos_sf2_file",library:"Chaos",displayName:"String Ensemble 2"},{id:"0490_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"String Ensemble 2"},{id:"0490_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"String Ensemble 2"},{id:"0490_JCLive_sf2_file",library:"JCLive",displayName:"String Ensemble 2"},{id:"0490_SBLive_sf2",library:"SBLive",displayName:"String Ensemble 2"},{id:"0490_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"String Ensemble 2"},{id:"0500_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Strings 1"},{id:"0500_Chaos_sf2_file",library:"Chaos",displayName:"Synth Strings 1"},{id:"0500_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Strings 1"},{id:"0500_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Strings 1"},{id:"0500_JCLive_sf2_file",library:"JCLive",displayName:"Synth Strings 1"},{id:"0500_SBLive_sf2",library:"SBLive",displayName:"Synth Strings 1"},{id:"0500_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Strings 1"},{id:"0510_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Strings 2"},{id:"0510_Chaos_sf2_file",library:"Chaos",displayName:"Synth Strings 2"},{id:"0510_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Strings 2"},{id:"0510_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Strings 2"},{id:"0510_JCLive_sf2_file",library:"JCLive",displayName:"Synth Strings 2"},{id:"0510_SBLive_sf2",library:"SBLive",displayName:"Synth Strings 2"},{id:"0510_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Strings 2"},{id:"0520_Aspirin_sf2_file",library:"Aspirin",displayName:"Choir Aahs"},{id:"0520_Chaos_sf2_file",library:"Chaos",displayName:"Choir Aahs"},{id:"0520_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Choir Aahs"},{id:"0520_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Choir Aahs"},{id:"0520_JCLive_sf2_file",library:"JCLive",displayName:"Choir Aahs"},{id:"0520_SBLive_sf2",library:"SBLive",displayName:"Choir Aahs"},{id:"0520_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Choir Aahs"},{id:"0530_Aspirin_sf2_file",library:"Aspirin",displayName:"Voice Oohs"},{id:"0530_Chaos_sf2_file",library:"Chaos",displayName:"Voice Oohs"},{id:"0530_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Voice Oohs"},{id:"0530_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Voice Oohs"},{id:"0530_JCLive_sf2_file",library:"JCLive",displayName:"Voice Oohs"},{id:"0530_SBLive_sf2",library:"SBLive",displayName:"Voice Oohs"},{id:"0530_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Voice Oohs"},{id:"0540_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Choir"},{id:"0540_Chaos_sf2_file",library:"Chaos",displayName:"Synth Choir"},{id:"0540_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Choir"},{id:"0540_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Choir"},{id:"0540_JCLive_sf2_file",library:"JCLive",displayName:"Synth Choir"},{id:"0540_SBLive_sf2",library:"SBLive",displayName:"Synth Choir"},{id:"0540_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Choir"},{id:"0550_Aspirin_sf2_file",library:"Aspirin",displayName:"Orchestra Hit"},{id:"0550_Chaos_sf2_file",library:"Chaos",displayName:"Orchestra Hit"},{id:"0550_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Orchestra Hit"},{id:"0550_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Orchestra Hit"},{id:"0550_JCLive_sf2_file",library:"JCLive",displayName:"Orchestra Hit"},{id:"0550_SBLive_sf2",library:"SBLive",displayName:"Orchestra Hit"},{id:"0550_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Orchestra Hit"},{id:"0560_Aspirin_sf2_file",library:"Aspirin",displayName:"Trumpet"},{id:"0560_Chaos_sf2_file",library:"Chaos",displayName:"Trumpet"},{id:"0560_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Trumpet"},{id:"0560_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Trumpet"},{id:"0560_JCLive_sf2_file",library:"JCLive",displayName:"Trumpet"},{id:"0560_SBLive_sf2",library:"SBLive",displayName:"Trumpet"},{id:"0560_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Trumpet"},{id:"0570_Aspirin_sf2_file",library:"Aspirin",displayName:"Trombone"},{id:"0570_Chaos_sf2_file",library:"Chaos",displayName:"Trombone"},{id:"0570_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Trombone"},{id:"0570_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Trombone"},{id:"0570_JCLive_sf2_file",library:"JCLive",displayName:"Trombone"},{id:"0570_SBLive_sf2",library:"SBLive",displayName:"Trombone"},{id:"0570_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Trombone"},{id:"0580_Aspirin_sf2_file",library:"Aspirin",displayName:"Tuba"},{id:"0580_Chaos_sf2_file",library:"Chaos",displayName:"Tuba"},{id:"0580_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Tuba"},{id:"0580_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Tuba"},{id:"0580_JCLive_sf2_file",library:"JCLive",displayName:"Tuba"},{id:"0580_SBLive_sf2",library:"SBLive",displayName:"Tuba"},{id:"0580_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Tuba"},{id:"0590_Aspirin_sf2_file",library:"Aspirin",displayName:"Muted Trumpet"},{id:"0590_Chaos_sf2_file",library:"Chaos",displayName:"Muted Trumpet"},{id:"0590_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Muted Trumpet"},{id:"0590_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Muted Trumpet"},{id:"0590_JCLive_sf2_file",library:"JCLive",displayName:"Muted Trumpet"},{id:"0590_SBLive_sf2",library:"SBLive",displayName:"Muted Trumpet"},{id:"0590_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Muted Trumpet"},{id:"0600_Aspirin_sf2_file",library:"Aspirin",displayName:"French Horn"},{id:"0600_Chaos_sf2_file",library:"Chaos",displayName:"French Horn"},{id:"0600_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"French Horn"},{id:"0600_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"French Horn"},{id:"0600_JCLive_sf2_file",library:"JCLive",displayName:"French Horn"},{id:"0600_SBLive_sf2",library:"SBLive",displayName:"French Horn"},{id:"0600_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"French Horn"},{id:"0610_Aspirin_sf2_file",library:"Aspirin",displayName:"Brass Section"},{id:"0610_Chaos_sf2_file",library:"Chaos",displayName:"Brass Section"},{id:"0610_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Brass Section"},{id:"0610_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Brass Section"},{id:"0610_JCLive_sf2_file",library:"JCLive",displayName:"Brass Section"},{id:"0610_SBLive_sf2",library:"SBLive",displayName:"Brass Section"},{id:"0610_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Brass Section"},{id:"0620_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Brass 1"},{id:"0620_Chaos_sf2_file",library:"Chaos",displayName:"Synth Brass 1"},{id:"0620_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Brass 1"},{id:"0620_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Brass 1"},{id:"0620_JCLive_sf2_file",library:"JCLive",displayName:"Synth Brass 1"},{id:"0620_SBLive_sf2",library:"SBLive",displayName:"Synth Brass 1"},{id:"0620_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Brass 1"},{id:"0630_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Brass 2"},{id:"0630_Chaos_sf2_file",library:"Chaos",displayName:"Synth Brass 2"},{id:"0630_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Brass 2"},{id:"0630_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Brass 2"},{id:"0630_JCLive_sf2_file",library:"JCLive",displayName:"Synth Brass 2"},{id:"0630_SBLive_sf2",library:"SBLive",displayName:"Synth Brass 2"},{id:"0630_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Brass 2"},{id:"0640_Aspirin_sf2_file",library:"Aspirin",displayName:"Soprano Sax"},{id:"0640_Chaos_sf2_file",library:"Chaos",displayName:"Soprano Sax"},{id:"0640_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Soprano Sax"},{id:"0640_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Soprano Sax"},{id:"0640_JCLive_sf2_file",library:"JCLive",displayName:"Soprano Sax"},{id:"0640_SBLive_sf2",library:"SBLive",displayName:"Soprano Sax"},{id:"0640_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Soprano Sax"},{id:"0650_Aspirin_sf2_file",library:"Aspirin",displayName:"Alto Sax"},{id:"0650_Chaos_sf2_file",library:"Chaos",displayName:"Alto Sax"},{id:"0650_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Alto Sax"},{id:"0650_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Alto Sax"},{id:"0650_JCLive_sf2_file",library:"JCLive",displayName:"Alto Sax"},{id:"0650_SBLive_sf2",library:"SBLive",displayName:"Alto Sax"},{id:"0650_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Alto Sax"},{id:"0660_Aspirin_sf2_file",library:"Aspirin",displayName:"Tenor Sax"},{id:"0660_Chaos_sf2_file",library:"Chaos",displayName:"Tenor Sax"},{id:"0660_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Tenor Sax"},{id:"0660_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Tenor Sax"},{id:"0660_JCLive_sf2_file",library:"JCLive",displayName:"Tenor Sax"},{id:"0660_SBLive_sf2",library:"SBLive",displayName:"Tenor Sax"},{id:"0660_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Tenor Sax"},{id:"0670_Aspirin_sf2_file",library:"Aspirin",displayName:"Baritone Sax"},{id:"0670_Chaos_sf2_file",library:"Chaos",displayName:"Baritone Sax"},{id:"0670_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Baritone Sax"},{id:"0670_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Baritone Sax"},{id:"0670_JCLive_sf2_file",library:"JCLive",displayName:"Baritone Sax"},{id:"0670_SBLive_sf2",library:"SBLive",displayName:"Baritone Sax"},{id:"0670_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Baritone Sax"},{id:"0680_Aspirin_sf2_file",library:"Aspirin",displayName:"Oboe"},{id:"0680_Chaos_sf2_file",library:"Chaos",displayName:"Oboe"},{id:"0680_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Oboe"},{id:"0680_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Oboe"},{id:"0680_JCLive_sf2_file",library:"JCLive",displayName:"Oboe"},{id:"0680_SBLive_sf2",library:"SBLive",displayName:"Oboe"},{id:"0680_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Oboe"},{id:"0690_Aspirin_sf2_file",library:"Aspirin",displayName:"English Horn"},{id:"0690_Chaos_sf2_file",library:"Chaos",displayName:"English Horn"},{id:"0690_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"English Horn"},{id:"0690_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"English Horn"},{id:"0690_JCLive_sf2_file",library:"JCLive",displayName:"English Horn"},{id:"0690_SBLive_sf2",library:"SBLive",displayName:"English Horn"},{id:"0690_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"English Horn"},{id:"0700_Aspirin_sf2_file",library:"Aspirin",displayName:"Bassoon"},{id:"0700_Chaos_sf2_file",library:"Chaos",displayName:"Bassoon"},{id:"0700_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Bassoon"},{id:"0700_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Bassoon"},{id:"0700_JCLive_sf2_file",library:"JCLive",displayName:"Bassoon"},{id:"0700_SBLive_sf2",library:"SBLive",displayName:"Bassoon"},{id:"0700_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Bassoon"},{id:"0710_Aspirin_sf2_file",library:"Aspirin",displayName:"Clarinet"},{id:"0710_Chaos_sf2_file",library:"Chaos",displayName:"Clarinet"},{id:"0710_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Clarinet"},{id:"0710_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Clarinet"},{id:"0710_JCLive_sf2_file",library:"JCLive",displayName:"Clarinet"},{id:"0710_SBLive_sf2",library:"SBLive",displayName:"Clarinet"},{id:"0710_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Clarinet"},{id:"0720_Aspirin_sf2_file",library:"Aspirin",displayName:"Piccolo"},{id:"0720_Chaos_sf2_file",library:"Chaos",displayName:"Piccolo"},{id:"0720_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Piccolo"},{id:"0720_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Piccolo"},{id:"0720_JCLive_sf2_file",library:"JCLive",displayName:"Piccolo"},{id:"0720_SBLive_sf2",library:"SBLive",displayName:"Piccolo"},{id:"0720_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Piccolo"},{id:"0730_Aspirin_sf2_file",library:"Aspirin",displayName:"Flute"},{id:"0730_Chaos_sf2_file",library:"Chaos",displayName:"Flute"},{id:"0730_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Flute"},{id:"0730_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Flute"},{id:"0730_JCLive_sf2_file",library:"JCLive",displayName:"Flute"},{id:"0730_SBLive_sf2",library:"SBLive",displayName:"Flute"},{id:"0730_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Flute"},{id:"0740_Aspirin_sf2_file",library:"Aspirin",displayName:"Recorder"},{id:"0740_Chaos_sf2_file",library:"Chaos",displayName:"Recorder"},{id:"0740_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Recorder"},{id:"0740_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Recorder"},{id:"0740_JCLive_sf2_file",library:"JCLive",displayName:"Recorder"},{id:"0740_SBLive_sf2",library:"SBLive",displayName:"Recorder"},{id:"0740_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Recorder"},{id:"0750_Aspirin_sf2_file",library:"Aspirin",displayName:"Pan Flute"},{id:"0750_Chaos_sf2_file",library:"Chaos",displayName:"Pan Flute"},{id:"0750_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pan Flute"},{id:"0750_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pan Flute"},{id:"0750_JCLive_sf2_file",library:"JCLive",displayName:"Pan Flute"},{id:"0750_SBLive_sf2",library:"SBLive",displayName:"Pan Flute"},{id:"0750_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pan Flute"},{id:"0760_Aspirin_sf2_file",library:"Aspirin",displayName:"Blown Bottle"},{id:"0760_Chaos_sf2_file",library:"Chaos",displayName:"Blown Bottle"},{id:"0760_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Blown Bottle"},{id:"0760_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Blown Bottle"},{id:"0760_JCLive_sf2_file",library:"JCLive",displayName:"Blown Bottle"},{id:"0760_SBLive_sf2",library:"SBLive",displayName:"Blown Bottle"},{id:"0760_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Blown Bottle"},{id:"0770_Aspirin_sf2_file",library:"Aspirin",displayName:"Shakuhachi"},{id:"0770_Chaos_sf2_file",library:"Chaos",displayName:"Shakuhachi"},{id:"0770_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Shakuhachi"},{id:"0770_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Shakuhachi"},{id:"0770_JCLive_sf2_file",library:"JCLive",displayName:"Shakuhachi"},{id:"0770_SBLive_sf2",library:"SBLive",displayName:"Shakuhachi"},{id:"0770_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Shakuhachi"},{id:"0780_Aspirin_sf2_file",library:"Aspirin",displayName:"Whistle"},{id:"0780_Chaos_sf2_file",library:"Chaos",displayName:"Whistle"},{id:"0780_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Whistle"},{id:"0780_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Whistle"},{id:"0780_JCLive_sf2_file",library:"JCLive",displayName:"Whistle"},{id:"0780_SBLive_sf2",library:"SBLive",displayName:"Whistle"},{id:"0780_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Whistle"},{id:"0790_Aspirin_sf2_file",library:"Aspirin",displayName:"Ocarina"},{id:"0790_Chaos_sf2_file",library:"Chaos",displayName:"Ocarina"},{id:"0790_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Ocarina"},{id:"0790_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Ocarina"},{id:"0790_JCLive_sf2_file",library:"JCLive",displayName:"Ocarina"},{id:"0790_SBLive_sf2",library:"SBLive",displayName:"Ocarina"},{id:"0790_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Ocarina"},{id:"0800_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 1 (square)"},{id:"0800_Chaos_sf2_file",library:"Chaos",displayName:"Lead 1 (square)"},{id:"0800_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 1 (square)"},{id:"0800_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 1 (square)"},{id:"0800_JCLive_sf2_file",library:"JCLive",displayName:"Lead 1 (square)"},{id:"0800_SBLive_sf2",library:"SBLive",displayName:"Lead 1 (square)"},{id:"0800_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 1 (square)"},{id:"0810_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 2 (sawtooth)"},{id:"0810_Chaos_sf2_file",library:"Chaos",displayName:"Lead 2 (sawtooth)"},{id:"0810_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 2 (sawtooth)"},{id:"0810_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 2 (sawtooth)"},{id:"0810_JCLive_sf2_file",library:"JCLive",displayName:"Lead 2 (sawtooth)"},{id:"0810_SBLive_sf2",library:"SBLive",displayName:"Lead 2 (sawtooth)"},{id:"0810_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 2 (sawtooth)"},{id:"0820_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 3 (calliope)"},{id:"0820_Chaos_sf2_file",library:"Chaos",displayName:"Lead 3 (calliope)"},{id:"0820_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 3 (calliope)"},{id:"0820_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 3 (calliope)"},{id:"0820_JCLive_sf2_file",library:"JCLive",displayName:"Lead 3 (calliope)"},{id:"0820_SBLive_sf2",library:"SBLive",displayName:"Lead 3 (calliope)"},{id:"0820_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 3 (calliope)"},{id:"0830_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 4 (chiff)"},{id:"0830_Chaos_sf2_file",library:"Chaos",displayName:"Lead 4 (chiff)"},{id:"0830_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 4 (chiff)"},{id:"0830_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 4 (chiff)"},{id:"0830_JCLive_sf2_file",library:"JCLive",displayName:"Lead 4 (chiff)"},{id:"0830_SBLive_sf2",library:"SBLive",displayName:"Lead 4 (chiff)"},{id:"0830_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 4 (chiff)"},{id:"0840_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 5 (charang)"},{id:"0840_Chaos_sf2_file",library:"Chaos",displayName:"Lead 5 (charang)"},{id:"0840_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 5 (charang)"},{id:"0840_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 5 (charang)"},{id:"0840_JCLive_sf2_file",library:"JCLive",displayName:"Lead 5 (charang)"},{id:"0840_SBLive_sf2",library:"SBLive",displayName:"Lead 5 (charang)"},{id:"0840_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 5 (charang)"},{id:"0850_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 6 (voice)"},{id:"0850_Chaos_sf2_file",library:"Chaos",displayName:"Lead 6 (voice)"},{id:"0850_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 6 (voice)"},{id:"0850_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 6 (voice)"},{id:"0850_JCLive_sf2_file",library:"JCLive",displayName:"Lead 6 (voice)"},{id:"0850_SBLive_sf2",library:"SBLive",displayName:"Lead 6 (voice)"},{id:"0850_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 6 (voice)"},{id:"0860_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 7 (fifths)"},{id:"0860_Chaos_sf2_file",library:"Chaos",displayName:"Lead 7 (fifths)"},{id:"0860_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 7 (fifths)"},{id:"0860_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 7 (fifths)"},{id:"0860_JCLive_sf2_file",library:"JCLive",displayName:"Lead 7 (fifths)"},{id:"0860_SBLive_sf2",library:"SBLive",displayName:"Lead 7 (fifths)"},{id:"0860_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 7 (fifths)"},{id:"0870_Aspirin_sf2_file",library:"Aspirin",displayName:"Lead 8 (bass + lead)"},{id:"0870_Chaos_sf2_file",library:"Chaos",displayName:"Lead 8 (bass + lead)"},{id:"0870_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Lead 8 (bass + lead)"},{id:"0870_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Lead 8 (bass + lead)"},{id:"0870_JCLive_sf2_file",library:"JCLive",displayName:"Lead 8 (bass + lead)"},{id:"0870_SBLive_sf2",library:"SBLive",displayName:"Lead 8 (bass + lead)"},{id:"0870_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Lead 8 (bass + lead)"},{id:"0880_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 1 (new age)"},{id:"0880_Chaos_sf2_file",library:"Chaos",displayName:"Pad 1 (new age)"},{id:"0880_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 1 (new age)"},{id:"0880_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 1 (new age)"},{id:"0880_JCLive_sf2_file",library:"JCLive",displayName:"Pad 1 (new age)"},{id:"0880_SBLive_sf2",library:"SBLive",displayName:"Pad 1 (new age)"},{id:"0880_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 1 (new age)"},{id:"0890_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 2 (warm)"},{id:"0890_Chaos_sf2_file",library:"Chaos",displayName:"Pad 2 (warm)"},{id:"0890_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 2 (warm)"},{id:"0890_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 2 (warm)"},{id:"0890_JCLive_sf2_file",library:"JCLive",displayName:"Pad 2 (warm)"},{id:"0890_SBLive_sf2",library:"SBLive",displayName:"Pad 2 (warm)"},{id:"0890_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 2 (warm)"},{id:"0900_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 3 (polysynth)"},{id:"0900_Chaos_sf2_file",library:"Chaos",displayName:"Pad 3 (polysynth)"},{id:"0900_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 3 (polysynth)"},{id:"0900_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 3 (polysynth)"},{id:"0900_JCLive_sf2_file",library:"JCLive",displayName:"Pad 3 (polysynth)"},{id:"0900_SBLive_sf2",library:"SBLive",displayName:"Pad 3 (polysynth)"},{id:"0900_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 3 (polysynth)"},{id:"0910_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 4 (choir)"},{id:"0910_Chaos_sf2_file",library:"Chaos",displayName:"Pad 4 (choir)"},{id:"0910_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 4 (choir)"},{id:"0910_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 4 (choir)"},{id:"0910_JCLive_sf2_file",library:"JCLive",displayName:"Pad 4 (choir)"},{id:"0910_SBLive_sf2",library:"SBLive",displayName:"Pad 4 (choir)"},{id:"0910_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 4 (choir)"},{id:"0920_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 5 (bowed)"},{id:"0920_Chaos_sf2_file",library:"Chaos",displayName:"Pad 5 (bowed)"},{id:"0920_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 5 (bowed)"},{id:"0920_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 5 (bowed)"},{id:"0920_JCLive_sf2_file",library:"JCLive",displayName:"Pad 5 (bowed)"},{id:"0920_SBLive_sf2",library:"SBLive",displayName:"Pad 5 (bowed)"},{id:"0920_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 5 (bowed)"},{id:"0930_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 6 (metallic)"},{id:"0930_Chaos_sf2_file",library:"Chaos",displayName:"Pad 6 (metallic)"},{id:"0930_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 6 (metallic)"},{id:"0930_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 6 (metallic)"},{id:"0930_JCLive_sf2_file",library:"JCLive",displayName:"Pad 6 (metallic)"},{id:"0930_SBLive_sf2",library:"SBLive",displayName:"Pad 6 (metallic)"},{id:"0930_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 6 (metallic)"},{id:"0940_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 7 (halo)"},{id:"0940_Chaos_sf2_file",library:"Chaos",displayName:"Pad 7 (halo)"},{id:"0940_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 7 (halo)"},{id:"0940_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 7 (halo)"},{id:"0940_JCLive_sf2_file",library:"JCLive",displayName:"Pad 7 (halo)"},{id:"0940_SBLive_sf2",library:"SBLive",displayName:"Pad 7 (halo)"},{id:"0940_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 7 (halo)"},{id:"0950_Aspirin_sf2_file",library:"Aspirin",displayName:"Pad 8 (sweep)"},{id:"0950_Chaos_sf2_file",library:"Chaos",displayName:"Pad 8 (sweep)"},{id:"0950_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Pad 8 (sweep)"},{id:"0950_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Pad 8 (sweep)"},{id:"0950_JCLive_sf2_file",library:"JCLive",displayName:"Pad 8 (sweep)"},{id:"0950_SBLive_sf2",library:"SBLive",displayName:"Pad 8 (sweep)"},{id:"0950_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Pad 8 (sweep)"},{id:"0960_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 1 (rain)"},{id:"0960_Chaos_sf2_file",library:"Chaos",displayName:"FX 1 (rain)"},{id:"0960_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 1 (rain)"},{id:"0960_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 1 (rain)"},{id:"0960_JCLive_sf2_file",library:"JCLive",displayName:"FX 1 (rain)"},{id:"0960_SBLive_sf2",library:"SBLive",displayName:"FX 1 (rain)"},{id:"0960_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 1 (rain)"},{id:"0970_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 2 (soundtrack)"},{id:"0970_Chaos_sf2_file",library:"Chaos",displayName:"FX 2 (soundtrack)"},{id:"0970_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 2 (soundtrack)"},{id:"0970_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 2 (soundtrack)"},{id:"0970_JCLive_sf2_file",library:"JCLive",displayName:"FX 2 (soundtrack)"},{id:"0970_SBLive_sf2",library:"SBLive",displayName:"FX 2 (soundtrack)"},{id:"0970_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 2 (soundtrack)"},{id:"0980_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 3 (crystal)"},{id:"0980_Chaos_sf2_file",library:"Chaos",displayName:"FX 3 (crystal)"},{id:"0980_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 3 (crystal)"},{id:"0980_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 3 (crystal)"},{id:"0980_JCLive_sf2_file",library:"JCLive",displayName:"FX 3 (crystal)"},{id:"0980_SBLive_sf2",library:"SBLive",displayName:"FX 3 (crystal)"},{id:"0980_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 3 (crystal)"},{id:"0990_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 4 (atmosphere)"},{id:"0990_Chaos_sf2_file",library:"Chaos",displayName:"FX 4 (atmosphere)"},{id:"0990_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 4 (atmosphere)"},{id:"0990_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 4 (atmosphere)"},{id:"0990_JCLive_sf2_file",library:"JCLive",displayName:"FX 4 (atmosphere)"},{id:"0990_SBLive_sf2",library:"SBLive",displayName:"FX 4 (atmosphere)"},{id:"0990_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 4 (atmosphere)"},{id:"1000_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 5 (brightness)"},{id:"1000_Chaos_sf2_file",library:"Chaos",displayName:"FX 5 (brightness)"},{id:"1000_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 5 (brightness)"},{id:"1000_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 5 (brightness)"},{id:"1000_JCLive_sf2_file",library:"JCLive",displayName:"FX 5 (brightness)"},{id:"1000_SBLive_sf2",library:"SBLive",displayName:"FX 5 (brightness)"},{id:"1000_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 5 (brightness)"},{id:"1010_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 6 (goblins)"},{id:"1010_Chaos_sf2_file",library:"Chaos",displayName:"FX 6 (goblins)"},{id:"1010_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 6 (goblins)"},{id:"1010_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 6 (goblins)"},{id:"1010_JCLive_sf2_file",library:"JCLive",displayName:"FX 6 (goblins)"},{id:"1010_SBLive_sf2",library:"SBLive",displayName:"FX 6 (goblins)"},{id:"1010_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 6 (goblins)"},{id:"1020_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 7 (echoes)"},{id:"1020_Chaos_sf2_file",library:"Chaos",displayName:"FX 7 (echoes)"},{id:"1020_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 7 (echoes)"},{id:"1020_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 7 (echoes)"},{id:"1020_JCLive_sf2_file",library:"JCLive",displayName:"FX 7 (echoes)"},{id:"1020_SBLive_sf2",library:"SBLive",displayName:"FX 7 (echoes)"},{id:"1020_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 7 (echoes)"},{id:"1030_Aspirin_sf2_file",library:"Aspirin",displayName:"FX 8 (sci-fi)"},{id:"1030_Chaos_sf2_file",library:"Chaos",displayName:"FX 8 (sci-fi)"},{id:"1030_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"FX 8 (sci-fi)"},{id:"1030_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"FX 8 (sci-fi)"},{id:"1030_JCLive_sf2_file",library:"JCLive",displayName:"FX 8 (sci-fi)"},{id:"1030_SBLive_sf2",library:"SBLive",displayName:"FX 8 (sci-fi)"},{id:"1030_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"FX 8 (sci-fi)"},{id:"1040_Aspirin_sf2_file",library:"Aspirin",displayName:"Sitar"},{id:"1040_Chaos_sf2_file",library:"Chaos",displayName:"Sitar"},{id:"1040_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Sitar"},{id:"1040_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Sitar"},{id:"1040_JCLive_sf2_file",library:"JCLive",displayName:"Sitar"},{id:"1040_SBLive_sf2",library:"SBLive",displayName:"Sitar"},{id:"1040_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Sitar"},{id:"1050_Aspirin_sf2_file",library:"Aspirin",displayName:"Banjo"},{id:"1050_Chaos_sf2_file",library:"Chaos",displayName:"Banjo"},{id:"1050_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Banjo"},{id:"1050_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Banjo"},{id:"1050_JCLive_sf2_file",library:"JCLive",displayName:"Banjo"},{id:"1050_SBLive_sf2",library:"SBLive",displayName:"Banjo"},{id:"1050_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Banjo"},{id:"1060_Aspirin_sf2_file",library:"Aspirin",displayName:"Shamisen"},{id:"1060_Chaos_sf2_file",library:"Chaos",displayName:"Shamisen"},{id:"1060_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Shamisen"},{id:"1060_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Shamisen"},{id:"1060_JCLive_sf2_file",library:"JCLive",displayName:"Shamisen"},{id:"1060_SBLive_sf2",library:"SBLive",displayName:"Shamisen"},{id:"1060_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Shamisen"},{id:"1070_Aspirin_sf2_file",library:"Aspirin",displayName:"Koto"},{id:"1070_Chaos_sf2_file",library:"Chaos",displayName:"Koto"},{id:"1070_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Koto"},{id:"1070_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Koto"},{id:"1070_JCLive_sf2_file",library:"JCLive",displayName:"Koto"},{id:"1070_SBLive_sf2",library:"SBLive",displayName:"Koto"},{id:"1070_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Koto"},{id:"1080_Aspirin_sf2_file",library:"Aspirin",displayName:"Kalimba"},{id:"1080_Chaos_sf2_file",library:"Chaos",displayName:"Kalimba"},{id:"1080_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Kalimba"},{id:"1080_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Kalimba"},{id:"1080_JCLive_sf2_file",library:"JCLive",displayName:"Kalimba"},{id:"1080_SBLive_sf2",library:"SBLive",displayName:"Kalimba"},{id:"1080_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Kalimba"},{id:"1090_Aspirin_sf2_file",library:"Aspirin",displayName:"Bagpipe"},{id:"1090_Chaos_sf2_file",library:"Chaos",displayName:"Bagpipe"},{id:"1090_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Bagpipe"},{id:"1090_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Bagpipe"},{id:"1090_JCLive_sf2_file",library:"JCLive",displayName:"Bagpipe"},{id:"1090_SBLive_sf2",library:"SBLive",displayName:"Bagpipe"},{id:"1090_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Bagpipe"},{id:"1100_Aspirin_sf2_file",library:"Aspirin",displayName:"Fiddle"},{id:"1100_Chaos_sf2_file",library:"Chaos",displayName:"Fiddle"},{id:"1100_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Fiddle"},{id:"1100_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Fiddle"},{id:"1100_JCLive_sf2_file",library:"JCLive",displayName:"Fiddle"},{id:"1100_SBLive_sf2",library:"SBLive",displayName:"Fiddle"},{id:"1100_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Fiddle"},{id:"1110_Aspirin_sf2_file",library:"Aspirin",displayName:"Shanai"},{id:"1110_Chaos_sf2_file",library:"Chaos",displayName:"Shanai"},{id:"1110_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Shanai"},{id:"1110_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Shanai"},{id:"1110_JCLive_sf2_file",library:"JCLive",displayName:"Shanai"},{id:"1110_SBLive_sf2",library:"SBLive",displayName:"Shanai"},{id:"1110_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Shanai"},{id:"1120_Aspirin_sf2_file",library:"Aspirin",displayName:"Tinkle Bell"},{id:"1120_Chaos_sf2_file",library:"Chaos",displayName:"Tinkle Bell"},{id:"1120_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Tinkle Bell"},{id:"1120_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Tinkle Bell"},{id:"1120_JCLive_sf2_file",library:"JCLive",displayName:"Tinkle Bell"},{id:"1120_SBLive_sf2",library:"SBLive",displayName:"Tinkle Bell"},{id:"1120_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Tinkle Bell"},{id:"1130_Aspirin_sf2_file",library:"Aspirin",displayName:"Agogo"},{id:"1130_Chaos_sf2_file",library:"Chaos",displayName:"Agogo"},{id:"1130_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Agogo"},{id:"1130_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Agogo"},{id:"1130_JCLive_sf2_file",library:"JCLive",displayName:"Agogo"},{id:"1130_SBLive_sf2",library:"SBLive",displayName:"Agogo"},{id:"1130_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Agogo"},{id:"1140_Aspirin_sf2_file",library:"Aspirin",displayName:"Steel Drums"},{id:"1140_Chaos_sf2_file",library:"Chaos",displayName:"Steel Drums"},{id:"1140_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Steel Drums"},{id:"1140_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Steel Drums"},{id:"1140_JCLive_sf2_file",library:"JCLive",displayName:"Steel Drums"},{id:"1140_SBLive_sf2",library:"SBLive",displayName:"Steel Drums"},{id:"1140_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Steel Drums"},{id:"1150_Aspirin_sf2_file",library:"Aspirin",displayName:"Woodblock"},{id:"1150_Chaos_sf2_file",library:"Chaos",displayName:"Woodblock"},{id:"1150_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Woodblock"},{id:"1150_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Woodblock"},{id:"1150_JCLive_sf2_file",library:"JCLive",displayName:"Woodblock"},{id:"1150_SBLive_sf2",library:"SBLive",displayName:"Woodblock"},{id:"1150_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Woodblock"},{id:"1160_Aspirin_sf2_file",library:"Aspirin",displayName:"Taiko Drum"},{id:"1160_Chaos_sf2_file",library:"Chaos",displayName:"Taiko Drum"},{id:"1160_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Taiko Drum"},{id:"1160_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Taiko Drum"},{id:"1160_JCLive_sf2_file",library:"JCLive",displayName:"Taiko Drum"},{id:"1160_SBLive_sf2",library:"SBLive",displayName:"Taiko Drum"},{id:"1160_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Taiko Drum"},{id:"1170_Aspirin_sf2_file",library:"Aspirin",displayName:"Melodic Tom"},{id:"1170_Chaos_sf2_file",library:"Chaos",displayName:"Melodic Tom"},{id:"1170_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Melodic Tom"},{id:"1170_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Melodic Tom"},{id:"1170_JCLive_sf2_file",library:"JCLive",displayName:"Melodic Tom"},{id:"1170_SBLive_sf2",library:"SBLive",displayName:"Melodic Tom"},{id:"1170_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Melodic Tom"},{id:"1180_Aspirin_sf2_file",library:"Aspirin",displayName:"Synth Drum"},{id:"1180_Chaos_sf2_file",library:"Chaos",displayName:"Synth Drum"},{id:"1180_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Synth Drum"},{id:"1180_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Synth Drum"},{id:"1180_JCLive_sf2_file",library:"JCLive",displayName:"Synth Drum"},{id:"1180_SBLive_sf2",library:"SBLive",displayName:"Synth Drum"},{id:"1180_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Synth Drum"},{id:"1190_Aspirin_sf2_file",library:"Aspirin",displayName:"Reverse Cymbal"},{id:"1190_Chaos_sf2_file",library:"Chaos",displayName:"Reverse Cymbal"},{id:"1190_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Reverse Cymbal"},{id:"1190_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Reverse Cymbal"},{id:"1190_JCLive_sf2_file",library:"JCLive",displayName:"Reverse Cymbal"},{id:"1190_SBLive_sf2",library:"SBLive",displayName:"Reverse Cymbal"},{id:"1190_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Reverse Cymbal"},{id:"1200_Aspirin_sf2_file",library:"Aspirin",displayName:"Guitar Fret Noise"},{id:"1200_Chaos_sf2_file",library:"Chaos",displayName:"Guitar Fret Noise"},{id:"1200_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Guitar Fret Noise"},{id:"1200_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Guitar Fret Noise"},{id:"1200_JCLive_sf2_file",library:"JCLive",displayName:"Guitar Fret Noise"},{id:"1200_SBLive_sf2",library:"SBLive",displayName:"Guitar Fret Noise"},{id:"1200_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Guitar Fret Noise"},{id:"1210_Aspirin_sf2_file",library:"Aspirin",displayName:"Breath Noise"},{id:"1210_Chaos_sf2_file",library:"Chaos",displayName:"Breath Noise"},{id:"1210_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Breath Noise"},{id:"1210_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Breath Noise"},{id:"1210_JCLive_sf2_file",library:"JCLive",displayName:"Breath Noise"},{id:"1210_SBLive_sf2",library:"SBLive",displayName:"Breath Noise"},{id:"1210_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Breath Noise"},{id:"1220_Aspirin_sf2_file",library:"Aspirin",displayName:"Seashore"},{id:"1220_Chaos_sf2_file",library:"Chaos",displayName:"Seashore"},{id:"1220_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Seashore"},{id:"1220_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Seashore"},{id:"1220_JCLive_sf2_file",library:"JCLive",displayName:"Seashore"},{id:"1220_SBLive_sf2",library:"SBLive",displayName:"Seashore"},{id:"1220_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Seashore"},{id:"1230_Aspirin_sf2_file",library:"Aspirin",displayName:"Bird Tweet"},{id:"1230_Chaos_sf2_file",library:"Chaos",displayName:"Bird Tweet"},{id:"1230_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Bird Tweet"},{id:"1230_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Bird Tweet"},{id:"1230_JCLive_sf2_file",library:"JCLive",displayName:"Bird Tweet"},{id:"1230_SBLive_sf2",library:"SBLive",displayName:"Bird Tweet"},{id:"1230_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Bird Tweet"},{id:"1240_Aspirin_sf2_file",library:"Aspirin",displayName:"Telephone Ring"},{id:"1240_Chaos_sf2_file",library:"Chaos",displayName:"Telephone Ring"},{id:"1240_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Telephone Ring"},{id:"1240_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Telephone Ring"},{id:"1240_JCLive_sf2_file",library:"JCLive",displayName:"Telephone Ring"},{id:"1240_SBLive_sf2",library:"SBLive",displayName:"Telephone Ring"},{id:"1240_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Telephone Ring"},{id:"1250_Aspirin_sf2_file",library:"Aspirin",displayName:"Helicopter"},{id:"1250_Chaos_sf2_file",library:"Chaos",displayName:"Helicopter"},{id:"1250_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Helicopter"},{id:"1250_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Helicopter"},{id:"1250_JCLive_sf2_file",library:"JCLive",displayName:"Helicopter"},{id:"1250_SBLive_sf2",library:"SBLive",displayName:"Helicopter"},{id:"1250_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Helicopter"},{id:"1260_Aspirin_sf2_file",library:"Aspirin",displayName:"Applause"},{id:"1260_Chaos_sf2_file",library:"Chaos",displayName:"Applause"},{id:"1260_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Applause"},{id:"1260_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Applause"},{id:"1260_JCLive_sf2_file",library:"JCLive",displayName:"Applause"},{id:"1260_SBLive_sf2",library:"SBLive",displayName:"Applause"},{id:"1260_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Applause"},{id:"1270_Aspirin_sf2_file",library:"Aspirin",displayName:"Gunshot"},{id:"1270_Chaos_sf2_file",library:"Chaos",displayName:"Gunshot"},{id:"1270_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Gunshot"},{id:"1270_GeneralUserGS_sf2_file",library:"GeneralUserGS",displayName:"Gunshot"},{id:"1270_JCLive_sf2_file",library:"JCLive",displayName:"Gunshot"},{id:"1270_SBLive_sf2",library:"SBLive",displayName:"Gunshot"},{id:"1270_SoundBlasterOld_sf2",library:"SoundBlasterOld",displayName:"Gunshot"},{id:"12835_1_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 1"},{id:"12835_1_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 1"},{id:"12835_1_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 1"},{id:"12835_1_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 1"},{id:"12835_2_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 2"},{id:"12835_2_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 2"},{id:"12835_2_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 2"},{id:"12835_2_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 2"},{id:"12835_3_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 3"},{id:"12835_3_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 3"},{id:"12835_3_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 3"},{id:"12835_3_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 3"},{id:"12835_4_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 4"},{id:"12835_4_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 4"},{id:"12835_4_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 4"},{id:"12835_4_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 4"},{id:"12835_5_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 5"},{id:"12835_5_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 5"},{id:"12835_5_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 5"},{id:"12835_5_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 5"},{id:"12835_6_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 6"},{id:"12835_6_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 6"},{id:"12835_6_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 6"},{id:"12835_6_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 6"},{id:"12835_7_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 7"},{id:"12835_7_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 7"},{id:"12835_7_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 7"},{id:"12835_7_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 7"},{id:"12835_8_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 8"},{id:"12835_8_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 8"},{id:"12835_8_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 8"},{id:"12835_8_SBLive_sf2_file",library:"SBLive",displayName:"Drum Kit 8"},{id:"12835_9_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 9"},{id:"12835_9_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 9"},{id:"12835_9_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 9"},{id:"12835_10_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 10"},{id:"12835_10_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 10"},{id:"12835_10_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 10"},{id:"12835_11_Chaos_sf2_file",library:"Chaos",displayName:"Drum Kit 11"},{id:"12835_11_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 11"},{id:"12835_11_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 11"},{id:"12835_12_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 12"},{id:"12835_12_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 12"},{id:"12835_13_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 13"},{id:"12835_13_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 13"},{id:"12835_14_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 14"},{id:"12835_14_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 14"},{id:"12835_15_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 15"},{id:"12835_15_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 15"},{id:"12835_16_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 16"},{id:"12835_16_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 16"},{id:"12835_17_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 17"},{id:"12835_17_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 17"},{id:"12835_18_FluidR3_GM_sf2_file",library:"FluidR3_GM",displayName:"Drum Kit 18"},{id:"12835_18_JCLive_sf2_file",library:"JCLive",displayName:"Drum Kit 18"}];function Va(i){const e=1+i%18,t=pt.find(n=>n.id.startsWith(`12835_${e}_`)&&n.library==="FluidR3_GM");if(t)return{library:t.library,displayName:t.displayName};const s=pt.find(n=>n.id.startsWith(`12835_${e}_`));return s?{library:s.library,displayName:s.displayName}:null}const Ya=Array.from({length:47},(i,e)=>35+e),Za={35:"kick2",36:"kick1",37:"rim",38:"snare1",39:"clap",40:"snare2",41:"lowtom2",42:"hh_closed",43:"lowtom1",44:"hh_pedal",45:"midtom2",46:"hh_open",47:"midtom1",48:"hitom2",49:"crash1",50:"hitom1",51:"ride1",52:"china",53:"ride_bell",54:"tamb",55:"splash",56:"cowbell",57:"crash2",58:"vibraslap",59:"ride2",60:"bongo_hi",61:"bongo_lo",62:"conga_hi_mute",63:"conga_hi_open",64:"conga_lo",65:"timbale_hi",66:"timbale_lo",67:"agogo_hi",68:"agogo_lo",69:"cabasa",70:"maracas",71:"whistle_short",72:"whistle_long",73:"guiro_short",74:"guiro_long",75:"claves",76:"woodblock_hi",77:"woodblock_lo",78:"cuica_mute",79:"cuica_open",80:"triangle_mute",81:"triangle_open"},fs=Ia,ai=new Map;let pe=null;function ps(i){return Math.max(i,1e-4)}async function Pt(i){return new Promise((e,t)=>{const s=document.createElement("script");s.src=i,s.onload=()=>e(),s.onerror=()=>t(new Error(`Failed to load script: ${i}`)),document.body.appendChild(s)})}async function Qa(){pe||(await Pt("https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"),pe=new window.WebAudioFontPlayer)}async function Di(i,e=te(),t=null,s,n,r,a=!0){const[o,l]=i.split("/"),d=String(e),c=`${o}/${l}@${d}`;ai.has(e)||ai.set(e,new Map);const u=ai.get(e);if(a&&u.has(c))return u.get(c);if(await Qa(),pe.resumeContext){const w=pe.resumeContext;pe.resumeContext=L=>{if(!(L instanceof OfflineAudioContext))return w.call(pe,L)}}const f=pt.find(w=>w.library===o&&w.displayName===l);if(!f)throw new Error(`Could not find WebAudioFont entry for library=${o} and instrument=${l}`);t&&t.context!==e&&(console.warn("[WebAudioFont] Ignoring mismatched destination from another context"),t=null);const h=t||ze(e),m=e.createStereoPanner();if(m.pan.value=n??0,m.connect(h),!f.displayName.startsWith("Drum Kit")){const w=`_tone_${f.id}`,L=`https://surikov.github.io/webaudiofontdata/sound/${f.id}.js`;r?await Pt(L):await fs(Pt(L));const k=window[w];if(!k)throw new Error(`Missing preset: ${w}`);if(pe.loader.decodeAfterLoading(e,w),e instanceof OfflineAudioContext){const M=(k==null?void 0:k.zones)??[];for(const x of M)if(x.file&&!x.buffer){const G=atob(x.file),P=new ArrayBuffer(G.length),R=new Uint8Array(P);for(let $=0;$<G.length;$++)R[$]=G.charCodeAt($);x.buffer=await new Promise(($,oe)=>e.decodeAudioData(P,$,oe))}}const B={_preset:k,_volume:s??1,_activeEnvelopes:[],start({note:M,duration:x=1,velocity:G=100,time:P}){const R=typeof M=="string"?j(M):M;if(R==null||typeof R!="number")return;const $=typeof P=="number"?P:0,oe=Math.max(.01,Math.min(1,G/127)),Ae=ps(B._volume),ti=Math.max(.01,Math.min(1,Ae*oe)),xt=pe.queueWaveTable(e,m||ze(),k,$,R,x,ti);B._activeEnvelopes.push(xt)},stop(){var M;for(const x of B._activeEnvelopes)try{x.cancel?x.cancel():(M=x.audioBufferSourceNode)!=null&&M.stop&&x.audioBufferSourceNode.stop()}catch(G){console.warn("Failed to stop envelope:",G)}B._activeEnvelopes=[]},setVolume(M){B._volume=Math.max(0,Math.min(1,M))},setPan(M){m.pan.value=Math.max(-1,Math.min(1,M))},load:Promise.resolve()};return a&&u.set(c,B),B}const g=f.id.match(/^12835_(\d+)_([A-Za-z0-9_]+)_sf2_file$/);if(!g)throw new Error(`Invalid drum ID format in catalogue: ${f.id}`);const[,p,_]=g,S=parseInt(p,10),v={},C=async()=>{for(const w of Ya){const L=`_drum_${w}_${S}_${_}_sf2_file`,k=`https://surikov.github.io/webaudiofontdata/sound/${12800+w}_${S}_${_}_sf2_file.js`;try{await Pt(k);const B=window[L];if(!B){console.warn(`Missing drum preset: ${L}`);continue}pe.loader.decodeAfterLoading(e,L),v[w]=B}catch(B){console.warn(`Failed to load drum preset ${w}: ${B}`)}}};r??!1?await C():await fs(C());const N={_preset:v,_volume:s??1,_activeEnvelopes:[],start({note:w,duration:L=1,velocity:k=100,time:B}){const M=typeof w=="string"?j(w):w;if(M==null||typeof M!="number"){console.warn(`Invalid MIDI pitch: ${w}`);return}const x=v[M];if(!x){console.warn(`No drum preset loaded for MIDI ${M}`);return}const G=typeof B=="number"?B:0,P=ps(N._volume),R=pe.queueWaveTable(e,m||ze(),x,G,M,L,P);N._activeEnvelopes.push(R)},stop(){var w;for(const L of N._activeEnvelopes)try{L.cancel?L.cancel():(w=L.audioBufferSourceNode)!=null&&w.stop&&L.audioBufferSourceNode.stop()}catch(k){console.warn("Failed to stop envelope:",k)}N._activeEnvelopes=[]},load:Promise.resolve(),setVolume(w){N._volume=Math.max(0,Math.min(1,w))},setPan(w){m.pan.value=Math.max(-1,Math.min(1,w))}};return a&&u.set(c,N),N}async function eo(){const i=new Set;for(const e of pt)i.add(e.library);return Array.from(i)}async function to(i){return pt.filter(e=>e.library===i).map(e=>e.displayName)}function io(){return{name:"webaudiofont",loadInstrument:Di,getAvailableLibraries:eo,getAvailableInstruments:to}}let Mi=null,xi=null;async function so(i){if(xi===i)return;const[,e,t]=i.split("/");Mi=await Di(`${e}/${t}`,Fe()),xi=i}function ro(){return xi}function no(i,e=100,t=!1){if(!Mi)return null;const n=Fe().currentTime,r=j(i);return r===null?null:(Mi.start({note:r,velocity:e,time:n,duration:1.5,loop:t}),()=>{})}function ao(i){}async function oo(i,e,t,s=100,n=!1,r=null,a=null,o=null,l,d){const c=a||te(),[,u,f]=i.split("/"),h=await Di(`${u}/${f}`,c,o,l,d);l!==void 0&&h.setVolume&&h.setVolume(l),d!==void 0&&h.setPan&&h.setPan(d);const m=j(e);return m===null||h.start({note:m,duration:t,velocity:s,loop:n,time:r??c.currentTime}),null}function lo(){return{name:"webaudiofont",setActiveInstrument:so,getActiveInstrumentName:ro,playNote:no,stopNoteByPitch:ao,loadAndPlayNote:oo}}function pr(i=3){const r=["C","D","E","F","G","A","B"],a=["C#","D#","","F#","G#","A#",""],o=[i,i+1,i+2],l={};let d=0;for(const c of o)r.forEach(u=>{const f=`${u}${c}`;l[f]={note:f,x:d,width:60,height:200,isBlack:!1},d+=60});d=0;for(const c of o)a.forEach((u,f)=>{if(u===""){d+=60;return}const h=`${u}${c}`;l[h]={note:h,x:d+60-40/2,width:40,height:120,isBlack:!0},d+=60});return l}let Ft="sf2/fluidr3-gm/acoustic_grand_piano",Ui=3,mr=!1,yr=pr(Ui);function co(){Ft="sf2/fluidr3-gm/acoustic_grand_piano",Ki(Ft)}function uo(i){Ki(i),Ft=i}function qi(){return Ft}function ho(){const i=document.getElementById("instrument-loop-toggle");return(i==null?void 0:i.checked)??!1}function oi(){return Ui}function ms(i){Ui=i}function Re(){return mr}function fo(i){mr=i}function $e(){return yr}function po(i){yr=i}const vt={sf2:Xa(),webaudiofont:lo()};async function Ki(i){if(!i.includes("/"))throw new Error(`Invalid instrument name: "${i}". Expected "<engine>/<library>/<instrument>"`);const e=i.split("/")[0],t=vt[e];if(!t)throw new Error(`Engine "${e}" not available`);await t.setActiveInstrument(i)}function gr(i,e=100,t=!1){const s=qi();if(!s)return null;const n=s.split("/")[0],r=vt[n];if(!r)throw new Error(`Engine "${n}" not available`);return r.playNote(i,e,t)}function mo(i){const e=qi();if(!e)return;const t=e.split("/")[0],s=vt[t];if(!s)throw new Error(`Engine "${t}" not available`);s.stopNoteByPitch(i)}async function yo(i,e,t=1,s=100,n=!1,r=null,a=null,o=null,l,d){const c=i.split("/")[0],u=vt[c];if(!u)throw new Error(`Engine "${c}" not available`);let f=a??te(),h=o;return f.state==="suspended"&&(console.warn("[loadAndPlayNote] Using preview context due to suspended main context"),f=Fe(),h=Ka()),await u.loadAndPlayNote(i,e,t,s,n,r,f,h,l,d)}let li=null;function te(){return li||(li=new(window.AudioContext||window.webkitAudioContext)),li}const ci=new WeakMap,di=new WeakMap;function br(i=te()){if(!di.has(i)){const e=i.createAnalyser();e.fftSize=2048,di.set(i,e)}return di.get(i)}function ze(i=te()){if(!ci.has(i)){const e=i.createGain(),t=br(i);e.connect(t),t.connect(i.destination),ci.set(i,e)}return ci.get(i)}function go(i){try{const e=gr(i,100,!1);return e?{stop:e,forceStop:e}:null}catch(e){return console.error("[playNote] Failed to play note",i,e),null}}function bo(i,e){const t=structuredClone(i);return t.tempo=e.bpm,t}function _r(i){return{type:"CHANGE_TEMPO",bpm:i}}function _o(i){return _r(i)}function vo(i,e){const t=structuredClone(i);return t.timeSignature=[e.beats,4],t}function vr(i){return{type:"SET_TIME_SIGNATURE",beats:i}}function So(i){return vr(i)}function Co(i,e){const t=structuredClone(i);return t.totalMeasures=e.measures,t}function Sr(i){return{type:"SET_TOTAL_MEASURES",measures:i}}function No(i){return Sr(i)}const wo=new Set(["C","C#","Db","D","D#","Eb","E","E#","Fb","F","F#","Gb","G","G#","Ab","A","A#","Bb","B","B#","Cb"]),Mo=new Set(["M","m"]);function xo(i){const e=i.slice(0,-1),t=i.slice(-1);if(!wo.has(e)||!Mo.has(t))return null;const s=t==="M"?"major":"minor",n=$n.get(`${e} ${s}`);return n.empty?null:n.notes}const Lo=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],ko=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],Cr={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function Ao(i){return i.includes("#")}function Y(i){const e=i==null?void 0:i.match(/^([A-Ga-g])([#b]*)(-?\d+)$/);if(!e)return null;const[,t,s,n]=e,r=t.toUpperCase(),a=Cr[r];if(a===void 0)return null;const o=[...s].reduce((d,c)=>c==="#"?d+1:c==="b"?d-1:d,0);return 12*(parseInt(n,10)+1)+(a+o)}function ye(i){return Y(i)}const Bo=i=>{const e=Y(i);return e!==null?e%12:0};function $i(i,e=21,t){const s=Y(i);if(s===null)return null;const n=t-e+1,r=s-e,a=n-1-r;return a>=0&&a<n?a:null}function ne(i,e,t){const n=t-e+1-1-i,r=e+n;return Pe(r)}function Pe(i,e=!1){const s=(e?ko:Lo)[i%12],n=Math.floor(i/12)-1;return`${s}${n}`}function Nr(i,e){const t=new Map;for(let s=i;s<=e;s++)t.set(s,Ao(Pe(s)));return t}function Go(i,e){const t=Y(i),s=Y(e);if(t===null||s===null)throw new Error(`Invalid pitches provided: ${i}, ${e}`);return t-s}function wr(i){const e=xo(i),t=new Map;if(!e)return t;const s=new Set(e.map(n=>Cr[n]%12));for(let n=0;n<=127;n++){const r=n%12;t.set(n,s.has(r))}return t}const Mr="grid-key-highlighting",xr="grid-snap-enabled",Lr="snap-to-in-key",Eo="CM";let kr=Qe(Mr)??!1,Ar=Qe(xr)??!0,Br=Qe(Lr)??!1,Gr=wr(Eo),Er=!1;function Tr(){return kr}function To(i){kr=i,bt(Mr,i)}function Ir(){return Ar}function Io(i){Ar=i,bt(xr,i)}function zt(){return Br}function Ro(i){Br=i,bt(Lr,i)}function Ht(){return Gr}function Po(i){Gr=wr(i)}function mt(){return Er}function ys(i){Er=i}function Oo(i,e){const t=structuredClone(i);return t.songKey=e.songKey,Po(e.songKey),t}function Rr(i){return{type:"CHANGE_SONG_KEY",songKey:i}}function Fo(i){return Rr(i)}function Do(i,e){const t=structuredClone(i);return t.snapResolution=e.snapResolution,t}function Pr(i){return{type:"CHANGE_SNAP_RESOLUTION",snapResolution:i}}function Uo(i){return Pr(i)}function qo(i,e){const t=structuredClone(i);return t.noteDuration=e.noteDuration,t}function Or(i){return{type:"CHANGE_NOTE_DURATION",noteDuration:i}}function Ko(i){return Or(i)}function $o(i,e){const t=structuredClone(i);return t.isTripletMode=e.triplet,t.isDottedMode=e.dotted,t}function Fr(i,e){return{type:"SET_NOTE_MODIFIER_MODE",triplet:i,dotted:e}}function zo(i,e){return Fr(i,e)}const zi={sf2:qa(),webaudiofont:io()},Dr="sf2";async function Ur(i,e,t,s,n,r,a=!0){const o=i.split("/");if(o.length!==3)throw new Error(`Invalid instrument fullName format: "${i}". Expected format "engine/library/instrument"`);const[l,d,c]=o,u=zi[l];if(!u)throw new Error(`Engine "${l}" not available`);return await u.loadInstrument(`${d}/${c}`,e,t,s,n,r,a)}async function Ho(i,e,t,s,n,r,a){if(!s||s.length===0)return;const o=60/ve();if(a!=null&&a.aborted)return;const l=await Ur(i,e,t,n,r);if(!(a!=null&&a.aborted))for(const d of s){if(a!=null&&a.aborted)return;const c=d.start*o,u=Math.max(.01,c),f=d.duration*o,h=d.velocity??100,m=Y(d.pitch);if(m==null)continue;const b=i.split("/"),p=(b.length>=3?b[1]:b[0])==="drummachines"&&l.__midiMap?l.__midiMap.get(m)??m:m;try{l.start({note:p,duration:f,velocity:h,time:u,loop:!1})}catch(_){console.warn("[exportNotesToOffline] Failed to start note:",d,_)}}}function gs(i){if(!i.container)return;const e=i.container.querySelector(".mute-btn"),t=i.container.querySelector(".solo-btn"),s=i.container.querySelector(".sequencer-body"),n=i.container.querySelector(".mini-contour");e==null||e.classList.toggle("bg-red-600",i.mute),e==null||e.classList.toggle("bg-gray-700",!i.mute),t==null||t.classList.toggle("bg-yellow-200",i.solo),t==null||t.classList.toggle("bg-gray-700",!i.solo);const r=i.mute&&!i.solo;s==null||s.classList.toggle("opacity-40",r),s==null||s.classList.toggle("opacity-100",!r),n==null||n.classList.toggle("opacity-40",r),n==null||n.classList.toggle("opacity-100",!r)}const We=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926","#0077b6","#00b4d8","#005f73","#03045e","#023e8a"];function Jt(i,e,t,s=0){const n=i.getContext("2d");if(!n)return;n.imageSmoothingEnabled=!1;const r=i.width,a=i.height;if(n.clearRect(0,0,r,a),!e.length)return;const o=We[s%We.length];n.fillStyle=o;const l=ae(),d=e.map(p=>j(p.pitch)).filter(p=>p!==null);if(!d.length)return;let c=Math.min(...d),u=Math.max(...d),f=Math.max(1,u-c);for(;a%f!==0;)u++,f=u-c;const h=a/f;for(const p of e){const _=j(p.pitch);if(_==null)continue;const S=p.start/l*r,v=p.duration/l*r,C=(_-c)/f,N=a-C*a-h/2,w=Math.round(S),L=Math.max(1,Math.round(v)),k=Math.round(N);n.fillRect(w,k,L,h)}const m=Oe(),b=ns();n.save();let g=1;b>256?g=16:b>128?g=8:b>32&&(g=4);for(let p=0;p<=b;p++){if(p%g!==0)continue;const S=p*m/l*r,v=Math.round(S)+.5;n.beginPath(),n.moveTo(v,0),n.lineTo(v,a);const C=g===1||p%(g*2)===0;n.strokeStyle=C?"rgba(255, 255, 255, 0.12)":"rgba(255, 255, 255, 0.04)",n.lineWidth=.2,n.stroke()}n.restore()}function Li(i,e){const{config:t,container:s,matrix:n,colorIndex:r,getNotes:a}=i,[o,l]=e,d=Y(o),c=Y(l);if(d===null||c===null){console.warn(`Invalid note range: ${e}`);return}if(d>=c){console.warn("Invalid note range: low note must be lower than high note");return}t.noteRange=e,t.visibleNotes=Go(l,o)+1;const u=s==null?void 0:s.querySelector(".mini-contour");u&&Jt(u,a(),t,r),n.setNoteRange(d,c)}function Jo(i){i.instrumentName.toLowerCase().includes("drum kit")?(Li(i,["B1","A5"]),i.matrix.setCustomLabels(Za)):(Li(i,["A0","C9"]),i.matrix.setCustomLabels(null))}const Wt=new Map;function Wo(){Wt.clear()}function jo(i,e){Wt.set(i,e)}function Xo(i){Wt.delete(i)}function qr(i){return Wt.get(i)}function Dt(i,e=!0,t=null){var o;const s=qr(i.id);if(!s)return;const n=W.getInstance(),r=s.getMatrixContainer(),a=s.getMiniContourCanvas();if(!(!r||!a)){if(i.collapsed=e,s.collapsed=e,r.classList.toggle("hidden",e),a.classList.toggle("hidden",!e),t){const l=t.querySelector("img");if(l){const d=e?"icon-caret-up":"icon-caret-down";l.src=fe(`static/svg/${d}.svg`)}}if(e){s.toggleZoomControls(!1),s.toggleGripHandle(!1);for(const l of i.scheduledAnimations)clearTimeout(l);i.scheduledAnimations=[],Jt(a,i.notes,i.config,i.colorIndex)}else s.toggleZoomControls(!0),s.toggleGripHandle(!0),(o=i.matrix)==null||o.resize(),n.isActive()&&i.resumeAnimationsFromCurrentTime(n.getStartTime(),n.getStartBeat())}}function Vo(){for(const i of J())Dt(i,!0)}const Yo={totalMeasures:8,beatsPerMeasure:4,layout:{labelWidthColumns:1,headerHeightRows:2,footerHeightRows:1,labelWidth:80,headerHeight:40,footerHeight:40,baseCellWidth:70,minCellWidth:10,maxCellWidth:200,verticalCellRatio:4,highestMidi:108,lowestMidi:21},display:{showMeasureLines:!0,showBeatLines:!0,showHoveredCell:!0,highlightCurrentMeasure:!0},behavior:{zoom:1,scrollMargin:48,enableSnapping:!0,snapDivisions:4,maxZoom:1.6,minZoom:.5}};function Zo(){return structuredClone(Yo)}function bs(i,e){return{...i,...e,layout:{...i.layout,...e.layout??{}},display:{...i.display,...e.display??{}},behavior:{...i.behavior,...e.behavior??{}}}}const Hi={Midnight:{whiteKey:"#1e1e1e",blackKey:"#2a103b",labelWhite:"#2c2c2c",labelBlack:"#3a1d4d",textWhite:"#cfcfcf",textBlack:"#e6d9ff",gridLine:"#333",beatLine:"#4e3d63",measureLine:"#8561c2",outOfKey:"rgb(255, 1, 1)"},Seashell:{whiteKey:"#fefefe",blackKey:"#f1e7dc",labelWhite:"#dddddd",labelBlack:"#d4cfc9",textWhite:"#444",textBlack:"#663300",gridLine:"#ccc",beatLine:"#bbb",measureLine:"#999",outOfKey:"rgba(255, 255, 255, 0.05)"},Cyberpunk:{whiteKey:"#162447",blackKey:"#1b1b2f",labelWhite:"#1f4068",labelBlack:"#1f4068",textWhite:"#e43f5a",textBlack:"#e43f5a",gridLine:"#1f4068",beatLine:"#e43f5a",measureLine:"#ffcc00",outOfKey:"rgba(255, 255, 255, 0.05)"},"Classic Blue":{whiteKey:"#f5faff",blackKey:"#dceeff",labelWhite:"#aaccee",labelBlack:"#88bbdd",textWhite:"#002244",textBlack:"#001122",gridLine:"#99bbdd",beatLine:"#88aacc",measureLine:"#336699",outOfKey:"rgba(255, 255, 255, 0.05)"},Darkroom:{whiteKey:"#2c2c2c",blackKey:"#1e1e1e",labelWhite:"#2a2a2a",labelBlack:"#383838",textWhite:"#e0e0e0",textBlack:"#a0a0a0",gridLine:"#404040",beatLine:"#606060",measureLine:"#808080",outOfKey:"rgba(255, 255, 255, 0.05)"}};class Qo{constructor(e,t,s,n,r){this.getBlackKeyMap=n,this.getInKeyMap=r,this.scroll=e,this.config=t,this.interactionStore=s}draw(e){const{totalMeasures:t,beatsPerMeasure:s,layout:{baseCellWidth:n,verticalCellRatio:r,labelWidth:a,headerHeight:o},behavior:{zoom:l}}=this.config,{gridColorScheme:d}=V().theme,c=Hi[d],u=this.config.layout.highestMidi-this.config.layout.lowestMidi+1,f=n*l,h=f/r,m=this.scroll.getX(),b=this.scroll.getY();(e.canvas.width-a)/f;const g=t*s;e.save(),e.translate(a-m,o-b);const p=Math.max(0,Math.floor((m-a)/f)),_=Tr(),S=this.getInKeyMap();for(let v=0;v<u;v++){const C=v*h,N=this.config.layout.highestMidi-v;let w;_?w=S.get(N)?c.whiteKey:c.blackKey:w=this.getBlackKeyMap().get(N)?c.blackKey:c.whiteKey,e.fillStyle=w,e.fillRect(0,C,g*f,h),e.strokeStyle=c.gridLine,e.beginPath(),e.moveTo(0,C),e.lineTo(g*f,C),e.stroke()}for(let v=p;v<=g;v++){if(v<0)continue;const C=v*f;e.strokeStyle=v%s===0?c.measureLine:c.beatLine,e.beginPath(),e.moveTo(C,0),e.lineTo(C,u*h),e.stroke()}e.restore()}}function el(i){const{layout:{labelWidth:e,baseCellWidth:t},totalMeasures:s,beatsPerMeasure:n,behavior:{zoom:r}}=i,a=t*r;return e+s*n*a}function tl(i){const{layout:{baseCellWidth:e,verticalCellRatio:t,highestMidi:s,lowestMidi:n,headerHeight:r},behavior:{zoom:a}}=i,o=s-n+1,l=e*a/t;return o*l+r}class il{constructor(e,t){this.scrollX=0,this.scrollY=0,this.canvas=e,this.config=t}getX(){return this.scrollX}getY(){return this.scrollY}setScroll(e,t){this.scrollX=this.clampX(e),this.scrollY=this.clampY(t)}recalculateBounds(){}getMaxScrollX(){const e=this.canvas.offsetWidth-this.config.layout.labelWidth;return Math.max(0,this.getContentWidth()-e)}getMaxScrollY(){const e=this.canvas.offsetHeight-this.config.layout.headerHeight;return Math.max(0,this.getContentHeight()-e)}clampX(e){return Math.max(0,Math.min(e,this.getMaxScrollX()))}clampY(e){return Math.max(0,Math.min(e,this.getMaxScrollY()))}getContentWidth(){return el(this.config)}getContentHeight(){return tl(this.config)}}function it(i,e){const t=e.getBoundingClientRect();return{x:i.clientX-t.left,y:i.clientY-t.top}}function Kr(i,e,t,s){const n=e.getBoundingClientRect();return{x:i.clientX-n.left+t.getX()-s.layout.labelWidth,y:i.clientY-n.top+t.getY()-s.layout.headerHeight}}function sl(i,e,t,s,n){const r=t.getBoundingClientRect();return{x:i-r.left+s.getX()-n.layout.labelWidth,y:e-r.top+s.getY()-n.layout.headerHeight}}function St(i,e,t,s,n=!1){const{layout:{labelWidth:r,headerHeight:a,baseCellWidth:o,verticalCellRatio:l,highestMidi:d,lowestMidi:c},behavior:{zoom:u}}=t,f=d-c+1,h=o*u,m=h/l,b=(i.x+e.getX()-r)/h;let g=Math.floor((i.y+e.getY()-a)/m);const p=n?s*(2/3):s,_=Math.floor(b/p)*p;if(_<0||g<0||g>=f)return null;if(zt()&&!mt()){const S=Ht(),v=d-g;let C=null,N=1/0;for(let w=-12;w<=12;w++){const L=v+w;if(L<c||L>d||!S.get(L))continue;const k=d-L,B=Math.abs(k-g);if(B<N&&(N=B,C=k),B===0)break}C!==null&&(g=C)}return{x:_,y:g}}class rl{constructor(e,t){this.notes=[],this.noteIndex=new Map,this.pitchIndex=new Map,this.config=e,this.playNote=t}set(e){this.notes=e}getAll(){return this.notes}add(e){this.notes.push(e)}getTrackedNotes(e){const t=e.getHoveredNoteKey(),s=r=>e.isNoteHighlighted(r),n=new Set(e.getSelectedNotes().map(r=>`${r.pitch}:${r.start}`));return this.notes.map(r=>{const a=`${r.pitch}:${r.start}`;return{note:r,state:{hovered:a===t,selected:n.has(a),highlighted:s(r)}}})}remove(e){const t=`${e.pitch}:${e.start}`;this.notes=this.notes.filter(s=>!(s.pitch===e.pitch&&s.start===e.start)),this.noteIndex.delete(t)}removeAll(e){const t=new Set(e.map(s=>`${s.pitch}:${s.start}`));this.notes=this.notes.filter(s=>!t.has(`${s.pitch}:${s.start}`));for(const s of t)this.noteIndex.delete(s)}rebuildIndex(){this.noteIndex.clear(),this.pitchIndex.clear();for(const e of this.notes){const t=`${e.pitch}:${e.start}`;this.noteIndex.set(t,e),this.pitchIndex.has(e.pitch)||this.pitchIndex.set(e.pitch,[]),this.pitchIndex.get(e.pitch).push(e)}for(const e of this.pitchIndex.values())e.sort((t,s)=>t.start-s.start)}findNoteAtMousePosition(e,t,s,n,r,a=!0){const o=it(e,t);E("Raw mouse pos (grid-relative)",o);const l=Qt(),d=St(o,s,n,l);if(!d){E("Snapped position is invalid",{mouse:o,snap:l});return}const c=ne(d.y,n.layout.lowestMidi,n.layout.highestMidi),u=d.x;E("Snapped grid position",d),E("Computed pitch and beat",{pitch:c,beat:u});const f=r.findNoteUnderCursor(c,u);return E("Note under cursor (if any)",f),f}findAtPosition(e,t){return this.noteIndex.get(`${e}:${t}`)}findNoteUnderCursor(e,t){const s=this.pitchIndex.get(e);if(!s||s.length===0)return;let n=0,r=s.length-1,a=-1;for(;n<=r;){const o=Math.floor((n+r)/2);s[o].start<=t?(a=o,n=o+1):r=o-1}if(a!==-1)for(let o=a;o>=0;o--){const l=s[o];if(t>=l.start&&t<l.start+l.duration)return l;if(l.start+l.duration<t)break}}findNoteEdgeAtCursor(e,t,s=.25){const n=this.pitchIndex.get(e);if(!n||n.length===0)return;let r=0,a=n.length-1,o=-1;for(;r<=a;){const l=Math.floor((r+a)/2);n[l].start<=t?(o=l,r=l+1):a=l-1}if(o!==-1)for(let l=o;l>=0;l--){const d=n[l],c=d.start+d.duration*(1-s),u=d.start+d.duration;if(t>=c&&t<=u)return d;if(d.start+d.duration<t)break}}mergeSelections(e,t){const s=new Set,n=[];for(const r of[...e,...t]){const a=`${r.pitch}:${r.start}`;s.has(a)||(s.add(a),n.push(r))}return n}previewNote(e,t,s=100,n=!1){this.playNote(e,t,s,n)}}function je(i,e,t,s,n,r=4){i.beginPath(),i.moveTo(e+r,t),i.lineTo(e+s-r,t),i.quadraticCurveTo(e+s,t,e+s,t+r),i.lineTo(e+s,t+n-r),i.quadraticCurveTo(e+s,t+n,e+s-r,t+n),i.lineTo(e+r,t+n),i.quadraticCurveTo(e,t+n,e,t+n-r),i.lineTo(e,t+r),i.quadraticCurveTo(e,t,e+r,t),i.closePath()}function nl(i,e,t,s){const{layout:{baseCellWidth:n,verticalCellRatio:r,highestMidi:a,lowestMidi:o},behavior:{zoom:l}}=t,d=a-o+1,c=n*l,u=c/r,f=s.offsetWidth,h=s.offsetHeight,m=0,b=i/c-m,g=(i+f)/c+m,p=Math.floor(e/u),_=Math.min(d-1,Math.ceil((e+h)/u)+m),S=new Map;return v=>v.filter(({note:C})=>{if(C.start+C.duration<b||C.start>g)return!1;let w=S.get(C.pitch);if(w==null){const L=$i(C.pitch,o,a);if(L==null||L<0||L>=d)return!1;w=L,S.set(C.pitch,w)}return w>=p&&w<=_})}function al(i){const e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;i=i.replace(e,(u,f,h,m)=>f+f+h+h+m+m);const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);if(!t)return null;const s=parseInt(t[1],16)/255,n=parseInt(t[2],16)/255,r=parseInt(t[3],16)/255,a=Math.max(s,n,r),o=Math.min(s,n,r);let l=0,d=0,c=(a+o)/2;if(a!==o){const u=a-o;switch(d=c>.5?u/(2-a-o):u/(a+o),a){case s:l=(n-r)/u+(n<r?6:0);break;case n:l=(r-s)/u+2;break;case r:l=(s-n)/u+4;break}l*=60}return{h:Math.round(l),s:Math.round(d*100),l:Math.round(c*100)}}const ol=["#FF0000","#9400D3","#FFFF00","#FF69B4","#00FF00","#00FFFF","#0000FF","#8A2BE2","#FF8C00","#FFD700","#ADFF2F","#DC143C"];function ll(i,e){const t=al(i);if(!t)return"#999";const n=10+(e??100)/127*50;return`hsl(${t.h}, ${t.s}%, ${n}%)`}function kt(i){return(e,t)=>{const s=i(e,t);return ll(s,e.velocity)}}function cl(i){const e=Y(i.pitch);if(e==null)return"#999";const t=e*3%360,s=100,n=60,a=.2+(i.velocity??100)/127*.8;return`hsla(${t}, ${s}%, ${n}%, ${a})`}const dl={Scriabin:kt((i,{getPitchClass:e}={})=>{const t=e?e(i.pitch):0;return ol[t]||"#999"}),"Track Color":kt((i,{getTrackColor:e}={})=>(e==null?void 0:e())||"#999"),"Note Velocity":kt((i,{getTrackColor:e}={})=>(e==null?void 0:e())||"#ff0000"),"Octave Bands":cl,"Pitch Class Contrast":kt((i,{getPitchClass:e}={})=>{const t=Y(i.pitch);if(t==null)return"#999";const s=t%12;return["#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f"][s]||"#999"})};function ul(i){return i<0&&(console.error(`Invalid trackId: ${i}. Using default color.`),i=0),We[i%We.length]}class hl{constructor(e,t,s,n,r){this.scroll=e,this.config=t,this.noteManager=s,this.interactionStore=n,this.sequencerId=r}draw(e){const{layout:{baseCellWidth:t,verticalCellRatio:s,labelWidth:n,headerHeight:r},behavior:{zoom:a}}=this.config,{noteColorScheme:o}=V().theme,l=dl[o]||(()=>"#999"),d={getPitchClass:Bo,getTrackColor:()=>ul(this.sequencerId)},c=t*a,u=c/s,f=this.scroll.getX(),h=this.scroll.getY(),m=e.canvas,b=this.noteManager.getTrackedNotes(this.interactionStore);e.save(),e.translate(n-f,r-h);const p=nl(f,h,this.config,m)(b);for(const{note:_,state:S}of p){const C=$i(_.pitch,this.config.layout.lowestMidi,this.config.layout.highestMidi)*u,N=_.start*c,w=_.duration*c,L=u,k=l(_,d);e.fillStyle=k,je(e,N,C,w,L,4),e.fill(),(S.selected||S.hovered||S.highlighted)&&(e.lineWidth=2,e.strokeStyle=S.selected?"#ffffff":S.hovered?"#ff9933":"#33ff99",je(e,N,C,w,L,4),e.stroke())}e.restore()}}class fl{constructor(e,t,s,n){this.scroll=e,this.config=t,this.store=s,this.getNoteDuration=n}draw(e){const{layout:{baseCellWidth:t,verticalCellRatio:s,labelWidth:n,headerHeight:r,lowestMidi:a,highestMidi:o},behavior:{zoom:l}}=this.config,d=t*l,c=d/s;e.save(),e.translate(n-this.scroll.getX(),r-this.scroll.getY()),e.fillStyle="rgba(100, 180, 255, 0.5)";const u=this.store.getPreviewNotes();if(u.length>0){const p=o-a+1;for(const _ of u){const S=ye(_.pitch);if(S===null)continue;const v=p-1-(S-a),C=_.start*d,N=v*c,w=_.duration*d;je(e,C,N,w,c,3),e.fill()}e.restore();return}const f=this.store.getSnappedCursorGridPosition();if(!f){e.restore();return}const h=this.getNoteDuration(),m=f.x*d,b=f.y*c,g=d*h;je(e,m,b,g,c,3),e.fill(),e.restore()}}let dt=!0,Ji=[],Wi=null,$r=!1;const ki=new Set;function pl(i){return ki.add(i),i(dt),()=>ki.delete(i)}function ml(){return $r}function At(i){$r=i}function ji(){return Wi}function Xe(i){Wi=i}function Xi(i){if(i.length===0){console.warn("Tried to set autocomplete target from empty note array",new Error().stack),zr();return}const e=i.reduce((t,s)=>{const n=s.start+s.duration;return n>t?n:t},-1/0);e!==-1/0&&Xe(e)}function zr(){Wi=null}function _s(){return dt=!dt,ki.forEach(i=>i(dt)),dt}function yl(i){Ji=i}function Ve(){return Ji}function Ct(){Ji=[]}function Hr(i,e,t,s,n,r="up",a="rgb(252, 159, 207)"){i.fillStyle=a,i.beginPath(),r==="up"?(i.moveTo(e,t-n),i.lineTo(e-s/2,t),i.lineTo(e+s/2,t)):(i.moveTo(e,t+n),i.lineTo(e-s/2,t),i.lineTo(e+s/2,t)),i.closePath(),i.fill()}class gl{constructor(e,t){this.scroll=e,this.config=t}draw(e){const{layout:{baseCellWidth:t,verticalCellRatio:s,labelWidth:n,headerHeight:r,lowestMidi:a,highestMidi:o},behavior:{zoom:l}}=this.config,d=t*l,c=d/s;e.save(),e.translate(n-this.scroll.getX(),r-this.scroll.getY());const u=Ve();if(u.length>0){const f=o-a+1;e.fillStyle="rgba(252, 159, 207, 0.4)";for(const h of u){const m=ye(h.pitch);if(m===null)continue;const b=f-1-(m-a),g=h.start*d,p=b*c,_=h.duration*d;je(e,g,p,_,c,3),e.fill()}}if(e.restore(),_t()){const f=ji();if(f!==null){const{layout:{baseCellWidth:h,labelWidth:m,headerHeight:b},behavior:{zoom:g}}=this.config,p=h*g,_=m-this.scroll.getX()+f*p,S=p*.5;Hr(e,_,b,S,8,"up")}}}}class bl{constructor(e,t){this.scroll=e,this.config=t,this.animations=[]}playNote(e){const t=performance.now(),s=ve();let n=e.duration*6e4/s;n=Math.max(100,Math.min(n,1600));const a=(Y(e.pitch)||0)*5%360;this.animations.push({note:e,startTime:t,duration:n,hue:a})}draw(e){const{layout:{baseCellWidth:t,verticalCellRatio:s,labelWidth:n,headerHeight:r,lowestMidi:a,highestMidi:o},behavior:{zoom:l}}=this.config,d=this.scroll.getX(),c=this.scroll.getY(),u=t*l,f=u/s,h=performance.now();e.clearRect(0,0,e.canvas.width,e.canvas.height),this.animations=this.animations.filter(m=>{const b=(h-m.startTime)/m.duration;if(b>1)return!1;const{note:g,hue:p}=m,_=Y(g.pitch);if(_==null||_<a||_>o)return!0;const S=o-_,v=g.start*u+n-d,C=S*f+r-c,N=g.duration*u,w=f-1,L=v+N/2,k=C+w/2,B=Math.sin(b*Math.PI),M=`hsla(${p}, 100%, 70%, ${.4*B})`;e.save(),e.globalAlpha=1,e.fillStyle=M,e.beginPath(),e.roundRect(v,C,N,w,4),e.fill();const x=2,G=50;for(let P=0;P<x;P++){const R=P*G,$=Math.max(0,Math.min(1,(h-m.startTime-R)/(m.duration-R))),oe=Math.sin($*Math.PI),Ae=1+(.1+P*.1)*oe,ti=(1-$)*.3;e.globalAlpha=ti,e.strokeStyle=`hsl(${p}, 100%, 65%)`,e.lineWidth=1.5;const xt=N*Ae,ds=w*Ae;e.beginPath(),e.roundRect(L-xt/2,k-ds/2,xt,ds,4),e.stroke()}return e.restore(),!0}),this.animations.length>0&&requestAnimationFrame(()=>this.draw(e))}}class _l{constructor(e,t,s){this.scroll=e,this.config=t,this.ctx=s,this.isAnimating=!1,this.acceptanceAnimations=[],this.activeBarIndex=null,this.renderFrame=n=>{if(!this.isAnimating)return;this.draw(n);const r=this.acceptanceAnimations.length>0,a=Ve().length>0,o=this.activeBarIndex!==null;r||a||o?requestAnimationFrame(this.renderFrame):this.isAnimating=!1}}start(){this.isAnimating||(this.isAnimating=!0,requestAnimationFrame(this.renderFrame))}stop(){this.isAnimating=!1}setActiveAutocompleteBar(e){this.activeBarIndex=e}invalidate(){this.isAnimating||(this.isAnimating=!0,requestAnimationFrame(this.renderFrame))}playNoteAcceptance(e){const t=performance.now();for(const s of e){const r=(Y(s.pitch)||0)*5%360;this.acceptanceAnimations.push({note:s,startTime:t,duration:800,hue:r})}this.isAnimating||(this.isAnimating=!0,requestAnimationFrame(this.renderFrame))}draw(e){const{layout:{baseCellWidth:t,verticalCellRatio:s,labelWidth:n,headerHeight:r,lowestMidi:a,highestMidi:o},behavior:{zoom:l}}=this.config,d=this.scroll.getX(),c=this.scroll.getY(),u=t*l,f=u/s,h=this.ctx;h.clearRect(0,0,h.canvas.width,h.canvas.height);const m=o-a+1;if(this.activeBarIndex!==null){const p=.5+.5*Math.sin(e*.005),{layout:{baseCellWidth:_,verticalCellRatio:S,labelWidth:v,headerHeight:C,lowestMidi:N,highestMidi:w},behavior:{zoom:L}}=this.config,k=this.scroll.getX(),B=this.scroll.getY(),M=_*L,x=M/S,G=this.activeBarIndex*M*(Oe()??4)+v-k,P=G+(Oe()??4)*M,R=C-B,$=(w-N+1)*x;this.ctx.save(),this.ctx.globalAlpha=.2*p,this.ctx.fillStyle="rgba(244, 114, 181, 0.36)",this.ctx.fillRect(G,R,P-G,$),this.ctx.restore()}const b=Ve();if(b.length>0){const p=.5+.5*Math.sin(e*.005);h.save(),h.translate(n-d,r-c);for(const _ of b){const S=ye(_.pitch);if(S===null)continue;const v=m-1-(S-a),C=_.start*u,N=v*f,w=_.duration*u;h.fillStyle=`rgba(255, 100, 180, ${.2*p})`,h.beginPath(),h.roundRect(C,N,w,f,3),h.fill(),h.lineWidth=1.5,h.strokeStyle=`rgba(255, 100, 180, ${.3*p})`,h.beginPath(),h.roundRect(C,N,w,f,3),h.stroke()}h.restore()}const g=performance.now();this.acceptanceAnimations=this.acceptanceAnimations.filter(p=>{const _=(g-p.startTime)/p.duration;if(_>1)return!1;const{note:S,hue:v}=p,C=ye(S.pitch);if(C===null||C<a||C>o)return!0;const N=m-1-(C-a),w=S.start*u+n-d,L=N*f+r-c,k=S.duration*u,B=f-1,M=w+k/2,x=L+B/2,P=1+.5*Math.sin(_*Math.PI),R=(1-_)*.5;h.save(),h.globalAlpha=R,h.strokeStyle=`hsl(${v}, 100%, 65%)`,h.lineWidth=2.5;const $=k*P,oe=B*P;return h.beginPath(),h.roundRect(M-$/2,x-oe/2,$,oe,4),h.stroke(),h.restore(),!0})}}class vl{constructor(e,t){this.scroll=e,this.config=t,this.x=null}setPlayheadX(e){this.x=e}clear(){this.x=null}draw(e){if(this.x==null)return;const{layout:{verticalCellRatio:t,baseCellWidth:s,labelWidth:n,headerHeight:r,highestMidi:a,lowestMidi:o},behavior:{zoom:l}}=this.config,d=a-o+1,c=this.scroll.getX(),u=this.scroll.getY(),f=s*l/t,h=d*f+r,m=this.x;e.save(),e.translate(n-c,-u),e.lineWidth=2,e.strokeStyle="rgba(168, 85, 247, 1.0)",e.shadowColor="rgba(168, 85, 247, 0.5)",e.shadowBlur=6,e.beginPath(),e.moveTo(m,0),e.lineTo(m,h),e.stroke(),e.restore()}}class Ue{constructor(e,t=!0){this.canvas=e,this.dpr=t&&window.devicePixelRatio||1;const s=this.canvas.getContext("2d");if(!s)throw new Error("Failed to get 2D context");this.ctx=s}resize(){const e=this.canvas.offsetWidth,t=this.canvas.offsetHeight,s=Math.floor(e*this.dpr),n=Math.floor(t*this.dpr);(this.canvas.width!==s||this.canvas.height!==n)&&(this.canvas.width=s,this.canvas.height=n,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr))}getContext(){return this.ctx}withContext(e){e(this.ctx)}clear(){this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight)}destroy(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.width=0,this.canvas.height=0,this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas)}}class vs{constructor(e,t,s,n,r){this.thumb=e,this.isHorizontal=t,this.scroll=s,this.interactionStore=n,this.requestRedraw=r,this.onMouseEnter=()=>this.interactionStore.setIsOnScrollbar(!0),this.onMouseLeave=()=>this.interactionStore.setIsOnScrollbar(!1),this.onThumbMouseDown=o=>this.handleMouseDown(o),this.onMouseMove=null,this.onMouseUp=null;const a=this.thumb.parentElement;if(!a)throw new Error("Scrollbar thumb must have a parent track element.");this.track=a,this.attachDragHandler()}attachDragHandler(){this.track.addEventListener("mouseenter",this.onMouseEnter),this.track.addEventListener("mouseleave",this.onMouseLeave),this.thumb.addEventListener("mouseenter",this.onMouseEnter),this.thumb.addEventListener("mouseleave",this.onMouseLeave),this.thumb.addEventListener("mousedown",this.onThumbMouseDown)}handleMouseDown(e){e.preventDefault(),this.interactionStore.setIsScrolling(!0),this.onMouseMove=t=>{const s=this.track.getBoundingClientRect(),n=this.isHorizontal?this.track.offsetWidth:this.track.offsetHeight,a=(this.isHorizontal?t.clientX:t.clientY)-(this.isHorizontal?s.left:s.top),o=this.isHorizontal?this.thumb.offsetWidth:this.thumb.offsetHeight,l=n-o,d=Math.max(0,Math.min(a-o/2,l)),c=l>0?d/l:0,u=this.isHorizontal?this.scroll.getMaxScrollX():this.scroll.getMaxScrollY(),f=c*u;this.isHorizontal?this.scroll.setScroll(f,this.scroll.getY()):this.scroll.setScroll(this.scroll.getX(),f),this.requestRedraw()},this.onMouseUp=()=>{document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),this.interactionStore.setIsScrolling(!1),this.onMouseMove=null,this.onMouseUp=null},document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}destroy(){this.track.removeEventListener("mouseenter",this.onMouseEnter),this.track.removeEventListener("mouseleave",this.onMouseLeave),this.thumb.removeEventListener("mouseenter",this.onMouseEnter),this.thumb.removeEventListener("mouseleave",this.onMouseLeave),this.thumb.removeEventListener("mousedown",this.onThumbMouseDown),this.onMouseMove&&document.removeEventListener("mousemove",this.onMouseMove),this.onMouseUp&&document.removeEventListener("mouseup",this.onMouseUp),this.onMouseMove=null,this.onMouseUp=null}}let Ss=!1;function Sl(){if(Ss)return;const i=document.createElement("style");i.textContent=`
    .grid-scrollbars {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    }

    .grid-scrollbar {
      position: absolute;
      background: #1f1f1f;
      pointer-events: all;
    }

    .grid-scrollbar-thumb {
      position: absolute;
      background: #888;
      border-radius: 6px;
      cursor: pointer;
    }

    .grid-scrollbar-corner {
      position: absolute;
      width: 12px;
      height: 12px;
      bottom: 0;
      right: 0;
      background: #1f1f1f;
      z-index: 2;
      pointer-events: none;
    }
  `,document.head.appendChild(i),Ss=!0}class Cl{constructor(e,t,s,n,r){this.container=e,this.scroll=t,this.config=s,this.interactionStore=n,this.requestRedraw=r,this.trackThickness=16,Sl(),this.createDOM(),this.attachEvents(),this.config=this.config,this.interactionStore=n}createDOM(){const e=this.hScrollbar=document.createElement("div"),t=this.hThumb=document.createElement("div"),s=this.vScrollbar=document.createElement("div"),n=this.vThumb=document.createElement("div"),r=this.corner=document.createElement("div");e.className="grid-scrollbar",s.className="grid-scrollbar",t.className="grid-scrollbar-thumb",n.className="grid-scrollbar-thumb",r.className="grid-scrollbar-corner",e.style.position=s.style.position=r.style.position="absolute",e.style.zIndex=s.style.zIndex=r.style.zIndex="5",e.style.bottom="0",e.style.left="0",e.style.right=`${this.trackThickness}px`,e.style.height=`${this.trackThickness}px`,s.style.top="0",s.style.right="0",s.style.bottom=`${this.trackThickness}px`,s.style.width=`${this.trackThickness}px`,r.style.width=`${this.trackThickness}px`,r.style.height=`${this.trackThickness}px`,r.style.right="0",r.style.bottom="0",r.style.background="#333",r.style.position="absolute",t.style.zIndex=n.style.zIndex="6",t.style.position=n.style.position="absolute",t.style.background="#7e22ce",n.style.background="#7e22ce",t.style.borderRadius=n.style.borderRadius="8px",t.style.height="100%",n.style.width="100%",e.appendChild(t),s.appendChild(n),this.container.appendChild(e),this.container.appendChild(s),this.container.appendChild(r)}attachEvents(){this.hDragHandler=new vs(this.hThumb,!0,this.scroll,this.interactionStore,this.requestRedraw),this.vDragHandler=new vs(this.vThumb,!1,this.scroll,this.interactionStore,this.requestRedraw)}update(){const{width:e,height:t}=this.container.getBoundingClientRect(),s=this.scroll.getContentWidth(),n=this.scroll.getContentHeight(),r=this.scroll.getX(),a=this.scroll.getY(),o=this.scroll.getMaxScrollX(),l=this.scroll.getMaxScrollY(),d=e-this.trackThickness,c=this.config.layout.labelWidth,u=Math.max(40,(e-c)/s*d),f=r/o*(d-u);this.hThumb.style.width=`${u}px`,this.hThumb.style.left=`${Math.max(0,f)}px`;const h=t-this.trackThickness,m=this.config.layout.headerHeight,b=Math.max(40,(t-m)/n*h),g=a/l*(h-b);this.vThumb.style.height=`${b}px`,this.vThumb.style.top=`${Math.max(0,g)}px`}destroy(){this.hDragHandler.destroy(),this.vDragHandler.destroy(),this.hScrollbar.remove(),this.vScrollbar.remove(),this.corner.remove(),this.hScrollbar=null,this.vScrollbar=null,this.corner=null}}var A=(i=>(i[i.NoteTool=0]="NoteTool",i[i.Selecting=1]="Selecting",i[i.SelectedIdle=2]="SelectedIdle",i[i.Dragging=3]="Dragging",i[i.Pasting=4]="Pasting",i[i.Sizing=5]="Sizing",i))(A||{});function xe(i,e,t,s,n){const r=it(i,e),a=t.getSnapResolution(),o=t.isTripletMode();return St(r,s,n,a,o)}function ke(i,e,t,s){const{baseCellWidth:n}=s.layout,{zoom:r}=s.behavior,a=Kr(i,e,t,s),o=n*r;return a.x/o}var F=(i=>(i.Default="default",i.Pointer="pointer",i.Crosshair="crosshair",i.Grabbing="grabbing",i.Grab="grab",i.ResizeHorizontal="ew-resize",i.ResizeVertical="ns-resize",i.Move="move",i.NotAllowed="not-allowed",i.Custom="url(cursor.png), auto",i))(F||{});function He(i,e,t,s){return!i||i.x>=ae()?(e.setSnappedCursorGridPosition(null),e.setHoveredNoteKey(null),t.set(F.Default),s(),!0):!1}function Jr(i){if(i.length===0)return;const e=Math.max(...i.map(t=>t.start+t.duration));Xe(e)}function Nl(i,e){const t=structuredClone(i),s=t.sequencers.find(n=>n.id===e.sequencerId);return s?(s.notes.push(...e.notes),Jr(e.notes),t):i}function jt(i,e){return{type:"PLACE_NOTES",sequencerId:i,notes:structuredClone(e)}}function Xt(i,e){return{type:"DELETE_NOTES",sequencerId:i,notes:structuredClone(e)}}function Wr(i,e){if(i.length===0)return;const t=Math.min(...i.map(n=>n.start)),s=e.filter(n=>n.start+n.duration<=t);if(s.length>0){const n=s.reduce((a,o)=>{const l=a.start+a.duration;return o.start+o.duration>l?o:a}),r=n.start+n.duration;Xe(r)}else Xe(0)}function wl(i,e){const t=structuredClone(i),s=t.sequencers.find(r=>r.id===e.sequencerId);if(!s)return i;const n=new Set(e.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));return s.notes=s.notes.filter(r=>{const a=`${r.pitch}|${r.start}|${r.duration}`;return!n.has(a)}),Wr(e.notes,s.notes),t}function ge(i,e){return{type:"DELETE_NOTES",sequencerId:i,notes:structuredClone(e)}}function be(i,e){return{type:"PLACE_NOTES",sequencerId:i,notes:structuredClone(e)}}class Ml{constructor(e,t,s,n,r,a,o,l,d,c,u,f){this.canvas=e,this.noteManager=t,this.scroll=s,this.config=n,this.store=r,this.grid=a,this.requestRedraw=o,this.getSequencerId=l,this.controller=d,this.cursorController=c,this.getClipboard=u,this.playNoteAnimation=f,this.initialMouseX=0,this.initialMouseY=0,this.dragThreshold=3}onMouseDown(e){if(e.button!==0||this.store.isOnNonGridElement())return;const t=xe(e,this.canvas,this.grid,this.scroll,this.config);if(He(t,this.store,this.cursorController,this.requestRedraw))return;const s=ke(e,this.canvas,this.scroll,this.config);if(t){const n=ne(t.y,this.config.layout.lowestMidi,this.config.layout.highestMidi),r=this.noteManager.findNoteEdgeAtCursor(n,s),a=this.store.getHoveredNoteKey();if(r&&a===`${r.pitch}:${r.start}`){this.store.setSelectedNotes([r]),this.controller.transitionTo(A.Sizing);return}}this.store.beginSelectionDrag(),this.initialMouseX=e.clientX,this.initialMouseY=e.clientY}onMouseMove(e){if(this.store.isOnNonGridElement()){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw();return}const t=e.clientX-this.initialMouseX,s=e.clientY-this.initialMouseY,n=Math.sqrt(t*t+s*s);if(this.store.isDraggingToSelect()){const c=this.store.getHoveredNoteKey();if(c&&n>=this.dragThreshold){const[u,f]=c.split(":"),h=this.noteManager.findAtPosition(u,Number(f));if(h){this.store.setSelectedNotes([h]),this.store.endSelectionDrag(),this.controller.transitionTo(A.Dragging);return}}if(n>=this.dragThreshold){this.store.endSelectionDrag(),this.controller.transitionTo(A.Selecting);return}}const r=xe(e,this.canvas,this.grid,this.scroll,this.config);if(!r||He(r,this.store,this.cursorController,this.requestRedraw))return;this.store.setSnappedCursorGridPosition(r);const a=ne(r.y,this.config.layout.lowestMidi,this.config.layout.highestMidi),o=ke(e,this.canvas,this.scroll,this.config),l=this.noteManager.findNoteUnderCursor(a,o),d=this.noteManager.findNoteEdgeAtCursor(a,o);if(l){const c=`${l.pitch}:${l.start}`;this.store.setHoveredNoteKey(c),this.store.setSnappedCursorGridPosition(null),d===l?this.cursorController.set(F.ResizeHorizontal):this.cursorController.set(F.Pointer)}else this.store.setHoveredNoteKey(null),this.store.setSnappedCursorGridPosition(r),this.cursorController.set(F.Default);this.requestRedraw()}onMouseUp(e){if(e.button!==0)return;if(this.store.isOnNonGridElement()){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw();return}this.store.isDraggingToSelect()&&this.store.endSelectionDrag();const t=this.store.getHoveredNoteKey();if(t){if(performance.now()-this.store.getLastDeletionTime()<100)return;const[d,c]=t.split(":"),u=this.noteManager.findAtPosition(d,Number(c));if(u){this.noteManager.previewNote(u.pitch,.25),this.store.setSelectedNotes([u]),this.controller.transitionTo(A.SelectedIdle);return}}const s=this.store.getSnappedCursorGridPosition();if(!s)return;const{layout:n}=this.config,r=this.grid.getNoteDuration(),a=ne(s.y,n.lowestMidi,n.highestMidi);if(!a||this.noteManager.findAtPosition(a,s.x))return;const l={start:s.x,duration:r,pitch:a,velocity:100};O(jt(this.getSequencerId(),[l]),Xt(this.getSequencerId(),[l])),this.noteManager.previewNote(a,r),this.playNoteAnimation({start:s.x,duration:r,pitch:a,velocity:100})}onContextMenu(e){if(e.preventDefault(),this.store.isOnNonGridElement())return;const t=this.store.getHoveredNoteKey();if(!t)return;const[s,n]=t.split(":"),r=parseFloat(n);if(!s||isNaN(r))return;const a=this.noteManager.findAtPosition(s,r);a&&(O(ge(this.getSequencerId(),[a]),be(this.getSequencerId(),[a])),this.store.setLastDeletionTime())}onMouseLeave(){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default),this.requestRedraw()}onKeyDown(e){if(q(e,"PasteNotes")){if(!this.getClipboard().notes.length)return;this.store.clearSelection(),this.controller.transitionTo(A.Pasting),e.preventDefault()}}onEnter(){E("DefaultNoteToolHandler entered")}onExit(){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw()}}function Cs(i,e,t,s,n){const{layout:{baseCellWidth:r,verticalCellRatio:a,lowestMidi:o,highestMidi:l},behavior:{zoom:d}}=s,c=r*d,u=c/a,f=Math.min(e.startX,e.currentX+c/2),h=Math.max(e.startX,e.currentX+c/2),m=Math.min(e.startY,e.currentY),b=Math.max(e.startY,e.currentY),g=n.getSnapResolution(),p=Math.floor(f/c/g)*g,_=Math.floor(h/c/g)*g,S=Math.floor(m/u),v=Math.floor(b/u),C=Math.min(S,v),N=Math.max(S,v);return i.filter(w=>{const L=$i(w.pitch,o,l);if(L==null)return!1;const k=L>=C&&L<=N,B=w.start+w.duration,M=w.start>=p&&B<=_;return k&&M})}class xl{constructor(e,t,s,n,r,a,o,l){this.canvas=e,this.config=t,this.scroll=s,this.grid=n,this.store=r,this.controller=a,this.noteManager=o,this.requestRedraw=l}onEnter(){const e=sl(this.controller.getLastMouseX(),this.controller.getLastMouseY(),this.canvas,this.scroll,this.config);this.store.setMarqueeBox({startX:e.x,startY:e.y,currentX:e.x,currentY:e.y})}onMouseMove(e){const t=this.store.getMarqueeBox();if(!t)return;const s=Kr(e,this.canvas,this.scroll,this.config);t.currentX=s.x,t.currentY=s.y,this.store.setMarqueeBox({...t});const n=Cs(this.noteManager.getAll(),t,this.scroll,this.config,this.grid);this.store.setHighlightedNotes(n),this.requestRedraw()}onMouseUp(e){const t=this.store.getMarqueeBox();if(!t){this.controller.transitionTo(A.NoteTool);return}const s=Cs(this.noteManager.getAll(),t,this.scroll,this.config,this.grid),r=navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey;if(s.length>0){const a=this.store.getSelectedNotes(),o=r?this.noteManager.mergeSelections(a,s):s;this.store.setSelectedNotes(o),this.store.clearHighlightedNotes(),this.store.setMarqueeBox(null),this.controller.transitionTo(A.SelectedIdle)}else this.store.clearSelection(),this.controller.transitionTo(A.NoteTool)}onMouseLeave(){this.store.clearHighlightedNotes(),this.store.setMarqueeBox(null),this.controller.transitionTo(A.NoteTool)}onExit(){this.store.clearHighlightedNotes(),this.store.setMarqueeBox(null),this.requestRedraw()}}class Ll{constructor(e,t,s,n,r,a,o,l,d,c,u,f){this.canvas=e,this.config=t,this.scroll=s,this.noteManager=n,this.store=r,this.grid=a,this.requestRedraw=o,this.getSequencerId=l,this.controller=d,this.cursorController=c,this.setClipboard=u,this.getClipboard=f,this.initialMouseX=0,this.initialMouseY=0,this.dragThreshold=3}onEnter(){}onExit(){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw()}onMouseDown(e){if(e.button!==0||this.store.isOnNonGridElement())return;const t=xe(e,this.canvas,this.grid,this.scroll,this.config);if(!t)return;const s=ke(e,this.canvas,this.scroll,this.config),n=ne(t.y,this.config.layout.lowestMidi,this.config.layout.highestMidi),r=this.noteManager.findNoteEdgeAtCursor(n,s);if(r){const a=`${r.pitch}:${r.start}`;new Set(this.store.getSelectedNotes().map(l=>`${l.pitch}:${l.start}`)).has(a)||this.store.setSelectedNotes([r]),this.controller.transitionTo(A.Sizing);return}this.store.beginSelectionDrag(),this.initialMouseX=e.clientX,this.initialMouseY=e.clientY}onMouseMove(e){if(this.store.isOnNonGridElement()){this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default),this.requestRedraw();return}const t=e.clientX-this.initialMouseX,s=e.clientY-this.initialMouseY,n=Math.sqrt(t*t+s*s);if(this.store.isDraggingToSelect()){const h=this.store.getHoveredNoteKey();if(h&&n>=this.dragThreshold){const[m,b]=h.split(":"),g=parseFloat(b),p=this.noteManager.findAtPosition(m,g);if(!p)return;this.store.getSelectedNotes().some(v=>v.pitch===p.pitch&&v.start===p.start)||this.store.setSelectedNotes([p]),this.store.setDragAnchorNoteKey(`${p.pitch}:${p.start}`),this.store.endSelectionDrag(),this.controller.transitionTo(A.Dragging);return}if(!h&&n>=this.dragThreshold){!e.ctrlKey&&!e.metaKey&&this.store.clearSelection(),this.store.endSelectionDrag(),this.controller.transitionTo(A.Selecting);return}}const r=it(e,this.canvas),a=this.grid.getSnapResolution(),o=this.grid.isTripletMode(),l=St(r,this.scroll,this.config,a,o);if(!l){this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default),this.requestRedraw();return}const d=ke(e,this.canvas,this.scroll,this.config),c=ne(l.y,this.config.layout.lowestMidi,this.config.layout.highestMidi),u=this.noteManager.findNoteUnderCursor(c,d),f=this.noteManager.findNoteEdgeAtCursor(c,d);if(u){const h=`${u.pitch}:${u.start}`;this.store.setHoveredNoteKey(h),f&&f===u?this.cursorController.set(F.ResizeHorizontal):this.cursorController.set(F.Pointer)}else this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default);this.requestRedraw()}onMouseUp(e){if(e.button!==0||this.store.isOnNonGridElement())return;e.stopPropagation(),this.store.endSelectionDrag();const t=this.noteManager.findNoteAtMousePosition(e,this.canvas,this.scroll,this.config,this.noteManager);if(t){const s=`${t.pitch}:${t.start}`,n=this.store.getSelectedNotes(),r=n.some(l=>`${l.pitch}:${l.start}`===s);if(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey){if(r){const l=n.filter(d=>`${d.pitch}:${d.start}`!==s);this.store.setSelectedNotes(l)}else this.noteManager.previewNote(t.pitch,.25),this.store.setSelectedNotes([...n,t]);this.controller.transitionTo(A.SelectedIdle);return}this.store.setSelectedNotes([t]),this.noteManager.previewNote(t.pitch,.25),this.controller.transitionTo(A.SelectedIdle);return}this.store.clearSelection(),this.controller.transitionTo(A.NoteTool)}onContextMenu(e){if(e.preventDefault(),this.store.isOnNonGridElement())return;const t=this.store.getHoveredNoteKey();if(!t)return;const[s,n]=t.split(":"),r=parseFloat(n),a=this.noteManager.findNoteUnderCursor(s,r);if(!a)return;const o=this.store.getSelectedNotes(),l=o.some(d=>d.pitch===a.pitch&&d.start===a.start);o.length>0&&l?O(ge(this.getSequencerId(),o),be(this.getSequencerId(),o)):O(ge(this.getSequencerId(),[a]),be(this.getSequencerId(),[a])),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool)}onKeyDown(e){const t=this.store.getSelectedNotes();if(q(e,"CopyNotes")){t.length&&this.setClipboard(t),e.preventDefault();return}if(q(e,"CutNotes")){if(!t.length)return;this.setClipboard(t),O(ge(this.getSequencerId(),t),be(this.getSequencerId(),t)),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool),e.preventDefault();return}if(q(e,"PasteNotes")){if(!this.getClipboard().notes.length)return;this.store.clearSelection(),this.controller.transitionTo(A.Pasting),e.preventDefault();return}if(q(e,"DeleteNotes")){if(!t.length)return;O(ge(this.getSequencerId(),t),be(this.getSequencerId(),t)),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool),e.preventDefault()}}}function kl({notes:i,anchorBeat:e,anchorMidi:t,targetBeat:s,targetMidi:n,lowestMidi:r,highestMidi:a}){const o=s-e,l=i.map(g=>g.start+o),d=i.map(g=>g.start+o+g.duration),c=Math.min(...l),u=Math.max(...d),f=Math.min(0,c),h=Math.max(0,u-ae()),m=o-f-h;if(!zt()||mt()){const g=n-t;return i.flatMap(p=>{const _=ye(p.pitch);if(_==null)return[];let S=_+g;S<r&&(S=r),S>a&&(S=a);const v=Pe(S);return v?[{pitch:v,start:p.start+m,duration:p.duration,velocity:p.velocity??100}]:[]})}else{const g=Ht(),p=[];for(let C=a;C>=r;C--)g.get(C)&&p.push(C);const _=p.indexOf(t),S=p.indexOf(n);if(_===-1||S===-1)return[];const v=S-_;return i.flatMap(C=>{const N=ye(C.pitch);if(N==null)return[];const w=p.indexOf(N);if(w===-1)return[];const L=w+v;if(L<0||L>=p.length)return[];const k=p[L],B=Pe(k);return B?[{pitch:B,start:C.start+m,duration:C.duration,velocity:C.velocity??100}]:[]})}}class Al{constructor(e,t,s,n,r,a,o,l,d,c){this.canvas=e,this.config=t,this.scroll=s,this.store=n,this.grid=r,this.requestRedraw=a,this.getSequencerId=o,this.controller=l,this.cursorController=d,this.getClipboard=c}onMouseMove(e){const t=xe(e,this.canvas,this.grid,this.scroll,this.config);if(!t||He(t,this.store,this.cursorController,this.requestRedraw))return;const s=this.getClipboard();if(!s.notes.length)return;const{lowestMidi:n,highestMidi:r}=this.config.layout,a=r-n+1,o=n+(a-1-t.y),l=t.x,d=kl({notes:s.notes,anchorBeat:s.anchorBeat,anchorMidi:s.anchorMidi,targetBeat:l,targetMidi:o,lowestMidi:n,highestMidi:r});this.store.setPreviewNotes(d),this.cursorController.set(F.Pointer),this.requestRedraw()}onMouseDown(e){if(e.button!==0||this.store.isOnNonGridElement())return;const t=this.store.getPreviewNotes();t.length&&(O(jt(this.getSequencerId(),t),Xt(this.getSequencerId(),t)),this.store.clearPreviewNotes(),this.controller.transitionTo(A.NoteTool))}onMouseLeave(){this.store.clearPreviewNotes(),this.controller.transitionTo(A.NoteTool)}onExit(){this.store.clearPreviewNotes(),this.requestRedraw()}}function Bl({originalNotes:i,anchorNote:e,targetPitch:t,targetBeat:s,lowestMidi:n,highestMidi:r}){const a=ye(t),o=ye(e.pitch);if(a==null||o==null)return[];const l=s-e.start,d=i.map(p=>p.start+l),c=i.map(p=>p.start+l+p.duration),u=Math.min(...d),f=Math.max(...c),h=Math.min(0,u),m=Math.max(0,f-ae()),b=l-h-m;if(!zt()||mt()){const p=a-o;return i.flatMap(_=>{const S=ye(_.pitch);if(S==null)return[];let v=S+p;v<n&&(v=n),v>r&&(v=r);const C=Pe(v);return C?[{pitch:C,start:_.start+b,duration:_.duration,velocity:_.velocity??100}]:[]})}else{const p=Ht(),_=[];for(let N=r;N>=n;N--)p.get(N)&&_.push(N);const S=_.indexOf(o),v=_.indexOf(a);if(S===-1||v===-1)return[];const C=v-S;return i.flatMap(N=>{const w=ye(N.pitch);if(w==null)return[];const L=_.indexOf(w);if(L===-1)return[];const k=L+C;if(k<0||k>=_.length)return[];const B=_[k],M=Pe(B);return M?[{pitch:M,start:N.start+b,duration:N.duration,velocity:N.velocity??100}]:[]})}}function Gl(i,e){const t=structuredClone(i),s=t.sequencers.find(a=>a.id===e.sequencerId);if(!s)return i;const n=e.from,r=e.to;for(let a=0;a<n.length;a++){const o=n[a],l=r[a],d=s.notes.findIndex(c=>c.pitch===o.pitch&&c.start===o.start&&c.duration===o.duration);d!==-1&&(s.notes[d].pitch=l.pitch,s.notes[d].start=l.start)}return Xi(r),t}function jr(i,e,t){return{type:"MOVE_NOTES",sequencerId:i,from:structuredClone(e),to:structuredClone(t)}}function El(i,e,t){return jr(i,t,e)}class Tl{constructor(e,t,s,n,r,a,o,l,d,c){this.canvas=e,this.config=t,this.scroll=s,this.store=n,this.noteManager=r,this.grid=a,this.requestRedraw=o,this.controller=l,this.cursorController=d,this.getSequencerId=c,this.originalNotes=[],this.anchorNote=null,this.hasMoved=!1,this.lastPreviewedPitch=null}onEnter(){const e=this.store.getSelectedNotes();if(!e.length){this.controller.transitionTo(A.NoteTool);return}this.originalNotes=e.map(n=>({...n}));const t=this.store.getDragAnchorNoteKey(),s=t?e.find(n=>`${n.pitch}:${n.start}`===t):e[0];this.anchorNote=s??e[0],this.noteManager.removeAll(e),this.store.setPreviewNotes(this.originalNotes),this.hasMoved=!1,this.requestRedraw()}onMouseMove(e){const t=it(e,this.canvas),s=this.grid.getSnapResolution(),n=this.grid.isTripletMode(),r=St(t,this.scroll,this.config,s,n);if(!r||!this.anchorNote)return;const{layout:a}=this.config,o=ne(r.y,a.lowestMidi,a.highestMidi);if(!o)return;const l=Bl({originalNotes:this.originalNotes,anchorNote:this.anchorNote,targetPitch:o,targetBeat:r.x,lowestMidi:a.lowestMidi,highestMidi:a.highestMidi});this.store.setPreviewNotes(l),this.hasMoved=!0,this.cursorController.set(F.Grabbing),o!==this.lastPreviewedPitch&&(this.noteManager.previewNote(o,.25),this.lastPreviewedPitch=o),this.requestRedraw()}onMouseUp(e){if(e.button!==0||!this.anchorNote)return;const t=this.store.getPreviewNotes();if(this.hasMoved&&t.some((n,r)=>n.start!==this.originalNotes[r].start||n.pitch!==this.originalNotes[r].pitch))O(jr(this.getSequencerId(),this.originalNotes,t),El(this.getSequencerId(),this.originalNotes,t));else for(const n of this.originalNotes)this.noteManager.add(n);this.store.clearPreviewNotes(),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool)}onMouseLeave(){this.hasMoved=!1,this.controller.transitionTo(A.NoteTool)}onExit(){if(!this.hasMoved&&this.originalNotes.length>0){for(const e of this.originalNotes)this.noteManager.add(e);this.noteManager.rebuildIndex()}this.originalNotes=[],this.anchorNote=null,this.store.clearPreviewNotes(),this.store.clearSelection(),this.store.setDragAnchorNoteKey(null),this.requestRedraw()}}function Il(i,e){const t=structuredClone(i),s=t.sequencers.find(a=>a.id===e.sequencerId);if(!s)return i;const n=e.resizes,r=[];for(const a of n){const o=s.notes.find(l=>l.pitch===a.pitch&&l.start===a.start);o&&(o.duration=a.newDuration,r.push(o))}return Xi(r),t}function Rl(i,e){return{type:"RESIZE_NOTES",sequencerId:i,resizes:structuredClone(e)}}function Pl(i,e){const t=e.map(s=>({pitch:s.pitch,start:s.start,newDuration:s.oldDuration}));return{type:"RESIZE_NOTES",sequencerId:i,resizes:t}}class Ol{constructor(e,t,s,n,r,a,o,l,d,c){this.canvas=e,this.config=t,this.scroll=s,this.store=n,this.noteManager=r,this.grid=a,this.requestRedraw=o,this.controller=l,this.cursorController=d,this.getSequencerId=c,this.originalNotes=[],this.previewNotes=[],this.anchorNote=null,this.hasResized=!1,this.hasMoved=!1,this.initialMouseX=0,this.accumulatedDelta=0}onEnter(){const e=this.store.getSelectedNotes();if(this.cursorController.set(F.ResizeHorizontal),!e.length){this.controller.transitionTo(A.NoteTool);return}this.originalNotes=e.map(s=>({...s}));const t=this.store.getHoveredNoteKey();this.anchorNote=t?e.find(s=>`${s.pitch}:${s.start}`===t)??null:e[0],this.noteManager.removeAll(e),this.store.setPreviewNotes(this.originalNotes),this.hasResized=!1,this.hasMoved=!1,this.accumulatedDelta=0,this.initialMouseX=this.controller.getLastMouseX(),this.requestRedraw()}onMouseMove(e){if(!this.anchorNote)return;const t=this.grid.getSnapResolution(),n=this.grid.isTripletMode()?t*(2/3):t,r=e.clientX-this.initialMouseX,o=this.config.layout.baseCellWidth*this.config.behavior.zoom*n,l=r/o,d=Math.round(l);if(d===this.accumulatedDelta)return;this.accumulatedDelta=d;const c=d*n,u=this.originalNotes.map(f=>{const h=Math.max(n,f.duration+c);return{...f,duration:h}});this.previewNotes=u,this.store.setPreviewNotes(u),this.hasResized=!0,this.requestRedraw()}onMouseUp(e){if(e.button!==0||!this.anchorNote||!this.hasResized)return;const t=this.originalNotes,n=this.previewNotes.map((a,o)=>({pitch:a.pitch,start:a.start,newDuration:a.duration})),r=t.map((a,o)=>({pitch:a.pitch,start:a.start,oldDuration:a.duration}));O(Rl(this.getSequencerId(),n),Pl(this.getSequencerId(),r)),this.store.clearPreviewNotes(),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool)}onMouseLeave(){this.controller.transitionTo(A.NoteTool)}onExit(){if(!this.hasResized&&this.originalNotes.length>0){for(const e of this.originalNotes)this.noteManager.add(e);this.noteManager.rebuildIndex()}this.cursorController.set(F.Default),this.originalNotes=[],this.previewNotes=[],this.anchorNote=null,this.store.clearPreviewNotes(),this.store.clearSelection(),this.requestRedraw()}}class Fl{constructor(e,t,s,n,r,a,o,l,d,c,u,f){this.canvas=e,this.noteManager=t,this.scroll=s,this.config=n,this.store=r,this.grid=a,this.requestRedraw=o,this.getSequencerId=l,this.controller=d,this.cursorController=c,this.getClipboard=u,this.playNoteAnimation=f,this.initialMouseX=0,this.initialMouseY=0,this.dragThreshold=1}onMouseDown(e){if(this.store.isOnNonGridElement())return;if(e.button!==0){this.store.beginSelectionDrag(),this.initialMouseX=e.clientX,this.initialMouseY=e.clientY;return}const t=this.store.getHoveredNoteKey();if(t){const[l,d]=t.split(":"),c=Number(d),u=this.noteManager.findAtPosition(l,c);if(u){const f=ke(e,this.canvas,this.scroll,this.config),h=this.noteManager.findNoteEdgeAtCursor(l,f);if(h&&u.pitch===h.pitch&&u.start===h.start){this.store.setSelectedNotes([h]),this.controller.transitionTo(A.Sizing);return}this.noteManager.previewNote(u.pitch,.25),this.store.setSelectedNotes([u]),this.store.suppressNextMouseUpEvent(),this.controller.transitionTo(A.SelectedIdle);return}}const s=xe(e,this.canvas,this.grid,this.scroll,this.config);if(He(s,this.store,this.cursorController,this.requestRedraw)||!s)return;const n=ne(s.y,this.config.layout.lowestMidi,this.config.layout.highestMidi);if(!n||this.noteManager.findAtPosition(n,s.x))return;this.store.beginSelectionDrag(),this.initialMouseX=e.clientX,this.initialMouseY=e.clientY;const a=this.grid.getNoteDuration(),o={start:s.x,duration:a,pitch:n,velocity:100};O(jt(this.getSequencerId(),[o]),Xt(this.getSequencerId(),[o])),this.noteManager.previewNote(n,a),this.playNoteAnimation(o)}onMouseMove(e){if(this.store.isOnNonGridElement()){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw();return}const t=e.clientX-this.initialMouseX,s=e.clientY-this.initialMouseY,n=Math.sqrt(t*t+s*s);if(e.buttons===1&&this.store.isDraggingToSelect()){const C=this.store.getHoveredNoteKey(),N=xe(e,this.canvas,this.grid,this.scroll,this.config);if(!N||He(N,this.store,this.cursorController,this.requestRedraw))return;const w=ne(N.y,this.config.layout.lowestMidi,this.config.layout.highestMidi);if(C&&n>=this.dragThreshold){const[L,k]=C.split(":");if(L===w){const B=this.noteManager.findAtPosition(L,Number(k));if(B){this.store.setSelectedNotes([B]),this.store.endSelectionDrag(),this.controller.transitionTo(A.Sizing);return}}}}if(e.buttons===2&&this.store.isDraggingToSelect()&&n>=this.dragThreshold){this.store.endSelectionDrag(),this.controller.transitionTo(A.Selecting);return}const r=xe(e,this.canvas,this.grid,this.scroll,this.config);if(!r||He(r,this.store,this.cursorController,this.requestRedraw))return;this.store.setSnappedCursorGridPosition(r);const a=it(e,this.canvas),{layout:{headerHeight:o,baseCellWidth:l,verticalCellRatio:d,highestMidi:c,lowestMidi:u},behavior:{zoom:f}}=this.config,h=l*f/d,m=c-u+1;let b=Math.floor((a.y+this.scroll.getY()-o)/h);b=Math.max(0,Math.min(b,m-1));const g=c-b,p=Pe(g),_=ke(e,this.canvas,this.scroll,this.config),S=this.noteManager.findNoteUnderCursor(p,_),v=this.noteManager.findNoteEdgeAtCursor(p,_);if(S){const C=`${S.pitch}:${S.start}`;this.store.setHoveredNoteKey(C),this.store.setSnappedCursorGridPosition(null),v===S?this.cursorController.set(F.ResizeHorizontal):this.cursorController.set(F.Pointer)}else this.store.setHoveredNoteKey(null),this.store.setSnappedCursorGridPosition(r),this.cursorController.set(F.Default);this.requestRedraw()}onMouseUp(e){this.store.endSelectionDrag()}onContextMenu(e){if(e.preventDefault(),this.store.isOnNonGridElement())return;const t=this.store.getHoveredNoteKey();if(!t)return;const[s,n]=t.split(":"),r=parseFloat(n);if(!s||isNaN(r))return;const a=this.noteManager.findAtPosition(s,r);a&&(O(ge(this.getSequencerId(),[a]),be(this.getSequencerId(),[a])),this.store.setLastDeletionTime())}onMouseLeave(){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default),this.requestRedraw()}onKeyDown(e){if(q(e,"PasteNotes")){if(!this.getClipboard().notes.length)return;this.store.clearSelection(),this.controller.transitionTo(A.Pasting),e.preventDefault()}}onEnter(){E("ExpressNoteToolHandler entered")}onExit(){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw()}}class Dl{constructor(e,t,s,n,r,a,o,l,d,c,u,f){this.canvas=e,this.config=t,this.scroll=s,this.noteManager=n,this.store=r,this.grid=a,this.requestRedraw=o,this.getSequencerId=l,this.controller=d,this.cursorController=c,this.setClipboard=u,this.getClipboard=f,this.initialMouseX=0,this.initialMouseY=0,this.dragThreshold=3}onEnter(){var e;if(window&&((e=window.event)==null?void 0:e.buttons)&1){this.store.beginSelectionDrag();const t=window.event;this.initialMouseX=t.clientX,this.initialMouseY=t.clientY}}onExit(){this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw()}onMouseDown(e){if(this.store.isOnNonGridElement())return;const t=e.button===0,s=e.button===2,n=xe(e,this.canvas,this.grid,this.scroll,this.config);if(!n){s&&this.beginSelectionDrag(e);return}const r=ne(n.y,this.config.layout.lowestMidi,this.config.layout.highestMidi);if(!r){s&&this.beginSelectionDrag(e);return}const a=ke(e,this.canvas,this.scroll,this.config),o=this.noteManager.findNoteUnderCursor(r,a);if(t){const l=this.noteManager.findNoteEdgeAtCursor(r,a);if(l){const d=`${l.pitch}:${l.start}`;new Set(this.store.getSelectedNotes().map(u=>`${u.pitch}:${u.start}`)).has(d)||this.store.setSelectedNotes([l]),this.controller.transitionTo(A.Sizing);return}o&&(this.beginSelectionDrag(e),this.initialMouseX=e.clientX,this.initialMouseY=e.clientY)}if(s)if(o){const l=`${o.pitch}:${o.start}`;this.store.setHoveredNoteKey(l)}else this.store.setHoveredNoteKey(null),this.beginSelectionDrag(e)}beginSelectionDrag(e){this.store.beginSelectionDrag(),this.initialMouseX=e.clientX,this.initialMouseY=e.clientY}onMouseMove(e){if(this.store.isOnNonGridElement()){this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default),this.requestRedraw();return}const t=e.clientX-this.initialMouseX,s=e.clientY-this.initialMouseY,n=Math.sqrt(t*t+s*s);if(this.store.isDraggingToSelect()&&e.buttons&1){const h=this.store.getHoveredNoteKey();if(h&&n>=this.dragThreshold){const[m,b]=h.split(":"),g=parseFloat(b),p=this.noteManager.findAtPosition(m,g);if(!p)return;this.store.getSelectedNotes().some(v=>v.pitch===p.pitch&&v.start===p.start)||this.store.setSelectedNotes([p]),this.store.setDragAnchorNoteKey(`${p.pitch}:${p.start}`),this.store.endSelectionDrag(),this.controller.transitionTo(A.Dragging);return}}else if(this.store.isDraggingToSelect()&&e.buttons&2&&!this.store.getHoveredNoteKey()&&n>=this.dragThreshold){!e.metaKey&&!e.shiftKey&&!e.ctrlKey&&this.store.clearSelection(),this.store.endSelectionDrag(),this.controller.transitionTo(A.Selecting);return}const r=it(e,this.canvas),a=this.grid.getSnapResolution(),o=this.grid.isTripletMode(),l=St(r,this.scroll,this.config,a,o);if(!l){this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default),this.requestRedraw();return}const d=ke(e,this.canvas,this.scroll,this.config),c=ne(l.y,this.config.layout.lowestMidi,this.config.layout.highestMidi),u=this.noteManager.findNoteUnderCursor(c,d),f=this.noteManager.findNoteEdgeAtCursor(c,d);if(u){const h=`${u.pitch}:${u.start}`;this.store.setHoveredNoteKey(h),f&&f===u?this.cursorController.set(F.ResizeHorizontal):this.cursorController.set(F.Pointer)}else this.store.setHoveredNoteKey(null),this.cursorController.set(F.Default);this.requestRedraw()}onMouseUp(e){if(e.button!==0||this.store.isOnNonGridElement()||(e.stopPropagation(),this.store.consumeSuppressMouseUpFlag()))return;this.store.endSelectionDrag();const t=this.noteManager.findNoteAtMousePosition(e,this.canvas,this.scroll,this.config,this.noteManager);if(t){const s=`${t.pitch}:${t.start}`,n=this.store.getSelectedNotes(),r=n.some(l=>`${l.pitch}:${l.start}`===s);if(navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey){if(r){const l=n.filter(d=>`${d.pitch}:${d.start}`!==s);this.store.setSelectedNotes(l)}else this.noteManager.previewNote(t.pitch,.25),this.store.setSelectedNotes([...n,t]);this.requestRedraw();return}this.store.setSelectedNotes([t]),this.noteManager.previewNote(t.pitch,.25),this.requestRedraw();return}this.store.clearSelection(),this.controller.transitionTo(A.NoteTool)}onContextMenu(e){if(e.preventDefault(),this.store.isOnNonGridElement())return;const t=this.store.getHoveredNoteKey();if(!t)return;const[s,n]=t.split(":"),r=parseFloat(n),a=this.noteManager.findNoteUnderCursor(s,r);if(!a)return;const o=this.store.getSelectedNotes(),l=o.some(d=>d.pitch===a.pitch&&d.start===a.start);o.length>0&&l?O(ge(this.getSequencerId(),o),be(this.getSequencerId(),o)):O(ge(this.getSequencerId(),[a]),be(this.getSequencerId(),[a])),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool)}onKeyDown(e){const t=this.store.getSelectedNotes();if(q(e,"CopyNotes")){t.length&&this.setClipboard(t),e.preventDefault();return}if(q(e,"CutNotes")){if(!t.length)return;this.setClipboard(t),O(ge(this.getSequencerId(),t),be(this.getSequencerId(),t)),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool),e.preventDefault();return}if(q(e,"PasteNotes")){if(!this.getClipboard().notes.length)return;this.store.clearSelection(),this.controller.transitionTo(A.Pasting),e.preventDefault();return}if(q(e,"DeleteNotes")){if(!t.length)return;O(ge(this.getSequencerId(),t),be(this.getSequencerId(),t)),this.store.clearSelection(),this.controller.transitionTo(A.NoteTool),e.preventDefault()}}}class Ul{constructor(e){this.data=e,this.mode=A.NoteTool,this.activeHandler=null,this.lastMouseX=0,this.lastMouseY=0,this.transitionTo(A.NoteTool)}handleMouseDown(e){var t,s;this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,(s=(t=this.activeHandler)==null?void 0:t.onMouseDown)==null||s.call(t,e)}handleMouseMove(e){var t,s;this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,(s=(t=this.activeHandler)==null?void 0:t.onMouseMove)==null||s.call(t,e)}handleMouseUp(e){var t,s;this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,(s=(t=this.activeHandler)==null?void 0:t.onMouseUp)==null||s.call(t,e)}handleContextMenu(e){var t,s;this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,(s=(t=this.activeHandler)==null?void 0:t.onContextMenu)==null||s.call(t,e)}handleMouseLeave(){var e,t;(t=(e=this.activeHandler)==null?void 0:e.onMouseLeave)==null||t.call(e)}handleMouseEnter(e){var t,s;(s=(t=this.activeHandler)==null?void 0:t.onMouseEnter)==null||s.call(t,e)}handleKeyDown(e){var t,s;(s=(t=this.activeHandler)==null?void 0:t.onKeyDown)==null||s.call(t,e)}transitionTo(e){var t,s,n,r;E(`Transitioning to mode: ${A[e]} from ${A[this.mode]}`),(s=(t=this.activeHandler)==null?void 0:t.onExit)==null||s.call(t),this.mode=e,this.activeHandler=this.createHandlerForMode(e),(r=(n=this.activeHandler)==null?void 0:n.onEnter)==null||r.call(n)}reset(){this.transitionTo(A.NoteTool)}createHandlerForMode(e){const t={transitionTo:s=>this.transitionTo(s),getLastMouseX:()=>this.lastMouseX,getLastMouseY:()=>this.lastMouseY};switch(e){case A.NoteTool:{const{global:{noteToolMode:s}}=V(),n=s==="express"?Fl:Ml,r=[this.data.canvas,this.data.noteManager,this.data.scroll,this.data.config,this.data.store,this.data.grid,this.data.requestRedraw,()=>this.data.sequencerContext.getId(),t,this.data.cursorController,this.data.getClipboard,this.data.playNoteAnimation];return new n(...r)}case A.Selecting:return new xl(this.data.canvas,this.data.config,this.data.scroll,this.data.grid,this.data.store,t,this.data.noteManager,this.data.requestRedraw);case A.SelectedIdle:{const{global:{noteToolMode:s}}=V(),n=s==="express"?Dl:Ll,r=[this.data.canvas,this.data.config,this.data.scroll,this.data.noteManager,this.data.store,this.data.grid,this.data.requestRedraw,()=>this.data.sequencerContext.getId(),t,this.data.cursorController,this.data.setClipboard,this.data.getClipboard];return new n(...r)}case A.Pasting:return new Al(this.data.canvas,this.data.config,this.data.scroll,this.data.store,this.data.grid,this.data.requestRedraw,()=>this.data.sequencerContext.getId(),t,this.data.cursorController,this.data.getClipboard);case A.Dragging:return new Tl(this.data.canvas,this.data.config,this.data.scroll,this.data.store,this.data.noteManager,this.data.grid,this.data.requestRedraw,t,this.data.cursorController,()=>this.data.sequencerContext.getId());case A.Sizing:return new Ol(this.data.canvas,this.data.config,this.data.scroll,this.data.store,this.data.noteManager,this.data.grid,this.data.requestRedraw,t,this.data.cursorController,()=>this.data.sequencerContext.getId());default:return{}}}destroy(){var e,t;(t=(e=this.activeHandler)==null?void 0:e.onExit)==null||t.call(e),this.activeHandler=null}}function Vi(i,e){var t;for(const s of i.sequencers){const n=s.matrix;if(!n)continue;const r=(t=n.getPixelsPerBeat)==null?void 0:t.call(n);if(!r)continue;const a=e*r;n.setPlayheadPixelX(a)}}function Xr(i,e){const t=e.snapResolution||.25,s=e.isTripletMode?t*(2/3):t;return Math.round(i/s)*s}function Bt(i,e,t){const s=e.getBoundingClientRect(),n=t.layout.headerHeight,r=i.clientY-s.top;return r>=0&&r<=n}let Ce=null,ht=null;function ql(i){ht=i,Ce=ht.getContext("2d")}function Nt(i){if(!Ce||!ht)return;const e=window.devicePixelRatio||1,t=ht.width/e,s=ht.height/e;Ce.clearRect(0,0,t,s);const n=Math.round(i)+.5;Ce.strokeStyle="#ff00ff",Ce.lineWidth=1,Ce.beginPath(),Ce.moveTo(n,0),Ce.lineTo(n,s),Ce.stroke()}function Vr(i,e){const t=i.getContext("2d");if(!t)return;const s=window.devicePixelRatio||1,n=i.width/s,r=i.height/s;t.clearRect(0,0,n,r);const a=ae();for(const l of e){const{notes:d,config:c}=l;if(!(d!=null&&d.length))continue;const u=We[e.indexOf(l)%We.length];t.fillStyle=u;const f=j(c.noteRange[0]),h=j(c.noteRange[1]);if(f==null||h==null)continue;const m=h-f||1,b=Math.max(2,r/m);for(const g of d){const p=j(g.pitch);if(p==null)continue;const _=g.start/a*n,S=Math.max(1,g.duration/a*n),v=(p-f)/m,C=r-v*r-b/2;t.fillRect(_,C,S,b)}}const o=Ve();if(o.length>0&&e.length>0){const{config:l}=e[0],d=j(l.noteRange[0]),c=j(l.noteRange[1]);if(d!=null&&c!=null){const u=c-d||1,f=Math.max(2,r/u);t.fillStyle="rgba(252, 159, 207, 0.41)";for(const h of o){const m=j(h.pitch);if(m==null)continue;const b=h.start/a*n,g=Math.max(1,h.duration/a*n),p=(m-d)/u,_=r-p*r-f/2;t.fillRect(b,_,g,f)}}}if(_t()){const l=ji();if(l!==null){const d=l/a*n,c=n*.01,u=6;Hr(t,d,u,c,u,"up")}}}function Kl(i,e){Vr(i,e)}function De(){const i=document.getElementById("global-mini-contour");if(!i)return;const e=J();Vr(i,e)}class $l{constructor(e,t,s,n,r,a,o,l){this.canvas=e,this.scroll=t,this.config=s,this.sequencerConfig=n,this.requestRedraw=r,this.getSequencerId=a,this.cursorController=o,this.store=l,this.isDragging=!1,this.wasAutoPaused=!1,this.AUTO_SCROLL_ZONE_PX=20,this.AUTO_SCROLL_SPEED_PX=10,this.autoScrollTimer=null,this.currentPointerX=null}updatePlayheadFromEvent(e){if(!Bt(e,this.canvas,this.config))return;const t=this.canvas.getBoundingClientRect(),s=this.config.layout.labelWidth,n=this.config.layout.baseCellWidth*this.config.behavior.zoom,a=(e.clientX-t.left+this.scroll.getX()-s)/n,o=ae(),l=Xr(a,this.sequencerConfig),d=Math.max(0,Math.min(o,l)),c=W.getInstance();c.seek(d),Xe(d),Vi(c,d),this.requestRedraw();const u=document.querySelector("#global-mini-playhead");if(u){const f=window.devicePixelRatio||1,h=u.width/f,m=d/o*h;Nt(m)}_t()&&De()}onMouseDown(e){if(!Bt(e,this.canvas,this.config))return!1;const t=W.getInstance();return t.isActive()&&t.pause().then(()=>{this.wasAutoPaused=!0}),this.isDragging=!0,this.currentPointerX=e.clientX,this.startAutoScrollLoop(),this.updatePlayheadFromEvent(e),this.cursorController.set(F.Grabbing),!0}onMouseMove(e){return Bt(e,this.canvas,this.config)?(this.currentPointerX=e.clientX,this.isDragging?(this.updatePlayheadFromEvent(e),this.cursorController.set(F.Grabbing)):this.cursorController.set(F.Grab),this.store.setSnappedCursorGridPosition(null),this.store.setHoveredNoteKey(null),this.requestRedraw(),!0):!1}onMouseUp(e){return this.isDragging?(this.updatePlayheadFromEvent(e),this.isDragging=!1,this.wasAutoPaused&&(W.getInstance().resume(),this.wasAutoPaused=!1),this.currentPointerX=null,this.stopAutoScrollLoop(),this.cursorController.set(F.Grab),!0):!1}onGlobalMouseUp(e){return this.onMouseUp(e)}onContextMenu(e){return!1}onMouseLeave(){return this.isDragging||this.cursorController.set(F.Default),!1}onMouseEnter(e){return Bt(e,this.canvas,this.config)?(this.cursorController.set(this.isDragging?F.Grabbing:F.Grab),!0):!1}onKeyDown(e){return!1}startAutoScrollLoop(){if(this.autoScrollTimer!==null)return;const e=()=>{if(!this.isDragging){this.stopAutoScrollLoop();return}const t=this.canvas.getBoundingClientRect(),s=this.currentPointerX;if(s===void 0||!s){this.stopAutoScrollLoop();return}let n=0;if(s<t.left+this.AUTO_SCROLL_ZONE_PX?n=-this.AUTO_SCROLL_SPEED_PX:s>t.right-this.AUTO_SCROLL_ZONE_PX&&(n=this.AUTO_SCROLL_SPEED_PX),n!==0){const r=this.scroll.getX()+n;this.scroll.setScroll(r,this.scroll.getY()),this.requestRedraw()}this.autoScrollTimer=requestAnimationFrame(e)};this.autoScrollTimer=requestAnimationFrame(e)}stopAutoScrollLoop(){this.autoScrollTimer!==null&&(cancelAnimationFrame(this.autoScrollTimer),this.autoScrollTimer=null)}destroy(){}}class zl{constructor(e){this.handlers=[new $l(e.canvas,e.scroll,e.config,e.sequencerConfig,e.requestRedraw,e.getSequencerId,e.cursorController,e.store)]}handleMouseDown(e){return this.dispatch("onMouseDown",e)}handleMouseMove(e){return this.dispatch("onMouseMove",e)}handleMouseUp(e){return this.dispatch("onMouseUp",e)}handleGlobalMouseUp(e){for(const t of this.handlers)if("onGlobalMouseUp"in t&&typeof t.onGlobalMouseUp=="function"&&t.onGlobalMouseUp(e)===!0)return!0;return!1}handleContextMenu(e){return this.dispatch("onContextMenu",e)}handleMouseLeave(){return this.dispatch("onMouseLeave")}handleMouseEnter(e){return this.dispatch("onMouseEnter",e)}handleKeyDown(e){return this.dispatch("onKeyDown",e)}dispatch(e,t){var s;for(const n of this.handlers)if(((s=n[e])==null?void 0:s.call(n,t))===!0)return!0;return!1}destroy(){var e;for(const t of this.handlers)(e=t.destroy)==null||e.call(t)}}class Hl{constructor(e){this.current=F.Default,this.canvas=e}set(e){this.current!==e&&(this.canvas.style.cursor=e,this.current=e)}reset(){this.set(F.Default)}}class Jl{constructor(e,t,s,n){this.context=e,this.overlayContext=t,this.canvas=s,this.sequencerContext=n,this.onMouseMove=r=>{this.overlayContext.handleMouseMove(r)||this.context.handleMouseMove(r)},this.onMouseDown=r=>{this.overlayContext.handleMouseDown(r)||this.context.handleMouseDown(r)},this.onMouseUp=r=>{this.overlayContext.handleMouseUp(r)||this.context.handleMouseUp(r)},this.onGlobalMouseUp=r=>{var a,o;(o=(a=this.overlayContext).handleGlobalMouseUp)!=null&&o.call(a,r)||this.context.handleMouseUp(r)},this.onMouseLeave=()=>{this.overlayContext.handleMouseLeave()||this.context.handleMouseLeave()},this.onMouseEnter=r=>{this.sequencerContext.isCollapsed()||ei()!==this.sequencerContext.getId()&&ls(this.sequencerContext.getId()),!this.overlayContext.handleMouseEnter(r)&&this.context.handleMouseEnter(r)},this.onContextMenu=r=>{this.overlayContext.handleContextMenu(r)||this.context.handleContextMenu(r)},this.onKeyDown=r=>{this.overlayContext.handleKeyDown(r)||this.context.handleKeyDown(r)},this.attachListeners(),this.canvas.style.pointerEvents="auto"}attachListeners(){this.canvas.addEventListener("mousemove",this.onMouseMove),this.canvas.addEventListener("mouseleave",this.onMouseLeave),this.canvas.addEventListener("mouseenter",this.onMouseEnter),this.canvas.addEventListener("mousedown",this.onMouseDown),this.canvas.addEventListener("mouseup",this.onMouseUp),this.canvas.addEventListener("contextmenu",this.onContextMenu),window.addEventListener("mouseup",this.onGlobalMouseUp),window.addEventListener("keydown",this.onKeyDown)}destroy(){this.canvas.removeEventListener("mousemove",this.onMouseMove),this.canvas.removeEventListener("mouseenter",this.onMouseEnter),this.canvas.removeEventListener("mouseleave",this.onMouseLeave),this.canvas.removeEventListener("mousedown",this.onMouseDown),this.canvas.removeEventListener("mouseup",this.onMouseUp),this.canvas.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("mouseup",this.onGlobalMouseUp),this.canvas.removeEventListener("keydown",this.onKeyDown)}}class Wl{constructor(e,t,s,n,r){this.canvas=e,this.scroll=t,this.requestRedraw=s,this.zoomIn=n,this.zoomOut=r,this.SCROLL_SPEED_X=1,this.SCROLL_SPEED_Y=1,this.onWheel=a=>{if(a.preventDefault(),a.ctrlKey){a.deltaY<0?this.zoomIn():a.deltaY>0&&this.zoomOut();return}const o=a.shiftKey||Math.abs(a.deltaX)>Math.abs(a.deltaY),l=a.deltaX||a.deltaY;if(o){const d=this.scroll.getX()+l*this.SCROLL_SPEED_X;this.scroll.setScroll(d,this.scroll.getY())}else{const d=this.scroll.getY()+a.deltaY*this.SCROLL_SPEED_Y;this.scroll.setScroll(this.scroll.getX(),d)}this.requestRedraw()},this.attachListeners()}attachListeners(){this.canvas.addEventListener("wheel",this.onWheel,{passive:!1})}destroy(){this.canvas.removeEventListener("wheel",this.onWheel)}}class jl{constructor(){this.snappedCursorGridPosition=null,this.previewNotes=[],this.hoveredNoteKey=null,this.marqueeBox=null,this.highlightedNoteKeys=new Set,this.suppressNextMouseUp=!1,this.selectedNotes=[],this.dragAnchorNoteKey=null,this.isOnScrollbar=!1,this.isScrolling=!1,this.isInitiatingSelectionDrag=!1,this.isDraggingNotes=!1,this.lastDeletionTime=0}setSnappedCursorGridPosition(e){this.snappedCursorGridPosition=e}getSnappedCursorGridPosition(){return this.snappedCursorGridPosition}setPreviewNotes(e){this.previewNotes=e}getPreviewNotes(){return this.previewNotes}clearPreviewNotes(){this.previewNotes=[]}setHoveredNoteKey(e){this.hoveredNoteKey=e}getHoveredNoteKey(){return this.hoveredNoteKey}setMarqueeBox(e){this.marqueeBox=e}getMarqueeBox(){return this.marqueeBox}hasMarquee(){return this.marqueeBox!==null}setHighlightedNotes(e){this.highlightedNoteKeys=new Set(e.map(t=>`${t.pitch}:${t.start}`))}clearHighlightedNotes(){this.highlightedNoteKeys.clear()}isNoteHighlighted(e){return this.highlightedNoteKeys.has(`${e.pitch}:${e.start}`)}suppressNextMouseUpEvent(){this.suppressNextMouseUp=!0}consumeSuppressMouseUpFlag(){const e=this.suppressNextMouseUp;return this.suppressNextMouseUp=!1,e}getSelectedNotes(){return this.selectedNotes}setSelectedNotes(e){e.length>0&&Xi(e),this.selectedNotes=e}clearSelection(){this.selectedNotes=[]}hasSelection(){return this.selectedNotes.length>0}setDragAnchorNoteKey(e){this.dragAnchorNoteKey=e}getDragAnchorNoteKey(){return this.dragAnchorNoteKey}setIsOnScrollbar(e){this.isOnScrollbar=e}getIsOnScrollbar(){return this.isOnScrollbar}setIsScrolling(e){this.isScrolling=e}isOnNonGridElement(){return this.isOnScrollbar||this.isScrolling}beginSelectionDrag(){this.isInitiatingSelectionDrag=!0}endSelectionDrag(){this.isInitiatingSelectionDrag=!1}isDraggingToSelect(){return this.isInitiatingSelectionDrag}setIsDraggingNotes(e){this.isDraggingNotes=e}getIsDraggingNotes(){return this.isDraggingNotes}isActivelyDragging(){return this.isDraggingNotes||this.isInitiatingSelectionDrag}setLastDeletionTime(){this.lastDeletionTime=performance.now()}getLastDeletionTime(){return this.lastDeletionTime}}class Xl{constructor(e){this.container=this.createContainer(),e.appendChild(this.container),this.gridCanvas=this.createCanvas("gridCanvas"),this.noteCanvas=this.createCanvas("noteCanvas"),this.animationCanvas=this.createCanvas("animationCanvas"),this.playheadCanvas=this.createCanvas("playheadCanvas"),this.aipreviewCanvas=this.createCanvas("aipreviewCanvas"),this.aiAnimationCanvas=this.createCanvas("aiAnimationCanvas"),this.container.appendChild(this.gridCanvas),this.container.appendChild(this.noteCanvas),this.container.appendChild(this.animationCanvas),this.container.appendChild(this.playheadCanvas),this.container.appendChild(this.aipreviewCanvas),this.container.appendChild(this.aiAnimationCanvas),this.gridCtx=this.getCtx(this.gridCanvas),this.noteCtx=this.getCtx(this.noteCanvas),this.animationCtx=this.getCtx(this.animationCanvas),this.playheadCtx=this.getCtx(this.playheadCanvas),this.aipreviewCtx=this.getCtx(this.aipreviewCanvas),this.aiAnimationCtx=this.getCtx(this.aiAnimationCanvas),this.injectContainerStyles(),this.injectCanvasStyles()}createContainer(){const e=document.createElement("div");return e.id="grid-container",e.style.position="relative",e.style.width="100%",e.style.height="100%",e.style.background="#222",e.style.border="1px solid #333",e.style.overflow="hidden",e.style.boxShadow="0 0 20px rgba(0,0,0,0.4)",e.style.borderRadius="6px",e}createCanvas(e){const t=document.createElement("canvas");return t.id=e,t.style.display="block",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.pointerEvents="none",t}getCtx(e){const t=e.getContext("2d");if(!t)throw new Error(`2D context not available for canvas with id: ${e.id}`);return t}injectContainerStyles(){const e=document.createElement("style");e.textContent=`
        #grid-container canvas {
          z-index: 0;
        }
        #grid-container canvas#noteCanvas {
          z-index: 1;
        }
        #grid-container canvas#aipreviewCanvas {
          z-index: 2;
        }
        #grid-container canvas#aiAnimationCanvas {
          z-index: 3;
        }
        #grid-container canvas#animationCanvas {
          z-index: 4;
        }
        #grid-container canvas#playheadCanvas {
          z-index: 5;
        }
      `,document.head.appendChild(e)}injectCanvasStyles(){}}class Vl{constructor(e,t){this.scroll=e,this.config=t}draw(e){const{layout:{baseCellWidth:t,headerHeight:s,labelWidth:n},totalMeasures:r,beatsPerMeasure:a,behavior:{zoom:o}}=this.config,{gridColorScheme:l}=V().theme,d=Hi[l],c=t*o,u=this.scroll.getX(),f=e.canvas.offsetWidth;e.save(),e.translate(n-u,0);const h=e.createLinearGradient(0,0,0,s);h.addColorStop(0,d.labelWhite),h.addColorStop(1,d.labelBlack),e.fillStyle=h,e.fillRect(-n+u,0,f,s);for(let m=0;m<=r;m++){const g=m*a*c,p=m%4===0;e.strokeStyle=p?d.measureLine:d.beatLine,e.lineWidth=p?2:1,e.beginPath(),e.moveTo(g,0),e.lineTo(g,s),e.stroke(),e.textAlign="center",e.textBaseline="top",e.fillStyle=p?d.textWhite:d.textBlack,e.font=`${p?"bold":""} ${Math.floor(s*.5)}px 'Inter', sans-serif`;const _=g+a*c/2;e.fillText(`${m+1}`,_,4)}e.restore()}}class Yl{constructor(e,t,s,n){this.scroll=e,this.config=t,this.getCustomLabels=s,this.getBlackKeyMap=n;const{lowestMidi:r,highestMidi:a}=t.layout;this.blackKeyMap=Nr(r,a)}draw(e){const{layout:{baseCellWidth:t,verticalCellRatio:s,headerHeight:n,labelWidth:r,highestMidi:a,lowestMidi:o},behavior:{zoom:l}}=this.config,{gridColorScheme:d}=V().theme,c=Hi[d],u=a-o+1,f=this.scroll.getY(),m=t*l/s,b=e.canvas.offsetHeight??u*m+n;e.save(),e.translate(0,-f);const g=e.createLinearGradient(0,0,0,b);g.addColorStop(0,c.labelWhite),g.addColorStop(1,c.labelBlack),e.fillStyle=g,e.fillRect(0,f,r,b),e.font=`${Math.floor(m*.6)}px 'Inter', sans-serif`,e.textAlign="right",e.textBaseline="middle",e.strokeStyle=c.gridLine,e.lineWidth=1,e.beginPath(),e.moveTo(r-.5,f),e.lineTo(r-.5,f+b),e.stroke();const p=this.getCustomLabels();for(let _=0;_<u;_++){const S=_*m+n,v=a-_,C=(p==null?void 0:p[v])??ne(_,o,a),N=this.getBlackKeyMap().get(v)??!1;e.fillStyle=N?c.textBlack:c.textWhite,e.fillText(C,r-8,S+m/2)}e.restore()}}class Zl{constructor(e,t,s){this.scroll=e,this.config=t,this.interactionStore=s}draw(e){const t=this.interactionStore.getMarqueeBox();if(!t)return;const{layout:{baseCellWidth:s,verticalCellRatio:n},behavior:{zoom:r}}=this.config,a=this.scroll.getX(),o=this.scroll.getY(),l=Math.min(t.startX,t.currentX),d=Math.min(t.startY,t.currentY),c=Math.abs(t.currentX-t.startX),u=Math.abs(t.currentY-t.startY);c<1||u<1||(e.save(),e.translate(this.config.layout.labelWidth-a,this.config.layout.headerHeight-o),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),je(e,l,d,c,u,3),e.stroke(),e.restore())}}const wt={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0};let Yr={notes:[],anchorBeat:0,anchorMidi:0};function Ql(i){if(i.length===0)return;const e=i[0],t=e.start,s=j(e.pitch)??0;Yr={notes:i.map(n=>({pitch:n.pitch,start:n.start,duration:n.duration,velocity:n.velocity??100})),anchorBeat:t,anchorMidi:s}}function ec(){return Yr}class tc{constructor(){this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t)}off(e,t){var s;(s=this.listeners[e])==null||s.delete(t)}emit(e,t){var s;(s=this.listeners[e])==null||s.forEach(n=>n(t))}clear(e){var t;(t=this.listeners[e])==null||t.clear()}removeAllListeners(){var e;for(const t in this.listeners)(e=this.listeners[t])==null||e.clear()}}class ic{constructor(e,t={},s){this.sequencerConfig=wt,this.needsRedraw=!0,this.customLabels=null,this.blackKeyMap=new Map,this.isDestroyed=!1,this.onWindowResize=()=>this.resize(),this.config=bs(Zo(),t),this.sequencerContext=s,this.recalculateLabelAndHeader(),this.gridManager=new Xl(e);const{gridCanvas:n,noteCanvas:r,animationCanvas:a,playheadCanvas:o,aipreviewCanvas:l,aiAnimationCanvas:d}=this.gridManager;this.gridCanvasManager=new Ue(n),this.noteCanvasManager=new Ue(r),this.animationCanvasManager=new Ue(a),this.playheadCanvasManager=new Ue(o),this.aipreviewCanvasManager=new Ue(l),this.aiAnimationCanvasManager=new Ue(d);const c=this.gridManager.container;this.noteManager=new rl(this.config,this.sequencerContext.playNote),this.interactionStore=new jl,this.emitter=new tc,this.scroll=new il(c,this.config),this.scrollbars=new Cl(c,this.scroll,this.config,this.interactionStore,()=>this.requestRedraw()),this.wheelHandler=new Wl(c,this.scroll,()=>this.requestRedraw(),()=>this.zoomIn(),()=>this.zoomOut()),this.cursorController=new Hl(c),this.overlayContext=new zl({canvas:n,scroll:this.scroll,config:this.config,sequencerConfig:this.sequencerConfig,requestRedraw:()=>this.requestRedraw(),getSequencerId:()=>this.sequencerContext.getId(),cursorController:this.cursorController,store:this.interactionStore}),this.interactionContext=new Ul({canvas:r,noteManager:this.noteManager,scroll:this.scroll,config:this.config,store:this.interactionStore,grid:this,addNote:u=>this.noteManager.add(u),requestRedraw:()=>this.requestRedraw(),sequencerContext:s,cursorController:this.cursorController,setClipboard:Ql,getClipboard:ec,playNoteAnimation:u=>this.playNoteAnimation(u)}),this.inputTracker=new Jl(this.interactionContext,this.overlayContext,c,{getId:()=>this.sequencerContext.getId(),isCollapsed:()=>this.sequencerContext.isCollapsed()}),this.gridRenderer=new Qo(this.scroll,this.config,this.interactionStore,()=>this.getBlackKeyMap(),()=>Ht()),this.noteRenderer=new hl(this.scroll,this.config,this.noteManager,this.interactionStore,this.sequencerContext.getId()),this.notePreviewRenderer=new fl(this.scroll,this.config,this.interactionStore,()=>this.getNoteDuration()),this.animationRenderer=new bl(this.scroll,this.config),this.headerRenderer=new Vl(this.scroll,this.config),this.labelRenderer=new Yl(this.scroll,this.config,()=>this.customLabels,()=>this.getBlackKeyMap()),this.playheadRenderer=new vl(this.scroll,this.config),this.marqueeRenderer=new Zl(this.scroll,this.config,this.interactionStore),this.aiAutocompletePreviewRenderer=new gl(this.scroll,this.config),this.aiAnimationRenderer=new _l(this.scroll,this.config,this.aiAnimationCanvasManager.getContext()),this.initialZoom=this.zoom,this.customLabels=null,requestAnimationFrame(()=>this.resize()),this.playheadRenderer.setPlayheadX(0),this.attachListeners(),this.renderLoop()}attachListeners(){window.addEventListener("resize",this.onWindowResize)}detachListeners(){window.removeEventListener("resize",this.onWindowResize)}renderLoop(){this.isDestroyed||(this.needsRedraw&&(this.render(),this.needsRedraw=!1),requestAnimationFrame(()=>this.renderLoop()))}recalculateLabelAndHeader(){const{baseCellWidth:e,verticalCellRatio:t,labelWidthColumns:s,headerHeightRows:n}=this.config.layout,r=this.zoom,a=e*r,o=a/t;this.config.layout.labelWidth=s*a,this.config.layout.headerHeight=n*o}get zoom(){return this.config.behavior.zoom}set zoom(e){this.config.behavior.zoom=e}get notes(){const e=this.noteManager.getAll();return e||[]}render(){this.gridCanvasManager.clear(),this.noteCanvasManager.clear(),this.animationCanvasManager.clear(),this.playheadCanvasManager.clear(),this.aipreviewCanvasManager.clear();const e=this.gridCanvasManager.getContext(),t=this.noteCanvasManager.getContext(),s=this.animationCanvasManager.getContext(),n=this.playheadCanvasManager.getContext(),r=this.aipreviewCanvasManager.getContext();this.gridRenderer.draw(e),this.noteRenderer.draw(t),this.notePreviewRenderer.draw(t),this.animationRenderer.draw(s),this.labelRenderer.draw(e),this.headerRenderer.draw(e),this.playheadRenderer.draw(n),this.aiAutocompletePreviewRenderer.draw(r),this.interactionStore.hasMarquee()&&this.marqueeRenderer.draw(s),this.scrollbars.update()}setConfig(e){this.config=bs(this.config,e),this.recalculateLabelAndHeader(),this.requestRedraw()}getConfig(){return this.config}requestRedraw(){this.needsRedraw=!0}resize(){this.gridCanvasManager.resize(),this.noteCanvasManager.resize(),this.animationCanvasManager.resize(),this.playheadCanvasManager.resize(),this.aipreviewCanvasManager.resize(),this.aiAnimationCanvasManager.resize(),this.scroll.recalculateBounds(),this.scrollbars.update(),this.requestRedraw()}on(e,t){this.emitter.on(e,t)}off(e,t){this.emitter.off(e,t)}setPlayheadPixelX(e){this.playheadRenderer.setPlayheadX(e),this.requestRedraw()}getPixelsPerBeat(){return this.config.layout.baseCellWidth*this.config.behavior.zoom}setNotes(e){this.noteManager.set(e),this.requestRedraw()}playNoteAnimation(e){this.animationRenderer.playNote(e)}invalidateAIAutocompleteRenderer(){this.aiAnimationRenderer.invalidate()}startAIAutocompleteAnimationLoop(){this.aiAnimationRenderer.start()}stopAIAutocompleteAnimationLoop(){this.aiAnimationRenderer.stop()}setActiveAutocompleteBar(e){this.aiAnimationRenderer.setActiveAutocompleteBar(e),requestAnimationFrame(this.aiAnimationRenderer.renderFrame)}playNoteAcceptanceAnimation(e){this.aiAnimationRenderer.playNoteAcceptance(e)}getTrackedNotes(){return this.noteManager.getTrackedNotes(this.interactionStore)}scrollTo(e,t){this.scroll.setScroll(e,t),this.scrollbars.update(),this.requestRedraw()}setZoom(e){this.zoom=e,this.scroll.recalculateBounds(),this.recalculateLabelAndHeader(),this.requestRedraw()}getZoom(){return this.zoom}resetZoom(){this.setZoom(this.initialZoom)}zoomIn(){this.setZoom(Math.min(this.config.behavior.maxZoom,this.zoom+.1))}zoomOut(){this.setZoom(Math.max(this.config.behavior.minZoom,this.zoom-.1))}setCustomLabels(e){this.customLabels=e,this.requestRedraw()}getMeasures(){return this.config.totalMeasures}setMeasures(e){this.config.totalMeasures=Math.max(1,e),this.scroll.recalculateBounds(),this.requestRedraw()}getBeatsPerMeasure(){return this.config.beatsPerMeasure}setBeatsPerMeasure(e){this.config.beatsPerMeasure=Math.max(1,e),this.scroll.recalculateBounds(),this.requestRedraw()}getTotalBeats(){return this.config.totalMeasures*this.config.beatsPerMeasure}setNoteRange(e,t){this.config.layout.lowestMidi=e,this.config.layout.highestMidi=t,this.blackKeyMap=Nr(e,t),this.scroll.recalculateBounds(),this.recalculateLabelAndHeader(),this.resize(),this.requestRedraw()}refreshNoteRange(){this.setNoteRange(this.config.layout.lowestMidi,this.config.layout.highestMidi)}getBlackKeyMap(){return this.blackKeyMap}isTripletMode(){return Gi()}getNoteDuration(){return this.sequencerConfig.currentDuration}getSnapResolution(){return Qt()}getInteractionStore(){return this.interactionStore}getNoteManager(){return this.noteManager}getInteractionContext(){return this.interactionContext}emit(e,t){this.emitter.emit(e,t)}destroy(){this.inputTracker.destroy(),this.wheelHandler.destroy(),this.scrollbars.destroy(),this.aiAnimationRenderer.stop(),this.gridManager.container.remove(),this.gridCanvasManager.destroy(),this.noteCanvasManager.destroy(),this.animationCanvasManager.destroy(),this.playheadCanvasManager.destroy(),this.aipreviewCanvasManager.destroy(),this.aiAnimationCanvasManager.destroy(),this.detachListeners(),this.emitter.removeAllListeners(),this.interactionContext.destroy(),this.overlayContext.destroy(),this.isDestroyed=!0}}function sc(i,e,t){return new ic(i,e,t)}function Zr({instrument:i,midi:e,time:t,duration:s,velocity:n}){var a;const r=((a=i.__midiMap)==null?void 0:a.get(e))??e;if(!(i!=null&&i.start)){console.warn("[startInstrumentNote] Instrument missing start() method");return}try{i.start({note:r,time:t,duration:s,velocity:n})}catch(o){console.warn("[startInstrumentNote] Failed to start instrument note",{midi:e,resolved:r,err:o})}}function Yi(i,e){var t;(t=i==null?void 0:i.stop)==null||t.call(i);for(const s of e)clearTimeout(s);e.length=0}async function rc(i,e,t,s,n,r,a,o=0){if(!n)return;if(i||await e(),Yi(i,r),!(i!=null&&i.start)){console.warn("[playback] Instrument does not support scheduled playback.");return}const d=60/ve(),c=performance.now();t.sort((f,h)=>f.start-h.start);let u=0;for(;u<t.length&&t[u].start<o;)u++;for(;u<t.length;u++){const f=t[u],h=Y(f.pitch);if(h==null)continue;const m=f.start-o,b=a+m*d,g=f.duration*d,p=f.velocity??100;if(Zr({instrument:i,midi:h,time:b,duration:g,velocity:p}),!s){const _=c+m*d*1e3,S=Math.max(0,_-performance.now()),v=setTimeout(()=>{n==null||n.playNoteAnimation(f)},S);r.push(v)}}}function nc(i,e,t,s,n,r){if(!s||n)return;const o=60/ve();performance.now();const c=(te().currentTime-e)/o,u=t+c;for(const f of i){if(f.start<u)continue;const m=(f.start-u)*o*1e3;if(m>=0){const b=setTimeout(()=>{s==null||s.playNoteAnimation(f)},m);r.push(b)}}}async function ac(i,e,t,s,n,r,a,o,l,d=0){if(!s||(Yi(i,o),i||await e(),r||!a||!(i!=null&&i.start)))return;const u=60/ve(),f=performance.now(),h=te().currentTime,m=t.filter(b=>b.start>=d);for(const b of m){const g=Y(b.pitch);if(g==null)continue;const p=b.start-d,_=l+p*u;if(_<=h+.01)continue;const S=b.duration*u,v=b.velocity??100;if(Zr({instrument:i,midi:g,time:_,duration:S,velocity:v}),!n){const C=f+p*u*1e3,N=Math.max(0,C-performance.now()),w=setTimeout(()=>{s==null||s.playNoteAnimation(b)},N);o.push(w)}}}class Qr{constructor(e,t,s=te(),n=ze(),r="sf2/fluidr3-gm/acoustic_grand_piano",a=!1,o=0){if(this.colorIndex=0,this.id=0,this.mute=!1,this.solo=!1,this.collapsed=!1,this.miniContour=null,this.body=null,this.collapseIcon=null,this._scheduledAnimations=[],this._volume=100/127,this._pan=0,this._instrument=null,this.id=o,this.container=e,this.config={...t},this.context=s,this.destination=n,this.instrumentName=r,this.squelchLoadingScreen=a,this.container){const l=this.container.querySelector(".sequencer-body");this.matrix=sc(l,{},{playNote:this.playNote.bind(this),getId:()=>this.id,isCollapsed:()=>this.collapsed}),this.matrix.refreshNoteRange()}}async initInstrument(){try{this._instrument=await Ur(this.instrumentName,this.context,this.destination,this._volume,this._pan,!1,!1),this.updateToDrumNoteRange()}catch(e){console.warn(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,e)}}setInstrument(e){this.instrumentName=e,this.updateTrackLabel(),this.initInstrument()}updateTrackLabel(){var t;const e=(t=this.container)==null?void 0:t.querySelector(".track-name");e&&(e.textContent=`${this.id+1}: ${this.instrumentName}`)}get notes(){var e;return((e=this.matrix)==null?void 0:e.notes)??[]}get volume(){return this._volume}set volume(e){var t;this._volume=Math.max(0,Math.min(1,e)),(t=this._instrument)!=null&&t.setVolume&&this._instrument.setVolume(this._volume)}get pan(){return this._pan}set pan(e){var t;this._pan=Math.max(-1,Math.min(1,e)),(t=this._instrument)!=null&&t.setPan&&this._instrument.setPan(this._pan)}get shouldPlay(){return kd()?this.solo:!this.mute}get scheduledAnimations(){return this._scheduledAnimations}set scheduledAnimations(e){this._scheduledAnimations=e}toggleMute(){const e=W.getInstance();this.mute=!this.mute,this.mute&&(this.solo=!1),this.stopScheduledNotes(),gs(this),e.isActive()&&qs()}toggleSolo(){const e=W.getInstance();this.solo=!this.solo,this.solo&&(this.mute=!1),gs(this),e.isActive()&&qs()}setCollapsed(e){this.collapsed=e,e&&ei()===this.id&&yn()}isCollapsed(){return this.collapsed}resetInteractionMode(){var e;(e=this.matrix)==null||e.getInteractionContext().reset()}async preparePlayback(e,t=0){var s;await rc(this._instrument,()=>this.initInstrument(),((s=this.matrix)==null?void 0:s.notes)??[],this.collapsed,this.matrix??null,this._scheduledAnimations,e,t)}stopScheduledNotes(){Yi(this._instrument,this._scheduledAnimations)}resumeAnimationsFromCurrentTime(e,t){var s;nc(((s=this.matrix)==null?void 0:s.notes)??[],e,t,this.matrix??null,this.collapsed,this._scheduledAnimations)}async reschedulePlayback(e,t=0){var s;await ac(this._instrument,()=>this.initInstrument(),((s=this.matrix)==null?void 0:s.notes)??[],this.matrix??null,this.collapsed,this.mute,this.shouldPlay,this._scheduledAnimations,e,t)}async exportToOffline(e,t){var n;const s=t??((n=this.matrix)==null?void 0:n.notes);!s||s.length===0||await Ho(this.instrumentName,this.context,this.destination,s,this._volume,this._pan,e)}playNote(e,t,s=100,n=!1){return yo(this.instrumentName,e,t,s,n,null,Fe(),this.destination,this.volume,this.pan)}updateTotalMeasures(){this.matrix&&this.matrix.setMeasures(ns())}updateBeatsPerMeasure(){this.matrix&&this.matrix.setBeatsPerMeasure(Oe())}redraw(){var e;(e=this.matrix)==null||e.requestRedraw()}getState(){return this.matrix?{notes:[...this.matrix.notes],config:{...this.config},instrument:this.instrumentName}:{notes:[],config:this.config,instrument:this.instrumentName}}setState({notes:e,config:t,instrument:s,volume:n,pan:r,collapsed:a}){this.matrix&&(this.matrix.setNotes(e),Object.assign(this.config,t),typeof n=="number"&&(this.volume=n),typeof r=="number"&&(this.pan=r),Dt(this,a),s&&(this.instrumentName=s),this.redraw())}updateNotesFromTrackMap(e){this.matrix&&this.matrix.notes.splice(0,this.matrix.notes.length,...e.n.map(([t,s,n,r=100])=>({pitch:t,start:s,duration:n,velocity:r})))}updateNoteRange(e){Li({config:this.config,container:this.container,matrix:this.matrix,instrumentName:this.instrumentName,colorIndex:this.colorIndex,getNotes:()=>{var t;return((t=this.matrix)==null?void 0:t.notes)??[]}},e)}updateToDrumNoteRange(){Jo({config:this.config,container:this.container,matrix:this.matrix,instrumentName:this.instrumentName,colorIndex:this.colorIndex,getNotes:()=>{var e;return((e=this.matrix)==null?void 0:e.notes)??[]}})}destroy(){var e,t;this.stopScheduledNotes(),(e=this.matrix)==null||e.destroy(),(t=this.container)==null||t.remove(),xd(this.id),W.getInstance().removeSequencer(this),this._instrument=null,this.matrix=void 0,this.container=null,this.refreshPanUI=void 0,this.refreshVolumeUI=void 0}}function oc(i,e){const t=structuredClone(i);t.sequencers=t.sequencers.filter(n=>n.id!==e.id);const s=qr(e.id);return s?s.destroy():console.warn(`DELETE_SEQUENCER: No controller found for id ${e.id}`),ls(null),zr(),t}function en(i,e,t=[],s,n,r){return{type:"DELETE_SEQUENCER",id:i,instrument:e,notes:structuredClone(t),volume:s,pan:n,collapsed:r}}function tn(i,e,t=[],s,n,r){return{type:"CREATE_SEQUENCER",id:i,instrument:e,notes:structuredClone(t),volume:s,pan:n,collapsed:r}}function lc(i,e,t){const s={id:t,...wt},n=e.instrument||"sf2/fluidr3-gm/acoustic_grand_piano",r=new Qr(i,s,te(),ze(),n,!0,t);r.id=t,r.colorIndex=t,r.mute=!1,r.solo=!1,r.volume=100/127,e.notes&&r.matrix&&r.matrix.setNotes(e.notes),e&&r.setState({notes:e.notes,config:{},instrument:e.instrument,volume:e.volume,pan:e.pan,collapsed:e.collapsed});const a=i.querySelector("canvas.mini-contour");return r.miniContour=a,Jt(a,r.notes,r.config,r.colorIndex),r.updateTrackLabel(),r.initInstrument(),Md(r.id,r),W.getInstance().addSequencer(r),{seq:r}}function cc(){var i,e;for(const t of J().slice())O(en(t.id,t.instrumentName,((i=t.matrix)==null?void 0:i.getNoteManager().getAll())??[],t.volume,t.pan,t.collapsed),tn(t.id,t.instrumentName,((e=t.matrix)==null?void 0:e.getNoteManager().getAll())??[],t.volume,t.pan,t.collapsed));Ld(),Wo(),W.getInstance().clearSequencers()}function I(i,e){return y("img",{src:fe(`static/svg/${i}.svg`),class:"w-6 h-6",alt:e})}function dc(){const i=U(),e=y("div",{class:`sequencer-header flex justify-between items-center ${i.textColor}`}),t=y("canvas",{class:"mini-contour w-full h-10 mb-2 bg-gray-800 rounded hidden"}),s=y("div",{class:`sequencer-body flex pt-2 h-[720px] border-t ${i.borderColor}`}),n=y("div",{class:"grip-handle group flex justify-center items-center h-6 cursor-grab hover:bg-gray-800 rounded"},I("icon-grip","Drag Track"));return{element:y("div",{class:`sequencer flex flex-col space-y-2 p-4 rounded ${i.surfaceBackground}`},e,t,s,n),topBarContainer:e,miniContourCanvas:t,matrixContainer:s,gripHandleContainer:n}}function uc(){const i=U(),e=y("div",{class:"sequencer-left-group-wrapper flex items-center gap-2"}),t=y("div",{class:"sequencer-volume-wrapper"}),s=y("div",{class:"sequencer-pan-wrapper"}),n=y("div",{class:"sequencer-zoom-wrapper flex items-center gap-2"}),r=y("div",{class:"sequencer-right-controls-wrapper flex items-center gap-2"}),a=y("div",{class:"sequencer-right-group-container flex items-center gap-3"},t,s,n,r);return{element:y("div",{class:`sequencer-header flex justify-between items-center w-full px-2 ${i.textColor}`},e,a),leftGroup:e,volumeWrapper:t,panWrapper:s,zoomWrapper:n,rightControlsWrapper:r}}function hc(){const i=U(),e=y("button",{class:["instrument-select-btn","side-button-primary","cursor-pointer px-2 py-1 rounded w-8","flex items-center justify-center",i.buttonPrimaryColor,i.buttonPrimaryColorHover,i.textColor].join(" "),title:"Change Instrument"},I("icon-list-instrument","Change Instrument")),t=y("button",{draggable:"true",class:["copy-midi-btn","side-button-secondary","cursor-grab select-none","px-2 py-1 rounded w-8 flex items-center justify-center","transition-transform transition-opacity duration-150","hover:scale-105 hover:brightness-110 active:cursor-grabbing",i.buttonSecondaryColor,i.buttonSecondaryColorHover,i.textColor].join(" "),title:"Export MIDI Track (Drag to Desktop)"},I("icon-copy","Export MIDI")),s=y("span",{class:`track-name font-semibold ${i.textColor}`},"Track");return{instrumentButton:e,copyMidiButton:t,label:s}}function fc(){const i=U(),e=y("div",{class:`volume-fill absolute top-0 left-0 h-full bg-gradient-to-r ${i.volumeGradientFrom} ${i.volumeGradientTo}`,style:"width: 60%;"}),t=y("div",{class:`volume-snap-marker absolute top-0 bottom-0 w-[2px] ${i.snapMarkerColor} pointer-events-none`,style:"left: 78.74%;"}),s=y("div",{class:["volume-thumb absolute top-1/2 -translate-y-1/2 w-[14px] h-[14px]","rounded-full shadow-md border group-hover:scale-110",i.borderColor,i.volumeThumbColor].join(" "),style:"left: calc(60% - 5px);"});return{element:y("div",{class:`volume-bar relative w-[140px] h-[16px] rounded-full overflow-hidden shadow-inner group cursor-pointer bg-gray-700 border ${i.borderColor}`},e,t,s),fill:e,snapMarker:t,thumb:s}}function pc(){const i=U(),e=y("div",{class:`pan-fill absolute top-0 left-0 h-full bg-gradient-to-r ${i.panGradientFrom} ${i.panGradientTo}`,style:"width: 50%;"}),t=y("div",{class:`pan-snap-marker absolute top-0 bottom-0 w-[2px] ${i.snapMarkerColor} pointer-events-none`,style:"left: 50%;"}),s=y("div",{class:["pan-thumb absolute top-1/2 -translate-y-1/2 w-[14px] h-[14px]","rounded-full shadow-md border group-hover:scale-110",i.borderColor,i.panThumbColor].join(" "),style:"left: calc(50% - 5px);"});return{element:y("div",{class:`pan-bar relative w-[140px] h-[16px] rounded-full overflow-hidden shadow-inner group cursor-pointer bg-gray-700 border ${i.borderColor}`},e,t,s),fill:e,snapMarker:t,thumb:s}}function mc(){const i=U(),e=y("button",{class:["zoom-in-btn hidden","cursor-pointer px-2 py-1 rounded w-8","flex items-center justify-center",i.buttonSecondaryColor,i.buttonSecondaryColorHover,i.textColor].join(" "),title:"Zoom In"},I("icon-zoom-in","Zoom In")),t=y("button",{class:["zoom-out-btn hidden","cursor-pointer px-2 py-1 rounded w-8","flex items-center justify-center",i.buttonSecondaryColor,i.buttonSecondaryColorHover,i.textColor].join(" "),title:"Zoom Out"},I("icon-zoom-out","Zoom Out")),s=y("button",{class:["zoom-reset-btn hidden","cursor-pointer px-2 py-1 rounded w-8","flex items-center justify-center",i.buttonSecondaryColor,i.buttonSecondaryColorHover,i.textColor].join(" "),title:"Reset Zoom"},I("icon-reset","Reset Zoom")),n=y("div",{class:`zoom-button-divider hidden border-l mx-2 h-6 ${i.borderColor}`}),r=y("div",{class:`zoom-button-divider hidden border-l mx-2 h-6 ${i.borderColor}`});return{element:y("div",{class:"flex items-center gap-2"},n,e,t,s,r),leadingDivider:n,zoomInBtn:e,zoomOutBtn:t,zoomResetBtn:s,trailingDivider:r}}function yc(){const i=U(),e=["side-button-secondary cursor-pointer px-2 py-1 rounded w-8","flex items-center justify-center",i.buttonSecondaryColor,i.buttonSecondaryColorHover,i.textColor],t=y("button",{class:[...e,"mute-btn"].join(" "),title:"Mute Track"},I("icon-volume-mute","Mute Track")),s=y("button",{class:[...e,"solo-btn"].join(" "),title:"Solo Track"},I("icon-headphones","Solo Track")),n=y("button",{class:[...e,"collapse-btn"].join(" "),title:"Expand/Collapse Track"},I("icon-caret-down","Expand/Collapse")),r=y("button",{class:[...e,"delete-btn hover:bg-red-600"].join(" "),title:"Delete Track"},I("icon-close-circle","Delete Track"));return{element:y("div",{class:"flex items-center gap-2"},t,s,n,r),muteBtn:t,soloBtn:s,collapseBtn:n,deleteBtn:r}}function gc(i,e,t){let s=!1,n=0,r=0;const a=150,o=1e3,l=u=>{s=!0,n=u.clientY,r=e.offsetHeight,i.classList.replace("cursor-grab","cursor-grabbing"),document.body.style.userSelect="none"},d=u=>{if(!s)return;const f=u.clientY-n;let h=r+f;h=Math.max(a,Math.min(o,h)),e.style.height=`${h}px`,t.resize()},c=()=>{s&&(s=!1,i.classList.replace("cursor-grabbing","cursor-grab"),document.body.style.userSelect="")};return i.addEventListener("mousedown",l),window.addEventListener("mousemove",d),window.addEventListener("mouseup",c),{detach:()=>{i.removeEventListener("mousedown",l),window.removeEventListener("mousemove",d),window.removeEventListener("mouseup",c)},refreshUI:()=>{}}}const bc={sm:"text-base",md:"text-lg",lg:"text-xl",xl:"text-2xl"};function _e(i){const e=U();if(typeof i=="string")return y("h2",{class:["text-lg font-semibold mb-4",e.textColor].join(" "),textContent:i});const{text:t,size:s="md",additionalClasses:n=""}=i;return y("h2",{class:[bc[s],"font-semibold mb-4",e.textColor,n].join(" "),textContent:t})}function _c(){const i=_e({text:"Delete Track",size:"lg",additionalClasses:"text-center mb-4"}),e=y("p",{class:"mb-6 text-center text-sm",textContent:"Are you sure you want to delete this track?"}),t=z({id:"delete-confirm",text:"Delete",kind:"tertiary",additionalClasses:"flex-1 py-2"}),s=z({id:"delete-cancel",text:"Cancel",kind:"secondary",additionalClasses:"flex-1 py-2"}),n=y("div",{class:"flex gap-3 w-full"},t,s);return he("delete-confirm-modal",[i,e,n],{sizePreset:"sm"})}function vc(i,e,t){const s=i.querySelector("#delete-confirm"),n=i.querySelector("#delete-cancel"),r=()=>{e(),i.classList.add("hidden")},a=()=>{t(),i.classList.add("hidden")};return s==null||s.addEventListener("click",r),n==null||n.addEventListener("click",a),{detach:()=>{s==null||s.removeEventListener("click",r),n==null||n.removeEventListener("click",a)},refreshUI:()=>{}}}class Sc{constructor(){this.detachFn=null,this.modal=_c(),document.body.appendChild(this.modal)}show(e,t){var n;(n=this.detachFn)==null||n.call(this);const s=vc(this.modal,e,t);this.detachFn=s.detach,this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function Le(i){const{id:e,label:t,stateA:s,stateB:n,tooltipTrigger:r,inline:a}=i,o=U(),l=s?y("span",{class:`text-sm transition-opacity ${o.textColor}`,textContent:s}):null,d=y("span",{class:`text-sm transition-opacity ${o.textColor}`,textContent:n}),c=y("input",{id:e,type:"checkbox",class:"sr-only peer"}),u=y("div",{class:["w-11 h-6 rounded-full peer relative",o.toggleTrackBase,o.toggleTrackChecked,'after:content-[""] after:absolute after:top-[2px] after:left-[2px]',"after:bg-white after:border after:rounded-full","after:h-5 after:w-5 after:transition-all",o.toggleKnobBase,o.toggleKnobChecked,"peer-checked:after:translate-x-full"].join(" ")}),f=()=>{const g=c.checked;l&&(l.style.opacity=g?"0.5":"1"),d.style.opacity=g?"1":"0.5"};c.addEventListener("change",f);const h=[];l&&h.push(l),h.push(y("label",{class:"relative inline-flex items-center cursor-pointer"},c,u)),h.push(d),r&&h.push(r);const m=y("div",{class:"flex items-center gap-3"},...h),b=a?m:y("div",{class:"mb-6"},t?y("label",{class:`block text-sm font-medium mb-2 ${o.textColor}`,textContent:t}):null,m);return requestAnimationFrame(f),{element:b,input:c,setChecked:g=>{c.checked=g,f()},getChecked:()=>c.checked,update:f}}function X(i,e){const t=U();if(typeof i=="string")return y("label",{class:`block text-sm font-medium mb-2 flex items-center gap-2 ${t.textColor}`},i,e??null);const{text:s,for:n,trailingElement:r}=i;return y("label",{...n?{htmlFor:n}:{},class:`block text-sm font-medium mb-2 flex items-center gap-2 ${t.textColor}`},s,r??null)}function Cc(){const i=U(),e=_e({text:"Select Instrument",size:"xl",additionalClasses:"text-center mb-6 z-10"}),t=(f,h)=>{const m=y("select",{id:f,class:["w-full bg-gray-700 border border-gray-600 rounded px-3 py-2","focus:outline-none focus:border-purple-500 cursor-pointer",i.textColor].join(" ")});return y("div",{class:"mb-4 z-10 w-full"},X({text:h,for:f}),m)},s=t("instrument-engine-select","Engine"),n=t("instrument-library-select","Instrument Library"),r=t("instrument-select","Instrument"),a=Le({id:"instrument-loop-toggle",label:"Loop instrument sound",stateB:"On"}),o=z({id:"instrument-select-confirm",text:"Select",kind:"primary",additionalClasses:"flex-1 py-2 text-sm rounded-lg"}),l=z({id:"instrument-cancel-btn",text:"Cancel",kind:"secondary",additionalClasses:"flex-1 py-2 text-sm rounded-lg"}),d=y("div",{class:"flex gap-3 z-10 w-full"},o,l),c=[e,s,n,r,a.element,d];return he("instrument-select-modal",c,{sizePreset:"md"})}function Nc(i,e){const t=structuredClone(i),s=t.sequencers.find(n=>n.id===e.sequencerId);return s&&e.instrument&&(s.instrument=e.instrument),t}function wc(i,e){return{type:"SET_INSTRUMENT",sequencerId:i,instrument:e}}function Mc(i,e){return{type:"SET_INSTRUMENT",sequencerId:i,instrument:e}}async function xc(i,e){if(e!=null){const t=Ye(e);t?(O(wc(t.id,i),Mc(t.id,t.instrumentName)),t.setInstrument(i)):console.warn(`Failed to find sequencer with ID ${e}`)}else try{await Ki(i),uo(i),window.dispatchEvent(new CustomEvent("global-instrument-selected",{detail:{fullName:i}}))}catch(t){console.error("Failed to load global instrument:",i,t)}}function Lc(){return Object.keys(vt)}async function kc(i=Dr){const e=zi[i];if(!e)throw new Error(`Engine "${i}" not available`);return await e.getAvailableLibraries()}async function Ac(i,e=Dr){const t=zi[e];if(!t)throw new Error(`Engine "${e}" not available`);return await t.getAvailableInstruments(i)}function Bc(i,e){const t=i.querySelector("#instrument-engine-select"),s=i.querySelector("#instrument-library-select"),n=i.querySelector("#instrument-select"),r=i.querySelector("#instrument-loop-toggle"),a=i.querySelector("#instrument-select-confirm"),o=i.querySelector("#instrument-cancel-btn"),{currentInstrument:l}=e;let d=null,c=null,u=null;if(l){const S=l.split("/");d=S[0]||null,c=S[1]||null,u=S[2]||null}const f=()=>{const S=Lc();t&&(t.innerHTML="",S.forEach(v=>{const C=document.createElement("option");C.value=v,C.textContent=v,t.appendChild(C)}),d&&S.includes(d)&&(t.value=d))},h=async()=>{if(!t)return;const S=await kc(t.value);s&&(s.innerHTML="",S.forEach(v=>{const C=document.createElement("option");C.value=v,C.textContent=v,s.appendChild(C)}),c&&S.includes(c)?s.value=c:S.length>0&&(s.value=S[0]))},m=async()=>{if(!t||!s)return;const S=await Ac(s.value,t.value);n&&(n.innerHTML="",S.forEach(v=>{const C=document.createElement("option");C.value=v,C.textContent=v,n.appendChild(C)}),u&&S.includes(u)&&(n.value=u))},b=async()=>{await h(),await m()},g=()=>{m()},p=async()=>{if(!t||!s||!n||!r)return;const S=`${t.value}/${s.value}/${n.value}`;await xc(S,e.sequencerId),e.hide()},_=()=>{e.hide()};return(async()=>(f(),await h(),await m()))(),t==null||t.addEventListener("change",b),s==null||s.addEventListener("change",g),a==null||a.addEventListener("click",p),o==null||o.addEventListener("click",_),{detach:()=>{t==null||t.removeEventListener("change",b),s==null||s.removeEventListener("change",g),a==null||a.removeEventListener("click",p),o==null||o.removeEventListener("click",_)},refreshUI:async()=>{f(),await h(),await m()}}}class Gc{constructor(){this.detachFn=null,this.modal=Cc(),document.body.appendChild(this.modal)}show(e,t){var n;(n=this.detachFn)==null||n.call(this);const s=Bc(this.modal,{sequencerId:e,currentInstrument:t,hide:()=>this.hide()});this.detachFn=s.detach,this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}class Ec{constructor(){this.initialize()}initialize(){this.deleteConfirmModal=new Sc,this.instrumentSelectModal=new Gc}showInstrumentSelectModal(e,t){this.instrumentSelectModal.show(e,t)}showDeleteConfirmModal(e,t){this.deleteConfirmModal.show(e,t)}destroy(){var e,t;(e=this.deleteConfirmModal)==null||e.destroy(),(t=this.instrumentSelectModal)==null||t.destroy()}reload(){this.destroy(),this.initialize()}}let ui=null;function Vt(){return ui||(ui=new Ec),ui}function Tc(i,e){const t=()=>{Vt().showInstrumentSelectModal(e.id,e.instrumentName)};return i.addEventListener("click",t),{detach:()=>{i.removeEventListener("click",t)},refreshUI:()=>{}}}function Ic(i){if(Object.prototype.hasOwnProperty.call(i,"__esModule"))return i;var e=i.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(s){var n=Object.getOwnPropertyDescriptor(i,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return i[s]}})}),t}var Be={},Gt={},hi,Ns;function Rc(){if(Ns)return hi;Ns=1;function i(n){var r=new s(n),a=r.readChunk();if(a.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+a.id+"'";for(var o=e(a.data),l=[],d=0;!r.eof()&&d<o.numTracks;d++){var c=r.readChunk();if(c.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+c.id+"'";var u=t(c.data);l.push(u)}return{header:o,tracks:l}}function e(n){var r=new s(n),a=r.readUInt16(),o=r.readUInt16(),l={format:a,numTracks:o},d=r.readUInt16();return d&32768?(l.framesPerSecond=256-(d>>8),l.ticksPerFrame=d&255):l.ticksPerBeat=d,l}function t(n){for(var r=new s(n),a=[];!r.eof();){var o=d();a.push(o)}return a;var l;function d(){var c={};c.deltaTime=r.readVarInt();var u=r.readUInt8();if((u&240)===240)if(u===255){c.meta=!0;var f=r.readUInt8(),h=r.readVarInt();switch(f){case 0:if(c.type="sequenceNumber",h!==2)throw"Expected length for sequenceNumber event is 2, got "+h;return c.number=r.readUInt16(),c;case 1:return c.type="text",c.text=r.readString(h),c;case 2:return c.type="copyrightNotice",c.text=r.readString(h),c;case 3:return c.type="trackName",c.text=r.readString(h),c;case 4:return c.type="instrumentName",c.text=r.readString(h),c;case 5:return c.type="lyrics",c.text=r.readString(h),c;case 6:return c.type="marker",c.text=r.readString(h),c;case 7:return c.type="cuePoint",c.text=r.readString(h),c;case 32:if(c.type="channelPrefix",h!=1)throw"Expected length for channelPrefix event is 1, got "+h;return c.channel=r.readUInt8(),c;case 33:if(c.type="portPrefix",h!=1)throw"Expected length for portPrefix event is 1, got "+h;return c.port=r.readUInt8(),c;case 47:if(c.type="endOfTrack",h!=0)throw"Expected length for endOfTrack event is 0, got "+h;return c;case 81:if(c.type="setTempo",h!=3)throw"Expected length for setTempo event is 3, got "+h;return c.microsecondsPerBeat=r.readUInt24(),c;case 84:if(c.type="smpteOffset",h!=5)throw"Expected length for smpteOffset event is 5, got "+h;var m=r.readUInt8(),b={0:24,32:25,64:29,96:30};return c.frameRate=b[m&96],c.hour=m&31,c.min=r.readUInt8(),c.sec=r.readUInt8(),c.frame=r.readUInt8(),c.subFrame=r.readUInt8(),c;case 88:if(c.type="timeSignature",h!=2&&h!=4)throw"Expected length for timeSignature event is 4 or 2, got "+h;return c.numerator=r.readUInt8(),c.denominator=1<<r.readUInt8(),h===4?(c.metronome=r.readUInt8(),c.thirtyseconds=r.readUInt8()):(c.metronome=36,c.thirtyseconds=8),c;case 89:if(c.type="keySignature",h!=2)throw"Expected length for keySignature event is 2, got "+h;return c.key=r.readInt8(),c.scale=r.readUInt8(),c;case 127:return c.type="sequencerSpecific",c.data=r.readBytes(h),c;default:return c.type="unknownMeta",c.data=r.readBytes(h),c.metatypeByte=f,c}}else if(u==240){c.type="sysEx";var h=r.readVarInt();return c.data=r.readBytes(h),c}else if(u==247){c.type="endSysEx";var h=r.readVarInt();return c.data=r.readBytes(h),c}else throw"Unrecognised MIDI event type byte: "+u;else{var g;if((u&128)===0){if(l===null)throw"Running status byte encountered before status byte";g=u,u=l,c.running=!0}else g=r.readUInt8(),l=u;var p=u>>4;switch(c.channel=u&15,p){case 8:return c.type="noteOff",c.noteNumber=g,c.velocity=r.readUInt8(),c;case 9:var _=r.readUInt8();return c.type=_===0?"noteOff":"noteOn",c.noteNumber=g,c.velocity=_,_===0&&(c.byte9=!0),c;case 10:return c.type="noteAftertouch",c.noteNumber=g,c.amount=r.readUInt8(),c;case 11:return c.type="controller",c.controllerType=g,c.value=r.readUInt8(),c;case 12:return c.type="programChange",c.programNumber=g,c;case 13:return c.type="channelAftertouch",c.amount=g,c;case 14:return c.type="pitchBend",c.value=g+(r.readUInt8()<<7)-8192,c;default:throw"Unrecognised MIDI event type: "+p}}}}function s(n){this.buffer=n,this.bufferLen=this.buffer.length,this.pos=0}return s.prototype.eof=function(){return this.pos>=this.bufferLen},s.prototype.readUInt8=function(){var n=this.buffer[this.pos];return this.pos+=1,n},s.prototype.readInt8=function(){var n=this.readUInt8();return n&128?n-256:n},s.prototype.readUInt16=function(){var n=this.readUInt8(),r=this.readUInt8();return(n<<8)+r},s.prototype.readInt16=function(){var n=this.readUInt16();return n&32768?n-65536:n},s.prototype.readUInt24=function(){var n=this.readUInt8(),r=this.readUInt8(),a=this.readUInt8();return(n<<16)+(r<<8)+a},s.prototype.readInt24=function(){var n=this.readUInt24();return n&8388608?n-16777216:n},s.prototype.readUInt32=function(){var n=this.readUInt8(),r=this.readUInt8(),a=this.readUInt8(),o=this.readUInt8();return(n<<24)+(r<<16)+(a<<8)+o},s.prototype.readBytes=function(n){var r=this.buffer.slice(this.pos,this.pos+n);return this.pos+=n,r},s.prototype.readString=function(n){var r=this.readBytes(n);return String.fromCharCode.apply(null,r)},s.prototype.readVarInt=function(){for(var n=0;!this.eof();){var r=this.readUInt8();if(r&128)n+=r&127,n<<=7;else return n+r}return n},s.prototype.readChunk=function(){var n=this.readString(4),r=this.readUInt32(),a=this.readBytes(r);return{id:n,length:r,data:a}},hi=i,hi}var fi,ws;function Pc(){if(ws)return fi;ws=1;function i(r,a){if(typeof r!="object")throw"Invalid MIDI data";a=a||{};var o=r.header||{},l=r.tracks||[],d,c=l.length,u=new n;for(e(u,o,c),d=0;d<c;d++)t(u,l[d],a);return u.buffer}function e(r,a,o){var l=a.format==null?1:a.format,d=128;a.timeDivision?d=a.timeDivision:a.ticksPerFrame&&a.framesPerSecond?d=-(a.framesPerSecond&255)<<8|a.ticksPerFrame&255:a.ticksPerBeat&&(d=a.ticksPerBeat&32767);var c=new n;c.writeUInt16(l),c.writeUInt16(o),c.writeUInt16(d),r.writeChunk("MThd",c.buffer)}function t(r,a,o){var l=new n,d,c=a.length,u=null;for(d=0;d<c;d++)(o.running===!1||!o.running&&!a[d].running)&&(u=null),u=s(l,a[d],u,o.useByte9ForNoteOff);r.writeChunk("MTrk",l.buffer)}function s(r,a,o,l){var d=a.type,c=a.deltaTime,u=a.text||"",f=a.data||[],h=null;switch(r.writeVarInt(c),d){case"sequenceNumber":r.writeUInt8(255),r.writeUInt8(0),r.writeVarInt(2),r.writeUInt16(a.number);break;case"text":r.writeUInt8(255),r.writeUInt8(1),r.writeVarInt(u.length),r.writeString(u);break;case"copyrightNotice":r.writeUInt8(255),r.writeUInt8(2),r.writeVarInt(u.length),r.writeString(u);break;case"trackName":r.writeUInt8(255),r.writeUInt8(3),r.writeVarInt(u.length),r.writeString(u);break;case"instrumentName":r.writeUInt8(255),r.writeUInt8(4),r.writeVarInt(u.length),r.writeString(u);break;case"lyrics":r.writeUInt8(255),r.writeUInt8(5),r.writeVarInt(u.length),r.writeString(u);break;case"marker":r.writeUInt8(255),r.writeUInt8(6),r.writeVarInt(u.length),r.writeString(u);break;case"cuePoint":r.writeUInt8(255),r.writeUInt8(7),r.writeVarInt(u.length),r.writeString(u);break;case"channelPrefix":r.writeUInt8(255),r.writeUInt8(32),r.writeVarInt(1),r.writeUInt8(a.channel);break;case"portPrefix":r.writeUInt8(255),r.writeUInt8(33),r.writeVarInt(1),r.writeUInt8(a.port);break;case"endOfTrack":r.writeUInt8(255),r.writeUInt8(47),r.writeVarInt(0);break;case"setTempo":r.writeUInt8(255),r.writeUInt8(81),r.writeVarInt(3),r.writeUInt24(a.microsecondsPerBeat);break;case"smpteOffset":r.writeUInt8(255),r.writeUInt8(84),r.writeVarInt(5);var m={24:0,25:32,29:64,30:96},b=a.hour&31|m[a.frameRate];r.writeUInt8(b),r.writeUInt8(a.min),r.writeUInt8(a.sec),r.writeUInt8(a.frame),r.writeUInt8(a.subFrame);break;case"timeSignature":r.writeUInt8(255),r.writeUInt8(88),r.writeVarInt(4),r.writeUInt8(a.numerator);var g=Math.floor(Math.log(a.denominator)/Math.LN2)&255;r.writeUInt8(g),r.writeUInt8(a.metronome),r.writeUInt8(a.thirtyseconds||8);break;case"keySignature":r.writeUInt8(255),r.writeUInt8(89),r.writeVarInt(2),r.writeInt8(a.key),r.writeUInt8(a.scale);break;case"sequencerSpecific":r.writeUInt8(255),r.writeUInt8(127),r.writeVarInt(f.length),r.writeBytes(f);break;case"unknownMeta":a.metatypeByte!=null&&(r.writeUInt8(255),r.writeUInt8(a.metatypeByte),r.writeVarInt(f.length),r.writeBytes(f));break;case"sysEx":r.writeUInt8(240),r.writeVarInt(f.length),r.writeBytes(f);break;case"endSysEx":r.writeUInt8(247),r.writeVarInt(f.length),r.writeBytes(f);break;case"noteOff":var p=l!==!1&&a.byte9||l&&a.velocity==0?144:128;h=p|a.channel,h!==o&&r.writeUInt8(h),r.writeUInt8(a.noteNumber),r.writeUInt8(a.velocity);break;case"noteOn":h=144|a.channel,h!==o&&r.writeUInt8(h),r.writeUInt8(a.noteNumber),r.writeUInt8(a.velocity);break;case"noteAftertouch":h=160|a.channel,h!==o&&r.writeUInt8(h),r.writeUInt8(a.noteNumber),r.writeUInt8(a.amount);break;case"controller":h=176|a.channel,h!==o&&r.writeUInt8(h),r.writeUInt8(a.controllerType),r.writeUInt8(a.value);break;case"programChange":h=192|a.channel,h!==o&&r.writeUInt8(h),r.writeUInt8(a.programNumber);break;case"channelAftertouch":h=208|a.channel,h!==o&&r.writeUInt8(h),r.writeUInt8(a.amount);break;case"pitchBend":h=224|a.channel,h!==o&&r.writeUInt8(h);var _=8192+a.value,S=_&127,v=_>>7&127;r.writeUInt8(S),r.writeUInt8(v);break;default:throw"Unrecognized event type: "+d}return h}function n(){this.buffer=[]}return n.prototype.writeUInt8=function(r){this.buffer.push(r&255)},n.prototype.writeInt8=n.prototype.writeUInt8,n.prototype.writeUInt16=function(r){var a=r>>8&255,o=r&255;this.writeUInt8(a),this.writeUInt8(o)},n.prototype.writeInt16=n.prototype.writeUInt16,n.prototype.writeUInt24=function(r){var a=r>>16&255,o=r>>8&255,l=r&255;this.writeUInt8(a),this.writeUInt8(o),this.writeUInt8(l)},n.prototype.writeInt24=n.prototype.writeUInt24,n.prototype.writeUInt32=function(r){var a=r>>24&255,o=r>>16&255,l=r>>8&255,d=r&255;this.writeUInt8(a),this.writeUInt8(o),this.writeUInt8(l),this.writeUInt8(d)},n.prototype.writeInt32=n.prototype.writeUInt32,n.prototype.writeBytes=function(r){this.buffer=this.buffer.concat(Array.prototype.slice.call(r,0))},n.prototype.writeString=function(r){var a,o=r.length,l=[];for(a=0;a<o;a++)l.push(r.codePointAt(a));this.writeBytes(l)},n.prototype.writeVarInt=function(r){if(r<0)throw"Cannot write negative variable-length integer";if(r<=127)this.writeUInt8(r);else{var a=r,o=[];for(o.push(a&127),a>>=7;a;){var l=a&127|128;o.push(l),a>>=7}this.writeBytes(o.reverse())}},n.prototype.writeChunk=function(r,a){this.writeString(r),this.writeUInt32(a.length),this.writeBytes(a)},fi=i,fi}var Ms;function sn(){return Ms||(Ms=1,Gt.parseMidi=Rc(),Gt.writeMidi=Pc()),Gt}var pi={},Ge={},xs;function rn(){if(xs)return Ge;xs=1,Object.defineProperty(Ge,"__esModule",{value:!0}),Ge.insert=Ge.search=void 0;function i(t,s,n){n===void 0&&(n="ticks");var r=0,a=t.length,o=a;if(a>0&&t[a-1][n]<=s)return a-1;for(;r<o;){var l=Math.floor(r+(o-r)/2),d=t[l],c=t[l+1];if(d[n]===s){for(var u=l;u<t.length;u++){var f=t[u];f[n]===s&&(l=u)}return l}else{if(d[n]<s&&c[n]>s)return l;d[n]>s?o=l:d[n]<s&&(r=l+1)}}return-1}Ge.search=i;function e(t,s,n){if(n===void 0&&(n="ticks"),t.length){var r=i(t,s[n],n);t.splice(r+1,0,s)}else t.push(s)}return Ge.insert=e,Ge}var Ls;function Ai(){return Ls||(Ls=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.Header=i.keySignatureKeys=void 0;var e=rn(),t=new WeakMap;i.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var s=function(){function n(r){var a=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",t.set(this,480),r){t.set(this,r.header.ticksPerBeat),r.tracks.forEach(function(l){l.forEach(function(d){d.meta&&(d.type==="timeSignature"?a.timeSignatures.push({ticks:d.absoluteTime,timeSignature:[d.numerator,d.denominator]}):d.type==="setTempo"?a.tempos.push({bpm:6e7/d.microsecondsPerBeat,ticks:d.absoluteTime}):d.type==="keySignature"&&a.keySignatures.push({key:i.keySignatureKeys[d.key+7],scale:d.scale===0?"major":"minor",ticks:d.absoluteTime}))})});var o=0;r.tracks[0].forEach(function(l){o+=l.deltaTime,l.meta&&(l.type==="trackName"?a.name=l.text:(l.type==="text"||l.type==="cuePoint"||l.type==="marker"||l.type==="lyrics")&&a.meta.push({text:l.text,ticks:o,type:l.type}))}),this.update()}}return n.prototype.update=function(){var r=this,a=0,o=0;this.tempos.sort(function(l,d){return l.ticks-d.ticks}),this.tempos.forEach(function(l,d){var c=d>0?r.tempos[d-1].bpm:r.tempos[0].bpm,u=l.ticks/r.ppq-o,f=60/c*u;l.time=f+a,a=l.time,o+=u}),this.timeSignatures.sort(function(l,d){return l.ticks-d.ticks}),this.timeSignatures.forEach(function(l,d){var c=d>0?r.timeSignatures[d-1]:r.timeSignatures[0],u=(l.ticks-c.ticks)/r.ppq,f=u/c.timeSignature[0]/(c.timeSignature[1]/4);c.measures=c.measures||0,l.measures=f+c.measures})},n.prototype.ticksToSeconds=function(r){var a=(0,e.search)(this.tempos,r);if(a!==-1){var o=this.tempos[a],l=o.time,d=(r-o.ticks)/this.ppq;return l+60/o.bpm*d}else{var c=r/this.ppq;return 60/120*c}},n.prototype.ticksToMeasures=function(r){var a=(0,e.search)(this.timeSignatures,r);if(a!==-1){var o=this.timeSignatures[a],l=(r-o.ticks)/this.ppq;return o.measures+l/(o.timeSignature[0]/o.timeSignature[1])/4}else return r/this.ppq/4},Object.defineProperty(n.prototype,"ppq",{get:function(){return t.get(this)},enumerable:!1,configurable:!0}),n.prototype.secondsToTicks=function(r){var a=(0,e.search)(this.tempos,r,"time");if(a!==-1){var o=this.tempos[a],l=o.time,d=r-l,c=d/(60/o.bpm);return Math.round(o.ticks+c*this.ppq)}else{var u=r/.5;return Math.round(u*this.ppq)}},n.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(r){return{bpm:r.bpm,ticks:r.ticks}}),timeSignatures:this.timeSignatures}},n.prototype.fromJSON=function(r){this.name=r.name,this.tempos=r.tempos.map(function(a){return Object.assign({},a)}),this.timeSignatures=r.timeSignatures.map(function(a){return Object.assign({},a)}),this.keySignatures=r.keySignatures.map(function(a){return Object.assign({},a)}),this.meta=r.meta.map(function(a){return Object.assign({},a)}),t.set(this,r.ppq),this.update()},n.prototype.setTempo=function(r){this.tempos=[{bpm:r,ticks:0}],this.update()},n}();i.Header=s}(pi)),pi}var st={},mi={},ks;function nn(){return ks||(ks=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ControlChange=i.controlChangeIds=i.controlChangeNames=void 0,i.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},i.controlChangeIds=Object.keys(i.controlChangeNames).reduce(function(n,r){return n[i.controlChangeNames[r]]=r,n},{});var e=new WeakMap,t=new WeakMap,s=function(){function n(r,a){e.set(this,a),t.set(this,r.controllerType),this.ticks=r.absoluteTime,this.value=r.value}return Object.defineProperty(n.prototype,"number",{get:function(){return t.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return i.controlChangeNames[this.number]?i.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"time",{get:function(){var r=e.get(this);return r.ticksToSeconds(this.ticks)},set:function(r){var a=e.get(this);this.ticks=a.secondsToTicks(r)},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},n}();i.ControlChange=s}(mi)),mi}var rt={},As;function Oc(){if(As)return rt;As=1,Object.defineProperty(rt,"__esModule",{value:!0}),rt.createControlChanges=void 0;var i=nn();function e(){return new Proxy({},{get:function(t,s){if(t[s])return t[s];if(i.controlChangeIds.hasOwnProperty(s))return t[i.controlChangeIds[s]]},set:function(t,s,n){return i.controlChangeIds.hasOwnProperty(s)?t[i.controlChangeIds[s]]=n:t[s]=n,!0}})}return rt.createControlChanges=e,rt}var nt={},Bs;function Fc(){if(Bs)return nt;Bs=1,Object.defineProperty(nt,"__esModule",{value:!0}),nt.PitchBend=void 0;var i=new WeakMap,e=function(){function t(s,n){i.set(this,n),this.ticks=s.absoluteTime,this.value=s.value}return Object.defineProperty(t.prototype,"time",{get:function(){var s=i.get(this);return s.ticksToSeconds(this.ticks)},set:function(s){var n=i.get(this);this.ticks=n.secondsToTicks(s)},enumerable:!1,configurable:!0}),t.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},t}();return nt.PitchBend=e,nt}var at={},Se={},Gs;function Dc(){return Gs||(Gs=1,Object.defineProperty(Se,"__esModule",{value:!0}),Se.DrumKitByPatchID=Se.InstrumentFamilyByID=Se.instrumentByPatchID=void 0,Se.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],Se.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],Se.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),Se}var Es;function Uc(){if(Es)return at;Es=1,Object.defineProperty(at,"__esModule",{value:!0}),at.Instrument=void 0;var i=Dc(),e=new WeakMap,t=function(){function s(n,r){if(this.number=0,e.set(this,r),this.number=0,n){var a=n.find(function(o){return o.type==="programChange"});a&&(this.number=a.programNumber)}}return Object.defineProperty(s.prototype,"name",{get:function(){return this.percussion?i.DrumKitByPatchID[this.number]:i.instrumentByPatchID[this.number]},set:function(n){var r=i.instrumentByPatchID.indexOf(n);r!==-1&&(this.number=r)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"family",{get:function(){return this.percussion?"drums":i.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"percussion",{get:function(){var n=e.get(this);return n.channel===9},enumerable:!1,configurable:!0}),s.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},s.prototype.fromJSON=function(n){this.number=n.number},s}();return at.Instrument=t,at}var ot={},Ts;function qc(){if(Ts)return ot;Ts=1,Object.defineProperty(ot,"__esModule",{value:!0}),ot.Note=void 0;function i(a){var o=Math.floor(a/12)-1;return e(a)+o.toString()}function e(a){var o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],l=a%12;return o[l]}function t(a){var o=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return o.indexOf(a)}var s=function(){var a=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,o={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(l){var d=a.exec(l),c=d[1],u=d[2],f=o[c.toLowerCase()];return f+(parseInt(u,10)+1)*12}}(),n=new WeakMap,r=function(){function a(o,l,d){n.set(this,d),this.midi=o.midi,this.velocity=o.velocity,this.noteOffVelocity=l.velocity,this.ticks=o.ticks,this.durationTicks=l.ticks-o.ticks}return Object.defineProperty(a.prototype,"name",{get:function(){return i(this.midi)},set:function(o){this.midi=s(o)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(o){var l=o-this.octave;this.midi+=l*12},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"pitch",{get:function(){return e(this.midi)},set:function(o){this.midi=12*(this.octave+1)+t(o)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"duration",{get:function(){var o=n.get(this);return o.ticksToSeconds(this.ticks+this.durationTicks)-o.ticksToSeconds(this.ticks)},set:function(o){var l=n.get(this),d=l.secondsToTicks(this.time+o);this.durationTicks=d-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"time",{get:function(){var o=n.get(this);return o.ticksToSeconds(this.ticks)},set:function(o){var l=n.get(this);this.ticks=l.secondsToTicks(o)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"bars",{get:function(){var o=n.get(this);return o.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),a.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},a}();return ot.Note=r,ot}var Is;function Rs(){if(Is)return st;Is=1,Object.defineProperty(st,"__esModule",{value:!0}),st.Track=void 0;var i=rn(),e=nn(),t=Oc(),s=Fc(),n=Uc(),r=qc(),a=new WeakMap,o=function(){function l(d,c){var u=this;if(this.name="",this.notes=[],this.controlChanges=(0,t.createControlChanges)(),this.pitchBends=[],a.set(this,c),d){var f=d.find(function(v){return v.type==="trackName"});this.name=f?f.text:""}if(this.instrument=new n.Instrument(d,this),this.channel=0,d){for(var h=d.filter(function(v){return v.type==="noteOn"}),m=d.filter(function(v){return v.type==="noteOff"}),b=function(){var v=h.shift();g.channel=v.channel;var C=m.findIndex(function(w){return w.noteNumber===v.noteNumber&&w.absoluteTime>=v.absoluteTime});if(C!==-1){var N=m.splice(C,1)[0];g.addNote({durationTicks:N.absoluteTime-v.absoluteTime,midi:v.noteNumber,noteOffVelocity:N.velocity/127,ticks:v.absoluteTime,velocity:v.velocity/127})}},g=this;h.length;)b();var p=d.filter(function(v){return v.type==="controller"});p.forEach(function(v){u.addCC({number:v.controllerType,ticks:v.absoluteTime,value:v.value/127})});var _=d.filter(function(v){return v.type==="pitchBend"});_.forEach(function(v){u.addPitchBend({ticks:v.absoluteTime,value:v.value/Math.pow(2,13)})});var S=d.find(function(v){return v.type==="endOfTrack"});this.endOfTrackTicks=S!==void 0?S.absoluteTime:void 0}}return l.prototype.addNote=function(d){var c=a.get(this),u=new r.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},c);return Object.assign(u,d),(0,i.insert)(this.notes,u,"ticks"),this},l.prototype.addCC=function(d){var c=a.get(this),u=new e.ControlChange({controllerType:d.number},c);return delete d.number,Object.assign(u,d),Array.isArray(this.controlChanges[u.number])||(this.controlChanges[u.number]=[]),(0,i.insert)(this.controlChanges[u.number],u,"ticks"),this},l.prototype.addPitchBend=function(d){var c=a.get(this),u=new s.PitchBend({},c);return Object.assign(u,d),(0,i.insert)(this.pitchBends,u,"ticks"),this},Object.defineProperty(l.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var d=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,c=0;c<this.notes.length-1;c++){var u=this.notes[c].time+this.notes[c].duration;d<u&&(d=u)}return d},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var d=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,c=0;c<this.notes.length-1;c++){var u=this.notes[c].ticks+this.notes[c].durationTicks;d<u&&(d=u)}return d},enumerable:!1,configurable:!0}),l.prototype.fromJSON=function(d){var c=this;this.name=d.name,this.channel=d.channel,this.instrument=new n.Instrument(void 0,this),this.instrument.fromJSON(d.instrument),d.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=d.endOfTrackTicks);for(var u in d.controlChanges)d.controlChanges[u]&&d.controlChanges[u].forEach(function(f){c.addCC({number:f.number,ticks:f.ticks,value:f.value})});d.notes.forEach(function(f){c.addNote({durationTicks:f.durationTicks,midi:f.midi,ticks:f.ticks,velocity:f.velocity})})},l.prototype.toJSON=function(){for(var d={},c=0;c<127;c++)this.controlChanges.hasOwnProperty(c)&&(d[c]=this.controlChanges[c].map(function(f){return f.toJSON()}));var u={channel:this.channel,controlChanges:d,pitchBends:this.pitchBends.map(function(f){return f.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(f){return f.toJSON()})};return this.endOfTrackTicks!==void 0&&(u.endOfTrackTicks=this.endOfTrackTicks),u},l}();return st.Track=o,st}var Ee={};function Kc(i){var e=[];return an(i,e),e}function an(i,e){for(var t=0;t<i.length;t++){var s=i[t];Array.isArray(s)?an(s,e):e.push(s)}}const $c=Object.freeze(Object.defineProperty({__proto__:null,flatten:Kc},Symbol.toStringTag,{value:"Module"})),zc=Ic($c);var Ps;function Hc(){if(Ps)return Ee;Ps=1;var i=Ee&&Ee.__spreadArray||function(p,_,S){if(S||arguments.length===2)for(var v=0,C=_.length,N;v<C;v++)(N||!(v in _))&&(N||(N=Array.prototype.slice.call(_,0,v)),N[v]=_[v]);return p.concat(N||Array.prototype.slice.call(_))};Object.defineProperty(Ee,"__esModule",{value:!0}),Ee.encode=void 0;var e=sn(),t=Ai(),s=zc;function n(p,_){return[{absoluteTime:p.ticks,channel:_,deltaTime:0,noteNumber:p.midi,type:"noteOn",velocity:Math.floor(p.velocity*127)},{absoluteTime:p.ticks+p.durationTicks,channel:_,deltaTime:0,noteNumber:p.midi,type:"noteOff",velocity:Math.floor(p.noteOffVelocity*127)}]}function r(p){return(0,s.flatten)(p.notes.map(function(_){return n(_,p.channel)}))}function a(p,_){return{absoluteTime:p.ticks,channel:_,controllerType:p.number,deltaTime:0,type:"controller",value:Math.floor(p.value*127)}}function o(p){for(var _=[],S=0;S<127;S++)p.controlChanges.hasOwnProperty(S)&&p.controlChanges[S].forEach(function(v){_.push(a(v,p.channel))});return _}function l(p,_){return{absoluteTime:p.ticks,channel:_,deltaTime:0,type:"pitchBend",value:p.value}}function d(p){var _=[];return p.pitchBends.forEach(function(S){_.push(l(S,p.channel))}),_}function c(p){return{absoluteTime:0,channel:p.channel,deltaTime:0,programNumber:p.instrument.number,type:"programChange"}}function u(p){return{absoluteTime:0,deltaTime:0,meta:!0,text:p,type:"trackName"}}function f(p){return{absoluteTime:p.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/p.bpm),type:"setTempo"}}function h(p){return{absoluteTime:p.ticks,deltaTime:0,denominator:p.timeSignature[1],meta:!0,metronome:24,numerator:p.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function m(p){var _=t.keySignatureKeys.indexOf(p.key);return{absoluteTime:p.ticks,deltaTime:0,key:_+7,meta:!0,scale:p.scale==="major"?0:1,type:"keySignature"}}function b(p){return{absoluteTime:p.ticks,deltaTime:0,meta:!0,text:p.text,type:p.type}}function g(p){var _={header:{format:1,numTracks:p.tracks.length+1,ticksPerBeat:p.header.ppq},tracks:i([i(i(i(i([{absoluteTime:0,deltaTime:0,meta:!0,text:p.header.name,type:"trackName"}],p.header.keySignatures.map(function(S){return m(S)}),!0),p.header.meta.map(function(S){return b(S)}),!0),p.header.tempos.map(function(S){return f(S)}),!0),p.header.timeSignatures.map(function(S){return h(S)}),!0)],p.tracks.map(function(S){return i(i(i([u(S.name),c(S)],r(S),!0),o(S),!0),d(S),!0)}),!0)};return _.tracks=_.tracks.map(function(S){S=S.sort(function(C,N){return C.absoluteTime-N.absoluteTime});var v=0;return S.forEach(function(C){C.deltaTime=C.absoluteTime-v,v=C.absoluteTime,delete C.absoluteTime}),S.push({deltaTime:0,meta:!0,type:"endOfTrack"}),S}),new Uint8Array((0,e.writeMidi)(_))}return Ee.encode=g,Ee}var Os;function Jc(){return Os||(Os=1,function(i){var e=Be&&Be.__awaiter||function(u,f,h,m){function b(g){return g instanceof h?g:new h(function(p){p(g)})}return new(h||(h=Promise))(function(g,p){function _(C){try{v(m.next(C))}catch(N){p(N)}}function S(C){try{v(m.throw(C))}catch(N){p(N)}}function v(C){C.done?g(C.value):b(C.value).then(_,S)}v((m=m.apply(u,f||[])).next())})},t=Be&&Be.__generator||function(u,f){var h={label:0,sent:function(){if(g[0]&1)throw g[1];return g[1]},trys:[],ops:[]},m,b,g,p;return p={next:_(0),throw:_(1),return:_(2)},typeof Symbol=="function"&&(p[Symbol.iterator]=function(){return this}),p;function _(v){return function(C){return S([v,C])}}function S(v){if(m)throw new TypeError("Generator is already executing.");for(;h;)try{if(m=1,b&&(g=v[0]&2?b.return:v[0]?b.throw||((g=b.return)&&g.call(b),0):b.next)&&!(g=g.call(b,v[1])).done)return g;switch(b=0,g&&(v=[v[0]&2,g.value]),v[0]){case 0:case 1:g=v;break;case 4:return h.label++,{value:v[1],done:!1};case 5:h.label++,b=v[1],v=[0];continue;case 7:v=h.ops.pop(),h.trys.pop();continue;default:if(g=h.trys,!(g=g.length>0&&g[g.length-1])&&(v[0]===6||v[0]===2)){h=0;continue}if(v[0]===3&&(!g||v[1]>g[0]&&v[1]<g[3])){h.label=v[1];break}if(v[0]===6&&h.label<g[1]){h.label=g[1],g=v;break}if(g&&h.label<g[2]){h.label=g[2],h.ops.push(v);break}g[2]&&h.ops.pop(),h.trys.pop();continue}v=f.call(u,h)}catch(C){v=[6,C],b=0}finally{m=g=0}if(v[0]&5)throw v[1];return{value:v[0]?v[1]:void 0,done:!0}}};Object.defineProperty(i,"__esModule",{value:!0}),i.Header=i.Track=i.Midi=void 0;var s=sn(),n=Ai(),r=Rs(),a=Hc(),o=function(){function u(f){var h=this,m=null;if(f){var b=f instanceof ArrayBuffer?new Uint8Array(f):f;m=(0,s.parseMidi)(b),m.tracks.forEach(function(g){var p=0;g.forEach(function(_){p+=_.deltaTime,_.absoluteTime=p})}),m.tracks=c(m.tracks)}this.header=new n.Header(m),this.tracks=[],f&&(this.tracks=m.tracks.map(function(g){return new r.Track(g,h.header)}),m.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return u.fromUrl=function(f){return e(this,void 0,void 0,function(){var h,m;return t(this,function(b){switch(b.label){case 0:return[4,fetch(f)];case 1:return h=b.sent(),h.ok?[4,h.arrayBuffer()]:[3,3];case 2:return m=b.sent(),[2,new u(m)];case 3:throw new Error("Could not load '".concat(f,"'"))}})})},Object.defineProperty(u.prototype,"name",{get:function(){return this.header.name},set:function(f){this.header.name=f},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"duration",{get:function(){var f=this.tracks.map(function(h){return h.duration});return Math.max.apply(Math,f)},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"durationTicks",{get:function(){var f=this.tracks.map(function(h){return h.durationTicks});return Math.max.apply(Math,f)},enumerable:!1,configurable:!0}),u.prototype.addTrack=function(){var f=new r.Track(void 0,this.header);return this.tracks.push(f),f},u.prototype.toArray=function(){return(0,a.encode)(this)},u.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(f){return f.toJSON()})}},u.prototype.fromJSON=function(f){var h=this;this.header=new n.Header,this.header.fromJSON(f.header),this.tracks=f.tracks.map(function(m){var b=new r.Track(void 0,h.header);return b.fromJSON(m),b})},u.prototype.clone=function(){var f=new u;return f.fromJSON(this.toJSON()),f},u}();i.Midi=o;var l=Rs();Object.defineProperty(i,"Track",{enumerable:!0,get:function(){return l.Track}});var d=Ai();Object.defineProperty(i,"Header",{enumerable:!0,get:function(){return d.Header}});function c(u){for(var f=[],h=0;h<u.length;h++)for(var m=f.length,b=new Map,g=Array(16).fill(0),p=0,_=u[h];p<_.length;p++){var S=_[p],v=m,C=S.channel;if(C!==void 0){S.type==="programChange"&&(g[C]=S.programNumber);var N=g[C],w="".concat(N," ").concat(C);b.has(w)?v=b.get(w):(v=m+b.size,b.set(w,v))}f[v]||f.push([]),f[v].push(S)}return f}}(Be)),Be}var Zi=Jc();const on=["acoustic_grand_piano","bright_acoustic_piano","electric_grand_piano","honkytonk_piano","electric_piano_1","electric_piano_2","harpsichord","clavinet","celesta","glockenspiel","music_box","vibraphone","marimba","xylophone","tubular_bells","dulcimer","drawbar_organ","percussive_organ","rock_organ","church_organ","reed_organ","accordion","harmonica","tango_accordion","acoustic_guitar_nylon","acoustic_guitar_steel","electric_guitar_jazz","electric_guitar_clean","electric_guitar_muted","overdriven_guitar","distortion_guitar","guitar_harmonics","acoustic_bass","electric_bass_finger","electric_bass_pick","fretless_bass","slap_bass_1","slap_bass_2","synth_bass_1","synth_bass_2","violin","viola","cello","contrabass","tremolo_strings","pizzicato_strings","orchestral_harp","timpani","string_ensemble_1","string_ensemble_2","synth_strings_1","synth_strings_2","choir_aahs","voice_oohs","synth_choir","orchestra_hit","trumpet","trombone","tuba","muted_trumpet","french_horn","brass_section","synth_brass_1","synth_brass_2","soprano_sax","alto_sax","tenor_sax","baritone_sax","oboe","english_horn","bassoon","clarinet","piccolo","flute","recorder","pan_flute","blown_bottle","shakuhachi","whistle","ocarina","lead_1_square","lead_2_sawtooth","lead_3_calliope","lead_4_chiff","lead_5_charang","lead_6_voice","lead_7_fifths","lead_8_bass__lead","pad_1_new_age","pad_2_warm","pad_3_polysynth","pad_4_choir","pad_5_bowed","pad_6_metallic","pad_7_halo","pad_8_sweep","fx_1_rain","fx_2_soundtrack","fx_3_crystal","fx_4_atmosphere","fx_5_brightness","fx_6_goblins","fx_7_echoes","fx_8_scifi","sitar","banjo","shamisen","koto","kalimba","bagpipe","fiddle","shanai","tinkle_bell","agogo","steel_drums","woodblock","taiko_drum","melodic_tom","synth_drum","reverse_cymbal","guitar_fret_noise","breath_noise","seashore","bird_tweet","telephone_ring","helicopter","applause","gunshot"];function ln(i){const e=i.split("/"),s=e[e.length-1].trim().toLowerCase().replace(/\s+/g,"_"),n=on.findIndex(r=>r===s);return n!==-1?n:(s.includes("drum")||s.includes("drummachine"),0)}async function Wc(i){if(!i.sequencers.length)throw new Error("No tracks to export.");const e=new Zi.Midi;e.header.setTempo(i.tempo),e.header.timeSignatures.push({ticks:0,timeSignature:i.timeSignature});for(const[n,r]of i.sequencers.entries()){const a=e.addTrack(),o=r.instrument.toLowerCase().includes("drum");a.channel=o?9:n%16;const l=ln(r.instrument);if(a.instrument.number=l,typeof r.volume=="number"&&a.addCC({number:7,time:0,value:Math.max(0,Math.min(1,r.volume))}),typeof r.pan=="number"){const d=(r.pan+1)/2;a.addCC({number:10,time:0,value:Math.max(0,Math.min(1,d))})}for(const d of r.notes){const c=j(d.pitch),u=Math.max(.01,Math.min(1,(d.velocity??100)/127));if(c===null)continue;const f=Ut(d.start,i.tempo),h=Ut(d.duration,i.tempo);a.addNote({midi:c,time:f,duration:h,velocity:u})}}const t=new Blob([e.toArray()],{type:"audio/midi"});return{url:URL.createObjectURL(t),filename:`session-${Date.now()}.mid`}}function jc(i){if(!i.length)throw new Error("No sequencers to export.");const e=new Zi.Midi,t=ve(),s=Oe();e.header.setTempo(t),e.header.timeSignatures.push({ticks:0,timeSignature:[s,4]});for(const[a,o]of i.entries()){const l=e.addTrack(),d=o.instrumentName.toLowerCase().includes("drum");l.channel=d?9:a%16;const c=ln(o.instrumentName);if(l.instrument.number=c,typeof o.volume=="number"&&l.addCC({number:7,time:0,value:Math.max(0,Math.min(1,o.volume))}),typeof o.pan=="number"){const u=(o.pan+1)/2;l.addCC({number:10,time:0,value:Math.max(0,Math.min(1,u))})}for(const u of o.notes){const f=j(u.pitch),h=Math.max(.01,Math.min(1,(u.velocity??100)/127));if(f===null)continue;const m=Ut(u.start,t),b=Ut(u.duration,t);l.addNote({midi:f,time:m,duration:b,velocity:h})}E(`[ExportMidi] Track ${a} (${o.instrumentName}) added with ${l.notes.length} notes.`)}const n=new Blob([e.toArray()],{type:"audio/midi"}),r=`session-${Date.now()}.mid`;return E(`[ExportMidi] MIDI session file created: ${r}, size: ${n.size} bytes`),{filename:r,blob:n}}function Ut(i,e){return 60/e*i}function cn(i,e){const{filename:t,blob:s}=jc(e),n=URL.createObjectURL(s);if(i.dataTransfer){i.dataTransfer.clearData(),i.dataTransfer.setData("DownloadURL",`audio/midi:${t}:${n}`),i.dataTransfer.effectAllowed="copy";const r=document.createElement("div");return r.textContent=t,r.style.padding="10px 16px",r.style.background="#000000",r.style.color="#ffffff",r.style.fontFamily="sans-serif",r.style.fontSize="12px",r.style.border="1px solid #555",r.style.borderRadius="6px",r.style.boxShadow="0 2px 6px rgba(0, 0, 0, 0.5)",r.style.position="absolute",r.style.top="-1000px",r.style.pointerEvents="none",document.body.appendChild(r),i.dataTransfer.setDragImage(r,0,0),E("[ExportMidiDrag] dataTransfer populated with MIDI file via DownloadURL"),()=>{E("[ExportMidiDrag] cleaning up URL and drag image"),setTimeout(()=>{URL.revokeObjectURL(n),E(`[ExportMidiDrag] URL revoked: ${n}`)},100),r.parentNode&&r.parentNode.removeChild(r)}}else return console.warn("Drag event has no dataTransfer"),()=>{}}function Xc(i,e){let t=null;const s=r=>{i.classList.add("dragging"),E(`[ExportMidiDrag] dragstart fired for sequencer ${e.id}`),t=cn(r,[e])},n=()=>{E(`[ExportMidiDrag] dragend for sequencer ${e.id}`),i.classList.remove("dragging"),t&&(t(),t=null)};return i.addEventListener("dragstart",s),i.addEventListener("dragend",n),{detach:()=>{i.removeEventListener("dragstart",s),i.removeEventListener("dragend",n)},refreshUI:()=>{}}}function Vc(i,e){var n;const t=structuredClone(i),s=t.sequencers.find(r=>r.id===e.id);if(s&&typeof e.volume=="number"){s.volume=e.volume;const a=J().find(o=>o.id===e.id);a&&(a.volume=e.volume,(n=a.refreshVolumeUI)==null||n.call(a))}return t}function Yc(i,e){return{type:"SET_VOLUME",id:i,volume:e}}function Zc(i,e){return{type:"SET_VOLUME",id:i,volume:e}}function Qc(i,e){const{element:t,fill:s,thumb:n}=i;let r=!1,a=!1,o=!1,l=null;const d=100/127,c=.1;function u(){const p=Math.max(0,Math.min(1,e.volume)),_=t.clientWidth,S=14,v=0,C=_-S,N=p*_,w=Math.max(v,Math.min(C,N-S/2));s.style.width=`${Math.round(p*100)}%`,n.style.left=`${w}px`;const L=Math.round(p/d*100);t.setAttribute("title",`Volume: ${L}%`);const k=p>d;s.classList.toggle("overdrive",k),n.classList.toggle("overdrive",k)}function f(){s.classList.toggle("precise",a),n.classList.toggle("precise",a)}function h(p){const _=t.getBoundingClientRect(),S=p-_.left;let v=Math.max(0,Math.min(1,S/_.width));return!a&&Math.abs(v-d)<c?(v=d,!o&&navigator.vibrate&&navigator.vibrate(10),o=!0):o=!1,e.volume=v,u(),v}const m=p=>{r=!0,a=p.shiftKey,l=e.volume,f(),h(p.clientX),p.preventDefault()},b=p=>{r&&(a=p.shiftKey,f(),h(p.clientX))},g=p=>{if(!r)return;r=!1;const _=h(p.clientX);l!==null&&_!==l&&O(Yc(e.id,_),Zc(e.id,l)),l=null,a=!1,o=!1,f(),u()};return t.addEventListener("mousedown",m),window.addEventListener("mousemove",b),window.addEventListener("mouseup",g),{detach:()=>{t.removeEventListener("mousedown",m),window.removeEventListener("mousemove",b),window.removeEventListener("mouseup",g)},refreshUI:u}}function ed(i,e){var n;const t=structuredClone(i),s=t.sequencers.find(r=>r.id===e.id);if(s&&typeof e.pan=="number"){s.pan=e.pan;const a=J().find(o=>o.id===e.id);a&&(a.pan=e.pan,(n=a.refreshPanUI)==null||n.call(a))}return t}function td(i,e){return{type:"SET_PAN",id:i,pan:e}}function id(i,e){return{type:"SET_PAN",id:i,pan:e}}function sd(i,e){const{element:t,fill:s,thumb:n}=i;let r=!1,a=!1,o=!1,l=null;function d(){const b=Math.max(-1,Math.min(1,e.pan)),g=(b+1)/2,p=t.clientWidth,_=14,S=0,v=p-_,C=g*p,N=Math.max(S,Math.min(v,C-_/2));s.style.width=`${Math.round(g*100)}%`,n.style.left=`${N}px`;const w=Math.round(b*100);t.setAttribute("title",`Pan: ${w}%`)}function c(){s.classList.toggle("precise",a),n.classList.toggle("precise",a)}function u(b){const g=t.getBoundingClientRect(),p=b-g.left;let S=Math.max(0,Math.min(1,p/g.width))*2-1;const v=0;return!a&&Math.abs(S-v)<.05?(S=v,!o&&navigator.vibrate&&navigator.vibrate(10),o=!0):o=!1,e.pan=S,d(),S}const f=b=>{r=!0,a=b.shiftKey,l=e.pan,c(),u(b.clientX),b.preventDefault()},h=b=>{r&&(a=b.shiftKey,c(),u(b.clientX))},m=b=>{if(!r)return;r=!1;const g=u(b.clientX);l!==null&&g!==l&&O(td(e.id,g),id(e.id,l)),l=null,a=!1,o=!1,c(),d()};return t.addEventListener("mousedown",f),window.addEventListener("mousemove",h),window.addEventListener("mouseup",m),{detach:()=>{t.removeEventListener("mousedown",f),window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",m)},refreshUI:d}}function rd(i,{onZoomIn:e,onZoomOut:t,onResetZoom:s}){const{zoomInBtn:n,zoomOutBtn:r,zoomResetBtn:a,trailingDivider:o}=i,l=()=>{n.classList.toggle("hidden",!0),r.classList.toggle("hidden",!0),a.classList.toggle("hidden",!0),o.classList.toggle("hidden",!0)};return n.addEventListener("click",e),r.addEventListener("click",t),a.addEventListener("click",s),{detach:()=>{n.removeEventListener("click",e),r.removeEventListener("click",t),a.removeEventListener("click",s)},refreshUI:l}}function nd(i,e,t,s,n){const{muteBtn:r,soloBtn:a,collapseBtn:o,deleteBtn:l}=i,d=()=>{r.classList.toggle("side-button-activated",e.mute),a.classList.toggle("side-button-activated",e.solo)},c=()=>{e.toggleMute(),d()},u=()=>{e.toggleSolo(),d()},f=()=>{s(!n())},h=()=>{Vt().showDeleteConfirmModal(()=>{O(en(e.id,e.instrumentName,e.notes,e.volume,e.pan),tn(e.id,e.instrumentName,e.notes,e.volume,e.pan)),e.destroy()},()=>{})};return r.addEventListener("click",c),a.addEventListener("click",u),o.addEventListener("click",f),l.addEventListener("click",h),{detach:()=>{r.removeEventListener("click",c),a.removeEventListener("click",u),o.removeEventListener("click",f),l.removeEventListener("click",h)},refreshUI:()=>{d()}}}class ad{constructor(e,t,s){this.id=null,this.zoomUI=null,this._collapsed=!1,this.detachFns=[],this.refreshFns=[],this.id=s??null,this.initializeUI(e,t),this.toggleZoomControls(!0),this.boundReload=this.reload.bind(this)}initializeUI(e,t){const s=dc(),n=uc();this.rootEl=s.element,s.topBarContainer.appendChild(n.element),e.appendChild(this.rootEl);const r=hc(),a=fc(),o=pc(),l=mc(),d=yc();this.collapseBtn=d.collapseBtn,n.leftGroup.appendChild(r.instrumentButton),n.leftGroup.appendChild(r.copyMidiButton),n.leftGroup.appendChild(r.label),n.volumeWrapper.appendChild(a.element),n.panWrapper.appendChild(o.element),n.zoomWrapper.appendChild(l.element),n.rightControlsWrapper.appendChild(d.element);const{seq:c}=lc(this.rootEl,t,this.id);this.body=s,this.zoomUI=l,this.sequencer=c,this.grid=c.matrix;const u=gc(s.gripHandleContainer,s.matrixContainer,this.grid),f=Xc(r.copyMidiButton,this.sequencer),h=Tc(r.instrumentButton,this.sequencer),m=Qc(a,this.sequencer),b=sd(o,this.sequencer),g=rd(l,{onZoomIn:()=>this.grid.zoomIn(),onZoomOut:()=>this.grid.zoomOut(),onResetZoom:()=>this.grid.resetZoom()}),p=nd(d,this.sequencer,s.matrixContainer,_=>this.collapse(_),()=>this.collapsed);this.detachFns=[u.detach,h.detach,f.detach,m.detach,b.detach,g.detach,p.detach],this.refreshFns=[u.refreshUI,h.refreshUI,f.refreshUI,m.refreshUI,b.refreshUI,g.refreshUI,p.refreshUI],this.sequencer.updateTotalMeasures(),this.sequencer.updateBeatsPerMeasure(),Dt(this.sequencer,t.collapsed),this.refreshUI()}get collapsed(){return this._collapsed}set collapsed(e){this._collapsed=e}collapse(e=!0){return Dt(this.sequencer,e,this.collapseBtn),this._collapsed}getMiniContourCanvas(){return this.body.miniContourCanvas}getMatrixContainer(){return this.body.matrixContainer}getElement(){return this.rootEl}refreshUI(){this.refreshFns.forEach(e=>e())}destroy(){this.detachFns.forEach(e=>e()),this.rootEl.remove(),this.sequencer.destroy(),Xo(this.sequencer.id),Ne.getInstance().unregisterReloadable(this.boundReload)}reload(){if(this.id===null||this.id===void 0){console.error("[SequencerController] Cannot reload without a valid ID.");return}const e={id:this.sequencer.id,instrument:this.sequencer.instrumentName,notes:structuredClone(this.sequencer.notes),volume:this.sequencer.volume,pan:this.sequencer.pan,collapsed:this._collapsed};this.detachFns.forEach(s=>s()),this.rootEl.remove(),this.sequencer.destroy();const t=document.getElementById("sequencers-container");if(!t){console.error("[SequencerController] Cannot reload - parent container missing.");return}this.initializeUI(t,e)}toggleZoomControls(e){if(!this.zoomUI)return;const{leadingDivider:t,zoomInBtn:s,zoomOutBtn:n,zoomResetBtn:r,trailingDivider:a}=this.zoomUI;t.classList.toggle("hidden",!e),s.classList.toggle("hidden",!e),n.classList.toggle("hidden",!e),r.classList.toggle("hidden",!e),a.classList.toggle("hidden",!e)}toggleGripHandle(e){const t=this.body.gripHandleContainer;t==null||t.classList.toggle("hidden",!e)}}function dn(i,e){const t=e.id,s=new ad(i,e,t);return jo(t,s),Ne.getInstance().registerReloadable(s.boundReload),s}function od(i,e){const t=structuredClone(i);if(t.sequencers.push({id:e.id,instrument:e.instrument,notes:e.notes??[],volume:e.volume,pan:e.pan,collapsed:e.collapsed}),!Ye(e.id)){const n={id:e.id,instrument:e.instrument,notes:e.notes??[],volume:e.volume,pan:e.pan,collapsed:e.collapsed},r=document.getElementById("sequencers-container");if(!r)return console.error("Sequencer container not found!"),t;dn(r,n)}return t}function un(i,e,t,s,n){return{type:"CREATE_SEQUENCER",id:i,instrument:e,volume:t,pan:s,collapsed:n}}function Qi(i){return{type:"DELETE_SEQUENCER",id:i}}function ld(i,e){const t=structuredClone(i),s=t.sequencers.find(r=>r.id===e.sequencerId);if(!s)return i;const n=new Set(e.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));return s.notes=s.notes.filter(r=>{const a=`${r.pitch}|${r.start}|${r.duration}`;return!n.has(a)}),Wr(e.notes,s.notes),t}function cd(i,e){const t=structuredClone(i),s=t.sequencers.find(n=>n.id===e.sequencerId);return s?(s.notes.push(...e.notes),Jr(e.notes),t):i}function dd(i,e){const t=structuredClone(i),s=t.sequencers.find(r=>r.id===e.sequencerId);if(!s)return i;const n=e.notes;for(const r of n){const a=s.notes.find(o=>o.pitch===r.pitch&&o.start===r.start&&o.duration===r.duration);a&&(a.velocity=r.velocity)}return ls(e.sequencerId),t}function ud(i,e){return{type:"SET_NOTE_VELOCITY",sequencerId:i,notes:structuredClone(e)}}function hd(i,e){return{type:"SET_NOTE_VELOCITY",sequencerId:i,notes:structuredClone(e)}}function fd(i,e){return structuredClone(i)}function es(i=""){return{type:"CHECKPOINT",label:i}}function hn(i=""){return es(i)}const pd=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_NOTE_DURATION:qo,CHANGE_SNAP_RESOLUTION:Do,CHANGE_SONG_KEY:Oo,CHANGE_TEMPO:bo,CHECKPOINT:fd,CREATE_SEQUENCER:od,CUT_NOTES:ld,DELETE_NOTES:wl,DELETE_SEQUENCER:oc,MOVE_NOTES:Gl,PASTE_NOTES:cd,PLACE_NOTES:Nl,RESIZE_NOTES:Il,SET_INSTRUMENT:Nc,SET_NOTE_MODIFIER_MODE:$o,SET_NOTE_VELOCITY:dd,SET_PAN:ed,SET_TIME_SIGNATURE:vo,SET_TOTAL_MEASURES:Co,SET_VOLUME:Vc},Symbol.toStringTag,{value:"Module"}));function ts(i){const e=pd[i.type];if(!e)throw new Error(`Unknown diff type: ${i.type}`);const t=e(H(),i);_d(t)}const Bi=new Set;function Yt(i){return Bi.add(i),()=>Bi.delete(i)}function Zt(i){for(const e of Bi)e(i)}const Me=[];let we=-1;const md=100;function yd({forwardDiff:i,reverseDiff:e}){Me.splice(we+1),Me.push({forwardDiff:i,reverseDiff:e}),we=Me.length-1,Me.length>md&&(Me.shift(),we--)}function gd(){var i;if(we<0)return null;for(let e=we;e>=0;e--){const t=Me[e];if(((i=t==null?void 0:t.forwardDiff)==null?void 0:i.type)==="CHECKPOINT")return null;if(t!=null&&t.reverseDiff)return we=e-1,ts(t.reverseDiff),Zt(H()),t.reverseDiff}return null}function bd(){if(we>=Me.length-1)return null;we++;const i=Me[we];return!i||!i.forwardDiff?null:(ts(i.forwardDiff),Zt(H()),i.forwardDiff)}let qt={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[],songKey:"CM",snapResolution:1,noteDuration:1,isTripletMode:!1,isDottedMode:!1};function H(){return qt}function _d(i){qt=structuredClone(i),Zt(qt)}function O(i,e){ts(i),yd({forwardDiff:i,reverseDiff:e}),Zt(qt)}let fn=500,pn=!1;function ae(){return H().totalMeasures*H().timeSignature[0]}function ve(){return 60/(fn/1e3)}function is(i,e=!0){const t=ve();if(e){O(_r(i),_o(t));return}const s=W.getInstance();performance.now(),s.getCurrentBeat(),fn=60/i*1e3,s.isActive()&&s.syncAfterTempoChange(t)}function ss(i,e=!0){const t=H().timeSignature[0];if(e){O(vr(i),So(t));return}J().forEach(s=>s.updateBeatsPerMeasure())}function rs(i,e=!0){const t=H().totalMeasures;if(e){O(Sr(i),No(t));return}}function mn(i,e=!0){const t=H().songKey;e&&O(Rr(i),Fo(t))}function Qt(){return Ir()?H().snapResolution:.001}function Fs(i,e=!0){const t=Qt();if(e){O(Pr(i),Uo(t));return}}function vd(i,e=!0){const t=H().noteDuration;if(e){O(Or(i),Ko(t));return}}function Ds(i,e,t=!0){const s=H(),n=s.isTripletMode,r=s.isDottedMode;if(t){O(Fr(i,e),zo(n,r));return}}function Gi(){return H().isTripletMode}function Us(){return H().isDottedMode}function Sd(){return H().noteDuration}function Oe(){return H().timeSignature[0]}function ns(){return H().totalMeasures}function as(){return H().songKey}function Cd(i){pn=i}function Nd(){return pn}let Et=null;function wd(){return W.getInstance()}class W{constructor(e){this.startTime=0,this.startBeat=0,this.isPlaying=!1,this.animationFrameId=null,this.onResumeCallback=null,this.onStopCallback=null,this.tick=()=>{var n;if(!this.isPlaying)return;const t=this.getCurrentBeat(),s=ae();if(t>=s)if(Nd())this.seek(0),this.start();else{this.stop(),(n=this.onStopCallback)==null||n.call(this);return}this.animationFrameId=requestAnimationFrame(this.tick)},this.context=te(),this.sequencers=e}static initialize(e){if(Et){console.warn("[PlaybackEngine] Instance already exists. Ignoring re-initialization.");return}Et=new W(e)}static getInstance(){if(!Et)throw new Error("[PlaybackEngine] Instance not initialized. Call initialize() first.");return Et}setOnResumeCallback(e){this.onResumeCallback=e}setOnStopCallback(e){this.onStopCallback=e}getCurrentBeat(){if(!this.isPlaying)return this.startBeat;const e=60/ve();return(this.context.currentTime-this.startTime)/e+this.startBeat}async start(){const e=this.context.currentTime+.1;this.startTime=e,this.startBeat=0,this.isPlaying=!0,await this.scheduleAll(e,this.startBeat),this.context.state==="suspended"&&await this.context.resume(),this.animationFrameId=requestAnimationFrame(this.tick)}async pause(){if(!this.isPlaying)return;const e=this.getCurrentBeat();for(const t of this.sequencers)t.stopScheduledNotes();await this.context.suspend(),this.startBeat=e,this.isPlaying=!1,this.animationFrameId&&cancelAnimationFrame(this.animationFrameId)}async resume(){var s;if(this.isPlaying)return;await this.context.resume();const t=this.context.currentTime+.05;this.startTime=t,await this.scheduleAll(t,this.startBeat),this.isPlaying=!0,(s=this.onResumeCallback)==null||s.call(this),this.animationFrameId=requestAnimationFrame(this.tick)}stop(){for(const e of this.sequencers)e.stopScheduledNotes();this.isPlaying=!1,this.startBeat=0,this.startTime=0,this.animationFrameId&&cancelAnimationFrame(this.animationFrameId)}seek(e){this.startBeat=e,this.startTime=this.context.currentTime;const t=this.isPlaying;if(this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),t){const s=this.context.currentTime+.05;this.startTime=s,this.scheduleAll(s,this.startBeat).then(()=>{this.animationFrameId=requestAnimationFrame(this.tick)}),this.context.state==="suspended"&&this.context.resume(),this.isPlaying=!0}else this.isPlaying=!1}syncAfterTempoChange(e){const t=this.context.currentTime,s=60/e,n=(t-this.startTime)/s+this.startBeat;this.startBeat=n,this.startTime=t}setSequencers(e){this.sequencers=e}addSequencer(e){this.sequencers.includes(e)||this.sequencers.push(e)}removeSequencer(e){this.sequencers=this.sequencers.filter(t=>t!==e)}clearSequencers(){this.stop(),this.sequencers=[]}isActive(){return this.isPlaying}getStartTime(){return this.startTime}getStartBeat(){return this.startBeat}async scheduleAll(e,t){for(const s of this.sequencers)s.shouldPlay?await s.preparePlayback(e,t):s.stopScheduledNotes()}}const Mt=new Map;let os=null;function Md(i,e){Mt.set(i,e)}function xd(i){Mt.delete(i)}function Ye(i){return Mt.get(i)}function J(){return Array.from(Mt.values())}function ei(){return os}function ls(i){Ct(),os=i}function yn(){Ct(),os=null}function Ld(){yn(),Mt.clear()}function kd(){return J().some(i=>i.solo)}function qs(){const i=W.getInstance();if(!i.isActive())return;const e=i.getStartTime(),t=i.getStartBeat();for(const s of J())s.stopScheduledNotes(),s.shouldPlay&&(s.reschedulePlayback(e,t),s.resumeAnimationsFromCurrentTime(e,t))}function Ad(){var i;for(const e of J())(i=e.matrix)==null||i.requestRedraw()}function gn(){return J()}function Bd(){E("Sequencer Dump",gn())}const Gd=Object.freeze(Object.defineProperty({__proto__:null,dumpSequencers:Bd,getSequencers:gn},Symbol.toStringTag,{value:"Module"}));function bn(){return H()}function Ed(){E("App State Dump",bn())}const Td=Object.freeze(Object.defineProperty({__proto__:null,dumpState:Ed,getAppState:bn},Symbol.toStringTag,{value:"Module"}));function Id(){return structuredClone(V())}function Rd(i,e){const t=i.split(".");if(t.length===0){console.warn("Invalid path provided to setUserConfigProperty.");return}let s={},n=s;for(let a=0;a<t.length-1;a++){const o=t[a];n[o]={},n=n[o]}const r=t[t.length-1];n[r]=e,re(s),E(`[UserConfig] Set ${i} =`,e)}function Pd(i){const e=i.split(".");let t=V();for(const s of e)if(t&&typeof t=="object"&&s in t)t=t[s];else{console.warn(`getUserConfigProperty: Path "${i}" not found.`);return}return t}const Od=Object.freeze(Object.defineProperty({__proto__:null,getUserConfigProperty:Pd,getUserConfigSnapshot:Id,setUserConfigProperty:Rd},Symbol.toStringTag,{value:"Module"}));function Fd(){return ue.getSubscribers()}function Dd(){ue.toggleAll()}function Ud(){ue.showAll()}function qd(){ue.hideAll()}const Kd=Object.freeze(Object.defineProperty({__proto__:null,getAllPopoverSubscribers:Fd,hideAllPopovers:qd,showAllPopovers:Ud,toggleAllPopovers:Dd},Symbol.toStringTag,{value:"Module"}));function $d(){const i=Object.create(null);return Object.assign(i,Gd,Td,Od,Kd),i}const zd="SEQUENZIA_DEV";function Hd(){if(typeof window>"u")return;localStorage.getItem(zd)==="true"&&!ii()&&(us(),console.info("[SEQUENZIA] Dev mode re-enabled from localStorage")),window.toggleDevMode=()=>{const e=!ii();e?us():Xn(),console.info(`[SEQUENZIA] Dev mode ${e?"enabled":"disabled"}`),e?Ks():delete window.DEVTOOLS},ii()&&Ks()}function Ks(){window.DEVTOOLS=$d()}function Jd(){window.addEventListener("contextmenu",i=>i.preventDefault()),window.addEventListener("dragstart",i=>{const e=i.target;e.closest(".copy-midi-btn")||e.closest(".drag-midi-btn")||i.preventDefault()}),window.addEventListener("selectstart",i=>i.preventDefault()),window.addEventListener("drop",i=>i.preventDefault()),window.addEventListener("dragover",i=>i.preventDefault()),window.addEventListener("keydown",i=>{const e=[" ","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Tab","Home","End","PageUp","PageDown"],t=i.metaKey,s=i.ctrlKey;(e.includes(i.key)||(t||s)&&["s","p"].includes(i.key.toLowerCase()))&&i.preventDefault()})}function Wd(i,e,t,s=!0){const n=i.getInteractionStore();let r=new Set;if(s){const o=n.getSelectedNotes();r=new Set(o.map(l=>`${l.pitch}:${l.start}:${l.duration}:${l.velocity}`))}if(i.setNotes(structuredClone(e)),i.getNoteManager().rebuildIndex(),s&&r.size>0){const o=i.notes.filter(l=>r.has(`${l.pitch}:${l.start}:${l.duration}:${l.velocity}`));n.setSelectedNotes(o)}const a=W.getInstance();if(a!=null&&a.isActive()){const o=a.getStartTime(),l=a.getStartBeat();t.reschedulePlayback(o,l)}i.requestRedraw()}function jd(i,e){return i!==void 0&&e!==void 0&&i===e}function Xd(i=H()){var n;is(i.tempo,!1),ss(i.timeSignature[0],!1),rs(i.totalMeasures,!1);const e=J();for(const r of e)r.updateTotalMeasures();const t=document.getElementById("sequencers-container");if(!t){console.error("resyncFromState: Missing #sequencers-container");return}for(const r of i.sequencers){const a=e.find(o=>jd(o.id,r.id));if(a){a.instrumentName=r.instrument,typeof r.volume=="number"&&(a.volume=r.volume),typeof r.pan=="number"&&(a.pan=r.pan);const o=(n=a.container)==null?void 0:n.querySelector("canvas.mini-contour");o&&Jt(o,r.notes,a.config,a.colorIndex),a.matrix&&Wd(a.matrix,r.notes,a,!0)}else{const o={id:r.id,instrument:r.instrument,notes:structuredClone(r.notes),volume:r.volume,pan:r.pan,collapsed:r.collapsed};dn(t,o)}}document.getElementById("global-mini-contour")&&De()}const _n="userConfig";function Vd(){const i=V();bt(_n,i)}function Yd(){const i=Qe(_n);i&&re(i)}function Zd(i,e=[],t="w-[1276px]"){const s=i.id||"bottom-drawer",n=i.ariaLabel||"Bottom drawer",r=i.edgeOffsetClass||"bottom-[60px]",a=i.drawerClassOverride||"",o=t.toString(),l=U(),d=y("div",{id:s,class:["fixed bottom-0 left-1/2 translate-x-[-50%] z-40",o,"overflow-y-auto","rounded-t-lg",l.menuBackground,l.textColor,"transition-transform","translate-y-0","border-t border-gray-200 dark:border-gray-700 pb-[20px]",r,a].join(" "),"aria-labelledby":`${s}-label`,"data-drawer-placement":"bottom","data-drawer-edge":"true","data-drawer-edge-offset":r}),c=y("div",{class:[i.toggleHandleHeightClass,"cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700"].join(" ")},y("span",{class:"absolute w-8 h-1 -translate-x-1/2 bg-gray-300 rounded-lg top-3 left-1/2 dark:bg-gray-600"}),y("h5",{id:`${s}-label`,class:"inline-flex items-center text-base text-gray-500 dark:text-gray-400 font-medium"},n));d.appendChild(c),e.forEach(f=>d.appendChild(f));const u=new zn(d,{placement:"bottom",edge:!0,edgeOffset:r,backdrop:!1,bodyScrolling:!0},{id:s,override:!0});return u.show(),c.addEventListener("click",()=>{u.toggle()}),d}const Qd="w-[1260px]",yi=1100,eu=[{value:"4",label:"𝅝",title:"Whole"},{value:"2",label:"𝅗𝅥",title:"Half"},{value:"1",label:"𝅘𝅥",title:"Quarter"},{value:"0.5",label:"♪",title:"Eighth"},{value:"0.25",label:"♬",title:"Sixteenth"},{value:"0.125",label:"𝅘𝅥𝅰",title:"32nd"}];class tu{constructor(){this.globalPlayheadRow=y("div",{id:"global-playhead-row",class:"w-full mb-2"}),this.globalToolsRow=y("div",{id:"global-tools-row",class:"w-full mb-2"}),this.globalTransportRow=y("div",{id:"global-transport-row",class:"w-full"});const e=Zd({id:"global-controls-drawer",ariaLabel:" ",edgeOffsetClass:"bottom-[40px]",toggleHandleHeightClass:"py-2"},[this.globalPlayheadRow,this.globalToolsRow,this.globalTransportRow],Qd);this.drawer=e;const t=document.getElementById("footer-main");t?t.appendChild(this.drawer):console.warn("footer-main container not found. GlobalControls not injected.")}render(){return this.drawer}destroy(){this.drawer.remove()}getGlobalPlayheadRow(){return this.globalPlayheadRow}getGlobalToolsRow(){return this.globalToolsRow}getGlobalTransportRow(){return this.globalTransportRow}}function Tt(i,e,t){const s=window.devicePixelRatio||1;i.width=e*s,i.height=t*s,i.style.width=`${e}px`,i.style.height=`${t}px`;const n=i.getContext("2d");n&&n.scale(s,s)}const iu=fe("static/svg/icon-caret-up.svg");function su(){const i=`w-[${yi}px]`,e="h-[75px]",t=y("div",{class:"relative flex justify-center w-full mt-4"}),s=y("canvas",{id:"global-mini-contour",class:`absolute top-0 left-0 ${i} ${e} z-0`}),n=y("canvas",{id:"global-mini-playhead",class:`absolute top-0 left-0 ${i} ${e} z-10`,style:"cursor: pointer;"}),r=y("div",{class:`relative ${i} ${e} bg-gray-900/80 backdrop-blur-sm shadow-md rounded-xl`},s,n);Tt(s,yi,75),Tt(n,yi,75),new ResizeObserver(()=>{const d=r.getBoundingClientRect(),c=Math.round(d.width),u=Math.round(d.height);Tt(s,c,u),Tt(n,c,u),De()}).observe(r);const o=y("img",{id:"global-mini-collapse-icon",src:iu,class:"w-4 h-4",alt:"Expand Mini Contour"}),l=y("button",{id:"global-mini-collapse-btn",class:"absolute right-[calc(50%-600px)] bottom-0 mb-2 p-2 bg-purple-700 text-white text-sm rounded hover:bg-purple-600 transition-colors",style:"cursor: pointer;",title:"Expand Mini Contour"},o);return t.appendChild(r),t.appendChild(l),y("div",{id:"globalControls-miniContour-body",class:"w-full max-w-[1260px] mx-auto"},t)}let ee=null;function ru(){return(ee==null?void 0:ee.disabled)??!1}function nu(i){ee=i}function au(){ee&&(ee.disabled=!0,ee.classList.add("opacity-50","cursor-not-allowed"),lu())}function ou(){ee&&(ee.disabled=!1,ee.classList.remove("opacity-50","cursor-not-allowed"),cu())}function lu(){if(!ee)return;const i=ee.querySelector("img");i&&(i.src=fe("static/svg/icon-cog.svg"),i.classList.add("img-spin"),i.alt="Generating...")}function cu(){if(!ee)return;const i=ee.querySelector("img");i&&(i.src=fe("static/svg/icon-cursor-arrow-rays.svg"),i.classList.remove("img-spin"),i.alt="Toggle Autocomplete")}function cs(i,e=[],t={},s=!1){const n=U(),r=t.id||`popover-${Math.random().toString(36).slice(2,9)}`,a=y("div",{id:r,"data-popover":"",role:"tooltip",class:["absolute z-[9999] inline-block w-64 text-sm transition-opacity duration-300","border rounded-lg shadow-xs opacity-0 invisible",n.menuBackground,n.textColor,n.borderColor,"bg-white dark:bg-gray-800"].join(" ")});if(t.title){const m=y("div",{class:["px-3 py-2 border-b rounded-t-lg","bg-gray-100 dark:bg-gray-700","border-gray-200 dark:border-gray-600"].join(" ")},y("h3",{class:"font-semibold text-gray-900 dark:text-white",textContent:t.title}));a.appendChild(m)}const o=y("div",{class:"px-3 py-2"},...e);a.appendChild(o),document.body.appendChild(a);const l={placement:t.placement||"bottom",triggerType:t.triggerType||"click",offset:t.offset??10,onShow:t.onShow??(()=>{}),onHide:t.onHide??(()=>{}),onToggle:t.onToggle??(()=>{})},d={id:r,override:t.overrideInstance??!0},c=new ir(a,i,l,d);let u=!1;s&&(ue.subscribe(c,a),u=!0);const f=()=>{u&&(ue.unsubscribe(c),u=!1)};let h=null;return c.updateOnShow(()=>{var m;h=b=>{(b.key==="Escape"||b.key.length===1)&&c.hide()},document.addEventListener("keydown",h,{once:!0}),(m=l.onShow)==null||m.call(l,c)}),c.updateOnHide(()=>{var m;h&&(document.removeEventListener("keydown",h),h=null),(m=l.onHide)==null||m.call(l,c)}),{trigger:i,content:a,instance:c,unsubscribe:f}}function vn(i){return i.startsWith("Key")&&i.length===4?i[3]:i.startsWith("Digit")&&i.length===6?i[5]:{BracketLeft:"[",BracketRight:"]",Backquote:"`",Minus:"-",Equal:"=",Semicolon:";",Quote:"'",Comma:",",Period:".",Slash:"/",Backslash:"\\",Space:"Space"}[i]??i}function du(i){const e=[];if(i.ctrl&&e.push("Ctrl"),i.shift&&e.push("Shift"),i.alt&&e.push("Alt"),i.meta){const s=navigator.platform.toUpperCase().includes("MAC");e.push(s?"Cmd":"Win")}const t=vn(i.code);return[...e,t].join("+")}function Sn(i){if(!i)return"";const e=[];if(i.ctrl&&e.push("Ctrl"),i.shift&&e.push("Shift"),i.alt&&e.push("Alt"),i.meta){const s=navigator.platform.toUpperCase().includes("MAC");e.push(s?"Cmd":"Win")}const t=vn(i.code);return[...e,t].join("+")}function uu(i){const e=Oi(i),t=Array.isArray(e)?e[0]:e;return t?du(t):""}const hu=[{id:"velocity-tool",label:"Velocity Tool",iconName:"icon-cog",macroName:"ToggleVelocityTool"},{id:"quantize-tool",label:"Quantize Tool",iconName:"icon-cog",macroName:"ToggleQuantizeTool",disabled:!0},{id:"transpose-tool",label:"Transpose Tool",iconName:"icon-cog",macroName:"ToggleTransposeTool",disabled:!0},{id:"chordifier",label:"Chordifier",iconName:"icon-adjustments-vertical",macroName:"ToggleChordifyTool",disabled:!0},{id:"humanizer",label:"Humanizer",iconName:"icon-adjustments-vertical",macroName:"ToggleHumanizeTool",disabled:!0}];function fu(){const i=U(),e=y("button",{id:"note-editing-options-btn",class:"bg-gray-800 px-3 py-1 rounded text-white hover:bg-purple-700 w-[52px] h-[42px] flex items-center justify-center",style:"cursor: pointer;",title:"Tools"},I("icon-chart-bar","Editing"));let t;const s=[y("div",{class:"max-h-72 overflow-y-auto flex flex-col gap-1"},...hu.flatMap((a,o)=>{const l=o===2,d=uu(a.macroName),c=y("button",{class:["flex items-center justify-between gap-2 px-3 py-2 text-sm rounded text-left transition-colors",a.disabled?"text-gray-500 bg-gray-700/30 cursor-not-allowed opacity-50":"text-white hover:bg-purple-700 cursor-pointer"].join(" "),...a.disabled?{}:{onClick:()=>{const u=new CustomEvent("editor-invoke",{detail:{editorId:a.id},bubbles:!0});e.dispatchEvent(u),requestAnimationFrame(()=>{t==null||t.hide()})}}},y("div",{class:"flex items-center gap-2"},I(a.iconName,a.label),y("span",{textContent:a.label})),d?y("span",{class:"text-xs text-gray-400 font-mono",textContent:d}):null);return l?[c,y("div",{class:`my-2 border-t ${i.borderColor} mx-2`})]:[c]}))];t=cs(e,s,{title:"Tools",placement:"bottom",triggerType:"click"}).instance;let r=null;return t.updateOnShow(()=>{r=a=>{(a.key==="Escape"||a.key.length===1)&&(t==null||t.hide())},document.addEventListener("keydown",r,{once:!0})}),t.updateOnHide(()=>{r&&(document.removeEventListener("keydown",r),r=null)}),e}function Ke(i){const e=U();return y("span",{class:`font-semibold ${e.accentColor} rounded text-xs`,textContent:i})}function se(...i){const e=U();return y("p",{class:`text-sm leading-relaxed ${e.textColor}`},...i)}function Je(i,e="?",t){const s=U(),n=y("span",{"data-tooltip-target":i,tabIndex:-1,class:[`${s.textColor} border border-white/40`,"hover:bg-white/10","font-medium rounded-full text-xs px-2 py-[2px]","pointer-events-auto select-none","cursor-default","focus:outline-none focus:ring-0","aria-hidden"].join(" ")},e),r=Array.isArray(t)?t.map(o=>typeof o=="string"?se(o):o):[typeof t=="string"?se(t):t],a=y("div",{id:i,role:"tooltip",class:["absolute z-10 invisible inline-block max-w-xs px-4 py-3 text-sm",`${s.textColor} transition-opacity duration-300 ${s.surfaceBackground} rounded-lg shadow-xs`,"opacity-0 tooltip"].join(" ")},y("div",{class:"space-y-2"},...r),y("div",{class:"tooltip-arrow","data-popper-arrow":""}));return{trigger:n,tooltip:a}}function pu(){const i=U(),e=y("button",{id:"note-placement-options-btn",class:"bg-gray-800 px-3 py-1 rounded text-white hover:bg-purple-700 w-[52px] h-[42px] flex items-center justify-center",title:"Grid Settings",style:"cursor: pointer;"},I("icon-music","Placement")),t=Je("tooltip-grid-guides","?",[se(Ke("Key Grid Highlighting:")," colors each piano roll row based on the current song key."),se("In-key notes are shown as white rows. Out-of-key notes are shown as black rows.")]),s=Le({id:"toggle-grid-guides",stateA:"Off",stateB:"Transpose Grid to Key",inline:!0,tooltipTrigger:t.trigger});s.input.addEventListener("change",()=>{To(s.getChecked())});const n=Je("tooltip-snap-to-key","?",[se(Ke("Snap to Key:")," constrains vertical note placement to notes in the current key."),se("Hold ",Ke("CTRL")," while placing notes to temporarily allow chromatic input.")]),r=Le({id:"toggle-snap-key",stateA:"Off",stateB:"Snap Notes to Key",inline:!0,tooltipTrigger:n.trigger});r.input.addEventListener("change",()=>{Ro(r.getChecked())});const a=Je("tooltip-snap-to-grid","?",[se(Ke("Snap to Grid:")," constrains horizontal note placement to musical durations."),se("Notes will align to the selected beat value (e.g. quarter, eighth, sixteenth).")]),o=Le({id:"toggle-snap-grid",stateA:"Off",stateB:"Snap Notes to Grid",inline:!0,tooltipTrigger:a.trigger});o.input.addEventListener("change",()=>{Io(o.getChecked())});const l=()=>{s.setChecked(Tr()),r.setChecked(zt()),o.setChecked(Ir())},d=[y("div",{class:"mb-1"},s.element),t.tooltip,y("div",{class:`my-2 border-t ${i.borderColor} mb-3 mx-2`}),y("div",{class:"mb-1"},r.element),n.tooltip,y("div",{class:"mt-1"},o.element),a.tooltip];return cs(e,d,{title:"Grid Settings",placement:"bottom",triggerType:"click",onShow:()=>requestAnimationFrame(l)}),{trigger:e,refreshToggles:l}}function mu(i,e=[],t={},s=!1){const n=U(),r=`minipop-${Math.random().toString(36).slice(2,9)}`,a=y("div",{id:r,"data-popover":"",role:"tooltip",class:["absolute z-[9999] inline-block text-xs transition-opacity duration-300","border rounded px-2 py-1 whitespace-nowrap opacity-0 invisible",n.menuBackground,n.textColor,n.borderColor,"bg-white dark:bg-gray-800"].join(" ")},...e);document.body.appendChild(a);const o={placement:t.placement||"top",triggerType:t.triggerType||"hover",offset:t.offset??6,onShow:t.onShow??(()=>{}),onHide:t.onHide??(()=>{}),onToggle:t.onToggle??(()=>{})},l={id:r,override:!0},d=new ir(a,i,o,l);let c=!1;return s&&(ue.subscribe(d,a),c=!0),{trigger:i,content:a,instance:d,unsubscribe:()=>{c&&(ue.unsubscribe(d),c=!1)}}}function yu(i){const e=[];i.ctrl&&e.push("Ctrl"),i.shift&&e.push("Shift"),i.alt&&e.push("Alt"),i.meta&&e.push("Meta");const t=Sn(i);return[...e,t].join(" + ")}function ie(i,e){const t=Oi(e),n=(Array.isArray(t)?t:[t]).map(r=>{const a=yu(r);return document.createElement("div").appendChild(document.createTextNode(a)).parentElement});return mu(i,n,{placement:"top",triggerType:"hover"},!0)}function gu(){const i=pu(),e=y("button",{id:"note-mode-btn",class:"bg-blue-600 px-3 py-1 rounded text-white hover:bg-blue-700 text-sm font-semibold w-[52px] h-[42px] flex items-center justify-center",style:"cursor: pointer;",title:"Drawing Toolbar"},I("icon-pen","Note Mode"));ie(e,"SwitchToNoteMode");const t=y("button",{id:"ai-mode-btn",class:"bg-gray-800 px-3 py-1 rounded text-white hover:bg-purple-700 text-sm font-semibold w-[52px] h-[42px] flex items-center justify-center",style:"cursor: pointer;",title:"AI Toolbar"},I("icon-brain-white","AI Mode"));ie(t,"SwitchToAIMode");const s=y("div",{class:"flex flex-wrap justify-center items-center gap-4 p-4"},y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md cursor-pointer"},e,t)),n=eu.map((p,_)=>{const S=y("button",{id:`note-duration-btn-${_}`,class:"bg-transparent hover:bg-gray-700 text-white cursor-pointer px-3 py-1 rounded text-2xl w-[52px] h-[42px] flex items-center justify-center","data-value":p.value,title:p.title},p.label);return ie(S,`ApplyDuration${_+1}`),S}),r=y("button",{id:"dotted-note-btn",class:"bg-transparent hover:bg-purple-700 text-white cursor-pointer px-3 py-1 rounded text-2xl font-semibold w-[52px] h-[42px] flex items-center justify-center",title:"Toggle Dotted Note"},"•");ie(r,"ToggleDottedNotes");const a=y("button",{id:"triplet-note-btn",class:"bg-transparent hover:bg-purple-700 text-white cursor-pointer px-3 py-1 rounded text-2xl font-semibold w-[52px] h-[42px] flex items-center justify-center",title:"Toggle Triplet"},"³");ie(a,"ToggleTripletNotes");const o=y("div",{class:"flex gap-4"},y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md cursor-pointer"},i.trigger,fu()),y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md"},...n),y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md"},r,a)),l=y("button",{id:"autocomplete-toggle-btn",class:"bg-transparent hover:bg-purple-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"AI Autocomplete"},I("icon-cursor-arrow-rays","Toggle Autocomplete"));nu(l),ie(l,"AIStartAutocomplete");const d=y("button",{id:"ai-tools-btn",class:"bg-transparent hover:bg-gray-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"AI Tools"},I("icon-chip","AI Tools"));ie(d,"AIToolsMenu");const c=y("button",{id:"autocomplete-approve-btn",class:"bg-transparent hover:bg-green-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"Approve"},I("icon-thumbs-up","Approve Autocomplete"));ie(c,"ApproveAutocomplete");const u=y("button",{id:"ai-extend-before-btn",class:"bg-transparent hover:bg-gray-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"AI Extend Before"},I("icon-double-arrow-left","AI Extend Before"));ie(u,"AIExtendBefore");const f=y("button",{id:"ai-paint-btn",class:"bg-transparent hover:bg-gray-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"AI Paint Tool"},I("icon-paint-brush","AI Paint"));ie(f,"AIPaint");const h=y("button",{id:"ai-extend-after-btn",class:"bg-transparent hover:bg-gray-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"AI Extend After"},I("icon-double-arrow-right","AI Extend After"));ie(h,"AIExtendAfter");const m=y("button",{id:"ai-adjust-prompt-btn",class:"bg-transparent hover:bg-gray-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"Adjust AI Prompt Settings"},I("icon-adjust-ai-prompt","Adjust AI Prompt"));ie(m,"AIAdjustPrompt");const b=y("button",{id:"ai-debugger-btn",class:"bg-transparent hover:bg-gray-700 text-white cursor-pointer px-3 py-1 rounded w-[52px] h-[42px] flex items-center justify-center",title:"AI Debugger"},I("icon-command-line","AI Debugger"));ie(b,"AIDebugger");const g=y("div",{class:"flex gap-4 hidden"},y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md"},d),y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md"},l,c),y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md"},u,f,h),y("div",{class:"flex items-center gap-1 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md"},m,b));return s.appendChild(o),s.appendChild(g),{element:s,refreshGridSettings:i.refreshToggles,noteOptionsGroup:o,aiOptionsGroup:g}}function bu(){const i=y("div",{class:"fixed left-[calc(50%-678px)] bottom-[20px] flex flex-col gap-2 z-[9999]"},y("button",{id:"footer-help-btn",class:"side-button side-button-info",title:"Help / Documentation"},I("icon-lightbulb","Help")),y("button",{id:"footer-whats-new-btn",class:"side-button side-button-info",title:"What's New / Release Notes"},I("icon-circle-plus","What's New")));return document.body.appendChild(i),i}function $s(){const i=U();return y("div",{class:["h-12 w-px",i.accentColor,"shadow-inner","rounded-full"].join(" ")})}function qe(i,e,t,s,n){return y("button",{id:i,title:e,class:["w-12 h-12 flex items-center justify-center rounded-full cursor-pointer shadow transition-all hover:scale-110","text-white",s,n].join(" ")},t)}function gi(i){const{id:e,value:t,min:s,max:n,onInput:r}=i,a=U();return y("input",{id:e,type:"number",value:String(t),min:s==null?void 0:s.toString(),max:n==null?void 0:n.toString(),class:["w-[72px] h-[40px] px-2 rounded text-sm font-semibold",a.surfaceBackground,a.textColor,a.borderColor].join(" "),oninput:r})}function lt(i="4"){return y("div",{class:`inline-block w-${i}`})}function Cn(){const i=U();return y("div",{class:["w-full h-px",i.accentColor,"shadow-inner","rounded-full","my-2"].join(" ")})}const _u=["C","D","E","F","G","A","B"],vu=["C#","D#","","F#","G#","A#",""];function Su(){return as()??"CM"}function bi(i){const e=i.endsWith("m")?"m":"M";return[i.slice(0,i.length-1),e]}function Cu(){U();let[i,e]=bi(Su());const t=z({id:"key-selector-trigger",text:`${i}${e}`,kind:"secondary",additionalClasses:"w-14 px-2 py-[10px] text-center truncate"}),s=(c,u)=>{if(c==="")return;i=c,e=u;const f=`${c}${u}`;mn(f),t.textContent=f,l()},n=y("div",{class:"flex w-full mt-2 gap-[6px]"},..._u.map(c=>y("button",{class:_i(c,i),onClick:()=>s(c,e)},c))),r=y("div",{class:"flex w-full mb-1 gap-[6px] translate-x-[22px]"},...vu.map(c=>c===""?y("div",{class:"w-8"}):y("button",{class:_i(c,i),onClick:()=>s(c,e)},c))),a=Le({id:"key-mode-toggle",stateA:"Major",stateB:"Minor",inline:!0});a.setChecked(e==="m"),a.input.addEventListener("change",()=>{const c=a.getChecked()?"m":"M";s(i,c)});const o=[r,n,Cn(),a.element],l=()=>{[...n.children,...r.children].forEach(u=>{if(!(u instanceof HTMLButtonElement))return;const f=u.textContent||"";u.className=_i(f,i)}),a.setChecked(e==="m")};return cs(t,o,{title:"Key Selector",placement:"bottom",triggerType:"click"}),Yt(c=>{const[u,f]=bi(c.songKey);i=u,e=f,t.textContent=c.songKey,l()}),{trigger:t,refreshUI:()=>{const[c,u]=bi(as());i=c,e=u,t.textContent=`${c}${u}`,l()}}}function _i(i,e){return["w-8 h-8 rounded-full text-xs flex items-center justify-center","transition-all duration-150","cursor-pointer focus:outline-none","text-white",i===e?"bg-cyan-600 ring-2 ring-white":"bg-gray-600 hover:bg-gray-500 hover:ring-1 hover:ring-white"].join(" ")}function Nu(){const i=Le({id:"loop-toggle",stateB:"Loop",inline:!0}),e=Cu();return{element:y("div",{class:"flex justify-center items-center gap-4 flex-wrap"},y("div",{class:"flex items-center gap-2"},qe("play-button","Play/Pause",I("icon-play","Play"),"bg-blue-600","hover:bg-blue-700"),qe("stop-button","Stop",I("icon-stop","Stop"),"bg-blue-600","hover:bg-blue-700"),lt("4"),qe("record-button","Record",I("icon-record","Record"),"bg-red-600","hover:bg-red-700"),lt("4"),i.element,lt("4"),$s()),y("div",{class:"flex items-center gap-4 px-3 py-2 rounded-xl bg-gray-900/80 backdrop-blur-sm shadow-md"},y("div",{class:"flex flex-col items-start gap-1"},X("Key"),e.trigger),y("div",{class:"flex flex-col items-start gap-1"},X("Tempo"),gi({id:"tempo-input",min:20,max:300,value:120})),y("div",{class:"flex flex-col items-start gap-1"},X("Measures"),gi({id:"measures-input",min:1,max:1e3,value:8})),y("div",{class:"flex flex-col items-start gap-1"},X("Beats"),gi({id:"beats-per-measure-input",min:1,max:16,value:4}))),$s(),y("div",{class:"flex items-center gap-2"},lt("4"),qe("save-button","Save",I("icon-save","Save"),"bg-green-600","hover:bg-green-700"),qe("load-button","Load",I("icon-load","Load"),"bg-yellow-600","hover:bg-yellow-700"),lt("4"),qe("config-button","User Settings",I("icon-user-settings","Settings"),"bg-purple-600","hover:bg-purple-700"))),refreshToggles:()=>{e.refreshUI()}}}const wu=fe("static/svg/icon-caret-up.svg"),Mu=fe("static/svg/icon-caret-down.svg");function xu(i){var d;const e=()=>{},t=(d=i.querySelector("#global-mini-contour"))==null?void 0:d.parentElement,s=i.querySelector("#global-mini-collapse-btn"),n=i.querySelector("#global-mini-collapse-icon"),r=300,a=75;let o=!0;const l=()=>{if(!t||!s||!n)return;o=!o,t.style.height=o?`${a}px`:`${r}px`,t.querySelectorAll("canvas").forEach(u=>{u.style.height=o?`${a}px`:`${r}px`}),n.src=o?wu:Mu,s.title=o?"Expand Mini Contour":"Collapse Mini Contour"};return s==null||s.addEventListener("click",l),{detach:()=>{s==null||s.removeEventListener("click",l)},refreshUI:e}}function zs(i,e={}){const{beatsPerBar:t=4,stepsPerBeat:s=4,quantizeDurations:n=!0,ignoreVelocity:r=!1}=e,a=[],o=[...i].sort((d,c)=>d.start-c.start);let l=-1;for(const d of o){const c=Math.floor(d.start/t),u=d.start%t,f=Math.round(u*s);c!==l&&(a.push({type:"Bar",value:c}),l=c),a.push({type:"Position",value:f}),a.push({type:"Pitch",value:d.pitch});const h=n?Math.max(1,Math.round(d.duration*s)):d.duration;if(a.push({type:"Duration",value:h}),!r){const m=d.velocity??100;a.push({type:"Velocity",value:m})}}return a}function Lu(i,e={}){const{beatsPerBar:t=4,stepsPerBeat:s=4,quantizeDurations:n=!0,ignoreVelocity:r=!1}=e;let a=0,o=0,l=!1;const d=[];for(let c=0;c<i.length;c++){const u=i[c];switch(u.type){case"Bar":a=u.value;break;case"Position":o=u.value,l=!0;break;case"Pitch":{if(!l){E(`REMI decode: Pitch token at index ${c} has no preceding Position`,u,"warn");continue}const f=i[c+1],h=p=>typeof p=="number"&&!Number.isNaN(p)&&Number.isFinite(p);if(!f||f.type!=="Duration"||!h(f.value)){E(`REMI decode: Missing or invalid Duration token after Pitch at index ${c}`,{pitchToken:u,durationToken:f},"warn");continue}let m=100;if(!r){const p=i[c+2];if(!p||p.type!=="Velocity"||!h(p.value)){E(`REMI decode: Missing or invalid Velocity token after Duration at index ${c}`,{pitchToken:u,velocityToken:p},"warn");continue}m=p.value}const b=a*t+o/s,g=n?f.value/s:f.value;d.push({pitch:u.value,start:b,duration:g,velocity:m}),l=!1,c+=r?1:2;break}}}return d}function ku(i,e,t,s){const n=i.filter(h=>h.start+h.duration<=e),r=i.filter(h=>h.start>=e),a=n.sort((h,m)=>Math.abs(h.start-e)-Math.abs(m.start-e)),o=r.sort((h,m)=>Math.abs(h.start-e)-Math.abs(m.start-e)),l=[],d=[];let c=0,u=0,f=0;for(;c<t&&(u<a.length||f<o.length);){if(u<a.length){const h=a[u++];if(l.push(h),c+=h.duration,c>=t)break}if(f<o.length){const h=o[f++];d.push(h),c+=h.duration}}return l.sort((h,m)=>h.start-m.start),{beforeRemi:zs(l,s),afterRemi:zs(d,s)}}function Au(i,e,t,s,n){const r=[];let a=0,o=null,l=!1;E("[AutoComplete] Clipping LLM Continuation:",{llmContinuationRemi:i,clipAfterBar:e,clipAfterPosition:t,clipBeforeBar:s,clipBeforePosition:n});for(const d of i){if(d.type==="Bar"){o=d,a=d.value;continue}if(d.type==="Position"){const c=a>e||a===e&&d.value>=t,u=s===void 0||n===void 0||a<s||a===s&&d.value<n;if(l=c&&u,l&&(o&&(r.push(o),o=null),r.push(d)),s!==void 0&&n!==void 0&&!u){E("[AutoComplete] Reached clipBefore boundary. Stopping further clipping.");break}continue}l&&r.push(d)}return E("[AutoComplete] Final Clipped LLM Continuation:",r),r}function Bu(i,e,t){const s=i.notes,n=ae();if(e>=n)return E("[AutoComplete] fromBeat is at or beyond song end. No space for continuation."),!1;const r=Math.min(e+t,n);return!s.some(o=>{const l=o.start,d=o.start+o.duration;return l<r&&d>e})}function Gu(i,e,t){const s=e*t,n=[];let r=0;for(const a of i){if(a.type==="Bar"){r=a.value,n.push(a);continue}if(a.type==="Position"){const o=a.value,l=Math.floor(o/s),d=o%s,c=r+l,u=n[n.length-1];(!u||u.type!=="Bar"||u.value!==c)&&n.push({type:"Bar",value:c}),n.push({type:"Position",value:d})}else n.push(a)}return n}const Eu="llmSettings",Tu={promptTuning:{styleInstruction:"",additionalInstructions:"",avoidStyles:""},context:{useMultiTrackContext:!0,contextBeats:32}};let Iu=Qe(Eu)??Tu;function Ot(){return Iu}function Nn(){return{beatsPerBar:Oe(),stepsPerBeat:4,quantizeDurations:!0,ignoreVelocity:!0}}function wn(i){const t=Ot().context.contextBeats,s=ji(),n=i.notes;if(s!==null){const d=Math.ceil(s);return[Math.max(0,d-t),d]}if(n.length===0)return[0,t];const r=n.reduce((d,c)=>{const u=d.start+d.duration;return c.start+c.duration>u?c:d}),a=r.start+r.duration,o=Math.ceil(a);return[Math.max(0,o-t),o]}function Ru(i,e,t){const s=Math.floor(i/e),n=Math.round(i%e*t);return E("[AutoComplete] Computed Clip Boundary:",{endBeat:i,beatsPerBar:e,stepsPerBeat:t,clipAfterBar:s,clipAfterPosition:n}),{clipAfterBar:s,clipAfterPosition:n}}function Pu(i){const[,e]=wn(i),t=Nn(),s=(t==null?void 0:t.beatsPerBar)??4;return Math.floor(e/s)}function Ou(i,e){const s=i.notes.filter(n=>n.start>=e).sort((n,r)=>n.start-r.start)[0];return s?s.start:null}function Fu(i,e,t){const s=Math.floor(i/e),n=Math.round(i%e*t);return{bar:s,position:n}}function Du(i){if(!i||typeof i!="string"||!i.trim())return"Unknown Key";const e=i.trim();if(e.length===1)return`${e.toUpperCase()} Major`;const t=e.slice(-1),s=e.slice(0,-1);return s?t==="m"?`${s.toUpperCase()} Minor`:`${s.toUpperCase()} Major`:"Unknown Key"}class Uu{logPrompt(e){E(`[${this.name}] Generated Prompt:`,e)}}class qu extends Uu{constructor(){super(...arguments),this.name="Remi Context Aware Autocomplete Prompt"}buildPrompt(e,t){const{continuationBeats:s,llmSettings:n}=t,{styleInstruction:r}=n.promptTuning,{beforeRemi:a,afterRemi:o}=e,l=u=>u.map(f=>`${f.type} ${f.value}`).join(" "),c=["Song Key:",Du(as()),...r?["","STYLE INSTRUCTION:",r]:[],"Earlier section of song:",a.length>0?l(a):"(empty)","","Later section of song:",o.length>0?l(o):"(empty)","",`${s} beat CONTINUATION:`].join(`
`);return this.logPrompt(c),c}}const Ku=Ie.object({type:Ie.enum(["Bar","Position","Pitch","Duration","Velocity"],{description:"The REMI token type"}),value:Ie.union([Ie.string(),Ie.number()],{description:"The token value (Pitch is string, others are numbers)"})}),$u=Ie.object({result:Ie.array(Ku,{description:"REMI token sequence"})}),zu={name:"remi_tokens",schema:$u};function Hu(i){const e=[];for(const n of i){const r=n.trim();if(r.includes("_")){const d=ju(r);if(d.length>0){e.push(...d);continue}}if(r.includes("|")){const d=Wu(r);if(d.length>0){e.push(...d);continue}}const a=Ju(n);if(a.length>0){e.push(...a);continue}const o=r.match(/^([A-Za-z]+)=(.+)$/);if(o){const[,d,c]=o;e.push(`${d.trim()} ${c.trim()}`);continue}const l=r.match(/^([A-Ga-g])[:](\d)$/);if(l){const[,d,c]=l;e.push(`Pitch ${d.toUpperCase()}${c}`);continue}if(r.includes(":")){const d=r.split(":");if(d.length===2&&d[0]&&d[1]){e.push(`${d[0].trim()} ${d[1].trim()}`);continue}}if(n.match(/(Bar_|Position_|Pitch_|Duration_|Velocity_|Pos_|Vel_|Dur_)/i)){const d=n.split(/(?=Bar_|Position_|Pitch_|Duration_|Velocity_|Pos_|Vel_|Dur_)/i);e.push(...d.map(c=>c.replace(/_/g," ").trim()).filter(Boolean));continue}if(n.match(/(Bar\s|Position\s|Pitch\s|Duration\s|Velocity\s|Pos\s|Vel\s|Dur\s)/i)&&n.split(" ").length>2){const d=n.split(/(?=Bar\s|Position\s|Pitch\s|Duration\s|Velocity\s|Pos\s|Vel\s|Dur\s)/i);e.push(...d.map(c=>c.trim()).filter(Boolean));continue}e.push(r)}const t={pos:"Position",vel:"Velocity",dur:"Duration"},s=[];for(let n=0;n<e.length;n++){const r=e[n],a=r.match(/^(pos|vel|dur|bar|position|pitch|duration|velocity)\s+(.+)$/i);if(a){const[,f,h]=a,m=t[f.toLowerCase()]||null,b=m||f[0].toUpperCase()+f.slice(1).toLowerCase();s.push(`${b} ${h}`);continue}const o=r,l=e[n+1],d=t[o.toLowerCase()]||null,c=o.match(/^(bar|position|pitch|duration|velocity)$/i),u=d||(c?c[0][0].toUpperCase()+c[0].slice(1).toLowerCase():null);if(u&&l!==void 0){s.push(`${u} ${l}`),n++;continue}s.push(r)}return s}function Ju(i){const e=[],t=i.trim(),s=t.match(/^([\d\.]+),(\d+),(\d+)/);if(s){const[,r,a,o]=s,l=Math.round(Number(r)*16);e.push(`Position ${l}`),e.push(`Velocity ${a}`),e.push(`Duration ${o}`)}const n=t.split("//");if(n.length>1){const a=n[1].trim().split(",").map(o=>o.trim()).filter(Boolean);e.push(...a)}return e}function Wu(i){const e=[],t=i.split("|").map(s=>s.trim()).filter(Boolean);for(let s=0;s<t.length;s+=2){const n=t[s],r=t[s+1];r&&(n.toLowerCase()==="track_info"||n.toLowerCase()==="inst"||e.push(`${n} ${r}`))}return e}function ju(i){const e=[],t=["bar","position","pos","pitch","duration","dur","velocity","vel"],s=i.split("_").filter(Boolean);for(let n=0;n<s.length-1;n++){const r=s[n].toLowerCase(),a=s[n+1];t.includes(r)&&(e.push(`${r} ${a}`),n++)}return e}function Xu(i){const e=Array.isArray(i)?i:i.split(/\s*[\n,]\s*/).filter(Boolean),t=[],s=Hu(e);for(const n of s){const r=n.match(/^(\w+)\s+(.+)$/);if(!r){if(/^\d+$/.test(n)){t.push({type:"Duration",value:Number(n)});continue}console.warn(`Invalid REMI token format: '${n}'`);continue}const[,a,o]=r;let l=a.charAt(0).toUpperCase()+a.slice(1).toLowerCase();if(!["Key","Inst","Tempo","Start","End"].includes(l))switch(l==="Note"&&(l="Pitch"),l){case"Bar":case"Position":case"Duration":case"Velocity":{const d=Number(o);if(isNaN(d)){console.warn(`Invalid numeric value in REMI token: '${n}'`);continue}t.push({type:l,value:d});break}case"Pitch":t.push({type:l,value:o});break;default:console.warn(`Unknown REMI token type: '${l}' in token '${n}'`);break}}return E("[RemiTokenParser] Parsed RemiEvents:",t),t}const Mn={parse(i){if(!i)throw new Error("REMI parse failed: result is null or undefined.");if(Array.isArray(i))return i;if(typeof i=="string")return Xu(i);throw new Error(`Unsupported REMI result type: ${typeof i}`)}},Vu={provider:"openai",tasks:{remi:{schema:zu,adapter:Mn.parse},chords:{schema:void 0,adapter:i=>i}}},Yu={provider:"anthropic",tasks:{remi:{schema:void 0,adapter:Mn.parse},chords:{schema:void 0,adapter:i=>i}}},Zu={openai:Vu,anthropic:Yu},Qu={"gpt-4o":"openai","gpt-4o-mini":"openai","gpt-4.1":"openai","o3-mini":"openai","o4-mini":"openai","claude-3":"anthropic","claude-3-opus":"anthropic","mistral-7b":"local","gemini-1.5":"google"},eh=Symbol("Let zodToJsonSchema decide on which parser to use"),Hs={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},th=i=>typeof i=="string"?{...Hs,basePath:["#"],definitions:{},name:i}:{...Hs,basePath:["#"],definitions:{},...i},Ei=i=>"_def"in i?i._def:i;function ih(i){if(!i)return!0;for(const e in i)return!1;return!0}const sh=i=>{const e=th(i),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([s,n])=>[Ei(n),{def:Ei(n),path:[...e.basePath,e.definitionPath,s],jsonSchema:void 0}]))}};function xn(i,e,t,s){s!=null&&s.errorMessages&&t&&(i.errorMessage={...i.errorMessage,[e]:t})}function K(i,e,t,s,n){i[e]=t,xn(i,e,s,n)}function rh(){return{}}function nh(i,e){var s,n;const t={type:"array"};return((n=(s=i.type)==null?void 0:s._def)==null?void 0:n.typeName)!==T.ZodAny&&(t.items=D(i.type._def,{...e,currentPath:[...e.currentPath,"items"]})),i.minLength&&K(t,"minItems",i.minLength.value,i.minLength.message,e),i.maxLength&&K(t,"maxItems",i.maxLength.value,i.maxLength.message,e),i.exactLength&&(K(t,"minItems",i.exactLength.value,i.exactLength.message,e),K(t,"maxItems",i.exactLength.value,i.exactLength.message,e)),t}function ah(i,e){const t={type:"integer",format:"int64"};if(!i.checks)return t;for(const s of i.checks)switch(s.kind){case"min":e.target==="jsonSchema7"?s.inclusive?K(t,"minimum",s.value,s.message,e):K(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),K(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?K(t,"maximum",s.value,s.message,e):K(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),K(t,"maximum",s.value,s.message,e));break;case"multipleOf":K(t,"multipleOf",s.value,s.message,e);break}return t}function oh(){return{type:"boolean"}}function lh(i,e){return D(i.type._def,e)}const ch=(i,e)=>D(i.innerType._def,e);function Ln(i,e,t){const s=t??e.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((n,r)=>Ln(i,e,n))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return dh(i,e)}}const dh=(i,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const s of i.checks)switch(s.kind){case"min":K(t,"minimum",s.value,s.message,e);break;case"max":K(t,"maximum",s.value,s.message,e);break}return t};function uh(i,e){return{...D(i.innerType._def,e),default:i.defaultValue()}}function hh(i,e,t){return e.effectStrategy==="input"?D(i.schema._def,e,t):{}}function fh(i){return{type:"string",enum:[...i.values]}}const ph=i=>"type"in i&&i.type==="string"?!1:"allOf"in i;function mh(i,e){const t=[D(i.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),D(i.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(r=>!!r);let s=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const n=[];return t.forEach(r=>{if(ph(r))n.push(...r.allOf),r.unevaluatedProperties===void 0&&(s=void 0);else{let a=r;if("additionalProperties"in r&&r.additionalProperties===!1){const{additionalProperties:o,...l}=r;a=l}else s=void 0;n.push(a)}}),n.length?{allOf:n,...s}:void 0}function yh(i,e){const t=typeof i.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(i.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[i.value]}:{type:t==="bigint"?"integer":t,const:i.value}}let vi;const Te={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(vi===void 0&&(vi=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),vi),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function kn(i,e){const t={type:"string"};function s(n){return e.patternStrategy==="escape"?gh(n):n}if(i.checks)for(const n of i.checks)switch(n.kind){case"min":K(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e);break;case"max":K(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"email":switch(e.emailStrategy){case"format:email":le(t,"email",n.message,e);break;case"format:idn-email":le(t,"idn-email",n.message,e);break;case"pattern:zod":ce(t,Te.email,n.message,e);break}break;case"url":le(t,"uri",n.message,e);break;case"uuid":le(t,"uuid",n.message,e);break;case"regex":ce(t,n.regex,n.message,e);break;case"cuid":ce(t,Te.cuid,n.message,e);break;case"cuid2":ce(t,Te.cuid2,n.message,e);break;case"startsWith":ce(t,RegExp(`^${s(n.value)}`),n.message,e);break;case"endsWith":ce(t,RegExp(`${s(n.value)}$`),n.message,e);break;case"datetime":le(t,"date-time",n.message,e);break;case"date":le(t,"date",n.message,e);break;case"time":le(t,"time",n.message,e);break;case"duration":le(t,"duration",n.message,e);break;case"length":K(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,n.value):n.value,n.message,e),K(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,n.value):n.value,n.message,e);break;case"includes":{ce(t,RegExp(s(n.value)),n.message,e);break}case"ip":{n.version!=="v6"&&le(t,"ipv4",n.message,e),n.version!=="v4"&&le(t,"ipv6",n.message,e);break}case"emoji":ce(t,Te.emoji,n.message,e);break;case"ulid":{ce(t,Te.ulid,n.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{le(t,"binary",n.message,e);break}case"contentEncoding:base64":{K(t,"contentEncoding","base64",n.message,e);break}case"pattern:zod":{ce(t,Te.base64,n.message,e);break}}break}case"nanoid":ce(t,Te.nanoid,n.message,e)}return t}const gh=i=>Array.from(i).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),le=(i,e,t,s)=>{var n;i.format||(n=i.anyOf)!=null&&n.some(r=>r.format)?(i.anyOf||(i.anyOf=[]),i.format&&(i.anyOf.push({format:i.format,...i.errorMessage&&s.errorMessages&&{errorMessage:{format:i.errorMessage.format}}}),delete i.format,i.errorMessage&&(delete i.errorMessage.format,Object.keys(i.errorMessage).length===0&&delete i.errorMessage)),i.anyOf.push({format:e,...t&&s.errorMessages&&{errorMessage:{format:t}}})):K(i,"format",e,t,s)},ce=(i,e,t,s)=>{var n;i.pattern||(n=i.allOf)!=null&&n.some(r=>r.pattern)?(i.allOf||(i.allOf=[]),i.pattern&&(i.allOf.push({pattern:i.pattern,...i.errorMessage&&s.errorMessages&&{errorMessage:{pattern:i.errorMessage.pattern}}}),delete i.pattern,i.errorMessage&&(delete i.errorMessage.pattern,Object.keys(i.errorMessage).length===0&&delete i.errorMessage)),i.allOf.push({pattern:Js(e,s),...t&&s.errorMessages&&{errorMessage:{pattern:t}}})):K(i,"pattern",Js(e,s),t,s)},Js=(i,e)=>{var d;const t=typeof i=="function"?i():i;if(!e.applyRegexFlags||!t.flags)return t.source;const s={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},n=s.i?t.source.toLowerCase():t.source;let r="",a=!1,o=!1,l=!1;for(let c=0;c<n.length;c++){if(a){r+=n[c],a=!1;continue}if(s.i){if(o){if(n[c].match(/[a-z]/)){l?(r+=n[c],r+=`${n[c-2]}-${n[c]}`.toUpperCase(),l=!1):n[c+1]==="-"&&((d=n[c+2])!=null&&d.match(/[a-z]/))?(r+=n[c],l=!0):r+=`${n[c]}${n[c].toUpperCase()}`;continue}}else if(n[c].match(/[a-z]/)){r+=`[${n[c]}${n[c].toUpperCase()}]`;continue}}if(s.m){if(n[c]==="^"){r+=`(^|(?<=[\r
]))`;continue}else if(n[c]==="$"){r+=`($|(?=[\r
]))`;continue}}if(s.s&&n[c]==="."){r+=o?`${n[c]}\r
`:`[${n[c]}\r
]`;continue}r+=n[c],n[c]==="\\"?a=!0:o&&n[c]==="]"?o=!1:!o&&n[c]==="["&&(o=!0)}try{const c=new RegExp(r)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return r};function An(i,e){var s,n,r,a;if(e.target==="openApi3"&&((s=i.keyType)==null?void 0:s._def.typeName)===T.ZodEnum)return{type:"object",required:i.keyType._def.values,properties:i.keyType._def.values.reduce((o,l)=>({...o,[l]:D(i.valueType._def,{...e,currentPath:[...e.currentPath,"properties",l]})??{}}),{}),additionalProperties:!1};const t={type:"object",additionalProperties:D(i.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return t;if(((n=i.keyType)==null?void 0:n._def.typeName)===T.ZodString&&((r=i.keyType._def.checks)!=null&&r.length)){const o=Object.entries(kn(i.keyType._def,e)).reduce((l,[d,c])=>d==="type"?l:{...l,[d]:c},{});return{...t,propertyNames:o}}else if(((a=i.keyType)==null?void 0:a._def.typeName)===T.ZodEnum)return{...t,propertyNames:{enum:i.keyType._def.values}};return t}function bh(i,e){if(e.mapStrategy==="record")return An(i,e);const t=D(i.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},s=D(i.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,s],minItems:2,maxItems:2}}}function _h(i){const e=i.values,s=Object.keys(i.values).filter(r=>typeof e[e[r]]!="number").map(r=>e[r]),n=Array.from(new Set(s.map(r=>typeof r)));return{type:n.length===1?n[0]==="string"?"string":"number":["string","number"],enum:s}}function vh(){return{not:{}}}function Sh(i){return i.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const Kt={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Ch(i,e){if(e.target==="openApi3")return Ws(i,e);const t=i.options instanceof Map?Array.from(i.options.values()):i.options;if(t.every(s=>s._def.typeName in Kt&&(!s._def.checks||!s._def.checks.length))){const s=t.reduce((n,r)=>{const a=Kt[r._def.typeName];return a&&!n.includes(a)?[...n,a]:n},[]);return{type:s.length>1?s:s[0]}}else if(t.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=t.reduce((n,r)=>{const a=typeof r._def.value;switch(a){case"string":case"number":case"boolean":return[...n,a];case"bigint":return[...n,"integer"];case"object":if(r._def.value===null)return[...n,"null"];case"symbol":case"undefined":case"function":default:return n}},[]);if(s.length===t.length){const n=s.filter((r,a,o)=>o.indexOf(r)===a);return{type:n.length>1?n:n[0],enum:t.reduce((r,a)=>r.includes(a._def.value)?r:[...r,a._def.value],[])}}}else if(t.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((s,n)=>[...s,...n._def.values.filter(r=>!s.includes(r))],[])};return Ws(i,e)}const Ws=(i,e)=>{const t=(i.options instanceof Map?Array.from(i.options.values()):i.options).map((s,n)=>D(s._def,{...e,currentPath:[...e.currentPath,"anyOf",`${n}`]})).filter(s=>!!s&&(!e.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return t.length?{anyOf:t}:void 0};function Nh(i,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(i.innerType._def.typeName)&&(!i.innerType._def.checks||!i.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:Kt[i.innerType._def.typeName],nullable:!0}:{type:[Kt[i.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const s=D(i.innerType._def,{...e,currentPath:[...e.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const t=D(i.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function wh(i,e){const t={type:"number"};if(!i.checks)return t;for(const s of i.checks)switch(s.kind){case"int":t.type="integer",xn(t,"type",s.message,e);break;case"min":e.target==="jsonSchema7"?s.inclusive?K(t,"minimum",s.value,s.message,e):K(t,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(t.exclusiveMinimum=!0),K(t,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?K(t,"maximum",s.value,s.message,e):K(t,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(t.exclusiveMaximum=!0),K(t,"maximum",s.value,s.message,e));break;case"multipleOf":K(t,"multipleOf",s.value,s.message,e);break}return t}function Mh(i,e){return e.removeAdditionalStrategy==="strict"?i.catchall._def.typeName==="ZodNever"?i.unknownKeys!=="strict":D(i.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:i.catchall._def.typeName==="ZodNever"?i.unknownKeys==="passthrough":D(i.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function xh(i,e){const t={type:"object",...Object.entries(i.shape()).reduce((s,[n,r])=>{if(r===void 0||r._def===void 0)return s;const a=[...e.currentPath,"properties",n],o=D(r._def,{...e,currentPath:a,propertyPath:a});return o===void 0?s:(e.openaiStrictMode&&r.isOptional()&&!r.isNullable()&&console.warn(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required
This will become an error in a future version of the SDK.`),{properties:{...s.properties,[n]:o},required:r.isOptional()&&!e.openaiStrictMode?s.required:[...s.required,n]})},{properties:{},required:[]}),additionalProperties:Mh(i,e)};return t.required.length||delete t.required,t}const Lh=(i,e)=>{var s;if(e.currentPath.toString()===((s=e.propertyPath)==null?void 0:s.toString()))return D(i.innerType._def,e);const t=D(i.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},kh=(i,e)=>{if(e.pipeStrategy==="input")return D(i.in._def,e);if(e.pipeStrategy==="output")return D(i.out._def,e);const t=D(i.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),s=D(i.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,s].filter(n=>n!==void 0)}};function Ah(i,e){return D(i.type._def,e)}function Bh(i,e){const s={type:"array",uniqueItems:!0,items:D(i.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return i.minSize&&K(s,"minItems",i.minSize.value,i.minSize.message,e),i.maxSize&&K(s,"maxItems",i.maxSize.value,i.maxSize.message,e),s}function Gh(i,e){return i.rest?{type:"array",minItems:i.items.length,items:i.items.map((t,s)=>D(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[]),additionalItems:D(i.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:i.items.length,maxItems:i.items.length,items:i.items.map((t,s)=>D(t._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((t,s)=>s===void 0?t:[...t,s],[])}}function Eh(){return{not:{}}}function Th(){return{}}const Ih=(i,e)=>D(i.innerType._def,e);function D(i,e,t=!1){var a;const s=e.seen.get(i);if(e.override){const o=(a=e.override)==null?void 0:a.call(e,i,e,s,t);if(o!==eh)return o}if(s&&!t){const o=Rh(s,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}const n={def:i,path:e.currentPath,jsonSchema:void 0};e.seen.set(i,n);const r=Oh(i,i.typeName,e,t);return r&&Fh(i,e,r),n.jsonSchema=r,r}const Rh=(i,e)=>{switch(e.$refStrategy){case"root":return{$ref:i.path.join("/")};case"extract-to-root":const t=i.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=i.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:Ph(e.currentPath,i.path)};case"none":case"seen":return i.path.length<e.currentPath.length&&i.path.every((s,n)=>e.currentPath[n]===s)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Ph=(i,e)=>{let t=0;for(;t<i.length&&t<e.length&&i[t]===e[t];t++);return[(i.length-t).toString(),...e.slice(t)].join("/")},Oh=(i,e,t,s)=>{switch(e){case T.ZodString:return kn(i,t);case T.ZodNumber:return wh(i,t);case T.ZodObject:return xh(i,t);case T.ZodBigInt:return ah(i,t);case T.ZodBoolean:return oh();case T.ZodDate:return Ln(i,t);case T.ZodUndefined:return Eh();case T.ZodNull:return Sh(t);case T.ZodArray:return nh(i,t);case T.ZodUnion:case T.ZodDiscriminatedUnion:return Ch(i,t);case T.ZodIntersection:return mh(i,t);case T.ZodTuple:return Gh(i,t);case T.ZodRecord:return An(i,t);case T.ZodLiteral:return yh(i,t);case T.ZodEnum:return fh(i);case T.ZodNativeEnum:return _h(i);case T.ZodNullable:return Nh(i,t);case T.ZodOptional:return Lh(i,t);case T.ZodMap:return bh(i,t);case T.ZodSet:return Bh(i,t);case T.ZodLazy:return D(i.getter()._def,t);case T.ZodPromise:return Ah(i,t);case T.ZodNaN:case T.ZodNever:return vh();case T.ZodEffects:return hh(i,t,s);case T.ZodAny:return rh();case T.ZodUnknown:return Th();case T.ZodDefault:return uh(i,t);case T.ZodBranded:return lh(i,t);case T.ZodReadonly:return Ih(i,t);case T.ZodCatch:return ch(i,t);case T.ZodPipeline:return kh(i,t);case T.ZodFunction:case T.ZodVoid:case T.ZodSymbol:return;default:return(n=>{})()}},Fh=(i,e,t)=>(i.description&&(t.description=i.description,e.markdownDescription&&(t.markdownDescription=i.description)),t),Dh=(i,e)=>{const t=sh(e),s=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,n=D(i._def,s===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,s]},!1)??{},r=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;r!==void 0&&(n.title=r);const a=(()=>{if(ih(t.definitions))return;const l={},d=new Set;for(let c=0;c<500;c++){const u=Object.entries(t.definitions).filter(([f])=>!d.has(f));if(u.length===0)break;for(const[f,h]of u)l[f]=D(Ei(h),{...t,currentPath:[...t.basePath,t.definitionPath,f]},!0)??{},d.add(f)}return l})(),o=s===void 0?a?{...n,[t.definitionPath]:a}:n:t.nameStrategy==="duplicate-ref"?{...n,...a||t.seenRefs.size?{[t.definitionPath]:{...a,...t.seenRefs.size?{[s]:n}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...a,[s]:n}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function Uh(i,e){return Dh(i,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function qh(i,e,t){return Hn({type:"json_schema",...t,name:e,strict:!0,schema:Uh(i,{name:e})},s=>i.parse(JSON.parse(s)))}async function Kh(i,e,t){const s=or();if(!s)throw new Error("OpenAI API key is not set.");const r=await new Jn({apiKey:s,dangerouslyAllowBrowser:!0}).responses.parse({model:e,input:[{role:"user",content:i}],text:{format:qh(t.schema,t.name)}});return E("[OpenAI] Raw Output:",r),r.output_parsed}async function $h(i,e){return E("[Anthropic] Simulated call:",{model:e,prompt:i}),{result:[{type:"Bar",value:1},{type:"Pitch",value:"C4"},{type:"Duration",value:4}]}}function zh(i){return typeof i=="object"&&i!==null&&"result"in i}async function Hh(i,e,t){const s=Qu[i];if(!s)throw new Error(`Unknown provider for model: ${i}`);const n=Zu[s],r=n.tasks[t];if(!r)throw new Error(`Provider ${n.provider} does not support task: ${t}`);let a;switch(n.provider){case"openai":if(!r.schema)throw new Error(`Task ${t} requires a schema for OpenAI models.`);a=await Kh(e,i,r.schema);break;case"anthropic":a=await $h(e,i);break;default:throw new Error(`Provider ${n.provider} not implemented.`)}const o=zh(a)?a.result:a;return E("[LLMCaller] Raw Result:",o),r.adapter(o)}async function Jh(i,e){return Hh(i,e,"remi")}function Wh(i,e,t,s){const n=i.find(h=>h.type==="Position");if(!n)return i;const r=i.indexOf(n),a=[...i].slice(0,r+1).reverse().find(h=>h.type==="Bar"),o=(a==null?void 0:a.value)??0,l=n.value,d=o*t+l/s,c=e-d,u=[];let f=0;for(const h of i){if(h.type==="Bar"){f=h.value;continue}if(h.type==="Position"){const b=f*t+h.value/s+c,g=Math.floor(b/t),p=Math.round(b%t*s);let _;for(let S=u.length-1;S>=0;S--)if(u[S].type==="Bar"){_=u[S];break}(!_||_.value!==g)&&u.push({type:"Bar",value:g}),u.push({type:"Position",value:p});continue}u.push(h)}return u}async function js(i="unknown"){var a,o,l,d,c;if(ml()){E("[AutoComplete] Ignored request: pipeline is already running.");return}At(!0);const e=ei();if(e===null){console.warn("No active sequencer to apply autocomplete to."),At(!1);return}const t=Ye(e);if(!t){console.error(`Sequencer with id ${e} not found.`),At(!1);return}au(),Ct(),De(),(a=t.matrix)==null||a.invalidateAIAutocompleteRenderer();const[s,n]=wn(t);E(`[AutoComplete] Running autocomplete for beats ${s} to ${n} on sequencer ${e} via ${i}`);const r=Pu(t);(o=t.matrix)==null||o.setActiveAutocompleteBar(r),(l=t.matrix)==null||l.startAIAutocompleteAnimationLoop();try{await jh(e,n)}catch(u){console.error("Autocomplete failed:",u)}finally{ou(),Ve().length===0&&(E("[AutoComplete] No preview notes generated. Stopping animation loop."),(d=t.matrix)==null||d.stopAIAutocompleteAnimationLoop()),(c=t.matrix)==null||c.setActiveAutocompleteBar(null),At(!1)}}async function jh(i,e,t="gpt-4o",s=4){E("[AutoComplete] Running REMI Continuation Pipeline with LLM settings:",Ot());const n=Ye(i);if(!n){console.error(`Sequencer with id ${i} not found.`);return}if(!Bu(n,e,s)){E("[AutoComplete] No available gap for REMI continuation. Aborting autocomplete.");return}const r=Ot().context.contextBeats,a=Nn(),o=ku(n.notes,e,r,a),d=new qu().buildPrompt(o,{continuationBeats:s,llmSettings:Ot()}),c=a.beatsPerBar??4,u=a.stepsPerBeat??4,f=2;for(let h=1;h<=f;h++){const m=await Jh(t,d);E("[AutoComplete] Raw LLM Continuation:",m);const b=Gu(m,c,u),g=Wh(b,e,c,u),{clipAfterBar:p,clipAfterPosition:_}=Ru(e,c,u),S=Ou(n,e);let v,C;S!==null&&({bar:v,position:C}=Fu(S,c,u));const N=Au(g,p,_,v,C),w=Lu(N,a);if(E(`[AutoComplete] Attempt ${h}: Decoded Notes:`,w),w.length>0){E("[AutoComplete] Final Decoded Notes:",w),yl(w),De();const L=Ye(i);L&&L.redraw();return}E(`[AutoComplete] Attempt ${h}: No new notes after clip boundary. Retrying...`)}E("[AutoComplete] All retry attempts failed to generate new continuation notes.")}function Xh(i){var s,n;const e=Ve();O(jt(i,e),Xt(i,e)),Ct(),De();const t=Ye(i);t?((s=t.matrix)==null||s.stopAIAutocompleteAnimationLoop(),(n=t.matrix)==null||n.playNoteAcceptanceAnimation(e)):console.warn(`Could not stop AI animation: sequencer ${i} not found.`)}function Vh(i){const{rootElement:e,noteOptionsGroup:t,aiOptionsGroup:s}=i,n=e.querySelectorAll("button[data-value]"),r=e.querySelector("#dotted-note-btn"),a=e.querySelector("#triplet-note-btn"),o=e.querySelector("#note-mode-btn"),l=e.querySelector("#ai-mode-btn"),d=e.querySelector("#autocomplete-toggle-btn"),c=e.querySelector("#autocomplete-approve-btn"),u=e.querySelector("#autocomplete-reject-btn"),f=e.querySelector("#ai-tools-btn"),h=e.querySelector("#ai-extend-before-btn"),m=e.querySelector("#ai-paint-btn"),b=e.querySelector("#ai-extend-after-btn"),g=e.querySelector("#ai-adjust-prompt-btn"),p=e.querySelector("#ai-debugger-btn"),_=M=>{if(M==="ai"&&!or()){Q().showOpenAIKeyNotSet();return}const x=M==="note";t.classList.toggle("hidden",!x),s.classList.toggle("hidden",x),o==null||o.classList.toggle("bg-blue-600",x),o==null||o.classList.toggle("bg-gray-800",!x),l==null||l.classList.toggle("bg-purple-700",!x),l==null||l.classList.toggle("bg-gray-800",x)};o==null||o.addEventListener("click",()=>_("note")),l==null||l.addEventListener("click",()=>_("ai")),d==null||d.addEventListener("click",M=>{M.button===0&&js("GlobalToolbarListeners")}),d==null||d.addEventListener("contextmenu",M=>{M.preventDefault(),_s()}),c==null||c.addEventListener("click",()=>{const M=ei();if(M===null){console.warn("No active sequencer to apply autocomplete to.");return}Xh(M)}),f==null||f.addEventListener("click",()=>{Q().showFeatureBlocked()}),h==null||h.addEventListener("click",()=>{Q().showFeatureBlocked()}),m==null||m.addEventListener("click",()=>{Q().showFeatureBlocked()}),b==null||b.addEventListener("click",()=>{Q().showFeatureBlocked()}),g==null||g.addEventListener("click",()=>{Q().showFeatureBlocked()}),p==null||p.addEventListener("click",()=>{Q().showFeatureBlocked()});const S=()=>{const M=Qt(),x=Sd();n.forEach(G=>{const P=parseFloat(G.dataset.value??"-1");G.classList.remove("bg-purple-700","bg-blue-700","bg-gray-800"),G.classList.add("bg-transparent"),P===x?(G.classList.add("bg-purple-700"),G.classList.remove("bg-transparent")):P===M?(G.classList.add("bg-blue-700"),G.classList.remove("bg-transparent")):G.classList.add("bg-gray-800")})},v=Yt(M=>{S(),r==null||r.classList.toggle("bg-purple-700",M.isDottedMode),r==null||r.classList.toggle("bg-transparent",!M.isDottedMode),a==null||a.classList.toggle("bg-purple-700",M.isTripletMode),a==null||a.classList.toggle("bg-transparent",!M.isTripletMode),N(M.noteDuration,!1)}),C=pl(M=>{d==null||d.classList.toggle("bg-pink-400",M),d==null||d.classList.toggle("bg-transparent",!M)}),N=(M,x=!0)=>{const G=Us(),P=Gi();let R=M;G?R*=1.5:P&&(R*=2/3),wt.currentDuration=R,J().forEach(oe=>{var Ae;oe.config.currentDuration=R,(Ae=oe.matrix)==null||Ae.requestRedraw()}),vd(M,x)},w=(M=!0)=>{const x=e.querySelector("button[data-value].bg-purple-700");if(x){const G=parseFloat(x.dataset.value);N(G,M)}},L=()=>{S()};n.forEach(M=>{M.classList.add("note-duration-btn"),M.addEventListener("click",x=>{if(x.button===0){const G=parseFloat(M.dataset.value);N(G)}}),M.addEventListener("contextmenu",x=>{x.preventDefault();const G=parseFloat(M.dataset.value);Fs(G,!0)})}),a==null||a.addEventListener("click",()=>{const M=!Gi();Ds(M,!1),w(!1)}),r==null||r.addEventListener("click",()=>{const M=!Us();Ds(!1,M),w(!1)});const k=M=>{const x=M.target;if(x.tagName==="INPUT"||x.tagName==="TEXTAREA"||x.isContentEditable||Re())return;const G={ApplyDuration1:4,ApplyDuration2:2,ApplyDuration3:1,ApplyDuration4:.5,ApplyDuration5:.25,ApplyDuration6:.125},P={ApplySnap1:4,ApplySnap2:2,ApplySnap3:1,ApplySnap4:.5,ApplySnap5:.25,ApplySnap6:.125};for(const[R,$]of Object.entries(P))if(q(M,R)){M.preventDefault(),Fs($,!0);return}for(const[R,$]of Object.entries(G))if(q(M,R)){M.preventDefault(),N($);return}if(q(M,"ToggleDottedNotes")){M.preventDefault(),r==null||r.click();return}if(q(M,"ToggleTripletNotes")){M.preventDefault(),a==null||a.click();return}if(q(M,"AIStartAutocomplete")){M.preventDefault(),ru()||js("GlobalToolbarListeners");return}if(q(M,"ToggleAIMode")){M.preventDefault(),_s();return}if(q(M,"ApproveAutocomplete")){M.preventDefault(),c==null||c.click();return}if(q(M,"RejectAutocomplete")){M.preventDefault(),Ct(),Ad();return}if(q(M,"SwitchToNoteMode")){M.preventDefault(),o==null||o.click();return}if(q(M,"SwitchToAIMode")){M.preventDefault(),l==null||l.click();return}};return window.addEventListener("keydown",k),L(),{detach:()=>{window.removeEventListener("keydown",k),v(),C(),[o,l,d,c,u,f,h,m,b,g,p].forEach(P=>{P&&P.replaceWith(P.cloneNode(!0))}),n.forEach(P=>{const R=P.cloneNode(!0);P.replaceWith(R)});const x=r==null?void 0:r.cloneNode(!0);x&&(r!=null&&r.parentNode)&&r.parentNode.replaceChild(x,r);const G=a==null?void 0:a.cloneNode(!0);G&&(a!=null&&a.parentNode)&&a.parentNode.replaceChild(G,a)},refreshUI:L}}function Yh(i,e){const t=i.querySelector("#footer-help-btn"),s=i.querySelector("#footer-whats-new-btn"),n=()=>{},r=()=>{window.open("https://github.com/alacrity-ai/sequenzia","_blank")},a=()=>{e.show()};return t==null||t.addEventListener("click",r),s==null||s.addEventListener("click",a),{detach:()=>{t==null||t.removeEventListener("click",r),s==null||s.removeEventListener("click",a)},refreshUI:n}}function Zh(i,e,t,s,n){const r=i.querySelector("#play-button"),a=i.querySelector("#stop-button"),o=i.querySelector("#record-button"),l=i.querySelector("#loop-toggle"),d=i.querySelector("#tempo-input"),c=i.querySelector("#measures-input"),u=i.querySelector("#beats-per-measure-input"),f=i.querySelector("#save-button"),h=i.querySelector("#load-button"),m=i.querySelector("#config-button"),b=x=>{if(!r)return;r.classList.toggle("bg-blue-800",x),r.classList.toggle("bg-blue-600",!x);const G=x?"icon-pause":"icon-play",P=fe(`static/svg/${G}.svg`),R=r.querySelector("img");if((R==null?void 0:R.getAttribute("src"))!==P){const $=I(G,x?"Pause":"Play");R?r.replaceChild($,R):r.appendChild($)}},g=()=>{b(e.isPlaying())};e.setOnStopCallback(()=>{b(!1)});const p=()=>{const x=!e.isPlaying();e.toggle(),b(x)},_=()=>{e.stop(),b(!1)},S=()=>{},v=()=>{const x=d==null?void 0:d.valueAsNumber;x&&x>=20&&x<=300&&is(x,!0)},C=()=>{const x=c==null?void 0:c.valueAsNumber;x&&x>=1&&x<=1e3&&rs(x,!0)},N=()=>{const x=u==null?void 0:u.valueAsNumber;x&&x>=1&&x<=16&&ss(x,!0)};Yt(x=>{d&&(d.value=String(x.tempo)),c&&(c.value=String(x.totalMeasures)),u&&(u.value=String(x.timeSignature[0]))});const w=()=>{Cd((l==null?void 0:l.checked)??!1)},L=()=>{s.show()},k=()=>{n.show()},B=()=>{t.show()},M=x=>{var R;const G=(R=document.activeElement)==null?void 0:R.tagName;if(!(G==="INPUT"||G==="TEXTAREA")){if(q(x,"TransportStop")){x.preventDefault(),_();return}if(q(x,"TransportPlay")){x.preventDefault(),p();return}}};return r==null||r.addEventListener("click",p),a==null||a.addEventListener("click",_),o==null||o.addEventListener("click",S),d==null||d.addEventListener("change",v),c==null||c.addEventListener("change",C),u==null||u.addEventListener("change",N),l==null||l.addEventListener("change",w),f==null||f.addEventListener("click",L),h==null||h.addEventListener("click",k),m==null||m.addEventListener("click",B),window.addEventListener("keydown",M),{detach:()=>{r==null||r.removeEventListener("click",p),a==null||a.removeEventListener("click",_),o==null||o.removeEventListener("click",S),d==null||d.removeEventListener("change",v),c==null||c.removeEventListener("change",C),u==null||u.removeEventListener("change",N),l==null||l.removeEventListener("change",w),f==null||f.removeEventListener("click",L),h==null||h.removeEventListener("click",k),m==null||m.removeEventListener("click",B),window.removeEventListener("keydown",M)},refreshUI:g}}let It=!1,de=null,Si=!1;function Qh(i){if(de=i.querySelector("#global-mini-playhead"),!de)throw new Error("Playhead canvas not found in container.");const e=W.getInstance(),t=(l,d=!0)=>{const c=ae(),u=Xr(l,wt),f=Math.max(0,Math.min(c,u)),h=e.isActive();if(e.seek(f),Xe(f),d&&h&&e.resume(),Vi(e,f),de){const m=window.devicePixelRatio||1,b=de.width/m,g=f/c*b;Nt(g)}_t()&&De()},s=l=>{if(!de)return;const d=window.devicePixelRatio||1,c=de.getBoundingClientRect(),u=de.width/d;let f=(l.clientX-c.left)*(u/c.width);f=Math.max(0,Math.min(u,f));const h=ae(),m=f/u*h;t(m,!1)},n=async l=>{e.isActive()&&(await e.pause(),Si=!0),It=!0,s(l)},r=l=>{It&&s(l)},a=l=>{It&&(s(l),It=!1,Si&&(e.resume(),Si=!1))},o=l=>{var h;const d=(h=document.activeElement)==null?void 0:h.tagName;if(d==="INPUT"||d==="TEXTAREA")return;const c=ae(),u=Oe();let f=e.getCurrentBeat();if(q(l,"SeekBackward")){l.preventDefault(),t(f-1);return}if(q(l,"SeekForward")){l.preventDefault(),t(f+1);return}if(q(l,"SeekMeasureBack")){l.preventDefault();const m=Math.floor(f),b=Math.floor(m/u)*u;f=m===b?Math.max(0,b-u):b,t(f);return}if(q(l,"SeekMeasureForward")){l.preventDefault();const m=Math.floor(f),g=Math.floor(m/u)*u+u;t(Math.min(c,g));return}};return de.addEventListener("mousedown",l=>void n(l)),window.addEventListener("mousemove",r),window.addEventListener("mouseup",a),window.addEventListener("keydown",o),{detach:()=>{de==null||de.removeEventListener("mousedown",n),window.removeEventListener("mousemove",r),window.removeEventListener("mouseup",a),window.removeEventListener("keydown",o)},refreshUI:()=>{}}}function Bn(){const i=J();for(const e of i){const t=e.matrix;if(!t)continue;const s=t.getInteractionStore();if(s.hasSelection())return{sequencerId:e.id,selectedNotes:s.getSelectedNotes()}}return null}function ef(i){const e=()=>{const o=Q(),l=Bn();if(!l||l.selectedNotes.length===0){o.showError("No notes selected. Please select notes before adjusting velocity.");return}i.velocity.show(l.selectedNotes)},t=o=>{var u;if(!q(o,"ToggleVelocityTool"))return;const l=(u=document.activeElement)==null?void 0:u.tagName,d=l==="INPUT"||l==="TEXTAREA",c=Re();d||c||(o.preventDefault(),e())},s=o=>{const l=o.ctrlKey||o.metaKey;o.type==="keydown"&&l&&!mt()&&ys(!0),o.type==="keyup"&&!l&&mt()&&ys(!1)},n=o=>{t(o),s(o)},r=o=>{s(o)},a=o=>{const{editorId:l}=o.detail;l==="velocity-tool"&&e()};return window.addEventListener("keydown",n),window.addEventListener("keyup",r),document.body.addEventListener("editor-invoke",a),{detach:()=>{window.removeEventListener("keydown",n),window.removeEventListener("keyup",r),document.body.removeEventListener("editor-invoke",a)},refreshUI:()=>{}}}let ft=null;function Xs(i,e){const t=ae(),s=window.devicePixelRatio||1,n=e/s;function r(){if(!i.isActive())return;const a=i.getCurrentBeat(),o=a/t*n;Nt(o),Vi(i,a),ft=requestAnimationFrame(r)}Ti(),ft=requestAnimationFrame(r)}function Ti(){ft!==null&&(cancelAnimationFrame(ft),ft=null)}function tf(i){var e;Nt(0);for(const t of i.sequencers)(e=t.matrix)==null||e.setPlayheadPixelX(0)}class sf{constructor(){this.onStop=null,this.engine=W.getInstance(),this.playheadCanvasWidth=300,this.engine.setOnResumeCallback(()=>{Xs(this.engine,this.playheadCanvasWidth)}),this.engine.setOnStopCallback(()=>{var e;(e=this.onStop)==null||e.call(this)})}play(){this.engine.start(),Xs(this.engine,this.playheadCanvasWidth)}stop(){this.engine.stop(),Ti(),tf(this.engine)}setOnStopCallback(e){this.onStop=e}async pause(){await this.engine.pause(),Ti()}async resume(){await this.engine.resume()}toggle(){this.engine.isActive()?this.pause():this.resume()}isPlaying(){return this.engine.isActive()}getEngine(){return this.engine}setSequencers(e){this.engine.setSequencers(e)}setPlayheadCanvasWidth(e){this.playheadCanvasWidth=e}}function rf(){const i=_e("💾 Export"),e=z({id:"export-json",text:"Save Project",kind:"primary"}),t=y("div",{class:"h-px bg-gray-600"}),s=z({id:"export-wav",text:"Export as WAV",kind:"secondary",additionalClasses:"bg-green-600 hover:bg-green-700"}),n=z({id:"export-midi",text:"Export as MIDI",kind:"secondary",additionalClasses:"bg-yellow-600 hover:bg-yellow-700"}),r=y("button",{id:"drag-midi",draggable:"true",class:["drag-midi-btn","cursor-grab select-none","px-2 py-1 rounded w-8 flex items-center justify-center","transition-transform transition-opacity duration-150","hover:scale-105 hover:brightness-110 active:cursor-grabbing","bg-yellow-700 hover:bg-yellow-600 text-white","border border-yellow-500"].join(" "),title:"Drag entire song as MIDI file to Desktop"},"🎵"),a=y("div",{class:"flex items-center gap-2"},n,r),o=z({id:"export-cancel",text:"Cancel",kind:"tertiary",additionalClasses:"mt-6 w-full"}),l=y("div",{class:"flex flex-col gap-3 w-full z-10"},e,t,s,a);return{root:he("export-modal",[i,l,o]),dragMidiBtn:r}}let Gn=0;function nf(i,e){const t=Gn++,s={id:t,...wt},n=e.instrument||"sf2/fluidr3-gm/acoustic_grand_piano",r=new Qr(null,s,i,i.destination,n,!0,t);return r.id=t,r.colorIndex=t,r.mute=!1,r.solo=!1,r.volume=e.volume??100/127,r.pan=e.pan??0,e.notes&&r.matrix&&r.matrix.setNotes(e.notes),r.setState({notes:e.notes,config:e.config||{},instrument:e.instrument,volume:e.volume,pan:e.pan}),r.initInstrument(),r}function af(){Gn=0}function of(i){if(!i.sequencers.length)throw new Error("No tracks to export.");const e=i.tempo,t=i.timeSignature[0],s=i.totalMeasures,n=i.songKey,r={v:3,t:new Date().toISOString(),c:{b:e,bpm:t,tm:s,sk:n},i:i.sequencers.map(o=>o.instrument||"sf2/fluidr3-gm/acoustic_grand_piano"),vlm:i.sequencers.map(o=>o.volume??100/127),pan:i.sequencers.map(o=>o.pan??0),tr:i.sequencers.map(o=>({n:o.notes.map(l=>[l.pitch,l.start,l.duration,l.velocity??100])}))},a=new Blob([JSON.stringify(r)],{type:"application/json"});return{url:URL.createObjectURL(a),filename:`session-${Date.now()}.json`}}async function lf(i,e={sampleRate:44100,includePan:!0}){if(!i.tracks||i.tracks.length===0)throw new Error("No tracks to export.");const t=e.sampleRate,s=e.includePan?2:1,n=new AbortController;let r=!1;ct("Exporting Session","Rendering your session offline...",()=>{r=!0,n.abort()},!0);try{const o=60/ve(),l=Math.max(...i.tracks.flatMap(m=>m.notes.map(b=>(b.start+b.duration)*o+.2))),d=new OfflineAudioContext(s,Math.ceil(t*l),t);af();for(const m of i.tracks)if(r||(await nf(d,m).exportToOffline(n.signal,m.notes),r))return;if(r)return;ct("Rendering Audio","Rendering audio buffer…",void 0,!0);const c=await d.startRendering();ct("Converting to WAV","Converting to WAV format…",void 0,!0);const u=cf(c);ct("Downloading WAV","Please wait...",void 0,!0);const f=URL.createObjectURL(u),h=document.createElement("a");h.href=f,h.download=`session-${Date.now()}.wav`,h.click(),URL.revokeObjectURL(f)}catch(a){r?console.warn("Export operation was cancelled by the user."):console.error("Error during export:",a)}finally{Fi(!0)}}function cf(i){const e=i.numberOfChannels,t=i.length*e*2,s=new DataView(new ArrayBuffer(44+t)),n=(a,o)=>{for(let l=0;l<o.length;l++)s.setUint8(a+l,o.charCodeAt(l))};n(0,"RIFF"),s.setUint32(4,36+t,!0),n(8,"WAVE"),n(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,e,!0),s.setUint32(24,i.sampleRate,!0),s.setUint32(28,i.sampleRate*e*2,!0),s.setUint16(32,e*2,!0),s.setUint16(34,16,!0),n(36,"data"),s.setUint32(40,t,!0);let r=44;for(let a=0;a<i.length;a++)for(let o=0;o<e;o++){const l=i.getChannelData(o)[a],d=Math.max(-1,Math.min(1,l));s.setInt16(r,d*32767,!0),r+=2}return new Blob([s.buffer],{type:"audio/wav"})}async function df(i){var l,d,c,u;const e=await i.text();let t;try{t=JSON.parse(e)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(t.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const s={bpm:((l=t.c)==null?void 0:l.b)??120,beatsPerMeasure:((d=t.c)==null?void 0:d.bpm)??4,totalMeasures:((c=t.c)==null?void 0:c.tm)??8,songKey:((u=t.c)==null?void 0:u.sk)??"CM"},n=Array.isArray(t.i)?t.i:[],r=Array.isArray(t.vlm)?t.vlm:[],a=Array.isArray(t.pan)?t.pan:[],o=t.tr.map((f,h)=>{if(!Array.isArray(f.n))throw new Error(`Track ${h} missing \`n\` (notes) array.`);const m=f.n.map(([_,S,v,C])=>({pitch:_,start:S,duration:v,velocity:C??100})),b=n[h]||"sf2/fluidr3-gm/acoustic_grand_piano",g=r[h],p=a[h];return{notes:m,instrument:b,volume:typeof g=="number"?g:void 0,pan:typeof p=="number"?p:void 0,config:{}}});return{globalConfig:s,tracks:o}}async function uf(i){var h;const e=await i.arrayBuffer(),t=new Zi.Midi(e),s=t.header.tempos[0],n=t.header.timeSignatures[0],r=(s==null?void 0:s.bpm)??120,a=((h=n==null?void 0:n.timeSignature)==null?void 0:h[0])??4,l=Math.max(0,...t.tracks.flatMap(m=>m.notes.map(b=>b.time+b.duration)))*(r/60),d=Math.ceil(l/a)||8,c={bpm:r,beatsPerMeasure:a,totalMeasures:d,songKey:"CM"},u=await Da(),f=t.tracks.map(m=>{const b=m.notes.map(N=>({pitch:N.name,start:N.time*(r/60),duration:N.duration*(r/60),velocity:Math.max(1,Math.min(127,Math.round(N.velocity*127)))}));let g=m.instrument.number;(g===void 0||g===0)&&(g=m.channel===9?0:m.channel%128);const p=m.controlChanges[7]||[],_=m.controlChanges[10]||[],S=p.length>0?p[0].value:void 0,v=_.length>0?_[0].value*2-1:void 0;let C;if(m.channel===9){const N=Va(g);N?C=`webaudiofont/${N.library}/${N.displayName}`:C=`sf2/drummachines/${u.includes("LM-2")?"LM-2":u[0]??"TR-808"}`}else C=`sf2/fluidr3-gm/${on[g]||"acoustic_grand_piano"}`;return{notes:b,instrument:C,volume:S,pan:v,config:{}}});return{globalConfig:c,tracks:f}}function Vs(i,e){const t=W.getInstance();t.isActive()&&t.pause(),is(e.bpm),ss(e.beatsPerMeasure),rs(e.totalMeasures),mn(e.songKey);const s=document.getElementById("tempo-input");s&&(s.value=String(ve()));const n=document.getElementById("measures-input");n&&(n.value=String(ns())),cc();for(const[o,l]of i.entries()){const d=o,c=l.instrument||"sf2/fluidr3-gm/acoustic_grand_piano",u=l.notes||[],f=l.volume,h=l.pan;O({type:"CREATE_SEQUENCER",id:d,instrument:c,notes:structuredClone(u),volume:f,pan:h,config:{...l.config||{}}},Qi(d))}O(es("Session Loaded"),hn("Session Loaded"));const r=J();Vo();const a=document.getElementById("global-mini-contour");a&&Kl(a,r),Nt(0)}class Ze{static async save(e){const t=H();if(e==="json"){const{url:s,filename:n}=of(t);Ze.download(s,n)}else if(e==="midi"){const{url:s,filename:n}=await Wc(t);Ze.download(s,n)}else throw new Error("Unsupported export format.")}static async saveWavWithOptions(e){const t=H(),s=J();try{const n={globalConfig:{bpm:t.tempo,beatsPerMeasure:t.timeSignature[0],totalMeasures:t.totalMeasures,songKey:t.songKey},tracks:s.map(r=>({notes:r.notes,instrument:r.instrumentName,config:r.config,volume:r.volume,pan:r.pan}))};await lf(n,e)}catch(n){alert("Failed to export WAV: "+(n instanceof Error?n.message:"Unknown error"))}}static async load(e){var t;try{const s=(t=e.name.split(".").pop())==null?void 0:t.toLowerCase();if(s==="json"){const{tracks:n,globalConfig:r}=await df(e);Vs(n,r)}else if(s==="mid"||s==="midi"){const{tracks:n,globalConfig:r}=await uf(e);Vs(n,r)}else throw new Error("Unsupported file type.")}catch(s){alert("Failed to load file: "+(s.message||"Unknown error"))}}static download(e,t){const s=document.createElement("a");s.href=e,s.download=t,s.click(),URL.revokeObjectURL(e)}}function hf(i,e,t){const s=i.querySelector("#export-cancel"),n=i.querySelector("#export-json"),r=i.querySelector("#export-wav"),a=i.querySelector("#export-midi");let o=null;const l=()=>{i.classList.add("hidden")},d=async f=>{f==="wav"?(l(),t()):(await Ze.save(f),l())};s==null||s.addEventListener("click",l),n==null||n.addEventListener("click",()=>d("json")),r==null||r.addEventListener("click",()=>d("wav")),a==null||a.addEventListener("click",()=>d("midi"));const c=f=>{e.classList.add("dragging"),o=cn(f,J())},u=()=>{e.classList.remove("dragging"),o&&(o(),o=null)};return e.addEventListener("dragstart",c),e.addEventListener("dragend",u),{detach:()=>{s==null||s.removeEventListener("click",l),n==null||n.removeEventListener("click",()=>d("json")),r==null||r.removeEventListener("click",()=>d("wav")),a==null||a.removeEventListener("click",()=>d("midi")),e.removeEventListener("dragstart",c),e.removeEventListener("dragend",u)},refreshUI:()=>{}}}class ff{constructor(e){this.detachFn=null;const{root:t,dragMidiBtn:s}=rf();this.modal=t,document.body.appendChild(this.modal);const n=hf(this.modal,s,e);this.detachFn=n.detach}show(){this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function pf({id:i,label:e,options:t}){const s=U(),n=y("select",{id:i,class:["w-[80px] h-[40px] text-sm font-semibold rounded px-2 cursor-pointer",s.surfaceBackground,s.textColor,s.borderColor].join(" ")},...t.map(r=>y("option",{value:r.value},r.label)));return e?y("div",{class:"flex flex-col items-start gap-1"},X(e),n):n}class mf{constructor(){const e=U();this.sampleRateSelect=pf({id:"save-wav-sample-rate",options:[{value:"44100",label:"44,100 Hz (CD Quality)"},{value:"32000",label:"32,000 Hz"},{value:"22050",label:"22,050 Hz (Faster Export)"}]}),this.includePanCheckbox=y("input",{id:"save-wav-include-pan",type:"checkbox",checked:!0,class:"accent-purple-500"}),this.cancelButton=z({id:"save-wav-options-cancel-btn",text:"Cancel",kind:"secondary"}),this.applyButton=z({id:"save-wav-options-apply-btn",text:"Export",kind:"primary"});const t=[_e("Export Settings"),se("Choose your WAV export parameters."),y("div",{class:"z-10 mb-4 w-full"},X({text:"Sample Rate",for:"save-wav-sample-rate"}),this.sampleRateSelect),y("div",{class:"z-10 mb-6"},y("label",{class:`flex items-center gap-2 text-sm ${e.textColor}`},this.includePanCheckbox,"Include Panning in Export")),y("div",{class:"flex justify-end gap-4 z-10"},this.cancelButton,this.applyButton)];this.modalEl=he("save-wav-options-modal",t,{sizePreset:"md"}),document.body.appendChild(this.modalEl),this.attachListeners()}attachListeners(){this.cancelButton.addEventListener("click",()=>this.hide()),this.applyButton.addEventListener("click",()=>{const e=parseInt(this.sampleRateSelect.value,10),t=this.includePanCheckbox.checked;this.hide(),Ze.saveWavWithOptions({sampleRate:e,includePan:t})})}show(){this.modalEl.classList.remove("hidden")}hide(){this.modalEl.classList.add("hidden")}destroy(){this.modalEl.remove()}}function yf(){const i=_e("📁 Load Project"),e=z({id:"import-json",text:"Load Project",kind:"primary"}),t=y("div",{class:"h-px bg-gray-600"}),s=z({id:"import-midi",text:"Import MIDI",kind:"secondary",additionalClasses:"bg-yellow-600 hover:bg-yellow-700"}),n=z({id:"import-cancel",text:"Cancel",kind:"tertiary",additionalClasses:"mt-6 w-full"}),r=y("div",{class:"flex flex-col gap-3 w-full z-10"},e,t,s);return he("import-modal",[i,r,n])}function gf(i){const e=i.querySelector("#import-cancel"),t=i.querySelector("#import-json"),s=i.querySelector("#import-midi"),n=()=>{i.classList.add("hidden")},r=async l=>{const d=document.createElement("input");d.type="file",d.accept=l.join(","),d.onchange=async()=>{var c;(c=d.files)!=null&&c[0]&&(await Ze.load(d.files[0]),n())},d.click()},a=()=>r([".json"]),o=()=>r([".mid",".midi"]);return e==null||e.addEventListener("click",n),t==null||t.addEventListener("click",a),s==null||s.addEventListener("click",o),{detach:()=>{e==null||e.removeEventListener("click",n),t==null||t.removeEventListener("click",a),s==null||s.removeEventListener("click",o)},refreshUI:()=>{}}}class bf{constructor(){this.detachFn=null,this.modal=yf(),document.body.appendChild(this.modal);const e=gf(this.modal);this.detachFn=e.detach}show(){this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}function _f(){const i=y("h2",{class:"text-xl font-semibold mb-2 z-10 text-center",textContent:"Adjust Velocity"}),e=y("p",{class:"text-sm text-gray-400 mb-4 text-center z-10",textContent:"Apply a velocity transformation to the selected notes."}),t=y("input",{id:"velocity-set-toggle",type:"checkbox",class:"accent-purple-500",checked:!0}),s=y("label",{class:"flex items-center gap-2 text-sm mb-2"},t,"Set base velocity to"),n=y("select",{id:"velocity-action-select",class:"flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500 cursor-pointer"},y("option",{value:"set"},"Set Velocity To"),y("option",{value:"increase"},"Increase Velocity By"),y("option",{value:"decrease"},"Decrease Velocity By")),r=y("input",{id:"velocity-value-input",type:"number",value:"100",min:"1",max:"127",class:"w-[100px] bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500"}),a=y("div",{id:"velocity-set-fields",class:"flex items-center gap-3"},n,r),o=y("div",{class:"z-10 mb-4"},s,a),l=y("input",{id:"velocity-ramp-toggle",type:"checkbox",class:"accent-purple-500"}),d=y("label",{class:"flex items-center gap-2 text-sm mb-2"},l,"Enable velocity ramp"),c=y("select",{id:"velocity-ramp-direction",class:"flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500 cursor-pointer"},y("option",{value:"up"},"Ramp Up"),y("option",{value:"down"},"Ramp Down")),u=y("input",{id:"velocity-ramp-amount",type:"number",value:"10",min:"1",max:"127",placeholder:"Δ per note",class:"w-[100px] bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-purple-500"}),f=y("div",{class:"flex items-center gap-2 mb-4 text-sm text-gray-300"},y("label",{class:"flex items-center gap-1"},y("input",{type:"radio",name:"ramp-mode",value:"linear",checked:!0,class:"accent-purple-500"}),"Linear"),y("label",{class:"flex items-center gap-1"},y("input",{type:"radio",name:"ramp-mode",value:"exponential",class:"accent-purple-500"}),"Exponential")),h=y("div",{id:"velocity-ramp-fields",class:"opacity-50 pointer-events-none"},y("div",{class:"flex items-center gap-3 mb-2"},c,u),f),m=y("div",{class:"border-t border-gray-700 pt-4 mt-4 z-10"},d,h),b=y("input",{id:"velocity-randomize-toggle",type:"checkbox",class:"accent-purple-500"}),g=y("label",{class:"flex items-center gap-2 text-sm mb-2"},b,"Add random variation"),p=y("input",{id:"velocity-random-range",type:"number",value:"5",min:"1",max:"64",class:"w-[80px] bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm focus:outline-none focus:border-purple-500"}),_=y("div",{id:"velocity-random-fields",class:"flex items-center gap-2 text-sm text-gray-300 opacity-50 pointer-events-none"},y("span",{textContent:"±"}),p),S=y("div",{class:"border-t border-gray-700 pt-4 mt-4 z-10"},g,_),v=y("div",{id:"velocity-preview-summary",class:"mt-6 text-sm text-gray-400 text-center z-10"}),C=z({id:"velocity-apply-btn",text:"Apply",kind:"primary"}),N=z({id:"velocity-cancel-btn",text:"Cancel",kind:"tertiary"}),w=y("div",{class:"flex gap-3 mt-6 z-10"},C,N);return he("velocity-modal",[i,e,o,m,S,v,w])}function vf(i){const e=Bn();if(!e){console.warn("No active note selection to apply velocity changes.");return}const{sequencerId:t,selectedNotes:s}=e;if(s.length===0){console.warn("No notes selected in the active sequencer.");return}const n=J().find(p=>p.id===t);if(!(n!=null&&n.matrix)){console.warn(`Could not find matrix for sequencer ID ${t}.`);return}const r=s.map(p=>({...p})),{mode:a,value:o,rampDirection:l="none",rampAmount:d=0,rampMode:c="linear",randomize:u=!1,randomRange:f=0}=i,h=s.map((p,_)=>({note:p,originalIndex:_}));h.sort((p,_)=>p.note.start-_.note.start);const m=new Map;for(const p of h){const _=p.note.start;m.has(_)||m.set(_,[]),m.get(_).push(p)}Array.from(m.entries()).sort((p,_)=>p[0]-_[0]).map(([,p])=>p).forEach((p,_)=>{let S=c==="linear"?_:Math.pow(_,1.3),v=d*S;l==="down"&&(v=-v);for(const{note:C}of p){let N;switch(a){case"set":N=Math.max(1,o);break;case"increase":N=(C.velocity??100)+o;break;case"decrease":N=(C.velocity??100)-o;break;case"none":default:N=C.velocity??100;break}let w=N+v;if(u&&f>0){const L=(Math.random()*2-1)*f;w+=L}C.velocity=Math.max(1,Math.min(127,Math.round(w)))}});const g=h.sort((p,_)=>p.originalIndex-_.originalIndex).map(({note:p})=>({...p}));O(ud(t,g),hd(t,r))}function Sf(i){const e=document.getElementById("velocity-modal");e&&e.classList.remove("hidden")}function Ci(){const i=document.getElementById("velocity-modal");i&&i.classList.add("hidden")}function Cf(i){var h;const e=i.querySelector("#velocity-apply-btn"),t=i.querySelector("#velocity-cancel-btn"),s=i.querySelector("#velocity-set-toggle"),n=((h=i.querySelector("#velocity-action-select"))==null?void 0:h.parentElement)??null,r=i.querySelector("#velocity-ramp-toggle"),a=i.querySelector("#velocity-ramp-fields"),o=i.querySelector("#velocity-randomize-toggle"),l=i.querySelector("#velocity-random-fields");function d(m,b){if(!m||!b)return;const g=m.checked;b.classList.toggle("opacity-50",!g),b.classList.toggle("pointer-events-none",!g)}function c(){s==null||s.addEventListener("change",()=>d(s,n)),r==null||r.addEventListener("change",()=>d(r,a)),o==null||o.addEventListener("change",()=>d(o,l)),d(s,n),d(r,a),d(o,l)}function u(){var L,k,B,M,x,G;const m=(s==null?void 0:s.checked)??!0,b=(r==null?void 0:r.checked)??!1,g=(o==null?void 0:o.checked)??!1,p=m?(L=i.querySelector("#velocity-action-select"))==null?void 0:L.value:"none",_=parseInt(((k=i.querySelector("#velocity-value-input"))==null?void 0:k.value)??"",10),S=isNaN(_)?100:Math.max(1,Math.min(127,_)),v=b?(B=i.querySelector("#velocity-ramp-direction"))==null?void 0:B.value:"none",C=b?parseInt(((M=i.querySelector("#velocity-ramp-amount"))==null?void 0:M.value)??"0",10):0,N=b?(x=i.querySelector('input[name="ramp-mode"]:checked'))==null?void 0:x.value:"linear",w=g?parseInt(((G=i.querySelector("#velocity-random-range"))==null?void 0:G.value)??"0",10):0;vf({mode:p,value:S,rampDirection:v,rampAmount:C,rampMode:N,randomize:g,randomRange:w}),Ci()}const f=()=>{t==null||t.removeEventListener("click",Ci),e==null||e.removeEventListener("click",u),s==null||s.removeEventListener("change",()=>d(s,n)),r==null||r.removeEventListener("change",()=>d(r,a)),o==null||o.removeEventListener("change",()=>d(o,l))};return t==null||t.addEventListener("click",Ci),e==null||e.addEventListener("click",u),c(),{detach:f,refreshUI:()=>{}}}class Nf{constructor(){this.detachFn=null,this.modal=_f(),document.body.appendChild(this.modal);const e=Cf(this.modal);this.detachFn=e.detach}show(e){Sf()}hide(){this.modal.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}const wf="v0.1.2",Mf="May 15, 2025",xf=["✨ New Features","- 🤖 Added AI Autocomplete for seamless melody continuation (OpenAI API Key required; more AI features rolling out soon)","- 🎨 Improved skin system with expanded customization options (available in User Settings)","- 🐛 Fixed numerous bugs and polished UI behavior for a smoother experience","🐞 Known Issues","- 🚫 Note placement during live playback of large sequences causes performance issues","🛣️ Roadmap","- 🤖 Continous enhancing and implementation of AI features"];function Lf(){const i=X({text:`${wf} — Updated ${Mf}`});i.id="whats-new-metadata",i.classList.add("italic","text-gray-400","text-center","self-center","mb-4");const e=y("ul",{id:"whats-new-content",class:"list-disc list-inside text-left space-y-2 text-md w-full"});let t=null;for(const a of xf)if(a.startsWith("✨")||a.startsWith("🐞")||a.startsWith("🛣️")){const o=y("li",{class:"font-bold mt-6 text-lg",textContent:a});e.appendChild(o),t=y("ul",{class:"list-disc list-inside ml-6 mt-2 space-y-1"}),e.appendChild(t)}else if(t){const o=y("li",{textContent:a.replace(/^- /,"")});t.appendChild(o)}const s=y("img",{src:fe("static/logo.png"),alt:"Sequenzia",class:"w-[180px] h-auto rounded-xl mb-6 self-center"}),n=z({id:"whats-new-close-btn",text:"Close",kind:"primary",additionalClasses:"mt-8 self-center text-base px-6 py-2 font-medium"}),r=_e({text:"🆕 What's New in Sequenzia",size:"xl",additionalClasses:"text-center self-center"});return he("whats-new-modal",[s,r,i,e,n],{sizePreset:"xl"})}function kf(i){const e=i.querySelector("#whats-new-close-btn"),t=()=>{i.style.opacity="0",i.style.transition="opacity 0.4s ease-out",setTimeout(()=>{i.classList.add("hidden"),i.style.opacity="1"},400)};return e==null||e.addEventListener("click",t),{detach:()=>{e==null||e.removeEventListener("click",t)},refreshUI:()=>{}}}class Af{constructor(){this.detachFn=null,this.modal=Lf(),document.body.appendChild(this.modal);const e=kf(this.modal);this.detachFn=e.detach}show(){this.modal.classList.remove("hidden"),this.modal.style.opacity="1"}hide(){this.modal.style.opacity="0",this.modal.style.transition="opacity 0.4s ease-out",setTimeout(()=>{this.modal.classList.add("hidden"),this.modal.style.opacity="1"},400)}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.modal.remove()}}class Bf{constructor(e,t){this.contour=null,this.miniCanvas=null,this.sideButtons=null,this.detachFns=[],this.refreshFns=[],this.engine=e,this.userConfigModalController=t,this.playbackService=new sf,this.initializeUI()}initializeUI(){this.controls=new tu,this.wavOptionsModal=new mf,this.saveModal=new ff(()=>this.wavOptionsModal.show()),this.loadModal=new bf,this.velocityModal=new Nf,this.whatsNewModal=new Af;const e=su(),t=gu(),s=Nu(),n=bu();this.controls.getGlobalPlayheadRow().appendChild(e),this.controls.getGlobalToolsRow().appendChild(t.element),this.controls.getGlobalTransportRow().appendChild(s.element);const r=document.getElementById("footer-main");r&&r.appendChild(n),this.miniCanvas=this.getGlobalMiniContourCanvas(),this.sideButtons=n,this.contour=e;const a=xu(e),o=Vh({rootElement:t.element,noteOptionsGroup:t.noteOptionsGroup,aiOptionsGroup:t.aiOptionsGroup}),l=Zh(s.element,this.playbackService,this.userConfigModalController,this.saveModal,this.loadModal),d=Yh(n,this.whatsNewModal),c=Qh(this.controls.getGlobalPlayheadRow()),u=ef({velocity:this.velocityModal});this.detachFns=[a.detach,o.detach,l.detach,d.detach,c.detach,u.detach,t.refreshGridSettings],this.refreshFns=[a.refreshUI,o.refreshUI,l.refreshUI,d.refreshUI,c.refreshUI,u.refreshUI,s.refreshToggles],sr(),this.initPlayhead()}initPlayhead(){if(!this.contour)return;const e=this.contour.querySelector("#global-mini-playhead");e&&(ql(e),this.playbackService.setPlayheadCanvasWidth(e.width))}getPlaybackService(){return this.playbackService}getGlobalMiniContourCanvas(){var e;return((e=this.contour)==null?void 0:e.querySelector("#global-mini-contour"))??null}show(){this.refreshFns.forEach(e=>e()),this.controls.render().classList.remove("hidden")}hide(){this.controls.render().classList.add("hidden")}destroy(){var e,t,s,n,r,a;this.detachFns.forEach(o=>o()),this.controls.destroy(),(e=this.sideButtons)!=null&&e.parentNode&&this.sideButtons.parentNode.removeChild(this.sideButtons),this.sideButtons=null,(t=this.wavOptionsModal)==null||t.destroy(),(s=this.saveModal)==null||s.destroy(),(n=this.loadModal)==null||n.destroy(),(r=this.velocityModal)==null||r.destroy(),(a=this.whatsNewModal)==null||a.destroy()}reload(){this.destroy(),this.initializeUI()}}function Gf(i,e){window.addEventListener("keydown",t=>{const s=(t.ctrlKey||t.metaKey)&&t.key.toLowerCase()==="z",n=(t.ctrlKey||t.metaKey)&&(t.key.toLowerCase()==="y"||t.shiftKey&&t.key.toLowerCase()==="z");if(!s&&!n)return;t.preventDefault(),t.target instanceof HTMLElement&&t.target.matches('input, textarea, [contenteditable="true"]')||(s?i():e())},{capture:!0})}function Ef(){const i=y("canvas",{id:"waveform",width:1260,height:100,class:"rounded border border-purple-800 bg-gray-900"}),e=y("button",{id:"visualizer-mode",class:"side-button side-button-primary",title:"Change visualizer mode",textContent:"📊"}),t=y("div",{class:"flex flex-col gap-2"},e),s=y("div",{class:"flex items-start gap-2"},i,t),n=document.getElementById("visualizer-container");return n&&n.appendChild(s),s}function Tf(i,e){const t=e.getContext("2d");if(!t)throw new Error("Canvas 2D context not available");const s=e.width,n=e.height,r=new Uint8Array(i.fftSize),a=new Uint8Array(i.frequencyBinCount),o=document.createElement("canvas");o.width=s,o.height=n;const l=o.getContext("2d");if(!l)throw new Error("Offscreen canvas 2D context not available");let d="frequency";function c(){if(!t)return;i.getByteTimeDomainData(r),t.fillStyle="#000",t.fillRect(0,0,s,n),t.lineWidth=2,t.strokeStyle="#00ffcc",t.beginPath();const m=s/r.length;let b=0;for(let g=0;g<r.length;g++){const _=r[g]/128*n/2;g===0?t.moveTo(b,_):t.lineTo(b,_),b+=m}t.lineTo(s,n/2),t.stroke()}function u(){if(i.getByteFrequencyData(a),!t)return;t.fillStyle="#000",t.fillRect(0,0,s,n),t.fillStyle="rgba(255,255,255,0.2)",t.fillRect(0,0,1,n),t.fillRect(s-1,0,1,n);const m=128,b=2,g=[];for(let p=0;p<m;p++)g.push(p*s/(m-1));g[g.length-1]=s-1;for(let p=0;p<m;p++){const _=g[p],S=p<m-1?g[p+1]:s,v=Math.max(1,S-_-b),C=20,N=2e4,w=p/(m-1),L=C*Math.pow(N/C,w),B=Math.min(a.length-1,Math.floor(L/22050*a.length)),M=a[B]/255,x=Math.max(1,M*n),G=240-w*240;t.fillStyle=`hsl(${G}, ${80+M*20}%, ${40+M*40}%)`,t.fillRect(_,n-x,v,x)}}function f(){if(i.getByteFrequencyData(a),!l)return;o.initialized||(l.fillStyle="#000",l.fillRect(0,0,s,n),o.initialized=!0),l.drawImage(o,-1,0),l.fillStyle="#000",l.fillRect(s-1,0,1,n);const m=128,b=20,g=2e4;for(let p=0;p<m;p++){const _=p/(m-1),S=b*Math.pow(g/b,_),C=Math.min(a.length-1,Math.floor(S/22050*a.length)),N=a[C]/255,w=n-1-Math.floor(p*n/m);if(N<.05)continue;const L=Math.floor(N*255),k=Math.floor(N*(255-_*200)),B=Math.floor(N*(100+_*155));l.fillStyle=`rgb(${L}, ${k}, ${B})`,l.fillRect(s-1,w,1,1)}t&&(t.fillStyle="#000",t.fillRect(0,0,s,n),t.drawImage(o,0,0))}function h(){switch(requestAnimationFrame(h),d){case"frequency":u();break;case"spectrogram":f();break;case"waveform":default:c()}}return h(),{setMode(m){["waveform","frequency","spectrogram"].includes(m)&&(d=m,t.clearRect(0,0,s,n),d==="spectrogram"&&l.clearRect(0,0,s,n))}}}function If(i){const e=i.querySelector("#waveform"),t=i.querySelector("#visualizer-mode");if(!e||!t)return console.warn("Visualizer setup failed: missing canvas or button"),{detach:()=>{},refreshUI:()=>{}};const s=Tf(br(),e),n=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let r=0;function a(){if(!t)return;r=(r+1)%n.length;const{name:o,emoji:l}=n[r];s.setMode(o),t.textContent=l,t.title=`Mode: ${o}`}return t.addEventListener("click",a),a(),{detach:()=>{t.removeEventListener("click",a)},refreshUI:()=>{t.textContent=n[r].emoji,t.title=`Mode: ${n[r].name}`}}}class Rf{constructor(){this.detachFn=null,this.refreshFn=null,this.initializeUI()}initializeUI(){this.container=Ef();const e=If(this.container);this.detachFn=e.detach,this.refreshFn=e.refreshUI}show(){var e;this.container.classList.remove("hidden"),(e=this.refreshFn)==null||e.call(this)}hide(){this.container.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.container.remove()}reload(){this.destroy(),this.initializeUI()}}function Pf(){const i=y("div",{id:"left-sidebutton-column",class:"absolute left-[-46px] flex flex-col gap-2 z-10"},y("button",{id:"piano-toggle-btn",class:"side-button side-button-info",title:"Toggle Piano View",textContent:"🎹"}),y("button",{id:"mixer-toggle-btn",class:"side-button side-button-info",title:"Toggle Mixer View",textContent:"🎛️"}),y("button",{id:"ai-toggle-btn",class:"side-button side-button-info",title:"Toggle AI View",textContent:"🤖"})),e=document.getElementById("top-controls-container");return e?e.appendChild(i):console.warn("[SideMenuUI] #top-controls-container not found."),i}function Of(i){const e=i.querySelector("#piano-toggle-btn"),t=i.querySelector("#mixer-toggle-btn"),s=i.querySelector("#ai-toggle-btn"),n=()=>{Q().showFeatureBlocked()},r=()=>{Q().showFeatureBlocked()},a=()=>{Q().showFeatureBlocked()};return e==null||e.addEventListener("click",n),t==null||t.addEventListener("click",r),s==null||s.addEventListener("click",a),{detach:()=>{e==null||e.removeEventListener("click",n),t==null||t.removeEventListener("click",r),s==null||s.removeEventListener("click",a)},refreshUI:()=>{}}}class Ff{constructor(){this.detachFn=null,this.refreshFn=null,this.initializeUI()}initializeUI(){this.container=Pf();const e=Of(this.container);this.detachFn=e.detach,this.refreshFn=e.refreshUI}show(){var e;this.container.classList.remove("hidden"),(e=this.refreshFn)==null||e.call(this)}hide(){this.container.classList.add("hidden")}destroy(){var e;(e=this.detachFn)==null||e.call(this),this.container.remove()}reload(){this.destroy(),this.initializeUI()}}function Df(){const i=y("canvas",{id:"piano",width:1260,height:200,class:"rounded shadow-lg border border-purple-700"}),e=y("button",{id:"octave-up",class:"side-button side-button-primary",title:"Octave Up"},I("icon-arrow-up","Octave Up")),t=y("button",{id:"octave-down",class:"side-button side-button-primary",title:"Octave Down"},I("icon-arrow-down","Octave Down")),s=y("button",{id:"global-instrument-select-btn",class:"side-button side-button-primary",title:"Select Instrument"},I("icon-list-instrument","Instrument")),n=y("button",{id:"disable-keyboard-inputs",class:"side-button side-button-secondary",title:"Toggle Keyboard Input"},I("icon-keyboard","Keyboard Input")),r=y("div",{class:"flex flex-col gap-2"},e,t,s,n);return{wrapper:y("div",{class:"flex items-start gap-2"},i,r),canvas:i}}function Ys(i,e){const t=parseInt(i.replace("#",""),16),s=Math.round(2.55*e),n=Math.max(0,Math.min(255,(t>>16)+s)),r=Math.max(0,Math.min(255,(t>>8&255)+s)),a=Math.max(0,Math.min(255,(t&255)+s));return`rgb(${n},${r},${a})`}function yt(i,e,t=new Set,s=null){i.clearRect(0,0,i.canvas.width,i.canvas.height);const{whiteKeyColor:n,blackKeyColor:r}=U(),a={};if(s)for(const[o,l]of Object.entries(s))a[l]=o;for(const o of Object.values(e))if(!o.isBlack){const l=i.createLinearGradient(0,0,0,o.height);t.has(o.note)?(l.addColorStop(0,"#99cfff"),l.addColorStop(1,"#cce0ff")):(l.addColorStop(0,Ys(n,-20)),l.addColorStop(1,n)),Zs(i,{...o,fill:l,stroke:"#333",radius:6}),i.fillStyle="#333",i.font="12px sans-serif",i.textAlign="center",a[o.note]&&(i.fillStyle="#7c3aed",i.fillText(a[o.note],o.x+o.width/2,o.height-24),i.fillStyle="#333"),i.fillText(o.note,o.x+o.width/2,o.height-8)}for(const o of Object.values(e))if(o.isBlack){const l=i.createLinearGradient(0,0,0,o.height);t.has(o.note)?(l.addColorStop(0,"#3040ff"),l.addColorStop(1,"#4a60ff")):(l.addColorStop(0,Ys(r,-20)),l.addColorStop(1,r)),Zs(i,{...o,fill:l,stroke:"#000000",radius:4}),a[o.note]&&(i.fillStyle="#c084fc",i.font="10px sans-serif",i.textAlign="center",i.fillText(a[o.note],o.x+o.width/2,o.height-28))}}function Zs(i,e){const{x:t,width:s,height:n,fill:r,stroke:a,radius:o=8}=e;i.beginPath(),i.moveTo(t,0),i.lineTo(t,n-o),i.quadraticCurveTo(t,n,t+o,n),i.lineTo(t+s-o,n),i.quadraticCurveTo(t+s,n,t+s,n-o),i.lineTo(t+s,0),i.closePath(),i.fillStyle=r,i.fill(),i.strokeStyle=a,i.lineWidth=1,i.stroke()}function Uf(i){const e=i.getContext("2d");if(!e)throw new Error("Canvas context unavailable.");const t=new Map,s=new Set;let n=!1;function r(h,m){const b=$e();for(const g of Object.values(b))if(g.isBlack&&h>=g.x&&h<=g.x+g.width&&m>=0&&m<=g.height)return g.note;for(const g of Object.values(b))if(!g.isBlack&&h>=g.x&&h<=g.x+g.width&&m>=0&&m<=g.height)return g.note;return null}function a(h){if(!h||s.has(h)||!e)return;const m=go(h);m&&(t.set(h,m),s.add(h),yt(e,$e(),s,void 0))}function o(h){if(!s.has(h)||!e)return;const m=t.get(h);m&&(m.stop(),t.delete(h)),s.delete(h),yt(e,$e(),s,void 0)}function l(){for(const h of s)o(h)}const d=h=>{n=!0;const m=i.getBoundingClientRect(),b=h.clientX-m.left,g=h.clientY-m.top,p=r(b,g);a(p)},c=h=>{if(!n)return;const m=i.getBoundingClientRect(),b=h.clientX-m.left,g=h.clientY-m.top,p=r(b,g);a(p)},u=()=>{n=!1,l()},f=()=>{n=!1,l()};return i.addEventListener("mousedown",d),i.addEventListener("mousemove",c),i.addEventListener("mouseup",u),i.addEventListener("mouseleave",f),{detach:()=>{i.removeEventListener("mousedown",d),i.removeEventListener("mousemove",c),i.removeEventListener("mouseup",u),i.removeEventListener("mouseleave",f)},refreshUI:()=>{}}}const En=[..."qwertyuiop[zxcvbnm,./"],Tn=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];function qf(i){const e=i.getContext("2d");if(!e)throw new Error("Canvas context unavailable.");const t=new Set,s=new Set,n=new Map;function r(){const c=$e(),u=Object.values(c).filter(m=>!m.isBlack).sort((m,b)=>m.x-b.x).map(m=>m.note),f=Object.values(c).filter(m=>m.isBlack).sort((m,b)=>m.x-b.x).map(m=>m.note),h={};return En.forEach((m,b)=>{u[b]&&(h[m]=u[b])}),Tn.forEach((m,b)=>{f[b]&&(h[m]=f[b])}),h}function a(c){const u=r(),f=u[c];if(!(!f||t.has(c)||!e)){if(t.add(c),!s.has(f)){const h=gr(f,100,ho());h&&(n.set(f,{stop:h}),s.add(f))}yt(e,$e(),s,u)}}function o(c){const u=r(),f=u[c];!f||!e||(t.delete(c),s.has(f)&&(mo(f),n.delete(f),s.delete(f)),yt(e,$e(),s,u))}const l=c=>{c.repeat||!Re()||a(c.key)},d=c=>{Re()&&o(c.key)};return window.addEventListener("keydown",l),window.addEventListener("keyup",d),{detach:()=>{window.removeEventListener("keydown",l),window.removeEventListener("keyup",d)},refreshUI:()=>{}}}function Qs(i,e){e?(i.classList.remove("side-button-secondary","side-button-primary"),i.classList.add("side-button-activated")):(i.classList.remove("side-button-activated"),i.classList.add("side-button-secondary"))}function Kf(i){const e=Object.values(i).filter(n=>!n.isBlack).sort((n,r)=>n.x-r.x).map(n=>n.note),t=Object.values(i).filter(n=>n.isBlack).sort((n,r)=>n.x-r.x).map(n=>n.note),s={};return En.forEach((n,r)=>{e[r]&&(s[n]=e[r])}),Tn.forEach((n,r)=>{t[r]&&(s[n]=t[r])}),s}function $f(i){const e=i.querySelector("#piano"),t=e==null?void 0:e.getContext("2d");if(!e||!t)throw new Error("Keyboard canvas not available");const s=i.querySelector("#octave-up"),n=i.querySelector("#octave-down"),r=i.querySelector("#disable-keyboard-inputs"),a=i.querySelector("#global-instrument-select-btn");function o(){if(!t)return;const f=oi(),h=pr(f);po(h),r&&Qs(r,Re());const m=Re()?Kf(h):null;yt(t,h,new Set,m??void 0)}const l=()=>{const f=oi();f<7&&(ms(f+1),o())},d=()=>{const f=oi();f>1&&(ms(f-1),o())},c=()=>{const f=Re();fo(!f),o(),r&&Qs(r,!f)},u=()=>{const f=qi()||"sf2/fluidr3-gm/acoustic_grand_piano";Vt().showInstrumentSelectModal(null,f)};return s==null||s.addEventListener("click",l),n==null||n.addEventListener("click",d),r==null||r.addEventListener("click",c),a==null||a.addEventListener("click",u),{detach:()=>{s==null||s.removeEventListener("click",l),n==null||n.removeEventListener("click",d),r==null||r.removeEventListener("click",c),a==null||a.removeEventListener("click",u)},refreshUI:o}}class zf{constructor(){this.detachFns=[],this.refreshFns=[];const{wrapper:e,canvas:t}=Df();this.wrapper=e,this.canvas=t}render(){return this.wrapper}initialize(){co();const e=Uf(this.canvas),t=qf(this.canvas),s=$f(this.wrapper);this.detachFns=[e.detach,t.detach,s.detach],this.refreshFns=[e.refreshUI,t.refreshUI,s.refreshUI],this.refresh()}refresh(){this.refreshFns.forEach(e=>e())}hide(){this.wrapper.classList.add("hidden")}show(){this.wrapper.classList.remove("hidden"),this.refresh()}destroy(){this.detachFns.forEach(e=>e()),this.wrapper.parentNode&&this.wrapper.parentNode.removeChild(this.wrapper)}}class Hf{constructor(){this.activeMode="keyboard",this.activeElement=null,this.detachFns=[];const e=document.getElementById("top-controls-container");if(!e)throw new Error("#top-controls-container not found in DOM");this.container=e,this.initialize()}initialize(){this.sideMenuController=new Ff,this.keyboardController=new zf,this.setMode("keyboard")}setMode(e){if(this.activeElement){if(this.activeMode===e)return;this.container.removeChild(this.activeElement),this.activeElement=null}switch(this.activeMode=e,e){case"keyboard":this.activeElement=this.keyboardController.render(),this.container.appendChild(this.activeElement),this.keyboardController.initialize();break;case"ai":this.activeElement=this.createStub("AI View not implemented"),this.container.appendChild(this.activeElement);break;case"mixer":this.activeElement=this.createStub("Mixer View not implemented"),this.container.appendChild(this.activeElement);break}}getCurrentMode(){return this.activeMode}destroy(){var e,t,s;this.detachFns.forEach(n=>n()),this.detachFns=[],(e=this.sideMenuController)==null||e.destroy(),(t=this.keyboardController)==null||t.destroy(),((s=this.activeElement)==null?void 0:s.parentNode)===this.container&&this.container.removeChild(this.activeElement),this.activeElement=null}reload(){this.destroy(),this.initialize()}createStub(e){const t=document.createElement("div");return t.className="text-gray-400 text-sm p-4 border border-gray-600 rounded",t.textContent=e,t}}function Jf(i){const e=U(),t=e.menuBackground,s=e.borderColor;return y("div",{class:["sticky top-0","flex justify-between items-center","mb-6 border-b",t,s,"z-999","pb-2 pt-3 px-4"].join(" ")},y("div",{class:"flex gap-4 text-xl select-none"},...i.map(n=>y("span",{class:["settings-tab","hover:text-white hover:scale-110 transition-all duration-150 cursor-pointer",n.isActive?"text-purple-500":"text-gray-300"].join(" "),dataset:{tab:n.key},title:n.title,textContent:n.icon}))))}class Wf{constructor(){this.globalSection=y("div",{id:"userconfig-global-settings",class:"settings-section z-10"}),this.themeSection=y("div",{id:"userconfig-theme-settings",class:"settings-section hidden z-10"}),this.aiSection=y("div",{id:"userconfig-ai-settings",class:"settings-section hidden z-10"}),this.keybindingsSection=y("div",{id:"userconfig-keybindings-settings",class:"settings-section hidden z-10"});const e=Jf([{key:"global-settings",icon:"⚙️",title:"Global Settings",isActive:!0},{key:"theme-settings",icon:"🎹",title:"Theme Settings"},{key:"ai-settings",icon:"🤖",title:"AI Settings"},{key:"keybindings-settings",icon:"⌨️",title:"Keybindings"}]);this.saveButton=z({id:"userconfig-save",text:"Save",kind:"primary"}),this.closeButton=z({id:"userconfig-close-bottom",text:"Cancel",kind:"secondary"});const t=U(),s=t.menuBackground,n=t.accentColor,r=y("div",{class:`sticky bottom-0 flex gap-3 py-4 px-6 borter-t ${n} ${s} z-10`},this.saveButton,this.closeButton);this.modal=he("userconfig-modal",[e,this.globalSection,this.themeSection,this.aiSection,this.keybindingsSection,r],{sizePreset:"xl",scrollableContent:!0}),document.body.appendChild(this.modal)}render(){return this.modal}show(){this.modal.classList.remove("hidden")}hide(){this.modal.classList.add("hidden")}destroy(){this.modal.remove()}getSectionContainer(e){switch(e){case"global":return this.globalSection;case"theme":return this.themeSection;case"ai":return this.aiSection;case"keybindings":return this.keybindingsSection}}getSaveButton(){return this.saveButton}getCloseButton(){return this.closeButton}getTabs(){return this.modal.querySelectorAll(".settings-tab")}getSections(){return this.modal.querySelectorAll(".settings-section")}}function jf(){const{trigger:i,tooltip:e}=Je("tooltip-note-mode","?",[se(Ke("Default Mode:")," gesture-based note placement. Allows click-and-drag selection and edit gestures."),se(Ke("Express Mode:")," notes are placed immediately on mouse down. Holding allows drag-resizing. Right-click initiates multi-note selection.")]),t=Le({id:"note-tool-toggle",label:"Note Placement:",stateA:"Classic",stateB:"Express",tooltipTrigger:i});t.input.addEventListener("change",()=>{const r=t.getChecked()?"express":"default";re({global:{noteToolMode:r}})});const s=()=>{const r=V().global.noteToolMode;t.setChecked(r==="express")};return{element:y("div",{},_e("Global Settings"),t.element,e),refreshToggle:s}}const Xf=["Default","Blue Dream","Modern Light","Synthwave","Verdant Alloy","Sunset"],Vf=["Darkroom","Seashell","Cyberpunk","Classic Blue","Midnight"],Yf=["Track Color","Note Velocity","Pitch Class Contrast","Scriabin","Octave Bands"];function Zf(){const i=Vf.map(s=>y("option",{value:s,textContent:s})),e=Yf.map(s=>y("option",{value:s,textContent:s})),t=Xf.map(s=>y("option",{value:s,textContent:s}));return y("div",{},_e("Theme Settings"),y("div",{className:"mb-6"},X("Interface Skin"),y("select",{id:"skin-select",className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500 cursor-pointer"},...t)),y("div",{className:"mb-6"},X("Grid Color Scheme"),y("select",{id:"grid-color-select",className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500 cursor-pointer"},...i)),y("div",{className:"mb-6"},X("Note Color Scheme"),y("select",{id:"note-color-select",className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500 cursor-pointer"},...e)))}const Qf=[{value:"gpt-4o",label:"gpt-4o"},{value:"gpt-4o-mini",label:"gpt-4o-mini"},{value:"gpt-4.1",label:"gpt-4.1"},{value:"gpt-4.1-mini",label:"gpt-4.1-mini"},{value:"o3-mini",label:"o3-mini"},{value:"o4-mini",label:"o4-mini",className:"bg-green-700 text-white"}];function ep(){const i=Qf.map(l=>y("option",{value:l.value,className:l.className,textContent:l.label})),e=Le({id:"ai-track-indicator-toggle",label:"AI Track Indicator:",stateA:"Off",stateB:"On"});e.input.addEventListener("change",()=>{re({ai:{indicatorEnabled:e.getChecked()}})});const t=()=>{e.setChecked(_t())},{trigger:s,tooltip:n}=Je("tooltip-openai-key","?",["You must provide an OpenAI API key to use AI features.",se("Visit ",y("a",{href:"https://platform.openai.com/account/api-keys",target:"_blank",className:"text-blue-400 underline hover:text-blue-300"},"platform.openai.com")," to manage your key.")]),{trigger:r,tooltip:a}=Je("tooltip-openai-model","?",["Different models offer varying performance and response quality.",se("Models marked in ",y("span",{class:"text-green-400 font-semibold"},"green")," are recommended for best results."),"We will add support for new models as they become available."]);return{element:y("div",{},_e("AI Configuration"),y("div",{class:"mb-6"},X("OpenAI API Key",s),y("input",{type:"password",id:"openai-key-input",placeholder:"sk-...",className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500"}),n),y("div",{class:"mb-8"},X("OpenAI Model",r),y("select",{id:"openai-model-select",className:"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500 cursor-pointer"},...i),a),y("div",{class:"mb-8"},e.element)),refreshToggle:t}}const tp=[{name:"Global",description:"Common editing operations.",macros:["ShowHotkeys","Undo","Redo","PasteNotes","CopyNotes","CutNotes","DeleteNotes"]},{name:"Note Editing",description:"Tools and overrides for note manipulation.",macros:["ToggleDottedNotes","ToggleTripletNotes","ApplyDuration1","ApplyDuration2","ApplyDuration3","ApplyDuration4","ApplyDuration5","ApplyDuration6","ApplySnap1","ApplySnap2","ApplySnap3","ApplySnap4","ApplySnap5","ApplySnap6"]},{name:"Tools",description:"Additional editing tools and utilities.",macros:["ToggleVelocityTool","ToggleQuantizeTool","ToggleTransposeTool","ToggleChordifyTool","ToggleHumanizeTool"]},{name:"Transport",description:"Playback and navigation controls.",macros:["TransportPlay","TransportStop","SeekBackward","SeekForward","SeekMeasureBack","SeekMeasureForward"]},{name:"AI Mode",description:"Autocomplete and AI-assisted operations.",macros:["AIStartAutocomplete","ToggleAIMode","ApproveAutocomplete","RejectAutocomplete","SwitchToNoteMode","SwitchToAIMode"]}];function ip(){const i=[],e=y("div",{className:"flex flex-col gap-y-4"}),t=hs();for(const a of tp){const o=X(a.name),l=y("div",{className:"grid gap-y-3 grid-cols-[200px_1fr_auto]"});for(const d of a.macros){const c=t[d],u=er(c),f=X(d),h=y("span",{className:"text-sm text-gray-300 self-center"},u),m=z({text:"Rebind",kind:"secondary",additionalClasses:"px-4 py-2"});i.push({macroName:d,labelEl:h,buttonEl:m}),l.appendChild(f),l.appendChild(h),l.appendChild(m)}e.appendChild(o),a.description&&e.appendChild(y("p",{className:"text-xs text-gray-400"},a.description)),e.appendChild(l),e.appendChild(Cn())}const s=z({id:"keybindings-reset-btn",text:"Reset to Defaults",kind:"tertiary",additionalClasses:"self-start px-4 py-2"});return e.appendChild(s),{element:y("div",{},_e("Key Bindings"),e),bindings:i,refreshToggle:()=>{const a=hs();for(const o of i){const l=a[o.macroName];o.labelEl.textContent=er(l)}}}}function er(i){const e=t=>{const s=[t.ctrl?"Ctrl":"",t.shift?"Shift":"",t.alt?"Alt":"",t.meta?"Meta":""].filter(Boolean),n=Sn(t);return[...s,n].join(" + ")};return Array.isArray(i)?i.map(e).join(" / "):e(i)}function sp(i,e={}){const t=i.getTabs(),s=i.getSections(),n=i.getCloseButton(),r=i.getSaveButton(),a=c=>{s.forEach(f=>{f.classList.add("hidden")});const u=document.getElementById(`userconfig-${c}`);u&&u.classList.remove("hidden"),t.forEach(f=>{const h=f.dataset.tab===c;f.classList.toggle("text-purple-500",h),f.classList.toggle("opacity-100",h),f.classList.toggle("text-gray-300",!h),f.classList.toggle("opacity-50",!h)})},o=[];t.forEach(c=>{const u=c.dataset.tab;if(!u)return;const f=()=>a(u);c.addEventListener("click",f),o.push(()=>c.removeEventListener("click",f))});const l=()=>{var c;(c=e.onClose)==null||c.call(e),i.hide()},d=()=>{var u;(u=e.onSave)==null||u.call(e);const c=U();c.name,Ne.getInstance().reloadAll(),i.hide()};return n.addEventListener("click",l),r.addEventListener("click",d),(()=>{const c=Array.from(t).find(u=>u.classList.contains("text-purple-500"));c!=null&&c.dataset.tab&&a(c.dataset.tab)})(),()=>{o.forEach(c=>c()),n.removeEventListener("click",l),r.removeEventListener("click",d)}}function rp(i){const e=i.querySelector("#openai-key-input"),t=i.querySelector("#openai-model-select"),s=i.querySelector("#ai-track-indicator-toggle"),n=()=>{var d;const l=V();e&&(e.value=l.ai.openaiApiKey||""),t&&(t.value=l.ai.openaiModel||((d=t.options[0])==null?void 0:d.value)||""),s&&(s.checked=!!l.ai.indicatorEnabled)},r=l=>{const d=l.target;re({ai:{openaiApiKey:d.value}})},a=l=>{const d=l.target;re({ai:{openaiModel:d.value}})},o=l=>{const d=l.target;re({ai:{indicatorEnabled:d.checked}})};return e==null||e.addEventListener("input",r),t==null||t.addEventListener("change",a),s==null||s.addEventListener("change",o),n(),{detach:()=>{e==null||e.removeEventListener("input",r),t==null||t.removeEventListener("change",a),s==null||s.removeEventListener("change",o)},refreshUI:n}}function np(i){const e=i.querySelector("#grid-color-select"),t=i.querySelector("#note-color-select"),s=i.querySelector("#skin-select"),n=()=>{var d,c,u;const l=V();e&&(e.value=l.theme.gridColorScheme||((d=e.options[0])==null?void 0:d.value)||""),t&&(t.value=l.theme.noteColorScheme||((c=t.options[0])==null?void 0:c.value)||""),s&&(s.value=l.theme.skin||((u=s.options[0])==null?void 0:u.value)||"")},r=l=>{const d=l.target;re({theme:{gridColorScheme:d.value}})},a=l=>{const d=l.target;re({theme:{noteColorScheme:d.value}})},o=l=>{const d=l.target;W.getInstance().stop(),re({theme:{skin:d.value}})};return e==null||e.addEventListener("change",r),t==null||t.addEventListener("change",a),s==null||s.addEventListener("change",o),n(),{detach:()=>{e==null||e.removeEventListener("change",r),t==null||t.removeEventListener("change",a),s==null||s.removeEventListener("change",o)},refreshUI:n}}function ap(i){const e=i.querySelector("#note-tool-toggle");if(!e)return console.warn("[GlobalSettings] Toggle input not found."),{detach:()=>{},refreshUI:()=>{}};const t=()=>{const n=V();e.checked=n.global.noteToolMode==="express"},s=n=>{const a=n.target.checked?"express":"default";re({global:{noteToolMode:a}}),J().forEach(o=>o.resetInteractionMode())};return e.addEventListener("change",s),t(),{detach:()=>e.removeEventListener("change",s),refreshUI:t}}function op(i){let e=!1;const t=()=>{i.refreshToggle()},s=(o,l)=>{if(e)return;e=!0,l.textContent="Press Key...";const d=f=>{if(f.preventDefault(),f.stopPropagation(),["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"].includes(f.code))return;if(f.code==="Escape"){i.refreshToggle(),u();return}const m=n(f);Yn(o,m),i.refreshToggle(),u()},c=f=>{i.element.contains(f.target)||(i.refreshToggle(),u())},u=()=>{window.removeEventListener("keydown",d,!0),window.removeEventListener("click",c,!0),e=!1};window.addEventListener("keydown",d,!0),window.addEventListener("click",c,!0)},n=o=>({code:o.code,ctrl:o.ctrlKey||void 0,shift:o.shiftKey||void 0,alt:o.altKey||void 0,meta:o.metaKey||void 0});for(const{macroName:o,labelEl:l,buttonEl:d}of i.bindings)d.addEventListener("click",()=>{s(o,l)});const r=i.element.querySelector("#keybindings-reset-btn"),a=()=>{Zn(),t()};return r==null||r.addEventListener("click",a),{detach:()=>{for(const{buttonEl:o}of i.bindings)o.replaceWith(o.cloneNode(!0));r==null||r.removeEventListener("click",a)},refreshUI:t}}class lp{constructor(){this.modal=null,this.detachFns=[],this.refreshFns=[],this.initialSnapshot=structuredClone(V()),this.initializeUI()}initializeUI(){this.modal=new Wf;const e=jf(),t=Zf(),s=ep(),n=ip();this.modal.getSectionContainer("global").appendChild(e.element),this.modal.getSectionContainer("theme").appendChild(t),this.modal.getSectionContainer("ai").appendChild(s.element),this.modal.getSectionContainer("keybindings").appendChild(n.element);const r=sp(this.modal,{onSave:()=>Vd(),onClose:()=>re(this.initialSnapshot)}),a=ap(e.element),o=np(t),l=rp(s.element),d=op(n);this.detachFns.push(r,a.detach,o.detach,l.detach,d.detach),this.refreshFns.push(a.refreshUI,o.refreshUI,l.refreshUI,e.refreshToggle,s.refreshToggle,d.refreshUI,n.refreshToggle),sr(),document.body.appendChild(this.modal.render())}show(){var e;this.initialSnapshot=structuredClone(V()),this.refreshFns.forEach(t=>t()),(e=this.modal)==null||e.show()}hide(){var e;(e=this.modal)==null||e.hide()}destroy(){var e;this.detachFns.forEach(t=>t()),(e=this.modal)==null||e.destroy(),this.modal=null,this.detachFns=[],this.refreshFns=[]}reload(){this.destroy(),this.initializeUI()}}function cp(){document.getElementById("add-sequencer").addEventListener("click",()=>{const e=J().length;O(un(e,"sf2/fluidr3-gm/acoustic_grand_piano"),Qi(e))})}function dp(){const i=Q();i.showSplashScreen(),Yd(),ea(),Hd(),Jd(),W.initialize(J());const e=new lp,t=Vt(),s=new Hf,n=new Bf(wd(),e),r=new Rf;n.show(),r.show();const a=Ne.getInstance();a.registerReloadable(()=>r.reload()),a.registerReloadable(()=>s.reload()),a.registerReloadable(()=>e.reload()),a.registerReloadable(()=>n.reload()),a.registerReloadable(()=>i.reload()),a.registerReloadable(()=>t.reload()),Yt(Xd),E("Setting up additional UI..."),Gf(gd,bd),cp();const o=0;O(un(o,"sf2/fluidr3-gm/acoustic_grand_piano"),Qi(o)),O(es("Initial App State"),hn("Initial App State")),i.hideSplashScreen(),rr("Sequenzia initialized"),E("Current state: ",H())}requestAnimationFrame(()=>{dp()});
