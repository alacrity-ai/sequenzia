const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-CZr_p8bz.js","assets/index-C4MulFSQ.js"])))=>i.map(i=>d[i]);
import{_ as It}from"./index-C4MulFSQ.js";function Nt(e=3){const i=["C","D","E","F","G","A","B"],a=["C#","D#","","F#","G#","A#",""],c=[e,e+1,e+2],l={};let r=0;for(const d of c)i.forEach(f=>{const h=`${f}${d}`;l[h]={note:h,x:r,width:60,height:200,isBlack:!1},r+=60});r=0;for(const d of c)a.forEach((f,h)=>{if(f===""){r+=60;return}const u=`${f}${d}`;l[u]={note:u,x:r+60-40/2,width:40,height:120,isBlack:!0},r+=60});return l}function Be(e,t,n=new Set,s=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const o={};if(s)for(const[i,a]of Object.entries(s))o[a]=i;for(const i of Object.values(t))i.isBlack||(ht(e,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",o[i.note]&&(e.fillStyle="#7c3aed",e.fillText(o[i.note],i.x+i.width/2,i.height-24),e.fillStyle="#333"),e.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(t))i.isBlack&&(ht(e,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),Jt(e,i),o[i.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(o[i.note],i.x+i.width/2,i.height-28)))}function ht(e,{x:t,width:n,height:s,fill:o,stroke:i,radius:a=8}){e.beginPath(),e.moveTo(t,0),e.lineTo(t,s-a),e.quadraticCurveTo(t,s,t+a,s),e.lineTo(t+n-a,s),e.quadraticCurveTo(t+n,s,t+n,s-a),e.lineTo(t+n,0),e.closePath(),e.fillStyle=o,e.fill(),e.strokeStyle=i,e.lineWidth=1,e.stroke()}function Jt(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}const ne=64,Vt={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"};function q(e){var i;const t=(i=e==null?void 0:e.match)==null?void 0:i.call(e,/^([A-G]#?)(\d)$/);if(!t)return null;const[n,s]=t.slice(1);return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[n]+12*parseInt(s,10)}function Zt(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function Qt(e){return e.replace(/\d+$/,"")}function Ke(e){return e.includes("#")}function xt(e,t){return e/t()}function en(e,t){let n=t.snapResolution||.25,s=t.isTripletMode?n*(2/3):n;return Math.round(e/s)*s}function tn(e,t,n){const s=xt(e,n);return en(s,t)}function gt(e,t,n,s,o,i=4){e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+s-i,n),e.quadraticCurveTo(t+s,n,t+s,n+i),e.lineTo(t+s,n+o-i),e.quadraticCurveTo(t+s,n+o,t+s-i,n+o),e.lineTo(t+i,n+o),e.quadraticCurveTo(t,n+o,t,n+o-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}function _(e){return e.totalMeasures*e.beatsPerMeasure}function R(e){const t=e.match(/^([A-G]#?)(\d)$/);if(!t)return null;const[n,s,o]=t;return 12+{C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11}[s]+12*parseInt(o,10)}function Ae(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]+(Math.floor(e/12)-1)}function nn(e,t,n,s,o,i,a,c){const{totalMeasures:l,beatsPerMeasure:r}=t,d=_(t)*i;for(let m=0;m<o;m++){const g=m*a,p=c(m);e.fillStyle=Ke(p)?"rgb(174,173,175)":"#fefefe",e.fillRect(0,g,d,a),e.fillStyle=Ke(p)?"#a088b0":"#dddddd",e.fillRect(-64,g,ne,a)}e.font=`${Math.floor(a*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let m=0;m<o;m++){const g=m*a,p=c(m);e.fillStyle=Ke(p)?"#800080":"#444",e.fillText(p,-8,g+a/2)}e.strokeStyle="#ddd",e.lineWidth=1;for(let m=0;m<o;m++){const g=m*a;e.beginPath(),e.moveTo(0,g),e.lineTo(d,g),e.stroke()}const f=o*a;e.beginPath(),e.moveTo(0,f),e.lineTo(d,f),e.stroke();const h=o*a,u=l*r;for(let m=0;m<=u;m++){const g=m*i,p=m%r===0;e.strokeStyle=p?"#bbb":"#eee",e.lineWidth=p?2:1,e.beginPath(),e.moveTo(g,0),e.lineTo(g,h),e.stroke()}const y=l*r*i;e.strokeStyle="#bbb",e.lineWidth=2,e.beginPath(),e.moveTo(y,0),e.lineTo(y,h),e.stroke()}function on(e,t,{previewNotes:n=null,hoveredNote:s,selectedNote:o,selectedNotes:i=[],highlightedNotes:a=[],cellWidth:c,cellHeight:l,visibleStartBeat:r,visibleEndBeat:d,getPitchRow:f,getPitchClass:h,PITCH_COLOR_MAP:u,drawRoundedRect:y}){for(const m of t){if(m.start+m.duration<r||m.start>d)continue;const g=m.start*c,p=f(m.pitch)*l,b=m.duration*c,v=l-1,S=u[h(m.pitch)]||"#999";e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,a.includes(m)?e.fillStyle="rgba(96, 165, 250, 0.6)":e.fillStyle=S,y(e,g,p,b,v),e.fill();const E=e.createLinearGradient(g,p,g,p+v);E.addColorStop(0,"rgba(255,255,255,0.4)"),E.addColorStop(.2,"rgba(255,255,255,0.15)"),E.addColorStop(.5,"rgba(255,255,255,0.05)"),E.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=E,y(e,g,p,b,v),e.fill();const L=i.includes(m),k=m===s,C=a.includes(m);(L||k||C)&&(e.lineWidth=2,L?e.strokeStyle="rgba(59, 130, 246, 1.0)":k?e.strokeStyle="rgba(0, 0, 0, 0.8)":C&&(e.strokeStyle="rgba(96, 165, 250, 0.6)"),y(e,g,p,b,v),e.stroke())}if(n)for(const m of n){const g=m.start*c,p=f(m.pitch)*l,b=m.duration*c,v=l-1,S=u[h(m.pitch)]||"#999";e.fillStyle=sn(S,.4),y(e,g,p,b,v),e.fill()}}function sn(e,t){const n=parseInt(e.slice(1),16);return`rgba(${n>>16&255}, ${n>>8&255}, ${n&255}, ${t})`}function an(e,t,n,s,o,i){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.translate(o-n,-s),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,i),e.stroke(),e.restore()}function ln(e,t,n,s=ne){const o=e.getBoundingClientRect(),i=parseFloat(e.style.width||o.width),a=parseFloat(e.style.height||o.height),c=e.width/i,l=e.height/a,r=(t.clientX-o.left)*c+n.scrollLeft-s,d=(t.clientY-o.top)*l+n.scrollTop;return{x:r,y:d}}function rn(e,t,n,s,o,i){const a=Math.floor(t/o),c=e/i;return n.find(l=>c>=l.start&&c<l.start+l.duration&&s(l.pitch)===a)}const Re=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function pt(e,t,n,s=0){const o=e.getContext("2d"),i=e.width,a=e.height;o.clearRect(0,0,i,a);const c=Re[s%Re.length];o.fillStyle=c;const l=_(n),r=q(n.noteRange[0]),f=q(n.noteRange[1])-r||1,h=Math.max(2,a/f);for(const u of t){const y=u.start/l*i,m=Math.max(1,u.duration/l*i),p=(q(u.pitch)-r)/f,b=a-p*a-h/2;o.fillRect(y,b,m,h)}}function fe(e,t){const n=e.getContext("2d"),s=e.width,o=e.height;n.clearRect(0,0,s,o),t.forEach((i,a)=>{const c=i.notes,l=i.config;if(!(c!=null&&c.length))return;const r=_(l),d=Re[a%Re.length];n.fillStyle=d;const f=q(l.noteRange[0]),u=q(l.noteRange[1])-f||1,y=Math.max(2,o/u);for(const m of c){const g=m.start/r*s,p=Math.max(1,m.duration/r*s),v=(q(m.pitch)-f)/u,S=o-v*o-y/2;n.fillRect(g,S,p,y)}})}function cn(e,t,n,s){const o=e.querySelector(".zoom-in-btn"),i=e.querySelector(".zoom-out-btn"),a=e.querySelector(".zoom-reset-btn");!o||!i||!a||(o.addEventListener("click",t),i.addEventListener("click",n),a.addEventListener("click",s))}function yt(e){let t=null,n=null;function s(r){var g,p;const{x:d,y:f}=e.getCanvasPos(r);if(d<0){const b=e.getPitchFromRow(Math.floor(f/e.getCellHeight()));e.sequencer.playNote(b,.5);return}const h=e.findNoteAt(d,f);if(h){e.setSelectedNote(h),e.scheduleRedraw(),(g=e.onNotesChanged)==null||g.call(e);return}const u=e.getSnappedBeatFromX(d),y=e.getPitchFromRow(Math.floor(f/e.getCellHeight())),m=_(e.config);u+e.config.currentDuration>m||(e.sequencer.playNote(y,.5),e.notes.push({pitch:y,start:u,duration:e.config.currentDuration}),e.scheduleRedraw(),(p=e.onNotesChanged)==null||p.call(e))}function o(r){var u;r.preventDefault();const{x:d,y:f}=e.getCanvasPos(r),h=e.findNoteAt(d,f);if(h){const y=e.notes.indexOf(h);y!==-1&&e.notes.splice(y,1),e.scheduleRedraw(),(u=e.onNotesChanged)==null||u.call(e)}}function i(r){var y;const{x:d,y:f}=e.getCanvasPos(r);if(d<0){e.clearPreview();return}const h=e.findNoteAt(d,f);e.setHoveredNote(h);const u=e.getSelectedNote();if(!t&&u&&u!==h&&e.setSelectedNote(null),!h&&!t){const m=e.getSnappedBeatFromX(d),g=e.getPitchFromRow(Math.floor(f/e.getCellHeight())),p=_(e.config);m+e.config.currentDuration<=p?e.updatePreview({pitch:g,start:m,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&u){const m=d-t.startX,g=e.getSnappedBeatFromX(m)-e.getSnappedBeatFromX(0),p=Math.max(0,t.initialStart+g),b=_(e.config);p+u.duration<=b&&(u.start=p);const v=f-t.startY,S=Math.round(v/e.getCellHeight()),E=t.initialMidi-S,L=R(e.config.noteRange[0]),k=R(e.config.noteRange[1]),C=Math.max(L,Math.min(k,E)),P=Ae(C);P!==u.pitch&&(u.pitch=P,n!==P&&(n=P,e.sequencer.playNote(P,.5))),e.scheduleRedraw(),(y=e.onNotesChanged)==null||y.call(e);return}e.scheduleRedraw()}function a(){e.clearPreview(),e.setHoveredNote(null),e.scheduleRedraw()}function c(r){const{x:d,y:f}=e.getCanvasPos(r),h=e.findNoteAt(d,f);h&&(e.setSelectedNote(h),t={startX:d,startY:f,initialStart:h.start,initialMidi:R(h.pitch)})}function l(){t=null}return{attach(r){r.addEventListener("click",s),r.addEventListener("contextmenu",o),r.addEventListener("mousemove",i),r.addEventListener("mouseleave",a),r.addEventListener("mousedown",c),r.addEventListener("mouseup",l)},detach(r){r.removeEventListener("click",s),r.removeEventListener("contextmenu",o),r.removeEventListener("mousemove",i),r.removeEventListener("mouseleave",a),r.removeEventListener("mousedown",c),r.removeEventListener("mouseup",l)}}}let re=null;function dn(e){re&&re!==e&&re.clearSelection(),re=e}function un(){re=null}function Le(){return re}let $e=!1,Fe=null,$=null;function fn(e){$e=!0,Fe=e,$=null}function nt(){var e;$&&($.gridContext.setPastePreviewNotes(null),$.scheduleRedraw(),(e=$.setCursor)==null||e.call($,"default")),$e=!1,Fe=null,$=null,document.body.style.cursor="default"}function Ge(){return $e}function mn(e,t){!$e||!Fe||(Fe(e,t),nt())}function hn(e){$&&$!==e&&($.gridContext.setPastePreviewNotes(null),$.scheduleRedraw()),$=e}let Ct={notes:[],anchorBeat:0,anchorMidi:0};function bt(e){if(e.length===0)return;const t=e[0],n=t.start,s=R(t.pitch);Ct={notes:e.map(o=>({pitch:o.pitch,start:o.start,duration:o.duration})),anchorBeat:n,anchorMidi:s}}function Pt(){return Ct}function vt(e){let t=null;function n(c){var h;c.preventDefault();const{x:l,y:r}=e.getCanvasPos(c),d=e.findNoteAt(l,r);if(!d)return;const f=e.getSelectedNotes();if(f.includes(d)){for(const u of f){const y=e.notes.indexOf(u);y!==-1&&e.notes.splice(y,1)}e.setSelectedNotes([])}else{const u=e.notes.indexOf(d);u!==-1&&e.notes.splice(u,1)}e.scheduleRedraw(),(h=e.onNotesChanged)==null||h.call(e)}function s(c){if(Ge()){mn(e.grid,c),c.preventDefault(),c.stopPropagation();return}const{x:l,y:r}=e.getCanvasPos(c);if(l<0)return;const d=e.findNoteAt(l,r);e.setHoveredNote(d),dn(e.grid);const f=e.getSelectedNotes();if(d&&f.includes(d)){t={startX:l,startY:r,anchorNote:d,initialNotes:f.map(h=>({note:h,start:h.start,midi:R(h.pitch)}))};return}e.selectionBox={active:!0,startX:l,startY:r,currentX:l,currentY:r},e.clearPreview(),e.setSelectedNote(null)}function o(c){var f,h;hn(e.grid);const{x:l,y:r}=e.getCanvasPos(c),d=e.findNoteAt(l,r);if(e.setHoveredNote(d),Ge()){const{notes:u,anchorBeat:y,anchorMidi:m}=Pt(),g=e.getSnappedBeatFromX(l),p=e.getPitchFromRow(Math.floor(r/e.getCellHeight())),b=R(p),v=g-y,S=b-m,E=u.map(L=>({pitch:Ae(R(L.pitch)+S),start:L.start+v,duration:L.duration}));e.setPastePreviewNotes(E),e.scheduleRedraw();return}else e.setPastePreviewNotes(null);if((f=e.selectionBox)!=null&&f.active){e.selectionBox.currentX=l,e.selectionBox.currentY=r;const u=e.selectionBox,y=Math.min(u.startX,u.currentX),m=Math.min(u.startY,u.currentY),g=Math.max(u.startX,u.currentX),p=Math.max(u.startY,u.currentY),b=Math.floor(m/e.getCellHeight()),v=Math.floor(p/e.getCellHeight()),S=e.getSnappedBeatFromX(y),E=e.getSnappedBeatFromX(g),L=R(e.getPitchFromRow(b)),k=R(e.getPitchFromRow(v)),C=e.notes.filter(P=>{const F=R(P.pitch),W=P.start,A=P.start+P.duration,z=W>=S&&A<=E,se=F>=k&&F<=L;return z&&se});e.setHighlightedNotes(C),e.scheduleRedraw();return}if(t){const u=l-t.startX,y=e.getSnappedBeatFromX(u)-e.getSnappedBeatFromX(0),m=r-t.startY,g=Math.round(m/e.getCellHeight()),p=_(e.config),b=R(e.config.noteRange[0]),v=R(e.config.noteRange[1]);for(const{note:E,start:L,midi:k}of t.initialNotes){const C=Math.max(0,L+y),P=Math.max(b,Math.min(v,k-g)),F=Ae(P);C+E.duration<=p&&(E.start=C,E.pitch=F)}const S=t.initialNotes.find(E=>E.note===t.anchorNote);if(S){const E=S.note.pitch;t.lastPreviewPitch!==E&&(t.lastPreviewPitch=E,e.sequencer.playNote(E,.5))}e.scheduleRedraw(),(h=e.onNotesChanged)==null||h.call(e)}}function i(c){var l;if(t=null,(l=e.selectionBox)!=null&&l.active){const{x:r,y:d}=e.getCanvasPos(c);e.selectionBox.currentX=r,e.selectionBox.currentY=d,e.selectionBox.active=!1;const f=e.selectionBox,h=Math.min(f.startX,f.currentX),u=Math.min(f.startY,f.currentY),y=Math.max(f.startX,f.currentX),m=Math.max(f.startY,f.currentY),g=Math.floor(u/e.getCellHeight()),p=Math.floor(m/e.getCellHeight()),b=e.getSnappedBeatFromX(h),v=e.getSnappedBeatFromX(y),S=R(e.getPitchFromRow(g)),E=R(e.getPitchFromRow(p)),L=e.notes.filter(k=>{const C=R(k.pitch),P=k.start,F=k.start+k.duration,W=P>=b&&F<=v,A=C>=E&&C<=S;return W&&A});e.setHighlightedNotes([]),e.setSelectedNotes(L),e.scheduleRedraw()}}function a(){e.setHoveredNote(null),e.setHighlightedNotes([]),Ge()&&e.setPastePreviewNotes(null),e.scheduleRedraw()}return{attach(c){c.addEventListener("mousedown",s),c.addEventListener("mousemove",o),c.addEventListener("mouseup",i),c.addEventListener("mouseleave",a),c.addEventListener("contextmenu",n)},detach(c){c.removeEventListener("mousedown",s),c.removeEventListener("mousemove",o),c.removeEventListener("mouseup",i),c.removeEventListener("mouseleave",a),c.removeEventListener("contextmenu",n)}}}const ot={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let Tt=ot.NOTE_PLACEMENT;const Ye=new Set;function st(){return Tt}function ke(e){nt(),Tt=e;for(const t of Ye)t(e)}function gn(e){return Ye.add(e),()=>Ye.delete(e)}function pn(e,t,n,s,o,i){let a=null,c=null,l=null,r=null,d=0,f=0;const h=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:50,cellHeight:25},{cellWidth:60,cellHeight:30}];let u=2;const y=e.getContext("2d"),m=t.getContext("2d");let g=h[u].cellWidth,p=h[u].cellHeight;const b=q(o.noteRange[1])-q(o.noteRange[0])+1,v=b*p,E=_(o)*g+ne;e.width=E,e.height=v,e.style.width=`${E}px`,e.style.height=`${v}px`,t.width=E,t.height=v,t.style.width=`${E}px`,t.style.height=`${v}px`,n.addEventListener("scroll",()=>{d=n.scrollLeft,f=n.scrollTop,k()});let L=null;function k(){L!==null&&cancelAnimationFrame(L),L=requestAnimationFrame(C)}function C(){var H;y.clearRect(0,0,e.width,e.height),y.save(),y.translate(-d+ne,-f);const w=B.getSelectedNotes();if(nn(y,o,d,f,b,g,p,he),on(y,s,{previewNotes:c??(a?[a]:null),hoveredNote:l,selectedNote:r,selectedNotes:w,highlightedNotes:B.getHighlightedNotes(),cellWidth:g,cellHeight:p,visibleStartBeat:d/g,visibleEndBeat:(d+e.width)/g,getPitchRow:me,getPitchClass:Qt,PITCH_COLOR_MAP:Vt,drawRoundedRect:gt}),(H=B.selectionBox)!=null&&H.active){const K=B.selectionBox,G=K.startX,ut=K.startY,ft=K.currentX,mt=K.currentY,Ut=Math.min(G,ft),jt=Math.min(ut,mt),Yt=Math.abs(ft-G),zt=Math.abs(mt-ut);y.save(),y.strokeStyle="rgba(128, 90, 213, 1.0)",y.lineWidth=2,y.setLineDash([5,5]),gt(y,Ut,jt,Yt,zt,3),y.stroke(),y.restore()}y.restore()}function P(){u<h.length-1&&(u++,A())}function F(){u>0&&(u--,A())}function W(){u=2,A()}function A(){const w=h[u];g=w.cellWidth,p=w.cellHeight,z()}function z(){const H=_(o)*g+ne,G=(q(o.noteRange[1])-q(o.noteRange[0])+1)*p;e.width=H,e.height=G,e.style.width=`${H}px`,e.style.height=`${G}px`,t.width=H,t.height=G,t.style.width=`${H}px`,t.style.height=`${G}px`,k()}function se(w){an(m,w,d,f,ne,e.height)}cn(i.container,P,F,W);function me(w){return q(o.noteRange[1])-q(w)}function he(w){const K=q(o.noteRange[1])-w,G=Math.max(q(o.noteRange[0]),Math.min(q(o.noteRange[1]),K));return Zt(G)}function Se(){const w=document.getElementById("global-mini-contour");w&&fe(w,N)}let J=null,M=[];const B={sequencer:i,grid:null,config:o,notes:s,getCellHeight:()=>p,getCanvasPos:w=>ln(e,w,n,ne),findNoteAt:(w,H)=>rn(w,H,s,me,p,g),scheduleRedraw:k,getPitchFromRow:he,getSnappedBeatFromX:w=>tn(w,o,()=>g),updatePreview:w=>a=w,clearPreview:()=>a=null,getSelectedNote:()=>r,setSelectedNote:w=>{r=w,M=w?[w]:[]},getSelectedNotes:()=>M,setSelectedNotes:w=>{M=w,r=w.length===1?w[0]:null},setHoveredNote:w=>l=w,onNotesChanged:Se};function T(w){J&&J.detach(e),J=w,J&&J.attach(e)}function O(){r=null,M=[],l=null,Me=[],k()}const x=st();T(x==="note-placement"?yt(B):x==="select"?vt(B):null);let Gt=gn(w=>{var H,K;a=null,c=null,Me=[],(H=B.clearPreview)==null||H.call(B),(K=B.setPastePreviewNotes)==null||K.call(B,null),B.selectionBox&&(B.selectionBox.active=!1,B.selectionBox=null),O(),T(w==="note-placement"?yt(B):w==="select"?vt(B):null),k()});const dt={canvas:e,scheduleRedraw:k,drawPlayhead:se,getSelectedNote:()=>r,clearSelection:O,getPreviewNote:()=>a,zoomIn:P,zoomOut:F,getXForBeat:w=>w*g,setMouseHandler:T,setCursor:w=>{e.style.cursor=w},gridContext:B,getSelectedNotes:()=>M,setSelectedNotes:w=>{M=w,r=w.length===1?w[0]:null},destroy(){Gt(),un()}};B.setPastePreviewNotes=w=>{c=w};let Me=[];return B.getHighlightedNotes=()=>Me,B.setHighlightedNotes=w=>{Me=w},B.grid=dt,dt}let X=null,ye=500,Pe=null,ze=!1,Je=1/0,ue=[],Te=null,At=0;function Ve(e){return ue.push(e),()=>{const t=ue.indexOf(e);t!==-1&&ue.splice(t,1)}}function yn(){ue=[]}function Z(e){At=e}function qe(){return At}function bn(e){Te=e}function vn(e,t={}){ye=60/e*1e3,ze=t.loop??!1,Je=t.endBeat??1/0;const n=t.startBeat??0;Pe=performance.now()-n*ye;const s=t.onLoop;function o(i){const c=(i-Pe)/ye;if(Z(c),ue.forEach(l=>l(c)),c>=Je)if(ze)Pe=performance.now(),Z(0),s&&s();else{_e();return}X=requestAnimationFrame(o)}X=requestAnimationFrame(o)}function _e(){X&&cancelAnimationFrame(X),X=null,yn(),Te&&(Te(),Te=null)}function En(){return X!==null}function Rt(){X&&cancelAnimationFrame(X),X=null}function Ft(){if(X)return;const e=performance.now()-qe()*ye;function t(n){const o=(n-e)/ye;if(Z(o),ue.forEach(i=>i(o)),o>=Je)if(ze)Pe=performance.now(),Z(0);else{_e();return}X=requestAnimationFrame(t)}X=requestAnimationFrame(t)}const wn={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function Xe(e){const t=e.match(/^([A-Ga-g][#b]?)(-?\d+)$/);if(!t)return null;const[,n,s]=t,o=n.toUpperCase(),i=wn[o];return i===void 0?null:12*(parseInt(s,10)+1)+i}class qt{constructor(t,n,s=Y,o=j,i="fluidr3-gm/acoustic_grand_piano"){this.container=t,this.config={...n},this.context=s,this.destination=o,this.instrumentName=i,this.notes=[],this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.isMuted=!1,this.isSoloed=!1,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this._initCanvases())}async initInstrument(){try{await De(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){const t=this.container.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument(),console.log(`[SEQ:${this.id}] Instrument set to:`,t)}playNote(t,n,s=100,o=!1){return Vn(this.instrumentName,t,n,s,o)}_initCanvases(){const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),s=this.container.querySelector("#grid-scroll-container");this.grid=pn(t,n,s,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(t){this.config.totalMeasures=t;const n=_(this.config);this.clampNotesToGrid();const s=n*this.config.cellWidth+(this.config.labelWidth||64),o=this.container.querySelector("canvas.note-grid"),i=this.container.querySelector(".playhead-canvas");o&&(o.width=s,o.style.width=`${s}px`),i&&(i.width=s,i.style.width=`${s}px`),this.redraw()}clampNotesToGrid(){const t=_(this.config),n=this.notes.filter(s=>s.start<t);n.forEach(s=>{s.start+s.duration>t&&(s.duration=t-s.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear();const n=60/this.config.bpm;this._beatHandler=s=>{var o;if((o=this.grid)==null||o.drawPlayhead(this.grid.getXForBeat(s)),!!this.shouldPlay)for(const i of this.notes){const a=i.start,c=i.start+i.duration;if(!this._activeNotes.has(i)&&a<=s&&s<=c){const l=i.duration*n;this.playNote(i.pitch,l),this._activeNotes.add(i)}}},this._unsub=Ve(this._beatHandler),this._beatHandler(0)}stop(){var t,n,s;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const o of this._activeNotes){const i=this._noteHandlers.get(o);(t=i==null?void 0:i.forceStop)==null||t.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(s=this.grid)==null||s.drawPlayhead(null),this.redraw()}pause(){var t;for(const n of this._activeNotes){const s=this._noteHandlers.get(n);(t=s==null?void 0:s.stop)==null||t.call(s)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=Ve(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.isMuted=!this.isMuted,this.isMuted&&(this.isSoloed=!1),this.updateTrackStyle()}toggleSolo(){this.isSoloed=!this.isSoloed,this.isSoloed&&(this.isMuted=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t.classList.toggle("bg-red-600",this.isMuted),t.classList.toggle("bg-gray-700",!this.isMuted),n.classList.toggle("bg-yellow-200",this.isSoloed),n.classList.toggle("bg-gray-700",!this.isSoloed),this.container.classList.toggle("opacity-40",this.isMuted&&!this.isSoloed),this.container.classList.toggle("opacity-100",!(this.isMuted&&!this.isSoloed))}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,s,o])=>({pitch:n,start:s,duration:o})))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:s}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),s&&(this.instrumentName=s),this.redraw()}async exportToOffline(){const t=60/this.config.bpm,n=await De(this.instrumentName,this.context,this.destination);for(const s of this.notes){const o=s.start*t,i=s.duration*t;n.start({note:Xe(s.pitch),duration:i,velocity:100,time:o,loop:!1})}}}async function Bn(e){var i,a,c,l,r,d,f;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!n||!Array.isArray(n.notes))throw new Error("JSON file missing required `notes` array.");const s=n.notes.map(h=>({pitch:h.pitch,start:h.start,duration:h.duration})),o={bpm:((i=n.config)==null?void 0:i.bpm)??120,snapResolution:((a=n.config)==null?void 0:a.snapResolution)??.125,currentDuration:((c=n.config)==null?void 0:c.currentDuration)??.25,noteRange:((l=n.config)==null?void 0:l.noteRange)??["C3","B5"],totalBeats:((r=n.config)==null?void 0:r.totalBeats)??100,beatsPerMeasure:((d=n.config)==null?void 0:d.beatsPerMeasure)??4,totalMeasures:((f=n.config)==null?void 0:f.totalMeasures)??8};return[{notes:s,config:o}]}async function Sn(e){var c,l,r;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const s=((c=n.c)==null?void 0:c.b)??120,o=((l=n.c)==null?void 0:l.bpm)??4,i=((r=n.c)==null?void 0:r.tm)??8,a=Array.isArray(n.i)?n.i:[];return n.tr.map((d,f)=>{if(!Array.isArray(d.n))throw new Error("Track missing `n` (notes) array.");const h=d.n.map(([m,g,p])=>({pitch:m,start:g,duration:p})),u={bpm:s,beatsPerMeasure:o,totalMeasures:i},y=a[f]||"fluidr3-gm/acoustic_grand_piano";return{notes:h,config:u,instrument:y}})}const I={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,bpm:220,loopEnabled:!1,useEqualTemperament:!0,beatsPerMeasure:4,totalMeasures:8},N=[],Mn=document.getElementById("sequencers-container"),Ln=document.getElementById("sequencer-template"),_t=document.getElementById("add-sequencer");function it(e,t){var n,s,o,i;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(s=e.querySelector(".zoom-out-btn"))==null||s.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-reset-btn"))==null||o.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!t)}function at(){return N}function kn(e){const t=String(e);return at().find(n=>{var s;return String(n.id)===t||String((s=n.config)==null?void 0:s.id)===t})}function Et(){const e=N.some(t=>t.solo);N.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function ge(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function lt(e){const n=Ln.content.cloneNode(!0).querySelector(".sequencer");Mn.insertBefore(n,_t);const s=N.length,o=e?{id:s,...I,...e.config}:{id:s,...I},i=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",a=new qt(n,o,Y,j,i);a.id=s,a.colorIndex=s,a.mute=!1,a.solo=!1,a.shouldPlay=!0;const c=n.querySelector("canvas.mini-contour");e&&a.setState(e),pt(c,a.notes,a.config,a.colorIndex),a.updateTrackLabel(),a.initInstrument();const l=n.querySelector(".collapse-btn"),r=l.querySelector("use"),d=n.querySelector(".sequencer-body");l.addEventListener("click",()=>{const m=d.classList.toggle("hidden");r.setAttribute("href",m?"#icon-caret-up":"#icon-caret-down"),c.classList.toggle("hidden",!m),it(n,!m),m&&pt(c,a.notes,a.config,a.colorIndex)});const f=n.querySelector(".delete-btn");f.innerHTML=`
    <svg class="w-6 h-6" aria-hidden="true">
      <use href="#icon-close-circle"></use>
    </svg>
  `,f.addEventListener("click",()=>{const m=document.getElementById("delete-confirm-modal"),g=document.getElementById("delete-confirm"),p=document.getElementById("delete-cancel");m.classList.remove("hidden");const b=()=>{a.destroy();const E=N.indexOf(a);E>=0&&N.splice(E,1),S()},v=()=>{S()},S=()=>{m.classList.add("hidden"),g.removeEventListener("click",b),p.removeEventListener("click",v)};g.addEventListener("click",b),p.addEventListener("click",v)});const h=n.querySelector(".mute-btn"),u=n.querySelector(".solo-btn"),y=n.querySelector(".instrument-select-btn");return h.addEventListener("click",()=>{a.mute=!a.mute,a.mute&&(a.solo=!1,u.classList.remove("bg-yellow-200"),u.classList.add("bg-gray-700"),u.classList.remove("hover:bg-yellow-400"),u.classList.add("hover:bg-purple-700"),ge(u,!1)),ge(h,a.mute),Et();const m=qe();a.seekTo(m)}),u.addEventListener("click",()=>{a.solo=!a.solo,a.solo&&(a.mute=!1,ge(h,!1)),u.classList.toggle("bg-yellow-200",a.solo),u.classList.toggle("bg-gray-700",!a.solo),u.classList.toggle("hover:bg-yellow-400",a.solo),u.classList.toggle("hover:bg-purple-700",!a.solo),Et();const m=qe();a.seekTo(m)}),y.addEventListener("click",async()=>{const m=document.getElementById("instrument-select-modal"),g=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const p=a.instrumentName||"fluidr3-gm/acoustic_grand_piano",[b,v]=p.split("/");g.value=b,await g.dispatchEvent(new CustomEvent("change",{detail:{preselect:p}})),m.dataset.currentSequencer=a.id,m.classList.remove("hidden")}),ge(h,!1),ge(u,!1),u.classList.add("hover:bg-purple-700"),N.push(a),{seq:a,wrapper:n}}function In(){N.slice().forEach(e=>e.destroy()),N.length=0}function Nn(){const e=document.getElementById("global-mini-contour");_t.addEventListener("click",()=>{lt(),fe(e,N)})}const oe={openaiApiKey:"",openaiModel:"gpt-4o"};function Ze(){return oe.openaiApiKey}function wt(){return oe.openaiModel}function Cn(e){oe.openaiApiKey=e}function Pn(e){const t=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];if(!t.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${t.join(", ")}`);oe.openaiModel=e}function Tn(){localStorage.setItem("userConfig",JSON.stringify(oe))}function An(){const e=localStorage.getItem("userConfig");if(e){const t=JSON.parse(e);oe.openaiApiKey=t.openaiApiKey||"",oe.openaiModel=t.openaiModel||"gpt-4o"}}An();function Rn(){const e=document.getElementById("userconfig-modal"),t=document.getElementById("config-save"),n=document.getElementById("config-close"),s=document.getElementById("openai-key-input"),o=document.getElementById("openai-model-select");s.value=Ze(),o.value=wt(),t.addEventListener("click",()=>{Cn(s.value),Pn(o.value),Tn(),e.classList.add("hidden")}),n.addEventListener("click",()=>{s.value=Ze(),o.value=wt(),e.classList.add("hidden")}),document.getElementById("key-not-set-ok").addEventListener("click",()=>{document.getElementById("openai-key-not-set-modal").classList.add("hidden")})}const Fn={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"};let Bt=!1,ee=!1,te=!1;function qn({getSequencers:e,onPlay:t,onStop:n,onPause:s,onResume:o,onDurationChange:i,onSnapChange:a,onToggleLoop:c,onTempoChange:l,onSave:r,onLoad:d,onMeasuresChange:f,onBeatsPerMeasureChange:h}){if(Bt)return;Bt=!0;const u=document.getElementById("play-button"),y=u.querySelector("use"),m=document.getElementById("stop-button"),g=document.getElementById("note-duration"),p=document.getElementById("dotted-note-btn"),b=document.getElementById("triplet-note-btn");g.value=String(I.currentDuration||1);const v=document.getElementById("snap-resolution");v.value=String(I.snapResolution||.25);const S=document.getElementById("loop-toggle"),E=document.getElementById("tempo-input"),L=document.getElementById("save-button"),k=document.getElementById("load-button"),C=document.getElementById("load-input"),P=document.getElementById("measures-input"),F=document.getElementById("beats-per-measure-input"),W=document.getElementById("config-button"),A=document.getElementById("export-modal"),z=document.getElementById("export-json"),se=document.getElementById("export-wav"),me=document.getElementById("export-midi"),he=document.getElementById("export-cancel");y.setAttribute("href","#icon-play"),u.addEventListener("click",()=>{!ee&&!te?(ee=!0,te=!1,t==null||t(),y.setAttribute("href","#icon-pause")):ee?(ee=!1,te=!0,s==null||s(),y.setAttribute("href","#icon-play")):te&&(ee=!0,te=!1,o==null||o(),y.setAttribute("href","#icon-pause"))}),m.addEventListener("click",()=>{n==null||n(),ee=!1,te=!1,y.setAttribute("href","#icon-play")});const Se={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125};window.addEventListener("keydown",M=>{var O;if(document.querySelector(".ai-modal:not(.hidden)"))return;const T=(O=document.activeElement)==null?void 0:O.tagName;if(!(T==="INPUT"||T==="TEXTAREA")){if(M.code==="Space"){M.preventDefault(),u.click();return}if(st()===ot.NOTE_PLACEMENT){if(Se.hasOwnProperty(M.code)){M.preventDefault();const x=Se[M.code];g.value=x,g.dispatchEvent(new Event("change"))}if(M.key==="."){M.preventDefault(),p==null||p.click();return}if(M.key==="/"){M.preventDefault(),b==null||b.click();return}}}}),g.addEventListener("change",M=>{const B=parseFloat(M.target.value);J(B),i==null||i(B),e==null||e().forEach(T=>{const O=T.grid;if(O!=null&&O.getPreviewNote){const x=O.getPreviewNote();x&&(x.duration=B,O.scheduleRedraw())}})});function J(M){document.querySelectorAll(".note-duration-btn").forEach(T=>{const O=parseFloat(T.dataset.value);T.classList.remove("bg-purple-700"),T.classList.remove("bg-gray-800"),O===M?T.classList.add("bg-purple-700"):T.classList.add("bg-gray-800")})}v.addEventListener("change",M=>{const B=M.target.value;Fn.hasOwnProperty(B)&&(I.snapResolution=parseFloat(B),v.value=String(B),a==null||a(I.snapResolution))}),S.addEventListener("change",M=>{c==null||c(M.target.checked)}),E.addEventListener("change",M=>{const B=parseInt(M.target.value,10);isNaN(B)||l==null||l(B)}),L.addEventListener("click",()=>{A?A.classList.remove("hidden"):r==null||r("json")}),k.addEventListener("click",()=>{C.click()}),C.addEventListener("change",M=>{const B=M.target.files[0];B&&(d==null||d(B)),M.target.value=""}),z&&z.addEventListener("click",()=>{A.classList.add("hidden"),r==null||r("json")}),se&&se.addEventListener("click",()=>{A.classList.add("hidden"),r==null||r("wav")}),me&&me.addEventListener("click",()=>{A.classList.add("hidden"),r==null||r("midi")}),he&&he.addEventListener("click",()=>{A.classList.add("hidden")}),W.addEventListener("click",()=>{document.getElementById("userconfig-modal").classList.remove("hidden")}),Rn(),P.value=I.totalMeasures,F.value=I.beatsPerMeasure,P.addEventListener("change",M=>{const B=parseInt(M.target.value,10);!isNaN(B)&&B>0&&(f==null||f(B))}),F.addEventListener("change",M=>{const B=parseInt(M.target.value,10);!isNaN(B)&&B>0&&(h==null||h(B))}),J(parseFloat(g.value))}function _n(){ee=!1,te=!1;const t=document.getElementById("play-button").querySelector("use");t&&t.setAttribute("href","#icon-play")}function Mo(e){const t=document.getElementById("measures-input");t&&(t.value=e)}function Dn(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function On(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}let D=null,be=0;const Ue=new Map;async function Q(){D||(D=await It(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function Dt(){return Y}async function De(e,t=Y,n=null){await Q();const[s,o]=e.includes("/")?e.split("/"):["musyngkite",e],i=t instanceof OfflineAudioContext;Ue.has(t)||Ue.set(t,new Map);const a=Ue.get(t),c=`${s}/${o}`;if(a.has(c))return a.get(c);let l;if(s==="smolken")l=new D.Smolken(t,{instrument:o,destination:n||j,disableScheduler:i}),await ie(l.load);else if(s==="splendidgrandpiano")l=new D.SplendidGrandPiano(t,{destination:n||j,disableScheduler:i}),await ie(l.load);else if(s==="electricpiano")l=new D.ElectricPiano(t,{instrument:o,destination:n||j,disableScheduler:i}),await ie(l.load);else if(s==="mallets")l=new D.Mallet(t,{instrument:o,destination:n||j,disableScheduler:i}),await ie(l.load);else if(s==="drummachines"){l=new D.DrumMachine(t,{instrument:o,destination:n||j,disableScheduler:i}),await ie(l.load);const r=l.getSampleNames(),d=new Map;r.forEach((f,h)=>{const u=36+h;d.set(u,f)}),l.__midiMap=d}else{const d={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[s.toLowerCase()]||"MusyngKite",f=await Un();console.log(`[Soundfont] Available kits: ${f.join(", ")}`),console.log(`[Soundfont] Requested: kit=${d} instrument=${o}`);const u=`https://gleitz.github.io/midi-js-soundfonts/${d}/${o}-ogg.js`;l=new D.Soundfont(t,{instrument:o,instrumentUrl:u,kit:d,destination:n||j,disableScheduler:i}),await ie(l.load)}return a.set(c,l),l}async function Hn(){return await Q(),D.getMalletNames()}async function $n(){return await Q(),D.getElectricPianoNames()}async function Xn(){return await Q(),["splendidgrandpiano"]}async function Wn(){return await Q(),D.getDrumMachineNames()}async function Kn(){return await Q(),D.getSmolkenNames()}async function Gn(e="MusyngKite"){await Q();const t=await D.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function Un(){return await Q(),D.getSoundfontKits()}function jn(){be++,be===1&&Dn()}function Yn(){be--,be<=0&&(be=0,On())}async function ie(e){jn();try{await e}finally{Yn()}}let V=null,Qe=null;async function St(e){if(Qe===e)return;V=await De(e),Qe=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function zn(){return Qe}function Ot(e,t=100,n=!1){var c;if(!V)return null;const o=Dt().currentTime,i=Xe(e),a=((c=V.__midiMap)==null?void 0:c.get(i))??i;return V.start({note:a,stopId:a,velocity:t,time:o,loop:n}),()=>{V.stop({stopId:a})}}function Jn(e){var s;if(!V)return;const t=Xe(e),n=((s=V.__midiMap)==null?void 0:s.get(t))??t;V.stop({stopId:n})}async function Vn(e,t,n,s=100,o=!1,i=null,a=null,c=null){var h;const l=a||Dt(),r=await De(e,l,c),d=Xe(t),f=((h=r.__midiMap)==null?void 0:h.get(d))??d;return r.start({note:f,duration:n,velocity:s,loop:o,time:i??l.currentTime}),null}const Y=new(window.AudioContext||window.webkitAudioContext),We=Y.createAnalyser();We.fftSize=2048;const j=Y.createGain();j.connect(We);We.connect(Y.destination);function Zn(e){Y.resume();try{const t=Ot(e,100,20);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}Y.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let Mt=!1,Ie=null;function Qn(e,t){if(Mt)return;Mt=!0,Ie=t;const n=e.getContext("2d"),s=new Map,o=new Set;function i(d,f){const h=Ie();for(const u of Object.values(h))if(u.isBlack&&d>=u.x&&d<=u.x+u.width&&f>=0&&f<=u.height)return u.note;for(const u of Object.values(h))if(!u.isBlack&&d>=u.x&&d<=u.x+u.width&&f>=0&&f<=u.height)return u.note;return null}function a(d){if(!d||o.has(d))return;const f=Zn(d);f&&(s.set(d,f),o.add(d),Be(n,Ie(),o))}function c(d){if(!o.has(d))return;const f=s.get(d);f&&(f.stop(),s.delete(d)),o.delete(d),Be(n,Ie(),o)}function l(){for(const d of o)c(d)}let r=!1;e.addEventListener("mousedown",d=>{r=!0;const f=e.getBoundingClientRect(),h=d.clientX-f.left,u=d.clientY-f.top,y=i(h,u);a(y)}),e.addEventListener("mousemove",d=>{if(!r)return;const f=e.getBoundingClientRect(),h=d.clientX-f.left,u=d.clientY-f.top,y=i(h,u);a(y)}),e.addEventListener("mouseup",()=>{r=!1,l()}),e.addEventListener("mouseleave",()=>{r=!1,l()})}const Ht=[..."qwertyuiop[zxcvbnm,./"],$t=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];let xe=!1,Ne=null,ve=null,Ee=null;function xn(e,t){if(xe)return;xe=!0;const n=e.getContext("2d"),s=new Set,o=new Set,i=new Map,a=Ht,c=$t;Ne=t;function l(){const f=Ne(),h=Object.values(f).filter(m=>!m.isBlack).sort((m,g)=>m.x-g.x).map(m=>m.note),u=Object.values(f).filter(m=>m.isBlack).sort((m,g)=>m.x-g.x).map(m=>m.note),y={};return a.forEach((m,g)=>{h[g]&&(y[m]=h[g])}),c.forEach((m,g)=>{u[g]&&(y[m]=u[g])}),y}function r(f){const h=l(),u=h[f];if(!(!u||s.has(f))){if(s.add(f),!o.has(u)){const y=Ot(u,100,no());y&&(i.set(u,{stop:y}),o.add(u))}Be(n,Ne(),o,h)}}function d(f){const h=l(),u=h[f];u&&(s.delete(f),o.has(u)&&(Jn(u),i.delete(u),o.delete(u)),Be(n,Ne(),o,h))}ve=f=>{f.repeat||r(f.key)},Ee=f=>{d(f.key)},window.addEventListener("keydown",ve),window.addEventListener("keyup",Ee)}function eo(){ve&&(window.removeEventListener("keydown",ve),ve=null),Ee&&(window.removeEventListener("keyup",Ee),Ee=null),xe=!1}let le=3,ae=Nt(le),Ce=!1;async function to(e){const t=e.getContext("2d");await St("fluidr3-gm/acoustic_grand_piano");const n=Ht,s=$t;function o(){const g=Object.values(ae).filter(v=>!v.isBlack).sort((v,S)=>v.x-S.x).map(v=>v.note),p=Object.values(ae).filter(v=>v.isBlack).sort((v,S)=>v.x-S.x).map(v=>v.note),b={};return n.forEach((v,S)=>{g[S]&&(b[v]=g[S])}),s.forEach((v,S)=>{p[S]&&(b[v]=p[S])}),b}function i(){ae=Nt(le);const g=Ce?o():null;Be(t,ae,new Set,g)}Qn(e,()=>ae),i(),document.getElementById("octave-up").addEventListener("click",()=>{le<7&&(le++,i())}),document.getElementById("octave-down").addEventListener("click",()=>{le>1&&(le--,i())});const a=document.getElementById("disable-keyboard-inputs");a.classList.remove("bg-purple-600"),a.classList.add("bg-gray-700"),a.addEventListener("click",()=>{Ce=!Ce,Ce?(xn(e,()=>ae),a.classList.remove("bg-gray-700"),a.classList.add("bg-purple-600")):(eo(),a.classList.remove("bg-purple-600"),a.classList.add("bg-gray-700")),i()});const c=document.getElementById("instrument-select-btn"),l=document.getElementById("instrument-select-modal"),r=document.getElementById("instrument-select"),d=document.getElementById("instrument-select-confirm"),f=document.getElementById("instrument-cancel-btn"),h=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([g,p])=>{const b=document.createElement("option");b.value=g,b.textContent=g.replace(/_/g," ").replace(/\b\w/g,v=>v.toUpperCase()),h.appendChild(b)}),h.addEventListener("change",async g=>{var S;const p=h.value,b=document.getElementById("instrument-select"),v=((S=g.detail)==null?void 0:S.preselect)||null;try{let E;p==="mallets"?E=await Hn():p==="electricpiano"?E=await $n():p==="splendidgrandpiano"?E=await Xn():p==="drummachines"?E=await Wn():p==="smolken"?E=await Kn():["fluidr3-gm","musyngkite","fatboy"].includes(p)?E=await Gn({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[p]):E=await(await fetch(`/static/${p}.json`)).json(),b.innerHTML="",E.forEach(L=>{const k=document.createElement("option");k.value=`${p}/${L}`,k.textContent=L.split("_").map(C=>C.charAt(0).toUpperCase()+C.slice(1)).join(" "),b.appendChild(k)}),b.value=v||`${p}/${E[0]}`}catch(E){console.error(`Failed to load instruments for library: ${p}`,E)}}),h.dispatchEvent(new Event("change")),c.addEventListener("click",async()=>{const g=zn()||"fluidr3-gm/acoustic_grand_piano",[p,b]=g.split("/");h.value=p,await h.dispatchEvent(new CustomEvent("change",{detail:{preselect:g}})),l.classList.remove("hidden"),delete l.dataset.currentSequencer}),d.addEventListener("click",async()=>{const g=r.value;l.classList.add("hidden");const p=l.dataset.currentSequencer;if(p){console.log("[Modal] Looking up sequencer with id:",p);const b=kn(p);console.log("[Modal] Lookup result:",b),b&&b.setInstrument(g),l.dataset.currentSequencer=""}else try{await St(g)}catch(b){console.error("Failed to load global instrument:",g,b)}});let y=!1;const m=document.getElementById("instrument-loop-toggle");m.addEventListener("change",()=>{y=m.checked,console.log("[UI] Loop mode:",y)}),f.addEventListener("click",()=>{l.classList.add("hidden")})}function no(){var e;return((e=document.getElementById("instrument-loop-toggle"))==null?void 0:e.checked)||!1}function oo(e,t){const n=t.getContext("2d"),s=t.width,o=t.height,i=new Uint8Array(e.fftSize),a=new Uint8Array(e.frequencyBinCount),c=document.createElement("canvas");c.width=s,c.height=o;const l=c.getContext("2d");let r="frequency";function d(){e.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,s,o),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const y=s/i.length;let m=0;for(let g=0;g<i.length;g++){const b=i[g]/128*o/2;g===0?n.moveTo(m,b):n.lineTo(m,b),m+=y}n.lineTo(s,o/2),n.stroke()}function f(){e.getByteFrequencyData(a),n.fillStyle="#000",n.fillRect(0,0,s,o),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,o),n.fillRect(s-1,0,1,o);const y=128,m=2,g=[];for(let p=0;p<y;p++)g.push(p*s/(y-1));g[g.length-1]=s-1;for(let p=0;p<y;p++){const b=g[p],v=p<y-1?g[p+1]:s,S=Math.max(1,v-b-m),E=20,L=2e4,k=p/(y-1),C=E*Math.pow(L/E,k),F=Math.min(a.length-1,Math.floor(C/22050*a.length)),W=a[F]/255,A=Math.max(1,W*o),z=240-k*240;n.fillStyle=`hsl(${z}, ${80+W*20}%, ${40+W*40}%)`,n.fillRect(b,o-A,S,A)}}function h(){e.getByteFrequencyData(a),c.initialized||(l.fillStyle="#000",l.fillRect(0,0,s,o),c.initialized=!0),l.drawImage(c,-1,0),l.fillStyle="#000",l.fillRect(s-1,0,1,o);const y=128,m=20,g=2e4;for(let p=0;p<y;p++){const b=p/(y-1),v=m*Math.pow(g/m,b),E=Math.min(a.length-1,Math.floor(v/22050*a.length)),L=a[E]/255,k=o-1-Math.floor(p*o/y);if(L<.05)continue;const C=Math.floor(L*255),P=Math.floor(L*(255-b*200)),F=Math.floor(L*(100+b*155));l.fillStyle=`rgb(${C}, ${P}, ${F})`,l.fillRect(s-1,k,1,1)}n.fillStyle="#000",n.fillRect(0,0,s,o),n.drawImage(c,0,0)}function u(){switch(requestAnimationFrame(u),r){case"frequency":f();break;case"spectrogram":h();break;case"waveform":default:d()}}return u(),{setMode(y){["waveform","frequency","spectrogram"].includes(y)&&(r=y,n.clearRect(0,0,s,o),r==="spectrogram"&&l.clearRect(0,0,s,o))}}}function so(e,t){const n=oo(We,e),s=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let o=0;function i(){o=(o+1)%s.length;const{name:a,emoji:c}=s[o];n.setMode(a),t.textContent=c,t.title=`Mode: ${a}`}t.addEventListener("click",i),i()}function io(e){if(!e.length)throw new Error("No tracks to export.");const t=e[0].config.bpm,n=e[0].config.beatsPerMeasure,s=e[0].config.totalMeasures,o={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:s},i:e.map(a=>a.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.map(({notes:a})=>({n:a.map(c=>[c.pitch,c.start,c.duration])}))},i=new Blob([JSON.stringify(o)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function ao(e){if(!e.length)return;const n=60/e[0].config.bpm,s=Math.max(...e.flatMap(d=>d.notes.map(f=>(f.start+f.duration)*n+.2))),o=44100,i=new OfflineAudioContext(2,Math.ceil(o*s),o);for(const d of e){const f=d.instrument||"fluidr3-gm/acoustic_grand_piano",h=new qt(null,d.config,i,i.destination,f);h.setState(d),await h.exportToOffline()}const a=await i.startRendering(),c=lo(a),l=URL.createObjectURL(c),r=document.createElement("a");r.href=l,r.download=`session-${Date.now()}.wav`,r.click(),URL.revokeObjectURL(l)}function lo(e){const t=e.numberOfChannels,n=e.length*t*2,s=new DataView(new ArrayBuffer(44+n)),o=(a,c)=>{for(let l=0;l<c.length;l++)s.setUint8(a+l,c.charCodeAt(l))};o(0,"RIFF"),s.setUint32(4,36+n,!0),o(8,"WAVE"),o(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,t,!0),s.setUint32(24,e.sampleRate,!0),s.setUint32(28,e.sampleRate*t*2,!0),s.setUint16(32,t*2,!0),s.setUint16(34,16,!0),o(36,"data"),s.setUint32(40,n,!0);let i=44;for(let a=0;a<e.length;a++)for(let c=0;c<t;c++){const l=e.getChannelData(c)[a],r=Math.max(-1,Math.min(1,l));s.setInt16(i,r*32767,!0),i+=2}return new Blob([s.buffer],{type:"audio/wav"})}function ro(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),s=document.getElementById("triplet-note-btn");let o=!1,i=!1;function a(l){l=parseFloat(l);let r=l;o?r=l*1.5:i&&(r=l*(2/3));let d=Array.from(t.options).find(f=>Math.abs(parseFloat(f.value)-r)<1e-4);d||(d=new Option(r.toString(),r.toString()),t.add(d)),t.value=d.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(l=>{l.addEventListener("click",()=>{e.forEach(d=>d.classList.remove("bg-purple-600")),l.classList.add("bg-purple-600");const r=parseFloat(l.dataset.value);a(r)})}),n.addEventListener("click",()=>{i&&(i=!1,s.classList.remove("bg-purple-600")),o=!o,n.classList.toggle("bg-purple-600"),c()}),s.addEventListener("click",()=>{o&&(o=!1,n.classList.remove("bg-purple-600")),i=!i,s.classList.toggle("bg-purple-600"),I.isTripletMode=i,N.forEach(l=>{l.config.isTripletMode=i}),c()});function c(){const l=document.querySelector(".note-duration-btn.bg-purple-600");if(l){const r=parseFloat(l.dataset.value);a(r)}}a(I.currentDuration||1)}let U=null,Oe=null;function co(e){Oe=e,U=Oe.getContext("2d")}function ce(e){if(!U||!Oe)return;const{width:t,height:n}=Oe;U.clearRect(0,0,t,n);const s=Math.round(e)+.5;U.strokeStyle="#ff00ff",U.lineWidth=1,U.beginPath(),U.moveTo(s,0),U.lineTo(s,n),U.stroke()}let He=!1,de=null,Xt=null,et=!1;function uo(e,t){de=e,Xt=t,de.addEventListener("mousedown",fo),window.addEventListener("mousemove",mo),window.addEventListener("mouseup",ho)}function fo(e){En()&&(Rt(),N.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),et=!0),He=!0,Wt(e)}function mo(e){He&&Wt(e)}function ho(){He&&(He=!1,et&&(Ft(),N.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),et=!1))}function Wt(e){const t=de.getBoundingClientRect(),n=de.width/t.width;let s=(e.clientX-t.left)*n;s=Math.max(0,Math.min(de.width,s));const o=_(Xt),i=s/de.width*o;Z(i),ce(s)}const rt={maxBeatsContext:32,extendBeatsAmount:16};function Lo(){return rt.maxBeatsContext}function ko(){return rt.extendBeatsAmount}function tt(e,t,n,s){const o=_(I),i=s/o*t;e.clearRect(0,0,t,n);const a=rt.maxBeatsContext,l=Math.max(0,s-a)/o*t,r=i-l;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(l,0,r,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke()}let Lt=!1;function kt(){if(!Lt){Lt=!0;const s=document.getElementById("extend-use-tags"),o=document.getElementById("extend-tags");if(s&&o){let r=function(){const d=s.checked;o.disabled=!d,o.classList.toggle("opacity-50",!d),o.classList.toggle("cursor-not-allowed",!d)};r(),s.addEventListener("change",r)}const i=document.getElementById("extend-start-help-btn"),a=document.getElementById("extend-start-help-popup"),c=document.getElementById("extend-start-help-close");i&&a&&c&&(i.addEventListener("click",()=>a.classList.remove("hidden")),c.addEventListener("click",()=>a.classList.add("hidden")),document.addEventListener("click",r=>{!a.contains(r.target)&&r.target!==i&&a.classList.add("hidden")}));const l=document.querySelector("#ai-extend-modal .generate-btn");l&&l.addEventListener("click",async()=>{const{extendTracksWithAI:r}=await It(async()=>{const{extendTracksWithAI:d}=await import("./extendTracks-CZr_p8bz.js");return{extendTracksWithAI:d}},__vite__mapDeps([0,1]));await r()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",at().forEach((o,i)=>{const a=`extend-track-${i}`,c=document.createElement("div");c.className="flex items-center gap-2";const l=document.createElement("input");l.type="checkbox",l.id=a,l.dataset.index=i,l.checked=!0,l.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const r=document.createElement("label");r.htmlFor=a,r.className="text-sm text-gray-200",r.textContent=o.config.name||`Track ${i+1}`,l.addEventListener("change",()=>{pe()}),c.appendChild(l),c.appendChild(r),e.appendChild(c)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(o=>o.checked=!0),pe()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(o=>o.checked=!1),pe()}),pe())}let je=!1,we=0;function Io(){return we}function go(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d"),s=e.clientWidth,o=e.clientHeight;e.width=s,e.height=o,t.width=s,t.height=o,pe(),tt(n,s,o,we),t.addEventListener("mousedown",a=>{je=!0,i(a.offsetX)}),window.addEventListener("mouseup",()=>{je=!1}),window.addEventListener("mousemove",a=>{if(!je)return;const c=t.getBoundingClientRect();i(a.clientX-c.left)});function i(a){const c=_(I),l=Math.max(0,Math.min(a,s));we=Math.round(l/s*c),tt(n,s,o,we)}}function pe(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead"),n=t.getContext("2d"),s=t.width,o=t.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),a=Array.from(i).filter(l=>l.checked).map(l=>parseInt(l.dataset.index,10)),c=at().filter((l,r)=>a.includes(r));fe(e,c),tt(n,s,o,we)}function po(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),s=document.getElementById("note-duration-controls"),o=document.getElementById("select-mode-controls"),i=document.getElementById("velocity-mode-controls");function a(l){[e,t,n].forEach(r=>{r.classList.remove("bg-purple-600"),r.classList.add("bg-gray-800")}),l.classList.remove("bg-gray-800"),l.classList.add("bg-purple-600")}function c(l){[s,o,i].forEach(r=>{r.classList.add("hidden")}),l.classList.remove("hidden")}e.addEventListener("click",()=>{a(e),c(s),ke("note-placement")}),t.addEventListener("click",()=>{a(t),c(o),ke("select")}),n.addEventListener("click",()=>{a(n),c(i),ke("velocity")}),window.addEventListener("keydown",l=>{var f;const r=(f=document.activeElement)==null?void 0:f.tagName;if(!(r==="INPUT"||r==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(l.key){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),a(e),c(s),ke("note-placement")}function yo(){const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),s=document.getElementById("ai-control-panel");function o(){document.querySelectorAll(".sequencer").forEach(h=>{const u=h.querySelector(".delete-btn"),y=h.querySelector(".collapse-btn"),m=y.querySelector("use");u.classList.add("button-locked"),y.classList.add("button-locked");const g=h.querySelector(".sequencer-body"),p=h.querySelector(".mini-contour");it(h,!1),g.classList.contains("hidden")||(g.classList.add("hidden"),p.classList.remove("hidden"),m.setAttribute("href","#icon-caret-up"))})}function i(){document.querySelectorAll(".sequencer").forEach(h=>{const u=h.querySelector(".delete-btn"),y=h.querySelector(".collapse-btn");u.classList.remove("button-locked"),y.classList.remove("button-locked")})}function a(){e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),s.classList.add("hidden"),i()}function c(){if(!Ze()){document.getElementById("openai-key-not-set-modal").classList.remove("hidden");return}t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),s.classList.remove("hidden"),o()}e.addEventListener("click",a),t.addEventListener("click",c);const l=document.getElementById("ai-inpaint-modal"),r=document.getElementById("ai-extend-modal"),d=document.getElementById("ai-generate-modal");function f(h){h.querySelector(".cancel-btn").addEventListener("click",()=>{h.classList.add("hidden")})}f(l),f(r),f(d),kt(),document.getElementById("ai-inpaint-btn").addEventListener("click",()=>{l.classList.remove("hidden")}),document.getElementById("ai-extend-btn").addEventListener("click",()=>{r.classList.remove("hidden"),go(),kt()}),document.getElementById("ai-generate-btn").addEventListener("click",()=>{d.classList.remove("hidden")}),po()}function bo(){document.addEventListener("keydown",o=>{var r;if(st()!==ot.SELECT)return;const a=navigator.platform.toUpperCase().includes("MAC")?o.metaKey:o.ctrlKey,c=(r=document.activeElement)==null?void 0:r.tagName;if(!(c==="INPUT"||c==="TEXTAREA"||!Le()))switch(!0){case(a&&o.key==="c"):o.preventDefault(),t==null||t.click();break;case(a&&o.key==="x"):o.preventDefault(),n==null||n.click();break;case(a&&o.key==="v"):o.preventDefault(),s==null||s.click();break;case o.key==="Delete":o.preventDefault(),e==null||e.click();break}});const e=document.querySelector(".select-mode-delete");e&&(e.onclick=()=>{var c;const o=Le();if(!o)return;const i=o.gridContext,a=o.getSelectedNotes();if(a.length!==0){for(const l of a){const r=i.notes.indexOf(l);r!==-1&&i.notes.splice(r,1)}i.setSelectedNotes([]),i.scheduleRedraw(),(c=i.onNotesChanged)==null||c.call(i)}});const t=document.querySelector(".select-mode-copy");t&&(t.onclick=()=>{const o=Le();if(!o)return;const i=o.getSelectedNotes();i.length!==0&&bt(i)});const n=document.querySelector(".select-mode-cut");n&&(n.onclick=()=>{var c;const o=Le();if(!o)return;const i=o.gridContext,a=o.getSelectedNotes();if(a.length!==0){bt(a);for(const l of a){const r=i.notes.indexOf(l);r!==-1&&i.notes.splice(r,1)}i.setSelectedNotes([]),i.scheduleRedraw(),(c=i.onNotesChanged)==null||c.call(i)}});const s=document.querySelector(".select-mode-paste");s&&(s.onclick=()=>{const o=Pt();o.notes.length&&(document.body.style.cursor="crosshair",fn((i,a)=>{var v;const c=i.gridContext,{x:l,y:r}=c.getCanvasPos(a),d=c.getSnappedBeatFromX(l),f=c.getPitchFromRow(Math.floor(r/c.getCellHeight())),h=R(f),{notes:u,anchorBeat:y,anchorMidi:m}=o,g=d-y,p=h-m,b=u.map(S=>({pitch:Ae(R(S.pitch)+p),start:S.start+g,duration:S.duration}));c.notes.push(...b),c.setSelectedNotes(b),c.scheduleRedraw(),(v=c.onNotesChanged)==null||v.call(c),document.body.style.cursor="default",nt()}))})}function Kt(){fe(vo,N)}const vo=document.getElementById("global-mini-contour"),ct=document.getElementById("global-mini-playhead");co(ct);uo(ct,I);ce(0);const Eo=document.getElementById("piano");to(Eo);const wo=document.getElementById("waveform");so(wo,document.getElementById("visualizer-mode"));const{wrapper:Bo}=lt();it(Bo,!0);bo();Kt();Nn();ro();yo();qn({getSequencers:()=>N,onPlay:()=>{_e();const e=_(I),t=qe();vn(I.bpm,{loop:I.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{N.forEach(n=>{var s;return(s=n.onTransportLoop)==null?void 0:s.call(n)})}}),Ve(n=>{const s=n/e*ct.width;ce(s)}),N.forEach(n=>n.play()),bn(()=>{_n(),Z(0),ce(0)})},onPause:()=>{Rt(),N.forEach(e=>e.pause())},onResume:()=>{Ft(),N.forEach(e=>e.resume())},onStop:()=>{_e(),Z(0),N.forEach(e=>e.stop()),ce(0)},onDurationChange:e=>{I.currentDuration=e,N.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{I.snapResolution=e,N.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{I.loopEnabled=e,N.forEach(t=>t.config.loopEnabled=e)},onTempoChange:e=>{I.bpm=e,N.forEach(t=>t.config.bpm=e)},onSave:async e=>{const t=N.map(n=>n.getState());if(e==="json"){const{url:n,filename:s}=io(t),o=document.createElement("a");o.href=n,o.download=s,o.click(),URL.revokeObjectURL(n)}else e==="wav"?await ao(t):e==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async e=>{try{let t=[];try{t=await Sn(e)}catch{t=await Bn(e)}if(t.length>0){const n=t[0].config;I.bpm=n.bpm??I.bpm;const s=document.getElementById("tempo-input");s&&(s.value=I.bpm),I.beatsPerMeasure=n.beatsPerMeasure??I.beatsPerMeasure,I.totalMeasures=n.totalMeasures??I.totalMeasures;const o=document.getElementById("measures-input");o&&(o.value=I.totalMeasures)}In(),t.forEach(n=>{const{seq:s,wrapper:o}=lt(n),i=o.querySelector(".sequencer-body"),a=o.querySelector("canvas.mini-contour"),c=o.querySelector(".collapse-btn");i.classList.add("hidden"),a.classList.remove("hidden"),c.textContent="⯅"}),Kt(),Z(0),ce(0)}catch(t){alert("Failed to load file: "+t.message)}},onMeasuresChange:e=>{I.totalMeasures=e,N.forEach(n=>{n.updateTotalMeasures(e)});const t=document.getElementById("global-mini-contour");t&&fe(t,N)},onBeatsPerMeasureChange:e=>{I.beatsPerMeasure=e,N.forEach(n=>{n.config.beatsPerMeasure=e,n.updateTotalMeasures(I.totalMeasures)});const t=document.getElementById("global-mini-contour");t&&fe(t,N)}});const No=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{wt as a,at as b,Io as c,Lo as d,ko as e,I as f,Ze as g,pt as h,fe as i,No as m,Mo as u};
