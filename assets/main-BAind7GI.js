const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/extendTracks-3QCN6tfB.js","assets/index-C0XNLAAk.js"])))=>i.map(i=>d[i]);
import{_ as gn}from"./index-C0XNLAAk.js";function pn(e=3){const i=["C","D","E","F","G","A","B"],r=["C#","D#","","F#","G#","A#",""],c=[e,e+1,e+2],a={};let l=0;for(const u of c)i.forEach(f=>{const d=`${f}${u}`;a[d]={note:d,x:l,width:60,height:200,isBlack:!1},l+=60});l=0;for(const u of c)r.forEach((f,d)=>{if(f===""){l+=60;return}const m=`${f}${u}`;a[m]={note:m,x:l+60-40/2,width:40,height:120,isBlack:!0},l+=60});return a}function He(e,t,n=new Set,o=null){e.clearRect(0,0,e.canvas.width,e.canvas.height);const s={};if(o)for(const[i,r]of Object.entries(o))s[r]=i;for(const i of Object.values(t))i.isBlack||(jt(e,{...i,fill:n.has(i.note)?"#cce0ff":"#ffffff",stroke:"#333",radius:6}),e.fillStyle="#333",e.font="12px sans-serif",e.textAlign="center",s[i.note]&&(e.fillStyle="#7c3aed",e.fillText(s[i.note],i.x+i.width/2,i.height-24),e.fillStyle="#333"),e.fillText(i.note,i.x+i.width/2,i.height-8));for(const i of Object.values(t))i.isBlack&&(jt(e,{...i,fill:n.has(i.note)?"#4a60ff":"#111111",stroke:"#000000",radius:4}),lo(e,i),s[i.note]&&(e.fillStyle="#c084fc",e.font="10px sans-serif",e.textAlign="center",e.fillText(s[i.note],i.x+i.width/2,i.height-28)))}function jt(e,t){const{x:n,width:o,height:s,fill:i,stroke:r,radius:c=8}=t;e.beginPath(),e.moveTo(n,0),e.lineTo(n,s-c),e.quadraticCurveTo(n,s,n+c,s),e.lineTo(n+o-c,s),e.quadraticCurveTo(n+o,s,n+o,s-c),e.lineTo(n+o,0),e.closePath(),e.fillStyle=i,e.fill(),e.strokeStyle=r,e.lineWidth=1,e.stroke()}function lo(e,t){const n=e.createLinearGradient(t.x,0,t.x,t.height);n.addColorStop(0,"rgba(255,255,255,0.2)"),n.addColorStop(.3,"rgba(255,255,255,0)"),e.fillStyle=n,e.beginPath(),e.moveTo(t.x,0),e.lineTo(t.x+t.width,0),e.lineTo(t.x+t.width,t.height*.4),e.lineTo(t.x,t.height*.4),e.closePath(),e.fill()}const X={cellWidth:40,cellHeight:20,visibleNotes:36,noteRange:["C1","B9"],currentDuration:1,snapResolution:1,isTripletMode:!1,loopEnabled:!1,useEqualTemperament:!0},Q=64,uo={C:"#FF0000","C#":"#9400D3",D:"#FFFF00","D#":"#FF69B4",E:"#0000FF",F:"#00FF00","F#":"#87CEFA",G:"#FFA500","G#":"#800080",A:"#2E8B57","A#":"#FFB6C1",B:"#4B0082"},fo={4:"𝅝",2:"𝅗𝅥",1:"𝅘𝅥","0.5":"♪","0.25":"♬","0.125":"𝅘𝅥𝅰"},Yt={Digit1:4,Digit2:2,Digit3:1,Digit4:.5,Digit5:.25,Digit6:.125},Ge=[{cellWidth:20,cellHeight:10},{cellWidth:30,cellHeight:15},{cellWidth:40,cellHeight:20},{cellWidth:60,cellHeight:25},{cellWidth:80,cellHeight:30}],yn={openaiApiKey:"",openaiModel:"gpt-4o",gridColorScheme:"Darkroom",noteColorScheme:"Track Color"};function Me(){return yn}function Fe(e){Object.assign(yn,e)}function mo(){const e=Me();localStorage.setItem("userConfig",JSON.stringify(e))}function ho(){const e=localStorage.getItem("userConfig");if(e)try{const t=JSON.parse(e);Fe(t)}catch(t){console.error("Failed to parse userConfig from localStorage:",t)}}ho();const Vt=["gpt-4o","gpt-4o-mini","gpt-4.1","gpt-4.1-mini","o3-mini","o4-mini"];function dt(){return Me().openaiApiKey}function Qt(){return Me().openaiModel}function go(e){Fe({openaiApiKey:e})}function po(e){if(!Vt.includes(e))throw new Error(`Invalid model: ${e}. Must be one of: ${Vt.join(", ")}`);Fe({openaiModel:e})}function yo(){var s;const e=document.getElementById("openai-key-input"),t=document.getElementById("openai-model-select"),n=document.getElementById("config-save"),o=document.querySelectorAll("#config-close, #config-close-bottom");e.value=dt(),t.value=Qt(),n.addEventListener("click",()=>{var i;go(e.value),po(t.value),mo(),(i=document.getElementById("userconfig-modal"))==null||i.classList.add("hidden")}),o.forEach(i=>{i.addEventListener("click",()=>{var r;e.value=dt(),t.value=Qt(),(r=document.getElementById("userconfig-modal"))==null||r.classList.add("hidden")})}),(s=document.getElementById("key-not-set-ok"))==null||s.addEventListener("click",()=>{var i;(i=document.getElementById("openai-key-not-set-modal"))==null||i.classList.add("hidden")})}function Eo(e,t){return e/t()}function En(e,t){const n=t.snapResolution||.25,o=t.isTripletMode?n*(2/3):n;return Math.round(e/o)*o}function bo(e,t,n){const o=Eo(e,n);return En(o,t)}const So={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,Fb:4,"E#":5,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11,Cb:11,"B#":0};function I(e){const t=e==null?void 0:e.match(/^([A-Ga-g])([#b]*)(-?\d+)$/);if(!t)return null;const[,n,o,s]=t,i=n.toUpperCase(),r=So[i];if(r===void 0)return null;const c=[...o].reduce((l,u)=>u==="#"?l+1:u==="b"?l-1:l,0);return 12*(parseInt(s,10)+1)+(r+c)}const wo=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],vo=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];function le(e,t=!1){const o=(t?vo:wo)[e%12],s=Math.floor(e/12)-1;return`${o}${s}`}function Co(e){return e.replace(/\d+$/,"")}function Lo(e){return e.includes("#")}function bn(e,t,n,o,s,i=4){e.beginPath(),e.moveTo(t+i,n),e.lineTo(t+o-i,n),e.quadraticCurveTo(t+o,n,t+o,n+i),e.lineTo(t+o,n+s-i),e.quadraticCurveTo(t+o,n+s,t+o-i,n+s),e.lineTo(t+i,n+s),e.quadraticCurveTo(t,n+s,t,n+s-i),e.lineTo(t,n+i),e.quadraticCurveTo(t,n,t+i,n),e.closePath()}function No(e,t){const n=structuredClone(e);return n.tempo=t.bpm,n}function Sn(e){return{type:"CHANGE_TEMPO",bpm:e}}function Bo(e){return Sn(e)}function Mo(e,t){const n=structuredClone(e);return n.timeSignature=[t.beats,4],n}function wn(e){return{type:"SET_TIME_SIGNATURE",beats:e}}function ko(e){return wn(e)}function Io(e,t){const n=structuredClone(e);return n.totalMeasures=t.measures,n}function vn(e){return{type:"SET_TOTAL_MEASURES",measures:e}}function To(e){return vn(e)}function Ro(e,t){const n=structuredClone(e);if(n.sequencers.push({id:t.id,instrument:t.instrument,notes:t.notes??[]}),!M.find(s=>s.id===t.id)){const s={id:t.id,instrument:t.instrument,notes:t.notes??[]},{wrapper:i}=Un(s);Ke(i,!0)}return n}function Cn(e,t){return{type:"CREATE_SEQUENCER",id:e,instrument:t}}function Mt(e){return{type:"DELETE_SEQUENCER",id:e}}function Po(e,t){const n=structuredClone(e);n.sequencers=n.sequencers.filter(s=>s.id!==t.id);const o=M.findIndex(s=>s.id===t.id);return o!==-1&&(M[o].destroy(),M.splice(o,1)),n}function qo(e,t,n=[]){return{type:"DELETE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function Ao(e,t,n=[]){return{type:"CREATE_SEQUENCER",id:e,instrument:t,notes:structuredClone(n)}}function _o(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);return o&&t.instrument&&(o.instrument=t.instrument),n}function Do(e,t){return{type:"SET_INSTRUMENT",sequencerId:e,instrument:t}}function Oo(e,t){return{type:"SET_INSTRUMENT",sequencerId:e,instrument:t}}const Be=["#ff006e","#3a86ff","#ffbe0b","#8338ec","#06d6a0","#ef476f","#118ab2","#ffd166","#073b4c","#8ac926"];function Zt(e){return e<0&&(console.error(`Invalid trackId: ${e}. Using default color.`),e=0),Be[e%Be.length]}function Ho(e){return e&&typeof e.colorIndex=="number"?Zt(e.colorIndex):(console.error(`Invalid sequencer colorIndex: ${e==null?void 0:e.colorIndex}. Using default color.`),Zt(0))}function $e(e,t,n,o=0){const s=e.getContext("2d");if(!s)return;s.imageSmoothingEnabled=!1;const i=e.width,r=e.height;if(s.clearRect(0,0,i,r),!t.length)return;const c=Be[o%Be.length];s.fillStyle=c;const a=U(),l=t.map(y=>I(y.pitch)).filter(y=>y!==null);if(!l.length)return;let u=Math.min(...l),f=Math.max(...l),d=Math.max(1,f-u);for(;r%d!==0;)f++,d=f-u;const m=r/d;for(const y of t){const E=I(y.pitch);if(E==null)continue;const b=y.start/a*i,w=y.duration/a*i,L=(E-u)/d,S=r-L*r-m/2,T=Math.round(b),B=Math.max(1,Math.round(w)),N=Math.round(S);s.fillRect(T,N,B,m)}const h=Ue(),p=ze();s.save();let g=1;p>256?g=16:p>128?g=8:p>32&&(g=4);for(let y=0;y<=p;y++){if(y%g!==0)continue;const b=y*h/a*i,w=Math.round(b)+.5;s.beginPath(),s.moveTo(w,0),s.lineTo(w,r);const L=g===1||y%(g*2)===0;s.strokeStyle=L?"rgba(255, 255, 255, 0.12)":"rgba(255, 255, 255, 0.04)",s.lineWidth=.2,s.stroke()}s.restore()}function J(e,t){const n=e.getContext("2d");if(!n)return;const o=e.width,s=e.height;n.clearRect(0,0,o,s);const i=U();for(const r of t){const{notes:c,config:a}=r;if(!(c!=null&&c.length))continue;const l=Be[t.indexOf(r)%Be.length];n.fillStyle=l;const u=I(a.noteRange[0]),f=I(a.noteRange[1]);if(u==null||f==null)continue;const d=f-u||1,m=Math.max(2,s/d);for(const h of c){const p=I(h.pitch);if(p==null)continue;const g=h.start/i*o,y=Math.max(1,h.duration/i*o),E=(p-u)/d,b=s-E*s-m/2;n.fillRect(g,b,y,m)}}}function Fo(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;o.notes.push(...t.notes);const s=document.getElementById("global-mini-contour");return s&&J(s,M),n}function $o(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Wo(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Uo(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(r=>`${r.pitch}|${r.start}|${r.duration}`));o.notes=o.notes.filter(r=>{const c=`${r.pitch}|${r.start}|${r.duration}`;return!s.has(c)});const i=document.getElementById("global-mini-contour");return i&&J(i,M),n}function kt(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function It(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function zo(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const s=t.from,i=t.to;for(let r=0;r<s.length;r++){const c=s[r],a=i[r],l=o.notes.findIndex(u=>u.pitch===c.pitch&&u.start===c.start&&u.duration===c.duration);l!==-1&&(o.notes[l].pitch=a.pitch,o.notes[l].start=a.start)}return n}function Tt(e,t,n){return{type:"MOVE_NOTES",sequencerId:e,from:structuredClone(t),to:structuredClone(n)}}function Ln(e,t,n){return Tt(e,n,t)}function Ko(e,t){const n=structuredClone(e),o=n.sequencers.find(i=>i.id===t.sequencerId);if(!o)return e;const s=new Set(t.notes.map(i=>`${i.pitch}|${i.start}|${i.duration}`));return o.notes=o.notes.filter(i=>{const r=`${i.pitch}|${i.start}|${i.duration}`;return!s.has(r)}),n}function Xo(e,t){return{type:"CUT_NOTES",sequencerId:e,notes:structuredClone(t)}}function Go(e,t){return{type:"PLACE_NOTES",sequencerId:e,notes:structuredClone(t)}}function jo(e,t){const n=structuredClone(e),o=n.sequencers.find(s=>s.id===t.sequencerId);return o?(o.notes.push(...t.notes),n):e}function Yo(e,t){return{type:"PASTE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Vo(e,t){return{type:"DELETE_NOTES",sequencerId:e,notes:structuredClone(t)}}function Qo(e,t){return structuredClone(e)}function Zo(e,t){const n=structuredClone(e),o=n.sequencers.find(r=>r.id===t.sequencerId);if(!o)return e;const s=t.resizes;for(const r of s){const c=o.notes.find(a=>a.pitch===r.pitch&&a.start===r.start);c&&(c.duration=r.newDuration)}const i=document.getElementById("global-mini-contour");return i&&J(i,M),n}function Jo(e,t){return{type:"RESIZE_NOTES",sequencerId:e,resizes:structuredClone(t)}}function xo(e,t){const n=t.map(o=>({pitch:o.pitch,start:o.start,newDuration:o.oldDuration}));return{type:"RESIZE_NOTES",sequencerId:e,resizes:n}}function es(e,t){return structuredClone(e)}function Rt(e=""){return{type:"CHECKPOINT",label:e}}function Nn(e=""){return Rt(e)}const ts=Object.freeze(Object.defineProperty({__proto__:null,CHANGE_TEMPO:No,CHECKPOINT:es,CREATE_SEQUENCER:Ro,CUT_NOTES:Ko,DELETE_NOTES:Uo,DELETE_SEQUENCER:Po,MOVE_NOTES:zo,PASTE_NOTES:jo,PLACE_NOTES:Fo,RESIZE_NOTES:Zo,SET_INSTRUMENT:_o,SET_TIME_SIGNATURE:Mo,SET_TOTAL_MEASURES:Io,UPDATE_NOTE_VELOCITY:Qo},Symbol.toStringTag,{value:"Module"}));function Pt(e){const t=ts[e.type];if(!t)throw new Error(`Unknown diff type: ${e.type}`);const n=t(ke(),e);Bn(n)}const ft=new Set;function ns(e){return ft.add(e),()=>ft.delete(e)}function We(e){for(const t of ft)t(e)}const ie=[];let ne=-1;const os=100;function ss({forwardDiff:e,reverseDiff:t}){ie.splice(ne+1),ie.push({forwardDiff:e,reverseDiff:t}),ne=ie.length-1,ie.length>os&&(ie.shift(),ne--)}function is(){var e;if(ne<0)return null;for(let t=ne;t>=0;t--){const n=ie[t];if(((e=n==null?void 0:n.forwardDiff)==null?void 0:e.type)==="CHECKPOINT")return null;if(n!=null&&n.reverseDiff)return ne=t-1,Pt(n.reverseDiff),We(ke()),n.reverseDiff}return null}function rs(){if(ne>=ie.length-1)return null;ne++;const e=ie[ne];return!e||!e.forwardDiff?null:(Pt(e.forwardDiff),We(ke()),e.forwardDiff)}function as(){ie.length=0,ne=-1}let Ze={tempo:120,timeSignature:[4,4],totalMeasures:8,sequencers:[]};function ke(){return Ze}function Bn(e){Ze=structuredClone(e),We(Ze)}function D(e,t){Pt(e),ss({forwardDiff:e,reverseDiff:t}),We(Ze)}let j=null,te=500,ve=null,mt=!1,ht=1/0,Ce=[],Qe=null,Mn=0,kn=4,In=8;function gt(e){return Ce.push(e),()=>{const t=Ce.indexOf(e);t!==-1&&Ce.splice(t,1)}}function cs(){Ce=[]}function ue(e){Mn=e}function Je(){return Mn}function U(){return ze()*Ue()}function pt(e,t=!0){if(t){const o=ge();D(Sn(e),Bo(o));return}if(Tn()){const o=performance.now(),s=(o-(ve??o))/te;te=60/e*1e3,ve=o-s*te}else te=60/e*1e3;const n=document.getElementById("tempo-input");n&&n.value!==String(e)&&(n.value=String(e))}function ge(){return 60/(te/1e3)}function yt(e,t=!0){if(t){const o=Ue();D(wn(e),ko(o));return}kn=e;const n=document.getElementById("beats-per-measure-input");n&&n.value!==String(e)&&(n.value=String(e)),de().forEach(o=>{var s,i;(s=o.grid)!=null&&s.resizeAndRedraw?o.grid.resizeAndRedraw():(i=o.grid)==null||i.scheduleRedraw()})}function Ue(){return kn}function Et(e,t=!0){if(t){const o=ze();D(vn(e),To(o));return}In=e;const n=document.getElementById("measures-input");n&&n.value!==String(e)&&(n.value=String(e)),de().forEach(o=>{var s;(s=o.grid)==null||s.scheduleRedraw()})}function ze(){return In}function ls(e){Qe=e}function us(){return X.snapResolution}function ds(e,t={}){te=60/e*1e3,mt=t.loop??!1,ht=t.endBeat??1/0;const n=t.startBeat??0;ve=performance.now()-n*te;const o=t.onLoop;function s(i){const c=(i-(ve??i))/te;if(ue(c),Ce.forEach(a=>a(c)),c>=ht)if(mt)ve=performance.now(),ue(0),o&&o();else{xe();return}j=requestAnimationFrame(s)}j=requestAnimationFrame(s)}function xe(){j!==null&&cancelAnimationFrame(j),j=null,cs(),Qe&&(Qe(),Qe=null)}function Tn(){return j!==null}function Rn(){j!==null&&cancelAnimationFrame(j),j=null}function Pn(){if(j!==null)return;const e=performance.now()-Je()*te;function t(n){const s=(n-e)/te;if(ue(s),Ce.forEach(i=>i(s)),s>=ht)if(mt)ve=performance.now(),ue(0);else{xe();return}j=requestAnimationFrame(t)}j=requestAnimationFrame(t)}const Jt={Midnight:{whiteKey:"#1e1e1e",blackKey:"#2a103b",labelWhite:"#2c2c2c",labelBlack:"#3a1d4d",textWhite:"#cfcfcf",textBlack:"#e6d9ff",gridLine:"#333",beatLine:"#4e3d63",measureLine:"#8561c2"},Seashell:{whiteKey:"#fefefe",blackKey:"#f1e7dc",labelWhite:"#dddddd",labelBlack:"#d4cfc9",textWhite:"#444",textBlack:"#663300",gridLine:"#ccc",beatLine:"#bbb",measureLine:"#999"},Cyberpunk:{whiteKey:"#1b1b2f",blackKey:"#162447",labelWhite:"#1f4068",labelBlack:"#1f4068",textWhite:"#e43f5a",textBlack:"#e43f5a",gridLine:"#1f4068",beatLine:"#e43f5a",measureLine:"#ffcc00"},"Classic Blue":{whiteKey:"#f5faff",blackKey:"#dceeff",labelWhite:"#aaccee",labelBlack:"#88bbdd",textWhite:"#002244",textBlack:"#001122",gridLine:"#99bbdd",beatLine:"#88aacc",measureLine:"#336699"},Darkroom:{whiteKey:"#2c2c2c",blackKey:"#1e1e1e",labelWhite:"#383838",labelBlack:"#2a2a2a",textWhite:"#a0a0a0",textBlack:"#e0e0e0",gridLine:"#404040",beatLine:"#606060",measureLine:"#808080"}};function fs(e,t,n,o,s,i){const{gridColorScheme:r}=Me(),c=Jt[r]||Jt.Darkroom,a=Ue(),l=U(),u=l*o,f=n*s;e.font=`${Math.floor(s*.6)}px sans-serif`,e.textAlign="right",e.textBaseline="middle";for(let d=0;d<n;d++){const m=d*s,h=i(d),p=Lo(h);e.fillStyle=p?c.blackKey:c.whiteKey,e.fillRect(0,m,u,s),e.fillStyle=p?c.labelBlack:c.labelWhite,e.fillRect(-64,m,Q,s),e.fillStyle=p?c.textBlack:c.textWhite,e.fillText(h,-8,m+s/2)}e.strokeStyle=c.gridLine,e.lineWidth=1;for(let d=0;d<n;d++){const m=d*s;e.beginPath(),e.moveTo(0,m),e.lineTo(u,m),e.stroke()}for(let d=0;d<=l;d++){const m=d*o,h=d%a===0;e.strokeStyle=h?c.measureLine:c.beatLine,e.lineWidth=h?2:1,e.beginPath(),e.moveTo(m,0),e.lineTo(m,f),e.stroke()}}const ms={Scriabin:(e,{getPitchClass:t}={})=>{const n=t?t(e.pitch):0;return uo[n]||"#999"},"Track Color":(e,{getTrackColor:t}={})=>(t==null?void 0:t())||"#999","Octave Bands":e=>{const t=I(e.pitch);return t==null?"#999":`hsl(${t*3%360}, 100%, 60%)`},"Pitch Class Contrast":(e,{getPitchClass:t}={})=>{const n=I(e.pitch);if(n==null)return"#999";const o=n%12;return["#ff0000","#ff7f00","#ffff00","#7fff00","#00ff00","#00ff7f","#00ffff","#007fff","#0000ff","#7f00ff","#ff00ff","#ff007f"][o]||"#999"}};function hs(e,t=1){if(e.startsWith("#")){const n=parseInt(e.slice(1),16),o=n>>16&255,s=n>>8&255,i=n&255;return`rgba(${o}, ${s}, ${i}, ${t})`}if(e.startsWith("hsl(")){const[n,o,s]=e.slice(4,-1).split(",").map(a=>parseFloat(a.trim())),[i,r,c]=gs(n,o/100,s/100);return`rgba(${i}, ${r}, ${c}, ${t})`}return e}function gs(e,t,n){const o=(1-Math.abs(2*n-1))*t,s=o*(1-Math.abs(e/60%2-1)),i=n-o/2;let r=0,c=0,a=0;return 0<=e&&e<60?[r,c,a]=[o,s,0]:60<=e&&e<120?[r,c,a]=[s,o,0]:120<=e&&e<180?[r,c,a]=[0,o,s]:180<=e&&e<240?[r,c,a]=[0,s,o]:240<=e&&e<300?[r,c,a]=[s,0,o]:300<=e&&e<360&&([r,c,a]=[o,0,s]),[Math.round((r+i)*255),Math.round((c+i)*255),Math.round((a+i)*255)]}function ps(e,t,{previewNotes:n=null,hoveredNote:o,selectedNote:s,selectedNotes:i=[],highlightedNotes:r=[],cellWidth:c,cellHeight:a,visibleStartBeat:l,visibleEndBeat:u,getPitchRow:f,getPitchClass:d,getTrackColor:m,drawRoundedRect:h}){const{noteColorScheme:g}=Me(),y=ms[g]||(()=>"#999");for(const E of t){if(E.start+E.duration<l-2||E.start>u)continue;const b=E.start*c,w=f(E.pitch)*a,L=E.duration*c,S=a-1,T=y(E,{getPitchClass:d,getTrackColor:m});e.shadowColor="rgba(0,0,0,0.3)",e.shadowBlur=4,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=r.includes(E)?"rgba(96, 165, 250, 0.6)":T,h(e,b,w,L,S),e.fill();const B=e.createLinearGradient(b,w,b,w+S);B.addColorStop(0,"rgba(255,255,255,0.4)"),B.addColorStop(.2,"rgba(255,255,255,0.15)"),B.addColorStop(.5,"rgba(255,255,255,0.05)"),B.addColorStop(1,"rgba(255,255,255,0)"),e.shadowColor="transparent",e.fillStyle=B,h(e,b,w,L,S),e.fill();const N=i.includes(E),k=E===o,A=r.includes(E);(N||k||A)&&(e.lineWidth=N?3:2,e.strokeStyle=N?"rgba(0, 255, 255, 1.0)":k?"rgba(255, 255, 255, 0.9)":"rgba(255, 200, 50, 0.7)",h(e,b,w,L,S),e.stroke())}if(n)for(const E of n){const b=E.start*c,w=f(E.pitch)*a,L=E.duration*c,S=a-1,T=y(E,{getPitchClass:d,getTrackColor:m});e.fillStyle=hs(T,.4),h(e,b,w,L,S),e.fill()}}function ys(e,t,n,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.strokeStyle="red",e.lineWidth=2,e.beginPath(),e.moveTo(t+n,0),e.lineTo(t+n,o),e.stroke(),e.restore()}function Es(e,t,n,o=Q){const s=e.getBoundingClientRect(),i=parseFloat(e.style.width||`${s.width}`),r=parseFloat(e.style.height||`${s.height}`),c=e.width/i,a=e.height/r,l=(t.clientX-s.left)*c-o,u=(t.clientY-s.top)*a;return{x:l,y:u}}function bs(e,t,n,o,s,i){const r=Math.floor(t/s),c=e/i;return n.find(a=>c>=a.start&&c<a.start+a.duration&&o(a.pitch)===r)}function xt(e,t){const n=I(e),o=I(t);if(n===null||o===null)throw new Error(`Invalid pitches provided: ${e}, ${t}`);return n-o}function Ss(e,t,n,o){const s=e.querySelector(".zoom-in-btn"),i=e.querySelector(".zoom-out-btn"),r=e.querySelector(".zoom-reset-btn");!s||!i||!r||(s.addEventListener("click",t),i.addEventListener("click",n),r.addEventListener("click",o))}let st=!1,et=null,W=null;function ws(e){st=!0,et=e,W=null}function qt(){var e;if(W){if(!W.gridContext.setPastePreviewNotes)return;W.gridContext.setPastePreviewNotes(null),W.scheduleRedraw(),(e=W.setCursor)==null||e.call(W,"default")}st=!1,et=null,W=null,document.body.style.cursor="default"}function At(){return st}function vs(e,t){!st||!et||(et(e,t),qt())}function Cs(e){if(W&&W!==e){if(!W.gridContext.setPastePreviewNotes)return;W.gridContext.setPastePreviewNotes(null),W.scheduleRedraw()}W=e}const re={NOTE_PLACEMENT:"note-placement",SELECT:"select"};let qn=re.NOTE_PLACEMENT;const bt=new Set;function An(){return qn}function Z(e){qt(),qn=e;for(const t of bt)t(e)}function Ls(e){return bt.add(e),()=>bt.delete(e)}let _t=!1;function Ns(){_t=!0,Z(re.SELECT)}function Le(){_t=!1}function Ne(){return _t}let Dt=!1;function Pe(e=!0){Dt=e}function en(){return Dt}function tn(){Dt=!1}let _n={notes:[],anchorBeat:0,anchorMidi:0};function Dn(e){if(e.length===0)return;const t=e[0],n=t.start,o=I(t.pitch)??0;_n={notes:e.map(s=>({pitch:s.pitch,start:s.start,duration:s.duration})),anchorBeat:n,anchorMidi:o}}function St(){return _n}let Ot=null,Ht=null;function Bs(e){Ot=e}function wt(){return Ot}function nn(){Ot=null}function on(e,t,n){Ht={anchorNote:e,startX:t,startY:n,originalDuration:e.duration}}function at(){return Ht}function Ms(){Ht=null}function On(e,t,n){if(!e.setPastePreviewNotes)return;if(!At()){e.setPastePreviewNotes(null);return}const{notes:o,anchorBeat:s,anchorMidi:i}=St(),r=e.getSnappedBeatFromX(t),c=e.getPitchFromRow(Math.floor(n/e.getCellHeight())),a=I(c);if(a===null)return;const l=r-s,u=a-i,f=o.map(d=>{const m=I(d.pitch);return m===null?{...d}:{pitch:le(m+u)??d.pitch,start:d.start+l,duration:d.duration}});e.setPastePreviewNotes(f),e.scheduleRedraw()}function Hn(e){e.setPastePreviewNotes&&At()&&e.setPastePreviewNotes(null)}function Fn(e,t){return At()?(vs(e.grid,t),t.preventDefault(),t.stopPropagation(),!0):!1}let qe=null;const ks=8;function sn(){qe=null}function Is(e,t){qe={x:e,y:t}}function Ts(e,t){if(!qe)return!1;const n=e-qe.x,o=t-qe.y;return Math.sqrt(n*n+o*o)>=ks}let Se=null;function Te(e){Se&&Se!==e&&Se.clearSelection(),Se=e}function Rs(){Se=null}function Ft(){return Se}function Ps(e,t,{getPitchRow:n,cellWidth:o,cellHeight:s,labelWidth:i}){const r=t.start*o+i,c=n(t.pitch)*s,a=t.duration*o,l=s-1,u=r+a/2,f=c+l/2,d=I(t.pitch);if(d===null)return;const m=d*5%360,h=e.animationCtx,p=performance.now(),g=500,y=3,E=60;function b(S,T,B){const N=Math.sin(S*Math.PI),k=1+T*N,A=(1-S)*B;h.globalAlpha=A,h.strokeStyle=`hsl(${m}, 100%, 65%)`,h.lineWidth=2;const q=a*k,O=l*k;h.beginPath(),h.roundRect(u-q/2,f-O/2,q,O,4),h.stroke()}function w(S){const T=Math.sin(S*Math.PI),N=`hsla(${m}, 100%, 80%, ${.4*T})`;h.globalAlpha=1,h.fillStyle=N,h.beginPath(),h.roundRect(r,c,a,l,3),h.fill()}function L(S){const T=S-p,B=T/g;if(B>1){h.clearRect(0,0,h.canvas.width,h.canvas.height);return}h.clearRect(0,0,h.canvas.width,h.canvas.height),h.save(),w(B);for(let N=0;N<y;N++){const k=N*E,A=Math.max(0,Math.min(1,(T-k)/(g-k)));b(A,.1+N*.1,.2)}h.restore(),requestAnimationFrame(L)}requestAnimationFrame(L)}function qs(e,t,{getPitchRow:n,cellWidth:o,cellHeight:s,labelWidth:i}){const r=t.start*o+i,c=n(t.pitch)*s,a=t.duration*o,l=s-1,u=r+a/2,f=c+l/2,d=I(t.pitch);if(d===null)return;const m=d*5%360,h=e.animationCtx,p=performance.now(),g=300;function y(E){const w=(E-p)/g;if(w>1){h.clearRect(0,0,h.canvas.width,h.canvas.height);return}h.clearRect(0,0,h.canvas.width,h.canvas.height),h.save();const L=1-.4*w,S=1-w,T=a*L,B=l*L;h.globalAlpha=S,h.fillStyle=`hsl(${m}, 100%, 70%)`,h.beginPath(),h.roundRect(u-T/2,f-B/2,T,B,3),h.fill(),h.restore(),requestAnimationFrame(y)}requestAnimationFrame(y)}function ct(e,t,n,o){if(!e||typeof e.getCellWidth!="function"||typeof e.getCellHeight!="function"||typeof e.getPitchRow!="function")return console.error("Invalid ctx object passed to isOnResizeHandle"),!1;const s=e.getCellWidth(),i=e.getCellHeight(),r=e.getPitchRow,c=Math.min(10,i*.8),l=(t.start+t.duration)*s+6,u=r(t.pitch)*i+(i-c)/2,f=4,d=l-f,m=l+c+f,h=u-f,p=u+c+f;return n>=d&&n<=m&&o>=h&&o<=p?console.log("Hit resize handle!"):console.log("Missed resize handle."),n>=d&&n<=m&&o>=h&&o<=p}function rn(e){let t=null,n=null,o=!1;function s(u){var E;if(console.log("ClickHandler called"),Te(e.grid),en()){tn(),e.scheduleRedraw();return}const{x:f,y:d}=e.getCanvasPos(u);if(f<0){const b=e.getPitchFromRow(Math.floor(d/e.getCellHeight()));e.sequencer.playNote(b,.5);return}const m=e.getSnappedBeatFromX(f),h=e.getPitchFromRow(Math.floor(d/e.getCellHeight())),p=U();if(m+e.config.currentDuration>p||e.notes.some(b=>b.pitch===h&&b.start===m))return;e.sequencer.playNote(h,.5);const y={pitch:h,start:m,duration:e.config.currentDuration};D($o(e.sequencer.id,[y]),Wo(e.sequencer.id,[y])),e.setSelectedNote(null),Ps(e,y,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:Q}),e.scheduleRedraw(),(E=e.onNotesChanged)==null||E.call(e)}function i(u){u.preventDefault();const{x:f,y:d}=e.getCanvasPos(u),m=e.findNoteAt(f,d);if(!m||e.notes.indexOf(m)===-1)return;qs(e,m,{getPitchRow:e.getPitchRow,cellWidth:e.getCellWidth(),cellHeight:e.getCellHeight(),labelWidth:Q});const p=[m];D(kt(e.sequencer.id,p),It(e.sequencer.id,p)),tn(),e.setSelectedNote(null),e.scheduleRedraw()}function r(u){if(Fn(e,u))return;const{x:f,y:d}=e.getCanvasPos(u),m=e.findNoteAt(f,d),h=wt();if(h&&ct(e,h,f,d)){on(h,f,d);return}if(m){if(ct(e,m,f,d)){console.log("Resize mode started!"),on(m,f,d);return}Te(e.grid),e.setSelectedNote(m),Te(e.grid),e.setSelectedNote(m),t={startX:f,startY:d,anchorNote:m,initialNotes:[{note:m,start:m.start,midi:I(m.pitch)??0}],lastPreviewPitch:void 0};return}Is(f,d),o=!1}function c(u){var y,E,b;e.grid.setCursor("default");const{x:f,y:d}=e.getCanvasPos(u);if(f<0){e.clearPreview();return}const m=at();if(m){e.grid.setCursor("ew-resize");const w=f-m.startX,L=e.getSnappedBeatFromX(w)-e.getSnappedBeatFromX(0),S=Math.max(us(),m.originalDuration+L);m.anchorNote.duration=S,e.scheduleRedraw(),(y=e.onNotesChanged)==null||y.call(e);return}On(e,f,d),nn(),e.grid.setCursor("default");const h=((E=e.getSelectedNotes)==null?void 0:E.call(e))??[];for(const w of h)if(ct(e,w,f,d)){Bs(w),e.grid.setCursor("ew-resize");break}if(!m&&!o&&Ts(f,d)){Ns(),e.selectionBox={active:!0,startX:f,startY:d,currentX:f,currentY:d},o=!0,Te(e.grid),sn();return}const p=e.findNoteAt(f,d);e.setHoveredNote(p??null);const g=e.getSelectedNote();if(at()||(t&&g?e.grid.setCursor("grabbing"):p&&e.grid.setCursor("grab")),!p&&!t&&!en()&&!wt()){const w=e.getSnappedBeatFromX(f),L=e.getPitchFromRow(Math.floor(d/e.getCellHeight())),S=U();w+e.config.currentDuration<=S?e.updatePreview({pitch:L,start:w,duration:e.config.currentDuration}):e.clearPreview()}else e.clearPreview();if(t&&g){const w=f-t.startX,L=e.getSnappedBeatFromX(w)-e.getSnappedBeatFromX(0),S=d-t.startY,T=Math.round(S/e.getCellHeight()),B=Math.max(0,t.initialNotes[0].start+L),N=U();B+g.duration<=N&&(g.start=B);const k=t.initialNotes[0].midi-T,A=I(e.config.noteRange[0])??0,q=I(e.config.noteRange[1])??127,O=Math.max(A,Math.min(q,k)),$=le(O)??g.pitch;$!==g.pitch&&(g.pitch=$,n!==$&&(n=$,e.sequencer.playNote($,.5))),e.scheduleRedraw(),(b=e.onNotesChanged)==null||b.call(e),Pe();return}e.scheduleRedraw()}function a(u){console.log("UpHandler called"),sn(),o=!1;const f=at();if(f){const{anchorNote:g,originalDuration:y}=f,E=g.duration;y!==E&&D(Jo(e.sequencer.id,[{pitch:g.pitch,start:g.start,newDuration:E}]),xo(e.sequencer.id,[{pitch:g.pitch,start:g.start,oldDuration:y}])),Ms(),Pe();return}if(!t||!e.getSelectedNote()){t=null;return}const{anchorNote:d}=t,m=t.initialNotes.find(g=>g.note===d);if(!m)return;const h={pitch:m.note.pitch,start:m.note.start,duration:m.note.duration};(m.start!==m.note.start||m.midi!==I(m.note.pitch))&&D(Tt(e.sequencer.id,[{pitch:le(m.midi)??m.note.pitch,start:m.start,duration:m.note.duration}],[h]),Ln(e.sequencer.id,[{pitch:le(m.midi)??m.note.pitch,start:m.start,duration:m.note.duration}],[h])),Pe(),t=null}function l(){e.clearPreview(),e.setHoveredNote(null),nn(),Hn(e),e.scheduleRedraw()}return{attach(u){u.addEventListener("click",s),u.addEventListener("contextmenu",i),u.addEventListener("mousemove",c),u.addEventListener("mouseleave",l),u.addEventListener("mousedown",r),u.addEventListener("mouseup",a)},detach(u){u.removeEventListener("click",s),u.removeEventListener("contextmenu",i),u.removeEventListener("mousemove",c),u.removeEventListener("mouseleave",l),u.removeEventListener("mousedown",r),u.removeEventListener("mouseup",a)}}}function an(e,{startX:t,currentX:n,startY:o,currentY:s,getCellHeight:i,getSnappedBeatFromX:r,getPitchFromRow:c}){const a=Math.min(t,n),l=Math.min(o,s),u=Math.max(t,n),f=Math.max(o,s),d=Math.floor(l/i()),m=Math.floor(f/i()),h=r(a),p=r(u),g=I(c(d)),y=I(c(m));return e.filter(E=>{const b=I(E.pitch);if(b===null||g===null||y===null)return!1;const w=E.start,S=E.start+E.duration>h&&w<p,T=b>=y-1&&b<=g+1;return S&&T})}function cn(e){let t=null;function n(c){c.preventDefault();const{x:a,y:l}=e.getCanvasPos(c),u=e.findNoteAt(a,l);if(!u)return;const f=e.getSelectedNotes(),d=f.includes(u)?f:[u];d.length&&(e.setSelectedNotes([]),D(kt(e.sequencer.id,d),It(e.sequencer.id,d)),Ne()&&(Le(),Z(re.NOTE_PLACEMENT)))}function o(c){if(!e.grid||Fn(e,c))return;const{x:a,y:l}=e.getCanvasPos(c);if(a<0)return;const u=e.findNoteAt(a,l);e.setHoveredNote(u??null),Te(e.grid);const f=e.getSelectedNotes();if(u&&f.includes(u)){t={startX:a,startY:l,anchorNote:u,initialNotes:f.map(d=>({note:d,start:d.start,midi:I(d.pitch)??0}))};return}e.selectionBox={active:!0,startX:a,startY:l,currentX:a,currentY:l},e.clearPreview(),e.setSelectedNote(null)}function s(c){var w,L;if(!e.grid)return;Cs(e.grid);const{x:a,y:l}=e.getCanvasPos(c),u=e.findNoteAt(a,l);if(e.setHoveredNote(u??null),On(e,a,l),(w=e.selectionBox)!=null&&w.active){if(!e.setHighlightedNotes)return;e.selectionBox.currentX=a,e.selectionBox.currentY=l;const S=e.selectionBox,T=an(e.notes,{startX:S.startX,currentX:S.currentX,startY:S.startY,currentY:S.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes(T),e.scheduleRedraw();return}if(!t)return;const f=t,d=a-f.startX,m=e.getSnappedBeatFromX(d)-e.getSnappedBeatFromX(0),h=l-f.startY,p=Math.round(h/e.getCellHeight()),g=U(),y=I(e.config.noteRange[0])??0,E=I(e.config.noteRange[1])??127;for(const{note:S,start:T,midi:B}of f.initialNotes){const N=Math.max(0,T+m),k=Math.max(y,Math.min(E,B-p)),A=le(k)??S.pitch;N+S.duration<=g&&(S.start=N,S.pitch=A)}const b=f.initialNotes.find(S=>S.note===f.anchorNote);if(b){const S=b.note.pitch;f.lastPreviewPitch!==S&&(f.lastPreviewPitch=S,e.sequencer.playNote(S,.5))}e.scheduleRedraw(),(L=e.onNotesChanged)==null||L.call(e)}function i(c){var a,l;if((a=t==null?void 0:t.initialNotes)!=null&&a.length){const{initialNotes:u}=t,f=u.map(({start:h,midi:p,note:g})=>({pitch:le(p)??g.pitch,start:h,duration:g.duration})),d=u.map(({note:h})=>({pitch:h.pitch,start:h.start,duration:h.duration}));f.some((h,p)=>h.pitch!==d[p].pitch||h.start!==d[p].start)&&(D(Tt(e.sequencer.id,f,d),Ln(e.sequencer.id,f,d)),Ne()&&(Le(),Z(re.NOTE_PLACEMENT)))}if(t=null,(l=e.selectionBox)!=null&&l.active){if(!e.setHighlightedNotes)return;const{x:u,y:f}=e.getCanvasPos(c);e.selectionBox.currentX=u,e.selectionBox.currentY=f,e.selectionBox.active=!1;const d=an(e.notes,{startX:e.selectionBox.startX,currentX:e.selectionBox.currentX,startY:e.selectionBox.startY,currentY:e.selectionBox.currentY,getCellHeight:e.getCellHeight,getSnappedBeatFromX:e.getSnappedBeatFromX,getPitchFromRow:e.getPitchFromRow});e.setHighlightedNotes([]),e.setSelectedNotes(d),e.scheduleRedraw(),Ne()&&e.getSelectedNotes().length===0&&(c.stopPropagation(),Le(),Z(re.NOTE_PLACEMENT),Pe()),Pe()}}function r(){e.setHighlightedNotes&&(e.setHoveredNote(null),e.setHighlightedNotes([]),Hn(e),e.scheduleRedraw())}return{attach(c){c.addEventListener("mousedown",o),c.addEventListener("mousemove",s),c.addEventListener("mouseup",i),c.addEventListener("mouseleave",r),c.addEventListener("contextmenu",n)},detach(c){c.removeEventListener("mousedown",o),c.removeEventListener("mousemove",s),c.removeEventListener("mouseup",i),c.removeEventListener("mouseleave",r),c.removeEventListener("contextmenu",n)}}}function As(e,t){const n=t.selectionBox;if(!n)return;const o=n.startX,s=n.startY,i=n.currentX,r=n.currentY,c=Math.min(o,i),a=Math.min(s,r),l=Math.abs(i-o),u=Math.abs(r-s);e.save(),e.strokeStyle="rgba(128, 90, 213, 1.0)",e.lineWidth=2,e.setLineDash([5,5]),bn(e,c,a,l,u,3),e.stroke(),e.restore()}function _s(e,t,{cellWidth:n,cellHeight:o,getPitchRow:s,isHovered:i=!1}){const r=Math.min(10,o*.8),a=(t.start+t.duration)*n+6,l=s(t.pitch)*o+(o-r)/2;e.save(),e.shadowColor="rgba(0,0,0,0.4)",e.shadowBlur=3,e.shadowOffsetX=1,e.shadowOffsetY=2,e.fillStyle=i?"rgba(0, 255, 255, 0.95)":"rgba(255, 255, 255, 0.85)",e.beginPath(),e.moveTo(a,l),e.lineTo(a+r,l+r/2),e.lineTo(a,l+r),e.closePath(),e.fill();const u=e.createLinearGradient(a,l,a,l+r);u.addColorStop(0,"rgba(255,255,255,0.9)"),u.addColorStop(.5,"rgba(255,255,255,0.5)"),u.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=u,e.beginPath(),e.moveTo(a,l),e.lineTo(a+r,l+r/2),e.lineTo(a,l+r),e.closePath(),e.fill(),e.restore()}function Ds(e,t,n,o,s,i,r){let c=null,a=null,l=null,u=null,f=[],d=2;const m=e.getContext("2d"),h=t.getContext("2d"),p=n.getContext("2d");if(!m||!h||!p)throw new Error("Failed to acquire required canvas contexts");const g=m,y=h,E=p;let b=Ge[d].cellWidth,w=Ge[d].cellHeight;const L=xt(i.noteRange[1],i.noteRange[0])+1,S=L*w,B=U()*b+Q;e.width=B,e.height=S,e.style.width=`${B}px`,e.style.height=`${S}px`,t.width=B,t.height=S,t.style.width=`${B}px`,t.style.height=`${S}px`,n.width=B,n.height=S,n.style.width=`${B}px`,n.style.height=`${S}px`;let N=null;function k(){N!==null&&cancelAnimationFrame(N),N=requestAnimationFrame(A)}function A(){var v,_;g.clearRect(0,0,e.width,e.height),g.save(),g.translate(Q,0),fs(g,i,L,b,w,H),ps(g,s,{previewNotes:a??(c?[c]:null),hoveredNote:l,selectedNote:u,selectedNotes:f,highlightedNotes:((v=P.getHighlightedNotes)==null?void 0:v.call(P))??[],cellWidth:b,cellHeight:w,visibleStartBeat:0,visibleEndBeat:e.width/b,getPitchRow:C,getPitchClass:Co,getTrackColor:()=>Ho(r),drawRoundedRect:bn});for(const G of f)_s(g,G,{cellWidth:b,cellHeight:w,getPitchRow:C,isHovered:G===wt()});(_=P.selectionBox)!=null&&_.active&&As(g,P),g.restore()}function q(){d<Ge.length-1&&(d++,z())}function O(){d>0&&(d--,z())}function $(){d=2,z()}function z(){const v=Ge[d];b=v.cellWidth,w=v.cellHeight,Y()}function Y(){const _=U()*b+Q,V=(xt(i.noteRange[1],i.noteRange[0])+1)*w;e.width=_,e.height=V,e.style.width=`${_}px`,e.style.height=`${V}px`,t.width=_,t.height=V,t.style.width=`${_}px`,t.style.height=`${V}px`,n.width=_,n.height=V,n.style.width=`${_}px`,n.style.height=`${V}px`,E.clearRect(0,0,n.width,n.height),k()}function pe(v){ys(y,v,Q,e.height)}Ss(r.container,q,O,$);function C(v){const _=I(i.noteRange[1]),G=I(v);return _===null||G===null?(console.warn(`Invalid pitch encountered: ${v}`),0):_-G}function H(v){const _=I(i.noteRange[1]),G=I(i.noteRange[0]);if(_===null||G===null)return console.warn(`Invalid pitch range configured: ${i.noteRange}`),"C4";const V=_-v,co=Math.max(G,Math.min(_,V));return le(co)??"C4"}function R(){const v=document.getElementById("global-mini-contour");v instanceof HTMLCanvasElement&&J(v,M)}let F=null;const P={sequencer:r,grid:null,config:i,notes:s,canvas:e,animationCtx:E,getCellHeight:()=>w,getCellWidth:()=>b,getCanvasPos:v=>Es(e,v,o,Q),findNoteAt:(v,_)=>bs(v,_,s,C,w,b),scheduleRedraw:k,getPitchFromRow:H,getPitchRow:C,getSnappedBeatFromX:v=>bo(v,i,()=>b),updatePreview:v=>c=v,clearPreview:()=>c=null,getSelectedNote:()=>u,setSelectedNote:v=>{u=v,f=v?[v]:[]},getSelectedNotes:()=>f,setSelectedNotes:v=>{f=v,u=v.length===1?v[0]:null},setHoveredNote:v=>l=v,onNotesChanged:R};function x(v){F==null||F.detach(e),F=v,F==null||F.attach(e)}function Ut(){u=null,f=[],l=null,Xe=[],k()}const rt={"note-placement":()=>x(rn(P)),select:()=>x(cn(P)),none:()=>x(null)};let eo=Ls(v=>{var _,G,V;c=null,a=null,Xe=[],(_=P.clearPreview)==null||_.call(P),(G=P.setPastePreviewNotes)==null||G.call(P,null),P.selectionBox&&(P.selectionBox.active=!1,P.selectionBox=null),Ut(),(V=rt[v])==null||V.call(rt),k()});function to(){return u}function no(){return c}function oo(v){return v*b}function so(v){e.style.cursor=v}function io(){return f}function ro(v){f=v,u=v.length===1?v[0]:null}function ao(){eo(),Rs()}const zt={canvas:e,scheduleRedraw:k,drawPlayhead:pe,getSelectedNote:to,clearSelection:Ut,getPreviewNote:no,zoomIn:q,zoomOut:O,getXForBeat:oo,setMouseHandler:x,setCursor:so,gridContext:P,getSelectedNotes:io,setSelectedNotes:ro,destroy:ao,resizeAndRedraw:Y},Kt=An();let Xt=null,Gt=null;Kt==="note-placement"?(Xt=rn(P),x(Xt)):Kt==="select"?(Gt=cn(P),x(Gt)):x(null),P.setPastePreviewNotes=v=>{a=v};let Xe=[];return P.getHighlightedNotes=()=>Xe,P.setHighlightedNotes=v=>{Xe=v},P.grid=zt,zt}function Os(e,t,{getPitchRow:n,cellWidth:o,cellHeight:s,labelWidth:i}){if(!(e!=null&&e.animationCtx)){console.warn("Missing animationCtx in animateNotePlay");return}const r=t.start*o+i,c=n(t.pitch)*s,a=t.duration*o,l=s-1,u=r+a/2,f=c+l/2,m=(I(t.pitch)||0)*5%360,h=e.animationCtx,p=document.createElement("canvas");p.width=h.canvas.width,p.height=h.canvas.height;let g=p.getContext("2d");if(!g){console.warn("Could not get animation context from offscreen canvas");return}const y=performance.now(),E=ge();let b=t.duration*6e4/E;b=Math.max(100,Math.min(b,1600));const w=2,L=50;function S(N){const k=Math.sin(N*Math.PI),A=`hsla(${m}, 100%, 70%, ${.4*k})`;g&&(g.globalAlpha=1,g.fillStyle=A,g.beginPath(),g.roundRect(r,c,a,l,3),g.fill())}function T(N,k,A){const q=Math.sin(N*Math.PI),O=1+k*q,$=(1-N)*A;if(g){g.globalAlpha=$,g.strokeStyle=`hsl(${m}, 100%, 65%)`,g.lineWidth=1.5;const z=a*O,Y=l*O;g.beginPath(),g.roundRect(u-z/2,f-Y/2,z,Y,4),g.stroke()}}function B(N){const k=N-y,A=k/b;if(A>1){g=null,p.width=0,p.height=0;return}if(g){g.clearRect(0,0,p.width,p.height),g.save(),S(A);for(let z=0;z<w;z++){const Y=z*L,pe=Math.max(0,Math.min(1,(k-Y)/(b-Y)));T(pe,.1+z*.1,.3)}g.restore(),h.save();const q=1.5,O=a*q+8,$=l*q+8;h.clearRect(u-O/2,f-$/2,O,$),h.globalAlpha=1,h.drawImage(p,0,0),h.restore()}requestAnimationFrame(B)}requestAnimationFrame(B)}class $n{constructor(t,n,o=ae,s=se,i="fluidr3-gm/acoustic_grand_piano"){this.notes=[],this.colorIndex=0,this.id=0,this.mute=!1,this.solo=!1,this.shouldPlay=!0,this._activeNotes=new Set,this._noteHandlers=new Map,this._beatHandler=null,this._unsub=null,this.container=t,this.config={...n},this.context=o,this.destination=s,this.instrumentName=i,this.container&&(this.pianoRollCanvas=this.container.querySelector(".piano-roll"),this.gridCanvas=this.container.querySelector(".note-grid"),this.animationCanvas=this.container.querySelector(".note-animate-canvas"),this._initCanvases())}async initInstrument(){try{await tt(this.instrumentName),console.log(`[SEQ:${this.id}] Instrument '${this.instrumentName}' loaded`)}catch(t){console.error(`[SEQ:${this.id}] Failed to load instrument '${this.instrumentName}':`,t)}}updateTrackLabel(){var n;const t=(n=this.container)==null?void 0:n.querySelector(".track-name");t&&(t.textContent=`${this.id+1}: ${this.instrumentName}`)}setInstrument(t){this.instrumentName=t,this.updateTrackLabel(),this.initInstrument()}playNote(t,n,o=100,s=!1){return li(this.instrumentName,t,n,o,s)}_initCanvases(){if(!this.container)return;const t=this.container.querySelector("canvas.note-grid"),n=this.container.querySelector("canvas.playhead-canvas"),o=this.container.querySelector("#grid-scroll-container"),s=this.container.querySelector("canvas.note-animate-canvas");this.grid=Ds(t,n,s,o,this.notes,this.config,this),this.grid.scheduleRedraw()}onTransportLoop(){this._activeNotes.clear()}updateTotalMeasures(){var r,c,a;const t=U();this.clampNotesToGrid();const n=t*this.config.cellWidth+Q,o=(r=this.container)==null?void 0:r.querySelector("canvas.note-grid"),s=(c=this.container)==null?void 0:c.querySelector(".playhead-canvas"),i=(a=this.container)==null?void 0:a.querySelector(".mini-contour");o&&(o.width=n,o.style.width=`${n}px`),s&&(s.width=n,s.style.width=`${n}px`),i&&$e(i,this.notes,this.config,this.colorIndex),this.redraw()}clampNotesToGrid(){const t=U(),n=this.notes.filter(o=>o.start<t);n.forEach(o=>{o.start+o.duration>t&&(o.duration=t-o.start)}),this.notes.splice(0,this.notes.length,...n)}play(){this.stop(),this.clampNotesToGrid(),this._activeNotes.clear(),this._noteHandlers.clear();const n=60/ge();this._beatHandler=o=>{var s,i;if((s=this.grid)==null||s.drawPlayhead(this.grid.getXForBeat(o)),!!this.shouldPlay)for(const r of this.notes){const c=r.start,a=r.start+r.duration;if(!this._activeNotes.has(r)&&c<=o&&o<=a){const l=r.duration*n;if(this.playNote(r.pitch,l),(i=this.grid)!=null&&i.gridContext){const u=this.grid.gridContext;Os(u,r,{getPitchRow:u.getPitchRow,cellWidth:u.getCellWidth(),cellHeight:u.getCellHeight(),labelWidth:Q})}this._activeNotes.add(r)}}},this._unsub=gt(this._beatHandler),this._beatHandler(0)}stop(){var t,n,o;this._unsub&&(this._unsub(),this._unsub=null),this._beatHandler=null;for(const s of this._activeNotes){const i=this._noteHandlers.get(s);(t=i==null?void 0:i.forceStop)==null||t.call(i),(n=i==null?void 0:i.stop)==null||n.call(i)}this._activeNotes.clear(),this._noteHandlers.clear(),(o=this.grid)==null||o.drawPlayhead(0),this.redraw()}pause(){var t;for(const n of this._activeNotes){const o=this._noteHandlers.get(n);(t=o==null?void 0:o.stop)==null||t.call(o)}this._activeNotes.clear(),this._unsub&&(this._unsub(),this._unsub=null)}resume(){this._beatHandler&&!this._unsub&&(this._unsub=gt(this._beatHandler))}seekTo(t){this.stop(),this.play()}toggleMute(){this.mute=!this.mute,this.mute&&(this.solo=!1),this.updateTrackStyle()}toggleSolo(){this.solo=!this.solo,this.solo&&(this.mute=!1),this.updateTrackStyle()}updateTrackStyle(){if(!this.container)return;const t=this.container.querySelector(".mute-btn"),n=this.container.querySelector(".solo-btn");t==null||t.classList.toggle("bg-red-600",this.mute),t==null||t.classList.toggle("bg-gray-700",!this.mute),n==null||n.classList.toggle("bg-yellow-200",this.solo),n==null||n.classList.toggle("bg-gray-700",!this.solo),this.container.classList.toggle("opacity-40",this.mute&&!this.solo),this.container.classList.toggle("opacity-100",!(this.mute&&!this.solo))}redraw(){var t;(t=this.grid)==null||t.scheduleRedraw()}destroy(){var t;this.stop(),(t=this.container)==null||t.remove()}getState(){return{notes:[...this.notes],config:{...this.config},instrument:this.instrumentName}}setState({notes:t,config:n,instrument:o}){this.notes.length=0,this.notes.push(...t),Object.assign(this.config,n),o&&(this.instrumentName=o),this.redraw()}updateNotesFromTrackMap(t){this.notes.splice(0,this.notes.length,...t.n.map(([n,o,s])=>({pitch:n,start:o,duration:s})))}async exportToOffline(){const t=60/ge(),n=await tt(this.instrumentName,this.context,this.destination);for(const o of this.notes){const s=o.start*t,i=o.duration*t,r=I(o.pitch);if(r!=null)if(this.instrumentName.startsWith("drummachines/")&&n.__midiMap){const c=n.__midiMap.get(r);c&&n.start({note:c,duration:i,velocity:100,time:s,loop:!1})}else n.start({note:r,duration:i,velocity:100,time:s,loop:!1})}}}const M=[],Hs=document.getElementById("sequencers-container"),Fs=document.getElementById("sequencer-template"),Wn=document.getElementById("add-sequencer");function Un(e){const n=Fs.content.cloneNode(!0).querySelector(".sequencer");Hs.insertBefore(n,Wn);const o=M.length,s={id:o,...X},i=(e==null?void 0:e.instrument)||"fluidr3-gm/acoustic_grand_piano",r=new $n(n,s,ae,se,i);r.id=o,r.colorIndex=o,r.mute=!1,r.solo=!1,r.shouldPlay=!0;const c=n.querySelector("canvas.mini-contour");e&&r.setState({notes:e.notes,config:{},instrument:e.instrument}),$e(c,r.notes,r.config,r.colorIndex),r.updateTrackLabel(),r.initInstrument();const a=n.querySelector(".collapse-btn"),l=a.querySelector("use"),u=n.querySelector(".sequencer-body");a.addEventListener("click",()=>{const p=u.classList.toggle("hidden");l.setAttribute("href",p?"#icon-caret-up":"#icon-caret-down"),c.classList.toggle("hidden",!p),Ke(n,!p),p&&$e(c,r.notes,r.config,r.colorIndex)}),n.querySelector(".delete-btn").addEventListener("click",()=>{const p=document.getElementById("delete-confirm-modal"),g=document.getElementById("delete-confirm"),y=document.getElementById("delete-cancel");p.classList.remove("hidden");const E=()=>{const L=qo(r.id,r.instrumentName,r.notes),S=Ao(r.id,r.instrumentName,r.notes);D(L,S),w()},b=()=>{w()},w=()=>{p.classList.add("hidden"),g.removeEventListener("click",E),y.removeEventListener("click",b)};g.addEventListener("click",E),y.addEventListener("click",b)});const d=n.querySelector(".mute-btn"),m=n.querySelector(".solo-btn"),h=n.querySelector(".instrument-select-btn");return d.addEventListener("click",()=>{r.mute=!r.mute,r.mute&&(r.solo=!1,m.classList.remove("bg-yellow-200","hover:bg-yellow-400"),m.classList.add("bg-gray-700","hover:bg-purple-700"),Ie(m,!1)),Ie(d,r.mute),ln(),r.seekTo(Je())}),m.addEventListener("click",()=>{r.solo=!r.solo,r.solo&&(r.mute=!1,Ie(d,!1)),m.classList.toggle("bg-yellow-200",r.solo),m.classList.toggle("bg-gray-700",!r.solo),m.classList.toggle("hover:bg-yellow-400",r.solo),m.classList.toggle("hover:bg-purple-700",!r.solo),ln(),r.seekTo(Je())}),h.addEventListener("click",async()=>{const p=document.getElementById("instrument-select-modal"),g=document.getElementById("instrument-library-select");document.getElementById("instrument-select");const y=r.instrumentName||"fluidr3-gm/acoustic_grand_piano",[E]=y.split("/");g.value=E,g.dispatchEvent(new CustomEvent("change",{detail:{preselect:y}})),p.dataset.currentSequencer=String(r.id),p.classList.remove("hidden")}),Zs(n),Ie(d,!1),Ie(m,!1),m.classList.add("hover:bg-purple-700"),M.push(r),{seq:r,wrapper:n}}function Ke(e,t){var n,o,s,i,r;(n=e.querySelector(".zoom-in-btn"))==null||n.classList.toggle("hidden",!t),(o=e.querySelector(".zoom-out-btn"))==null||o.classList.toggle("hidden",!t),(s=e.querySelector(".zoom-reset-btn"))==null||s.classList.toggle("hidden",!t),(i=e.querySelector(".zoom-button-divider"))==null||i.classList.toggle("hidden",!t),(r=e.querySelector(".grip-handle"))==null||r.classList.toggle("hidden",!t)}function de(){return M}function $s(e){const t=e;return M.find(n=>n.id===t)}function ln(){const e=M.some(t=>t.solo);M.forEach(t=>{t.shouldPlay=e?t.solo:!t.mute})}function Ie(e,t){e.classList.toggle("opacity-100",t),e.classList.toggle("opacity-40",!t)}function Ws(){M.slice().forEach(n=>n.destroy()),M.length=0;const e=ke(),t=structuredClone(e);t.sequencers=[],as(),Bn(t),We(t)}function Us(){document.getElementById("global-mini-contour"),Wn.addEventListener("click",()=>{const e=M.length;D(Cn(e,"fluidr3-gm/acoustic_grand_piano"),Mt(e))})}const zs=["Darkroom","Seashell","Cyberpunk","Classic Blue","Midnight"],Ks=["Track Color","Pitch Class Contrast","Scriabin","Octave Bands"];function Xs(){const e=document.getElementById("grid-color-select"),t=document.getElementById("note-color-select");if(!e||!t)return;for(const o of zs){const s=document.createElement("option");s.value=o,s.textContent=o,e.appendChild(s)}for(const o of Ks){const s=document.createElement("option");s.value=o,s.textContent=o,t.appendChild(s)}const n=Me();e.value=n.gridColorScheme,t.value=n.noteColorScheme,e.addEventListener("change",o=>{const s=o.target;Fe({gridColorScheme:s.value}),de().forEach(i=>{var r;return(r=i.grid)==null?void 0:r.scheduleRedraw()})}),t.addEventListener("change",o=>{const s=o.target;Fe({noteColorScheme:s.value}),de().forEach(i=>{var r;return(r=i.grid)==null?void 0:r.scheduleRedraw()})})}function Gs(){const e=document.getElementById("userconfig-modal"),t=document.querySelectorAll(".settings-tab"),n=document.querySelectorAll(".settings-section");if(!e)return;function o(){t.forEach(s=>{const i=s.dataset.tab;if(!i)return;const r=document.getElementById(i),c=r!==null&&!r.classList.contains("hidden");s.classList.toggle("text-purple-500",c),s.classList.toggle("opacity-100",c),s.classList.toggle("text-gray-500",!c),s.classList.toggle("opacity-50",!c)})}t.forEach(s=>{s.addEventListener("click",()=>{const i=s.dataset.tab;if(!i)return;n.forEach(c=>c.classList.add("hidden"));const r=document.getElementById(i);r&&r.classList.remove("hidden"),o()})}),o(),yo(),Xs()}let un=!1,me=!1,he=!1;function js({getSequencers:e,onPlay:t,onStop:n,onPause:o,onResume:s,onDurationChange:i,onSnapChange:r,onToggleLoop:c,onTempoChange:a,onSave:l,onLoad:u,onMeasuresChange:f,onBeatsPerMeasureChange:d}){if(un)return;un=!0;const m=document.getElementById("play-button"),h=m.querySelector("use"),p=document.getElementById("stop-button"),g=document.getElementById("note-duration"),y=document.getElementById("dotted-note-btn"),E=document.getElementById("triplet-note-btn"),b=document.getElementById("snap-resolution"),w=document.getElementById("loop-toggle"),L=document.getElementById("tempo-input"),S=document.getElementById("save-button"),T=document.getElementById("load-button"),B=document.getElementById("load-input"),N=document.getElementById("measures-input"),k=document.getElementById("beats-per-measure-input"),A=document.getElementById("config-button"),q=document.getElementById("export-modal"),O=document.getElementById("export-json"),$=document.getElementById("export-wav"),z=document.getElementById("export-midi"),Y=document.getElementById("export-cancel");g.value=String(X.currentDuration||1),b.value=String(X.snapResolution||.25),h.setAttribute("href","#icon-play"),m.addEventListener("click",()=>{!me&&!he?(me=!0,he=!1,t(),h.setAttribute("href","#icon-pause")):me?(me=!1,he=!0,o(),h.setAttribute("href","#icon-play")):he&&(me=!0,he=!1,s(),h.setAttribute("href","#icon-pause"))}),p.addEventListener("click",()=>{n(),me=!1,he=!1,h.setAttribute("href","#icon-play")}),window.addEventListener("keydown",C=>{var F;if(document.querySelector(".ai-modal:not(.hidden)"))return;const R=(F=document.activeElement)==null?void 0:F.tagName;if(!(R==="INPUT"||R==="TEXTAREA")){if(C.code==="Space"){C.preventDefault(),m.click();return}if((C.metaKey||C.ctrlKey)&&(C.key==="z"&&is(),C.key==="y"&&rs()),(C.metaKey||C.ctrlKey)&&C.key.toLowerCase()==="r"){C.preventDefault();return}if(An()===re.NOTE_PLACEMENT){if(Object.prototype.hasOwnProperty.call(Yt,C.code)){C.preventDefault();const P=Yt[C.code];g.value=String(P),g.dispatchEvent(new Event("change"))}if(C.key==="."){C.preventDefault(),y==null||y.click();return}if(C.key==="/"){C.preventDefault(),E==null||E.click();return}}}}),g.addEventListener("change",C=>{const H=C.target,R=parseFloat(H.value);pe(R),i(R),e().forEach(F=>{const P=F.grid;if(P!=null&&P.getPreviewNote){const x=P.getPreviewNote();x&&(x.duration=R,P.scheduleRedraw())}})});function pe(C){document.querySelectorAll(".note-duration-btn").forEach(R=>{const F=parseFloat(R.dataset.value??"0");R.classList.remove("bg-purple-700","bg-gray-800"),F===C?R.classList.add("bg-purple-700"):R.classList.add("bg-gray-800")})}b.addEventListener("change",C=>{const R=C.target.value;Object.prototype.hasOwnProperty.call(fo,R)&&(X.snapResolution=parseFloat(R),b.value=String(R),r(X.snapResolution))}),w.addEventListener("change",C=>{const H=C.target;c(H.checked)}),L.addEventListener("change",C=>{const H=C.target,R=parseInt(H.value,10);isNaN(R)||a(R)}),S.addEventListener("click",()=>{q?q.classList.remove("hidden"):l("json")}),T.addEventListener("click",()=>{B.click()}),B.addEventListener("change",C=>{var F;const H=C.target,R=(F=H.files)==null?void 0:F[0];R&&u(R),H.value=""}),O&&O.addEventListener("click",()=>{q==null||q.classList.add("hidden"),l==null||l("json")}),$&&$.addEventListener("click",()=>{q==null||q.classList.add("hidden"),l==null||l("wav")}),z&&z.addEventListener("click",()=>{q==null||q.classList.add("hidden"),l==null||l("midi")}),Y&&Y.addEventListener("click",()=>{q==null||q.classList.add("hidden")}),A==null||A.addEventListener("click",()=>{const C=document.getElementById("userconfig-modal");C==null||C.classList.remove("hidden")}),Gs(),N&&(N.value=String(ze())),k&&(k.value=String(Ue())),N==null||N.addEventListener("change",C=>{const H=C.target,R=parseInt(H.value,10);!isNaN(R)&&R>0&&(f==null||f(R))}),k==null||k.addEventListener("change",C=>{const H=C.target,R=parseInt(H.value,10);!isNaN(R)&&R>0&&(d==null||d(R))}),pe(parseFloat(g.value))}function Ys(){me=!1,he=!1;const e=document.getElementById("play-button"),t=e==null?void 0:e.querySelector("use");t&&t.setAttribute("href","#icon-play")}function Vs(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.remove("hidden")}function Qs(){var e;(e=document.getElementById("loading-modal"))==null||e.classList.add("hidden")}function Zs(e){const t=e.querySelector(".cursor-grab");if(!t)return;const n=e.querySelector(".sequencer-body");if(!n)return;let o=!1,s=0,i=0;const r=150,c=1e3;t.addEventListener("mousedown",a=>{o=!0,s=a.clientY,i=n.offsetHeight,t.classList.replace("cursor-grab","cursor-grabbing"),document.body.style.userSelect="none"}),window.addEventListener("mousemove",a=>{if(!o)return;const l=a.clientY-s;let u=i+l;u=Math.max(r,Math.min(c,u)),n.style.height=`${u}px`}),window.addEventListener("mouseup",()=>{o&&(o=!1,t.classList.replace("cursor-grabbing","cursor-grab"),document.body.style.userSelect="")})}let K=null,Ae=0;const lt=new Map;async function fe(){K||(K=await gn(()=>import("https://unpkg.com/smplr@latest/dist/index.mjs"),[]))}function zn(){return ae}async function tt(e,t=ae,n=null){var l;await fe();const[o,s]=e.includes("/")?e.split("/"):["musyngkite",e],i=t instanceof OfflineAudioContext;lt.has(t)||lt.set(t,new Map);const r=lt.get(t),c=`${o}/${s}`;if(r.has(c))return r.get(c);let a;if(o==="smolken")a=new K.Smolken(t,{instrument:s,destination:n||se,disableScheduler:i}),await ye(a.load);else if(o==="splendidgrandpiano")a=new K.SplendidGrandPiano(t,{destination:n||se,disableScheduler:i}),await ye(a.load);else if(o==="electricpiano")a=new K.ElectricPiano(t,{instrument:s,destination:n||se,disableScheduler:i}),await ye(a.load);else if(o==="mallets")a=new K.Mallet(t,{instrument:s,destination:n||se,disableScheduler:i}),await ye(a.load);else if(o==="drummachines"){a=new K.DrumMachine(t,{instrument:s,destination:n||se,disableScheduler:i}),await ye(a.load);const u=((l=a.getSampleNames)==null?void 0:l.call(a))??[],f=new Map;u.forEach((d,m)=>{const h=36+m;f.set(h,d)}),a.__midiMap=f}else{const f={"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[o.toLowerCase()]||"MusyngKite",d=await si();console.log(`[Soundfont] Available kits: ${d.join(", ")}`),console.log(`[Soundfont] Requested: kit=${f} instrument=${s}`);const h=`https://gleitz.github.io/midi-js-soundfonts/${f}/${s}-ogg.js`;a=new K.Soundfont(t,{instrument:s,instrumentUrl:h,kit:f,destination:n||se,disableScheduler:i}),await ye(a.load)}return r.set(c,a),a}async function Js(){return await fe(),K.getMalletNames()}async function xs(){return await fe(),K.getElectricPianoNames()}async function ei(){return await fe(),["splendidgrandpiano"]}async function ti(){return await fe(),K.getDrumMachineNames()}async function ni(){return await fe(),K.getSmolkenNames()}async function oi(e="MusyngKite"){await fe();const t=await K.getSoundfontNames(e);return console.log(`[SF2] Instruments in kit "${e}":`,t),t}async function si(){return await fe(),K.getSoundfontKits()}function ii(){Ae++,Ae===1&&Vs()}function ri(){Ae--,Ae<=0&&(Ae=0,Qs())}async function ye(e){ii();try{await e}finally{ri()}}let ee=null,vt=null;async function Kn(e){if(vt===e)return;ee=await tt(e),vt=e,console.log(`[SF2] Global keyboard instrument set to: ${e}`)}function ai(){return vt}function Xn(e,t=100,n=!1){var c;if(!ee)return null;const s=zn().currentTime,i=I(e);if(i===null)return null;const r=((c=ee.__midiMap)==null?void 0:c.get(i))??i;return ee.start({note:r,stopId:r,velocity:t,time:s,loop:n}),()=>{ee==null||ee.stop({stopId:r})}}function ci(e){var o;if(!ee)return;const t=I(e);if(t===null)return;const n=((o=ee.__midiMap)==null?void 0:o.get(t))??t;ee.stop({stopId:n})}async function li(e,t,n,o=100,s=!1,i=null,r=null,c=null){var d;const a=r||zn(),l=await tt(e,a,c),u=I(t);if(u===null)return null;const f=((d=l.__midiMap)==null?void 0:d.get(u))??u;return l.start({note:f,duration:n,velocity:o,loop:s,time:i??a.currentTime}),null}const ae=new(window.AudioContext||window.webkitAudioContext),it=ae.createAnalyser();it.fftSize=2048;const se=ae.createGain();se.connect(it);it.connect(ae.destination);function ui(e){ae.resume();try{const t=Xn(e,100,!1);return t?{stop:t,forceStop:t}:null}catch(t){return console.error("[playNote] Failed to play note",e,t),null}}ae.resume().catch(e=>{console.warn("Failed to resume AudioContext:",e)});let dn=!1,je=null;function di(e,t){if(dn)return;dn=!0,je=t;const n=e.getContext("2d");if(!n)return;const o=new Map,s=new Set;function i(u,f){const d=je();for(const m of Object.values(d))if(m.isBlack&&u>=m.x&&u<=m.x+m.width&&f>=0&&f<=m.height)return m.note;for(const m of Object.values(d))if(!m.isBlack&&u>=m.x&&u<=m.x+m.width&&f>=0&&f<=m.height)return m.note;return null}function r(u){if(!u||s.has(u))return;const f=ui(u);f&&(o.set(u,f),s.add(u),n&&He(n,je(),s))}function c(u){if(!s.has(u))return;const f=o.get(u);f&&(f.stop(),o.delete(u)),s.delete(u),n&&He(n,je(),s)}function a(){for(const u of s)c(u)}let l=!1;e.addEventListener("mousedown",u=>{l=!0;const f=e.getBoundingClientRect(),d=u.clientX-f.left,m=u.clientY-f.top,h=i(d,m);r(h)}),e.addEventListener("mousemove",u=>{if(!l)return;const f=e.getBoundingClientRect(),d=u.clientX-f.left,m=u.clientY-f.top,h=i(d,m);r(h)}),e.addEventListener("mouseup",()=>{l=!1,a()}),e.addEventListener("mouseleave",()=>{l=!1,a()})}const Gn=[..."qwertyuiop[zxcvbnm,./"],jn=["2","3","5","6","7","9","0","=","s","d","g","h","k","l",";"];function fi(){const e=document.getElementById("instrument-loop-toggle");return(e==null?void 0:e.checked)??!1}let Ct=!1,Ye=null,_e=null,De=null;function mi(e,t){if(Ct)return;Ct=!0;const n=e.getContext("2d");if(!n)throw new Error("Canvas 2D context not available.");const o=new Set,s=new Set,i=new Map,r=Gn,c=jn;Ye=t;function a(){const f=Ye(),d=Object.values(f).filter(p=>!p.isBlack).sort((p,g)=>p.x-g.x).map(p=>p.note),m=Object.values(f).filter(p=>p.isBlack).sort((p,g)=>p.x-g.x).map(p=>p.note),h={};return r.forEach((p,g)=>{d[g]&&(h[p]=d[g])}),c.forEach((p,g)=>{m[g]&&(h[p]=m[g])}),h}function l(f){const d=a(),m=d[f];if(!(!m||o.has(f))){if(o.add(f),!s.has(m)){const h=Xn(m,100,fi());h&&(i.set(m,{stop:h}),s.add(m))}n&&He(n,Ye(),s,d)}}function u(f){const d=a(),m=d[f];m&&(o.delete(f),s.has(m)&&(ci(m),i.delete(m),s.delete(m)),n&&He(n,Ye(),s,d))}_e=f=>{f.repeat||l(f.key)},De=f=>{u(f.key)},window.addEventListener("keydown",_e),window.addEventListener("keyup",De)}function hi(){_e&&(window.removeEventListener("keydown",_e),_e=null),De&&(window.removeEventListener("keyup",De),De=null),Ct=!1}let be=3,Ee=pn(be),Ve=!1;async function gi(e){var i,r;const t=e.getContext("2d");if(!t)throw new Error("Failed to get 2D context for keyboard canvas");function n(){const c=Object.values(Ee).filter(u=>!u.isBlack).sort((u,f)=>u.x-f.x).map(u=>u.note),a=Object.values(Ee).filter(u=>u.isBlack).sort((u,f)=>u.x-f.x).map(u=>u.note),l={};return Gn.forEach((u,f)=>{c[f]&&(l[u]=c[f])}),jn.forEach((u,f)=>{a[f]&&(l[u]=a[f])}),l}function o(){if(!t)return;Ee=pn(be);const c=Ve?n():null;He(t,Ee,new Set,c)}di(e,()=>Ee),o(),(i=document.getElementById("octave-up"))==null||i.addEventListener("click",()=>{be<7&&(be++,o())}),(r=document.getElementById("octave-down"))==null||r.addEventListener("click",()=>{be>1&&(be--,o())});const s=document.getElementById("disable-keyboard-inputs");return s.classList.remove("bg-purple-600"),s.classList.add("bg-gray-700"),s.addEventListener("click",()=>{Ve=!Ve,Ve?(mi(e,()=>Ee),s.classList.remove("bg-gray-700"),s.classList.add("bg-purple-600")):(hi(),s.classList.remove("bg-purple-600"),s.classList.add("bg-gray-700")),o()}),{refreshKeyboard:o}}async function pi(){const e=document.getElementById("instrument-select-btn"),t=document.getElementById("instrument-select-modal"),n=document.getElementById("instrument-select"),o=document.getElementById("instrument-select-confirm"),s=document.getElementById("instrument-cancel-btn"),i=document.getElementById("instrument-library-select");Object.entries({"fluidr3-gm":"soundfont",musyngkite:"soundfont",fatboy:"soundfont",splendidgrandpiano:"builtin",electricpiano:"builtin",mallets:"builtin",drummachines:"builtin",smolken:"builtin"}).forEach(([c])=>{const a=document.createElement("option");a.value=c,a.textContent=c.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase()),i.appendChild(a)}),i.addEventListener("change",()=>{const c=new CustomEvent("instrument-library-change",{detail:{preselect:null}});i.dispatchEvent(c)}),i.addEventListener("instrument-library-change",async c=>{var f;const a=c,l=i.value,u=((f=a.detail)==null?void 0:f.preselect)??null;try{let d;l==="mallets"?d=await Js():l==="electricpiano"?d=await xs():l==="splendidgrandpiano"?d=await ei():l==="drummachines"?d=await ti():l==="smolken"?d=await ni():["fluidr3-gm","musyngkite","fatboy"].includes(l)?d=await oi({"fluidr3-gm":"FluidR3_GM",fatboy:"FatBoy",musyngkite:"MusyngKite"}[l]):d=await(await fetch(`/static/${l}.json`)).json(),n.innerHTML="",d.forEach(m=>{const h=document.createElement("option");h.value=`${l}/${m}`,h.textContent=m.split("_").map(p=>p[0].toUpperCase()+p.slice(1)).join(" "),n.appendChild(h)}),u?n.value=u:d.length>0&&(n.value=`${l}/${d[0]}`)}catch(d){console.error(`Failed to load instruments for library: ${l}`,d)}}),e.addEventListener("click",async()=>{const c=ai()||"fluidr3-gm/acoustic_grand_piano",[a]=c.split("/");i.value=a;const l=new CustomEvent("instrument-library-change",{detail:{preselect:c}});i.dispatchEvent(l),t.classList.remove("hidden"),delete t.dataset.currentSequencer}),o.addEventListener("click",async()=>{const c=n.value;t.classList.add("hidden");const a=t.dataset.currentSequencer,l=a!==void 0?parseInt(a,10):void 0;if(l!==void 0&&!isNaN(l)){const u=$s(l);u&&(D(Do(u.id,c),Oo(u.id,u.instrumentName)),u.setInstrument(c)),t.dataset.currentSequencer=""}else try{await Kn(c)}catch(u){console.error("Failed to load global instrument:",c,u)}}),s.addEventListener("click",()=>{t.classList.add("hidden")})}async function yi(e){await Kn("fluidr3-gm/acoustic_grand_piano");const{refreshKeyboard:t}=await gi(e);await pi()}function Ei(e,t){const n=t.getContext("2d");if(!n)throw new Error("Canvas 2D context not available");const o=t.width,s=t.height,i=new Uint8Array(e.fftSize),r=new Uint8Array(e.frequencyBinCount),c=document.createElement("canvas");c.width=o,c.height=s;const a=c.getContext("2d");if(!a)throw new Error("Offscreen canvas 2D context not available");let l="frequency";function u(){if(!n)return;e.getByteTimeDomainData(i),n.fillStyle="#000",n.fillRect(0,0,o,s),n.lineWidth=2,n.strokeStyle="#00ffcc",n.beginPath();const h=o/i.length;let p=0;for(let g=0;g<i.length;g++){const E=i[g]/128*s/2;g===0?n.moveTo(p,E):n.lineTo(p,E),p+=h}n.lineTo(o,s/2),n.stroke()}function f(){if(e.getByteFrequencyData(r),!n)return;n.fillStyle="#000",n.fillRect(0,0,o,s),n.fillStyle="rgba(255,255,255,0.2)",n.fillRect(0,0,1,s),n.fillRect(o-1,0,1,s);const h=128,p=2,g=[];for(let y=0;y<h;y++)g.push(y*o/(h-1));g[g.length-1]=o-1;for(let y=0;y<h;y++){const E=g[y],b=y<h-1?g[y+1]:o,w=Math.max(1,b-E-p),L=20,S=2e4,T=y/(h-1),B=L*Math.pow(S/L,T),k=Math.min(r.length-1,Math.floor(B/22050*r.length)),A=r[k]/255,q=Math.max(1,A*s),O=240-T*240;n.fillStyle=`hsl(${O}, ${80+A*20}%, ${40+A*40}%)`,n.fillRect(E,s-q,w,q)}}function d(){if(e.getByteFrequencyData(r),!a)return;c.initialized||(a.fillStyle="#000",a.fillRect(0,0,o,s),c.initialized=!0),a.drawImage(c,-1,0),a.fillStyle="#000",a.fillRect(o-1,0,1,s);const h=128,p=20,g=2e4;for(let y=0;y<h;y++){const E=y/(h-1),b=p*Math.pow(g/p,E),L=Math.min(r.length-1,Math.floor(b/22050*r.length)),S=r[L]/255,T=s-1-Math.floor(y*s/h);if(S<.05)continue;const B=Math.floor(S*255),N=Math.floor(S*(255-E*200)),k=Math.floor(S*(100+E*155));a.fillStyle=`rgb(${B}, ${N}, ${k})`,a.fillRect(o-1,T,1,1)}n&&(n.fillStyle="#000",n.fillRect(0,0,o,s),n.drawImage(c,0,0))}function m(){switch(requestAnimationFrame(m),l){case"frequency":f();break;case"spectrogram":d();break;case"waveform":default:u()}}return m(),{setMode(h){["waveform","frequency","spectrogram"].includes(h)&&(l=h,n.clearRect(0,0,o,s),l==="spectrogram"&&a.clearRect(0,0,o,s))}}}function bi(e,t){const n=Ei(it,e),o=[{name:"waveform",emoji:"🌊"},{name:"frequency",emoji:"📊"},{name:"spectrogram",emoji:"🌈"}];let s=0;function i(){s=(s+1)%o.length;const{name:r,emoji:c}=o[s];n.setMode(r),t.textContent=c,t.title=`Mode: ${r}`}t.addEventListener("click",i),i()}function Si(){for(const e of M){const t=e.container;if(!t)continue;const n=t.querySelector(".sequencer-body"),o=t.querySelector("canvas.mini-contour"),s=t.querySelector(".collapse-btn use");!n||!o||n.classList.contains("hidden")||(n.classList.add("hidden"),o.classList.remove("hidden"),s==null||s.setAttribute("href","#icon-caret-up"),Ke(t,!1),$e(o,e.notes,e.config,e.colorIndex))}}function wi(){var f;const e=document.getElementById("global-mini-expand-btn"),t=document.getElementById("global-mini-contour"),n=document.getElementById("global-mini-playhead"),o=(f=t==null?void 0:t.parentElement)==null?void 0:f.parentElement,s=t==null?void 0:t.parentElement,i=e==null?void 0:e.querySelector("svg use"),r=document.querySelector(".footer-spacer"),c=40;let a=!1;function l(d,m){const h=d.offsetWidth;d.style.height=`${m}px`,d.height=m,d.width=h}if(!e||!t||!n||!o||!s||!i||!r){console.warn("FooterUI: One or more elements not found.");return}o.style.height=`${c}px`,s.style.height=`${c}px`,l(t,c),l(n,c),J(t,de());function u(){a=!a;const d=a?200:40;!o||!s||!t||!n||!i||!r||(o.style.height=`${d}px`,s.style.height=`${d}px`,l(t,d),l(n,d),i.setAttribute("href",a?"#icon-caret-down":"#icon-caret-up"),r.style.height=`${d-40+140}px`,J(t,de()))}e.addEventListener("click",u)}function vi(e){if(!e.sequencers.length)throw new Error("No tracks to export.");const t=e.tempo,n=e.timeSignature[0],o=e.totalMeasures,s={v:3,t:new Date().toISOString(),c:{b:t,bpm:n,tm:o},i:e.sequencers.map(r=>r.instrument||"fluidr3-gm/acoustic_grand_piano"),tr:e.sequencers.map(r=>({n:r.notes.map(c=>[c.pitch,c.start,c.duration])}))},i=new Blob([JSON.stringify(s)],{type:"application/json"});return{url:URL.createObjectURL(i),filename:`session-${Date.now()}.json`}}async function Ci(e){if(!e.tracks||e.tracks.length===0)throw new Error("No tracks to export.");const n=60/ge(),o=Math.max(...e.tracks.flatMap(u=>u.notes.map(f=>(f.start+f.duration)*n+.2))),s=44100,i=new OfflineAudioContext(2,Math.ceil(s*o),s);for(const u of e.tracks){const f=u.instrument||"fluidr3-gm/acoustic_grand_piano",d=new $n(null,u.config,i,i.destination,f);d.setState(u),await d.exportToOffline()}const r=await i.startRendering(),c=Li(r),a=URL.createObjectURL(c),l=document.createElement("a");l.href=a,l.download=`session-${Date.now()}.wav`,l.click(),URL.revokeObjectURL(a)}function Li(e){const t=e.numberOfChannels,n=e.length*t*2,o=new DataView(new ArrayBuffer(44+n)),s=(r,c)=>{for(let a=0;a<c.length;a++)o.setUint8(r+a,c.charCodeAt(a))};s(0,"RIFF"),o.setUint32(4,36+n,!0),s(8,"WAVE"),s(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,t,!0),o.setUint32(24,e.sampleRate,!0),o.setUint32(28,e.sampleRate*t*2,!0),o.setUint16(32,t*2,!0),o.setUint16(34,16,!0),s(36,"data"),o.setUint32(40,n,!0);let i=44;for(let r=0;r<e.length;r++)for(let c=0;c<t;c++){const a=e.getChannelData(c)[r],l=Math.max(-1,Math.min(1,a));o.setInt16(i,l*32767,!0),i+=2}return new Blob([o.buffer],{type:"audio/wav"})}async function Ni(e){var r,c,a;const t=await e.text();let n;try{n=JSON.parse(t)}catch{throw new Error("Invalid JSON format.")}if(!Array.isArray(n.tr))throw new Error("Missing or invalid `tr` (tracks) array.");const o={bpm:((r=n.c)==null?void 0:r.b)??120,beatsPerMeasure:((c=n.c)==null?void 0:c.bpm)??4,totalMeasures:((a=n.c)==null?void 0:a.tm)??8},s=Array.isArray(n.i)?n.i:[],i=n.tr.map((l,u)=>{if(!Array.isArray(l.n))throw new Error(`Track ${u} missing \`n\` (notes) array.`);const f=l.n.map(([m,h,p])=>({pitch:m,start:h,duration:p})),d=s[u]||"fluidr3-gm/acoustic_grand_piano";return{notes:f,instrument:d,config:{}}});return{globalConfig:o,tracks:i}}function Bi(){const e=document.querySelectorAll(".note-duration-btn"),t=document.getElementById("note-duration"),n=document.getElementById("dotted-note-btn"),o=document.getElementById("triplet-note-btn");let s=!1,i=!1;function r(a){let l=a;s?l=a*1.5:i&&(l=a*(2/3));let u=Array.from(t.options).find(f=>Math.abs(parseFloat(f.value)-l)<1e-4);u||(u=new Option(l.toString(),l.toString()),t.add(u)),t.value=u.value,t.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0}))}e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(u=>u.classList.remove("bg-purple-600")),a.classList.add("bg-purple-600");const l=parseFloat(a.dataset.value);r(l)})}),n.addEventListener("click",()=>{i&&(i=!1,o.classList.remove("bg-purple-600")),s=!s,n.classList.toggle("bg-purple-600"),c()}),o.addEventListener("click",()=>{s&&(s=!1,n.classList.remove("bg-purple-600")),i=!i,o.classList.toggle("bg-purple-600"),X.isTripletMode=i,M.forEach(a=>{a.config.isTripletMode=i}),c()});function c(){const a=document.querySelector(".note-duration-btn.bg-purple-600");if(a){const l=parseFloat(a.dataset.value);r(l)}}r(X.currentDuration||1)}let oe=null,nt=null;function Mi(e){nt=e,oe=nt.getContext("2d")}function we(e){if(!oe||!nt)return;const{width:t,height:n}=nt;oe.clearRect(0,0,t,n);const o=Math.round(e)+.5;oe.strokeStyle="#ff00ff",oe.lineWidth=1,oe.beginPath(),oe.moveTo(o,0),oe.lineTo(o,n),oe.stroke()}let ot=!1,ce=null,Lt=null,Nt=!1;function ki(e,t){ce=e,Lt=t,ce.addEventListener("mousedown",Ii),window.addEventListener("mousemove",Ti),window.addEventListener("mouseup",Ri)}function Ii(e){Tn()&&(Rn(),M.forEach(t=>{var n;return(n=t.pause)==null?void 0:n.call(t)}),Nt=!0),ot=!0,Yn(e)}function Ti(e){ot&&Yn(e)}function Ri(){ot&&(ot=!1,Nt&&(Pn(),M.forEach(e=>{var t;return(t=e.resume)==null?void 0:t.call(e)}),Nt=!1))}function Yn(e){if(!ce||!Lt)return;const t=ce.getBoundingClientRect(),n=ce.width/t.width;let o=(e.clientX-t.left)*n;o=Math.max(0,Math.min(ce.width,o));const s=U(),i=o/ce.width*s,r=En(i,Lt),c=r/s*ce.width;ue(r),we(c)}const $t={maxBeatsContext:32,extendBeatsAmount:16};function Ki(){return $t.maxBeatsContext}function Xi(){return $t.extendBeatsAmount}function Bt(e,t,n,o){const s=U(),i=o/s*t;e.clearRect(0,0,t,n);const r=$t.maxBeatsContext,a=Math.max(0,o-r)/s*t,l=i-a;e.fillStyle="rgba(85, 187, 255, 0.55)",e.fillRect(a,0,l,n),e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(i,0),e.lineTo(i,n),e.stroke()}let fn=!1,ut=!1,Oe=0;function Gi(){return Oe}function mn(){if(!fn){fn=!0;const o=document.getElementById("extend-use-tags"),s=document.getElementById("extend-tags");if(o&&s){let l=function(){const d=u.checked;f.disabled=!d,f.classList.toggle("opacity-50",!d),f.classList.toggle("cursor-not-allowed",!d)};const u=o,f=s;l(),u.addEventListener("change",l)}const i=document.getElementById("extend-start-help-btn"),r=document.getElementById("extend-start-help-popup"),c=document.getElementById("extend-start-help-close");i&&r&&c&&(i.addEventListener("click",()=>r.classList.remove("hidden")),c.addEventListener("click",()=>r.classList.add("hidden")),document.addEventListener("click",l=>{l.target instanceof Node&&!r.contains(l.target)&&l.target!==i&&r.classList.add("hidden")}));const a=document.querySelector("#ai-extend-modal .generate-btn");a&&a.addEventListener("click",async()=>{const{extendTracksWithAI:l}=await gn(async()=>{const{extendTracksWithAI:u}=await import("./extendTracks-3QCN6tfB.js");return{extendTracksWithAI:u}},__vite__mapDeps([0,1]));await l()})}const e=document.getElementById("extend-track-checkboxes"),t=document.getElementById("extend-select-all"),n=document.getElementById("extend-deselect-all");e&&t&&n&&(e.innerHTML="",de().forEach((s,i)=>{const r=`extend-track-${i}`,c=document.createElement("div");c.className="flex items-center gap-2";const a=document.createElement("input");a.type="checkbox",a.id=r,a.dataset.index=i.toString(),a.checked=!0,a.className="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500";const l=document.createElement("label");l.htmlFor=r,l.className="text-sm text-gray-200",l.textContent=s.config.name||`Track ${i+1}`,a.addEventListener("change",()=>{Re()}),c.appendChild(a),c.appendChild(l),e.appendChild(c)}),t.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!0),Re()}),n.addEventListener("click",()=>{e.querySelectorAll('input[type="checkbox"]').forEach(s=>s.checked=!1),Re()}),Re())}function Pi(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d");if(!n)return;const o=e.clientWidth,s=e.clientHeight;e.width=o,e.height=s,t.width=o,t.height=s,Re(),Bt(n,o,s,Oe),t.addEventListener("mousedown",r=>{ut=!0,i(r.offsetX)}),window.addEventListener("mouseup",()=>{ut=!1}),window.addEventListener("mousemove",r=>{if(!ut)return;const c=t.getBoundingClientRect();i(r.clientX-c.left)});function i(r){if(!n)return;const c=U(),a=Math.max(0,Math.min(r,o));Oe=Math.round(a/o*c),Bt(n,o,s,Oe)}}function Re(){const e=document.getElementById("extend-mini-contour"),t=document.getElementById("extend-mini-playhead");if(!e||!t)return;const n=t.getContext("2d");if(!n)return;const o=t.width,s=t.height,i=document.querySelectorAll('#extend-track-checkboxes input[type="checkbox"]'),r=Array.from(i).filter(a=>a.checked).map(a=>parseInt(a.dataset.index||"0",10)),c=de().filter((a,l)=>r.includes(l));J(e,c),Bt(n,o,s,Oe)}function qi(){const e=document.getElementById("note-placement-mode-btn"),t=document.getElementById("select-mode-btn"),n=document.getElementById("velocity-mode-btn"),o=document.getElementById("note-duration-controls"),s=document.getElementById("select-mode-controls"),i=document.getElementById("velocity-mode-controls");if(!e||!t||!n||!o||!s||!i){console.error("Missing essential UI elements for edit mode switching.");return}function r(a){[e,t,n].forEach(l=>{l&&(l.classList.remove("bg-purple-600"),l.classList.add("bg-gray-800"))}),a.classList.remove("bg-gray-800"),a.classList.add("bg-purple-600")}function c(a){[o,s,i].forEach(l=>{l&&l.classList.add("hidden")}),a.classList.remove("hidden")}e.addEventListener("click",()=>{r(e),c(o),Z("note-placement")}),t.addEventListener("click",()=>{r(t),c(s),Z("select")}),n.addEventListener("click",()=>{r(n),c(i),Z("none")}),window.addEventListener("keydown",a=>{var f;const l=(f=document.activeElement)==null?void 0:f.tagName;if(!(l==="INPUT"||l==="TEXTAREA"||document.querySelector(".ai-modal:not(.hidden)")))switch(a.key.toLowerCase()){case"q":e.click();break;case"w":t.click();break;case"e":n.click();break;default:return}}),r(e),c(o),Z("note-placement")}function Ai(){var d,m,h;const e=document.getElementById("note-mode-btn"),t=document.getElementById("ai-mode-btn"),n=document.getElementById("note-duration-panel"),o=document.getElementById("ai-control-panel");if(!e||!t||!n||!o){console.error("Missing essential elements for control mode switching.");return}function s(){document.querySelectorAll(".sequencer").forEach(p=>{const g=p.querySelector(".delete-btn"),y=p.querySelector(".collapse-btn"),E=y==null?void 0:y.querySelector("use"),b=p.querySelector(".sequencer-body"),w=p.querySelector(".mini-contour");!g||!y||!E||!b||!w||(g.classList.add("button-locked"),y.classList.add("button-locked"),Ke(p,!1),b.classList.contains("hidden")||(b.classList.add("hidden"),w.classList.remove("hidden"),E.setAttribute("href","#icon-caret-up")))})}function i(){document.querySelectorAll(".sequencer").forEach(p=>{const g=p.querySelector(".delete-btn"),y=p.querySelector(".collapse-btn");g==null||g.classList.remove("button-locked"),y==null||y.classList.remove("button-locked")})}function r(){!e||!t||!n||!o||(e.classList.replace("bg-gray-800","bg-blue-600"),t.classList.replace("bg-purple-600","bg-gray-800"),n.classList.remove("hidden"),o.classList.add("hidden"),i())}function c(){if(!dt()){const p=document.getElementById("openai-key-not-set-modal");p==null||p.classList.remove("hidden");return}!e||!t||!n||!o||(t.classList.replace("bg-gray-800","bg-purple-600"),e.classList.replace("bg-blue-600","bg-gray-800"),n.classList.add("hidden"),o.classList.remove("hidden"),s())}e.addEventListener("click",r),t.addEventListener("click",c);const a=document.getElementById("ai-inpaint-modal"),l=document.getElementById("ai-extend-modal"),u=document.getElementById("ai-generate-modal");function f(p){if(!p)return;const g=p.querySelector(".cancel-btn");g==null||g.addEventListener("click",()=>{p.classList.add("hidden")})}f(a),f(l),f(u),mn(),(d=document.getElementById("ai-inpaint-btn"))==null||d.addEventListener("click",()=>{a==null||a.classList.remove("hidden")}),(m=document.getElementById("ai-extend-btn"))==null||m.addEventListener("click",()=>{l==null||l.classList.remove("hidden"),Pi(),mn()}),(h=document.getElementById("ai-generate-btn"))==null||h.addEventListener("click",()=>{u==null||u.classList.remove("hidden")}),qi()}function Vn(){const e=Ft();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(D(kt(t.sequencer.id,n),It(t.sequencer.id,n)),Ne()&&(Le(),Z(re.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function Qn(){console.log("performCopy called");const e=Ft();if(!e)return;const t=e.getSelectedNotes();t.length!==0&&Dn(t)}function Zn(){const e=Ft();if(!e)return;const t=e.gridContext,n=t.getSelectedNotes();n.length!==0&&(Dn(n),D(Xo(t.sequencer.id,n),Go(t.sequencer.id,n)),Ne()&&(Le(),Z(re.NOTE_PLACEMENT)),t.setSelectedNotes([]))}function Jn(){if(console.log("performPaste called"),!St().notes.length){console.log("No notes in clipboard");return}document.body.style.cursor="crosshair",ws((t,n)=>{const o=t.gridContext,{x:s,y:i}=o.getCanvasPos(n),r=o.getSnappedBeatFromX(s),c=o.getPitchFromRow(Math.floor(i/o.getCellHeight())),a=I(c);if(a===null)return;const{notes:l,anchorBeat:u,anchorMidi:f}=St(),d=r-u,m=a-f,h=l.map(p=>{const g=I(p.pitch);return g===null?{...p}:{pitch:le(g+m)??p.pitch,start:p.start+d,duration:p.duration}});D(Yo(o.sequencer.id,h),Vo(o.sequencer.id,h)),Ne()&&(Le(),Z(re.NOTE_PLACEMENT)),o.setSelectedNotes(h),document.body.style.cursor="default",qt()})}function _i(){document.addEventListener("keydown",e=>{const n=navigator.platform.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey,o=document.activeElement,s=o instanceof HTMLElement?o.tagName:null;if(!(s==="INPUT"||s==="TEXTAREA"))switch(!0){case(n&&e.key==="c"):e.preventDefault(),Qn();break;case(n&&e.key==="x"):e.preventDefault(),Zn();break;case(n&&e.key==="v"):e.preventDefault(),Jn();break;case e.key==="Delete":e.preventDefault(),Vn();break}})}function Di(){const e=document.querySelector(".select-mode-copy");e&&(e.onclick=Qn);const t=document.querySelector(".select-mode-cut");t&&(t.onclick=Zn);const n=document.querySelector(".select-mode-paste");n&&(n.onclick=Jn);const o=document.querySelector(".select-mode-delete");o&&(o.onclick=Vn),_i()}function Oi(e,t){return e!==void 0&&t!==void 0&&e===t}function Hi(e=ke()){var n,o,s;pt(e.tempo,!1),yt(e.timeSignature[0],!1),Et(e.totalMeasures,!1);for(const i of M)i.updateTotalMeasures();for(const i of e.sequencers){const r=M.find(c=>Oi(c.id,i.id));if(r){r.instrumentName=i.instrument;const c=(n=r.container)==null?void 0:n.querySelector("canvas.mini-contour");c&&$e(c,r.notes,r.config,r.colorIndex);const a=(o=r.grid)==null?void 0:o.gridContext;if(a){const l=a.getSelectedNotes?a.getSelectedNotes():[],u=a.getSelectedNote?a.getSelectedNote():null,f=l.map(d=>({pitch:d.pitch,start:d.start,duration:d.duration}));if(a.notes.length=0,a.notes.push(...structuredClone(i.notes)),l.length>0){const d=f.map(m=>a.notes.find(h=>h.pitch===m.pitch&&h.start===m.start&&h.duration===m.duration)).filter(Boolean);d.length>0&&(a.setSelectedNotes(d),u&&d.length===1&&a.setSelectedNote(d[0]))}(s=r.grid)==null||s.scheduleRedraw()}}else{const c={id:i.id,instrument:i.instrument,notes:structuredClone(i.notes)},{wrapper:a}=Un(c),l=a.querySelector(".sequencer");l&&Ke(l,!0)}}const t=document.getElementById("global-mini-contour");t&&J(t,M)}ns(Hi);function xn(){const e=document.getElementById("global-mini-contour");e&&J(e,M)}document.getElementById("global-mini-contour");const Wt=document.getElementById("global-mini-playhead");Mi(Wt);ki(Wt,X);we(0);const Fi=document.getElementById("piano");yi(Fi);const $i=document.getElementById("waveform"),Wi=document.getElementById("visualizer-mode");bi($i,Wi);const hn=0,Ui="fluidr3-gm/acoustic_grand_piano";D(Cn(hn,Ui),Mt(hn));D(Rt("Initial App State"),Nn("Initial App State"));Di();xn();Us();Bi();Ai();wi();js({getSequencers:()=>M,onPlay:()=>{xe();const e=U(),t=Je();ds(ge(),{loop:X.loopEnabled,endBeat:e,startBeat:t,onLoop:()=>{M.forEach(n=>{var o;return(o=n.onTransportLoop)==null?void 0:o.call(n)})}}),gt(n=>{const o=n/e*Wt.width;we(o)}),M.forEach(n=>n.play()),ls(()=>{Ys(),ue(0),we(0)})},onPause:()=>{Rn(),M.forEach(e=>e.pause())},onResume:()=>{Pn(),M.forEach(e=>e.resume())},onStop:()=>{xe(),ue(0),M.forEach(e=>e.stop()),we(0)},onDurationChange:e=>{X.currentDuration=e,M.forEach(t=>t.config.currentDuration=e)},onSnapChange:e=>{X.snapResolution=e,M.forEach(t=>t.config.snapResolution=e)},onToggleLoop:e=>{X.loopEnabled=e,M.forEach(t=>t.config.loopEnabled=e)},onTempoChange:e=>{pt(e)},onSave:async e=>{const t=ke();if(e==="json"){const{url:n,filename:o}=vi(t),s=document.createElement("a");s.href=n,s.download=o,s.click(),URL.revokeObjectURL(n)}else if(e==="wav"){const n={globalConfig:{bpm:t.tempo,beatsPerMeasure:t.timeSignature[0],totalMeasures:t.totalMeasures},tracks:M.map(o=>({notes:o.notes,instrument:o.instrumentName,config:o.config}))};await Ci(n)}else e==="midi"&&alert("MIDI export not implemented yet.")},onLoad:async e=>{try{const{tracks:t,globalConfig:n}=await Ni(e);pt(n.bpm),yt(n.beatsPerMeasure),Et(n.totalMeasures);const o=document.getElementById("tempo-input");o&&(o.value=String(ge()));const s=document.getElementById("measures-input");s&&(s.value=String(ze())),Ws();for(const[i,r]of t.entries()){const c=i,a=r.instrument||"fluidr3-gm/acoustic_grand_piano",l=r.notes||[];D({type:"CREATE_SEQUENCER",id:c,instrument:a,notes:structuredClone(l),config:r.config||{}},Mt(c))}D(Rt("Session Loaded"),Nn("Session Loaded")),Si(),xn(),ue(0),we(0)}catch(t){t instanceof Error?alert("Failed to load file: "+t.message):alert("Failed to load file: Unknown error")}},onMeasuresChange:e=>{Et(e);const t=document.getElementById("global-mini-contour");t&&J(t,M)},onBeatsPerMeasureChange:e=>{yt(e);const t=document.getElementById("global-mini-contour");t&&J(t,M)}});const ji=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{Qt as a,de as b,Gi as c,Ki as d,Xi as e,Ue as f,dt as g,$e as h,J as i,ji as m,Et as u};
